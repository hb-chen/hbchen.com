---
title: "ã€go-microã€‘Networkåˆæ¢"
date: 2019-11-15
lastmod: 2019-11-16 07:03:09
draft: false
mermaid: false
comments: true
categories: [
	"å¾®æœåŠ¡",
]
tags: [
	"go-micro",
    "å¾®æœåŠ¡",
]
---
Networkæ˜¯microç¤¾åŒºæ­£åœ¨ä¸»åŠ›æ‰“é€ çš„è§£å†³å¤š"äº‘"ç¯å¢ƒçš„è§£å†³æ–¹æ¡ˆï¼Œä¸‹é¢ç»“åˆæœ€è¿‘çš„ç ”ç©¶åšä¸ªæ€»ç»“ï¼Œä¸»è¦åŒ…æ‹¬`network`é€‚ç”¨çš„å‡ ç§åœºæ™¯åˆ†æï¼Œ
ä»¥åŠåœ¨è¿™äº›åœºæ™¯éœ€æ±‚ä¸‹`network`è¿˜æœ‰å“ªäº›ä¸è¶³ã€‚

<!--more-->

- [Network Overview](https://micro.mu/docs/network.html)
- [Service Network](https://micro.mu/docs/service-network.html)


## Proxy
åœ¨åˆ†æ`network`ä¹‹å‰å…ˆäº†è§£`micro`çš„`proxy`æ¨¡å¼ï¼ŒæœåŠ¡ä¹‹é—´è°ƒç”¨ä¸éœ€è¦æœåŠ¡å‘ç°ï¼Œè€Œæ˜¯é€šè¿‡`proxy`åšè½¬å‘ï¼Œç”±`proxy`å®ŒæˆæœåŠ¡çš„å‘ç°å’Œè°ƒç”¨ã€‚
`network`å®ç°äº†ä¸€ä¸ªç‰¹æ®Šçš„ä»£ç†ï¼Œå®ƒçš„æœåŠ¡å‘ç°å¹¶ä¸åªæ˜¯é€šè¿‡æ³¨å†Œä¸­å¿ƒï¼ŒåŒæ—¶æœ‰`network`ä¹‹é—´å…±äº«çš„æœåŠ¡ã€‚
![micro-proxy](/img/micro/proxy.png)

## æœåŠ¡å¯è§æ€§
`network`é€šè¿‡å…±äº«æœåŠ¡ä¿¡æ¯ï¼Œå®ç°è·¨`network`çš„æœåŠ¡å¯è§ï¼Œä»è€Œå®ç°ä»£ç†çš„æœåŠ¡å‘ç°ï¼Œå¹¶ä¸”å…±äº«æ˜¯æœ‰å¯è§æ€§çš„ï¼Œå½“å‰`advertise_strategy`æœ‰`3+1`ç§æ–¹æ¡ˆ:

- `none`ä¸å…±äº«æœåŠ¡
	- å³åªæ¥å—å¤–éƒ¨æœåŠ¡ï¼Œé€‚åˆè¾¹ç¼˜èŠ‚ç‚¹ï¼Œä¾èµ–ä¸­å¿ƒæœåŠ¡åœºæ™¯
- `all`å…±äº«å…¨éƒ¨æœåŠ¡
- `best`å…±äº«æœ€ä¼˜è·¯ç”±
	- `local`ä»…å…±äº«é›†ç¾¤å†…éƒ¨æœåŠ¡ï¼Œè€Œä¸å…±äº«ä»å…¶ä»–`network`å…±äº«å¾—åˆ°çš„æœåŠ¡ï¼Œå®é™…æ˜¯`best`çš„ä¸€ä¸ªç­›é€‰é¡¹ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¯´å®ƒæ˜¯`3+1`
	
> æˆªæ­¢`v1.6.0`ç‰ˆæœ¬è¿˜æ²¡æœ‰æ­¤åŠŸèƒ½ï¼Œéœ€è¦ä½¿ç”¨`master`åˆ†æ”¯ï¼Œ[PR#932](https://github.com/micro/go-micro/pull/932)å¢åŠ äº†æ­¤ç­–ç•¥çš„æ”¯æŒï¼Œ
ä»¥microçš„å‘ç‰ˆé€Ÿåº¦åº”è¯¥è¦ä¸äº†å¤šä¹…å°±ä¼šæœ‰Releaseç‰ˆğŸ¤£

> Networkåœ¨ä¸æ–­å®Œå–„ï¼Œæœ¬æ–‡å‚è€ƒç‰ˆæœ¬ä¸ºï¼š
>
 - [micro/tree/98d9b1f332a2](https://github.com/micro/micro/tree/98d9b1f332a2)
 - [go-micro/tree/9f481542f38d](https://github.com/micro/go-micro/tree/9f481542f38d)
	
## åº”ç”¨åœºæ™¯
### å¤šé›†ç¾¤
å¤šé›†ç¾¤åœºæ™¯åˆ†ä¸¤ç§ä¸€æ˜¯**é›†ç¾¤æœåŠ¡å…±äº«**ï¼ŒäºŒæ˜¯**å¤šä¸­å¿ƒ/ä¸»å¤‡é›†ç¾¤**ï¼Œåœ¨`advertise_strategy`ç­–ç•¥é€‰æ‹©æœ‰åŒºåˆ«ã€‚

#### é›†ç¾¤æœåŠ¡å…±äº«
é›†ç¾¤æœåŠ¡å…±äº«æ˜¯æŒ‡ä¸åŒé›†ç¾¤æ‹¥æœ‰ä¸åŒçš„æœåŠ¡ï¼Œå®ç°é›†ç¾¤é—´çš„æœåŠ¡å‘ç°ï¼Œé€‰æ‹©çš„ç­–ç•¥æ˜¯`advertise_strategy=local`ï¼Œ`network`ä»…å…±äº«è‡ªèº«æœåŠ¡ï¼Œ
å¦‚æœ`DC B`ä¸`DC C`éœ€è¦å…±äº«æœåŠ¡ï¼Œé‚£ä¹ˆéœ€è¦ç›´æ¥å»ºç«‹è¿æ¥ï¼Œè€Œä¸æ˜¯é€šè¿‡`DC A`
![network_multi_cluster](/img/micro/network_multi_cluster_1.png)

#### å¤šä¸­å¿ƒ/ä¸»å¤‡é›†ç¾¤
å¤šä¸­å¿ƒ/ä¸»å¤‡é›†ç¾¤æ˜¯å°†åŒä¸€å¥—æœåŠ¡éƒ¨ç½²åœ¨å¤šä¸ªä¸­å¿ƒï¼Œå¯èƒ½æ˜¯å¤šæ´»ï¼Œä¹Ÿå¯èƒ½æ˜¯åˆ†ä¸»å¤‡ï¼Œé€‰æ‹©çš„ç­–ç•¥æ˜¯`advertise_strategy=best`ï¼Œä½†ç°åœ¨`network`åœ¨è´Ÿè½½ç­–ç•¥ä¸Šè¿˜æ²¡æœ‰**å°±è¿‘åŸåˆ™**
![network_multi_cluster](/img/micro/network_multi_cluster_2.png)

### ä¸­å¿ƒæœåŠ¡+è¾¹ç¼˜
å¯¹äºè¾¹ç¼˜è®¡ç®—åœºæ™¯ï¼Œè¾¹ç¼˜èŠ‚ç‚¹å¯èƒ½æ˜¯ä¸æä¾›æœåŠ¡çš„ï¼Œæ¯”å¦‚åªä¸ŠæŠ¥æ•°æ®ï¼Œå¯ä»¥é€‰æ‹©`advertise_strategy=none`ï¼Œå½“ç„¶æœ‰çš„å¯èƒ½åˆæ˜¯æä¾›æœåŠ¡çš„ï¼Œå¯ä»¥é€‰æ‹©`advertise_strategy=local`ï¼Œ
ä½†`DC A`å¹¶ä¸ä¼šå°†`DC C`çš„æœåŠ¡å…±äº«ç»™`DC B`ã€‚å› ä¸º`network`é—´é€šè¿‡`tunnel`é€šä¿¡ï¼Œè¾¹ç¼˜èŠ‚ç‚¹å¯ä»¥æ˜¯ä»»æ„ç½‘ç»œï¼Œåªè¦è¿æ¥åˆ°ä¸­å¿ƒæœåŠ¡çš„`network`å³å¯ã€‚
![network_edge](/img/micro/network_edge.png)

## ä¸è¶³
### Networké«˜å¯ç”¨åŠæ€§èƒ½
è¦è€ƒè™‘`network`çš„é«˜å¯ç”¨ï¼Œå¿…é¡»æ”¯æŒå¤šå‰¯æœ¬æ°´å¹³æ‰©å±•ï¼Œç°åœ¨åŒä¸€é›†ç¾¤å†…`network`ä¼šå…±äº«æœåŠ¡ï¼Œä½†å½“å‰`network`çš„æœåŠ¡å¯è§æ€§å¹¶æ²¡æœ‰å°†é›†ç¾¤å†…`node`ä¸ç›´è¿çš„`node`èŠ‚ç‚¹åšåŒºåˆ†ï¼Œ
å¦‚æœé›†ç¾¤å†…å‡ºç°nä¸ªå‰¯æœ¬ï¼Œé‚£ä¹ˆæœ€å·®çš„æƒ…å†µä¸‹å¯èƒ½è¦åœ¨`network`çš„`pod`é—´è·³è½¬næ¬¡ã€‚ç†æƒ³çŠ¶æ€åº”è¯¥æ˜¯å¯¹äºé›†ç¾¤å†…ä»…å…±äº«ä¸`node`ç›´è¿çš„**é›†ç¾¤å¤–æœåŠ¡**ï¼ˆè¿™æ˜¯å½“å‰`network`ä¸å…·å¤‡ï¼‰ï¼Œ
è€Œå¯¹é›†ç¾¤å¤–å…±äº«æœ¬é›†ç¾¤æœåŠ¡ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿é›†ç¾¤å†…`network`ä»£ç†æœ€å¤šç»è¿‡**ä¸¤è·³**å³å¯è°ƒç”¨é›†ç¾¤å¤–æœåŠ¡ã€‚
![network_edge](/img/micro/network_problem_ha.png)
å›¾ä¸­çº¢è‰²æ ‡è®°çš„`go.micro.srv.s-2 gateway-a-2`ã€`go.micro.srv.s-2 gateway-a-3`ä¸åº”è¯¥å‡ºç°åœ¨`network`çš„`routes`ä¸­ï¼Œé¿å…åŒä¸€é›†ç¾¤å†…æ²¡å¿…è¦çš„è·¯ç”±ã€‚

> æœ‰å…³`network`çš„å¤šå‰¯æœ¬è¿˜éœ€è¦è¿›ä¸€æ­¥ç ”ç©¶ï¼Œæ¯”å¦‚4ä¸ªåä¼šä¸ä¼šå‡ºç°é“¾è·¯å¾ªç¯ï¼Œä»¥åŠå…·ä½“è·¯ç”±è´Ÿè½½ç­–ç•¥ç­‰

æ€»çš„æ¥è¯´æ˜¯`advertise_strategy`éœ€è¦æ›´å®Œå–„çš„ç­–ç•¥æ”¯æŒï¼Œåšå¿…è¦çš„éš”ç¦»ã€ç­›é€‰ï¼Œä¸€æ˜¯æœåŠ¡çš„å¯è§æ€§é—®é¢˜ï¼ŒäºŒæ˜¯æœåŠ¡è§„æ¨¡å¢åŠ å`network`é—´çš„æ•°æ®é€šä¿¡ä¹Ÿä¼šæˆä¸ºç“¶é¢ˆã€‚

### è·¯ç”±è´Ÿè½½ç­–ç•¥
è·¯ç”±è´Ÿè½½é€‰æ‹©éœ€è¦ä¼˜å…ˆçº§ã€ç­›é€‰ç­‰ç­–ç•¥ï¼Œå¦‚localä¼˜å…ˆï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥å®ç°ä¸»å¤‡é›†ç¾¤ï¼Œä»¥åŠé›†ç¾¤é—´æµé‡åˆ‡æ¢ç­‰åœºæ™¯çš„åº”ç”¨

### å®‰å…¨
> æ›´æ­£ï¼šè¿™é‡Œæˆ‘ä»¬å¿½ç•¥äº†`tunnel`çš„`transport`ï¼Œåœ¨`transport`å±‚æ˜¯æœ‰`mTLS`æ”¯æŒçš„ï¼Œå…·ä½“å‚è€ƒ[ã€go-microã€‘è‡ªç­¾åè¯ä¹¦&Tunnel mTLS](/post/microservice/2019-11-27-go-micro-tunnel-mtls/)

~~`network`é—´çš„è¿æ¥æ˜¯é€šè¿‡`tunnel`å®Œæˆï¼Œè€Œ`tunnel`åœ¨å®‰å…¨æ–¹é¢åªæ˜¯åœ¨`message`çš„`header`ä¸­æ”¾äº†ä¸€ä¸ª`token`ç”¨äºç›¸äº’éªŒè¯ï¼Œè¿™ä¹Ÿæ˜¯éœ€è¦åŠ å¼ºçš„éƒ¨åˆ†ã€‚~~

## Networkæ¨¡æ‹Ÿæµ‹è¯•
å¯ä»¥æœ¬åœ°ä½¿ç”¨ä¸åŒçš„æ³¨å†Œä¸­å¿ƒæ¨¡æ‹Ÿå¤šä¸ªé›†ç¾¤ï¼Œç®€å•çš„`mdns`ã€`consul`å’Œ`etcd`å°±å¯ä»¥æ¨¡æ‹Ÿå‡ºä¸‰ä¸ªé›†ç¾¤ï¼Œå¦‚æœæœ‰å…¬ç½‘æœåŠ¡å™¨å½“ç„¶æ›´å¥½ã€‚
