<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>ã€Istioæºç ã€‘Pilot Discovery - Hobo&#39;s Blog - æŠ€æœ¯å®è·µ</title>
  <link rel="alternate" hreflang="zh-cn" href="http://hbchen.com" />

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Hobo Chen" />
  <meta name="description" content="æµé‡ç®¡ç†æ˜¯ç½‘æ ¼çš„åŸºç¡€ï¼ŒPilotè´Ÿè´£ä¸‰ä¸ªä¸»è¦åŠŸèƒ½ï¼šæœåŠ¡æ²»ç†istio-pilotã€Sidecaræ³¨å…¥istio-sidecar-injectorã€ä»¥åŠSidecaristio-proxyï¼Œ åˆ†åˆ«ç”±ä¸‰ä¸ªæ¨¡å—è´Ÿè´£ï¼špilot-discoveryã€sidecar-injectorã€pilot-agentï¼Œè¿™é‡Œä»pilot-discoveryå¼€å§‹ã€‚
" />

  <meta name="keywords" content="Hobo, hbchen, å¾®æœåŠ¡, æœåŠ¡ç½‘æ ¼, go-micro, Golang, Micro, RPC, Istio, Service mesh" />






<meta name="generator" content="Hugo 0.53" />


<link rel="canonical" href="http://hbchen.com/post/servicemesh/2019-03-17-istio-code-pilot-discovery/" />

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" href="/favicon.ico" />
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">




<link href="/dist/jane.min.css?v=2.7.0" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">




<meta property="og:title" content="ã€Istioæºç ã€‘Pilot Discovery" />
<meta property="og:description" content="æµé‡ç®¡ç†æ˜¯ç½‘æ ¼çš„åŸºç¡€ï¼ŒPilotè´Ÿè´£ä¸‰ä¸ªä¸»è¦åŠŸèƒ½ï¼šæœåŠ¡æ²»ç†istio-pilotã€Sidecaræ³¨å…¥istio-sidecar-injectorã€ä»¥åŠSidecaristio-proxyï¼Œ
åˆ†åˆ«ç”±ä¸‰ä¸ªæ¨¡å—è´Ÿè´£ï¼špilot-discoveryã€sidecar-injectorã€pilot-agentï¼Œè¿™é‡Œä»pilot-discoveryå¼€å§‹ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://hbchen.com/post/servicemesh/2019-03-17-istio-code-pilot-discovery/" /><meta property="article:published_time" content="2019-03-30T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2019-03-30T00:00:00&#43;00:00"/>

<meta itemprop="name" content="ã€Istioæºç ã€‘Pilot Discovery">
<meta itemprop="description" content="æµé‡ç®¡ç†æ˜¯ç½‘æ ¼çš„åŸºç¡€ï¼ŒPilotè´Ÿè´£ä¸‰ä¸ªä¸»è¦åŠŸèƒ½ï¼šæœåŠ¡æ²»ç†istio-pilotã€Sidecaræ³¨å…¥istio-sidecar-injectorã€ä»¥åŠSidecaristio-proxyï¼Œ
åˆ†åˆ«ç”±ä¸‰ä¸ªæ¨¡å—è´Ÿè´£ï¼špilot-discoveryã€sidecar-injectorã€pilot-agentï¼Œè¿™é‡Œä»pilot-discoveryå¼€å§‹ã€‚">


<meta itemprop="datePublished" content="2019-03-30T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-03-30T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="3793">



<meta itemprop="keywords" content="Service Mesh,Istio,æºç ," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ã€Istioæºç ã€‘Pilot Discovery"/>
<meta name="twitter:description" content="æµé‡ç®¡ç†æ˜¯ç½‘æ ¼çš„åŸºç¡€ï¼ŒPilotè´Ÿè´£ä¸‰ä¸ªä¸»è¦åŠŸèƒ½ï¼šæœåŠ¡æ²»ç†istio-pilotã€Sidecaræ³¨å…¥istio-sidecar-injectorã€ä»¥åŠSidecaristio-proxyï¼Œ
åˆ†åˆ«ç”±ä¸‰ä¸ªæ¨¡å—è´Ÿè´£ï¼špilot-discoveryã€sidecar-injectorã€pilot-agentï¼Œè¿™é‡Œä»pilot-discoveryå¼€å§‹ã€‚"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">HB Chen</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="https://github.com/hb-chen">
        <li class="mobile-menu-item">GitHub</li>
      </a>
  </ul>
</nav>

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">HB Chen</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://github.com/hb-chen">GitHub</a>
      </li>
  </ul>
</nav>
  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">ã€Istioæºç ã€‘Pilot Discovery</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-03-30 </span>
        <div class="post-category">
            
              <a href="/categories/service-mesh/"> Service Mesh </a>
            
          </div>
        <span class="more-meta"> çº¦ 3793 å­— </span>
        <span class="more-meta"> é¢„è®¡é˜…è¯» 8 åˆ†é’Ÿ </span>
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
  
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#discoveryè¿è¡Œåºåˆ—">Discoveryè¿è¡Œåºåˆ—</a>
<ul>
<li><a href="#kubeç¯å¢ƒç®€åŒ–åºåˆ—">kubeç¯å¢ƒç®€åŒ–åºåˆ—</a></li>
<li><a href="#è¯¦ç»†åºåˆ—">è¯¦ç»†åºåˆ—</a></li>
</ul></li>
<li><a href="#discovery-serveræµç¨‹">Discovery Serveræµç¨‹</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>æµé‡ç®¡ç†æ˜¯ç½‘æ ¼çš„åŸºç¡€ï¼ŒPilotè´Ÿè´£ä¸‰ä¸ªä¸»è¦åŠŸèƒ½ï¼šæœåŠ¡æ²»ç†<code>istio-pilot</code>ã€Sidecaræ³¨å…¥<code>istio-sidecar-injector</code>ã€ä»¥åŠSidecar<code>istio-proxy</code>ï¼Œ
åˆ†åˆ«ç”±ä¸‰ä¸ªæ¨¡å—è´Ÿè´£ï¼š<code>pilot-discovery</code>ã€<code>sidecar-injector</code>ã€<code>pilot-agent</code>ï¼Œè¿™é‡Œä»<code>pilot-discovery</code>å¼€å§‹ã€‚</p>

<h2 id="discoveryè¿è¡Œåºåˆ—">Discoveryè¿è¡Œåºåˆ—</h2>

<h3 id="kubeç¯å¢ƒç®€åŒ–åºåˆ—">kubeç¯å¢ƒç®€åŒ–åºåˆ—</h3>

<pre><code class="language-mermaid">sequenceDiagram
    participant s as server
    participant f as fileWatcher
    participant i as k8s.io/client-go&lt;br/&gt;informer
    participant h as handler
    
    Note over s: mesh
    s -&gt;&gt; f: addFieWatcher()
    Note over s: meshNetworks
    s -&gt;&gt; f: addFileWatcher()
    Note over s: config
        loop IstioConfigTypes
        s -&gt;&gt; i: cache.NewSharedIndexInformer()
        end
    Note over s: service
        s -&gt;&gt; i: Services().Informer()
        s -&gt;&gt; i: Endpoints().Informer()
        s -&gt;&gt; i: Nodes().Informer()
        s -&gt;&gt; i: Pods().Informer()
    Note over s: discovery
        s -&gt;&gt; h: service.AppendServiceHandler()
        s -&gt;&gt; h: service.AppendInstanceHandler()
        s -&gt;&gt; h: config.RegisterEventHandler()
    
    alt fsnotify
        f -&gt;&gt; s: fsnotify.Event()
        s -&gt;&gt; s: discovery.ConfigUpdate(true)
    end
        
    alt K8S
        i -&gt;&gt; h: handler.Apply()
        loop handler.funcs
            h -&gt;&gt; s: discovery.ConfigUpdate()
        end
    end

</code></pre>

<h3 id="è¯¦ç»†åºåˆ—">è¯¦ç»†åºåˆ—</h3>

<pre><code class="language-mermaid">sequenceDiagram
    participant b as bootstrap
    participant kc as k8s.io/client-go
    participant cmd as cmd
    participant c as config/&lt;br/&gt;aggregate&lt;br/&gt;kube&lt;br/&gt;â€¦â€¦
    
    participant k as kube
    participant m as model
    participant pe as proxy/envoy
    participant sr as serviceregistry
    
    
    b -&gt;&gt; b: NewServer()
    Note left of b: initKubeClient()
    b -&gt;&gt; k: kube.CreateClientset()
    k --&gt;&gt; b: kubeClient *kubernetes.Clientset
    
    Note left of b: ç½‘æ ¼é…ç½®&lt;br/&gt;initMesh()
        Note over kc,cmd: é»˜è®¤ConfigFile&lt;br/&gt;/etc/istio/config/mesh
        alt args.Mesh.ConfigFile != &quot;&quot;
        b -&gt;&gt; cmd: cmd.ReadMeshConfig(args.Mesh.ConfigFile)
        cmd --&gt;&gt; b: mesh *meshconfig.MeshConfig
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&lt;br/&gt;ï¸addFileWatcher(args.Mesh.ConfigFile)&lt;br/&gt;mesh reload&lt;br/&gt;âœ…s.EnvoyXdsServer.ConfigUpdate()
        else K8s ConfigMap è·å–é…ç½®
        b -&gt;&gt; b: GetMeshConfig(s.kubeClient, kube.IstioNamespace, kube.IstioConfigMap)
        b -&gt;&gt; m: model.DefaultMeshConfig()/model.ApplyMeshConfigDefaults(cfgYaml)
        m --&gt;&gt; b: mesh meshconfig.MeshConfig
        end
    
    Note left of b: Meshç½‘ç»œé…ç½®&lt;br/&gt;initMeshNetworks()
        Note over kc,cmd: é»˜è®¤NetworksConfigFile&lt;br/&gt;/etc/istio/config/meshNetworks
        alt args.NetworksConfigFile != &quot;&quot;
        b -&gt;&gt; cmd: cmd.ReadMeshNetworksConfig()
        cmd --&gt;&gt; b: meshNetworks *meshconfig.MeshNetworks
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&lt;br/&gt;addFileWatcher(args.NetworksConfigFile)&lt;br/&gt;meshNetworks reload&lt;br/&gt;âœ…s.EnvoyXdsServer.ConfigUpdate()
        end
    
    Note left of b: Mixer&lt;br/&gt;initMixerSan()
        alt s.mesh.DefaultConfig.ControlPlaneAuthPolicy == meshconfig.AuthenticationPolicy_MUTUAL_TLS
        b -&gt;&gt; pe: envoy.GetMixerSAN(args.Namespace)
        pe -&gt;&gt; b: SpiffeURI string
        Note over kc,cmd: s.mixerSAN[SpiffeURI]&lt;br/&gt;NewDiscoveryServiceçš„Env
        end
    
    Note left of b: é…ç½®ç®¡ç†&lt;br/&gt;initConfigController()
        alt len(args.MCPServerAddrs) &gt; 0 || len(s.mesh.ConfigSources) &gt; 0
        Note over kc,cmd: s.initMCPConfigController()
            Note over kc,cmd: var clients []*client.Client&lt;br/&gt;var clients2 []*sink.Client&lt;br/&gt;var conns []*grpc.ClientConn&lt;br/&gt;var configStores []model.ConfigStoreCache
            loop s.mesh.ConfigSources
                alt url.Scheme == fsScheme
                b -&gt;&gt; c: memory.NewController(store)
                c --&gt;&gt; b: configController model.ConfigStoreCache
                Note over kc,cmd: configStores = append(configStores, configController)
                else
                b -&gt;&gt; c: coredatamodel.NewController()
                c --&gt;&gt; b: mcpController CoreDataModel
                Note over kc,cmd: clients = append(clients, mcpClient)&lt;br/&gt;clients2 = append(clients2, mcpClient2)&lt;br/&gt;mcpControlleræ˜¯MCP Clientçš„Updater&lt;br/&gt;å½“Clientç«¯æ”¶åˆ°Responseæ—¶&lt;br/&gt;é€šè¿‡Updater.Apply()æ¥å£é€šçŸ¥æ›´æ–°
                Note over kc,cmd: conns = append(conns, conn)&lt;br/&gt;configStores = append(configStores, mcpController)
                end
            end
            
            alt len(configStores) == 0
            Note over kc,cmd: ConfigSourcesæœªåŠ è½½é…ç½®&lt;br/&gt;ä»MCPServerAddrsåŠ è½½
            loop args.MCPServerAddrs
            b -&gt;&gt; c: coredatamodel.NewController()
            c --&gt;&gt; b: mcpController CoreDataModel
            Note over kc,cmd: conns = append(conns, conn)&lt;br/&gt;configStores = append(configStores, mcpController)
            end
            end
            
            
            Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&lt;br/&gt;s.addStartFunc(go func() {client.Run(ctx)}())&lt;br/&gt;MCP Clientså¯åŠ¨&lt;br/&gt;æ¥æ”¶åˆ°Responseé€šçŸ¥mcpController&lt;br/&gt;Apply(*Change)&lt;br/&gt;model.ServiceEntry.Typeçš„ä¿®æ”¹é€šçŸ¥åˆ°serviceEntryEvents()&lt;br/&gt;â—åœ¨external.NewServiceDiscovery()æœ‰model.ServiceEntry.Typeçš„handler
            Note over kc,cmd: é…ç½®æ±‡æ€»
            b -&gt;&gt; c: configaggregate.MakeCache(configStores)
            c --&gt;&gt; b: aggregateMcpController model.ConfigStoreCache
            
        else args.Config.Controller != nil
        Note over kc,cmd: s.configController = args.Config.Controller
        else args.Config.FileDir != &quot;&quot;
        Note over kc,cmd: configController := memory.NewController(store)
        else é»˜è®¤KubeConfig
        Note over kc,cmd: controller, err := s.makeKubeConfigController(args)
        end
        
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&lt;br/&gt;s.addStartFunc ( go s.configController.Run(stop) )&lt;br/&gt;é…ç½®Controllerå¯åŠ¨&lt;br/&gt;å¤„ç†é…ç½®å˜æ›´çš„EventHandler&lt;br/&gt;memoryã€kube.crdçš„Controlleræœ‰Run()å®ç°
        Note over kc,cmd: memoryé€šè¿‡makeFileMonitor()ç›‘æ§æ–‡ä»¶&lt;br/&gt;æ¥æ”¶èµ„æºå˜æ›´æ—¶æ›´æ–°configStore&lt;br/&gt;å¹¶é€šè¿‡monitor.ScheduleProcessEvent()åˆ†å‘äº‹ä»¶&lt;br/&gt;â—RegisterEventHandlerå°†handler Appendåˆ°monitorçš„handlers
        Note over kc,cmd: kube.crd.cacheHandlerè¿è¡Œinformer&lt;br/&gt;informerç›‘æ§ä¸åŒConfigType&lt;br/&gt;informerå°†èµ„æºAddã€Updateã€Deleteäº‹ä»¶ç»Ÿä¸€å‹å…¥Queue&lt;br/&gt;Queue Run()é€ä¸ªäº‹ä»¶å¤„ç†ï¼Œå³cacheHandlerçš„hander.funcs&lt;br/&gt;â—RegisterEventHandlerå°†handler Appendåˆ°hander.funcs
        Note over b,c: ğŸ’šğŸ’šğŸ’šğŸ’šğŸ’š&lt;br/&gt;RegisterEventHandler()&lt;br/&gt;&lt;br/&gt;â—åœ¨Discoveryå’ŒServiceRegistryæœ‰handleræ³¨å†Œ
        
        alt hasKubeRegistry(args) &amp;&amp; s.mesh.IngressControllerMode != meshconfig.MeshConfig_OFF
        Note over kc,cmd: K8s ingressçš„ConfigController
        b -&gt;&gt; c: ingress.NewController()
        c --&gt;&gt; b: ingress model.ConfigStoreCache
        b -&gt;&gt; c: configaggregate.MakeCache(s.configController, ingress)
        c --&gt;&gt; b: configController model.ConfigStoreCache
        b -&gt;&gt; c: ingress.NewStatusSyncer()
        c --&gt;&gt; b: ingressSyncer *StatusSyncer
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&lt;br/&gt;s.addStartFunc ( go ingressSyncer.Run(stop) )&lt;br/&gt;Ingress Syncerå¯åŠ¨
        end
        b -&gt;&gt; m: model.MakeIstioStore(s.configController)
        m --&gt;&gt; b: istioConfigStore IstioConfigStore
        Note over b,c: ğŸ’šğŸ’šğŸ’šğŸ’šğŸ’š&lt;br/&gt;istioConfigStoreæä¾›Istioé…ç½®è·å–&lt;br/&gt;ä¸»è¦ä¸ºConfigStoreçš„List()æ¥å£
    
    Note left of b: æœåŠ¡æ³¨å†Œ&lt;br/&gt;initServiceControllers()
        b -&gt;&gt; sr: aggregate.NewController()
        sr --&gt;&gt; b: serviceControllers *Controller
        loop args.Service.Registries
        Note over b,c: ğŸ’šğŸ’šğŸ’šğŸ’šğŸ’š&lt;br/&gt;å¤šæ³¨å†Œä¸­å¿ƒ&lt;br/&gt;Controlleré€šè¿‡AppendServiceHandler()ã€AppendInstanceHandler()æ¥æ”¶å¤–éƒ¨Handler&lt;br/&gt;åœ¨æœ‰å˜æ›´æ—¶è½®è¯¢Handler&lt;br/&gt;â—Discoveryä¼šAppendHandler
        alt serviceregistry.MockRegistry
        b -&gt;&gt; b: s.initMemoryRegistry()
        b -&gt;&gt; sr: srmemory.NewDiscovery() aggregate.Registry{}
        b --&gt;&gt; b: serviceControllers.AddRegistry()
        else serviceregistry.KubernetesRegistry
        b -&gt;&gt; b: s.createK8sServiceControllers()
        b -&gt;&gt; sr: kube.NewController()
        b --&gt;&gt; b: serviceControllers.AddRegistry()
        else serviceregistry.ConsulRegistry
        b -&gt;&gt; b: s.initConsulRegistry()
        b -&gt;&gt; sr: consul.NewController()
        b --&gt;&gt; b: serviceControllers.AddRegistry()
        else serviceregistry.MCPRegistry
        Note over kc,cmd: no-op: get service info from MCP ServiceEntries.
        end
        end
        b -&gt;&gt; sr: external.NewServiceDiscovery()
        sr --&gt;&gt; b: serviceEntryStore *ServiceEntryStore
        b --&gt;&gt; b: serviceControllers.AddRegistry()
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&lt;br/&gt;s.addStartFunc()&lt;br/&gt;æœåŠ¡æ³¨å†ŒControllerså¯åŠ¨
    
    Note left of b: æœåŠ¡å‘ç°&lt;br/&gt;initDiscoveryService()&lt;br/&gt;gRPCå’ŒHTTPæœåŠ¡
        b -&gt;&gt; pe: envoy.NewDiscoveryService()
        Note over b,c: ğŸ’šğŸ’šğŸ’šğŸ’šğŸ’šds.clearCache()å°è£…ä¸ºHandler&lt;br/&gt;æ¥æ”¶s.ServiceControllerã€s.configControllerçš„å˜æ›´é€šçŸ¥&lt;br/&gt;âœ…s.ServiceController.AppendServiceHandler()&lt;br/&gt;âœ…s.ServiceController.AppendInstanceHandler()&lt;br/&gt;âœ…s.configController.RegisterEventHandler()
        pe --&gt;&gt; b: discovery *DiscoveryService
        Note over kc,cmd: HTTP&lt;br/&gt;envoy.DiscoveryServiceæä¾›/v1/registrationä»¥åŠ/debug/pprof/* RESTæ¥å£
        b --&gt; b: s.mux = discovery.RestContainer.ServeMux
        b -&gt;&gt; pe: envoyv2.NewDiscoveryServer()
        pe --&gt;&gt; b: s.EnvoyXdsServer *DiscoveryServer
        Note over kc,cmd: gRPC&lt;br/&gt;envoyv2.DiscoveryServer&lt;br/&gt;åªæä¾›StreamAggregatedResources()æœåŠ¡&lt;br/&gt;xDSç®¡ç†
        Note over kc,cmd: s.initGrpcServer()&lt;br/&gt;s.httpServer&lt;br/&gt;http.Server{Handler: s.mux}        
        Note over kc,cmd: http listener&lt;br/&gt;grpc listener
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸â¤ï¸ï¸s.addStartFunc()&lt;br/&gt;s.httpServer.Serve()&lt;br/&gt;s.grpcServer.Serve()
        alt args.DiscoveryOptions.SecureGrpcAddr != &quot;&quot;
        b -&gt;&gt; b: initSecureGrpcServer()
            Note over kc,cmd: s.secureGRPCServer&lt;br/&gt;s.secureHTTPServer
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&lt;br/&gt;s.addStartFunc()&lt;br/&gt;s.secureHTTPServer.ServeTLS()
        end
        
        Note right of b: 
    
    Note left of b: ç›‘æ§&lt;br/&gt;initMonitor()
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&lt;br/&gt;s.addStartFunc()&lt;br/&gt;startMonitor()
    
    Note left of b: é›†ç¾¤&lt;br/&gt;initClusterRegistries()
        b -&gt;&gt; c: clusterregistry.NewMulticluster()
        c --&gt;&gt; b: multicluster *Multicluster
</code></pre>

<h2 id="discovery-serveræµç¨‹">Discovery Serveræµç¨‹</h2>

<pre><code class="language-mermaid">graph LR
    
    
    s(ads.StreamAggregatedResources)
    style s fill:#f9f
    s --&gt; rc(reqChannel)
    s --&gt; pc(pushChannel)
    style rc fill:#f9f
    style pc fill:#f9f
    
    subgraph reqChannel
        rc --&gt; dt{discReq.TypeUrl}
        dt --&gt;|ClusterType| pushCds[&quot;pushCds()&quot;]
        dt --&gt;|ListenerType| pushLds[&quot;pushLds()&quot;]
        dt --&gt;|RouteType| pushRoute[&quot;pushRoute()&quot;]
        dt --&gt;|EndpointType| pushEds[&quot;pushEds()&quot;]
    end
    
    subgraph pushChannel
        nd(&quot;NewDiscoveryServer&quot;) --&gt; pr(&quot;periodicRefresh&quot;)
        nd --&gt; ash(&quot;s.ServiceController.AppendServiceHandler()&quot;)
        nd --&gt; aih(&quot;s.ServiceController.AppendInstanceHandler()&quot;)
        nd --&gt; reh(&quot;s.configController.RegisterEventHandler()&quot;)
        ash --&gt; clearCache(&quot;clearCache()&quot;)
        aih --&gt; clearCache
        reh --&gt; clearCache
        clearCache --&gt;|full=true| ds(&quot;ds.ConfigUpdate()&quot;)
        pr --&gt; pa(&quot;ads.AdsPushAll()&quot;)         
        
        sp(&quot;ads.startPush()&quot;) --&gt; pc
        
        c(config) --MeshConfig/MeshNetworks/MCPConfig--&gt; ds
        ds --&gt; dp(&quot;doPush()&quot;)
        dp --&gt; push(&quot;Push()&quot;)
        
        push --&gt; pa
        pa --&gt; updateCluster[&quot;eds.updateCluster()&quot;]
        push --&gt; updateServiceShards[&quot;eds.updateServiceShards()&quot;]
        pa --&gt; ei(&quot;eds.edsIncremental()&quot;)
        ei --&gt; updateClusterInc(&quot;eds.updateClusterInc()&quot;)
        pa --&gt; sp
        ei --&gt; sp
        updateClusterInc --&gt; updateCluster
        
        
        pc --&gt; pushConn(pushConnection)
        pushConn -.-&gt; C/E/L/Rds
    end
</code></pre>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">æ–‡ç« ä½œè€…</span>
    <span class="item-content">Hobo Chen</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">ä¸Šæ¬¡æ›´æ–°</span>
    <span class="item-content">2019-03-30</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">è®¸å¯åè®®</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>

    
    

    <footer class="post-footer">
      <div class="post-tags">
          
          <a href="/tags/service-mesh/">Service Mesh</a>
          
          <a href="/tags/istio/">Istio</a>
          
          <a href="/tags/%E6%BA%90%E7%A0%81/">æºç </a>
          
        </div>

      
      <nav class="post-nav">
        
        
          <a class="next" href="/post/servicemesh/2019-03-09-istio-rbac-quick-start/">
            <span class="next-text nav-default">ã€Istioå®‰å…¨ã€‘æœåŠ¡é—´è®¿é—®æ§åˆ¶-RBAC</span>
            <span class="prev-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
    

  

  

  <script src="https://utteranc.es/client.js"
          repo="hb-chen/hbchen.com"
          label="utterances"
          theme="github-light"
          issue-term="pathname"
          crossorigin="anonymous"
          async>
  </script>

  
  </article>
        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:hobo@hbchen.com" rel="me" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/hobo_chen" rel="me" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/hb-chen" rel="me" class="iconfont icon-github" title="github"></a>
  <a href="http://hbchen.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy; 
    
      2013 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">HB Studio</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001"></script>
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>
<script type="text/javascript" src="/dist/jane.min.js?v=2.7.0"></script>

<script type="text/javascript" src="https://unpkg.com/mermaid@8.0.0/dist/mermaid.min.js"></script>
<script>
    mermaid.initialize({
        startOnLoad: true,
        theme: "forest"
    });
</script><script id="tencent_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
	hm.src = "//tajs.qq.com/stats?sId=65523817";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>





</body>
</html>
