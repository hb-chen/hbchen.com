<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>HB-æŠ€æœ¯å®è·µ</title>
    <link>http://hbchen.com/</link>
    <description>Recent content on HB-æŠ€æœ¯å®è·µ</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <copyright>HB Studio èœ€ICPå¤‡18021614å·-1</copyright>
    <lastBuildDate>Sun, 20 Aug 2017 21:38:52 +0800</lastBuildDate>
    
        <atom:link href="http://hbchen.com/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>About</title>
      <link>http://hbchen.com/about/</link>
      <pubDate>Sun, 20 Aug 2017 21:38:52 +0800</pubDate>
      
      <guid>http://hbchen.com/about/</guid>
      
        <description>

&lt;h2 id=&#34;about&#34;&gt;About&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/micro-in-cn&#34;&gt;Microä¸­å›½ç«™&lt;/a&gt;æˆå‘˜&lt;/li&gt;
&lt;li&gt;Golangã€PHPã€Objective-C&amp;hellip; ä¸€çº¿ç å†œï¼Œå…¨æ ˆæ¶æ„&lt;/li&gt;
&lt;li&gt;ä¸“æ³¨äºå¾®æœåŠ¡æ¶æ„ä¸æœåŠ¡ç½‘æ ¼çš„åº”ç”¨&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;github&#34;&gt;GitHub&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;go-microå®è·µ &lt;a href=&#34;https://github.com/micro-in-cn/starter-kit&#34;&gt;micro-in-cn/starter-kit&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Echoå®è·µ &lt;a href=&#34;https://github.com/hb-go/echo-web&#34;&gt;hb-go/echo-web&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Istioå¾®æœåŠ¡æ¶æ„å®è·µ &lt;a href=&#34;https://github.com/hb-go/micro-mesh&#34;&gt;hb-go/micro-mesh&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;More &lt;a href=&#34;https://github.com/hb-chen&#34;&gt;GitHub&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;å¾®ä¿¡&#34;&gt;å¾®ä¿¡&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/wechat.jpg&#34; alt=&#34;å¾®ä¿¡&#34; /&gt;&lt;/p&gt;
</description>
      
    </item>
    
    <item>
      <title>ã€Istioæºç ã€‘Citadel &amp; Node Agent</title>
      <link>http://hbchen.com/post/servicemesh/2020-01-07-istio-code-security/</link>
      <pubDate>Tue, 07 Jan 2020 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/servicemesh/2020-01-07-istio-code-security/</guid>
      
        <description>&lt;p&gt;Istioå®‰å…¨ä¸»è¦åŒ…æ‹¬&lt;strong&gt;è®¤è¯&lt;/strong&gt;å’Œ&lt;strong&gt;æˆæƒ&lt;/strong&gt;ï¼Œæœ‰å…³æˆæƒçš„&lt;code&gt;RBAC&lt;/code&gt;ä½¿ç”¨å‚è€ƒä¹‹å‰çš„æ–‡ç« &lt;a href=&#34;http://hbchen.com/post/servicemesh/2019-03-09-istio-rbac-quick-start/#1-å¼€å¯æˆæƒ-clusterrbacconfig&#34;&gt;ã€Istioå®‰å…¨ã€‘æœåŠ¡é—´è®¿é—®æ§åˆ¶-RBAC&lt;/a&gt;
ï¼Œä¸è¿‡&lt;code&gt;RBAC&lt;/code&gt;å·²ç»&lt;a href=&#34;https://istio.io/docs/reference/config/security/istio.rbac.v1alpha1/&#34;&gt;å‡†å¤‡åºŸå¼ƒ&lt;/a&gt;è¢«&lt;code&gt;Authorization&lt;/code&gt;æ›¿ä»£ï¼Œ
&lt;strong&gt;è®¤è¯&lt;/strong&gt;åˆ™åˆ†ä¸º&lt;strong&gt;æœåŠ¡é—´èº«ä»½éªŒè¯&lt;/strong&gt;å’Œ&lt;strong&gt;æ¥æºèº«ä»½è®¤è¯&lt;/strong&gt;ï¼ŒæœåŠ¡é—´èº«ä»½éªŒè¯Istioæä¾›äº†&lt;strong&gt;åŒå‘TLS&lt;/strong&gt;æ–¹æ¡ˆï¼Œå…¶ä¸­æ¶‰åŠçš„ç§˜é’¥ç®¡ç†æœåŠ¡ï¼Œä¸»è¦ç”±&lt;code&gt;istio/security&lt;/code&gt;æ¨¡å—çš„
&lt;code&gt;Citadel&lt;/code&gt;å’Œ&lt;code&gt;Node Agent&lt;/code&gt;æä¾›ï¼Œæœ¬æ–‡ä¸»è¦åˆ†æè¿™éƒ¨åˆ†çš„æºç å®ç°ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Istio 1.14.0&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h1 id=&#34;pki&#34;&gt;PKI&lt;/h1&gt;

&lt;p&gt;é¦–å…ˆå‚è€ƒ&lt;a href=&#34;https://preliminary.istio.io/zh/docs/concepts/security/#pki&#34;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;[&lt;a href=&#34;https://istio.io/docs/concepts/security/#pki&#34;&gt;en&lt;/a&gt;]çœ‹ä¸‹å‡ ç§ä¸åŒåœºæ™¯çš„æ–¹æ¡ˆï¼Œå…¶ä¸­&lt;code&gt;Kubernetes æ–¹æ¡ˆ&lt;/code&gt;æœ€ç®€å•ï¼Œ
&lt;code&gt;Kubernetes ä¸­çš„ä»£ç†èŠ‚ç‚¹&lt;/code&gt;æ›´é€‚åˆç”Ÿäº§ï¼Œå…·ä½“ä¼˜åŠ¿&lt;a href=&#34;https://preliminary.istio.io/zh/docs/tasks/security/citadel-config/auth-sds&#34;&gt;å‚è€ƒ&lt;/a&gt;[&lt;a href=&#34;https://istio.io/docs/tasks/security/citadel-config/auth-sds/&#34;&gt;en&lt;/a&gt;]ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Kubernetes æ–¹æ¡ˆ

&lt;ul&gt;
&lt;li&gt;Citadel ç›‘è§† Kubernetes apiserverï¼Œä¸ºæ¯ä¸ªç°æœ‰å’Œæ–°çš„æœåŠ¡å¸æˆ·åˆ›å»º SPIFFE è¯ä¹¦å’Œå¯†é’¥å¯¹ã€‚Citadel å°†è¯ä¹¦å’Œå¯†é’¥å¯¹å­˜å‚¨ä¸º Kubernetes secretã€‚&lt;/li&gt;
&lt;li&gt;åˆ›å»º pod æ—¶ï¼ŒKubernetes ä¼šæ ¹æ®å…¶æœåŠ¡å¸æˆ·é€šè¿‡ Kubernetes secret volume å°†è¯ä¹¦å’Œå¯†é’¥å¯¹æŒ‚è½½åˆ° pod ä¸Šã€‚&lt;/li&gt;
&lt;li&gt;Citadel ç›‘è§†æ¯ä¸ªè¯ä¹¦çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶é€šè¿‡é‡å†™ Kubernetes secret è‡ªåŠ¨è½®æ¢è¯ä¹¦ã€‚&lt;/li&gt;
&lt;li&gt;Pilot ç”Ÿæˆå®‰å…¨å‘½åä¿¡æ¯ï¼Œè¯¥ä¿¡æ¯å®šä¹‰äº†å“ªäº› Service Account å¯ä»¥è¿è¡Œå“ªäº›æœåŠ¡ã€‚Pilot ç„¶åå°†å®‰å…¨å‘½åä¿¡æ¯ä¼ é€’ç»™ envoy sidecarã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;æœ¬åœ°æœºå™¨æ–¹æ¡ˆ

&lt;ul&gt;
&lt;li&gt;Citadel åˆ›å»º gRPC æœåŠ¡æ¥æ¥å—è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆCSRï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;èŠ‚ç‚¹ä»£ç†ç”Ÿæˆç§é’¥å’Œ CSRï¼Œå¹¶å°† CSR åŠå…¶å‡­æ®å‘é€ç»™ Citadel è¿›è¡Œç­¾åã€‚&lt;/li&gt;
&lt;li&gt;Citadel éªŒè¯ CSR æ‰¿è½½çš„å‡­è¯ï¼Œå¹¶ç­¾ç½² CSR ä»¥ç”Ÿæˆè¯ä¹¦ã€‚&lt;/li&gt;
&lt;li&gt;èŠ‚ç‚¹ä»£ç†å°†ä» Citadel æ¥æ”¶çš„è¯ä¹¦å’Œç§é’¥å‘é€ç»™ Envoyã€‚&lt;/li&gt;
&lt;li&gt;ä¸Šè¿° CSR è¿‡ç¨‹ä¼šå®šæœŸé‡å¤è¿›è¡Œè¯ä¹¦å’Œå¯†é’¥è½®æ¢ã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;Kubernetes ä¸­çš„ä»£ç†èŠ‚ç‚¹

&lt;ul&gt;
&lt;li&gt;Citadel åˆ›å»ºä¸€ä¸ª gRPC æœåŠ¡æ¥æ¥å— CSR è¯·æ±‚ã€‚&lt;/li&gt;
&lt;li&gt;Envoy é€šè¿‡ Envoy secret å‘ç°æœåŠ¡ï¼ˆSDSï¼‰API å‘é€è¯ä¹¦å’Œå¯†é’¥è¯·æ±‚ã€‚&lt;/li&gt;
&lt;li&gt;æ”¶åˆ° SDS è¯·æ±‚åï¼ŒèŠ‚ç‚¹ä»£ç†ä¼šåˆ›å»ºç§é’¥å’Œ CSRï¼Œå¹¶å°† CSR åŠå…¶å‡­æ®å‘é€ç»™ Citadel è¿›è¡Œç­¾åã€‚&lt;/li&gt;
&lt;li&gt;Citadel éªŒè¯ CSR ä¸­æºå¸¦çš„å‡­è¯ï¼Œå¹¶ç­¾ç½² CSR ä»¥ç”Ÿæˆè¯ä¹¦ã€‚&lt;/li&gt;
&lt;li&gt;èŠ‚ç‚¹ä»£ç†é€šè¿‡ Envoy SDS API å°†ä» Citadel æ¥æ”¶çš„è¯ä¹¦å’Œç§é’¥å‘é€ç»™ Envoyã€‚&lt;/li&gt;
&lt;li&gt;ä¸Šè¿° CSR è¿‡ç¨‹ä¼šå®šæœŸé‡å¤è¿›è¡Œè¯ä¹¦å’Œå¯†é’¥è½®æ¢ã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h1 id=&#34;caç®¡ç†-citadel&#34;&gt;CAç®¡ç†-Citadel&lt;/h1&gt;

&lt;p&gt;Citadel(æºç å…¥å£&lt;code&gt;istio/security/cmd/istio_ca&lt;/code&gt;)æ˜¯Istioè‡ªå¸¦çš„ç§˜é’¥ç®¡ç†æœåŠ¡ï¼Œä½¿ç”¨ä»£ç†èŠ‚ç‚¹ä¹Ÿæ”¯æŒå¤–éƒ¨CAç³»ç»Ÿï¼Œå¦‚ï¼šVaultCAå’ŒGoogleCAã€‚&lt;/p&gt;

&lt;p&gt;åŒ…æ‹¬ä»¥ä¸‹èƒ½åŠ›ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;è¯ä¹¦ç®¡ç†:&lt;code&gt;pki/ca&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#istioca&#34;&gt;IstioCA&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;å·¥ä½œè´Ÿè½½çš„è¯ä¹¦è½®æ¢:&lt;code&gt;k8s/controller&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#secretcontroller&#34;&gt;SecretController&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;è¯ä¹¦ç­¾åæœåŠ¡:&lt;code&gt;server/ca&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#server&#34;&gt;Server&lt;/a&gt;
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;em&gt;TODO é…å›¾&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&#34;istioca&#34;&gt;IstioCA&lt;/h2&gt;

&lt;p&gt;IstioCaæ”¯æŒä¸¤ç§æ–¹å¼ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;è‡ªç­¾åè¯ä¹¦ï¼Œè‡ªåŠ¨è½®æ¢&lt;a href=&#34;#selfsignedca&#34;&gt;SelfSignedCA&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;å¤–éƒ¨æ–‡ä»¶è¯ä¹¦
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;selfsignedca&#34;&gt;SelfSignedCA&lt;/h3&gt;

&lt;p&gt;è‡ªç­¾åè¯ä¹¦ï¼Œè‡ªåŠ¨è½®æ¢ç®¡ç†ç”±&lt;code&gt;SelfSignedCARootCertRotator&lt;/code&gt;å®ç°ï¼Œé»˜è®¤&lt;code&gt;1å°æ—¶&lt;/code&gt;åšä¸€æ¬¡è¯ä¹¦çš„æ£€æŸ¥ã€‚&lt;/p&gt;

&lt;h2 id=&#34;secretcontroller&#34;&gt;SecretController&lt;/h2&gt;

&lt;p&gt;åœ¨Kubernetesæ–¹æ¡ˆä¸­å·¥ä½œè´Ÿè½½çš„è¯ä¹¦ç®¡ç†ï¼ŒCitadelé€šè¿‡ä¿®æ”¹&lt;code&gt;secret&lt;/code&gt;å¯¹å·¥ä½œè´Ÿè½½çš„è¯ä¹¦è¿›è¡Œç®¡ç†ï¼Œ&lt;code&gt;SecretController&lt;/code&gt;ç›‘æ§&lt;code&gt;ServiceAccount&lt;/code&gt;çš„åˆ›å»ºã€åˆ é™¤ï¼Œ
&lt;code&gt;Secret&lt;/code&gt;çš„åˆ é™¤ã€æ›´æ–°ï¼Œä»¥åŠ&lt;code&gt;Namespace&lt;/code&gt;çš„æ›´æ–°ï¼Œåœ¨äº§ç”Ÿå˜æ›´æ—¶ä¿®æ”¹&lt;code&gt;secret&lt;/code&gt;å®Œæˆè¯ä¹¦çš„è½®æ¢ï¼ŒåŒæ—¶&lt;code&gt;Pilot Agent&lt;/code&gt;ä¼šç›‘æ§&lt;code&gt;secret&lt;/code&gt;çš„å˜æ›´ï¼Œå¹¶é‡å¯Envoyä½¿é…ç½®ç”Ÿæ•ˆï¼Œå®Œæˆè¯ä¹¦çš„è½®æ¢ã€‚&lt;/p&gt;

&lt;h2 id=&#34;server&#34;&gt;Server&lt;/h2&gt;

&lt;p&gt;è¯ä¹¦æœåŠ¡ï¼Œä¸&lt;code&gt;nodeagent&lt;/code&gt;çš„&lt;code&gt;caclient&lt;/code&gt;äº¤äº’ï¼ŒåŒ…æ‹¬æœåŠ¡çš„è®¤è¯åŠé‰´æƒç­‰&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;gRPCæœåŠ¡å¦‚ä¸‹:&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;CertificateService

&lt;ul&gt;
&lt;li&gt;CreateCertificate(context.Context, *IstioCertificateRequest) (*IstioCertificateResponse, error)&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;CAService&lt;code&gt;åºŸå¼ƒ&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;HandleCSR(context.Context, *CsrRequest) (*CsrResponse, error)&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;authenticator&#34;&gt;Authenticator&lt;/h3&gt;

&lt;p&gt;gRPCæœåŠ¡è®¤è¯ï¼Œé»˜è®¤ä¸€ä¸ª&lt;code&gt;ClientCertAuthenticator&lt;/code&gt;ï¼Œå½“å¯åŠ¨SDSæ—¶æ·»åŠ äº†&lt;code&gt;KubeJWTAuthenticator&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&#34;authorizer&#34;&gt;Authorizer&lt;/h3&gt;

&lt;p&gt;gRPCæœåŠ¡&lt;code&gt;CAService&lt;/code&gt;å’Œ&lt;code&gt;CertificateService&lt;/code&gt;çš„é‰´æƒ&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;æœåŠ¡çš„&lt;code&gt;Authorizer&lt;/code&gt;éƒ½æ˜¯&lt;code&gt;TODO&lt;/code&gt;çŠ¶æ€&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;strong&gt;registry&lt;/strong&gt;æä¾›äº†ä¸€ä¸ªèº«ä»½æˆæƒçš„æ³¨å†Œè¡¨&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;kube/ServiceController

&lt;ul&gt;
&lt;li&gt;ç›‘æ§&lt;code&gt;Service&lt;/code&gt;åˆ›å»ºã€åˆ é™¤ä¸ä¿®æ”¹&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;kube/ServiceAccountController

&lt;ul&gt;
&lt;li&gt;ç›‘æ§&lt;code&gt;ServiceAccount&lt;/code&gt;åˆ›å»ºã€åˆ é™¤ä¸ä¿®æ”¹
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&#34;node-agent-k8s&#34;&gt;Node Agent K8S&lt;/h1&gt;

&lt;p&gt;NodeAgent(æºç å…¥å£&lt;code&gt;istio/security/cmd/node_agent_k8s&lt;/code&gt;)æ˜¯Citadelåœ¨å·¥ä½œè´Ÿè½½&lt;code&gt;node&lt;/code&gt;æˆ–è€…ç½‘å…³&lt;code&gt;pod&lt;/code&gt;ä¸­çš„ä»£ç†ï¼Œä¸ºEnvoyæä¾›&lt;code&gt;SDS&lt;/code&gt;æœåŠ¡ï¼Œå¹¶ä¸Citadeläº¤äº’å‘èµ·&lt;code&gt;CSR&lt;/code&gt;è¯·æ±‚ã€‚
ä½¿ç”¨&lt;strong&gt;Kubernetesä¸­çš„ä»£ç†èŠ‚ç‚¹&lt;/strong&gt;æ¨¡å¼æ—¶Citadelå¯ä»¥è¿è¡Œä¸º&lt;code&gt;server-only&lt;/code&gt;æ¨¡å¼ï¼Œå³ä¸åšå·¥ä½œè´Ÿè½½çš„è¯ä¹¦ç®¡ç†ã€‚&lt;/p&gt;

&lt;p&gt;&lt;em&gt;TODO é…å›¾&lt;/em&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Node Agentæºç å‡åœ¨&lt;code&gt;nodeagent&lt;/code&gt;ç›®å½•&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;ca-client&#34;&gt;CA Client&lt;/h2&gt;

&lt;p&gt;æä¾›CSRç­¾åæ¥å£ï¼ŒæœåŠ¡å®ç°æ”¯æŒ&lt;code&gt;citadel&lt;/code&gt;ã€&lt;code&gt;google&lt;/code&gt;ã€&lt;code&gt;vault&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Clientæ¥å£&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// Client interface defines the clients need to implement to talk to CA for CSR.
type Client interface {
	CSRSign(ctx context.Context, csrPEM []byte, subjectID string,
		certValidTTLInSec int64) ([]string /*PEM-encoded certificate chain*/, error)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;secret-fetcher&#34;&gt;Secret Fetcher&lt;/h2&gt;

&lt;p&gt;ä½œä¸ºWorkloadä»£ç†æ—¶æ ¹æ®ä¸åŒçš„Providerå®ä¾‹åŒ–CA Clientï¼Œæˆ–è€…ä½œä¸ºIngress Gatewayä»£ç†æ—¶ç›‘æ§&lt;code&gt;secret&lt;/code&gt;å˜æ›´ï¼Œå¹¶é€šçŸ¥åˆ°&lt;code&gt;secretcache&lt;/code&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Workloadä»£ç†ä»¥&lt;code&gt;DaemonSet&lt;/code&gt;åœ¨&lt;code&gt;node&lt;/code&gt;ä¸Šè¿è¡Œï¼Œä½¿ç”¨CA Clientä¸CA Serveräº¤äº’&lt;/li&gt;
&lt;li&gt;Ingress Gatewayä»£ç†ä¸Workloadéƒ¨ç½²æ–¹å¼ä¸åŒï¼Œä»£ç†åœ¨Podå†…è¿è¡Œï¼Œè€Œä¸æ˜¯&lt;code&gt;DaemonSet&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;ç›‘æ§&lt;code&gt;secret&lt;/code&gt;çš„åˆ›å»ºã€åˆ é™¤å’Œæ›´æ–°ï¼Œç”¨äºæ•è·Ingress Gatewayçš„TLSé…ç½®&lt;/li&gt;
&lt;li&gt;&lt;code&gt;secret&lt;/code&gt;æœ‰å˜æ›´æ—¶é€šè¿‡&lt;code&gt;AddCache&lt;/code&gt;ã€&lt;code&gt;DeleteCache&lt;/code&gt;å’Œ&lt;code&gt;UpdateCache&lt;/code&gt;æ–¹æ³•é€šçŸ¥&lt;code&gt;secretcache&lt;/code&gt;åˆ°&lt;code&gt;DeleteK8sSecret&lt;/code&gt;å’Œ&lt;code&gt;UpdateK8sSecret&lt;/code&gt;ï¼Œå†ç”±&lt;code&gt;sds.NotifyProxy&lt;/code&gt;é€šçŸ¥SDSæœåŠ¡&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://preliminary.istio.io/zh/docs/tasks/traffic-management/ingress/secure-ingress-sds/#configure-a-TLS-ingress-gateway-using-sds&#34;&gt;ä½¿ç”¨SDSçš„ä¼˜åŠ¿&lt;/a&gt;[&lt;a href=&#34;https://istio.io/docs/tasks/traffic-management/ingress/secure-ingress-sds/#configure-a-tls-ingress-gateway-using-sds&#34;&gt;en&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;Ingress Gatewayçš„TLSçš„é»˜è®¤é…ç½®æ–¹å¼æ˜¯&lt;a href=&#34;https://preliminary.istio.io/zh/docs/tasks/traffic-management/ingress/secure-ingress-mount/&#34;&gt;æ–‡ä»¶æŒ‚è½½&lt;/a&gt;[&lt;a href=&#34;https://istio.io/docs/tasks/traffic-management/ingress/secure-ingress-mount/&#34;&gt;en&lt;/a&gt;]&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;secret-cache&#34;&gt;Secret Cache&lt;/h2&gt;

&lt;p&gt;ç§˜é’¥ç¼“å­˜ï¼Œè´Ÿè´£ç§˜é’¥çš„è½®æ¢&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;é»˜è®¤10minåšä¸€æ¬¡æ£€æŸ¥ï¼Œå¯¹å³å°†è¿‡æœŸçš„åšè½®æ¢ï¼Œé»˜è®¤1å°æ—¶åè¿‡æœŸçš„è¯ä¹¦å°±åšæ›´æ–°

&lt;ul&gt;
&lt;li&gt;å¦‚æœè½®è¯¢æ—¶&lt;code&gt;token&lt;/code&gt;è¿‡æœŸä¼šè¿”å›&lt;code&gt;secret=nil&lt;/code&gt;ï¼Œè¿™æ—¶SDSæœåŠ¡åœ¨æ”¶åˆ°&lt;code&gt;notify&lt;/code&gt;åéœ€è¦å°†è¿æ¥æ–­å¼€é‡è¿&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;äº§ç”Ÿè½®æ¢æ—¶é€šè¿‡&lt;code&gt;sds.NotifyProxy&lt;/code&gt;é€šçŸ¥åˆ°SDSæœåŠ¡ï¼ŒSDSæœåŠ¡é€šè¿‡&lt;code&gt;connKey&lt;/code&gt;æ‰¾åˆ°å¯¹åº”çš„&lt;code&gt;client&lt;/code&gt;ï¼Œå¹¶é€šè¿‡SDSçš„&lt;code&gt;StreamSecrets&lt;/code&gt;å°†æ–°çš„è¯ä¹¦æ¨é€åˆ°&lt;code&gt;Pod&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;åœ¨&lt;code&gt;generateSecret&lt;/code&gt;æ—¶ï¼Œå¦‚æœæ£€æµ‹åˆ°&lt;code&gt;rootCert&lt;/code&gt;ä¸º&lt;code&gt;nil&lt;/code&gt;æˆ–è€…ä¸&lt;code&gt;certChainPEM&lt;/code&gt;çš„ä¸ä¸€è‡´ï¼Œå°†è§¦å‘&lt;code&gt;rootCert&lt;/code&gt;çš„æ›´æ–°

&lt;ul&gt;
&lt;li&gt;SDSæœåŠ¡å°†æ–°çš„&lt;code&gt;rootCert&lt;/code&gt;åŠ å…¥åˆ°å¯ä¿¡&lt;code&gt;CA&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;SecretManageræ¥å£&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// SecretManager defines secrets management interface which is used by SDS.
type SecretManager interface {
	// GenerateSecret generates new secret and cache the secret.
	GenerateSecret(ctx context.Context, connectionID, resourceName, token string) (*model.SecretItem, error)

	// ShouldWaitForIngressGatewaySecret indicates whether a valid ingress gateway secret is expected.
	ShouldWaitForIngressGatewaySecret(connectionID, resourceName, token string) bool

	// SecretExist checks if secret already existed.
	// This API is used for sds server to check if coming request is ack request.
	SecretExist(connectionID, resourceName, token, version string) bool

	// DeleteSecret deletes a secret by its key from cache.
	DeleteSecret(connectionID, resourceName string)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;sds-service&#34;&gt;SDS Service&lt;/h2&gt;

&lt;p&gt;SDSæœåŠ¡å®ç°&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;NotifyProxy&lt;/code&gt;æ¥æ”¶&lt;code&gt;secret&lt;/code&gt;å˜æ›´çš„é€šçŸ¥

&lt;ul&gt;
&lt;li&gt;æŸ¥æ‰¾&lt;code&gt;client&lt;/code&gt;çš„&lt;code&gt;connection&lt;/code&gt;ï¼Œé€šè¿‡&lt;code&gt;pushChannel&lt;/code&gt;å°†&lt;code&gt;secret&lt;/code&gt;å˜æ›´äº‹ä»¶åˆ†å‘ç»™SDSæœåŠ¡æ¥å£&lt;code&gt;StreamSecrets&lt;/code&gt;ï¼Œç„¶åæ¨é€åˆ°Envoy&lt;/li&gt;
&lt;li&gt;äº‹ä»¶ç±»å‹ï¼š

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Secret_TlsCertificate&lt;/code&gt;TLSè¯ä¹¦&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Secret_ValidationContext&lt;/code&gt;å¯ä¿¡CA&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;æ¥æ”¶Envoyå¯¹SDSæœåŠ¡&lt;code&gt;StreamSecrets&lt;/code&gt;å’Œ&lt;code&gt;FetchSecrets&lt;/code&gt;è¯·æ±‚ï¼Œ&lt;code&gt;SecretManager.GenerateSecret()&lt;/code&gt;ç”Ÿæˆç§˜é’¥&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&#34;ref&#34;&gt;Ref&lt;/h1&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://zhuanlan.zhihu.com/p/59825498&#34;&gt;æ·±åº¦è§£æIstioç³»åˆ—ä¹‹å®‰å…¨æ¨¡å—ç¯‡&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://blog.fleeto.us/post/istio-security-notes/&#34;&gt;Istio å®‰å…¨è®¾ç½®ç¬”è®°&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
      
    </item>
    
    <item>
      <title>ã€go-microã€‘å¾®æœåŠ¡åä½œå¼€å‘ã€ç°åº¦å‘å¸ƒä¹‹æµé‡æŸ“è‰²</title>
      <link>http://hbchen.com/post/microservice/2019-11-30-go-micro-service-chain/</link>
      <pubDate>Sat, 30 Nov 2019 16:40:32 +0800</pubDate>
      
      <guid>http://hbchen.com/post/microservice/2019-11-30-go-micro-service-chain/</guid>
      
        <description>&lt;p&gt;åä½œå¼€å‘ä¸ç°åº¦å‘å¸ƒæ˜¯å¾®æœåŠ¡æ¡†æ¶åœ¨æµé‡æ²»ç†èƒ½åŠ›æ–¹é¢çš„ä¸¤ä¸ªä½“ç°ï¼Œæœ¬æ–‡ç»“åˆ&lt;strong&gt;go-micro&lt;/strong&gt;å®è·µå¯¹æµé‡è¿›è¡ŒæŸ“è‰²ï¼Œå®ç°å¼€å‘ç¯å¢ƒçš„å¤šåˆ†æ”¯åä½œï¼Œ
ä»¥åŠç”Ÿäº§ç¯å¢ƒçš„ç°åº¦å‘å¸ƒã€‚&lt;/p&gt;

&lt;h1 id=&#34;åœºæ™¯&#34;&gt;åœºæ™¯&lt;/h1&gt;

&lt;h2 id=&#34;å¼€å‘ç¯å¢ƒå¤šæœåŠ¡-å¤šåˆ†æ”¯åä½œ&#34;&gt;å¼€å‘ç¯å¢ƒå¤šæœåŠ¡ã€å¤šåˆ†æ”¯åä½œ&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/micro/chain-dev.png&#34; alt=&#34;micro-chain-dev&#34; /&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;QA&lt;/code&gt;ç»„æµ‹è¯•&lt;code&gt;v1.2&lt;/code&gt;å’Œ&lt;code&gt;v2.0&lt;/code&gt;é“¾è·¯

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;v2.0&lt;/code&gt; + &lt;code&gt;v1.2&lt;/code&gt;é“¾è·¯&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;v1.1&lt;/code&gt;ç»„ä»…å…³æ³¨&lt;code&gt;v1.1&lt;/code&gt;çš„ç‰ˆæœ¬å¼€å‘

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;v1.1&lt;/code&gt; + &lt;code&gt;master&lt;/code&gt;é“¾è·¯&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;v1.2&lt;/code&gt;ç»„åœ¨&lt;code&gt;v1.1&lt;/code&gt;å¼€å‘æ–°ç‰ˆ&lt;code&gt;srv-2&lt;/code&gt;æœåŠ¡

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;v1.2&lt;/code&gt; + &lt;code&gt;v1.1&lt;/code&gt; + &lt;code&gt;master&lt;/code&gt;é“¾è·¯&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;v2.0&lt;/code&gt;ç»„ä»…å…³æ³¨&lt;code&gt;v2.0&lt;/code&gt;çš„ç‰ˆæœ¬å¼€å‘

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;v2.0&lt;/code&gt; + &lt;code&gt;master&lt;/code&gt;é“¾è·¯
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;ç”Ÿäº§ç¯å¢ƒç°åº¦å‘å¸ƒ&#34;&gt;ç”Ÿäº§ç¯å¢ƒç°åº¦å‘å¸ƒ&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/micro/chain-gray.png&#34; alt=&#34;micro-chain-gray&#34; /&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æ™®é€šç”¨æˆ·

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Pro&lt;/code&gt;é“¾è·¯&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;ç°åº¦æµ‹è¯•ç”¨æˆ·

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Gray&lt;/code&gt; + &lt;code&gt;Pro&lt;/code&gt;é“¾è·¯&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;QA

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Pre&lt;/code&gt; + &lt;code&gt;Pro&lt;/code&gt;é“¾è·¯&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&#34;æµé‡æŸ“è‰²&#34;&gt;æµé‡æŸ“è‰²&lt;/h1&gt;

&lt;p&gt;&lt;strong&gt;æµé‡æŸ“è‰²æ ¸å¿ƒï¼š&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;gatewayå¯¹è¯·æ±‚è¿›è¡ŒæŸ“è‰²

&lt;ul&gt;
&lt;li&gt;æŸ“è‰²è§„åˆ™å¯ä»¥æ˜¯&lt;code&gt;host&lt;/code&gt;ã€&lt;code&gt;header&lt;/code&gt;å­—æ®µã€&lt;code&gt;agent&lt;/code&gt;ç»ˆç«¯ä¿¡æ¯ã€ç”¨æˆ·ç­›é€‰ã€æµé‡æ¯”ä¾‹ç­‰ç­‰&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;æŸ“è‰²ä¿¡æ¯åœ¨æœåŠ¡é—´ä¼ é€’

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;go-micro&lt;/code&gt;ä¸­&lt;code&gt;http&lt;/code&gt;è¯·æ±‚çš„&lt;code&gt;header&lt;/code&gt;ä»¥åŠ&lt;code&gt;rpc&lt;/code&gt;è¯·æ±‚çš„&lt;code&gt;metadata&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;æœåŠ¡è°ƒç”¨æ—¶æ ¹æ®æŸ“è‰²ä¿¡æ¯å¯¹æœåŠ¡è¿›è¡Œç­›é€‰ï¼Œå®ç°è°ƒç”¨é“¾è·¯çš„ç®¡æ§&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æˆ‘ä»¬åŸºäº&lt;code&gt;go-micro&lt;/code&gt;å®è·µçš„æ˜¯å®ç°&lt;strong&gt;å¤šé“¾è·¯æŸ“è‰²&lt;/strong&gt;ï¼ŒæŸ“è‰²é“¾è·¯å¸¦æœ‰ä¼˜å…ˆçº§ï¼Œå¦‚&lt;a href=&#34;#å¼€å‘ç¯å¢ƒå¤šæœåŠ¡-å¤šåˆ†æ”¯åä½œ&#34;&gt;å¼€å‘ç¯å¢ƒå¤šæœåŠ¡ã€å¤šåˆ†æ”¯åä½œ&lt;/a&gt;çš„&lt;code&gt;v1.2&lt;/code&gt;ç»„ï¼Œ
è™½ç„¶&lt;code&gt;v1.1&lt;/code&gt;å’Œ&lt;code&gt;v1.2&lt;/code&gt;éƒ½æœ‰&lt;code&gt;srv-2&lt;/code&gt;æœåŠ¡ï¼Œä½†æˆ‘ä»¬åœ¨æŸ“è‰²ä¿¡æ¯ä¸­&lt;code&gt;v1.2&lt;/code&gt;åœ¨å‰ä¼˜å…ˆé€‰æ‹©ï¼Œæ‰€ä»¥å¯ä»¥å®ç°å¤šåˆ†æ”¯åŒæ—¶æŸ“è‰²(PSï¼šå¦‚æœä¸¤ä¸ªåˆ†æ”¯ä¸­ä¸¤ä¸ªæœåŠ¡çš„ä¼˜å…ˆçº§ç›¸åæ— æ³•å®ç°ï¼Œéœ€è¦è®¾è®¡æ›´å¤æ‚çš„æŸ“è‰²æ–¹æ¡ˆ)&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;ç½‘å…³æŸ“è‰²åŠ&lt;code&gt;client wrapper&lt;/code&gt;å®ç°å‚è€ƒæˆ‘å®ç°çš„ä¸¤ä¸ª&lt;code&gt;chain&lt;/code&gt;æ’ä»¶&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-plugins/tree/master/micro/chain&#34;&gt;hb-chen/micro-plugin/micro/chain&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-plugins/tree/master/wrapper/select/chain&#34;&gt;hb-chen/micro-plugin/wrapper/select/chain&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;æŸ“è‰²&#34;&gt;æŸ“è‰²&lt;/h2&gt;

&lt;p&gt;åœ¨ç½‘å…³å¯¹æµé‡è¿›è¡Œ&lt;strong&gt;æŸ“è‰²&lt;/strong&gt;ï¼ŒåŸºäº&lt;code&gt;mciro&lt;/code&gt;çš„æ’ä»¶ï¼Œå¯ä»¥æ–¹ä¾¿çš„å®ç°ï¼Œå…·ä½“æŸ“è‰²è§„åˆ™éœ€è¦æ ¹æ®è‡ªèº«éœ€æ±‚å®ç°ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;// é“¾è·¯æŸ“è‰²
api.Register(chain.New(chain.WithChainsFunc(func(r *http.Request) []string {
	return []string{&amp;quot;v2.0&amp;quot;, &amp;quot;v1.2&amp;quot;}
})))

web.Register(chain.New(chain.WithChainsFunc(func(r *http.Request) []string {
	return []string{&amp;quot;v2.0&amp;quot;}
})))
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;è°ƒç”¨é“¾è·¯ç®¡æ§&#34;&gt;è°ƒç”¨é“¾è·¯ç®¡æ§&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;go-micro&lt;/code&gt;å®ç°è°ƒç”¨é“¾è·¯ç®¡æ§ï¼Œæœ€å¤§çš„éšœç¢å°±æ˜¯&lt;strong&gt;ç½‘å…³&lt;/strong&gt;ï¼Œ&lt;code&gt;API&lt;/code&gt;åŠ&lt;code&gt;Web&lt;/code&gt;å‡ä¸æ”¯æŒæœåŠ¡ç­›é€‰ï¼Œéœ€è¦è‡ªå·±äºŒæ¬¡å¼€å‘ï¼Œç›¸å…³é—®é¢˜ä¹Ÿåé¦ˆç»™ç¤¾åŒºçœ‹åç»­è®¡åˆ’&lt;a href=&#34;https://github.com/micro/go-micro/issues/1003&#34;&gt;#1003&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;h3 id=&#34;ç½‘å…³æœåŠ¡ç­›é€‰-å‘&#34;&gt;ç½‘å…³æœåŠ¡ç­›é€‰-å‘&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;APIç½‘å…³&lt;/strong&gt;ä»…å°è¯•äº†&lt;code&gt;api handler&lt;/code&gt;ï¼Œä¿®æ”¹ç›¸å¯¹ç®€å•ï¼Œåªéœ€è¦å¢åŠ &lt;code&gt;ClientWrapper&lt;/code&gt;ï¼Œå¹¶å»æ‰æŒ‡å®šçš„è´Ÿè½½ç­–ç•¥å³å¯ã€‚å¦‚æœä½¿ç”¨å…¶ä»–&lt;code&gt;handler&lt;/code&gt;éœ€è¦é€ä¸ªè§£å†³ã€‚&lt;/p&gt;

&lt;p&gt;&lt;em&gt;1. &lt;code&gt;micro/main.go&lt;/code&gt;æ·»åŠ &lt;code&gt;ClientWrapper&lt;/code&gt;&lt;/em&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func main() {
	cmd.Init(
		// é“¾è·¯æŸ“è‰²
		micro.WrapClient(chain.NewClientWrapper()),
	)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;em&gt;2. &lt;code&gt;go-micro/api/handler/api.go&lt;/code&gt;å»æ‰&lt;code&gt;strategy&lt;/code&gt;ï¼Œ&lt;code&gt;rpc handler&lt;/code&gt;ç±»ä¼¼&lt;/em&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// create strategy
// so := selector.WithStrategy(strategy(service.Services))

// if err := c.Call(cx, req, rsp, client.WithSelectOption(so)); err != nil {
if err := c.Call(cx, req, rsp); err != nil {
	
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;Webç½‘å…³&lt;/strong&gt;ç›¸å¯¹éº»çƒ¦ï¼Œä¸èƒ½æ–¹ä¾¿çš„ä½¿ç”¨&lt;code&gt;micro&lt;/code&gt;çš„&lt;code&gt;options&lt;/code&gt;ï¼Œæš‚æ—¶æµ‹è¯•åœ¨&lt;code&gt;web&lt;/code&gt;æ¨¡å—å®ç°&lt;code&gt;filter&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;1. &lt;code&gt;micro/web/web.go&lt;/code&gt;ä¿®æ”¹&lt;code&gt;func (s *srv) proxy() http.Handler&lt;/code&gt;ï¼Œå¢åŠ &lt;code&gt;SelectOption&lt;/code&gt;&lt;/em&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func (s *srv) proxy() http.Handler {
	sel := s.service.Client().Options().Selector

	director := func(r *http.Request) {
		kill := func() {
			r.URL.Host = &amp;quot;&amp;quot;
			r.URL.Path = &amp;quot;&amp;quot;
			r.URL.Scheme = &amp;quot;&amp;quot;
			r.Host = &amp;quot;&amp;quot;
			r.RequestURI = &amp;quot;&amp;quot;
		}

		parts := strings.Split(r.URL.Path, &amp;quot;/&amp;quot;)
		if len(parts) &amp;lt; 2 {
			kill()
			return
		}
		if !re.MatchString(parts[1]) {
			kill()
			return
		}

		// NOTE: æ·»åŠ SelectOption
		val := r.Header.Get(&amp;quot;X-Micro-Chain&amp;quot;)
		chains := strings.Split(val, &amp;quot;;&amp;quot;)

		next, err := sel.Select(Namespace+&amp;quot;.&amp;quot;+parts[1], selector.WithFilter(filterChain(chains)))
		if err != nil {
			kill()
			return
		}

		s, err := next()
		if err != nil {
			kill()
			return
		}

		r.Header.Set(BasePathHeader, &amp;quot;/&amp;quot;+parts[1])
		r.URL.Host = s.Address
		r.URL.Path = &amp;quot;/&amp;quot; + strings.Join(parts[2:], &amp;quot;/&amp;quot;)
		r.URL.Scheme = &amp;quot;http&amp;quot;
		r.Host = r.URL.Host
	}

	return &amp;amp;proxy{
		Default:  &amp;amp;httputil.ReverseProxy{Director: director},
		Director: director,
	}
}

// NOTE: SelectOptionçš„filterå®ç°
func filterChain(chains []string) selector.Filter {
	return func(old []*registry.Service) []*registry.Service {
		if len(chains) == 0 {
			return old
		}

		var services []*registry.Service

		chain := &amp;quot;&amp;quot;
		idx := 0
		for _, service := range old {
			serv := new(registry.Service)
			var nodes []*registry.Node

			for _, node := range service.Nodes {
				if node.Metadata == nil {
					continue
				}

				val := node.Metadata[&amp;quot;chain&amp;quot;]
				if len(val) == 0 {
					continue
				}

				if len(chain) &amp;gt; 0 &amp;amp;&amp;amp; idx == 0 {
					if chain == val {
						nodes = append(nodes, node)
					}
					continue
				}

				// chainsæŒ‰é¡ºåºä¼˜å…ˆåŒ¹é…
				ok, i := inArray(val, chains)
				if ok &amp;amp;&amp;amp; idx &amp;gt; i {
					// å‡ºç°ä¼˜å…ˆé“¾è·¯ï¼Œservicesæ¸…ç©ºï¼Œnodesæ¸…ç©º
					idx = i
					services = services[:0]
					nodes = nodes[:0]
				}

				if ok {
					chain = val
					nodes = append(nodes, node)
				}
			}

			// only add service if there&#39;s some nodes
			if len(nodes) &amp;gt; 0 {
				// copy
				*serv = *service
				serv.Nodes = nodes
				services = append(services, serv)
			}
		}

		if len(services) == 0 {
			return old
		}

		return services
	}
}

func inArray(s string, d []string) (bool, int) {
	for k, v := range d {
		if s == v {
			return true, k
		}
	}
	return false, 0
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;æœåŠ¡ç­›é€‰&#34;&gt;æœåŠ¡ç­›é€‰&lt;/h3&gt;

&lt;p&gt;æ™®é€šæœåŠ¡çš„ç­›é€‰æ¡†æ¶æ”¯æŒæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œé¦–å…ˆè¦ä¸ºæœåŠ¡æ·»åŠ &lt;code&gt;metadata&lt;/code&gt;ä¿¡æ¯ï¼Œä¸èµ˜è¿°ã€‚å…¶æ¬¡è¦å¯¹&lt;code&gt;Client&lt;/code&gt;è¿›è¡ŒåŒ…è£…ï¼ŒæœåŠ¡è°ƒç”¨æ—¶æ·»åŠ &lt;code&gt;SelectOption&lt;/code&gt;ï¼Œ
å®ç°å‚è€ƒæˆ‘çš„&lt;a href=&#34;https://github.com/hb-go/micro-plugins/tree/master/wrapper/select/chain&#34;&gt;chain&lt;/a&gt;æ’ä»¶ã€‚&lt;/p&gt;

&lt;p&gt;&lt;em&gt;1. æ·»åŠ &lt;code&gt;metadata&lt;/code&gt;&lt;/em&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;md := make(map[string]string)
md[&amp;quot;chain&amp;quot;] = &amp;quot;v2.0&amp;quot;

// New Service
service := micro.NewService(
	micro.Name(&amp;quot;go.micro.api.xxx&amp;quot;),
	micro.Version(&amp;quot;latest&amp;quot;),
	micro.Metadata(md),
)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;em&gt;2. Wrap Client&lt;/em&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;éœ€è¦æ³¨æ„çš„æ˜¯&lt;code&gt;service&lt;/code&gt;åˆå§‹è¿‡ç¨‹ï¼Œæœ‰ç±»ä¼¼&lt;code&gt;micro new&lt;/code&gt;æ¨¡æ¿å°†service clientæ³¨å…¥åˆ°contextçš„æ–¹æ³•ï¼Œéœ€è¦åˆ†ä¸¤æ¬¡Init()ï¼Œå…ˆWrapClientï¼Œå†WrapHandlerï¼Œ
å¦åˆ™æ³¨å…¥çš„&lt;code&gt;client&lt;/code&gt;å°†æ˜¯æœªè¢«åŒ…è£…çš„ã€‚è¿™ä¹Ÿæ˜¯microæ¯”è¾ƒå¸¸é‡åˆ°çš„&lt;strong&gt;å‘&lt;/strong&gt;ï¼&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// Initialise service
// NOTE: æ³¨æ„æœ‰ç±»ä¼¼micro newæ¨¡å—å°†service clientæ³¨å…¥åˆ°contextçš„æ–¹æ³•ï¼Œéœ€è¦åˆ†ä¸¤æ¬¡Init()ï¼Œå¦åˆ™æ³¨å…¥çš„Clientå¹¶æœªè¢«åŒ…è£…
service.Init(
	micro.WrapClient(chain.NewClientWrapper()),
)
service.Init(
	// create wrap for the Example srv client
	micro.WrapHandler(client.AccountWrapper(service)),
)
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;ref&#34;&gt;Ref&lt;/h1&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://mp.weixin.qq.com/s/UBoRKt3l91ffPagtjExmYw&#34;&gt;å¤§è§„æ¨¡å¾®æœåŠ¡åœºæ™¯ä¸‹ç°åº¦å‘å¸ƒä¸æµé‡æŸ“è‰²å®è·µ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
      
    </item>
    
    <item>
      <title>ã€go-microã€‘Network mTLS &amp; è‡ªç­¾åè¯ä¹¦</title>
      <link>http://hbchen.com/post/microservice/2019-11-27-go-micro-network-mtls/</link>
      <pubDate>Wed, 27 Nov 2019 20:39:14 +0800</pubDate>
      
      <guid>http://hbchen.com/post/microservice/2019-11-27-go-micro-network-mtls/</guid>
      
        <description>&lt;p&gt;åœ¨&lt;a href=&#34;http://hbchen.com/post/microservice/2019-11-15-go-micro-network/&#34;&gt;ã€go-microã€‘Networkåˆæ¢&lt;/a&gt;æˆ‘ä»¬åˆ†æäº†&lt;code&gt;network&lt;/code&gt;çš„åº”ç”¨åœºæ™¯ä»¥åŠå­˜åœ¨çš„ä¸è¶³ä¹‹å¤„ï¼Œ
å…¶ä¸­å¯¹äºå®‰å…¨ä¸è¶³ç ”ç©¶çš„ä¸å¤Ÿæ·±å…¥ï¼Œ&lt;code&gt;tunnel&lt;/code&gt;æ˜¯åœ¨&lt;code&gt;transport&lt;/code&gt;åŸºç¡€ä¸Šå»ºç«‹çš„ï¼Œè€Œ&lt;code&gt;transport&lt;/code&gt;å±‚æœ‰&lt;code&gt;mTLS&lt;/code&gt;çš„æ”¯æŒï¼Œæ‰€ä»¥å½“æ—¶æ‰€è¯´çš„åœ¨å®‰å…¨æ–¹é¢åªæœ‰&lt;code&gt;header&lt;/code&gt;ä¸­çš„&lt;code&gt;token&lt;/code&gt;æ˜¯é”™è¯¯çš„ã€‚
åªæ˜¯&lt;code&gt;micro&lt;/code&gt;å½“å‰åœ¨&lt;code&gt;network&lt;/code&gt;è¿˜æ²¡æœ‰åš&lt;code&gt;mTLS&lt;/code&gt;ç¯å¢ƒå˜é‡çš„æ”¯æŒï¼Œæœ¬æ–‡å°†åšä¸€ä¸ªç®€å•çš„åˆ†äº«ä¸º&lt;code&gt;network&lt;/code&gt;å¢åŠ &lt;code&gt;mTLS&lt;/code&gt;æ”¯æŒã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;åˆšåˆš(2019-11-27)&lt;code&gt;micro&lt;/code&gt;åˆå‘å¸ƒäº†æ–°ç‰ˆæœ¬&lt;code&gt;1.17.0&lt;/code&gt;ï¼Œç»§ç»­é‡‡å‘ğŸ¤£&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;networkä¿®æ”¹&#34;&gt;Networkä¿®æ”¹&lt;/h2&gt;

&lt;p&gt;å½“å‰&lt;code&gt;micro&lt;/code&gt;çš„&lt;code&gt;network&lt;/code&gt;æ¨¡å—å¹¶æ²¡æœ‰æä¾›&lt;code&gt;TLS&lt;/code&gt;ç¯å¢ƒå˜é‡é…ç½®çš„æ”¯æŒï¼Œéœ€è¦è‡ªå·±ä¿®æ”¹æºç ï¼Œåœ¨&lt;a href=&#34;https://github.com/micro/micro&#34;&gt;micro/micro&lt;/a&gt;çš„&lt;code&gt;internal/helper&lt;/code&gt;æœ‰&lt;code&gt;TLSConfig()&lt;/code&gt;æ–¹æ³•å¯ä»¥ä»&lt;code&gt;GLOBAL OPTIONS&lt;/code&gt;ä¸­ç”Ÿæˆ&lt;code&gt;*tls.Config&lt;/code&gt;ï¼Œ
å‚è€ƒå½“å‰&lt;code&gt;micro&lt;/code&gt;å®ç°&lt;code&gt;mTLS&lt;/code&gt;ä¸¤ä¸ª&lt;code&gt;command&lt;/code&gt;(&lt;code&gt;api&lt;/code&gt;å’Œ&lt;code&gt;web&lt;/code&gt;)ï¼Œå¯¹&lt;code&gt;network&lt;/code&gt;çš„&lt;code&gt;tunnel&lt;/code&gt;åšå¦‚ä¸‹ä¿®æ”¹:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// create a tunnel
tunOpts := []tunnel.Option{
	tunnel.Address(Address),
	tunnel.Nodes(nodes...),
	tunnel.Token(Token),
}
if ctx.GlobalBool(&amp;quot;enable_tls&amp;quot;) {
	config, err := helper.TLSConfig(ctx)
	if err != nil {
		fmt.Println(err.Error())
		return
	}
	config.InsecureSkipVerify = true

	tunOpts = append(tunOpts, tunnel.Transport(
		quic.NewTransport(transport.TLSConfig(config)),
	))
}
tun := tunnel.NewTunnel(tunOpts...)
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;æ³¨æ„è¿™é‡Œæˆ‘ä»¬è®¾ç½®äº†&lt;code&gt;InsecureSkipVerify&lt;/code&gt;ä¸º&lt;code&gt;true&lt;/code&gt;ï¼Œç”±äºæ˜¯åŒå‘è®¤è¯ï¼Œå¦‚æœ&lt;code&gt;InsecureSkipVerify&lt;/code&gt;ä¸º&lt;code&gt;false&lt;/code&gt;ï¼Œ&lt;code&gt;network&lt;/code&gt;å°†æ— æ³•æ­£å¸¸è¿æ¥&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;mtls&#34;&gt;mTLS&lt;/h2&gt;

&lt;p&gt;é¦–å…ˆå‚è€ƒä¸‹å›¾å¯¹&lt;code&gt;mTLS&lt;/code&gt;æœ‰ä¸ªäº†è§£ï¼Œ&lt;code&gt;server&lt;/code&gt;å’Œ&lt;code&gt;client&lt;/code&gt;éƒ½éœ€è¦é€šè¿‡&lt;code&gt;CA&lt;/code&gt;å¯¹å½¼æ­¤çš„è¯ä¹¦è¿›è¡ŒéªŒè¯&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/micro/mtls.png&#34; alt=&#34;network_multi_cluster&#34; /&gt;&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬åªç”Ÿæˆä¸€ä¸ª&lt;code&gt;CA&lt;/code&gt;å’Œ&lt;code&gt;CSR&lt;/code&gt;è¯ä¹¦ï¼Œå¯¹äºç”Ÿäº§ç¯å¢ƒæ ¹æ®è‡ªå·±çš„åœºæ™¯éœ€è¦æ›´ä¸ºå®Œå–„å’Œå¤æ‚çš„è¯ä¹¦ç®¡ç†ï¼Œè¿™é‡Œæ²¡æœ‰æ¶‰åŠï¼Œåé¢ä¼šç»“åˆ&lt;code&gt;micro&lt;/code&gt;ç”Ÿæ€ä¸å®‰å…¨ç›¸å…³çš„&lt;code&gt;mTLS&lt;/code&gt;åšæ›´å¤šçš„ç ”ç©¶åˆ†äº«ã€‚&lt;/p&gt;

&lt;h3 id=&#34;caè¯ä¹¦&#34;&gt;CAè¯ä¹¦&lt;/h3&gt;

&lt;p&gt;ä½¿ç”¨&lt;a href=&#34;https://github.com/square/certstrap&#34;&gt;certstrap&lt;/a&gt;å·¥å…·ç”Ÿæˆ&lt;code&gt;CA&lt;/code&gt;è¯ä¹¦&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# MacOS
$ brew install certstrap

# æœªè¾“å…¥å¯†ç 
$ certstrap init --common-name &amp;quot;MicroCA&amp;quot; --expires &amp;quot;20 years&amp;quot;
    Enter passphrase (empty for no passphrase): 
    Enter same passphrase again: 
    Created out/MicroCA.key
    Created out/MicroCA.crt
    Created out/MicroCA.crl
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;csrè¯ä¹¦&#34;&gt;CSRè¯ä¹¦&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ certstrap request-cert -cn network  
	Enter passphrase (empty for no passphrase): 
    Enter same passphrase again: 
    Created out/network.key
    Created out/network.csr
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;csrè¯ä¹¦ç­¾å&#34;&gt;CSRè¯ä¹¦ç­¾å&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ certstrap sign network --CA MicroCA
	Created out/network.crt from out/network.csr signed by out/MicroCA.key
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;è¿è¡Œnetwork-mtls&#34;&gt;è¿è¡ŒNetwork + mTLS&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ./micro \
--registry=etcd \
--transport=tcp \
--enable_tls=true \
--tls_cert_file=conf/tls/network.crt  \
--tls_key_file=conf/tls/network.key  \
--tls_client_ca_file=conf/tls/MicroCA.crt \
network

$ ./micro \
--registry=consul \
--transport=tcp \
--enable_tls=true \
--tls_cert_file=conf/tls/network.crt  \
--tls_key_file=conf/tls/network.key  \
--tls_client_ca_file=conf/tls/MicroCA.crt \
network \
--nodes=localhost:8085 \
--address=:8086
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;Network routes&lt;/strong&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å¦‚æœ&lt;code&gt;routes&lt;/code&gt;ä¸­çœ‹ä¸åˆ°&lt;code&gt;link=network&lt;/code&gt;åº”è¯¥æ˜¯&lt;code&gt;network&lt;/code&gt;é—´æœªèƒ½å»ºç«‹è¿æ¥&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;./micro --registry=etcd --transport=tcp network routes  
+------------------+----------------------+----------------------+--------------------------------------+----------+--------+---------+
|     SERVICE      |       ADDRESS        |       GATEWAY        |                ROUTER                | NETWORK  | METRIC |  LINK   |
+------------------+----------------------+----------------------+--------------------------------------+----------+--------+---------+
| consul           | 1919625842587659968  | 17017708900476934200 | f5dc3933-3ccc-4dc0-bafe-cbfd7abebf60 | go.micro | 1      | network |
| go.micro.network | 15624894091238291400 | 17017708900476934200 | f5dc3933-3ccc-4dc0-bafe-cbfd7abebf60 | go.micro | 1      | network |
| go.micro.network | 192.168.1.4:58527    |                      | df521f3c-a39e-455b-abbf-ada184a900c9 | go.micro | 1      | local   |
| go.micro.network | 192.168.1.4:58528    |                      | df521f3c-a39e-455b-abbf-ada184a900c9 | go.micro | 1      | local   |
| go.micro         | 192.168.1.4:8085     |                      | df521f3c-a39e-455b-abbf-ada184a900c9 | go.micro | 1      | local   |
| go.micro         | 9876822083478954444  | 17017708900476934200 | f5dc3933-3ccc-4dc0-bafe-cbfd7abebf60 | go.micro | 1      | network |
+------------------+----------------------+----------------------+--------------------------------------+----------+--------+---------+

./micro --registry=consul --transport=tcp network routes
+------------------+----------------------+---------------------+--------------------------------------+----------+--------+---------+
|     SERVICE      |       ADDRESS        |       GATEWAY       |                ROUTER                | NETWORK  | METRIC |  LINK   |
+------------------+----------------------+---------------------+--------------------------------------+----------+--------+---------+
| consul           | 127.0.0.1:8300       |                     | f5dc3933-3ccc-4dc0-bafe-cbfd7abebf60 | go.micro | 1      | local   |
| go.micro         | 192.168.1.4:8086     |                     | f5dc3933-3ccc-4dc0-bafe-cbfd7abebf60 | go.micro | 1      | local   |
| go.micro         | 9480410441638176179  | 3307701226171868606 | df521f3c-a39e-455b-abbf-ada184a900c9 | go.micro | 2      | network |
| go.micro.network | 11801771601773192119 | 3307701226171868606 | df521f3c-a39e-455b-abbf-ada184a900c9 | go.micro | 2      | network |
| go.micro.network | 192.168.1.4:58843    |                     | f5dc3933-3ccc-4dc0-bafe-cbfd7abebf60 | go.micro | 1      | local   |
| go.micro.network | 192.168.1.4:58844    |                     | f5dc3933-3ccc-4dc0-bafe-cbfd7abebf60 | go.micro | 1      | local   |
+------------------+----------------------+---------------------+--------------------------------------+----------+--------+---------+
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;ref&#34;&gt;Ref&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://www.gitdig.com/about/&#34;&gt;Go ç¼–ç¨‹: å¿«é€Ÿç”Ÿæˆè‡ªç­¾åè¯ä¹¦ä¸åŒå‘è®¤è¯(mTLS)&lt;/a&gt;&lt;/p&gt;</description>
      
    </item>
    
    <item>
      <title>ã€go-microã€‘Networkåˆæ¢</title>
      <link>http://hbchen.com/post/microservice/2019-11-15-go-micro-network/</link>
      <pubDate>Fri, 15 Nov 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/microservice/2019-11-15-go-micro-network/</guid>
      
        <description>&lt;p&gt;Networkæ˜¯microç¤¾åŒºæ­£åœ¨ä¸»åŠ›æ‰“é€ çš„è§£å†³å¤š&amp;rdquo;äº‘&amp;rdquo;ç¯å¢ƒçš„è§£å†³æ–¹æ¡ˆï¼Œä¸‹é¢ç»“åˆæœ€è¿‘çš„ç ”ç©¶åšä¸ªæ€»ç»“ï¼Œä¸»è¦åŒ…æ‹¬&lt;code&gt;network&lt;/code&gt;é€‚ç”¨çš„å‡ ç§åœºæ™¯åˆ†æï¼Œ
ä»¥åŠåœ¨è¿™äº›åœºæ™¯éœ€æ±‚ä¸‹&lt;code&gt;network&lt;/code&gt;è¿˜æœ‰å“ªäº›ä¸è¶³ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://micro.mu/docs/network.html&#34;&gt;Network Overview&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://micro.mu/docs/service-network.html&#34;&gt;Service Network&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;proxy&#34;&gt;Proxy&lt;/h2&gt;

&lt;p&gt;åœ¨åˆ†æ&lt;code&gt;network&lt;/code&gt;ä¹‹å‰å…ˆäº†è§£&lt;code&gt;micro&lt;/code&gt;çš„&lt;code&gt;proxy&lt;/code&gt;æ¨¡å¼ï¼ŒæœåŠ¡ä¹‹é—´è°ƒç”¨ä¸éœ€è¦æœåŠ¡å‘ç°ï¼Œè€Œæ˜¯é€šè¿‡&lt;code&gt;proxy&lt;/code&gt;åšè½¬å‘ï¼Œç”±&lt;code&gt;proxy&lt;/code&gt;å®ŒæˆæœåŠ¡çš„å‘ç°å’Œè°ƒç”¨ã€‚
&lt;code&gt;network&lt;/code&gt;å®ç°äº†ä¸€ä¸ªç‰¹æ®Šçš„ä»£ç†ï¼Œå®ƒçš„æœåŠ¡å‘ç°å¹¶ä¸åªæ˜¯é€šè¿‡æ³¨å†Œä¸­å¿ƒï¼ŒåŒæ—¶æœ‰&lt;code&gt;network&lt;/code&gt;ä¹‹é—´å…±äº«çš„æœåŠ¡ã€‚
&lt;img src=&#34;http://hbchen.com/img/micro/proxy.png&#34; alt=&#34;micro-proxy&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;æœåŠ¡å¯è§æ€§&#34;&gt;æœåŠ¡å¯è§æ€§&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;network&lt;/code&gt;é€šè¿‡å…±äº«æœåŠ¡ä¿¡æ¯ï¼Œå®ç°è·¨&lt;code&gt;network&lt;/code&gt;çš„æœåŠ¡å¯è§ï¼Œä»è€Œå®ç°ä»£ç†çš„æœåŠ¡å‘ç°ï¼Œå¹¶ä¸”å…±äº«æ˜¯æœ‰å¯è§æ€§çš„ï¼Œå½“å‰&lt;code&gt;advertise_strategy&lt;/code&gt;æœ‰&lt;code&gt;3+1&lt;/code&gt;ç§æ–¹æ¡ˆ:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;none&lt;/code&gt;ä¸å…±äº«æœåŠ¡

&lt;ul&gt;
&lt;li&gt;å³åªæ¥å—å¤–éƒ¨æœåŠ¡ï¼Œé€‚åˆè¾¹ç¼˜èŠ‚ç‚¹ï¼Œä¾èµ–ä¸­å¿ƒæœåŠ¡åœºæ™¯&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;all&lt;/code&gt;å…±äº«å…¨éƒ¨æœåŠ¡&lt;/li&gt;
&lt;li&gt;&lt;code&gt;best&lt;/code&gt;å…±äº«æœ€ä¼˜è·¯ç”±

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;local&lt;/code&gt;ä»…å…±äº«é›†ç¾¤å†…éƒ¨æœåŠ¡ï¼Œè€Œä¸å…±äº«ä»å…¶ä»–&lt;code&gt;network&lt;/code&gt;å…±äº«å¾—åˆ°çš„æœåŠ¡ï¼Œå®é™…æ˜¯&lt;code&gt;best&lt;/code&gt;çš„ä¸€ä¸ªç­›é€‰é¡¹ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¯´å®ƒæ˜¯&lt;code&gt;3+1&lt;/code&gt;
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;p&gt;æˆªæ­¢&lt;code&gt;v1.6.0&lt;/code&gt;ç‰ˆæœ¬è¿˜æ²¡æœ‰æ­¤åŠŸèƒ½ï¼Œéœ€è¦ä½¿ç”¨&lt;code&gt;master&lt;/code&gt;åˆ†æ”¯ï¼Œ&lt;a href=&#34;https://github.com/micro/go-micro/pull/932&#34;&gt;PR#932&lt;/a&gt;å¢åŠ äº†æ­¤ç­–ç•¥çš„æ”¯æŒï¼Œ
ä»¥microçš„å‘ç‰ˆé€Ÿåº¦åº”è¯¥è¦ä¸äº†å¤šä¹…å°±ä¼šæœ‰Releaseç‰ˆğŸ¤£&lt;/p&gt;

&lt;p&gt;Networkåœ¨ä¸æ–­å®Œå–„ï¼Œæœ¬æ–‡å‚è€ƒç‰ˆæœ¬ä¸ºï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/micro/micro/tree/98d9b1f332a2&#34;&gt;micro/tree/98d9b1f332a2&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/micro/go-micro/tree/9f481542f38d&#34;&gt;go-micro/tree/9f481542f38d&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;åº”ç”¨åœºæ™¯&#34;&gt;åº”ç”¨åœºæ™¯&lt;/h2&gt;

&lt;h3 id=&#34;å¤šé›†ç¾¤&#34;&gt;å¤šé›†ç¾¤&lt;/h3&gt;

&lt;p&gt;å¤šé›†ç¾¤åœºæ™¯åˆ†ä¸¤ç§ä¸€æ˜¯&lt;strong&gt;é›†ç¾¤æœåŠ¡å…±äº«&lt;/strong&gt;ï¼ŒäºŒæ˜¯&lt;strong&gt;å¤šä¸­å¿ƒ/ä¸»å¤‡é›†ç¾¤&lt;/strong&gt;ï¼Œåœ¨&lt;code&gt;advertise_strategy&lt;/code&gt;ç­–ç•¥é€‰æ‹©æœ‰åŒºåˆ«ã€‚&lt;/p&gt;

&lt;h4 id=&#34;é›†ç¾¤æœåŠ¡å…±äº«&#34;&gt;é›†ç¾¤æœåŠ¡å…±äº«&lt;/h4&gt;

&lt;p&gt;é›†ç¾¤æœåŠ¡å…±äº«æ˜¯æŒ‡ä¸åŒé›†ç¾¤æ‹¥æœ‰ä¸åŒçš„æœåŠ¡ï¼Œå®ç°é›†ç¾¤é—´çš„æœåŠ¡å‘ç°ï¼Œé€‰æ‹©çš„ç­–ç•¥æ˜¯&lt;code&gt;advertise_strategy=local&lt;/code&gt;ï¼Œ&lt;code&gt;network&lt;/code&gt;ä»…å…±äº«è‡ªèº«æœåŠ¡ï¼Œ
å¦‚æœ&lt;code&gt;DC B&lt;/code&gt;ä¸&lt;code&gt;DC C&lt;/code&gt;éœ€è¦å…±äº«æœåŠ¡ï¼Œé‚£ä¹ˆéœ€è¦ç›´æ¥å»ºç«‹è¿æ¥ï¼Œè€Œä¸æ˜¯é€šè¿‡&lt;code&gt;DC A&lt;/code&gt;
&lt;img src=&#34;http://hbchen.com/img/micro/network_multi_cluster_1.png&#34; alt=&#34;network_multi_cluster&#34; /&gt;&lt;/p&gt;

&lt;h4 id=&#34;å¤šä¸­å¿ƒ-ä¸»å¤‡é›†ç¾¤&#34;&gt;å¤šä¸­å¿ƒ/ä¸»å¤‡é›†ç¾¤&lt;/h4&gt;

&lt;p&gt;å¤šä¸­å¿ƒ/ä¸»å¤‡é›†ç¾¤æ˜¯å°†åŒä¸€å¥—æœåŠ¡éƒ¨ç½²åœ¨å¤šä¸ªä¸­å¿ƒï¼Œå¯èƒ½æ˜¯å¤šæ´»ï¼Œä¹Ÿå¯èƒ½æ˜¯åˆ†ä¸»å¤‡ï¼Œé€‰æ‹©çš„ç­–ç•¥æ˜¯&lt;code&gt;advertise_strategy=best&lt;/code&gt;ï¼Œä½†ç°åœ¨&lt;code&gt;network&lt;/code&gt;åœ¨è´Ÿè½½ç­–ç•¥ä¸Šè¿˜æ²¡æœ‰&lt;strong&gt;å°±è¿‘åŸåˆ™&lt;/strong&gt;
&lt;img src=&#34;http://hbchen.com/img/micro/network_multi_cluster_2.png&#34; alt=&#34;network_multi_cluster&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;ä¸­å¿ƒæœåŠ¡-è¾¹ç¼˜&#34;&gt;ä¸­å¿ƒæœåŠ¡+è¾¹ç¼˜&lt;/h3&gt;

&lt;p&gt;å¯¹äºè¾¹ç¼˜è®¡ç®—åœºæ™¯ï¼Œè¾¹ç¼˜èŠ‚ç‚¹å¯èƒ½æ˜¯ä¸æä¾›æœåŠ¡çš„ï¼Œæ¯”å¦‚åªä¸ŠæŠ¥æ•°æ®ï¼Œå¯ä»¥é€‰æ‹©&lt;code&gt;advertise_strategy=none&lt;/code&gt;ï¼Œå½“ç„¶æœ‰çš„å¯èƒ½åˆæ˜¯æä¾›æœåŠ¡çš„ï¼Œå¯ä»¥é€‰æ‹©&lt;code&gt;advertise_strategy=local&lt;/code&gt;ï¼Œ
ä½†&lt;code&gt;DC A&lt;/code&gt;å¹¶ä¸ä¼šå°†&lt;code&gt;DC C&lt;/code&gt;çš„æœåŠ¡å…±äº«ç»™&lt;code&gt;DC B&lt;/code&gt;ã€‚å› ä¸º&lt;code&gt;network&lt;/code&gt;é—´é€šè¿‡&lt;code&gt;tunnel&lt;/code&gt;é€šä¿¡ï¼Œè¾¹ç¼˜èŠ‚ç‚¹å¯ä»¥æ˜¯ä»»æ„ç½‘ç»œï¼Œåªè¦è¿æ¥åˆ°ä¸­å¿ƒæœåŠ¡çš„&lt;code&gt;network&lt;/code&gt;å³å¯ã€‚
&lt;img src=&#34;http://hbchen.com/img/micro/network_edge.png&#34; alt=&#34;network_edge&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;ä¸è¶³&#34;&gt;ä¸è¶³&lt;/h2&gt;

&lt;h3 id=&#34;networké«˜å¯ç”¨åŠæ€§èƒ½&#34;&gt;Networké«˜å¯ç”¨åŠæ€§èƒ½&lt;/h3&gt;

&lt;p&gt;è¦è€ƒè™‘&lt;code&gt;network&lt;/code&gt;çš„é«˜å¯ç”¨ï¼Œå¿…é¡»æ”¯æŒå¤šå‰¯æœ¬æ°´å¹³æ‰©å±•ï¼Œç°åœ¨åŒä¸€é›†ç¾¤å†…&lt;code&gt;network&lt;/code&gt;ä¼šå…±äº«æœåŠ¡ï¼Œä½†å½“å‰&lt;code&gt;network&lt;/code&gt;çš„æœåŠ¡å¯è§æ€§å¹¶æ²¡æœ‰å°†é›†ç¾¤å†…&lt;code&gt;node&lt;/code&gt;ä¸ç›´è¿çš„&lt;code&gt;node&lt;/code&gt;èŠ‚ç‚¹åšåŒºåˆ†ï¼Œ
å¦‚æœé›†ç¾¤å†…å‡ºç°nä¸ªå‰¯æœ¬ï¼Œé‚£ä¹ˆæœ€å·®çš„æƒ…å†µä¸‹å¯èƒ½è¦åœ¨&lt;code&gt;network&lt;/code&gt;çš„&lt;code&gt;pod&lt;/code&gt;é—´è·³è½¬næ¬¡ã€‚ç†æƒ³çŠ¶æ€åº”è¯¥æ˜¯å¯¹äºé›†ç¾¤å†…ä»…å…±äº«ä¸&lt;code&gt;node&lt;/code&gt;ç›´è¿çš„&lt;strong&gt;é›†ç¾¤å¤–æœåŠ¡&lt;/strong&gt;ï¼ˆè¿™æ˜¯å½“å‰&lt;code&gt;network&lt;/code&gt;ä¸å…·å¤‡ï¼‰ï¼Œ
è€Œå¯¹é›†ç¾¤å¤–å…±äº«æœ¬é›†ç¾¤æœåŠ¡ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿é›†ç¾¤å†…&lt;code&gt;network&lt;/code&gt;ä»£ç†æœ€å¤šç»è¿‡&lt;strong&gt;ä¸¤è·³&lt;/strong&gt;å³å¯è°ƒç”¨é›†ç¾¤å¤–æœåŠ¡ã€‚
&lt;img src=&#34;http://hbchen.com/img/micro/network_problem_ha.png&#34; alt=&#34;network_edge&#34; /&gt;
å›¾ä¸­çº¢è‰²æ ‡è®°çš„&lt;code&gt;go.micro.srv.s-2 gateway-a-2&lt;/code&gt;ã€&lt;code&gt;go.micro.srv.s-2 gateway-a-3&lt;/code&gt;ä¸åº”è¯¥å‡ºç°åœ¨&lt;code&gt;network&lt;/code&gt;çš„&lt;code&gt;routes&lt;/code&gt;ä¸­ï¼Œé¿å…åŒä¸€é›†ç¾¤å†…æ²¡å¿…è¦çš„è·¯ç”±ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;æœ‰å…³&lt;code&gt;network&lt;/code&gt;çš„å¤šå‰¯æœ¬è¿˜éœ€è¦è¿›ä¸€æ­¥ç ”ç©¶ï¼Œæ¯”å¦‚4ä¸ªåä¼šä¸ä¼šå‡ºç°é“¾è·¯å¾ªç¯ï¼Œä»¥åŠå…·ä½“è·¯ç”±è´Ÿè½½ç­–ç•¥ç­‰&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;æ€»çš„æ¥è¯´æ˜¯&lt;code&gt;advertise_strategy&lt;/code&gt;éœ€è¦æ›´å®Œå–„çš„ç­–ç•¥æ”¯æŒï¼Œåšå¿…è¦çš„éš”ç¦»ã€ç­›é€‰ï¼Œä¸€æ˜¯æœåŠ¡çš„å¯è§æ€§é—®é¢˜ï¼ŒäºŒæ˜¯æœåŠ¡è§„æ¨¡å¢åŠ å&lt;code&gt;network&lt;/code&gt;é—´çš„æ•°æ®é€šä¿¡ä¹Ÿä¼šæˆä¸ºç“¶é¢ˆã€‚&lt;/p&gt;

&lt;h3 id=&#34;è·¯ç”±è´Ÿè½½ç­–ç•¥&#34;&gt;è·¯ç”±è´Ÿè½½ç­–ç•¥&lt;/h3&gt;

&lt;p&gt;è·¯ç”±è´Ÿè½½é€‰æ‹©éœ€è¦ä¼˜å…ˆçº§ã€ç­›é€‰ç­‰ç­–ç•¥ï¼Œå¦‚localä¼˜å…ˆï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥å®ç°ä¸»å¤‡é›†ç¾¤ï¼Œä»¥åŠé›†ç¾¤é—´æµé‡åˆ‡æ¢ç­‰åœºæ™¯çš„åº”ç”¨&lt;/p&gt;

&lt;h3 id=&#34;å®‰å…¨&#34;&gt;å®‰å…¨&lt;/h3&gt;

&lt;blockquote&gt;
&lt;p&gt;æ›´æ­£ï¼šè¿™é‡Œæˆ‘ä»¬å¿½ç•¥äº†&lt;code&gt;tunnel&lt;/code&gt;çš„&lt;code&gt;transport&lt;/code&gt;ï¼Œåœ¨&lt;code&gt;transport&lt;/code&gt;å±‚æ˜¯æœ‰&lt;code&gt;mTLS&lt;/code&gt;æ”¯æŒçš„ï¼Œå…·ä½“å‚è€ƒ&lt;a href=&#34;http://hbchen.com/post/microservice/2019-11-27-go-micro-tunnel-mtls/&#34;&gt;ã€go-microã€‘è‡ªç­¾åè¯ä¹¦&amp;amp;Tunnel mTLS&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;del&gt;&lt;code&gt;network&lt;/code&gt;é—´çš„è¿æ¥æ˜¯é€šè¿‡&lt;code&gt;tunnel&lt;/code&gt;å®Œæˆï¼Œè€Œ&lt;code&gt;tunnel&lt;/code&gt;åœ¨å®‰å…¨æ–¹é¢åªæ˜¯åœ¨&lt;code&gt;message&lt;/code&gt;çš„&lt;code&gt;header&lt;/code&gt;ä¸­æ”¾äº†ä¸€ä¸ª&lt;code&gt;token&lt;/code&gt;ç”¨äºç›¸äº’éªŒè¯ï¼Œè¿™ä¹Ÿæ˜¯éœ€è¦åŠ å¼ºçš„éƒ¨åˆ†ã€‚&lt;/del&gt;&lt;/p&gt;

&lt;h2 id=&#34;networkæ¨¡æ‹Ÿæµ‹è¯•&#34;&gt;Networkæ¨¡æ‹Ÿæµ‹è¯•&lt;/h2&gt;

&lt;p&gt;å¯ä»¥æœ¬åœ°ä½¿ç”¨ä¸åŒçš„æ³¨å†Œä¸­å¿ƒæ¨¡æ‹Ÿå¤šä¸ªé›†ç¾¤ï¼Œç®€å•çš„&lt;code&gt;mdns&lt;/code&gt;ã€&lt;code&gt;consul&lt;/code&gt;å’Œ&lt;code&gt;etcd&lt;/code&gt;å°±å¯ä»¥æ¨¡æ‹Ÿå‡ºä¸‰ä¸ªé›†ç¾¤ï¼Œå¦‚æœæœ‰å…¬ç½‘æœåŠ¡å™¨å½“ç„¶æ›´å¥½ã€‚&lt;/p&gt;</description>
      
    </item>
    
    <item>
      <title>ã€go-microã€‘å¾®æœåŠ¡å¿«é€Ÿå¼€å§‹</title>
      <link>http://hbchen.com/post/microservice/2019-10-13-go-micro-quick-start/</link>
      <pubDate>Sun, 13 Oct 2019 15:27:12 +0800</pubDate>
      
      <guid>http://hbchen.com/post/microservice/2019-10-13-go-micro-quick-start/</guid>
      
        <description>&lt;p&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start&#34;&gt;github.com/hb-go/micro-quick-start&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;è¿™åªæ˜¯ä¸€ä¸ªç®€æ˜“æ•™ç¨‹ï¼Œæ˜¯ç»“åˆæ¼”ç¤ºæ–‡ç¨¿&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/blob/master/micro-quick-start.pdf&#34;&gt;micro-quick-start.pdf&lt;/a&gt;çš„ä»£ç ç¤ºä¾‹ï¼Œ
ç»“åˆæ¼”ç¤ºæ–‡ç¨¿å¯ä»¥å¿«é€Ÿäº†è§£å¾®æœåŠ¡ä¸&lt;code&gt;go-micro&lt;/code&gt;æ¡†æ¶ï¼Œå¹¶å¯ä»¥ç»“åˆä»£ç ç¤ºä¾‹è¿›è¡ŒéªŒè¯æµ‹è¯•ï¼Œæ–‡ç¨¿ä¸­æœ‰å…³äº&lt;a href=&#34;#microè‡ªå®šä¹‰&#34;&gt;&lt;code&gt;micro&lt;/code&gt;è‡ªå®šä¹‰&lt;/a&gt;ä»¥åŠ&lt;code&gt;go-micro&lt;/code&gt;ç°æˆç»„ä»¶çš„ä½¿ç”¨è¿™é‡Œå¹¶æ²¡æœ‰å…¨éƒ¨ç¤ºèŒƒï¼Œ
è¯¦ç»†å‚è€ƒæ–‡ç¨¿ï¼Œæœ¬æ•™ç¨‹æ¯ä¸ªç¤ºä¾‹å‡å¯¹åº”ä¸€ä¸ª&lt;code&gt;commit&lt;/code&gt;ï¼Œå¯ä»¥å¿«é€ŸæŸ¥çœ‹/æ¯”è¾ƒç¤ºä¾‹ç›¸å…³ä»£ç ï¼ŒåŒ…å«ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/commit/e76368bbee7dec646d13f1d9644b9d529e88074f&#34;&gt;æœåŠ¡åˆ›å»º&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;é€šè¿‡&lt;code&gt;micro new&lt;/code&gt;åˆ›å»ºæœåŠ¡åè¿›è¡Œå®Œå–„ï¼Œä½¿æ¨¡æ¿åˆ›å»ºçš„æœåŠ¡å¯ä»¥è¿è¡Œ&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/commit/5f7de50b10c19e19ef546144d6a11adf69ad1cfd&#34;&gt;è‡ªå®šä¹‰Server&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/commit/ff70f21ba9d6a9bbf889598c0837e058706bf2fd&#34;&gt;è‡ªå®šä¹‰Transport&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/commit/615d4604e251bf1188fe12a0be22e05ca9c4ebf9&#34;&gt;æœåŠ¡ç­›é€‰&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/commit/703851f4364c541c436896f85badb836859c3b7e&#34;&gt;è‡ªå®šä¹‰Wrapper-ç›‘æ§&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/commit/2f0baa1f5117d44809be07d6435fe36aeb1b9990&#34;&gt;è¶…æ—¶&amp;amp;é‡è¯•&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/commit/11453df1566721c1b8aa50d253e3454986aa2c4f&#34;&gt;é™æµ&amp;amp;ç†”æ–­&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/commit/8573ae85a7bd70038c0e0a18900bfa76d4cddb6c&#34;&gt;é…ç½®-consul&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/commit/d3f79f6c427822c1646ee7ccb2a4ba68c81681fd&#34;&gt;é“¾è·¯è¿½è¸ª&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/commit/8979073c7f473635e84d0300b61a749b66bc3bd1&#34;&gt;k8séƒ¨ç½²&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;microè‡ªå®šä¹‰&#34;&gt;microè‡ªå®šä¹‰&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;micro&lt;/code&gt;åšä¸ºç½‘å…³å¾€å¾€éœ€è¦è‡ªå®šä¹‰ï¼Œ&lt;code&gt;micro&lt;/code&gt;æä¾›äº†&lt;code&gt;plugin&lt;/code&gt;çš„è‡ªå®šä¹‰ï¼Œä»¥ä¸‹æ˜¯éƒ¨åˆ†å‚è€ƒï¼Œå¦‚å¢åŠ ç»„ä»¶&lt;code&gt;tcp&lt;/code&gt;ã€&lt;code&gt;kubernetes&lt;/code&gt;ï¼Œä½¿ç”¨&lt;code&gt;go-plugins&lt;/code&gt;ä¸­å·²æœ‰çš„&lt;code&gt;micro/metrics&lt;/code&gt;æ’ä»¶ï¼Œ
ä»¥åŠå®Œå…¨è‡ªå®šä¹‰ä¸€ä¸ª&lt;code&gt;metrics&lt;/code&gt;æ’ä»¶ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;package main

import (
	&amp;quot;github.com/micro/go-micro/util/log&amp;quot;
	&amp;quot;github.com/micro/go-plugins/micro/metrics&amp;quot;
	&amp;quot;github.com/micro/micro/api&amp;quot;
	&amp;quot;github.com/micro/micro/plugin&amp;quot;
	&amp;quot;github.com/micro/micro/web&amp;quot;
	&amp;quot;github.com/prometheus/client_golang/prometheus&amp;quot;
	&amp;quot;github.com/prometheus/client_golang/prometheus/promhttp&amp;quot;
	&amp;quot;net/http&amp;quot;
	&amp;quot;strconv&amp;quot;

	// tcp transport
	_ &amp;quot;github.com/micro/go-plugins/transport/tcp&amp;quot;

	// k8s registry
	_ &amp;quot;github.com/micro/go-plugins/registry/kubernetes&amp;quot;
)

// Metrics
func init() {
	api.Register(metrics.NewPlugin())
	web.Register(metrics.NewPlugin())
}

// è‡ªå®šä¹‰Metrics
func init() {
	api.Register(plugin.NewPlugin(
		plugin.WithHandler(
			func(h http.Handler) http.Handler {
				return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
					r.Header.Get(&amp;quot;&amp;quot;)
				})
			}),
	))

	api.Register(plugin.NewPlugin(
		plugin.WithHandler(
			func(h http.Handler) http.Handler {
				md := make(map[string]string)

				opsCounter := prometheus.NewCounterVec(
					prometheus.CounterOpts{
						Namespace: &amp;quot;micro&amp;quot;,
						Name:      &amp;quot;request_total&amp;quot;,
						Help:      &amp;quot;How many go-micro requests processed, partitioned by method and status&amp;quot;,
					},
					[]string{&amp;quot;path&amp;quot;, &amp;quot;method&amp;quot;, &amp;quot;code&amp;quot;},
				)

				timeCounterSummary := prometheus.NewSummaryVec(
					prometheus.SummaryOpts{
						Namespace: &amp;quot;micro&amp;quot;,
						Name:      &amp;quot;upstream_latency_microseconds&amp;quot;,
						Help:      &amp;quot;Service backend method request latencies in microseconds&amp;quot;,
					},
					[]string{&amp;quot;path&amp;quot;, &amp;quot;method&amp;quot;},
				)

				timeCounterHistogram := prometheus.NewHistogramVec(
					prometheus.HistogramOpts{
						Namespace: &amp;quot;micro&amp;quot;,
						Name:      &amp;quot;request_duration_seconds&amp;quot;,
						Help:      &amp;quot;Service method request time in seconds&amp;quot;,
					},
					[]string{&amp;quot;path&amp;quot;, &amp;quot;method&amp;quot;},
				)

				reg := prometheus.NewRegistry()
				wrapreg := prometheus.WrapRegistererWith(md, reg)
				wrapreg.MustRegister(
					opsCounter,
					timeCounterSummary,
					timeCounterHistogram,
				)

				prometheus.DefaultGatherer = reg
				prometheus.DefaultRegisterer = wrapreg

				return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
					// æ‹¦æˆªmetrics pathï¼Œé»˜è®¤&amp;quot;/metrics&amp;quot;
					if r.URL.Path == &amp;quot;/metrics&amp;quot; {
						promhttp.Handler().ServeHTTP(w, r)
						return
					}

					path := r.URL.Path
					method := r.Method
					timer := prometheus.NewTimer(prometheus.ObserverFunc(func(v float64) {
						us := v * 1000000 // make microseconds
						timeCounterSummary.WithLabelValues(path, method).Observe(us)
						timeCounterHistogram.WithLabelValues(path, method).Observe(v)
					}))
					defer timer.ObserveDuration()

					ww := wrapWriter{ResponseWriter: w}
					h.ServeHTTP(&amp;amp;ww, r)
					log.Logf(&amp;quot;statusCode: %d, %s&amp;quot;, ww.StatusCode, strconv.Itoa(ww.StatusCode))
					opsCounter.WithLabelValues(path, method, strconv.Itoa(ww.StatusCode)).Inc()
				})
			}),
	))

}

type wrapWriter struct {
	StatusCode int
	http.ResponseWriter
}

func (ww *wrapWriter) WriteHeader(statusCode int) {
	log.Logf(&amp;quot;statusCode: %d&amp;quot;, statusCode)
	ww.StatusCode = statusCode
	ww.ResponseWriter.WriteHeader(statusCode)
}
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>ã€æœåŠ¡ç½‘æ ¼-gRPCã€‘ç½‘å…³grpc-gateway</title>
      <link>http://hbchen.com/post/servicemesh/2019-08-30-mesh-grpc-01/</link>
      <pubDate>Fri, 30 Aug 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/servicemesh/2019-08-30-mesh-grpc-01/</guid>
      
        <description>&lt;p&gt;åœ¨ç½‘æ ¼ä¸­ä½¿ç”¨&lt;code&gt;gRPC&lt;/code&gt;å¯ä»¥æ–¹ä¾¿çš„å®šä¹‰æœåŠ¡ï¼Œè€Œå½“éœ€è¦å¯¹å¤–æä¾›æœåŠ¡æ—¶å¾€å¾€&lt;code&gt;HTTP&lt;/code&gt;æ¥å£æ¯”è¾ƒæ™®éï¼Œ&lt;code&gt;grpc-gateway&lt;/code&gt;æä¾›äº†&lt;code&gt;RESTful JSON API&lt;/code&gt;è½¬&lt;code&gt;gRPC&lt;/code&gt;çš„ä»£ç†æœåŠ¡ã€‚
åœ¨&lt;code&gt;mesh&lt;/code&gt;ä¸­&lt;code&gt;grpc-gateway&lt;/code&gt;çš„è§’è‰²æ›´åƒä¸€ä¸ª&lt;strong&gt;æœåŠ¡èšåˆå±‚&lt;/strong&gt;ï¼Œå°†å†…éƒ¨&lt;code&gt;gRPC&lt;/code&gt;æœåŠ¡èšåˆå¹¶æä¾›&lt;code&gt;HTTP&lt;/code&gt;æ¥å£æœåŠ¡ï¼Œåœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ä¹Ÿé‡åˆ°äº›é—®é¢˜ï¼Œå¦‚ï¼šè¿›ç¨‹å†…è·¯ç”±ã€Headeræ˜ å°„ç­‰ï¼Œè¿™é‡Œç»“åˆä½¿ç”¨ç»éªŒåšä¸ªæ€»ç»“ã€‚&lt;/p&gt;

&lt;h1 id=&#34;æ¥å£å®šä¹‰&#34;&gt;æ¥å£å®šä¹‰&lt;/h1&gt;

&lt;p&gt;&lt;code&gt;gRPC&lt;/code&gt;çš„æœåŠ¡å®šä¹‰è¿™é‡Œä¸åšè¿‡å¤šå…³è”ä»‹ç»ï¼Œ&lt;code&gt;grpc-gateway&lt;/code&gt;åè®®æ”¯æŒä¸¤ç§æ–¹å¼æ·»åŠ ï¼Œä¸€æ˜¯åœ¨&lt;code&gt;.proto&lt;/code&gt;çš„æœåŠ¡å®šä¹‰ä¸­ä»¥&lt;code&gt;option&lt;/code&gt;çš„æ–¹å¼ç›´æ¥ç»‘å®šï¼›
äºŒæ˜¯ä½¿ç”¨å•ç‹¬çš„&lt;code&gt;.yaml&lt;/code&gt;æ–‡ä»¶å®šä¹‰ã€‚æ¥å£å®šä¹‰éµå¾ª&lt;a href=&#34;https://cloud.google.com/service-infrastructure/docs/service-management/reference/rpc/google.api#http&#34;&gt;google.api&lt;/a&gt;å¤§å®¶å¯ä»¥å‚è€ƒï¼Œ
ä¸»è¦å†…å®¹åœ¨&lt;code&gt;HttpRule&lt;/code&gt;ï¼Œå…·ä½“å­—æ®µå‚è€ƒåè®®&lt;a href=&#34;https://github.com/googleapis/googleapis/blob/master/google/api/http.proto&#34;&gt;http.proto&lt;/a&gt;æ›´æ¸…æ™°ï¼Œ
æ¯”å¦‚:&lt;code&gt;response_body&lt;/code&gt;åœ¨æ–‡æ¡£ä¸­å¹¶æ²¡æœ‰æåˆ°ï¼Œç”¨äºé€‰æ‹©&lt;code&gt;Response&lt;/code&gt;ç»“æ„çš„æŸä¸€å­—æ®µä½œä¸ºå“åº”å†…å®¹ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;grpc-gateway&lt;/code&gt;æ–‡æ¡£å‚è€ƒ

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://grpc-ecosystem.github.io/grpc-gateway/docs/usage.html&#34;&gt;Usage&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://grpc-ecosystem.github.io/grpc-gateway/docs/grpcapiconfiguration.html&#34;&gt;Usage without annotations (gRPC API Configuration)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;syntax = &amp;quot;proto3&amp;quot;;
package example;

import &amp;quot;google/api/annotations.proto&amp;quot;;

message StringMessage {
    string value = 1;
}

service YourService {
    rpc Echo (StringMessage) returns (StringMessage) {
       option (google.api.http) = {
           post: &amp;quot;/v1/example/echo&amp;quot;
           body: &amp;quot;*&amp;quot;
       };
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;type: google.api.Service
config_version: 3

http:
  rules:
  - selector: example.YourService.Echo
    post: /v1/example/echo
    body: &amp;quot;*&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;è¿›ç¨‹å†…è·¯ç”±&#34;&gt;è¿›ç¨‹å†…è·¯ç”±&lt;/h1&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/grpc/grpc-gateway.png&#34; alt=&#34;grpc-gateway&#34; /&gt;
&lt;code&gt;grpc-gateway&lt;/code&gt;çš„ä»£ç†æ–¹å¼æ˜¯&lt;code&gt;gRPC&lt;/code&gt;è¿œç¨‹è°ƒç”¨ï¼Œåœ¨&lt;code&gt;mesh&lt;/code&gt;ä¸­æœ‰å·²ç»æœ‰&lt;code&gt;ingress&lt;/code&gt;ç½‘å…³ï¼Œå¦‚æœç»§ç»­ç”¨&lt;code&gt;rpc&lt;/code&gt;è°ƒç”¨ï¼Œ
å°†åœ¨é“¾è·¯ä¸Šåˆå¢åŠ ä¸€å±‚ç½‘ç»œå¼€é”€&lt;code&gt;ingress -&amp;gt; grpc-gatewap -&amp;gt; grpc server&lt;/code&gt;ï¼Œè€Œæˆ‘ä»¬çš„ä¸»è¦ç›®çš„æ˜¯å°†&lt;code&gt;gRPC&lt;/code&gt;æœåŠ¡æ˜ å°„æˆ&lt;code&gt;HTTP&lt;/code&gt;å¹¶ä¸éœ€è¦å…¶å®ƒèƒ½åŠ›ï¼Œ
æ‰€ä»¥æˆ‘ä»¬æœŸæœ›&lt;code&gt;grpc-gateway&lt;/code&gt;èƒ½å¤Ÿè¿›ç¨‹å°†&lt;code&gt;HTTP&lt;/code&gt;è¯·æ±‚è½¬å‘ç»™&lt;code&gt;gRPC&lt;/code&gt;æœåŠ¡ã€‚&lt;/p&gt;

&lt;p&gt;é’ˆå¯¹è¿™ä¸€éœ€æ±‚éœ€è¦&lt;code&gt;gRPC&lt;/code&gt;æœåŠ¡æ”¯æŒè¿›ç¨‹å†…è°ƒç”¨ï¼Œç¤¾åŒºç°æœ‰çš„æ–¹æ¡ˆæ˜¯&lt;a href=&#34;https://github.com/grpc/grpc-go/tree/master/test/bufconn&#34;&gt;test/bufconn&lt;/a&gt;ï¼Œ
ç¤ºä¾‹å‚è€ƒ&lt;a href=&#34;https://github.com/grpc-ecosystem/grpc-gateway/pull/947#issuecomment-502578553&#34;&gt;grpc-gateway/pull/947&lt;/a&gt;ä¸­çš„è®¨è®ºã€‚
è‡³äºç›´æ¥&lt;strong&gt;è¿›ç¨‹å†…è°ƒ&lt;/strong&gt;&lt;code&gt;Contributor&lt;/code&gt;çš„æœ€æ–°å›å¤æ˜¯8æœˆä»½å¯åŠ¨&lt;a href=&#34;https://github.com/grpc/grpc-go/issues/906#issuecomment-513856927&#34;&gt;grpc-go/issues/906&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;p&gt;å¦ä¸€ä¸ªä¸´æ—¶çš„æ–¹æ¡ˆæ˜¯æˆ‘æäº¤åˆ°&lt;code&gt;grpc-gateway&lt;/code&gt;çš„&lt;code&gt;PR&lt;/code&gt; &lt;a href=&#34;https://github.com/grpc-ecosystem/grpc-gateway/pull/947&#34;&gt;pull/947&lt;/a&gt;ï¼Œå·²ç»&lt;code&gt;merge&lt;/code&gt;åˆ°&lt;code&gt;master&lt;/code&gt;ï¼Œ
ä½†æ­¤æ–¹æ¡ˆä»…æ”¯æŒ&lt;code&gt;Unary&lt;/code&gt;ï¼Œä¸æ”¯æŒ&lt;code&gt;Streaming&lt;/code&gt;ï¼Œä¸è¿‡å¯¹äºç½‘å…³åº”è¯¥èƒ½å¤Ÿæ»¡è¶³å¤§éƒ¨åˆ†åœºæ™¯çš„éœ€æ±‚ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func RegisterXXXHandlerServer(ctx context.Context, mux *runtime.ServeMux, server XXXServer) error
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;headerä¼ é€’&#34;&gt;Headerä¼ é€’&lt;/h1&gt;

&lt;p&gt;åœ¨&lt;code&gt;tracing&lt;/code&gt;ç­‰åœºæ™¯æˆ‘ä»¬å¾€å¾€éœ€è¦å°†&lt;code&gt;Header&lt;/code&gt;ä¿¡æ¯åœ¨æœåŠ¡ä¹‹é—´ä¼ é€’ï¼ŒåŒ…æ‹¬&lt;code&gt;RESTful API&lt;/code&gt;è¯·æ±‚ã€‚é¦–å…ˆ&lt;code&gt;grpc-gateway&lt;/code&gt;çš„&lt;code&gt;NewServeMux()&lt;/code&gt;éœ€è¦&lt;code&gt;runtime.WithMetadata()&lt;/code&gt;Optionï¼Œ
ç­›é€‰&lt;code&gt;HTTP Header&lt;/code&gt;æ˜ å°„ä¸º&lt;code&gt;metadata&lt;/code&gt;ï¼›å…¶æ¬¡å¦‚æœæ˜¯ä½¿ç”¨&lt;a href=&#34;https://github.com/grpc/grpc-go/tree/master/test/bufconn&#34;&gt;test/bufconn&lt;/a&gt;æ–¹æ¡ˆï¼Œ
åœ¨&lt;code&gt;RegisterXXXHandlerFromEndpoint(...,opts []grpc.DialOption)&lt;/code&gt; &lt;code&gt;opts&lt;/code&gt;çš„&lt;code&gt;grpc.WithChainUnaryInterceptor()&lt;/code&gt;ä¸­éœ€è¦å¢åŠ &lt;code&gt;metadata&lt;/code&gt;çš„æ˜ å°„ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;grpc-gateway&lt;/code&gt;çš„å¦ä¸€ä¸ªæ–¹å¼æ˜¯&lt;code&gt;runtime.WithIncomingHeaderMatcher()&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨å¯ä»¥å‚è€ƒæˆ‘çš„&lt;code&gt;metadata&lt;/code&gt;æ’ä»¶&lt;a href=&#34;https://github.com/hb-go/grpc-contrib/tree/master/metadata&#34;&gt;github.com/hb-go/grpc-contrib/metadata&lt;/a&gt;ï¼Œ
æ”¯æŒæŒ‡å®š&lt;strong&gt;Header&lt;/strong&gt;å’Œ&lt;strong&gt;å‰ç¼€åŒ¹é…&lt;/strong&gt;ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;hb-go/grpc-contrib/metadata&lt;/code&gt;ç¤ºä¾‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;mux := runtime.NewServeMux(
    runtime.WithMetadata(metadata.GatewayMetadataAnnotator(
        metadata.WithHeader(&amp;quot;x-request-id&amp;quot;),
        metadata.WithPrefix(&amp;quot;x-prefix&amp;quot;),
    )),
)
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;err := pb.RegisterXXXHandlerFromEndpoint(ctx, mux, &amp;quot;&amp;quot;,
    []grpc.DialOption{
        grpc.WithChainUnaryInterceptor(
            metadata.UnaryClientInterceptor(
                metadata.WithHeader(&amp;quot;x-request-id&amp;quot;),
                metadata.WithPrefix(&amp;quot;x-prefix&amp;quot;),
            ),
        ),
    },
)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;Istio&lt;/code&gt;ç¯å¢ƒè¦å®Œæ•´&lt;code&gt;tracing&lt;/code&gt;é“¾è·¯ï¼Œ&lt;code&gt;ClientConn&lt;/code&gt;éœ€è¦ä¸&lt;code&gt;grpc-gateway&lt;/code&gt;ä¸€æ ·ï¼Œåœ¨&lt;code&gt;DialOption&lt;/code&gt;çš„&lt;code&gt;grpc.WithChainUnaryInterceptor()&lt;/code&gt;ä¸­åŠ å…¥&lt;code&gt;metadata.UnaryClientInterceptor(...)&lt;/code&gt;ï¼Œ
&lt;code&gt;Header&lt;/code&gt;è¯´æ˜å‚è€ƒ&lt;code&gt;Istio&lt;/code&gt;æ–‡æ¡£&lt;a href=&#34;https://istio.io/faq/distributed-tracing/#how-to-support-tracing&#34;&gt;WHAT IS REQUIRED FOR DISTRIBUTED TRACING WITH ISTIO?&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;metadata.WithHeader(&amp;quot;x-request-id&amp;quot;),
metadata.WithHeader(&amp;quot;x-b3-traceid&amp;quot;),
metadata.WithHeader(&amp;quot;x-b3-spanid&amp;quot;),
metadata.WithHeader(&amp;quot;x-b3-parentspanid&amp;quot;),
metadata.WithHeader(&amp;quot;x-b3-sampled&amp;quot;),
metadata.WithHeader(&amp;quot;x-b3-flags&amp;quot;),
metadata.WithHeader(&amp;quot;b3&amp;quot;),
metadata.WithHeader(&amp;quot;x-ot-span-context&amp;quot;),
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;TODO&lt;/p&gt;

&lt;h1 id=&#34;å‚æ•°æ˜ å°„&#34;&gt;å‚æ•°æ˜ å°„&lt;/h1&gt;

&lt;ul&gt;
&lt;li&gt;body&lt;/li&gt;
&lt;li&gt;path&lt;/li&gt;
&lt;li&gt;queue&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;</description>
      
    </item>
    
    <item>
      <title>ã€go-microã€‘ä½¿ç”¨kubernetesæ³¨å†Œä¸­å¿ƒ</title>
      <link>http://hbchen.com/post/microservice/2019-06-27-go-micro-use-kubernetes-registry/</link>
      <pubDate>Thu, 27 Jun 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/microservice/2019-06-27-go-micro-use-kubernetes-registry/</guid>
      
        <description>&lt;p&gt;&lt;code&gt;go-micro&lt;/code&gt;éƒ¨ç½²åˆ°&lt;code&gt;kubernetes&lt;/code&gt;ç¯å¢ƒï¼Œå¯ä»¥é€‰æ‹©&lt;code&gt;kubernetes&lt;/code&gt;æ³¨å†Œä¸­å¿ƒæ’ä»¶ï¼Œå‡å°‘ç»„ä»¶ä¾èµ–ç®€åŒ–è¿ç»´ã€‚&lt;/p&gt;

&lt;h1 id=&#34;ä¸»è¦å·¥ä½œ&#34;&gt;ä¸»è¦å·¥ä½œ&lt;/h1&gt;

&lt;blockquote&gt;
&lt;p&gt;éƒ¨ç½²ç¤ºä¾‹&lt;a href=&#34;https://github.com/hb-go/micro/tree/master/k8s&#34;&gt;hb-go/micro&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;micro&lt;/code&gt;é€‰æ‹©è‡ªå·±ç¼–è¯‘ï¼Œè€Œä¸æ˜¯ç›´æ¥&lt;code&gt;go get -u github.com/micro/micro&lt;/code&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;è‡ªå®šä¹‰é€‰æ‹©æ’ä»¶çš„æ”¯æŒ&lt;/li&gt;
&lt;li&gt;è‡ªå·±å‘å¸ƒé•œåƒï¼Œå®˜æ–¹&lt;code&gt;microhq/micro&lt;/code&gt;ä¸Šçš„é•œåƒæ²¡æœ‰ç‰ˆæœ¬ï¼Œå®¹æ˜“å‡ºç°å…¼å®¹é—®é¢˜&lt;/li&gt;
&lt;li&gt;å¦å¤–éå¸¸é‡è¦çš„ä¸€ç‚¹&lt;strong&gt;ä¿è¯æœ¬åœ°ä¸çº¿ä¸Š&lt;code&gt;micro&lt;/code&gt;çš„ä¸€è‡´&lt;/strong&gt;ï¼Œåªéœ€è¦æ›¿æ¢æ³¨å†Œä¸­å¿ƒ&lt;code&gt;--registry=kubernetes&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;go build&lt;/code&gt;æ‰“åŒ…æœåŠ¡æ—¶å¢åŠ &lt;code&gt;kubernetes&lt;/code&gt;æ’ä»¶&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;import (
	_ &amp;quot;github.com/micro/go-plugins/registry/kubernetes&amp;quot;
)
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&#34;rbacé—®é¢˜&#34;&gt;RBACé—®é¢˜&lt;/h1&gt;

&lt;p&gt;å¦‚æœ&lt;code&gt;kubernetes&lt;/code&gt;å¼€å¯äº†&lt;code&gt;RBAC&lt;/code&gt;ï¼Œåœ¨éƒ¨ç½²æœåŠ¡æ—¶éœ€è¦é…ç½®&lt;code&gt;RBAC&lt;/code&gt;ï¼ŒåŒ…æ‹¬&lt;code&gt;micro web&lt;/code&gt;ã€&lt;code&gt;micro api&lt;/code&gt;æœåŠ¡ï¼Œå¦åˆ™æœåŠ¡æ³¨å†Œ/å‘ç°å°†å¤±è´¥&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;2019/06/27 12:54:13 K8s: request failed with code 403
2019/06/27 12:54:13 K8s: request failed with body:
2019/06/27 12:54:13 {&amp;quot;kind&amp;quot;:&amp;quot;Status&amp;quot;,&amp;quot;apiVersion&amp;quot;:&amp;quot;v1&amp;quot;,&amp;quot;metadata&amp;quot;:{},&amp;quot;status&amp;quot;:&amp;quot;Failure&amp;quot;,&amp;quot;message&amp;quot;:&amp;quot;pods \&amp;quot;micro-web-79545546b4-p5vbt\&amp;quot; is forbidden: User \&amp;quot;system:serviceaccount:default:default\&amp;quot; cannot patch resource \&amp;quot;pods\&amp;quot; in API group \&amp;quot;\&amp;quot; in the namespace \&amp;quot;default\&amp;quot;&amp;quot;,&amp;quot;reason&amp;quot;:&amp;quot;Forbidden&amp;quot;,&amp;quot;details&amp;quot;:{&amp;quot;name&amp;quot;:&amp;quot;micro-web-79545546b4-p5vbt&amp;quot;,&amp;quot;kind&amp;quot;:&amp;quot;pods&amp;quot;},&amp;quot;code&amp;quot;:403}
2019/06/27 12:54:13 Server register error: K8s: error
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;rbac-yaml&#34;&gt;RBAC yaml&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: v1
kind: ServiceAccount
metadata:
  name: micro-services
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: micro-registry
rules:
- apiGroups:
  - &amp;quot;&amp;quot;
  resources:
  - pods
  verbs:
  - list
  - patch
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: micro-registry
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: micro-registry
subjects:
- kind: ServiceAccount
  name: micro-services
  namespace: default
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æœåŠ¡æŒ‡å®šservice-account&#34;&gt;æœåŠ¡æŒ‡å®šService Account&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  namespace: default
  name: micro-api
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: micro-api
    spec:
+     serviceAccountName: micro-services
      containers:
      - name: api
        command: [
          &amp;quot;/micro&amp;quot;,
          &amp;quot;--registry=kubernetes&amp;quot;,
          &amp;quot;--server=rpc&amp;quot;,
          &amp;quot;--broker=http&amp;quot;,
          &amp;quot;--transport=http&amp;quot;,
          &amp;quot;--register_ttl=60&amp;quot;,
          &amp;quot;--register_interval=30&amp;quot;,
          &amp;quot;--selector=cache&amp;quot;,
          &amp;quot;--enable_stats&amp;quot;,
          &amp;quot;api&amp;quot;
        ]
        image: hbchen/micro:k8s
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
          name: api-port
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>ã€go-microã€‘æœåŠ¡é—´é€šä¿¡æ’ä»¶Benchmark</title>
      <link>http://hbchen.com/post/microservice/2019-05-31-go-micro-benchmark/</link>
      <pubDate>Fri, 31 May 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/microservice/2019-05-31-go-micro-benchmark/</guid>
      
        <description>&lt;p&gt;æµ‹è¯•å½±å“&lt;code&gt;go-micro&lt;/code&gt;æœåŠ¡é—´é€šä¿¡æ•ˆç‡çš„ä¸‰ä¸ªç»„ä»¶ï¼š&lt;code&gt;transport&lt;/code&gt;ã€&lt;code&gt;server&lt;/code&gt;ä»¥åŠ&lt;code&gt;codec&lt;/code&gt;ï¼Œä¸»è¦åšä¸åŒæ’ä»¶é—´çš„æ¨ªå‘å¯¹æ¯”ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;æºç &lt;a href=&#34;https://github.com/hb-go/micro/tree/master/benchmark&#34;&gt;github.com/hb-go/micro/benchmark&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;strong&gt;æµ‹è¯•ç¯å¢ƒ&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;MBP&lt;/li&gt;
&lt;li&gt;go &lt;strong&gt;1.12.5&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;go-micro &lt;strong&gt;v1.2.0&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;go-plugins &lt;strong&gt;v1.1.0&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;transport-serverå¯¹æ¯”&#34;&gt;Transport + Serverå¯¹æ¯”&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;transport&lt;/code&gt;å’Œ&lt;code&gt;server&lt;/code&gt;çš„å¯¹æ¯”ä½¿ç”¨&lt;code&gt;100&lt;/code&gt;å¹¶å‘ï¼Œå®Œæˆ&lt;code&gt;10W&lt;/code&gt;è¯·æ±‚è¿›è¡Œæµ‹è¯•&lt;/p&gt;

&lt;h3 id=&#34;ç»“æœå¯¹æ¯”&#34;&gt;ç»“æœå¯¹æ¯”&lt;/h3&gt;

&lt;p&gt;ä»ç»“æœçœ‹&lt;code&gt;tcp&lt;/code&gt;+&lt;code&gt;rpc&lt;/code&gt;ååé‡æœ€é«˜ï¼Œåˆ†åˆ«æ¯”è¾ƒï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;transport&lt;/code&gt;æ¯”è¾ƒç»“æœ&lt;code&gt;tcp&lt;/code&gt;&amp;gt;&lt;code&gt;grpc&lt;/code&gt;&amp;gt;&lt;code&gt;utp&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;server&lt;/code&gt;æ¯”è¾ƒç»“æœå¤§è‡´ä¸º&lt;code&gt;rpc&lt;/code&gt;&amp;gt;&lt;code&gt;grpc&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;T+S&lt;/th&gt;
&lt;th&gt;å¹³å‡&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;ä¸­ä½&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;æœ€å¤§&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;æœ€å°&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;P90&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;P99&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;TPS&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;tcp+rpc&lt;/td&gt;
&lt;td&gt;7.236&lt;/td&gt;
&lt;td&gt;5.629&lt;/td&gt;
&lt;td&gt;101.506&lt;/td&gt;
&lt;td&gt;0.177&lt;/td&gt;
&lt;td&gt;13.338&lt;/td&gt;
&lt;td&gt;35.880&lt;/td&gt;
&lt;td&gt;13192&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;grpc+rpc&lt;/td&gt;
&lt;td&gt;8.668&lt;/td&gt;
&lt;td&gt;7.964&lt;/td&gt;
&lt;td&gt;101.280&lt;/td&gt;
&lt;td&gt;0.251&lt;/td&gt;
&lt;td&gt;12.744&lt;/td&gt;
&lt;td&gt;21.672&lt;/td&gt;
&lt;td&gt;11166&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;utp+rpc&lt;/td&gt;
&lt;td&gt;11.824&lt;/td&gt;
&lt;td&gt;11.600&lt;/td&gt;
&lt;td&gt;53.183&lt;/td&gt;
&lt;td&gt;0.204&lt;/td&gt;
&lt;td&gt;15.575&lt;/td&gt;
&lt;td&gt;21.334&lt;/td&gt;
&lt;td&gt;8252&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;grpc+grpc&lt;/td&gt;
&lt;td&gt;8.924&lt;/td&gt;
&lt;td&gt;8.181&lt;/td&gt;
&lt;td&gt;134.434&lt;/td&gt;
&lt;td&gt;0.286&lt;/td&gt;
&lt;td&gt;13.211&lt;/td&gt;
&lt;td&gt;22.973&lt;/td&gt;
&lt;td&gt;10845&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;blockquote&gt;
&lt;p&gt;åœ¨å¼€å§‹çš„æµ‹è¯•ä¸­æœ‰ä¸ªè¯¯åŒºï¼Œ&lt;code&gt;grpc&lt;/code&gt;æœåŠ¡å¹¶ä¸ä½¿ç”¨&lt;code&gt;transport&lt;/code&gt;ï¼ŒåŒ…æ‹¬&lt;code&gt;http&lt;/code&gt;æœåŠ¡ï¼Œ&lt;code&gt;transport&lt;/code&gt;ä»…åœ¨ä½¿ç”¨&lt;code&gt;go-micro&lt;/code&gt;çš„&lt;code&gt;rpc&lt;/code&gt;æœåŠ¡æ—¶æœ‰æ•ˆ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;codecå¯¹æ¯”&#34;&gt;Codecå¯¹æ¯”&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;transport&lt;/code&gt;å’Œ&lt;code&gt;server&lt;/code&gt;åˆ†åˆ«ä½¿ç”¨&lt;code&gt;tcp&lt;/code&gt;å’Œ&lt;code&gt;rpc&lt;/code&gt;å¯¹æ¯”ä¸åŒ&lt;code&gt;codec&lt;/code&gt;æ€§èƒ½ï¼Œå› ä¸ºå¹¶å‘&lt;code&gt;100&lt;/code&gt;æ—¶ä¸åŒ&lt;code&gt;codec&lt;/code&gt;çš„å¤±è´¥ç‡å·®åˆ«æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥ä½¿ç”¨&lt;code&gt;50&lt;/code&gt;å¹¶å‘ï¼Œå®Œæˆ&lt;code&gt;10W&lt;/code&gt;è¯·æ±‚è¿›è¡Œæµ‹è¯•&lt;/p&gt;

&lt;h3 id=&#34;ç»“æœå¯¹æ¯”-1&#34;&gt;ç»“æœå¯¹æ¯”&lt;/h3&gt;

&lt;p&gt;å¯¹æ¯”ç»“æœï¼š&lt;code&gt;protobuf&lt;/code&gt;&amp;gt;&lt;code&gt;proto-rpc&lt;/code&gt;&amp;gt;&lt;code&gt;grpc&lt;/code&gt;&amp;gt;&lt;code&gt;json&lt;/code&gt;&amp;gt;&lt;code&gt;grpc+json&lt;/code&gt;&amp;gt;&lt;code&gt;json-rpc&lt;/code&gt;&amp;gt;&lt;code&gt;bsonrpc&lt;/code&gt;&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;CODEC&lt;/th&gt;
&lt;th&gt;å¹³å‡&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;ä¸­ä½&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;æœ€å¤§&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;æœ€å°&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;P90&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;P99&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;TPS&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;grpc&lt;/td&gt;
&lt;td&gt;3.937&lt;/td&gt;
&lt;td&gt;2.979&lt;/td&gt;
&lt;td&gt;90.004&lt;/td&gt;
&lt;td&gt;0.180&lt;/td&gt;
&lt;td&gt;7.184&lt;/td&gt;
&lt;td&gt;19.355&lt;/td&gt;
&lt;td&gt;12310&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;grpc+json&lt;/td&gt;
&lt;td&gt;6.085&lt;/td&gt;
&lt;td&gt;4.694&lt;/td&gt;
&lt;td&gt;149.861&lt;/td&gt;
&lt;td&gt;0.342&lt;/td&gt;
&lt;td&gt;10.365&lt;/td&gt;
&lt;td&gt;31.837&lt;/td&gt;
&lt;td&gt;8000&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;protobuf&lt;/td&gt;
&lt;td&gt;3.661&lt;/td&gt;
&lt;td&gt;2.707&lt;/td&gt;
&lt;td&gt;96.636&lt;/td&gt;
&lt;td&gt;0.156&lt;/td&gt;
&lt;td&gt;6.542&lt;/td&gt;
&lt;td&gt;20.261&lt;/td&gt;
&lt;td&gt;13150&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;json&lt;/td&gt;
&lt;td&gt;5.402&lt;/td&gt;
&lt;td&gt;4.122&lt;/td&gt;
&lt;td&gt;122.360&lt;/td&gt;
&lt;td&gt;0.225&lt;/td&gt;
&lt;td&gt;9.186&lt;/td&gt;
&lt;td&gt;30.474&lt;/td&gt;
&lt;td&gt;8896&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;json-rpc&lt;/td&gt;
&lt;td&gt;6.380&lt;/td&gt;
&lt;td&gt;4.878&lt;/td&gt;
&lt;td&gt;115.141&lt;/td&gt;
&lt;td&gt;0.288&lt;/td&gt;
&lt;td&gt;11.150&lt;/td&gt;
&lt;td&gt;33.395&lt;/td&gt;
&lt;td&gt;7631&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;proto-rpc&lt;/td&gt;
&lt;td&gt;3.692&lt;/td&gt;
&lt;td&gt;2.729&lt;/td&gt;
&lt;td&gt;101.010&lt;/td&gt;
&lt;td&gt;0.180&lt;/td&gt;
&lt;td&gt;6.701&lt;/td&gt;
&lt;td&gt;19.454&lt;/td&gt;
&lt;td&gt;13041&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;bsonrpc&lt;/td&gt;
&lt;td&gt;7.912&lt;/td&gt;
&lt;td&gt;5.979&lt;/td&gt;
&lt;td&gt;132.041&lt;/td&gt;
&lt;td&gt;0.354&lt;/td&gt;
&lt;td&gt;14.789&lt;/td&gt;
&lt;td&gt;40.414&lt;/td&gt;
&lt;td&gt;6145&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;é»˜è®¤&lt;code&gt;chdec&lt;/code&gt;å¦‚ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;DefaultCodecs = map[string]codec.NewCodec{
    &amp;quot;application/grpc&amp;quot;:         grpc.NewCodec,
    &amp;quot;application/grpc+json&amp;quot;:    grpc.NewCodec,
    &amp;quot;application/grpc+proto&amp;quot;:   grpc.NewCodec,
    &amp;quot;application/json&amp;quot;:         json.NewCodec,
    &amp;quot;application/json-rpc&amp;quot;:     jsonrpc.NewCodec,
    &amp;quot;application/protobuf&amp;quot;:     proto.NewCodec,
    &amp;quot;application/proto-rpc&amp;quot;:    protorpc.NewCodec,
    &amp;quot;application/octet-stream&amp;quot;: raw.NewCodec,
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¦å¤–&lt;code&gt;go-plugins&lt;/code&gt;æä¾›ä¸‰ä¸ª&lt;code&gt;codec&lt;/code&gt;æ’ä»¶ï¼Œåœ¨&lt;code&gt;server&lt;/code&gt;å’Œ&lt;code&gt;client&lt;/code&gt;åˆå§‹åŒ–æ—¶è‡ªå®šä¹‰æ·»åŠ &lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;server.Codec(&amp;quot;application/msgpackrpc&amp;quot;, msgpackrpc.NewCodec),
server.Codec(&amp;quot;application/bsonrpc&amp;quot;, bsonrpc.NewCodec),
server.Codec(&amp;quot;application/jsonrpc2&amp;quot;, jsonrpc2.NewCodec),

client.Codec(&amp;quot;application/msgpackrpc&amp;quot;, msgpackrpc.NewCodec),
client.Codec(&amp;quot;application/bsonrpc&amp;quot;, bsonrpc.NewCodec),
client.Codec(&amp;quot;application/jsonrpc2&amp;quot;, jsonrpc2.NewCodec),
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å®é™…æµ‹è¯•æ—¶ç”±äºä¸åŒåŸå› &lt;code&gt;raw&lt;/code&gt; ã€&lt;code&gt;msgpackrpc&lt;/code&gt;å’Œ&lt;code&gt;jsonrpc2&lt;/code&gt;è¿è¡Œå¤±è´¥æœªæµ‹è¯•ï¼Œ&lt;code&gt;grpc+proto&lt;/code&gt;ä¸&lt;code&gt;grpc&lt;/code&gt;å®ç°ä¸€è‡´æœªæµ‹è¯•&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;raw.NewCodec&lt;br/&gt;error:{&amp;ldquo;id&amp;rdquo;:&amp;ldquo;go.micro.client.codec&amp;rdquo;,&amp;ldquo;code&amp;rdquo;:500,&amp;ldquo;detail&amp;rdquo;:&amp;ldquo;failed to write: field1:â€¦â€¦&lt;br/&gt;
 msgpackrpc.NewCodecï¼Œéœ€è¦å®ç°EncodeMsg(*Writer)&lt;br/&gt;error:{&amp;ldquo;id&amp;rdquo;:&amp;ldquo;go.micro.client.codec&amp;rdquo;,&amp;ldquo;code&amp;rdquo;:500,&amp;ldquo;detail&amp;rdquo;:&amp;ldquo;Not encodable&amp;rdquo;,&amp;ldquo;status&amp;rdquo;:&amp;ldquo;Internal Server Error&amp;rdquo;}&lt;br/&gt;
 jsonrpc2.NewCodec&lt;br/&gt;error:{&amp;ldquo;id&amp;rdquo;:&amp;ldquo;go.micro.client.transport&amp;rdquo;,&amp;ldquo;code&amp;rdquo;:500,&amp;ldquo;detail&amp;rdquo;:&amp;ldquo;EOF&amp;rdquo;,&amp;ldquo;status&amp;rdquo;:&amp;ldquo;Internal Server Error&amp;rdquo;}&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;è¯¦ç»†æ•°æ®&#34;&gt;è¯¦ç»†æ•°æ®&lt;/h2&gt;

&lt;h3 id=&#34;transport-server&#34;&gt;Transport + Server&lt;/h3&gt;

&lt;h4 id=&#34;æµ‹è¯•å‘½ä»¤&#34;&gt;æµ‹è¯•å‘½ä»¤&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ go run server.go
$ go run client.go -c 100 -n 100000
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;tcp + rpc&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 7580
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 99999
throughput (TPS)       : 13192

concurrency mean      median    max         min       p90        p99        TPS
100         7235584ns 5629000ns 101506000ns 177000ns  13338000ns 35880000ns 13192
100         7.236ms   5.629ms   101.506ms   0.177ms   13.338ms   35.880ms   13192

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;grpc + rpc&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 8955
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 99999
throughput (TPS)       : 11166

concurrency mean      median    max         min       p90        p99        TPS
100         8668191ns 7964000ns 101280000ns 251000ns  12744000ns 21672000ns 11166
100         8.668ms   7.964ms   101.280ms   0.251ms   12.744ms   21.672ms   11166
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;utp + rpc&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 12117
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 100000
throughput (TPS)       : 8252

concurrency mean       median     max        min       p90        p99        TPS
100         11823520ns 11600000ns 53183000ns 204000ns  15575000ns 21334000ns 8252
100         11.824ms   11.600ms   53.183ms   0.204ms   15.575ms   21.334ms   8252
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;grpc + gRPC&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 9220
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 99995
throughput (TPS)       : 10845

concurrency mean      median    max         min       p90        p99        TPS
100         8924043ns 8181000ns 134434000ns 286000ns  13211000ns 22973000ns 10845
100         8.924ms   8.181ms   134.434ms   0.286ms   13.211ms   22.973ms   10845
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;codec&#34;&gt;Codec&lt;/h3&gt;

&lt;h4 id=&#34;æµ‹è¯•å‘½ä»¤-1&#34;&gt;æµ‹è¯•å‘½ä»¤&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cd benchmark/tcp_rpc
$ go run server.go
$ go run client.go -c 50 -n 100000 -ct grpc
$ go run client.go -c 50 -n 100000 -ct grpc+json
$ go run client.go -c 50 -n 100000 -ct protobuf
$ go run client.go -c 50 -n 100000 -ct json
$ go run client.go -c 50 -n 100000 -ct json-rpc
$ go run client.go -c 50 -n 100000 -ct proto-rpc
$ go run client.go -c 50 -n 100000 -ct bsonrpc
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;grpc&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 8123
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 100000
throughput (TPS)       : 12310

concurrency mean      median    max        min       p90       p99        TPS
50          3936652ns 2979000ns 90004000ns 180000ns  7184000ns 19355000ns 12310
50          3.937ms   2.979ms   90.004ms   0.180ms   7.184ms   19.355ms   12310
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;grpc+json&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 12500
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 99961
throughput (TPS)       : 8000

concurrency mean      median    max         min       p90        p99        TPS
50          6084709ns 4694000ns 149861000ns 342000ns  10365000ns 31837000ns 8000
50          6.085ms   4.694ms   149.861ms   0.342ms   10.365ms   31.837ms   8000
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;protobuf&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 7604
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 100000
throughput (TPS)       : 13150

concurrency mean      median    max        min       p90       p99        TPS
50          3660854ns 2707000ns 96636000ns 156000ns  6542000ns 20261000ns 13150
50          3.661ms   2.707ms   96.636ms   0.156ms   6.542ms   20.261ms   13150
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;json&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 11241
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 99922
throughput (TPS)       : 8896

concurrency mean      median    max         min       p90       p99        TPS
50          5401532ns 4121500ns 122360000ns 225000ns  9186000ns 30474000ns 8896
50          5.402ms   4.122ms   122.360ms   0.225ms   9.186ms   30.474ms   8896
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;json-rpc&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 13103
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 99971
throughput (TPS)       : 7631

concurrency mean      median    max         min       p90        p99        TPS
50          6380308ns 4878000ns 115141000ns 288000ns  11150000ns 33395000ns 7631
50          6.380ms   4.878ms   115.141ms   0.288ms   11.150ms   33.395ms   7631
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;proto-rpc&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 7668
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 99998
throughput (TPS)       : 13041

concurrency mean      median    max         min       p90       p99        TPS
50          3692281ns 2729000ns 101010000ns 180000ns  6701000ns 19454000ns 13041
50          3.692ms   2.729ms   101.010ms   0.180ms   6.701ms   19.454ms   13041
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;bsonrpc&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 16272
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 99933
throughput (TPS)       : 6145

concurrency mean      median    max         min       p90        p99        TPS
50          7911887ns 5979000ns 132041000ns 354000ns  14789000ns 40414000ns 6145
50          7.912ms   5.979ms   132.041ms   0.354ms   14.789ms   40.414ms   6145
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Istioå®‰å…¨ã€‘ç½‘æ ¼è¾¹ç¼˜-Ingress</title>
      <link>http://hbchen.com/post/servicemesh/2019-05-11-istio-security-ingress/</link>
      <pubDate>Sat, 11 May 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/servicemesh/2019-05-11-istio-security-ingress/</guid>
      
        <description>&lt;p&gt;æ¥&lt;a href=&#34;(/post/servicemesh/2019-04-11-istio-security-egress/)&#34;&gt;ã€Istioå®‰å…¨ã€‘ç½‘æ ¼è¾¹ç¼˜-Egress&lt;/a&gt;ç»§ç»­ç½‘æ ¼è¾¹ç¼˜çš„å®è·µ&lt;code&gt;ingress-gateway&lt;/code&gt;ï¼Œ
åˆ†ä¸º&lt;strong&gt;HTTP&lt;/strong&gt;ã€&lt;strong&gt;HTTPS-ä¸ç»ˆæ­¢TLS&lt;/strong&gt;å’Œ&lt;strong&gt;HTTPS-ç§å­TLS&lt;/strong&gt;ä¸‰ç§åœºæ™¯ã€‚&lt;/p&gt;

&lt;h2 id=&#34;å‡†å¤‡å·¥ä½œ&#34;&gt;å‡†å¤‡å·¥ä½œ&lt;/h2&gt;

&lt;p&gt;æœ‰äº†&lt;a href=&#34;http://hbchen.com/post/servicemesh/2019-04-11-istio-security-egress/&#34;&gt;Egress&lt;/a&gt;çš„å®è·µï¼Œè¿™é‡Œä¸ä½¿ç”¨&lt;code&gt;httpbin&lt;/code&gt;åšå†…éƒ¨æœåŠ¡ï¼Œè€Œæ˜¯ç”¨&lt;code&gt;egress-gateway&lt;/code&gt;çš„æˆæœï¼Œ
&lt;code&gt;www.aliyun.com&lt;/code&gt;å’Œ&lt;code&gt;hbchen.com&lt;/code&gt;çš„ä¸¤ä¸ªå¤–éƒ¨æœåŠ¡è¿›è¡Œæµ‹è¯•ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;$ kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: entry-x
spec:
  hosts:
  - www.aliyun.com
  - hbchen.com
  ports:
  - number: 80
    name: http
    protocol: HTTP
  resolution: NONE
EOF

$ kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: originate-tls-for-aliyun
spec:
  host: www.aliyun.com
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
  subsets:
    - name: originate-tls
      trafficPolicy:
        loadBalancer:
          simple: ROUND_ROBIN
        portLevelSettings:
        - port:
            number: 443
          tls:
            mode: SIMPLE
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;ç¯å¢ƒå˜é‡&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=&#39;{.spec.ports[?(@.name==&amp;quot;http2&amp;quot;)].nodePort}&#39;)
export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=&#39;{.spec.ports[?(@.name==&amp;quot;https&amp;quot;)].nodePort}&#39;)

export INGRESS_HOST=$(minikube ip)
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;æ¥ä¸‹æ¥è¿›å…¥æ­£æ–‡&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;éƒ½åªéœ€è¦å®šä¹‰ä¸¤ä¸ª&lt;code&gt;.yaml&lt;/code&gt;é…ç½®:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Gateway&lt;/strong&gt;:&lt;code&gt;ingress-example-gateway&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;VirtualService&lt;/strong&gt;:&lt;code&gt;ingress-example-svc&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;http-gateway&#34;&gt;Http Gateway&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/istio/ingress-http.png&#34; alt=&#34;ServiceEntry&#34; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å®˜æ–¹æ–‡æ¡£&lt;a href=&#34;https://istio.io/zh/docs/tasks/traffic-management/ingress/&#34;&gt;æ§åˆ¶ Ingress æµé‡&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: ingress-example-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: http
    hosts:
    - &amp;quot;hbchen.com&amp;quot;
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ingress-example-svc
spec:
  hosts:
  - &amp;quot;hbchen.com&amp;quot;
  gateways:
  - ingress-example-gateway
  http:
  - match:
    - port: 80
    route:
    - destination:
        host: hbchen.com
        port:
          number: 80
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;curl -I -v -HHost:hbchen.com http://$INGRESS_HOST:$INGRESS_PORT
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;https-gateway-ä¸ç»ˆæ­¢-tls&#34;&gt;Https Gateway-ä¸ç»ˆæ­¢&lt;code&gt;TLS&lt;/code&gt;&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/istio/ingress-https-passthrough.png&#34; alt=&#34;ServiceEntry&#34; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å®˜æ–¹æ–‡æ¡£&lt;a href=&#34;https://istio.io/zh/docs/examples/advanced-gateways/ingress-sni-passthrough/&#34;&gt;æ²¡æœ‰ TLS çš„ Ingress gateway&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä¸ç»ˆæ­¢&lt;code&gt;TLS&lt;/code&gt;å³é€ä¼ &lt;code&gt;https&lt;/code&gt;è¯·æ±‚åˆ°ç½‘æ ¼å†…æœåŠ¡ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå¤–éƒ¨æœåŠ¡æ¥æ¨¡æ‹Ÿä¸€ä¸ªæ”¯æŒ&lt;code&gt;https&lt;/code&gt;çš„æœåŠ¡&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: ingress-example-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: http
    hosts:
    - &amp;quot;www.aliyun.com&amp;quot;
  - port:
      number: 443
      name: https
      protocol: HTTPS
    tls:
      mode: PASSTHROUGH
    hosts:
    - &amp;quot;www.aliyun.com&amp;quot;
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ingress-example-svc
spec:
  hosts:
  - &amp;quot;www.aliyun.com&amp;quot;
  gateways:
  - ingress-example-gateway
  http:
  - match:
    - port: 80
    route:
    - destination:
        host: www.aliyun.com
        subset: originate-tls
        port:
          number: 443
  tls:
  - match:
    - port: 443
      sni_hosts:
      - www.aliyun.com
    route:
    - destination:
        host: www.aliyun.com
        port:
          number: 443
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;curl -I -v -HHost:www.aliyun.com http://$INGRESS_HOST:$INGRESS_PORT
curl -I -v --resolve www.aliyun.com:$SECURE_INGRESS_PORT:$INGRESS_HOST https://www.aliyun.com:$SECURE_INGRESS_PORT
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;https-gateway-ç»ˆæ­¢-tls&#34;&gt;Https Gateway-ç»ˆæ­¢&lt;code&gt;TLS&lt;/code&gt;&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/istio/ingress-https.png&#34; alt=&#34;ServiceEntry&#34; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å®˜æ–¹æ–‡æ¡£&lt;a href=&#34;https://istio.io/zh/docs/tasks/traffic-management/secure-ingress/sds/&#34;&gt;ä½¿ç”¨ SDS ä¸º Gateway æä¾› HTTPS åŠ å¯†æ”¯æŒ&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ç»ˆæ­¢&lt;code&gt;TLS&lt;/code&gt;å³ç”±&lt;code&gt;ingress-gateway&lt;/code&gt;æä¾›&lt;code&gt;https&lt;/code&gt;æœåŠ¡ï¼Œæ›´ç¬¦åˆ&lt;code&gt;ingress-gateway&lt;/code&gt;ä½œä¸ºç½‘æ ¼ç»Ÿä¸€å…¥å£çš„éœ€æ±‚&lt;/p&gt;

&lt;h3 id=&#34;å¯ç”¨sds&#34;&gt;å¯ç”¨SDS&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;SDS&lt;/code&gt;é»˜è®¤æ˜¯å…³é—­çš„ï¼Œæ‰€ä»¥é¦–å…ˆéœ€è¦å¼€å¯&lt;code&gt;ingress-gateway&lt;/code&gt;çš„&lt;code&gt;SDS&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cd istio/path 

# ç”Ÿæˆ.yaml
$ helm template install/kubernetes/helm/istio/ --name istio \
--namespace istio-system -x charts/gateways/templates/deployment.yaml \
--set gateways.istio-egressgateway.enabled=false \
--set gateways.istio-ingressgateway.sds.enabled=true &amp;gt; \
$HOME/istio-ingressgateway.yaml

# é‡æ–°éƒ¨ç½²
$ kubectl apply -f $HOME/istio-ingressgateway.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;ç”Ÿæˆè¯ä¹¦&#34;&gt;ç”Ÿæˆè¯ä¹¦&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ git clone https://github.com/nicholasjackson/mtls-go-example

$ cd mtls-go-example
$ ./generate.sh hbchen.com 123456

$ mkdir ./../hbchen.com &amp;amp;&amp;amp; mv 1_root 2_intermediate 3_application 4_client ./../hbchen.com
$ cd ..
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;åˆ›å»º-secret&#34;&gt;åˆ›å»º&lt;code&gt;Secret&lt;/code&gt;&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl create -n istio-system secret generic hbchen-credential \
--from-file=key=hbchen.com/3_application/private/hbchen.com.key.pem \
--from-file=cert=hbchen.com/3_application/certs/hbchen.com.cert.pem
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: ingress-example-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 443
      name: https
      protocol: HTTPS
    tls:
      mode: SIMPLE
      credentialName: &amp;quot;hbchen-credential&amp;quot; # NOTE: å’Œ Secret åç§°ä¸€è‡´
    hosts:
    - &amp;quot;hbchen.com&amp;quot;
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ingress-example-svc
spec:
  hosts:
  - &amp;quot;hbchen.com&amp;quot;
  gateways:
  - ingress-example-gateway
  http:
  - match:
    - port: 443
    route:
    - destination:
        host: hbchen.com
        port:
          number: 80
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;curl -I -v -HHost:hbchen.com \
--resolve hbchen.com:$SECURE_INGRESS_PORT:$INGRESS_HOST \
--cacert hbchen.com/2_intermediate/certs/ca-chain.cert.pem \
https://hbchen.com:$SECURE_INGRESS_PORT
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;todo&#34;&gt;TODO&lt;/h2&gt;

&lt;h3 id=&#34;jwt&#34;&gt;JWT&lt;/h3&gt;

&lt;h3 id=&#34;authn&#34;&gt;Authn&lt;/h3&gt;</description>
      
    </item>
    
    <item>
      <title>åˆ†å¸ƒå¼ç³»ç»Ÿé™æµæœåŠ¡-Golang&amp;Redis</title>
      <link>http://hbchen.com/post/distributed/2019-05-05-rate-limit/</link>
      <pubDate>Sun, 05 May 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/distributed/2019-05-05-rate-limit/</guid>
      
        <description>&lt;p&gt;æœ¬æ–‡å‚è€ƒä¸¤ä¸ªä½¿ç”¨Redisåšé™æµçš„é¡¹ç›®ï¼Œåˆ†æåˆ†å¸ƒå¼ç³»ç»Ÿé™æµæœåŠ¡çš„å®ç°ï¼ŒåŒ…æ‹¬å›ºå®šçª—å£ä»¥åŠæ»šåŠ¨çª—å£çš„é™æµã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;å‚è€ƒé¡¹ç›®&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Istioé¡¹ç›®&lt;code&gt;mixer&lt;/code&gt;æ¨¡å—çš„&lt;a href=&#34;https://github.com/istio/istio/tree/master/mixer/adapter/redisquota&#34;&gt;adapter/redisquota&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/go-redis/redis_rate&#34;&gt;go-redis/redis_rate&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;å›ºå®šçª—å£&#34;&gt;å›ºå®šçª—å£&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/distributed/rate-window-fixed.png&#34; alt=&#34;fixed-window&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;go-redis-redis-rate&#34;&gt;go-redis/redis_rate&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;redis_rate&lt;/code&gt;ä½¿ç”¨&lt;strong&gt;çª—å£æ ‡è¯†&lt;/strong&gt;åš&lt;code&gt;key&lt;/code&gt;çš„å­—ç¬¦ä¸²ï¼Œç”¨&lt;code&gt;INCRBY&lt;/code&gt;ç»Ÿè®¡çª—å£å·²ä½¿ç”¨æµé‡&lt;code&gt;n&lt;/code&gt;ï¼Œä¸”&lt;code&gt;key&lt;/code&gt;åœ¨æ­¤çª—å£ç»“æŸåè‡ªåŠ¨è¿‡æœŸã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;çª—å£æ ‡è¯†&lt;/strong&gt;çš„ç”Ÿæˆï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;slot&lt;/code&gt; = &lt;code&gt;utime&lt;/code&gt;(&lt;em&gt;æ—¶é—´æˆ³&lt;code&gt;s&lt;/code&gt;&lt;/em&gt;)â—&lt;code&gt;udur&lt;/code&gt;(&lt;em&gt;çª—å£å¤§å°&lt;code&gt;s&lt;/code&gt;ï¼Œ&lt;code&gt;dur â‰¥ 1s&lt;/code&gt;&lt;/em&gt;)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;key&lt;/code&gt; = &lt;code&gt;name&lt;/code&gt; + &lt;code&gt;slot&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;utime&lt;/code&gt;ä¸ç³»ç»Ÿæ—¶é’Ÿç›¸å…³ï¼Œè€ƒè™‘ä¸€ç§è¾ƒä¸ºæç«¯çš„æƒ…å†µï¼Œçª—å£å¤§å°&lt;code&gt;1s&lt;/code&gt;ï¼Œ&lt;code&gt;A&lt;/code&gt;ã€&lt;code&gt;B&lt;/code&gt;ä¸¤ä¸ªç³»ç»Ÿæ—¶é’Ÿå·®&lt;code&gt;2s&lt;/code&gt;ï¼Œè€Œ&lt;code&gt;key&lt;/code&gt;çš„è¿‡æœŸæ—¶é—´ä¸çª—å£å¤§å°ç›¸åŒ&lt;code&gt;1s&lt;/code&gt;ï¼Œ
å‡è®¾&lt;code&gt;key&lt;/code&gt;åœ¨çª—å£æœ€åæœ‰æ›´æ–°åˆ™&lt;code&gt;key&lt;/code&gt;çš„ç”Ÿå­˜å‘¨æœŸæ˜¯&lt;code&gt;2s&lt;/code&gt;ï¼Œè€Œæ°å¥½æ—¶é’Ÿç›¸å·®&lt;code&gt;2s&lt;/code&gt;ï¼Œè¿™æ ·&lt;code&gt;A&lt;/code&gt;ã€&lt;code&gt;B&lt;/code&gt;ç³»ç»Ÿçš„åˆ†å¸ƒå¼é™æµå°±å˜æˆäº†å•æœºé™æµã€‚&lt;br/&gt;
è™½ç„¶æ¯”è¾ƒæç«¯ï¼Œä½†åœ¨ä½¿ç”¨æ—¶è¿˜æ˜¯éœ€è¦æ³¨æ„ï¼Œæ ¹æ®éœ€è¦å¯ä»¥é€‚å½“åŠ å¤§&lt;code&gt;key&lt;/code&gt;çš„è¿‡æœŸæ—¶é—´ï¼ŒåŒæ—¶å­˜æ´»å¤šä¸ªçª—å£ï¼Œä½¿å­˜æ´»çª—å£èŒƒå›´è¦†ç›–ç³»ç»Ÿé—´çš„æ—¶é’Ÿè¯¯å·®ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func (l *Limiter) AllowN(
	name string, maxn int64, dur time.Duration, n int64,
) (count int64, delay time.Duration, allow bool) {
	udur := int64(dur / time.Second)
	utime := time.Now().Unix()
	slot := utime / udur
	delay = time.Duration((slot+1)*udur-utime) * time.Second

	if l.Fallback != nil {
		allow = l.Fallback.Allow()
	}

	name = allowName(name, slot)
	count, err := l.incr(name, dur, n)
	if err == nil {
		allow = count &amp;lt;= maxn
	}

	return count, delay, allow
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;adapter-redisquota-fixed-window&#34;&gt;adapter/redisquota/fixed_window&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;redisquota&lt;/strong&gt;ä½¿ç”¨&lt;code&gt;lua&lt;/code&gt;è„šæœ¬å®ç°ï¼Œè®¾è®¡ä¸Šä½¿ç”¨ä¸€ä¸ªå¸¦æœ‰&lt;code&gt;token&lt;/code&gt;å’Œ&lt;code&gt;expire&lt;/code&gt;çš„å“ˆå¸Œè¡¨ï¼Œ&lt;code&gt;key&lt;/code&gt;è¿‡æœŸæ—¶é—´ä¸º&lt;code&gt;windowLength&lt;/code&gt;ï¼Œçª—å£åœ¨&lt;code&gt;key&lt;/code&gt;è¿‡æœŸæˆ–&lt;code&gt;timestamp&lt;/code&gt;â‰¥&lt;code&gt;expire&lt;/code&gt;æ—¶é‡ç½®ã€‚
å¦å¤–&lt;code&gt;redisquota&lt;/code&gt;æ ¹æ®åœºæ™¯åšäº†&lt;strong&gt;å¹‚ç­‰&lt;/strong&gt;è®¾è®¡ï¼ŒåŒä¸€&lt;code&gt;deduplicationid&lt;/code&gt;åœ¨çª—å£æœ‰æ•ˆæœŸå†…ä¸ä¼šé‡æ–°åˆ†é…&lt;code&gt;token&lt;/code&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å› ä¸º&lt;code&gt;timestamp&lt;/code&gt;ä¸ç³»ç»Ÿæ—¶é’Ÿç›¸å…³ï¼ŒåŒæ ·å‡è®¾&lt;code&gt;A&lt;/code&gt;ã€&lt;code&gt;B&lt;/code&gt;ä¸¤ä¸ªç³»ç»Ÿæ—¶é’Ÿå·®&lt;code&gt;2s&lt;/code&gt;(&lt;code&gt;A&lt;/code&gt;&amp;gt;&lt;code&gt;B&lt;/code&gt;)ï¼Œçª—å£å¤§å°&lt;code&gt;10s&lt;/code&gt;ï¼Œå¦‚æœçª—å£â‘ ç”±&lt;code&gt;A&lt;/code&gt;ç³»ç»Ÿæ—¶é—´æˆ³è§¦å‘ï¼Œè€Œçª—å£â‘¡ç”±&lt;code&gt;B&lt;/code&gt;ç³»ç»Ÿæ—¶é—´æˆ³è§¦å‘(&lt;code&gt;A&lt;/code&gt;åœ¨å&lt;code&gt;2s&lt;/code&gt;æ²¡æœ‰æµé‡)ï¼Œ
è¿™æ ·â‘ å®é™…çª—å£å¤§å°å°±æ˜¯&lt;code&gt;12s&lt;/code&gt;ï¼Œè¿™æ ·ç»§ç»­åˆ°çª—å£â‘¢ç”±&lt;code&gt;A&lt;/code&gt;ç³»ç»Ÿæ—¶é—´æˆ³è§¦å‘ï¼Œâ‘¡çš„å®é™…çª—å£ä»£é”€å°±æ˜¯&lt;code&gt;8s&lt;/code&gt;ï¼Œæ‰€ä»¥åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹é™æµæ•ˆæœåŒæ ·å—ç³»ç»Ÿæ—¶é’Ÿè¯¯å·®çš„å½±å“ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-lua&#34;&gt;local key_meta = KEYS[1]
-- local key_data = KEYS[2]

local credit = tonumber(ARGV[1])
local windowLength = tonumber(ARGV[2])
-- local bucketLength = tonumber(ARGV[3])
local bestEffort = tonumber(ARGV[4])
local token = tonumber(ARGV[5])
local timestamp = tonumber(ARGV[6])
local deduplicationid = ARGV[7]

-- lookup previous response for the deduplicationid and returns if it is still valid
--------------------------------------------------------------------------------
if (deduplicationid or &#39;&#39;) ~= &#39;&#39; then
    local previous_token = tonumber(redis.call(&amp;quot;HGET&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, &amp;quot;token&amp;quot;))
    local previous_expire = tonumber(redis.call(&amp;quot;HGET&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, &amp;quot;expire&amp;quot;))

    if previous_token and previous_expire then
        if timestamp &amp;lt; previous_expire then
            return {previous_token, previous_expire - timestamp}
        end
    end
end

-- read or initialize meta information
--------------------------------------------------------------------------------
local info_token = tonumber(redis.call(&amp;quot;HGET&amp;quot;, key_meta, &amp;quot;token&amp;quot;))
local info_expire = tonumber(redis.call(&amp;quot;HGET&amp;quot;, key_meta, &amp;quot;expire&amp;quot;))

if (not info_token or not info_expire) or (timestamp &amp;gt;= info_expire) then
    info_token = 0
    info_expire = windowLength + timestamp

    redis.call(&amp;quot;HMSET&amp;quot;, key_meta, &amp;quot;token&amp;quot;, info_token, &amp;quot;expire&amp;quot;, windowLength + timestamp)
    -- set the expiration time for automatic cleanup
    redis.call(&amp;quot;PEXPIRE&amp;quot;, key_meta, windowLength / 1000000)
end

if info_token + token &amp;gt; credit then
    if bestEffort == 1 then
        local exceeded = info_token + token - credit

        if exceeded &amp;lt; token then
            -- return maximum available allocated token
            redis.call(&amp;quot;HMSET&amp;quot;, key_meta, &amp;quot;token&amp;quot;, credit)

            -- save current request and set expiration time for auto cleanup
            if (deduplicationid or &#39;&#39;) ~= &#39;&#39; then
                redis.call(&amp;quot;HMSET&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, &amp;quot;token&amp;quot;, token - exceeded, &amp;quot;expire&amp;quot;, info_expire)
                redis.call(&amp;quot;PEXPIRE&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, math.floor((info_expire - timestamp) / 1000000))
            end

            return {token - exceeded, info_expire - timestamp}
        else
            -- not enough available credit
            return {0, 0}
        end
    else
        -- not enough available credit
        return {0, 0}
    end
else
    -- allocated token
    redis.call(&amp;quot;HMSET&amp;quot;, key_meta, &amp;quot;token&amp;quot;, info_token + token)

    -- save current request and set expiration time for auto cleanup
    if (deduplicationid or &#39;&#39;) ~= &#39;&#39; then
        redis.call(&amp;quot;HMSET&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, &amp;quot;token&amp;quot;, token, &amp;quot;expire&amp;quot;, info_expire)
        redis.call(&amp;quot;PEXPIRE&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, math.floor((info_expire - timestamp) / 1000000))
    end

    return {token, info_expire - timestamp}
end
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;luaè„šæœ¬è·å–æ—¶é—´æˆ³&#34;&gt;Luaè„šæœ¬è·å–æ—¶é—´æˆ³&lt;/h3&gt;

&lt;p&gt;æ—¢ç„¶åœ¨åˆ†å¸ƒå¼ç¯å¢ƒç³»ç»Ÿæ—¶é’Ÿæœ‰å¯èƒ½å­˜åœ¨è¯¯å·®ï¼Œé‚£è‡ªç„¶è€ƒè™‘å°†æ—¶é—´æˆ³è½¬åˆ°Redisä¸­è·å–ï¼Œæ¶ˆé™¤æ—¶é’Ÿè¯¯å·®å¯¹çª—å£çš„å½±å“ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªé™åˆ¶æ¡ä»¶æ˜¯éœ€è¦Luaè„šæœ¬æ”¯æŒ&lt;strong&gt;éšæœºå†™å…¥&lt;/strong&gt;ï¼Œ
æœ‰å…³Redis Luaè„šæœ¬&lt;strong&gt;éšæœºå†™å…¥&lt;/strong&gt;è¯·å‚è€ƒæ­¤æ–‡ã€Š&lt;a href=&#34;https://yq.aliyun.com/articles/195914&#34;&gt;redis4.0ä¹‹Luaè„šæœ¬æ–°å§¿åŠ¿&lt;/a&gt;ã€‹ï¼Œç»“åˆè¿™ä¸ªç‰¹æ€§å¯ä»¥å°†ä¸¤ä¸ªæ–¹æ¡ˆçš„æ—¶é—´æˆ³ç”±å¤–éƒ¨ä¼ å…¥æ”¹ä¸ºåœ¨Luaè„šæœ¬ä¸­è·å–Redisç³»ç»Ÿæ—¶é—´ï¼Œ
æˆ‘åœ¨&lt;a href=&#34;https://github.com/hb-go/pkg/tree/master/rate&#34;&gt;hb-go/pkg/rate&lt;/a&gt;åŒ…åˆ†åˆ«ä½¿ç”¨&lt;code&gt;SET&lt;/code&gt;ã€&lt;code&gt;HSET&lt;/code&gt;åšäº†å®ç°å¯ä»¥å‚è€ƒã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lua&#34;&gt;-- Redis version â‰¥ 3.2
redis.replicate_commands()
local now = redis.call(&#39;TIME&#39;)
timestamp = (tonumber(now[1]) * 1e6 + tonumber(now[2])) * 1e3
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æ»šåŠ¨çª—å£&#34;&gt;æ»šåŠ¨çª—å£&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/distributed/rate-window-rolling.png&#34; alt=&#34;rolling-window&#34; /&gt;&lt;/p&gt;

&lt;p&gt;æ»šåŠ¨çª—å£åœ¨å›ºå®šçª—å£åŸºç¡€ä¸Šï¼Œå°†ä¸€ä¸ª&lt;code&gt;window&lt;/code&gt;æ‹†æˆå¤šä¸ª&lt;code&gt;bucket&lt;/code&gt;ï¼Œè¿™æ ·çª—å£æ ¹æ®&lt;code&gt;bucket&lt;/code&gt;çš„å¤§å°å‘å‰ç§»åŠ¨ã€‚Redisçš„ç»“æ„ä¸ºå“ˆå¸Œè¡¨ï¼š&lt;code&gt;token&lt;/code&gt;ã€&lt;code&gt;bucket.token&lt;/code&gt;ã€&lt;code&gt;bucket.timestamp&lt;/code&gt;å’Œ&lt;code&gt;key&lt;/code&gt;ï¼Œ
ä»¥åŠä¸€ä¸ªå­˜å‚¨&lt;code&gt;bucket&lt;/code&gt;å†å²æ•°æ®çš„æœ‰åºé›†åˆ(&lt;em&gt;ä»¥&lt;code&gt;bucket&lt;/code&gt;çš„æ—¶é—´æˆ³æ’åº&lt;/em&gt;)&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;token&lt;/code&gt;:çª—å£å†…å·²ä½¿ç”¨&lt;code&gt;token&lt;/code&gt;æ•°&lt;/li&gt;
&lt;li&gt;&lt;code&gt;bucket.token&lt;/code&gt;:å½“å‰æ¡¶å†…å·²ä½¿ç”¨&lt;code&gt;token&lt;/code&gt;æ•°&lt;/li&gt;
&lt;li&gt;&lt;code&gt;bucket.timestamp&lt;/code&gt;:å½“å‰æ¡¶çš„æ—¶é—´æˆ³&lt;/li&gt;
&lt;li&gt;&lt;code&gt;key&lt;/code&gt;:ç´¯è®¡&lt;code&gt;bucket&lt;/code&gt;æ•°é‡&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-lua&#34;&gt;local key_meta = KEYS[1]
local key_data = KEYS[2]

local credit = tonumber(ARGV[1])
local windowLength = tonumber(ARGV[2])
local bucketLength = tonumber(ARGV[3])
local bestEffort = tonumber(ARGV[4])
local token = tonumber(ARGV[5])
local timestamp = tonumber(ARGV[6])
local deduplicationid = ARGV[7]

-- lookup previous response for the deduplicationid and returns if it is still valid
--------------------------------------------------------------------------------
if (deduplicationid or &#39;&#39;) ~= &#39;&#39; then
    local previous_token = tonumber(redis.call(&amp;quot;HGET&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, &amp;quot;token&amp;quot;))
    local previous_expire = tonumber(redis.call(&amp;quot;HGET&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, &amp;quot;expire&amp;quot;))

    if previous_token and previous_expire then
        if timestamp &amp;lt; previous_expire then
            return {previous_token, previous_expire - timestamp}
        end
    end
end

-- read meta information
--------------------------------------------------------------------------------
local info_token = tonumber(redis.call(&amp;quot;HGET&amp;quot;, key_meta, &amp;quot;token&amp;quot;))
local info_bucket_token = tonumber(redis.call(&amp;quot;HGET&amp;quot;, key_meta, &amp;quot;bucket.token&amp;quot;))
local info_bucket_timestamp = tonumber(redis.call(&amp;quot;HGET&amp;quot;, key_meta, &amp;quot;bucket.timestamp&amp;quot;))

-- initialize meta
--------------------------------------------------------------------------------
if not info_token or not info_bucket_token or not info_bucket_timestamp then
    info_token = 0
    info_bucket_token = 0
    info_bucket_timestamp = timestamp

    redis.call(&amp;quot;HMSET&amp;quot;, key_meta,
        &amp;quot;token&amp;quot;, info_token,
        &amp;quot;bucket.token&amp;quot;, info_bucket_token,
        &amp;quot;bucket.timestamp&amp;quot;, info_bucket_timestamp,
        &amp;quot;key&amp;quot;, 0)
end


-- move buffer to bucket list if bucket timer is older than bucket window
--------------------------------------------------------------------------------
if (timestamp - info_bucket_timestamp + 1) &amp;gt; bucketLength then
    if tonumber(info_bucket_token) &amp;gt; 0 then
        local nextKey = redis.call(&amp;quot;HINCRBY&amp;quot;, key_meta, &amp;quot;key&amp;quot;, 1)
        local value = tostring(nextKey) .. &amp;quot;.&amp;quot; .. tostring(info_bucket_token)
        redis.call(&amp;quot;ZADD&amp;quot;, key_data, info_bucket_timestamp, value);
    end
    redis.call(&amp;quot;HMSET&amp;quot;, key_meta,
        &amp;quot;bucket.token&amp;quot;, 0,
        &amp;quot;bucket.timestamp&amp;quot;, timestamp)
end

local time_to_expire = timestamp - windowLength

-- reclaim tokens from expired records
--------------------------------------------------------------------------------
local reclaimed = 0
local expired = redis.call(&amp;quot;ZRANGEBYSCORE&amp;quot;, key_data, 0, time_to_expire)

for idx, value in ipairs(expired) do
    reclaimed = reclaimed + tonumber(string.sub(value, string.find(value, &amp;quot;%.&amp;quot;)+1))
end

-- remove expired records
--------------------------------------------------------------------------------
redis.call(&amp;quot;ZREMRANGEBYSCORE&amp;quot;, key_data, 0, time_to_expire)

-- update consumed token
--------------------------------------------------------------------------------
if reclaimed &amp;gt; 0 then
    info_token = info_token - reclaimed;
    if info_token &amp;lt; 0 then
        info_token = 0
    end
    redis.call(&amp;quot;HSET&amp;quot;, key_meta, &amp;quot;token&amp;quot;, info_token)
end

-- update the expiration time for automatic cleanup
--------------------------------------------------------------------------------
redis.call(&amp;quot;PEXPIRE&amp;quot;, key_meta, windowLength / 1000000)
redis.call(&amp;quot;PEXPIRE&amp;quot;, key_meta, windowLength / 1000000)

-- calculate available token
--------------------------------------------------------------------------------
local available_token = credit - info_token

-- check available token and requested token
--------------------------------------------------------------------------------

if available_token &amp;lt;= 0 then
    -- credit exhausted
    return {0, 0}
elseif available_token &amp;gt;= token then
    -- increase token and bucket.token by token
    redis.call(&amp;quot;HINCRBY&amp;quot;, key_meta, &amp;quot;token&amp;quot;, token)
    redis.call(&amp;quot;HINCRBY&amp;quot;, key_meta, &amp;quot;bucket.token&amp;quot;, token)

    -- save current request and set expiration time for auto cleanup
    if (deduplicationid or &#39;&#39;) ~= &#39;&#39; then
        redis.call(&amp;quot;HMSET&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, &amp;quot;token&amp;quot;, token, &amp;quot;expire&amp;quot;, timestamp + windowLength)
        redis.call(&amp;quot;PEXPIRE&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, windowLength / 1000000)
    end

    return {token,  windowLength}
else

    if bestEffort == 0 then
        -- not enough token
        return {0, 0}
    end

    -- allocate available token only
    redis.call(&amp;quot;HINCRBY&amp;quot;, key_meta, &amp;quot;token&amp;quot;, available_token)
    redis.call(&amp;quot;HINCRBY&amp;quot;, key_meta, &amp;quot;bucket.token&amp;quot;, available_token)

    -- save current request and set expiration time for auto cleanup
    if (deduplicationid or &#39;&#39;) ~= &#39;&#39; then
        redis.call(&amp;quot;HMSET&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, &amp;quot;token&amp;quot;, available_token, &amp;quot;expire&amp;quot;, timestamp + windowLength)
        redis.call(&amp;quot;PEXPIRE&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, windowLength / 1000000)
    end

    return {available_token, windowLength}
end
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;é™æµçš„çª—å£ä¸Flinkçš„&lt;a href=&#34;https://ci.apache.org/projects/flink/flink-docs-release-1.8/dev/stream/operators/windows.html#tumbling-windows&#34;&gt;Window&lt;/a&gt;ç±»ä¼¼ï¼Œ
å¯¹äºå›ºå®šçª—å£ç»“åˆä½¿ç”¨åœºæ™¯çš„éœ€æ±‚ï¼Œå¯ä»¥å€Ÿé‰´Flinkçš„&lt;strong&gt;Tumbling Window&lt;/strong&gt;æ¥å£è®¾è®¡æä¾›&lt;code&gt;offset&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Flinkå®è·µã€‘å®æ—¶æ¶ˆè´¹é˜¿é‡Œäº‘SLSæ—¥å¿—&#43;è¾“å‡ºåˆ°ES</title>
      <link>http://hbchen.com/post/flink/2019-04-29-sls&#43;es/</link>
      <pubDate>Mon, 29 Apr 2019 18:42:22 +0800</pubDate>
      
      <guid>http://hbchen.com/post/flink/2019-04-29-sls&#43;es/</guid>
      
        <description>&lt;p&gt;æœ¬æ–‡ä»‹ç»Flinkåœ¨æµè®¡ç®—åœºæ™¯çš„ç®€å•åº”ç”¨ï¼Œå®æ—¶æ¶ˆè´¹SLSå†…çš„AccessLogï¼Œå¹¶å°†è®¡ç®—ç»“æœè¾“å‡ºåˆ°Elasticsearchã€‚&lt;/p&gt;

&lt;h2 id=&#34;ç¯å¢ƒ&#34;&gt;ç¯å¢ƒ&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;Flink

&lt;ul&gt;
&lt;li&gt;1.8&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;ES

&lt;ul&gt;
&lt;li&gt;6.3.2&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;å‡è®¾åœºæ™¯&#34;&gt;å‡è®¾åœºæ™¯&lt;/h2&gt;

&lt;p&gt;&lt;em&gt;æ—¥å¿—ç»“æ„&lt;/em&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;request_time: 1556415329
uri: /analysis/path?id=1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç³»ç»ŸAccessLogé€šè¿‡Logtaié‡‡é›†åˆ°é˜¿é‡Œäº‘SLSï¼ŒæŒ‡å®š&lt;code&gt;request_time&lt;/code&gt;ä¸ºæ—¥å¿—æ—¶é—´å­—æ®µã€‚ç¤ºä¾‹åœºæ™¯éœ€æ±‚ç»Ÿè®¡æŒ‡å®š&lt;code&gt;uri.path&lt;/code&gt;+&lt;code&gt;uri.query.id&lt;/code&gt;åˆ†ç»„ç»Ÿè®¡è®¿é—®è®¡æ•°ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å®æ—¶æ¶ˆè´¹&lt;code&gt;SLS&lt;/code&gt;æ—¥å¿—&lt;/li&gt;
&lt;li&gt;ç­›é€‰&lt;code&gt;uri.path&lt;/code&gt;=&lt;code&gt;/analysis/path&lt;/code&gt;(&lt;em&gt;ç®€åŒ–åªç»Ÿè®¡å•ä¸ª&lt;code&gt;path&lt;/code&gt;ï¼Œå®é™…åœºæ™¯å¯èƒ½æ˜¯å¤šä¸ª&lt;code&gt;path&lt;/code&gt;çš„è®¿é—®ç»Ÿè®¡ï¼Œç›¸åº”çš„&lt;code&gt;key&lt;/code&gt;å‚æ•°è§„åˆ™ä¹Ÿä¼šä¸åŒ&lt;/em&gt;)&lt;/li&gt;
&lt;li&gt;è§£æ&lt;code&gt;uri.query&lt;/code&gt;å‚æ•°&lt;code&gt;id&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;åˆ›å»ºESç´¢å¼•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;PUT sls_analysis

PUT sls_analysis/_mapping/_doc
{
  &amp;quot;properties&amp;quot;: {
    &amp;quot;path&amp;quot;: {
      &amp;quot;type&amp;quot;: &amp;quot;text&amp;quot;
    },
    &amp;quot;key&amp;quot;: {
      &amp;quot;type&amp;quot;: &amp;quot;integer&amp;quot;
    },
    &amp;quot;count&amp;quot;: {
      &amp;quot;type&amp;quot;: &amp;quot;integer&amp;quot;
    },
    &amp;quot;timestamp&amp;quot;: {
      &amp;quot;type&amp;quot;:&amp;quot;long&amp;quot;
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æµç¨‹è§£æ&#34;&gt;æµç¨‹è§£æ&lt;/h2&gt;

&lt;p&gt;æ¥ä¸‹æ¥ç»“åˆ&lt;a href=&#34;https://github.com/hb-chen/flink-practice/tree/master/sls&#34;&gt;hb-chen/flink-practice&lt;/a&gt;æºç å¯¹æµç¨‹è¿›è¡Œè§£æã€‚&lt;/p&gt;

&lt;h3 id=&#34;gradleæ·»åŠ ä¾èµ–&#34;&gt;Gradleæ·»åŠ ä¾èµ–&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;    // ES
    flinkShadowJar &amp;quot;org.apache.flink:flink-connector-elasticsearch6_${scalaBinaryVersion}:${flinkVersion}&amp;quot;

    // SLS
    flinkShadowJar &amp;quot;com.aliyun.openservices:flink-log-connector:0.1.7&amp;quot;
    flinkShadowJar &amp;quot;com.aliyun.openservices:aliyun-log:0.6.19&amp;quot;
    flinkShadowJar &amp;quot;com.aliyun.openservices:log-loghub-producer:0.1.8&amp;quot;
    flinkShadowJar &amp;quot;com.google.protobuf:protobuf-java:2.5.0&amp;quot;
    
    // YAMLè§£æ
    flinkShadowJar &amp;quot;org.yaml:snakeyaml:1.24&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;å‚æ•°-é…ç½®-å¯å¿½ç•¥&#34;&gt;å‚æ•°&amp;amp;é…ç½®ï¼ˆå¯å¿½ç•¥ï¼‰&lt;/h3&gt;

&lt;p&gt;è™½ç„¶åªæ˜¯ç¤ºä¾‹è¿˜æ˜¯åšäº†&lt;code&gt;args&lt;/code&gt;å‚æ•°åŠ&lt;code&gt;config.yml&lt;/code&gt;é…ç½®çš„è·å–ï¼Œæ–¹ä¾¿é…ç½®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;public static void main(String[] args) throws Exception {
    final ParameterTool params = ParameterTool.fromArgs(args);
    String analysisPath = params.getRequired(&amp;quot;path&amp;quot;);
    String analysisQueryKey = params.get(&amp;quot;key&amp;quot;, &amp;quot;id&amp;quot;);
    LOG.info(&amp;quot;access log analysis path:&amp;quot; + analysisPath + &amp;quot; key:&amp;quot; + analysisQueryKey);

    Config config = getConfig();
    
    // â€¦â€¦
}

private static Config getConfig() {
    Constructor constructor = new Constructor(Config.class);
    org.yaml.snakeyaml.Yaml yaml = new org.yaml.snakeyaml.Yaml(constructor);

    Config config = yaml.loadAs(SlsAnalysis.class.getClassLoader().getResourceAsStream(&amp;quot;config.yml&amp;quot;), Config.class);
    return config;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;æ—¥å¿—æ¶ˆè´¹&#34;&gt;æ—¥å¿—æ¶ˆè´¹&lt;/h3&gt;

&lt;p&gt;é¦–å…ˆå‚è€ƒ&lt;a href=&#34;https://help.aliyun.com/document_detail/63594.html&#34;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;é€šè¿‡&lt;code&gt;SLS&lt;/code&gt;çš„å„ç§é…ç½®åˆ›å»ºä¸€ä¸ª&lt;code&gt;Consumer&lt;/code&gt;ï¼Œè·å¾—&lt;code&gt;SLS&lt;/code&gt;æ—¥å¿—æµ&lt;code&gt;DataStream&amp;lt;RawLogGroupList&amp;gt; logStream&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;    // SLSæ¶ˆè´¹
    // https://help.aliyun.com/document_detail/63594.html
    Properties configProps = new Properties();
    // è®¾ç½®è®¿é—®æ—¥å¿—æœåŠ¡çš„åŸŸå
    configProps.put(ConfigConstants.LOG_ENDPOINT, config.getSls().getEndpoint());
    // è®¾ç½®è®¿é—®ak
    configProps.put(ConfigConstants.LOG_ACCESSSKEYID, config.getSls().getAk());
    configProps.put(ConfigConstants.LOG_ACCESSKEY, config.getSls().getSk());
    // è®¾ç½®æ—¥å¿—æœåŠ¡çš„project
    configProps.put(ConfigConstants.LOG_PROJECT, config.getSls().getProject());
    // è®¾ç½®æ—¥å¿—æœåŠ¡çš„Logstore
    configProps.put(ConfigConstants.LOG_LOGSTORE, config.getSls().getLogStore());
    // è®¾ç½®æ¶ˆè´¹æ—¥å¿—æœåŠ¡èµ·å§‹ä½ç½®
    configProps.put(ConfigConstants.LOG_CONSUMER_BEGIN_POSITION, &amp;quot;&amp;quot; + (System.currentTimeMillis() / 1000L));
    // è®¾ç½®æ—¥å¿—æ‹‰å–æ—¶é—´é—´éš”åŠæ¯æ¬¡è°ƒç”¨æ‹‰å–çš„æ—¥å¿—æ•°é‡
    configProps.put(ConfigConstants.LOG_FETCH_DATA_INTERVAL_MILLIS, &amp;quot;1000&amp;quot;);
    configProps.put(ConfigConstants.LOG_MAX_NUMBER_PER_FETCH, &amp;quot;100&amp;quot;);
    // è®¾ç½®Shardså‘ç°å‘¨æœŸ
    configProps.put(ConfigConstants.LOG_SHARDS_DISCOVERY_INTERVAL_MILLIS, Consts.DEFAULT_SHARDS_DISCOVERY_INTERVAL_MILLIS);

    // è®¾ç½®æ—¥å¿—æœåŠ¡çš„æ¶ˆæ¯ååºåˆ—åŒ–æ–¹æ³•
    RawLogGroupListDeserializer deserializer = new RawLogGroupListDeserializer();
    final StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
    DataStream&amp;lt;RawLogGroupList&amp;gt; logStream = env.addSource(new FlinkLogConsumer&amp;lt;RawLogGroupList&amp;gt;(deserializer, configProps));
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é€šè¿‡&lt;code&gt;RawLogGroupList&lt;/code&gt;ç»“æ„çŸ¥é“&lt;code&gt;logStream&lt;/code&gt;è·å¾—çš„æ˜¯æ‰¹é‡çš„&lt;code&gt;SLS&lt;/code&gt;æ—¥å¿—ï¼Œå•æ¡æ—¥å¿—æ˜¯åˆ†ç»„çš„&lt;code&gt;RawLog&lt;/code&gt;åˆ—è¡¨ï¼Œè¿™å°±éœ€è¦é¦–å…ˆå¯¹æ‰¹é‡çš„æ•°æ®è¿›è¡Œå±•å¼€(&lt;code&gt;flatMap()&lt;/code&gt;)æ¥è·å¾—å•æ¡æ•°æ®æµ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;public class RawLogGroupList implements Serializable {
    public List&amp;lt;RawLogGroup&amp;gt; rawLogGroups = new ArrayList();
}

public class RawLogGroup implements Serializable {
    public String source;
    public String topic = &amp;quot;&amp;quot;;
    public Map&amp;lt;String, String&amp;gt; tags = new HashMap();
    public List&amp;lt;RawLog&amp;gt; logs = new ArrayList();
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;æ‰¹é‡æ—¥å¿—å±•å¼€&#34;&gt;æ‰¹é‡æ—¥å¿—å±•å¼€&lt;/h3&gt;

&lt;p&gt;è¿™æ˜¯æ•´ä¸ªè¿‡æµç¨‹æœ€å…³é”®çš„ä¸€ç¯ï¼Œè¿™é‡Œè¦å®šä¹‰å±•å¼€åæ•°æ®æµçš„ç»“æ„ï¼Œä¸å•°å—¦ç›´æ¥çœ‹ç»“æ„&lt;code&gt;Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&lt;/code&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;f0&lt;/code&gt;:&lt;code&gt;AccessLogAnalysis&lt;/code&gt;æ˜¯è§£æ&lt;code&gt;uri&lt;/code&gt;çš„&lt;code&gt;path&lt;/code&gt;+&lt;code&gt;key&lt;/code&gt;çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¦ç”¨åš&lt;code&gt;keyBy&lt;/code&gt;çš„å±æ€§&lt;/li&gt;
&lt;li&gt;&lt;code&gt;f1&lt;/code&gt;:&lt;code&gt;Integer&lt;/code&gt;ç»Ÿè®¡æ•°é‡ï¼Œå•æ¡æ—¥å¿—å…¨è®¡ä¸º1(&lt;em&gt;æ ¹æ®éœ€æ±‚è¿™é‡Œå¯ä»¥è€ƒäº›ä¼˜åŒ–ï¼Œæ¯”å¦‚Groupå†…æœ‰åºå¯ä»¥åœ¨rangeè¿‡ç¨‹ç›´æ¥å¯¹ç›¸åŒ&lt;code&gt;request_time&lt;/code&gt;åšèšåˆ&lt;/em&gt;)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;f2&lt;/code&gt;:&lt;code&gt;Long&lt;/code&gt;æ—¥å¿—æ—¶é—´æˆ³ï¼Œè€ƒè™‘åç»­ä½œä¸º&lt;code&gt;EventTime&lt;/code&gt;ä½¿ç”¨ï¼Œæ‰€ä»¥å°†&lt;code&gt;request_time&lt;/code&gt;è½¬ä¸ºæ¯«ç§’&lt;/li&gt;
&lt;li&gt;&lt;code&gt;f3&lt;/code&gt;:&lt;code&gt;Long&lt;/code&gt;æ‰¹é‡æ—¥å¿—çš„æœ€å°æ—¶é—´æˆ³ï¼Œå› ä¸º&lt;code&gt;SLS&lt;/code&gt;æ—¥å¿—æ˜¯æ—¶é—´æœ‰åºçš„ï¼Œä¸”å•ä¸ª&lt;code&gt;RawLogGroup&lt;/code&gt;æ—¥å¿—å‡åºï¼Œæ‰€ä»¥è‡ªç„¶çš„è€ƒè™‘ä½¿ç”¨æœ€å°æ—¶é—´æˆ³ä½œä¸º&lt;code&gt;watermark&lt;/code&gt;ï¼Œè¿™æ ·ä¹Ÿé¿å…äº†&lt;strong&gt;arrive late&lt;/strong&gt;çš„å‡ºç°&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;    // SLSæ‰¹é‡æ—¥å¿—å±•å¼€
    DataStream&amp;lt;Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&amp;gt; flatStream = logStream.flatMap(new FlatMapFunction&amp;lt;RawLogGroupList, Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&amp;gt;() {
        @Override
        public void flatMap(RawLogGroupList value, Collector&amp;lt;Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&amp;gt; out) throws Exception {
            // Log groupå†…æ—¶é—´å‡åºï¼Œè®°å½•æ‰€æœ‰åˆ†ç»„æœ€å°æ—¶é—´æˆ³ï¼Œå³ä¸ºwatermarkä½ç½®
            long minTimestamp = Long.MAX_VALUE;
            for (RawLogGroup group : value.getRawLogGroups()) {
                if (group.getLogs().size() &amp;gt; 0) {
                    RawLog log = group.getLogs().get(0);
                    long rt = Optional.ofNullable(log.getContents().get(&amp;quot;request_time&amp;quot;)).map(Long::new).orElse(Long.MAX_VALUE);
                    minTimestamp = rt &amp;lt; minTimestamp ? rt : minTimestamp;
                }
            }
            // å–æ¯«ç§’ï¼Œæ’é™¤MAX_VALUE
            minTimestamp = minTimestamp == Long.MAX_VALUE ? minTimestamp : minTimestamp * 1000;

            Integer count = 0;
            for (RawLogGroup group : value.getRawLogGroups()) {
                count += group.getLogs().size();
                for (RawLog log : group.getLogs()) {
                    // URIè§£æ
                    QueryStringDecoder decoder = new QueryStringDecoder(log.getContents().get(&amp;quot;uri&amp;quot;));
                    String path = decoder.path();
                    List&amp;lt;String&amp;gt; keyList = decoder.parameters().get(analysisQueryKey);
                    if (path.equalsIgnoreCase(analysisPath) &amp;amp;&amp;amp; keyList != null &amp;amp;&amp;amp; keyList.size() &amp;gt; 0) {
                        Integer id = Optional.ofNullable(keyList.get(0)).map(Integer::new).orElse(0);
                        AccessLogAnalysis ala = new AccessLogAnalysis();
                        ala.setKey(id);
                        ala.setPath(path);

                        Long timestamp = Optional.ofNullable(log.getContents().get(&amp;quot;request_time&amp;quot;)).map(Long::new).orElse(0L);
                        timestamp *= 1000;

                        out.collect(new Tuple4&amp;lt;&amp;gt;(ala, 1, timestamp, minTimestamp));
                    }

                }
            }
            LOG.info(&amp;quot;raw log count:&amp;quot; + count + &amp;quot; timestamp:&amp;quot; + minTimestamp);
        }
    });
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;eventtime-timewindow&#34;&gt;EventTime &amp;amp; timeWindow&lt;/h3&gt;

&lt;p&gt;æœ‰äº†&lt;code&gt;flatStream&lt;/code&gt;çš„ç»“æœï¼Œè‡ªå®šä¹‰&lt;code&gt;EventTime&lt;/code&gt;ä»¥åŠ&lt;code&gt;Watermark&lt;/code&gt;å°±æ¯”è¾ƒç®€å•ã€‚&lt;br/&gt;&lt;code&gt;.keyBy(0).timeWindow(Time.seconds(60)).sum(1)&lt;/code&gt;æµç¨‹ä»¥&lt;code&gt;f0&lt;/code&gt;ä¸º&lt;code&gt;key&lt;/code&gt;åˆ†éš”ï¼Œ60sä¸ºæ—¶é—´çª—å£å¯¹&lt;code&gt;f1&lt;/code&gt;æ±‚å’Œã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;DataStream result = flatStream.assignTimestampsAndWatermarks(new AssignerWithPunctuatedWatermarks&amp;lt;Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&amp;gt;() {
    @Nullable
    @Override
    public Watermark checkAndGetNextWatermark(Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt; lastElement, long extractedTimestamp) {
        return lastElement.f3 &amp;lt;= extractedTimestamp ? new Watermark(lastElement.f3) : null;
    }

    @Override
    public long extractTimestamp(Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt; element, long previousElementTimestamp) {
        if (element.f2 &amp;gt; 0L) {
            return element.f2;
        } else {
            return previousElementTimestamp;
        }
    }
})
.keyBy(0)
.timeWindow(Time.seconds(60))
.sum(1);
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;è¾“å‡ºåˆ°es&#34;&gt;è¾“å‡ºåˆ°ES&lt;/h3&gt;

&lt;p&gt;å¤§è‡´å‚è€ƒ&lt;a href=&#34;https://ci.apache.org/projects/flink/flink-docs-release-1.8/dev/connectors/elasticsearch.html&#34;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;å³å¯ï¼Œ
åªæ˜¯æ²¡æœ‰è®¤è¯(&lt;em&gt;ç”Ÿäº§ç¯å¢ƒå¿…ä¸å¯å°‘ï¼Œæƒ³åˆ°ESç¤¾åŒºçš„åˆ†äº«ï¼Œåœ¨&lt;a href=&#34;https://www.shodan.io&#34;&gt;shodan.io&lt;/a&gt;ä¸Šæ‰¾å„ç§å…¬å¼€å…è´¹ESèµ„æºğŸ˜&lt;/em&gt;)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;// Sink:Elasticsearch
List&amp;lt;HttpHost&amp;gt; httpHosts = new ArrayList&amp;lt;&amp;gt;();
httpHosts.add(new HttpHost(config.getEs().getHostname(), 9200, &amp;quot;http&amp;quot;));

// use a ElasticsearchSink.Builder to create an ElasticsearchSink
ElasticsearchSink.Builder&amp;lt;Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&amp;gt; esSinkBuilder = new ElasticsearchSink.Builder&amp;lt;&amp;gt;(httpHosts, new ElasticsearchSinkFunction&amp;lt;Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&amp;gt;() {
    public IndexRequest createIndexRequest(Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt; element) {
        Map&amp;lt;String, String&amp;gt; json = new HashMap&amp;lt;&amp;gt;();
        json.put(&amp;quot;path&amp;quot;, element.f0.getPath());
        json.put(&amp;quot;key&amp;quot;, element.f0.getKey().toString());
        json.put(&amp;quot;count&amp;quot;, element.f1.toString());
        json.put(&amp;quot;timestamp&amp;quot;, element.f3.toString());

        return Requests.indexRequest().index(&amp;quot;sls_analysis&amp;quot;).type(&amp;quot;_doc&amp;quot;).source(json);
    }

    @Override
    public void process(Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt; element, RuntimeContext runtimeContext, RequestIndexer requestIndexer) {
        requestIndexer.add(createIndexRequest(element));
    }
});

// configuration for the bulk requests; this instructs the sink to emit after every element, otherwise they would be buffered
esSinkBuilder.setBulkFlushMaxActions(1);

// provide a RestClientFactory for custom configuration on the internally created REST client
String esUsername = config.getEs().getUsername();
String esPassword = config.getEs().getPassword();
esSinkBuilder.setRestClientFactory(restClientBuilder -&amp;gt; {
    // restClientBuilder.setDefaultHeaders(headers);
    // restClientBuilder.setMaxRetryTimeoutMillis(...)
    // restClientBuilder.setPathPrefix(...)
    restClientBuilder.setHttpClientConfigCallback(new RestClientBuilder.HttpClientConfigCallback() {
        @Override
        public HttpAsyncClientBuilder customizeHttpClient(HttpAsyncClientBuilder httpAsyncClientBuilder) {
            CredentialsProvider credentialsProvider = new BasicCredentialsProvider();
            credentialsProvider.setCredentials(AuthScope.ANY, new UsernamePasswordCredentials(esUsername, esPassword));
            return httpAsyncClientBuilder.setDefaultCredentialsProvider(credentialsProvider);
        }
    });
});

// finally, build and add the sink to the job&#39;s pipeline
result.addSink(esSinkBuilder.build());
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡Œè¿˜é‡åˆ°ä¸ªå°å‘ï¼ˆJavaä¸¢çš„å¤ªä¹…äº†ğŸ˜‚ï¼‰ï¼Œåœ¨&lt;code&gt;UsernamePasswordCredentials()&lt;/code&gt;ä¸­ç›´æ¥ä½¿ç”¨&lt;code&gt;config.getEs().getUsername()&lt;/code&gt; &lt;code&gt;config.getEs().getPassword()&lt;/code&gt;ï¼Œå¯¼è‡´åºåˆ—åŒ–é”™è¯¯ï¼Œç›¸å…³å‚è€ƒ&lt;a href=&#34;https://yuzhouwan.com/posts/20644/&#34;&gt;Apache Flink#è¸©è¿‡çš„å‘&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;Exception in thread &amp;quot;main&amp;quot; org.apache.flink.api.common.InvalidProgramException: The implementation of the ElasticsearchSinkBase is not serializable. The object probably contains or references non serializable fields.
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;æµ‹è¯•-æ‰“åŒ…&#34;&gt;æµ‹è¯• &amp;amp; æ‰“åŒ…&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# æµ‹è¯•
$ ./gradlew sls:run --args=&amp;quot;--path /analysis/path&amp;quot;

# æ‰“åŒ…
$ ./gradlew clean sls:shadowJar
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;æäº¤jobåˆ°flinkè¿è¡Œ&#34;&gt;æäº¤Jobåˆ°Flinkè¿è¡Œ&lt;/h3&gt;

&lt;p&gt;ä¸Šä¼ &lt;code&gt;.jar&lt;/code&gt;åˆ°Flink&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;Program Arguments
--path /analysis/path
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/flink/sls+es-dashboard.png&#34; alt=&#34;auth-adapter&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;åˆ°kibanaçœ‹ä¸‹ç»“æœ&#34;&gt;åˆ°Kibanaçœ‹ä¸‹ç»“æœ&lt;/h3&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/flink/sls+es-kibana.png&#34; alt=&#34;auth-adapter&#34; /&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;GET /sls_analysis/_search
{
  &amp;quot;aggs&amp;quot;: {
    &amp;quot;2&amp;quot;: {
      &amp;quot;terms&amp;quot;: {
        &amp;quot;field&amp;quot;: &amp;quot;key&amp;quot;,
        &amp;quot;size&amp;quot;: 20,
        &amp;quot;order&amp;quot;: {
          &amp;quot;1&amp;quot;: &amp;quot;desc&amp;quot;
        }
      },
      &amp;quot;aggs&amp;quot;: {
        &amp;quot;1&amp;quot;: {
          &amp;quot;sum&amp;quot;: {
            &amp;quot;field&amp;quot;: &amp;quot;count&amp;quot;
          }
        }
      }
    }
  },
  &amp;quot;size&amp;quot;: 0,
  &amp;quot;_source&amp;quot;: {
    &amp;quot;excludes&amp;quot;: []
  },
  &amp;quot;stored_fields&amp;quot;: [
    &amp;quot;*&amp;quot;
  ],
  &amp;quot;script_fields&amp;quot;: {},
  &amp;quot;docvalue_fields&amp;quot;: [],
  &amp;quot;query&amp;quot;: {
    &amp;quot;bool&amp;quot;: {
      &amp;quot;must&amp;quot;: [
        {
          &amp;quot;match_all&amp;quot;: {}
        },
        {
          &amp;quot;match_phrase&amp;quot;: {
            &amp;quot;path&amp;quot;: {
              &amp;quot;query&amp;quot;: &amp;quot;/analysis/path&amp;quot;
            }
          }
        }
      ],
      &amp;quot;filter&amp;quot;: [],
      &amp;quot;should&amp;quot;: [],
      &amp;quot;must_not&amp;quot;: []
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;todo&#34;&gt;TODO&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;Checkpoint&lt;/li&gt;
&lt;/ul&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Istioå®‰å…¨ã€‘ç½‘æ ¼è¾¹ç¼˜-Egress</title>
      <link>http://hbchen.com/post/servicemesh/2019-04-11-istio-security-egress/</link>
      <pubDate>Sun, 14 Apr 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/servicemesh/2019-04-11-istio-security-egress/</guid>
      
        <description>&lt;p&gt;æ¥ä¸Šä¸€ç¯‡ã€Š&lt;a href=&#34;http://hbchen.com/post/servicemesh/2019-03-09-istio-rbac-quick-start/&#34;&gt;ã€Istioå®‰å…¨ã€‘æœåŠ¡é—´è®¿é—®æ§åˆ¶-RBAC&lt;/a&gt;ã€‹ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»ç½‘æ ¼è¾¹ç¼˜Egressç›¸å…³çš„é…ç½®ï¼Œ&lt;code&gt;HTTP&lt;/code&gt;ã€&lt;code&gt;HTTPS&lt;/code&gt;ä»¥åŠ&lt;code&gt;HTTP&lt;/code&gt;è½¬&lt;code&gt;TLS&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Istioç‰ˆæœ¬ &lt;strong&gt;1.1.1&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;å¼€å§‹å‰çš„å‡†å¤‡&#34;&gt;å¼€å§‹å‰çš„å‡†å¤‡&lt;/h2&gt;

&lt;blockquote&gt;
&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;  # Set the default behavior of the sidecar for handling outbound traffic from the application:
  # ALLOW_ANY - outbound traffic to unknown destinations will be allowed, in case there are no
  #   services or ServiceEntries for the destination port
  # REGISTRY_ONLY - restrict outbound traffic to services defined in the service registry as well
  #   as those defined through ServiceEntries
  # ALLOW_ANY is the default in 1.1.  This means each pod will be able to make outbound requests 
  # to services outside of the mesh without any ServiceEntry.
  # REGISTRY_ONLY was the default in 1.0.  If this behavior is desired, set the value below to REGISTRY_ONLY.
  outboundTrafficPolicy:
    mode: ALLOW_ANY
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;p&gt;Istioéƒ¨ç½²é…ç½®çš„&lt;code&gt;global.outboundTrafficPolicy&lt;/code&gt;å‚æ•°ï¼Œåœ¨1.1å¼€å§‹é»˜è®¤&lt;code&gt;ALLOW_ANY&lt;/code&gt;ï¼Œè¿™ç§æƒ…å†µä¸‹å¦‚æœä¸é…ç½®&lt;code&gt;ServiceEntry&lt;/code&gt;ï¼Œè®¿é—®å¤–åŒ…HTTPæµé‡è¿”å›&lt;code&gt;404&lt;/code&gt;ï¼Œè€ŒHTTPSæµé‡å¯ä»¥æ­£å¸¸è®¿é—®ï¼Œä¸ºäº†æµ‹è¯•&lt;code&gt;ServiceEntry&lt;/code&gt;é…ç½®æ•ˆæœï¼Œå°†é…ç½®æ”¹ä¸º&lt;code&gt;REGISTRY_ONLY&lt;/code&gt;ï¼Œæ–¹ä¾¿è§‚å¯Ÿ&lt;code&gt;ServiceEntry&lt;/code&gt;é…ç½®çš„æ•ˆæœ&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;æœ¬æ–‡ç¤ºä¾‹Istioä½¿ç”¨helmçš„values-istio-demo.yamlé…ç½®å®‰è£…&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;éƒ¨ç½²æµ‹è¯•ç”¨ä¾‹&lt;code&gt;sleep&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.1/samples/sleep/sleep.yaml

$ export SOURCE_POD=$(kubectl get pod -l app=sleep -o jsonpath={.items..metadata.name})
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;code&gt;outboundTrafficPolicy=ALLOW_ANY&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://hbchen.com
HTTP/1.1 404 Not Found

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://www.aliyun.com
HTTP/1.1 404 Not Found

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - https://www.aliyun.com
HTTP/2 200
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¿®æ”¹&lt;code&gt;values-istio-demo.yaml&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;  outboundTrafficPolicy:
    mode: REGISTRY_ONLY
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é‡æ–°éƒ¨ç½²Istio&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ helm template install/kubernetes/helm/istio --name istio --namespace istio-system --values install/kubernetes/helm/istio/values-istio-demo.yaml | kubectl apply -f -
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é‡æ–°éƒ¨ç½²æµ‹è¯•ç”¨ä¾‹&lt;code&gt;sleep&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl delete -f https://raw.githubusercontent.com/istio/istio/release-1.1/samples/sleep/sleep.yaml
$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.1/samples/sleep/sleep.yaml

$ export SOURCE_POD=$(kubectl get pod -l app=sleep -o jsonpath={.items..metadata.name})
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;sidecaræ–¹å¼&#34;&gt;Sidecaræ–¹å¼&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/istio/egress-sidecar.png&#34; alt=&#34;ServiceEntry&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;http&#34;&gt;HTTP&lt;/h3&gt;

&lt;p&gt;å…ˆå®šä¹‰ä¸€ä¸ª&lt;code&gt;ServiceEntry&lt;/code&gt;ï¼Œå¼€å¯&lt;code&gt;www.aliyun.com&lt;/code&gt;ã€&lt;code&gt;hbchen.com&lt;/code&gt;çš„å¤–éƒ¨è®¿é—®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;$ kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: entry-x
spec:
  hosts:
  - www.aliyun.com
  - hbchen.com
  ports:
  - number: 80
    name: http
    protocol: HTTP
  resolution: NONE
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://hbchen.com
HTTP/1.1 200 OK

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://www.aliyun.com
HTTP/1.1 301 Moved Permanently
...
command terminated with exit code 35

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - https://www.aliyun.com
command terminated with exit code 35
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;http-https&#34;&gt;HTTP &amp;amp; HTTPS&lt;/h3&gt;

&lt;p&gt;åªå¼€&lt;code&gt;80&lt;/code&gt;ç«¯å£ï¼Œ&lt;code&gt;HTTP&lt;/code&gt;æ­£å¸¸ï¼Œè€Œå¯¹äº&lt;code&gt;HTTPS&lt;/code&gt;ä»¥åŠæœ‰&lt;code&gt;HTTP&lt;/code&gt;é‡å®šå‘&lt;code&gt;HTTPS&lt;/code&gt;çš„è¯·æ±‚ä»ä¼šå¤±è´¥&lt;code&gt;command terminated with exit code 35&lt;/code&gt;ï¼Œæ‰€ä»¥å®è·µä¸­å¤–éƒ¨æœåŠ¡ä¸€èˆ¬åŒæ—¶å¼€å¯&lt;code&gt;80&lt;/code&gt;ã€&lt;code&gt;443&lt;/code&gt;ç«¯å£&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;$ kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: entry-x
spec:
  hosts:
  - www.aliyun.com
  - hbchen.com
  ports:
  - number: 80
    name: http-port
    protocol: HTTP
  - number: 443
    name: https-port
    protocol: HTTPS
  resolution: NONE
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://www.aliyun.com
HTTP/1.1 301 Moved Permanently
...
HTTP/2 200

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - https://www.aliyun.com
HTTP/2 200
...
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;httpè½¬tls&#34;&gt;HTTPè½¬TLS&lt;/h3&gt;

&lt;p&gt;è¿™æ—¶æˆ‘ä»¬çœ‹åˆ°å¦ä¸€ä¸ªé—®é¢˜ï¼Œéœ€è¦å‡çº§&lt;code&gt;HTTPS&lt;/code&gt;çš„&lt;code&gt;HTTP&lt;/code&gt;è¯·æ±‚æ¯æ¬¡éƒ½è¦&lt;code&gt;301&lt;/code&gt;é‡å®šå‘ä¸€æ¬¡ï¼Œåœ¨ä¸ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹å¯ä»¥åœ¨&lt;code&gt;proxy&lt;/code&gt;å°†&lt;code&gt;HTTP&lt;/code&gt;è¯·æ±‚å‡çº§ä¸º&lt;code&gt;TLS&lt;/code&gt;ï¼Œé¿å…äºŒæ¬¡è·³è½¬ï¼Œéœ€è¦åŠ &lt;code&gt;VirtualService&lt;/code&gt; + &lt;code&gt;DestinationRule&lt;/code&gt;æ¥å®ç°ã€‚&lt;/p&gt;

&lt;p&gt;åœ¨å®˜æ–¹ç¤ºä¾‹&lt;a href=&#34;https://istio.io/zh/docs/examples/advanced-gateways/egress-tls-origination/#%E5%87%BA%E5%8F%A3%E6%B5%81%E9%87%8F%E7%9A%84-tls&#34;&gt;å‡ºå£æµé‡çš„-tls&lt;/a&gt;ä¸­ï¼Œä»…å°†&lt;code&gt;HTTP&lt;/code&gt;å‡çº§åˆ°&lt;code&gt;TLS&lt;/code&gt;ï¼Œè€Œå¯¹æ­£å¸¸çš„&lt;code&gt;HTTPS&lt;/code&gt;æ²¡æœ‰æ”¯æŒï¼Œè¿™é‡Œç¨ä½œæ”¹åŠ¨ï¼Œåœ¨&lt;code&gt;VirtualService&lt;/code&gt;ä¸­ä¸º&lt;code&gt;80&lt;/code&gt;ç«¯å£çš„&lt;code&gt;destination&lt;/code&gt;å®šä¹‰&lt;code&gt;subset&lt;/code&gt;ï¼Œè¿™æ ·åœ¨&lt;code&gt;DestinationRule&lt;/code&gt;ä¸­é»˜è®¤&lt;code&gt;trafficPolicy&lt;/code&gt;ä¸åšå¤„ç†ï¼Œä»…å¯¹æŒ‡å®šçš„&lt;code&gt;subset&lt;/code&gt;åš&lt;code&gt;HTTPS&lt;/code&gt;è½¬å‘ï¼Œä½¿ç½‘æ ¼å†…æ— è®ºå‘èµ·&lt;code&gt;HTTP&lt;/code&gt;è¿˜æ˜¯&lt;code&gt;HTTPS&lt;/code&gt;çš„å¤–ç½‘è¯·æ±‚éƒ½å¯ä»¥æ­£å¸¸è®¿é—®ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: entry-x
spec:
  hosts:
  - www.aliyun.com
  - hbchen.com
  ports:
  - number: 80
    name: http-port
    protocol: HTTP
  - number: 443
    name: https-port
    protocol: HTTPS
  resolution: DNS
  location: MESH_EXTERNAL
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: rewrite-port-for-entry
spec:
  hosts:
  - www.aliyun.com
  http:
  - match:
      - port: 80
    route:
    - destination:
        # NOTE: ä¸ºHTTPå‡çº§æµé‡æŒ‡å®šsubset
        subset: originate-tls
        host: www.aliyun.com
        port:
          number: 443
  tls:
  - match:
      - port: 443
        sniHosts:
        - www.aliyun.com
    route:
    - destination:
        host: www.aliyun.com
        port:
          number: 443
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: originate-tls-for-entry
spec:
  host: www.aliyun.com
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
  subsets:
    - name: originate-tls
      trafficPolicy:
        loadBalancer:
          simple: ROUND_ROBIN
        portLevelSettings:
        - port:
            number: 443
          tls:
            mode: SIMPLE
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://hbchen.com
HTTP/1.1 200 OK

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://www.aliyun.com
HTTP/1.1 200 OK

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - https://www.aliyun.com
HTTP/2 200
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;gatewayæ–¹å¼&#34;&gt;Gatewayæ–¹å¼&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/istio/egress-gateway.png&#34; alt=&#34;ServiceEntry&#34; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å®˜æ–¹ç¤ºä¾‹&lt;a href=&#34;https://istio.io/zh/docs/examples/advanced-gateways/egress-gateway/&#34;&gt;é…ç½® Egress gateway&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Gatewayä¸Sidecarçš„åŒºåˆ«æ˜¯å°†å‡ºå£æµé‡éƒ½è½¬åˆ°&lt;code&gt;egressgateway&lt;/code&gt;ï¼Œå†ç”±Gatewayè¿›è¡Œè½¬å‘å¤„ç†ï¼Œæ— è®ºGatewayè¿˜æ˜¯Sidecar&lt;code&gt;ServiceEntry&lt;/code&gt;çš„é…ç½®è§„åˆ™éƒ½æ˜¯éœ€è¦çš„ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥å¼€å¯&lt;code&gt;80&lt;/code&gt;ã€&lt;code&gt;433&lt;/code&gt;ï¼Œæ³¨æ„&lt;code&gt;resolution&lt;/code&gt;=&lt;code&gt;DNS&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: entry-x
spec:
  hosts:
  - www.aliyun.com
  ports:
  - number: 80
    name: http-port
    protocol: HTTP
  - number: 443
    name: https-port
    protocol: HTTPS
  resolution: DNS
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;em&gt;è®¿é—®æµ‹è¯•ï¼ˆç•¥ï¼‰&lt;/em&gt;&lt;/p&gt;

&lt;h3 id=&#34;http-1&#34;&gt;HTTP&lt;/h3&gt;

&lt;p&gt;æµç¨‹å¦‚ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-mermaid&#34;&gt;graph LR;
   S[Siedcar]--&amp;gt;|&amp;quot;â‘ HTTP&amp;quot;|VS[VirtualService&amp;lt;br/&amp;gt;www.aliyun.com]
   VS--&amp;gt;|&amp;quot;â‘¡gateway=mesh&amp;quot;|EG[EgressGateway]
   EG--&amp;gt;|&amp;quot;â‘¢HTTP&amp;quot;|VS
   VS--&amp;gt;|&amp;quot;â‘£gateway=istio-egressgateway&amp;quot;|E[External]
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: istio-egressgateway
spec:
  selector:
    istio: egressgateway
  servers:
  - port:
      number: 80
      name: http-port
      protocol: HTTP
    hosts:
    - www.aliyun.com
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: egressgateway-for-aliyun
spec:
  host: istio-egressgateway.istio-system.svc.cluster.local
  subsets:
  - name: aliyun
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: aliyun-through-egress-gateway
spec:
  hosts:
  - www.aliyun.com
  gateways:
  - istio-egressgateway
  - mesh
  http:
  - match:
    - gateways:
      - mesh
      port: 80
    route:
    - destination:
        host: istio-egressgateway.istio-system.svc.cluster.local
        subset: aliyun
        port:
          number: 80
      weight: 100
  - match:
    - gateways:
      - istio-egressgateway
      port: 80
    route:
    - destination:
        host: www.aliyun.com
        port:
          number: 80
      weight: 100
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;(&lt;em&gt;è¿™é‡Œåªæœ‰HTTP&lt;/em&gt;)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://www.aliyun.com
HTTP/1.1 301 Moved Permanently
...
HTTP/2 200
...
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;httpè½¬tls-1&#34;&gt;HTTPè½¬TLS&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-mermaid&#34;&gt;graph LR;
   S[Siedcar]--&amp;gt;|&amp;quot;â‘ HTTP&amp;quot;|VS[VirtualService&amp;lt;br/&amp;gt;www.aliyun.com]
   VS--&amp;gt;|&amp;quot;â‘¡gateway=mesh&amp;quot;|EG[EgressGateway]
   EG--&amp;gt;|&amp;quot;â‘¢HTTP&amp;quot;|VS
   VS--&amp;gt;|&amp;quot;â‘£gateway=istio-egressgateway&amp;lt;br/&amp;gt;DestinationRuleä¸ºSubsetå‡çº§TLS&amp;quot;|E[External]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸Sidecaræ–¹å¼ç±»ä¼¼ï¼Œå¯¹äºæœ‰&lt;code&gt;HTTP&lt;/code&gt;é‡å®šå‘åˆ°&lt;code&gt;HTTPS&lt;/code&gt;çš„æµé‡å¯ä»¥åœ¨Gatewayä»£ç†ç›´æ¥å‡çº§ä¸º&lt;code&gt;TLS&lt;/code&gt;ï¼Œå‡å°‘è·³è½¬ï¼Œå®ç°æ–¹å¼ä¸Sidecaræ–¹å¼ç±»ä¼¼ï¼Œä¸º&lt;code&gt;HOST&lt;/code&gt;å¢åŠ &lt;code&gt;DestinationRule&lt;/code&gt;è§„åˆ™ä¸º&lt;code&gt;HTTP&lt;/code&gt;æµé‡å‘èµ·&lt;code&gt;TLS&lt;/code&gt;è¯·æ±‚ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: istio-egressgateway
spec:
  selector:
    istio: egressgateway
  servers:
  - port:
      number: 80
      name: http-port
      protocol: HTTP
    hosts:
    - www.aliyun.com
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: egressgateway-for-aliyun
spec:
  host: istio-egressgateway.istio-system.svc.cluster.local
  subsets:
  - name: aliyun
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: aliyun-through-egress-gateway
spec:
  hosts:
  - www.aliyun.com
  gateways:
  - istio-egressgateway
  - mesh
  http:
  - match:
    - gateways:
      - mesh
      port: 80
    route:
    - destination:
        host: istio-egressgateway.istio-system.svc.cluster.local
        subset: aliyun
        port:
          number: 80
      weight: 100
  - match:
    - gateways:
      - istio-egressgateway
      port: 80
    route:
    - destination:
        host: www.aliyun.com
        # NOTE: ä¸ºHTTPå‡çº§æµé‡æŒ‡å®šsubset
        subset: originate-tls
        port:
          number: 443
      weight: 100
---
# NOTE: æ³¨æ„è¿™é‡Œä¸Sidecaræ–¹å¼ç±»ä¼¼ï¼Œéœ€è¦å¯¹HTTPæµé‡å•ç‹¬é…ç½®subsetï¼Œå¦åˆ™å½±å“æ­£å¸¸HTTPSæµé‡
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: originate-tls-for-aliyun
spec:
  host: www.aliyun.com
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
  subsets:
    - name: originate-tls
      trafficPolicy:
        loadBalancer:
          simple: ROUND_ROBIN
        portLevelSettings:
        - port:
            number: 443
          tls:
            mode: SIMPLE
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://www.aliyun.com
HTTP/1.1 200 OK
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;åŒå‘&lt;code&gt;TLS&lt;/code&gt;ã€&lt;code&gt;HTTTPS&lt;/code&gt;é€ä¼ ç­‰è¿™é‡Œæ²¡æœ‰å†åšæµ‹è¯•ï¼Œæœ‰å…´è¶£å¯ä»¥å‚è€ƒå®˜æ–¹ç¤ºä¾‹&lt;a href=&#34;https://istio.io/zh/docs/examples/advanced-gateways/egress-gateway/&#34;&gt;é…ç½® Egress gateway&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;ç›´æ¥è°ƒç”¨å¤–éƒ¨æœåŠ¡&#34;&gt;ç›´æ¥è°ƒç”¨å¤–éƒ¨æœåŠ¡&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/istio/egress-sidecar-ip.png&#34; alt=&#34;ServiceEntry&#34; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Istioæ–‡æ¡£&lt;a href=&#34;https://istio.io/zh/docs/tasks/traffic-management/egress/#%E7%9B%B4%E6%8E%A5%E8%B0%83%E7%94%A8%E5%A4%96%E9%83%A8%E6%9C%8D%E5%8A%A1&#34;&gt;ç›´æ¥è°ƒç”¨å¤–éƒ¨æœåŠ¡&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;éœ€è¦ä¿®æ”¹helmçš„valuesé…ç½®æ›´æ–°éƒ¨ç½²ã€‚å¹¶ä¸”è¦è®©æ–°çš„&lt;code&gt;istio-sidecar-injector&lt;/code&gt;ç”Ÿæ•ˆï¼Œé‡æ–°éƒ¨ç½²&lt;code&gt;sleep&lt;/code&gt;ç”¨ä¾‹ã€‚è¿™ç§æ–¹å¼åœ¨Sidecarçš„Proxyä¸­è·³è¿‡äº†å¤–éƒ¨IPï¼Œè™½ç„¶ä¹Ÿæœ‰&lt;code&gt;excludeIPRanges&lt;/code&gt;æ–¹å¼ï¼Œä½†ä¿®æ”¹éº»çƒ¦éœ€è¦æ›´æ–°sidecarï¼Œå¹¶ä¸”è¿™æ ·ä¹Ÿå¤±å»äº†Istioçš„å…¶å®ƒèƒ½åŠ›ï¼Œæ‰€ä»¥ä¸æ€ä¹ˆå®ç”¨ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;  proxy:
    # Minikube
    includeIPRanges: &amp;quot;10.0.0.1/24&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;ServiceEntry&lt;/code&gt;é…åˆ&lt;code&gt;VirtualService&lt;/code&gt;ã€&lt;code&gt;DestinationRule&lt;/code&gt;å¯ä»¥ä½¿å¤–éƒ¨æµé‡åšæ¯”è¾ƒçµæ´»çš„ç®¡æ§ï¼Œå¹¶ä¸”å¯ä»¥å¯¹å¤–éƒ¨æœåŠ¡ä½¿ç”¨æµé‡ç®¡ç†çš„ç›¸å…³åŠŸèƒ½ï¼ŒGatewayç›¸å¯¹Sidecaré…ç½®è¿˜æ˜¯ç•¥æ˜¾å¤æ‚ï¼Œè€Œåœ¨æ€§èƒ½æ–¹é¢å®˜æ–¹Blog&lt;a href=&#34;https://istio.io/zh/blog/2019/egress-performance/&#34;&gt;Egress gateway æ€§èƒ½æµ‹è¯•&lt;/a&gt;ç»™å‡ºçš„æ¯”è¾ƒç»“æœä¸¤è€…ç›¸å·®ä¸å¤§ï¼Œè‡³äºç›´æ¥è°ƒç”¨æ–¹å¼ç›¸å¯¹å°±ä¸æ€ä¹ˆå®ç”¨äº†ã€‚&lt;/p&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Istioæºç ã€‘Pilot Agent</title>
      <link>http://hbchen.com/post/servicemesh/2019-03-31-istio-code-pilot-agent/</link>
      <pubDate>Sun, 07 Apr 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/servicemesh/2019-03-31-istio-code-pilot-agent/</guid>
      
        <description>&lt;p&gt;æ¥ä¸Šä¸€ç¯‡&lt;a href=&#34;http://hbchen.com/post/servicemesh/2019-03-17-istio-code-pilot-discovery/&#34;&gt;ã€Šã€Istioæºç ã€‘Pilot Discoveryã€‹&lt;/a&gt;ï¼Œè¿™ç¯‡ç»§ç»­åˆ†æ&lt;strong&gt;Pilot&lt;/strong&gt;çš„&lt;code&gt;pilot-agent&lt;/code&gt;æ¨¡å—ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;pilot-agent&lt;/code&gt;ç›¸å¯¹&lt;code&gt;pilot-discovery&lt;/code&gt;åœ¨æ§åˆ¶å¹³é¢æ¯”è¾ƒç®€å•ï¼Œ&lt;strong&gt;agent&lt;/strong&gt;æ›´å¤šçš„èƒ½åŠ›æ˜¯åœ¨æ•°æ®å¹³é¢çš„&lt;code&gt;envoy&lt;/code&gt;ï¼Œ&lt;code&gt;envoy&lt;/code&gt;é€šè¿‡&lt;code&gt;xDS&lt;/code&gt;åè®®ä¸&lt;code&gt;pilot-discovery&lt;/code&gt;æœåŠ¡è¿›è¡Œé€šä¿¡ã€‚agentä¸»è¦è´Ÿè´£ç›‘æ§&lt;code&gt;ingress&lt;/code&gt;ã€&lt;code&gt;mTLS&lt;/code&gt;çš„è¯ä¹¦ï¼Œå‘ç”Ÿå˜æ›´åé‡å¯&lt;code&gt;envoy&lt;/code&gt;ï¼Œä»¥åŠæä¾›&lt;strong&gt;agent&lt;/strong&gt;çŠ¶æ€çš„HTTPæœåŠ¡(&lt;em&gt;å¯é€‰æœåŠ¡&lt;/em&gt;)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-mermaid&#34;&gt;sequenceDiagram
    participant a as agent
    participant pa as proxy/agent
    participant ew as envoy/watcher
    participant ep as envoy/proxy
    participant s as status
    participant fw as fsnotify.Watcher 
    
    Note over a,fw: agentçŠ¶æ€æœåŠ¡
    a -&amp;gt;&amp;gt; s: NewServer()
    s --&amp;gt;&amp;gt; a: statusServer *Server
    a -&amp;gt;&amp;gt; s: statusServer.Run()

    a -&amp;gt;&amp;gt; ep: NewProxy(proxyConfig)
    ep --&amp;gt;&amp;gt; a: envoyProxy proxy.Proxy
    a -&amp;gt;&amp;gt; pa: NewAgent(envoyProxy)
    pa --&amp;gt; a: agent Agent
    a -&amp;gt;&amp;gt; ew: NewWatcher(agent.ConfigCh)ï¼Œupdates = agent.ConfigCh
    ew --&amp;gt;&amp;gt; a: watcher Watcher
    
    Note over a,fw: watcherç›‘æ§é…ç½®å˜æ›´ï¼Œé€šçŸ¥agenté‡å¯envoy
    loop: go
        a -&amp;gt;&amp;gt; ew: watcher.Run()
        ew -&amp;gt;&amp;gt; fw: fw.Watch(certs)ï¼ŒAuthCertsPathã€IngressCertsPath
        fw --&amp;gt;&amp;gt; ew: w.watchFileEvents()
        ew -&amp;gt;&amp;gt; ew: &amp;lt;-timeChanï¼Œ10så»¶è¿Ÿ
        ew -&amp;gt;&amp;gt; ew: SendConfig()
        ew -&amp;gt;&amp;gt; pa: updates&amp;lt;-
        Note over pa: &amp;lt;-configCh
    end    
    
    Note over a,fw: agentåšenvoyé‡å¯æ“ä½œï¼ŒåŒ…æ‹¬é¢‘ç‡æ§åˆ¶ã€å¤±è´¥é‡è¯•ç­‰
    loop : go
        a -&amp;gt;&amp;gt; pa: agent.Run()
        Note over pa: rateLimiter.Wait()&amp;lt;br/&amp;gt;æ§åˆ¶é¢‘ç‡
        alt &amp;lt;-configCh
            Note over pa: é…ç½®æ›´æ–°Envoyçƒ­é‡å¯&amp;lt;br/&amp;gt;reconcile()
        else &amp;lt;-statusCh  
            Note over pa: Envoyé‡å¯åé€šçŸ¥å¤„ç†&amp;lt;br/&amp;gt;å¤±è´¥é‡è¯•é€»è¾‘
        else &amp;lt;-reconcileTimer.C
            Note over pa: å¤±è´¥é‡è¯•è®¡æ—¶é‡å¯&amp;lt;br/&amp;gt;reconcile()
        end
    end
    
    loop: envoyé‡å¯
        pa -&amp;gt;&amp;gt; pa: reconcile()
        Note over ep: é»˜è®¤æœåŠ¡å‘ç°åœ°å€:&amp;lt;br/&amp;gt;istio-pilot:15010&amp;lt;br/&amp;gt;å¯¹åº”pilot-discoveryçš„åœ°å€:&amp;lt;br/&amp;gt;gRPC port:15010
        pa -&amp;gt;&amp;gt; ep: proxy.Run(&amp;lt;-abort)
        ep --&amp;gt;&amp;gt; pa: err error
        pa -&amp;gt;&amp;gt; pa: statusCh&amp;lt;-
    end
    
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Istioæºç ã€‘Pilot Discovery</title>
      <link>http://hbchen.com/post/servicemesh/2019-03-17-istio-code-pilot-discovery/</link>
      <pubDate>Sat, 30 Mar 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/servicemesh/2019-03-17-istio-code-pilot-discovery/</guid>
      
        <description>&lt;p&gt;æµé‡ç®¡ç†æ˜¯ç½‘æ ¼çš„åŸºç¡€ï¼ŒPilotè´Ÿè´£ä¸‰ä¸ªä¸»è¦åŠŸèƒ½ï¼šæœåŠ¡æ²»ç†&lt;code&gt;istio-pilot&lt;/code&gt;ã€Sidecaræ³¨å…¥&lt;code&gt;istio-sidecar-injector&lt;/code&gt;ã€ä»¥åŠSidecar&lt;code&gt;istio-proxy&lt;/code&gt;ï¼Œ
åˆ†åˆ«ç”±ä¸‰ä¸ªæ¨¡å—è´Ÿè´£ï¼š&lt;code&gt;pilot-discovery&lt;/code&gt;ã€&lt;code&gt;sidecar-injector&lt;/code&gt;ã€&lt;code&gt;pilot-agent&lt;/code&gt;ï¼Œè¿™é‡Œä»&lt;code&gt;pilot-discovery&lt;/code&gt;å¼€å§‹ã€‚&lt;/p&gt;

&lt;h2 id=&#34;discoveryè¿è¡Œåºåˆ—&#34;&gt;Discoveryè¿è¡Œåºåˆ—&lt;/h2&gt;

&lt;h3 id=&#34;kubeç¯å¢ƒç®€åŒ–åºåˆ—&#34;&gt;kubeç¯å¢ƒç®€åŒ–åºåˆ—&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-mermaid&#34;&gt;sequenceDiagram
    participant s as server
    participant f as fileWatcher
    participant i as k8s.io/client-go&amp;lt;br/&amp;gt;informer
    participant h as handler
    
    Note over s: mesh
    s -&amp;gt;&amp;gt; f: addFieWatcher()
    Note over s: meshNetworks
    s -&amp;gt;&amp;gt; f: addFileWatcher()
    Note over s: config
        loop IstioConfigTypes
        s -&amp;gt;&amp;gt; i: cache.NewSharedIndexInformer()
        end
    Note over s: service
        activate i
        s -&amp;gt;&amp;gt; i: Services().Informer()
        s -&amp;gt;&amp;gt; i: Endpoints().Informer()
        s -&amp;gt;&amp;gt; i: Nodes().Informer()
        s -&amp;gt;&amp;gt; i: Pods().Informer()
        deactivate i
    Note over s: discovery
        activate h
        s -&amp;gt;&amp;gt; h: service.AppendServiceHandler()
        s -&amp;gt;&amp;gt; h: service.AppendInstanceHandler()
        s -&amp;gt;&amp;gt; h: config.RegisterEventHandler()
        deactivate h
    alt fsnotify
        f -&amp;gt;&amp;gt; s: fsnotify.Event()
        s -&amp;gt;&amp;gt; s: ds.ConfigUpdate()
    end
        
    alt K8S
        i -&amp;gt;&amp;gt; h: handler.Apply()
        loop handler.funcs
            h -&amp;gt;&amp;gt; s: Event Handler
            s -&amp;gt;&amp;gt; s: ds.ConfigUpdate()
        end
    end
    activate s
    s -&amp;gt;&amp;gt; s: pushChannel &amp;lt;- XdsEvent
    s -&amp;gt;&amp;gt; s: ds.StreamAggregatedResources()Pushåˆ°xDS
    deactivate s

&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;è¯¦ç»†åºåˆ—&#34;&gt;è¯¦ç»†åºåˆ—&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-mermaid&#34;&gt;sequenceDiagram
    participant b as bootstrap
    participant kc as k8s.io/client-go
    participant cmd as cmd
    participant c as config/&amp;lt;br/&amp;gt;aggregate&amp;lt;br/&amp;gt;kube&amp;lt;br/&amp;gt;â€¦â€¦
    
    participant k as kube
    participant m as model
    participant pe as proxy/envoy
    participant sr as serviceregistry
    
    
    b -&amp;gt;&amp;gt; b: NewServer()
    Note left of b: initKubeClient()
    b -&amp;gt;&amp;gt; k: kube.CreateClientset()
    k --&amp;gt;&amp;gt; b: kubeClient *kubernetes.Clientset
    
    Note left of b: ç½‘æ ¼é…ç½®&amp;lt;br/&amp;gt;initMesh()
        Note over kc,cmd: é»˜è®¤ConfigFile&amp;lt;br/&amp;gt;/etc/istio/config/mesh
        alt args.Mesh.ConfigFile != &amp;quot;&amp;quot;
        b -&amp;gt;&amp;gt; cmd: cmd.ReadMeshConfig(args.Mesh.ConfigFile)
        cmd --&amp;gt;&amp;gt; b: mesh *meshconfig.MeshConfig
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&amp;lt;br/&amp;gt;ï¸addFileWatcher(args.Mesh.ConfigFile)&amp;lt;br/&amp;gt;mesh reload&amp;lt;br/&amp;gt;âœ…s.EnvoyXdsServer.ConfigUpdate()
        else K8s ConfigMap è·å–é…ç½®
        b -&amp;gt;&amp;gt; b: GetMeshConfig(s.kubeClient, kube.IstioNamespace, kube.IstioConfigMap)
        b -&amp;gt;&amp;gt; m: model.DefaultMeshConfig()/model.ApplyMeshConfigDefaults(cfgYaml)
        m --&amp;gt;&amp;gt; b: mesh meshconfig.MeshConfig
        end
    
    Note left of b: Meshç½‘ç»œé…ç½®&amp;lt;br/&amp;gt;initMeshNetworks()
        Note over kc,cmd: é»˜è®¤NetworksConfigFile&amp;lt;br/&amp;gt;/etc/istio/config/meshNetworks
        alt args.NetworksConfigFile != &amp;quot;&amp;quot;
        b -&amp;gt;&amp;gt; cmd: cmd.ReadMeshNetworksConfig()
        cmd --&amp;gt;&amp;gt; b: meshNetworks *meshconfig.MeshNetworks
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&amp;lt;br/&amp;gt;addFileWatcher(args.NetworksConfigFile)&amp;lt;br/&amp;gt;meshNetworks reload&amp;lt;br/&amp;gt;âœ…s.EnvoyXdsServer.ConfigUpdate()
        end
    
    Note left of b: Mixer&amp;lt;br/&amp;gt;initMixerSan()
        alt s.mesh.DefaultConfig.ControlPlaneAuthPolicy == meshconfig.AuthenticationPolicy_MUTUAL_TLS
        b -&amp;gt;&amp;gt; pe: envoy.GetMixerSAN(args.Namespace)
        pe -&amp;gt;&amp;gt; b: SpiffeURI string
        Note over kc,cmd: s.mixerSAN[SpiffeURI]&amp;lt;br/&amp;gt;NewDiscoveryServiceçš„Env
        end
    
    Note left of b: é…ç½®ç®¡ç†&amp;lt;br/&amp;gt;initConfigController()
        alt len(args.MCPServerAddrs) &amp;gt; 0 || len(s.mesh.ConfigSources) &amp;gt; 0
        Note over kc,cmd: s.initMCPConfigController()
            Note over kc,cmd: var clients []*client.Client&amp;lt;br/&amp;gt;var clients2 []*sink.Client&amp;lt;br/&amp;gt;var conns []*grpc.ClientConn&amp;lt;br/&amp;gt;var configStores []model.ConfigStoreCache
            loop s.mesh.ConfigSources
                alt url.Scheme == fsScheme
                b -&amp;gt;&amp;gt; c: memory.NewController(store)
                c --&amp;gt;&amp;gt; b: configController model.ConfigStoreCache
                Note over kc,cmd: configStores = append(configStores, configController)
                else
                b -&amp;gt;&amp;gt; c: coredatamodel.NewController()
                c --&amp;gt;&amp;gt; b: mcpController CoreDataModel
                Note over kc,cmd: clients = append(clients, mcpClient)&amp;lt;br/&amp;gt;clients2 = append(clients2, mcpClient2)&amp;lt;br/&amp;gt;mcpControlleræ˜¯MCP Clientçš„Updater&amp;lt;br/&amp;gt;å½“Clientç«¯æ”¶åˆ°Responseæ—¶&amp;lt;br/&amp;gt;é€šè¿‡Updater.Apply()æ¥å£é€šçŸ¥æ›´æ–°
                Note over kc,cmd: conns = append(conns, conn)&amp;lt;br/&amp;gt;configStores = append(configStores, mcpController)
                end
            end
            
            alt len(configStores) == 0
            Note over kc,cmd: ConfigSourcesæœªåŠ è½½é…ç½®&amp;lt;br/&amp;gt;ä»MCPServerAddrsåŠ è½½
            loop args.MCPServerAddrs
            b -&amp;gt;&amp;gt; c: coredatamodel.NewController()
            c --&amp;gt;&amp;gt; b: mcpController CoreDataModel
            Note over kc,cmd: conns = append(conns, conn)&amp;lt;br/&amp;gt;configStores = append(configStores, mcpController)
            end
            end
            
            
            Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&amp;lt;br/&amp;gt;s.addStartFunc(go func() {client.Run(ctx)}())&amp;lt;br/&amp;gt;MCP Clientså¯åŠ¨&amp;lt;br/&amp;gt;æ¥æ”¶åˆ°Responseé€šçŸ¥mcpController&amp;lt;br/&amp;gt;Apply(*Change)&amp;lt;br/&amp;gt;model.ServiceEntry.Typeçš„ä¿®æ”¹é€šçŸ¥åˆ°serviceEntryEvents()&amp;lt;br/&amp;gt;â—åœ¨external.NewServiceDiscovery()æœ‰model.ServiceEntry.Typeçš„handler
            Note over kc,cmd: é…ç½®æ±‡æ€»
            b -&amp;gt;&amp;gt; c: configaggregate.MakeCache(configStores)
            c --&amp;gt;&amp;gt; b: aggregateMcpController model.ConfigStoreCache
            
        else args.Config.Controller != nil
        Note over kc,cmd: s.configController = args.Config.Controller
        else args.Config.FileDir != &amp;quot;&amp;quot;
        Note over kc,cmd: configController := memory.NewController(store)
        else é»˜è®¤KubeConfig
        Note over kc,cmd: controller, err := s.makeKubeConfigController(args)
        end
        
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&amp;lt;br/&amp;gt;s.addStartFunc ( go s.configController.Run(stop) )&amp;lt;br/&amp;gt;é…ç½®Controllerå¯åŠ¨&amp;lt;br/&amp;gt;å¤„ç†é…ç½®å˜æ›´çš„EventHandler&amp;lt;br/&amp;gt;memoryã€kube.crdçš„Controlleræœ‰Run()å®ç°
        Note over kc,cmd: memoryé€šè¿‡makeFileMonitor()ç›‘æ§æ–‡ä»¶&amp;lt;br/&amp;gt;æ¥æ”¶èµ„æºå˜æ›´æ—¶æ›´æ–°configStore&amp;lt;br/&amp;gt;å¹¶é€šè¿‡monitor.ScheduleProcessEvent()åˆ†å‘äº‹ä»¶&amp;lt;br/&amp;gt;â—RegisterEventHandlerå°†handler Appendåˆ°monitorçš„handlers
        Note over kc,cmd: kube.crd.cacheHandlerè¿è¡Œinformer&amp;lt;br/&amp;gt;informerç›‘æ§ä¸åŒConfigType&amp;lt;br/&amp;gt;informerå°†èµ„æºAddã€Updateã€Deleteäº‹ä»¶ç»Ÿä¸€å‹å…¥Queue&amp;lt;br/&amp;gt;Queue Run()é€ä¸ªäº‹ä»¶å¤„ç†ï¼Œå³cacheHandlerçš„hander.funcs&amp;lt;br/&amp;gt;â—RegisterEventHandlerå°†handler Appendåˆ°hander.funcs
        Note over b,c: ğŸ’šğŸ’šğŸ’šğŸ’šğŸ’š&amp;lt;br/&amp;gt;RegisterEventHandler()&amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;â—åœ¨Discoveryå’ŒServiceRegistryæœ‰handleræ³¨å†Œ
        
        alt hasKubeRegistry(args) &amp;amp;&amp;amp; s.mesh.IngressControllerMode != meshconfig.MeshConfig_OFF
        Note over kc,cmd: K8s ingressçš„ConfigController
        b -&amp;gt;&amp;gt; c: ingress.NewController()
        c --&amp;gt;&amp;gt; b: ingress model.ConfigStoreCache
        b -&amp;gt;&amp;gt; c: configaggregate.MakeCache(s.configController, ingress)
        c --&amp;gt;&amp;gt; b: configController model.ConfigStoreCache
        b -&amp;gt;&amp;gt; c: ingress.NewStatusSyncer()
        c --&amp;gt;&amp;gt; b: ingressSyncer *StatusSyncer
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&amp;lt;br/&amp;gt;s.addStartFunc ( go ingressSyncer.Run(stop) )&amp;lt;br/&amp;gt;Ingress Syncerå¯åŠ¨
        end
        b -&amp;gt;&amp;gt; m: model.MakeIstioStore(s.configController)
        m --&amp;gt;&amp;gt; b: istioConfigStore IstioConfigStore
        Note over b,c: ğŸ’šğŸ’šğŸ’šğŸ’šğŸ’š&amp;lt;br/&amp;gt;istioConfigStoreæä¾›Istioé…ç½®è·å–&amp;lt;br/&amp;gt;ä¸»è¦ä¸ºConfigStoreçš„List()æ¥å£
    
    Note left of b: æœåŠ¡æ³¨å†Œ&amp;lt;br/&amp;gt;initServiceControllers()
        b -&amp;gt;&amp;gt; sr: aggregate.NewController()
        sr --&amp;gt;&amp;gt; b: serviceControllers *Controller
        loop args.Service.Registries
        Note over b,c: ğŸ’šğŸ’šğŸ’šğŸ’šğŸ’š&amp;lt;br/&amp;gt;å¤šæ³¨å†Œä¸­å¿ƒ&amp;lt;br/&amp;gt;Controlleré€šè¿‡AppendServiceHandler()ã€AppendInstanceHandler()æ¥æ”¶å¤–éƒ¨Handler&amp;lt;br/&amp;gt;åœ¨æœ‰å˜æ›´æ—¶è½®è¯¢Handler&amp;lt;br/&amp;gt;â—Discoveryä¼šAppendHandler
        alt serviceregistry.MockRegistry
        b -&amp;gt;&amp;gt; b: s.initMemoryRegistry()
        b -&amp;gt;&amp;gt; sr: srmemory.NewDiscovery() aggregate.Registry{}
        b --&amp;gt;&amp;gt; b: serviceControllers.AddRegistry()
        else serviceregistry.KubernetesRegistry
        b -&amp;gt;&amp;gt; b: s.createK8sServiceControllers()
        b -&amp;gt;&amp;gt; sr: kube.NewController()
        b --&amp;gt;&amp;gt; b: serviceControllers.AddRegistry()
        else serviceregistry.ConsulRegistry
        b -&amp;gt;&amp;gt; b: s.initConsulRegistry()
        b -&amp;gt;&amp;gt; sr: consul.NewController()
        b --&amp;gt;&amp;gt; b: serviceControllers.AddRegistry()
        else serviceregistry.MCPRegistry
        Note over kc,cmd: no-op: get service info from MCP ServiceEntries.
        end
        end
        b -&amp;gt;&amp;gt; sr: external.NewServiceDiscovery()
        sr --&amp;gt;&amp;gt; b: serviceEntryStore *ServiceEntryStore
        b --&amp;gt;&amp;gt; b: serviceControllers.AddRegistry()
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&amp;lt;br/&amp;gt;s.addStartFunc()&amp;lt;br/&amp;gt;æœåŠ¡æ³¨å†ŒControllerså¯åŠ¨
    
    Note left of b: æœåŠ¡å‘ç°&amp;lt;br/&amp;gt;initDiscoveryService()&amp;lt;br/&amp;gt;gRPCå’ŒHTTPæœåŠ¡
        b -&amp;gt;&amp;gt; pe: envoy.NewDiscoveryService()
        Note over b,c: ğŸ’šğŸ’šğŸ’šğŸ’šğŸ’šds.clearCache()å°è£…ä¸ºHandler&amp;lt;br/&amp;gt;æ¥æ”¶s.ServiceControllerã€s.configControllerçš„å˜æ›´é€šçŸ¥&amp;lt;br/&amp;gt;âœ…s.ServiceController.AppendServiceHandler()&amp;lt;br/&amp;gt;âœ…s.ServiceController.AppendInstanceHandler()&amp;lt;br/&amp;gt;âœ…s.configController.RegisterEventHandler()
        pe --&amp;gt;&amp;gt; b: discovery *DiscoveryService
        Note over kc,cmd: HTTP&amp;lt;br/&amp;gt;envoy.DiscoveryServiceæä¾›/v1/registrationä»¥åŠ/debug/pprof/* RESTæ¥å£
        b --&amp;gt; b: s.mux = discovery.RestContainer.ServeMux
        b -&amp;gt;&amp;gt; pe: envoyv2.NewDiscoveryServer()
        pe --&amp;gt;&amp;gt; b: s.EnvoyXdsServer *DiscoveryServer
        Note over kc,cmd: gRPC&amp;lt;br/&amp;gt;envoyv2.DiscoveryServer&amp;lt;br/&amp;gt;åªæä¾›StreamAggregatedResources()æœåŠ¡&amp;lt;br/&amp;gt;xDSç®¡ç†
        Note over kc,cmd: s.initGrpcServer()&amp;lt;br/&amp;gt;s.httpServer&amp;lt;br/&amp;gt;http.Server{Handler: s.mux}        
        Note over kc,cmd: http listener&amp;lt;br/&amp;gt;grpc listener
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸â¤ï¸ï¸s.addStartFunc()&amp;lt;br/&amp;gt;s.httpServer.Serve()&amp;lt;br/&amp;gt;s.grpcServer.Serve()
        alt args.DiscoveryOptions.SecureGrpcAddr != &amp;quot;&amp;quot;
        b -&amp;gt;&amp;gt; b: initSecureGrpcServer()
            Note over kc,cmd: s.secureGRPCServer&amp;lt;br/&amp;gt;s.secureHTTPServer
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&amp;lt;br/&amp;gt;s.addStartFunc()&amp;lt;br/&amp;gt;s.secureHTTPServer.ServeTLS()
        end
        
        Note right of b: 
    
    Note left of b: ç›‘æ§&amp;lt;br/&amp;gt;initMonitor()
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&amp;lt;br/&amp;gt;s.addStartFunc()&amp;lt;br/&amp;gt;startMonitor()
    
    Note left of b: é›†ç¾¤&amp;lt;br/&amp;gt;initClusterRegistries()
        b -&amp;gt;&amp;gt; c: clusterregistry.NewMulticluster()
        c --&amp;gt;&amp;gt; b: multicluster *Multicluster
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;discovery-serveræµç¨‹&#34;&gt;Discovery Serveræµç¨‹&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-mermaid&#34;&gt;graph LR
    
    
    s(ads.StreamAggregatedResources)
    style s fill:#f9f
    s --&amp;gt; rc(reqChannel)
    s --&amp;gt; pc(pushChannel)
    style rc fill:#f9f
    style pc fill:#f9f
    
    subgraph reqChannel
        rc --&amp;gt; dt{discReq.TypeUrl}
        dt --&amp;gt;|ClusterType| pushCds[&amp;quot;pushCds()&amp;quot;]
        dt --&amp;gt;|ListenerType| pushLds[&amp;quot;pushLds()&amp;quot;]
        dt --&amp;gt;|RouteType| pushRoute[&amp;quot;pushRoute()&amp;quot;]
        dt --&amp;gt;|EndpointType| pushEds[&amp;quot;pushEds()&amp;quot;]
    end
    
    subgraph pushChannel
        nd(&amp;quot;DiscoveryServer&amp;quot;) --&amp;gt; pr(&amp;quot;periodicRefresh&amp;quot;)
        nd --&amp;gt; ash(&amp;quot;s.ServiceController.AppendServiceHandler()&amp;quot;)
        nd --&amp;gt; aih(&amp;quot;s.ServiceController.AppendInstanceHandler()&amp;quot;)
        nd --&amp;gt; reh(&amp;quot;s.configController.RegisterEventHandler()&amp;quot;)
        ash --&amp;gt; clearCache(&amp;quot;clearCache()&amp;quot;)
        aih --&amp;gt; clearCache
        reh --&amp;gt; clearCache
        clearCache --&amp;gt;|full=true| ds(&amp;quot;ds.ConfigUpdate()&amp;quot;)
        pr --&amp;gt; pa(&amp;quot;ads.AdsPushAll()&amp;quot;)         
        
        sp(&amp;quot;ads.startPush()&amp;quot;) --&amp;gt; pc
        
        c(config) --MeshConfig/MeshNetworks/MCPConfig--&amp;gt; ds
        ds --&amp;gt; dp(&amp;quot;doPush()&amp;quot;)
        dp --&amp;gt; push(&amp;quot;Push()&amp;quot;)
        
        push --&amp;gt; pa
        pa --&amp;gt; updateCluster[&amp;quot;eds.updateCluster()&amp;quot;]
        push --&amp;gt; updateServiceShards[&amp;quot;eds.updateServiceShards()&amp;quot;]
        pa --&amp;gt; ei(&amp;quot;eds.edsIncremental()&amp;quot;)
        ei --&amp;gt; updateClusterInc(&amp;quot;eds.updateClusterInc()&amp;quot;)
        pa --&amp;gt; sp
        ei --&amp;gt; sp
        updateClusterInc --&amp;gt; updateCluster
        
        
        pc --&amp;gt; pushConn(pushConnection)
        pushConn -.-&amp;gt; C/E/L/Rds
    end
    
    nd --&amp;gt;|Serve gRPC| s
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Istioå®‰å…¨ã€‘æœåŠ¡é—´è®¿é—®æ§åˆ¶-RBAC</title>
      <link>http://hbchen.com/post/servicemesh/2019-03-09-istio-rbac-quick-start/</link>
      <pubDate>Fri, 22 Mar 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/servicemesh/2019-03-09-istio-rbac-quick-start/</guid>
      
        <description>&lt;p&gt;Istioæä¾›äº†éå¸¸æ˜“ç”¨çš„å®‰å…¨è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬æœåŠ¡é—´èº«ä»½éªŒè¯&lt;code&gt;mTLS&lt;/code&gt;ï¼ŒæœåŠ¡é—´è®¿é—®æ§åˆ¶&lt;code&gt;RBAC&lt;/code&gt;ï¼Œä»¥åŠç»ˆç«¯ç”¨æˆ·èº«ä»½éªŒè¯&lt;code&gt;JWT&lt;/code&gt;ç­‰ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»å¦‚ä½•ä½¿ç”¨æœåŠ¡é—´è®¿é—®æ§åˆ¶ï¼ŒåŒæ—¶æ¶‰åŠ&lt;code&gt;åŒå‘TLS&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Istioç‰ˆæœ¬ &lt;strong&gt;1.1.0&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;åœ¨çš„&lt;a href=&#34;https://github.com/hb-go/micro-mesh&#34;&gt;github.com/hb-go/micro-mesh&lt;/a&gt;ä¸­æœ‰ç»“åˆç¤ºä¾‹çš„&lt;a href=&#34;https://github.com/hb-go/micro-mesh/tree/master/deploy/k8s/istio/rbac&#34;&gt;RBACé…ç½®å®è·µ&lt;/a&gt;å¯ä»¥å‚è€ƒ&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;strong&gt;è¦å®ç°&lt;code&gt;RBAC&lt;/code&gt;ä¸»è¦ç†è§£ä»¥ä¸‹å‡ ä¸ªç±»å‹çš„&lt;code&gt;yaml&lt;/code&gt;é…ç½®ï¼Œä»¥åŠä¹‹é—´çš„å…³ç³»ï¼š&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#åŒå‘tls&#34;&gt;åŒå‘TLS&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Policy&lt;/code&gt;æˆ–&lt;code&gt;MeshPolicy&lt;/code&gt;ï¼Œä¸Šæ¸¸&lt;code&gt;server&lt;/code&gt;å¼€å¯TLS&lt;/li&gt;
&lt;li&gt;&lt;code&gt;DestinationRule&lt;/code&gt;ï¼Œä¸‹æ¸¸&lt;code&gt;client&lt;/code&gt;å¼€å¯TLS&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#rbac&#34;&gt;RBAC&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;ClusterRbacConfig&lt;/code&gt;/&lt;code&gt;RbacConfig&lt;/code&gt;ï¼Œå¯ç”¨æˆæƒåŠèŒƒå›´&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ServiceRole&lt;/code&gt;ï¼Œè§’è‰²æƒé™è§„åˆ™&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ServiceRoleBinding&lt;/code&gt;ï¼Œè§’è‰²ç»‘å®šè§„åˆ™&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#optional&#34;&gt;Optional&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;ServiceAccount&lt;/code&gt;ï¼Œ&lt;code&gt;ServiceRoleBinding&lt;/code&gt;.&lt;code&gt;subjects&lt;/code&gt;çš„&lt;code&gt;user&lt;/code&gt;æ¡ä»¶
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;å‡è®¾åœºæ™¯&#34;&gt;å‡è®¾åœºæ™¯&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;ç½‘æ ¼å†…&lt;code&gt;service-1&lt;/code&gt;ã€&lt;code&gt;service-2&lt;/code&gt;å¼€å¯RBACè®¿é—®æ§åˆ¶&lt;/li&gt;
&lt;li&gt;ä»…&lt;code&gt;service-1&lt;/code&gt;æˆæƒç»™&lt;code&gt;ingressgateway&lt;/code&gt;è®¿é—®ï¼Œ&lt;code&gt;service-2&lt;/code&gt;åˆ™ä¸èƒ½è¢«&lt;code&gt;ingressgateway&lt;/code&gt;è®¿é—®&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/istio-tls-rbac.png&#34; alt=&#34;auth-adapter&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;åŒå‘tls&#34;&gt;åŒå‘TLS&lt;/h2&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/concepts/security/#%E8%AE%A4%E8%AF%81&#34;&gt;Istioæ–‡æ¡£-è®¤è¯ç­–ç•¥&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/concepts/security/#%E8%AE%A4%E8%AF%81%E7%AD%96%E7%95%A5&#34;&gt;è®¤è¯ç­–ç•¥&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/tasks/security/authn-policy/&#34;&gt;Istioæ–‡æ¡£-åŸºç¡€è®¤è¯ç­–ç•¥&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/tasks/security/authn-policy/#%E4%B8%BA%E7%BD%91%E6%A0%BC%E4%B8%AD%E7%9A%84%E6%89%80%E6%9C%89%E6%9C%8D%E5%8A%A1%E5%90%AF%E7%94%A8%E5%8F%8C%E5%90%91-tls-%E8%AE%A4%E8%AF%81&#34;&gt;ä¸ºç½‘æ ¼ä¸­çš„æ‰€æœ‰æœåŠ¡å¯ç”¨åŒå‘ TLS è®¤è¯&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h3 id=&#34;1-ä¸Šæ¸¸-server-å¼€å¯tls&#34;&gt;1.ä¸Šæ¸¸&lt;code&gt;server&lt;/code&gt;å¼€å¯TLS&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;&lt;em&gt;&lt;a href=&#34;##&#34;&gt;ç­–ç•¥èŒƒå›´è¯´æ˜&lt;/a&gt;&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;ç½‘æ ¼èŒƒå›´ç­–ç•¥&lt;/strong&gt;ï¼šåœ¨ç½‘æ ¼èŒƒå›´å­˜å‚¨ä¸­å®šä¹‰çš„ç­–ç•¥ï¼Œæ²¡æœ‰ç›®æ ‡é€‰æ‹©å™¨éƒ¨åˆ†ã€‚ç½‘æ ¼ä¸­æœ€å¤šåªèƒ½æœ‰&lt;strong&gt;ä¸€ä¸ªç½‘æ ¼èŒƒå›´&lt;/strong&gt;çš„ç­–ç•¥ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å‘½åç©ºé—´èŒƒå›´çš„ç­–ç•¥&lt;/strong&gt;ï¼šåœ¨å‘½åç©ºé—´èŒƒå›´å­˜å‚¨ä¸­å®šä¹‰çš„ç­–ç•¥ï¼Œåç§°ä¸º default ä¸”æ²¡æœ‰ç›®æ ‡é€‰æ‹©å™¨éƒ¨åˆ†ã€‚æ¯ä¸ªå‘½åç©ºé—´æœ€å¤šåªèƒ½æœ‰&lt;strong&gt;ä¸€ä¸ªå‘½åç©ºé—´èŒƒå›´&lt;/strong&gt;çš„ç­–ç•¥ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç‰¹å®šäºæœåŠ¡çš„ç­–ç•¥&lt;/strong&gt;ï¼šåœ¨å‘½åç©ºé—´èŒƒå›´å­˜å‚¨ä¸­å®šä¹‰çš„ç­–ç•¥ï¼Œå…·æœ‰éç©ºç›®æ ‡é€‰æ‹©å™¨éƒ¨åˆ†ã€‚å‘½åç©ºé—´å¯ä»¥å…·æœ‰&lt;strong&gt;é›¶ä¸ªï¼Œä¸€ä¸ªæˆ–å¤šä¸ªç‰¹å®šäºæœåŠ¡&lt;/strong&gt;çš„ç­–ç•¥ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;ç­–ç•¥èŒƒå›´å¯ä»¥åˆ†åˆ«ç”±&lt;code&gt;Policy&lt;/code&gt;ã€&lt;code&gt;MeshPolicy&lt;/code&gt;è®¾ç½®ï¼Œ&lt;code&gt;Policy&lt;/code&gt;å¯ä»¥é€‰æ‹©å¯¹&lt;strong&gt;å‘½åç©ºé—´&lt;/strong&gt;æ‰€æœ‰æœåŠ¡ç”Ÿæ•ˆï¼Œä¹Ÿå¯ä»¥æŒ‡å®š&lt;code&gt;targets&lt;/code&gt;å¯¹&lt;strong&gt;ç‰¹å®šæœåŠ¡&lt;/strong&gt;ç”Ÿæ•ˆï¼Œ&lt;code&gt;MeshPolicy&lt;/code&gt;åˆ™æ˜¯æ•´ä¸ªç½‘æ ¼å†…ç”Ÿæ•ˆï¼Œå¯¹äº&lt;strong&gt;å‘½åç©ºé—´èŒƒå›´&lt;/strong&gt;å’Œ&lt;strong&gt;ç½‘æ ¼èŒƒå›´&lt;/strong&gt;åç§°éƒ½åªèƒ½ä¸º&lt;code&gt;default&lt;/code&gt;ã€‚&lt;/br&gt;
åŒæ—¶é…ç½®å¤šä¸ªç­–ç•¥æ—¶ä½¿ç”¨æœ€çª„åŒ¹é…ç­–ç•¥ï¼Œ&lt;strong&gt;ç‰¹å®šæœåŠ¡&amp;gt;å‘½åç©ºé—´èŒƒå›´&amp;gt;ç½‘æ ¼èŒƒå›´&lt;/strong&gt;ï¼Œå¦‚æœå¤šä¸ª&lt;strong&gt;ç‰¹å®šäºæœåŠ¡çš„ç­–ç•¥&lt;/strong&gt;ä¸æœåŠ¡åŒ¹é…ï¼Œåˆ™éšæœºé€‰æ‹©ä¸€ä¸ªã€‚ä¸‹é¢æ˜¯ä¸åŒç­–ç•¥èŒƒå›´çš„å…·ä½“é…ç½®å‚è€ƒï¼š&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&lt;code&gt;Policy&lt;/code&gt;ç‰¹å®šäºæœåŠ¡çš„ç­–ç•¥&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;targets&lt;/code&gt;æ”¯æŒ&lt;code&gt;name&lt;/code&gt;ä»¥åŠ&lt;code&gt;ports&lt;/code&gt;åˆ—è¡¨&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: &amp;quot;authentication.istio.io/v1alpha1&amp;quot;
kind: &amp;quot;Policy&amp;quot;
metadata:
  name: &amp;quot;policy-name&amp;quot;
spec:
  targets:
  - name: service-name-1
  - name: service-name-2
    ports:
    - number: 8080
  peers:
  - mtls: {}
---
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;&lt;code&gt;Policy&lt;/code&gt;å‘½åç©ºé—´èŒƒå›´çš„ç­–ç•¥&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: &amp;quot;authentication.istio.io/v1alpha1&amp;quot;
kind: &amp;quot;Policy&amp;quot;
metadata:
  name: &amp;quot;default&amp;quot;
  namespace: &amp;quot;namespace-1&amp;quot;
spec:
  peers:
  - mtls: {}
---
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;&lt;code&gt;MeshPolicy&lt;/code&gt;ç½‘æ ¼èŒƒå›´ç­–ç•¥&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: &amp;quot;authentication.istio.io/v1alpha1&amp;quot;
kind: &amp;quot;MeshPolicy&amp;quot;
metadata:
  name: &amp;quot;default&amp;quot;
spec:
  peers:
  - mtls: {}
---
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;2-ä¸‹æ¸¸-client-å¼€å¯tls&#34;&gt;2.ä¸‹æ¸¸&lt;code&gt;client&lt;/code&gt;å¼€å¯TLS&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;client&lt;/code&gt;ç«¯TLSç”±ç›®æ ‡è§„åˆ™&lt;code&gt;DestinationRule&lt;/code&gt;é…ç½®ï¼Œåœ¨æµé‡ç­–ç•¥&lt;code&gt;trafficPolicy&lt;/code&gt;ä¸­å¼€å¯&lt;code&gt;tls&lt;/code&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/reference/config/istio.networking.v1alpha3/#destinationrule&#34;&gt;Istioå‚è€ƒé…ç½®-é€šä¿¡è·¯ç”±#DestinationRule&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/reference/config/istio.networking.v1alpha3/#trafficpolicy&#34;&gt;Istioå‚è€ƒé…ç½®-é€šä¿¡è·¯ç”±#TrafficPolicy&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: service-name-1
spec:
  host: service-host-1
  # NOTE: å¼€å¯TLS
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
  subsets:
  - name: v1
    labels:
      version: v1
---
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;TLS&lt;code&gt;mode&lt;/code&gt;è¯´æ˜&lt;/strong&gt;&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&#34;center&#34;&gt;modeå€¼&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;æè¿°&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;DISABLE&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;ä¸è¦ä¸ºä¸Šæ¸¸ç«¯ç‚¹ä½¿ç”¨ TLSã€‚&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;SIMPLE&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;å‘ä¸Šæ¸¸ç«¯ç‚¹å‘èµ· TLS è¿æ¥ã€‚&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;MUTUAL&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;å‘é€å®¢æˆ·ç«¯è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼Œç”¨åŒå‘ TLS è¿æ¥ä¸Šæ¸¸ç«¯ç‚¹ã€‚&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;ISTIO_MUTUAL&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;å‘é€å®¢æˆ·ç«¯è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼Œç”¨åŒå‘ TLS è¿æ¥ä¸Šæ¸¸ç«¯ç‚¹ã€‚å’Œ MUTUAL ç›¸æ¯”ï¼Œè¿™ç§æ–¹å¼ä½¿ç”¨çš„åŒå‘ TLS è¯ä¹¦ç³»ç»Ÿæ˜¯ç”± Istio ç”Ÿæˆçš„ã€‚å¦‚æœä½¿ç”¨è¿™ç§æ¨¡å¼ï¼ŒTLSSettings ä¸­çš„å…¶ä»–å­—æ®µåº”è¯¥ç•™ç©ºã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&#34;rbac&#34;&gt;RBAC&lt;/h2&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/concepts/security/#%E6%8E%88%E6%9D%83&#34;&gt;Istioæ–‡æ¡£-æˆæƒ&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/concepts/security/#%E5%90%AF%E7%94%A8%E6%8E%88%E6%9D%83&#34;&gt;å¯ç”¨æˆæƒ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/concepts/security/#%E6%8E%88%E6%9D%83%E7%AD%96%E7%95%A5&#34;&gt;æˆæƒç­–ç•¥&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/tasks/security/role-based-access-control/&#34;&gt;Istioæ–‡æ¡£-åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/tasks/security/role-based-access-control/#%E6%9C%8D%E5%8A%A1%E7%BA%A7%E7%9A%84%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6&#34;&gt;æœåŠ¡çº§çš„è®¿é—®æ§åˆ¶&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/setup/kubernetes/upgrade/#%E8%BF%81%E7%A7%BB-rbacconfig-%E5%88%B0-clusterrbacconfig&#34;&gt;Istioæ–‡æ¡£-è¿ç§» RbacConfig åˆ° ClusterRbacConfig&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;em&gt;è¿™é‡Œä½¿ç”¨çš„&lt;code&gt;ClusterRbacConfig&lt;/code&gt;&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/reference/config/authorization/&#34;&gt;Istioå‚è€ƒé…ç½®-æˆæƒ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;æœ‰å…³&lt;code&gt;RbacConfig&lt;/code&gt;ã€&lt;code&gt;ServiceRole&lt;/code&gt;ã€&lt;code&gt;ServiceRoleBinding&lt;/code&gt;çš„å±æ€§ç»“æ„Istioæ–‡æ¡£æœ‰è¯¦ç»†çš„é…ç½®å¯ä»¥å‚è€ƒ:&lt;a href=&#34;https://istio.io/zh/docs/reference/config/authorization/istio.rbac.v1alpha1/&#34;&gt;Istioå‚è€ƒé…ç½®-æˆæƒ-RBAC&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;1-å¼€å¯æˆæƒ-clusterrbacconfig&#34;&gt;1.å¼€å¯æˆæƒ&lt;code&gt;ClusterRbacConfig&lt;/code&gt;&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: &amp;quot;rbac.istio.io/v1alpha1&amp;quot;
kind: ClusterRbacConfig
metadata:
  name: default
  namespace: istio-system
spec:
  mode: &#39;ON_WITH_INCLUSION&#39;
  inclusion:
    #namespaces: [&amp;quot;namespace-1&amp;quot;]
    services: [&amp;quot;service-name-1.namespace-1.svc.cluster.local&amp;quot;, &amp;quot;service-name-2.namespace-1.svc.cluster.local&amp;quot;]
  # NOTE: ENFORCED/PERMISSIVEï¼Œä¸¥æ ¼æˆ–å®½å®¹æ¨¡å¼
  enforcement_mode: ENFORCED
---
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;enforcement_mode&lt;/code&gt;å¯ä»¥é€‰æ‹©&lt;code&gt;ENFORCED&lt;/code&gt;ä¸¥æ ¼æ¨¡å¼ï¼Œæˆ–&lt;code&gt;PERMISSIVE&lt;/code&gt;å®½å®¹æ¨¡å¼ï¼Œå®½å®¹æ¨¡å¼ä¾¿äºæˆæƒç­–ç•¥éœ€è¦&lt;strong&gt;å˜æ›´æ—¶è¿›è¡ŒéªŒè¯æµ‹è¯•&lt;/strong&gt;ï¼Œ&lt;a href=&#34;https://istio.io/zh/docs/tasks/security/role-based-access-control/#%E6%8E%88%E6%9D%83%E8%AE%B8%E5%8F%AF%E6%A8%A1%E5%BC%8F&#34;&gt;Istioä»»åŠ¡-æˆæƒè®¸å¯æ¨¡å¼&lt;/a&gt;ä»»åŠ¡ä¸­æœ‰æ›´å…·ä½“çš„åœºæ™¯ä»‹ç»ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;æ¨¡å¼&lt;code&gt;mode&lt;/code&gt;è¯´æ˜&lt;/strong&gt;&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&#34;center&#34;&gt;modeå€¼&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;æè¿°&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;OFF&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;å…³é—­ Istio RBACï¼ŒRbacConfig çš„æ‰€æœ‰é…ç½®å°†ä¼šå¤±æ•ˆï¼Œä¸” Istio RBAC Policies ä¸ä¼šæ‰§è¡Œã€‚&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;ON&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;ä¸ºæ‰€æœ‰ services å’Œ namespaces å¯ç”¨ Istio RBACã€‚&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;ON_WITH_INCLUSION&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;ä»…é’ˆå¯¹ inclusion å­—æ®µä¸­æŒ‡å®šçš„ services å’Œ namespaces å¯ç”¨ Istio RBACã€‚å…¶å®ƒä¸åœ¨ inclusion å­—æ®µä¸­çš„ services å’Œ namespaces å°†ä¸ä¼šè¢« Istio RBAC Policies å¼ºåˆ¶æ‰§è¡Œã€‚&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;ON_WITH_EXCLUSION&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;é’ˆå¯¹é™¤äº† exclusion å­—æ®µä¸­æŒ‡å®šçš„ services å’Œ namespacesï¼Œå¯ç”¨ Istio RBACã€‚å…¶å®ƒä¸åœ¨ exclusion å­—æ®µä¸­çš„ services å’Œ namespaces å°†æŒ‰ç…§ Istio RBAC Policies æ‰§è¡Œã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&#34;2-è§’è‰²æƒé™è§„åˆ™-servicerole&#34;&gt;2.è§’è‰²æƒé™è§„åˆ™&lt;code&gt;ServiceRole&lt;/code&gt;&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;namespace&lt;/code&gt; + &lt;code&gt;services&lt;/code&gt; + &lt;code&gt;paths&lt;/code&gt; + &lt;code&gt;methods&lt;/code&gt; ä¸€èµ·å®šä¹‰äº†å¦‚ä½•è®¿é—®æœåŠ¡ï¼Œå…¶ä¸­&lt;code&gt;services&lt;/code&gt;å¿…é€‰ï¼Œå¦å¤–æœ‰&lt;code&gt;constraints&lt;/code&gt;å¯ä»¥æŒ‡å®šå…¶å®ƒçº¦æŸï¼Œæ”¯æŒçš„çº¦æŸå‚è€ƒ&lt;a href=&#34;https://istio.io/zh/docs/reference/config/authorization/constraints-and-properties/#%E6%94%AF%E6%8C%81%E7%9A%84%E7%BA%A6%E6%9D%9F&#34;&gt;Istioå‚è€ƒé…ç½®-æˆæƒ-çº¦æŸå’Œå±æ€§#æ”¯æŒçš„çº¦æŸ&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: &amp;quot;rbac.istio.io/v1alpha1&amp;quot;
kind: ServiceRole
metadata:
  name: service-role-1
  namespace: default
spec:
  rules:
  - services: [&amp;quot;service-name-1.namespace-1.svc.cluster.local&amp;quot;]
    methods: [&amp;quot;*&amp;quot;]
    # NOTE: æ ¹æ®çº¦æŸéœ€è¦ä¿®æ”¹
    constraints:
    - key: request.headers[version]
      values: [&amp;quot;v1&amp;quot;, &amp;quot;v2&amp;quot;]
---
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;3-è§’è‰²ç»‘å®šè§„åˆ™-servicerolebinding&#34;&gt;3.è§’è‰²ç»‘å®šè§„åˆ™&lt;code&gt;ServiceRoleBinding&lt;/code&gt;&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;user&lt;/code&gt; + &lt;code&gt;properties&lt;/code&gt; ä¸€èµ·å®šä¹‰æˆæƒç»™è°ï¼Œæ”¯æŒçš„å±æ€§å‚è€ƒ&lt;a href=&#34;https://istio.io/zh/docs/reference/config/authorization/constraints-and-properties/#%E6%94%AF%E6%8C%81%E7%9A%84%E5%B1%9E%E6%80%A7&#34;&gt;Istioå‚è€ƒé…ç½®-æˆæƒ-çº¦æŸå’Œå±æ€§#æ”¯æŒçš„å±æ€§&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: &amp;quot;rbac.istio.io/v1alpha1&amp;quot;
kind: ServiceRoleBinding
metadata:
  name: service-rb-1
  namespace: default
spec:
  subjects:
  # NOTE: éœ€è¦æ·»åŠ  ServiceAccount
  - user: &amp;quot;cluster.local/ns/namespace-1/sa/service-account-2&amp;quot;
    # NOTE: æ ¹æ®å±æ€§éœ€è¦ä¿®æ”¹
    properties:
      source.namespace: &amp;quot;default&amp;quot;
  # NOTE: ingressgatewayæˆæƒ
  - user: &amp;quot;cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account&amp;quot;
  roleRef:
    kind: ServiceRole
    name: &amp;quot;service-role-1&amp;quot;
---
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;optional&#34;&gt;Optional&lt;/h2&gt;

&lt;h3 id=&#34;éƒ¨ç½²å®ä¾‹æ·»åŠ -serviceaccount&#34;&gt;éƒ¨ç½²å®ä¾‹æ·»åŠ &lt;code&gt;ServiceAccount&lt;/code&gt;&lt;/h3&gt;

&lt;p&gt;å¯¹äºéœ€è¦è¦åœ¨&lt;code&gt;ServiceRoleBinding&lt;/code&gt;çš„&lt;code&gt;subjects&lt;/code&gt;æ¡ä»¶ä¸­æˆæƒçš„&lt;code&gt;user&lt;/code&gt;ï¼Œéœ€è¦åœ¨éƒ¨ç½²å®ä¾‹æ—¶æŒ‡å®š&lt;code&gt;serviceAccountName&lt;/code&gt;ï¼Œå¦‚å‰é¢&lt;code&gt;ServiceRoleBinding&lt;/code&gt;é…ç½®è¦å…è®¸&lt;code&gt;service-2&lt;/code&gt;è®¿é—®&lt;code&gt;service-1&lt;/code&gt;ï¼Œåˆ™éƒ¨ç½²&lt;code&gt;service-2&lt;/code&gt;æ—¶éœ€è¦é…ç½®&lt;code&gt;serviceAccountName: service-account-2&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;# NOTE: åˆ›å»ºServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: service-account-2
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: service-name-2-v1
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: service-name-2
        version: v1
    spec:
      # NOTE: ä¸ºéƒ¨ç½²å®ä¾‹æŒ‡å®šserviceAccountName
      serviceAccountName: service-account-2
      containers:
      - name: service-name-2-v1
        command: [
          &amp;quot;/main&amp;quot;
        ]
        image: hbchen/service-2:v0.0.1
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9080
---
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;

&lt;p&gt;IstioæœåŠ¡ç½‘æ ¼å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°&lt;strong&gt;æœåŠ¡é—´è®¿é—®æ§åˆ¶&lt;/strong&gt;ï¼Œé€šè¿‡æœåŠ¡çº§çš„æˆæƒå¼€å…³ï¼Œå†ç»“åˆ&lt;code&gt;ServiceRole&lt;/code&gt;ã€&lt;code&gt;ServiceRoleBinding&lt;/code&gt;çš„çº¦æŸå’Œå±æ€§æ¡ä»¶ï¼Œå¯ä»¥å®ç°ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶ã€‚æœ¬æ–‡æœªæ¶‰åŠIstioçš„ç»ˆç«¯ç”¨æˆ·èº«ä»½éªŒè¯ï¼Œåé¢ä¼šç»“åˆ&lt;code&gt;Ingress&lt;/code&gt;ã€&lt;code&gt;Egress&lt;/code&gt;çš„&lt;code&gt;TLS&lt;/code&gt;å’Œ&lt;code&gt;JWT&lt;/code&gt;ä¸€èµ·åˆ†æè¾¹ç¼˜æµé‡ç›¸å…³çš„å®‰å…¨é—®é¢˜ã€‚&lt;/p&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Istioæºç ã€‘Mixer</title>
      <link>http://hbchen.com/post/servicemesh/2019-03-17-istio-code-mixer/</link>
      <pubDate>Sun, 17 Mar 2019 17:23:52 +0800</pubDate>
      
      <guid>http://hbchen.com/post/servicemesh/2019-03-17-istio-code-mixer/</guid>
      
        <description>&lt;p&gt;Mixeræ¨¡å—ä¸ºIstioæä¾›äº†æ¨¡å—åŒ–å¯æ‰©å±•çš„ç»„ä»¶ï¼Œå°†ç­–ç•¥ä¸é¥æµ‹è¿›è¡ŒæŠ½è±¡ï¼Œé€šè¿‡é…ç½®æ¨¡å‹è¿›è¡Œé…ç½®ã€‚åœ¨&lt;a href=&#34;http://hbchen.com/post/2019-03-05-custom-istio-mixer-adapter/&#34;&gt;ã€Šã€Istioã€‘è‡ªå®šä¹‰ Mixer Adapterç¤ºä¾‹æ•™ç¨‹(é™„æºç )ã€‹&lt;/a&gt;ä¸­ä»‹ç»äº†å¦‚ä½•è‡ªå®šä¹‰ä¸€ä¸ªAdapterï¼Œæœ¬æ–‡é€šè¿‡&lt;code&gt;mxier&lt;/code&gt;çš„æºç åˆ†æï¼Œè¿›ä¸€æ­¥äº†è§£é€‚é…å™¨å¦‚ä½•å·¥ä½œã€‚&lt;/p&gt;

&lt;p&gt;Istioéƒ¨ç½²ä¸­æœ‰ä¸¤ä¸ªæœåŠ¡ä¸&lt;code&gt;mixer&lt;/code&gt;æœ‰å…³:&lt;code&gt;istio-policy&lt;/code&gt;ã€&lt;code&gt;istio-telemetry&lt;/code&gt;ï¼Œåˆ†åˆ«è´Ÿè´£ç­–ç•¥ä¸é¥æµ‹ï¼Œè¿è¡Œçš„éƒ½æ˜¯&lt;code&gt;mixs&lt;/code&gt;ï¼›å¦å¤–&lt;code&gt;mixer&lt;/code&gt;çš„Clientç«¯åœ¨Sidecar&lt;code&gt;istio-proxy&lt;/code&gt;ï¼Œç«Ÿåƒæ˜¯&lt;code&gt;pilot-agent&lt;/code&gt;ï¼Œé•œåƒä¸­çš„&lt;code&gt;Envoy&lt;/code&gt;æ˜¯&lt;code&gt;istio/proxy&lt;/code&gt;é€šè¿‡&lt;code&gt;Envoy&lt;/code&gt;çš„&lt;code&gt;filter&lt;/code&gt;æ‰©å±•äº†&lt;code&gt;mixerclient&lt;/code&gt;ã€&lt;code&gt;jwt_auth&lt;/code&gt;ã€&lt;code&gt;authn&lt;/code&gt;ç­‰åŠŸèƒ½ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;github.com/istio/istio &lt;strong&gt;release 1.1.0&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;github.com/istio/proxy &lt;strong&gt;release 1.1.0&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;mixeræ¨¡å—-mixs-server-æ‰§è¡Œåºåˆ—&#34;&gt;Mixeræ¨¡å—&lt;code&gt;mixs server&lt;/code&gt;æ‰§è¡Œåºåˆ—&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-mermaid&#34;&gt;sequenceDiagram
    participant s as server
    participant a as api
    participant r as runtime
    participant rd as runtine/dispatcher
    participant rc as runtime/config
    participant cs as config/store
    
    s -&amp;gt;&amp;gt; r: runtime.New()
    r --&amp;gt;&amp;gt; s: rt *Runtime
    s -&amp;gt;&amp;gt; r: p.runtimeListen(rt) â€”&amp;gt; rt.StartListening()
    r -&amp;gt;&amp;gt; cs: store.StartWatch()
    loop é…ç½®ç›‘æ§ 
    cs -&amp;gt;&amp;gt; cs: go func() { watchChan&amp;lt;-Event }
    end
    cs --&amp;gt;&amp;gt; r: &amp;lt;-watchChan
    
    loop é…ç½®æ›´æ–°
    r -&amp;gt;&amp;gt; rc: go func() { WatchChanges(watchChan) }
    alt &amp;lt;-watchChan
    Note over rd,rc: &amp;lt;-watchChan Eventå…ˆåšå †ç§¯
    cs -&amp;gt;&amp;gt; cs: append(events, event)
    
    else &amp;lt;-timeChan
    Note over rd,rc: &amp;lt;-timeChan è®¡æ—¶å™¨æ›´æ–°é…ç½®
    cs -&amp;gt;&amp;gt; r: onConfigChange()
    r -&amp;gt;&amp;gt; rc: ephemeral.ApplyEvent(events)
    rc -&amp;gt;&amp;gt; rc: entries Lock()ï¼Œæ›´æ–°entries
    r -&amp;gt;&amp;gt; r: processNewConfig()
    r -&amp;gt;&amp;gt; rc: ephemeral.BuildSnapshot()
    Note right of rc: åˆ›å»ºé…ç½®å¿«ç…§&amp;lt;br/&amp;gt;entries RLock()&amp;lt;br/&amp;gt;......&amp;lt;br/&amp;gt;e.processRuleConfigs
    rc -&amp;gt;&amp;gt; rc: processXXXConfigs()
    rc --&amp;gt;&amp;gt; r: nweSnapshot *Snapshot
    Note right of r: è·å¾—newHandlers
    r -&amp;gt;&amp;gt; r: handler.NewTable(nweSnapshot)
    Note right of r: è·å¾—newRoutes
    r -&amp;gt;&amp;gt; r: routing.BuildTable(newHandlers, nweSnapshot)
    Note right of r: æ›´æ–°RoutingContext
    r -&amp;gt;&amp;gt; rd: dispatcher.ChangeRoute(newRoutes)
    
    else &amp;lt;-stop
    Note over rd,rc: &amp;lt;-stop é€€å‡ºgoroutine
    cs --&amp;gt;&amp;gt; r: return
    end
    end
    
    r --&amp;gt;&amp;gt; s: nil or error
    s -&amp;gt;&amp;gt; a: api.NewGRPCServer(s.dispatcher)
    a --&amp;gt;&amp;gt; s: *MixerServer
    s -&amp;gt;&amp;gt; s: grpcServer.Serve()
    
    loop MixerServer
    activate a
    s -&amp;gt;&amp;gt; a: MixerServer Request
    Note right of a: MixeræœåŠ¡é€»è¾‘
    a -&amp;gt;&amp;gt; rd: Checkã€Quotaç­‰è°ƒåº¦
    activate rd
    rd -&amp;gt;&amp;gt; rd: session.dispatch()
    Note right of rd: æ ¹æ®varietyã€nsç­›é€‰&amp;lt;br/&amp;gt;destinations
    rd -&amp;gt;&amp;gt; rd: s.rc.Routes.GetDestinations()
    Note right of rd: ç­‰å¾…Adapterè°ƒåº¦å®Œæˆ
    rd -&amp;gt;&amp;gt; rd: s.waitForDispatched()
    rd --&amp;gt;&amp;gt; a: nil or error
    a --&amp;gt;&amp;gt; s: MixerServer Response
    deactivate rd
    deactivate s
    end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é€šè¿‡åºåˆ—åˆ†æå¯¹&lt;code&gt;mixs server&lt;/code&gt;æœ‰æ•´ä½“çš„äº†è§£ï¼Œå¯¹&lt;code&gt;.yaml&lt;/code&gt;é…ç½®é€»è¾‘çš„ç†è§£åœ¨&lt;code&gt;runtime/config/ephemeral.go&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// BuildSnapshot builds a stable, fully-resolved snapshot view of the configuration.
func (e *Ephemeral) BuildSnapshot() (*Snapshot, error) {
	// â€¦â€¦
	
	// NOTE: e.entriesä¸­Kindä¸ºattributemanifestçš„å±æ€§ï¼Œä»¥åŠe.templatesä¸­Varietyä¸ºTEMPLATE_VARIETY_ATTRIBUTE_GENERATORç”Ÿäº§çš„å±æ€§
	attributes := e.processAttributeManifests(monitoringCtx)
	
	// NOTE: e.entriesä¸­Kindä¸ºhandlerï¼Œä¸”åœ¨e.adaptersä¸­æœ‰å®šä¹‰çš„Resource
	shandlers := e.processStaticAdapterHandlerConfigs(monitoringCtx)
	
	// NOTE: e.entriesä¸­Kindåœ¨e.templatesä¸­çš„Resource
	af := ast.NewFinder(attributes)
	instances := e.processInstanceConfigs(monitoringCtx, af, errs)
    
	// New dynamic configurations
	dTemplates := e.processDynamicTemplateConfigs(monitoringCtx, errs)
	dAdapters := e.processDynamicAdapterConfigs(monitoringCtx, dTemplates, errs)
	dhandlers := e.processDynamicHandlerConfigs(monitoringCtx, dAdapters, errs)
	dInstances := e.processDynamicInstanceConfigs(monitoringCtx, dTemplates, af, errs)
    
	// NOTE: æ ¹æ®è§„åˆ™åŒ¹é…é»˜è®¤åŠåŠ¨æ€çš„handlersã€instancesé…ç½®
	rules := e.processRuleConfigs(monitoringCtx, shandlers, instances, dhandlers, dInstances, af, errs)
	// â€¦â€¦
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;istio-proxyä¸­-mixerclient-æ‰§è¡Œæµç¨‹&#34;&gt;istio/proxyä¸­&lt;code&gt;mixerclient&lt;/code&gt;æ‰§è¡Œæµç¨‹&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;src/envoy/BUILD

&lt;ul&gt;
&lt;li&gt;http/mixer:filter_lib&lt;/li&gt;
&lt;li&gt;tcp/mixer:filter_lib&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;src/envoy/httpã€tcp/mixer/filter.cc

&lt;ul&gt;
&lt;li&gt;åˆ†åˆ«åœ¨&lt;code&gt;decodeHeaders()&lt;/code&gt;å’Œ&lt;code&gt;onData()&lt;/code&gt;åš&lt;code&gt;Check()&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;src/istio/control/httpã€tcp/request_handler_impl.cc

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Check()&lt;/code&gt;å…ˆåšå±æ€§æ³¨å…¥&lt;/li&gt;
&lt;li&gt;src/istio/control/client_context_base.ccï¼Œ&lt;code&gt;SendCheck()&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;è°ƒç”¨&lt;code&gt;mixerclient-&amp;gt;Check()&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;src/istio/mixerclient/client_impl.cc

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Check()&lt;/code&gt;å…ˆè·å–ç¼“å­˜&lt;code&gt;checkPolicyCache()&lt;/code&gt;ï¼Œç¼“å­˜æ²¡æœ‰å‘½ä¸­åˆ™èµ°&lt;code&gt;RemoteCheck()&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;RemoteCheck()&lt;/code&gt;æˆåŠŸåæ›´æ–°ç¼“å­˜&lt;code&gt;updatePolicyCache()&lt;/code&gt;
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-mermaid&#34;&gt;graph TB;
  subgraph src/envoy
  A[mixer:filter_lib]--&amp;gt;|&amp;quot;decodeHeaders()&amp;quot;|B(http/mixer/filter.cc)
  A--&amp;gt;|&amp;quot;onData()&amp;quot;|C(tcp/mixer/filter.cc)
  end
  subgraph srv/istio/control
  B--&amp;gt;|&amp;quot;Check(){å±æ€§æ³¨å…¥}&amp;quot;|D(http/request_handler_impl.cc)
  C--&amp;gt;|&amp;quot;Check(){å±æ€§æ³¨å…¥}&amp;quot;|E(tcp/request_handler_impl.cc)
  D--&amp;gt;|&amp;quot;SendCheck()&amp;quot;|F(client_context_base.cc)
  E--&amp;gt;|&amp;quot;SendCheck()&amp;quot;|F
  end
  subgraph srv/istio/mixerclient
  F--&amp;gt;|&amp;quot;Check()&amp;quot;|G(client_impl.cc)
  G--&amp;gt;|&amp;quot;â‘ checkPolicyCache()&amp;quot;|H(check_context.cc)
  G--&amp;gt;|&amp;quot;â‘¡RemoteCheck()&amp;quot;|G
  G--&amp;gt;|&amp;quot;â‘¢updatePolicyCache()&amp;quot;|H
  end
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Istioã€‘è‡ªå®šä¹‰ Mixer Adapterç¤ºä¾‹æ•™ç¨‹(é™„æºç )</title>
      <link>http://hbchen.com/post/2019-03-05-custom-istio-mixer-adapter/</link>
      <pubDate>Tue, 05 Mar 2019 20:44:07 +0800</pubDate>
      
      <guid>http://hbchen.com/post/2019-03-05-custom-istio-mixer-adapter/</guid>
      
        <description>&lt;blockquote&gt;
&lt;p&gt;å¿«é€Ÿå¼€å§‹:&lt;a href=&#34;https://github.com/hb-go/micro-mesh/tree/master/examples/adapter/auth&#34;&gt;micro-mesh/examples/adapter/auth&lt;/a&gt;æºç ä¼ é€é—¨&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ç ”ç©¶Istioä¸‹æ„å»ºç®€æ´çš„å¾®æœåŠ¡æ¶æ„ï¼Œå¯¹Istioçš„ç ”ç©¶ä¹Ÿæ›´æ·±å…¥ï¼Œè‡ªå®šä¹‰Mixer Adapterå¿…ä¸å°‘ï¼Œä»¥ä¸‹ç»“åˆä½¿ç”¨åœºæ™¯åšä¸€ä¸ªè‡ªå®šä¹‰é€‚é…å™¨çš„å®è·µåˆ†äº«ã€‚&lt;/p&gt;

&lt;h2 id=&#34;èƒŒæ™¯&#34;&gt;èƒŒæ™¯&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/hb-go/micro-mesh/master/doc/img/micro-mesh.jpg&#34; alt=&#34;auth-adapter&#34; /&gt;
ç»“åˆ&lt;a href=&#34;https://github.com/hb-go/micro-mesh#micro-mesh&#34;&gt;micro-mesh&lt;/a&gt;çš„å®è·µåœºæ™¯ï¼Œéœ€è¦åœ¨&lt;code&gt;ingressgateway&lt;/code&gt;ä¸&lt;code&gt;API service&lt;/code&gt;é—´åŠ å…¥è®¤è¯&amp;amp;é‰´æƒ(JWT&amp;amp;RBAC)ï¼Œè‡ªç„¶è€ƒè™‘Istioæä¾›çš„&lt;a href=&#34;https://istio.io/zh/docs/concepts/security/&#34;&gt;å®‰å…¨&lt;/a&gt;æ–¹æ¡ˆï¼Œä½†ä½¿ç”¨JWTåšè®¤è¯é‰´æƒåœ¨åç«¯æ˜¯æ— çŠ¶æ€çš„ï¼Œè¿™æ ·åœ¨ä½¿ç”¨åœºæ™¯ä¸Šæœ‰ä¸€å®šé™åˆ¶ï¼Œå¦‚:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å¯†ç ä¿®æ”¹ã€ç»ˆç«¯è¿æ¥é™åˆ¶ç­‰åœºæ™¯ä¸‹æ— æ³•è¸¢é™¤&lt;/li&gt;
&lt;li&gt;è®¿é—®æ§åˆ¶ç­–ç•¥æ— æ³•å®æ—¶ç”Ÿæ•ˆ&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;p&gt;é»˜è®¤æ–¹æ¡ˆåªæ˜¯åœ¨ä¸€äº›åœºæ™¯ä¸‹ä¸åˆé€‚ï¼Œæ ¹æ®å…·ä½“éœ€æ±‚è€ƒè™‘&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;åŸºäºè¿™æ ·çš„åœºæ™¯å¯ä»¥è‡ªå®šä¹‰Adapteræ¥å®ç°ï¼Œç›®æ ‡:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Token-JWT

&lt;ul&gt;
&lt;li&gt;æœåŠ¡ç«¯éªŒè¯tokenæœ‰æ•ˆæ€§&lt;/li&gt;
&lt;li&gt;åº”å¯¹å¯†ç ä¿®æ”¹ã€ç»ˆç«¯æ•°é‡é™åˆ¶ç­‰åœºæ™¯&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;ACL-&lt;a href=&#34;http://github.com/casbin/casbin&#34;&gt;Casbin&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;æœåŠ¡ç«¯è·å–ç”¨æˆ·è§’è‰²ï¼ŒåšAPIè®¿é—®æ§åˆ¶&lt;/li&gt;
&lt;li&gt;ç”¨æˆ·è§’è‰²åŠæ¥å£æˆæƒç­–ç•¥å®æ—¶ç”Ÿæ•ˆ
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä»¥ä¸‹ç¤ºä¾‹å¯¹tokenéªŒè¯ã€è®¿é—®æ§åˆ¶ä¸åšå…·ä½“è®¾è®¡ï¼Œé‡ç‚¹ä»‹ç»å¦‚ä½•è‡ªå®šä¹‰ä¸€ä¸ª&lt;code&gt;auth-adapter&lt;/code&gt;&lt;/p&gt;

&lt;h2 id=&#34;è‡ªå®šä¹‰adapterä»‹ç»&#34;&gt;è‡ªå®šä¹‰Adapterä»‹ç»&lt;/h2&gt;

&lt;p&gt;é…ç½®å…³ç³»åŠæ‰§è¡Œæµç¨‹å¦‚å›¾ï¼š
&lt;img src=&#34;https://raw.githubusercontent.com/hb-go/micro-mesh/master/doc/img/auth-adapter.jpg&#34; alt=&#34;auth-adapter&#34; /&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å±æ€§ï¼šä½¿ç”¨&lt;code&gt;istio&lt;/code&gt;çš„&lt;code&gt;attributes&lt;/code&gt;ï¼Œ&lt;code&gt;istio/mixer/testdata/config/attributes.yaml&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;å±æ€§ä¸é€‚é…å™¨è¾“å…¥æ˜ å°„æ¨¡æ¿ï¼šä½¿ç”¨&lt;code&gt;istio&lt;/code&gt;çš„&lt;code&gt;authorization&lt;/code&gt;æ¨¡æ¿ï¼Œ&lt;code&gt;istio/mixer/template/authorization/template.yaml&lt;/code&gt;ï¼Œé€šè¿‡&lt;code&gt;template.proto&lt;/code&gt;æŸ¥çœ‹åè®®å†…å®¹&lt;/li&gt;
&lt;li&gt;é€‚é…å™¨ï¼Œ&lt;code&gt;micro-mesh/examples/adapter/auth/config/auth-adapter.yaml&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;go generate ./...&lt;/code&gt;è‡ªåŠ¨ç”Ÿæˆ&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;é€‚é…å™¨æœåŠ¡å¯åŠ¨é…ç½®ï¼Œ&lt;code&gt;micro-mesh/examples/adapter/auth/config/config.proto&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;é€‚é…å™¨æœåŠ¡å®ä¾‹ï¼Œ&lt;code&gt;micro-mesh/examples/adapter/auth/operatorconfig/cluster-service.yaml&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;é€‚é…å™¨é…ç½®ï¼Œ&lt;code&gt;micro-mesh/examples/adapter/auth/operatorconfig/operator-cfg.yaml&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;ç›®å½•ç»“æ„&#34;&gt;ç›®å½•ç»“æ„&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;bin                         æ‰§è¡Œæ–‡ä»¶
cmd                         
  â”” main.go                 é€‚é…å™¨å…¥å£
config                      é…ç½®åè®®
  â”œ adapter.auth.config.pb.html                 #go generate ./... è‡ªåŠ¨ç”Ÿæˆ
  â”œ auth-adapter.yaml       é€‚é…å™¨æè¿°æ–‡ä»¶       #go generate ./... è‡ªåŠ¨ç”Ÿæˆ
  â”œ config.pb.go                                #go generate ./... è‡ªåŠ¨ç”Ÿæˆ
  â”œ config.proto            é€‚é…å™¨æœåŠ¡å¯åŠ¨é…ç½®
  â”” config.proto_descriptor                     #go generate ./... è‡ªåŠ¨ç”Ÿæˆ
operatorconfig              k8sé…ç½®
  â”œ attributes.yaml         å±æ€§                  #copy istio/mixer/testdata/config/attributes.yaml
  â”œ cluster-service.yaml    é€‚é…å™¨æœåŠ¡å®ä¾‹
  â”œ operator-cfg.yaml       é€‚é…å™¨é…ç½®
  â”” template.yaml           å±æ€§ä¸é€‚é…å™¨è¾“å…¥æ¨¡æ¿    #copy istio/mixer/template/authorization/template.yaml
testdata                    æµ‹è¯•é…ç½®
  â”œ attributes.yaml         å±æ€§                  #copy istio/mixer/testdata/config/attributes.yaml
  â”œ auth-adapter.yaml       é€‚é…å™¨æè¿°æ–‡ä»¶         #copy config/auth-adapter.yaml
  â”œ operator-cfg.yaml       é€‚é…å™¨é…ç½®
  â”” template.yaml           å±æ€§ä¸é€‚é…å™¨è¾“å…¥æ¨¡æ¿    #copy istio/mixer/template/authorization/template.yaml
auth.go                     é€‚é…å™¨æœåŠ¡å®ç°
Dockerfile                  Dockeré•œåƒ
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æœ‰3å¤„ä¸é€‚é…å™¨å®ç°ç›¸å…³ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;é€‚é…å™¨æœåŠ¡å¯åŠ¨é…ç½®&lt;code&gt;config/config.proto&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;é€‚é…å™¨æœåŠ¡å®ç°&lt;code&gt;auth.go&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;é€‚é…å™¨å…¥å£&lt;code&gt;cmd/main.go&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;blockquote&gt;
&lt;p&gt;æ¥ä¸‹æ¥ä½¿ç”¨&lt;a href=&#34;https://github.com/hb-go/micro-mesh/tree/master/examples/adapter/auth&#34;&gt;micro-mesh/examples/adapter/auth&lt;/a&gt;æºç æŒ‰æ­¥éª¤æ“ä½œï¼Œå®ç°æœ¬åœ°åŠ&lt;code&gt;GKE&lt;/code&gt;ç¯å¢ƒçš„æµ‹è¯•éƒ¨ç½²&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;æ­¥éª¤&#34;&gt;æ­¥éª¤&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;å¼€å‘ç¯å¢ƒ&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;OSX&lt;/li&gt;
&lt;li&gt;Go &lt;strong&gt;1.11.1&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;protoc &lt;strong&gt;libprotoc 3.6.1&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;Istio &lt;strong&gt;1.1.0&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;1-istioæºç &#34;&gt;1.Istioæºç &lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mkdir -p $GOPATH/src/istio.io/
cd $GOPATH/src/istio.io/
git clone https://github.com/istio/istio.git
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;2-micro-meshæºç &#34;&gt;2.micro-meshæºç &lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;git clone https://github.com/hb-go/micro-mesh.git
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;3-mixerå¼€å‘å·¥å…·&#34;&gt;3.Mixerå¼€å‘å·¥å…·&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# build mixer server &amp;amp; client 
cd istio
make mixs
make mixc
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨&lt;code&gt;$GOPATH/out/darwin_amd64/release/&lt;/code&gt;ç”Ÿæˆ&lt;code&gt;mixs&lt;/code&gt;ã€&lt;code&gt;mixc&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&#34;4-æ„å»ºauth-adapteré¡¹ç›®&#34;&gt;4.æ„å»ºAuth adapteré¡¹ç›®&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# copy auth adapter example
cp {micro-mesh path}/examples/adapter/auth mixer/adapter/auth

cd mixer/adapter/auth
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Optional&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;å¯ä»¥åˆ é™¤&lt;code&gt;config&lt;/code&gt;ç›®å½•é™¤&lt;code&gt;config.proto&lt;/code&gt;å¤–çš„å…¶ä»–æ–‡ä»¶ï¼Œçœ‹æ‰§è¡Œgo generateåçš„ç»“æœ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;go generate ./...
go build ./...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;go generate&lt;/code&gt;æ ¹æ®&lt;code&gt;config/config.proto&lt;/code&gt;ä»¥åŠ&lt;code&gt;auth.go&lt;/code&gt;çš„æ³¨é‡Šè‡ªåŠ¨ç”Ÿæˆ&lt;code&gt;config&lt;/code&gt;ç›®å½•ä¸‹çš„å…¶ä»–æ–‡ä»¶:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;adapter.auth.config.pb.html&lt;/li&gt;
&lt;li&gt;auth-adapter.yaml&lt;/li&gt;
&lt;li&gt;config.pb.go&lt;/li&gt;
&lt;li&gt;config.proto_descriptor&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ ¹æ®&lt;code&gt;auth.go&lt;/code&gt;çš„ä»¥ä¸‹æ³¨é‡Šï¼Œ&lt;code&gt;mixer_codegen.sh&lt;/code&gt;ä½¿ç”¨&lt;code&gt;authorization&lt;/code&gt;æ¨¡æ¿ç”Ÿæˆ&lt;code&gt;name&lt;/code&gt;ä¸º&lt;code&gt;auth-adapter&lt;/code&gt;çš„é€‚é…å™¨&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// nolint:lll
// Generates the auth adapter&#39;s resource yaml. It contains the adapter&#39;s configuration, name, supported template
// names (metric in this case), and whether it is session or no-session based.
//go:generate $GOPATH/src/istio.io/istio/bin/mixer_codegen.sh -a mixer/adapter/auth/config/config.proto -x &amp;quot;-s=false -n auth-adapter -t authorization&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;h3 id=&#34;5-æœ¬åœ°æµ‹è¯•&#34;&gt;5.æœ¬åœ°æµ‹è¯•&lt;/h3&gt;

&lt;p&gt;æœ¬åœ°æµ‹è¯•ä½¿ç”¨testdataä¸‹çš„é…ç½®ï¼Œå…¶ä¸­&lt;code&gt;operator-cfg.yaml&lt;/code&gt;æœ‰å‡ å¤„ä¸æ­£å¼éƒ¨ç½²ä¸åŒï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;handler&lt;/code&gt;çš„&lt;code&gt;address&lt;/code&gt;ä½¿ç”¨æœ¬åœ°æœåŠ¡&lt;code&gt;&amp;quot;[::]:44225&amp;quot;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;ä¸ºäº†æ–¹ä¾¿æµ‹è¯•&lt;code&gt;instance&lt;/code&gt;çš„&lt;code&gt;params&lt;/code&gt;å‚æ•°ä»¥åŠ&lt;code&gt;rule&lt;/code&gt;çš„&lt;code&gt;math&lt;/code&gt;æ¡ä»¶åšäº†ç®€åŒ–&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# å¯åŠ¨é€‚é…å™¨æœåŠ¡
go run cmd/main.go 44225

# ä½¿ç”¨testdataä¸‹é…ç½®å¯åŠ¨mixer server
$GOPATH/out/darwin_amd64/release/mixs server \
--configStoreURL=fs://$GOPATH/src/istio.io/istio/mixer/adapter/auth/testdata \
--log_output_level=default:debug,attributes:debug

# æµ‹è¯•Adapteræ˜¯å¦ç”Ÿæ•ˆ
$GOPATH/out/darwin_amd64/release/mixc check -s request.host=&amp;quot;localhost&amp;quot; --stringmap_attributes &amp;quot;request.headers=x-custom-token:efg&amp;quot;
# Check RPC completed successfully. Check status was PERMISSION_DENIED (mm-example-auth.handler.istio-system:Unauthorized...)

$GOPATH/out/darwin_amd64/release/mixc check -s request.host=&amp;quot;localhost&amp;quot; --stringmap_attributes &amp;quot;request.headers=x-custom-token:abc&amp;quot;
# Check RPC completed successfully. Check status was OK
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;NOTE:å‡ºç°é¢„æœŸç»“æœä¸ä¸€è‡´å¯èƒ½æ˜¯ç”±äºmixer cacheå¯¼è‡´&lt;code&gt;Valid use count: 10000, valid duration: 9.726875254s&lt;/code&gt;ï¼Œè¯·å‚è€ƒ&lt;a href=&#34;http://www.servicemesher.com/categories/istio-mixer-cache&#34;&gt;Istio Mixer Cache&lt;/a&gt;ç³»åˆ—æ–‡ç« äº†è§£&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&#34;6-æ‰“åŒ…é•œåƒ&#34;&gt;6.æ‰“åŒ…é•œåƒ&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# buildæ‰§è¡Œæ–‡ä»¶
CGO_ENABLED=0 GOOS=linux \
    go build -a -installsuffix cgo -v -o bin/auth ./cmd/
    
# dockeré•œåƒ
docker build -t hbchen/micro-mesh-example-adapter-auth:v0.0.1 .
docker push hbchen/micro-mesh-example-adapter-auth:v0.0.1
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;7-istioç¯å¢ƒéƒ¨ç½²&#34;&gt;7.Istioç¯å¢ƒéƒ¨ç½²&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;éƒ¨ç½²ç¯å¢ƒ&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;GKE &lt;strong&gt;1.12.5-gke.10&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;Istio &lt;strong&gt;1.1.0&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# å±æ€§ã€æ¨¡æ¿
# attributes.yaml -&amp;gt; istio/mixer/testdata/config/attributes.yaml 
# template.yaml -&amp;gt; istio/mixer/template/authorization/template.yaml
kubectl apply -f examples/adapter/auth/testdata/attributes.yaml -f examples/adapter/auth/testdata/template.yaml

# é€‚é…å™¨
kubectl apply -f examples/adapter/auth/config/auth-adapter.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;è¿™é‡Œæ˜¯ä»¥&lt;a href=&#34;https://github.com/hb-go/micro-mesh&#34;&gt;micro-mesh&lt;/a&gt;ç¤ºä¾‹ä¸ºåŸºç¡€çš„é…ç½®ï¼Œå¦‚æœä½¿ç”¨&lt;code&gt;bookinfo&lt;/code&gt;æˆ–è€…è‡ªå·±çš„æœåŠ¡éœ€è¦åšç›¸åº”çš„ä¿®æ”¹&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;code&gt;operator-cfg.yaml&lt;/code&gt;ä¸æœ¬åœ°æµ‹è¯•é…ç½®ä¸åŒï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;handler&lt;/code&gt;çš„&lt;code&gt;address&lt;/code&gt;ä½¿ç”¨é›†ç¾¤æœåŠ¡&lt;code&gt;&amp;quot;mm-example-auth-adapter-service:44225&amp;quot;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;instance&lt;/code&gt;çš„&lt;code&gt;params&lt;/code&gt;æ ¹æ®&lt;code&gt;authorization&lt;/code&gt;æ¨¡æ¿åŠ&lt;code&gt;auth-adapter&lt;/code&gt;æœåŠ¡çš„éœ€æ±‚é…ç½®&lt;/li&gt;
&lt;li&gt;&lt;code&gt;rule&lt;/code&gt;çš„&lt;code&gt;match&lt;/code&gt;æ¡ä»¶ä½¿ç”¨&lt;code&gt;destination.service.name == &amp;quot;mm-example-api&amp;quot;&lt;/code&gt;æˆ–&lt;code&gt;destination.service.host == &amp;quot;mm-example-api.default.svc.cluster.local&amp;quot;&lt;/code&gt;ï¼Œä»…å¯¹&lt;code&gt;mm-example-api&lt;/code&gt;æœåŠ¡ç”Ÿæ•ˆ&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# é€‚é…å™¨æœåŠ¡å®ä¾‹éƒ¨ç½²
kubectl apply -f examples/adapter/auth/operatorconfig/cluster-service.yaml

# é€‚é…å™¨é…ç½®
kubectl apply -f examples/adapter/auth/operatorconfig/operator-cfg.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;8-istioç¯å¢ƒéƒ¨ç½²æµ‹è¯•&#34;&gt;8.Istioç¯å¢ƒéƒ¨ç½²æµ‹è¯•&lt;/h3&gt;

&lt;blockquote&gt;
&lt;p&gt;å¦‚æœæ²¡æœ‰å¼€Gatewayçš„JWTéªŒè¯å¯ä»¥å¿½ç•¥&lt;code&gt;Authorization&lt;/code&gt;ï¼Œå…¶å®åšäº†è‡ªå®šä¹‰Authåæ˜¯å¤šä½™çš„ğŸ˜‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;TOKEN=$(curl https://raw.githubusercontent.com/istio/istio/release-1.1/security/tools/jwt/samples/demo.jwt -s)

curl -H &amp;quot;Authorization: Bearer $TOKEN&amp;quot; -H &amp;quot;x-custom-token: efg&amp;quot; -H &amp;quot;Grpc-Metadata-x-tier: 2&amp;quot; -X GET http://35.192.111.18/v1/example/call/Hobo
curl -H &amp;quot;Authorization: Bearer $TOKEN&amp;quot; -H &amp;quot;x-custom-token: abc&amp;quot; -H &amp;quot;Grpc-Metadata-x-tier: 2&amp;quot; -X GET http://35.192.111.18/v1/example/call/Hobo

&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/istio/istio/wiki/Mixer-Out-of-Process-Adapter-Walkthrough&#34;&gt;Mixer Out of Process Adapter Walkthrough&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://medium.com/google-cloud/simple-istio-mixer-out-of-process-authorization-adapter-5f9363cd9bbc&#34;&gt;Simple Istio Mixer Out of Process Authorization Adapter&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
      
    </item>
    
    <item>
      <title>go-microåŠ å…¥IstioæœåŠ¡ç½‘æ ¼</title>
      <link>http://hbchen.com/post/2019-01-08-go-micro%E5%8A%A0%E5%85%A5istio%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/</link>
      <pubDate>Thu, 21 Feb 2019 16:59:37 +0800</pubDate>
      
      <guid>http://hbchen.com/post/2019-01-08-go-micro%E5%8A%A0%E5%85%A5istio%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/</guid>
      
        <description>&lt;p&gt;å°†go-microæœåŠ¡åŠ å…¥service meshï¼ŒClientã€Serverä¸éœ€è¦Registryã€Selectorã€Transportç­‰ï¼Œé€šè¿‡è‡ªå®šä¹‰microçš„server &amp;amp; clientæ’ä»¶ï¼Œå»æ‰åœ¨istioä¸­ä¸éœ€è¦çš„ç»„ä»¶ä¾èµ–ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/hb-go/micro/master/doc/img/micro-istio.png&#34; alt=&#34;go-micro&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/hb-go/micro-plugins&#34;&gt;hb-go/micro-plugins&lt;/a&gt;å®ç°äº†gRPCã€httpçš„Istioç‰ˆæœ¬Pluginï¼Œä¸‹é¢ä»‹ç»å¦‚ä½•ä½¿ç”¨ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å®Œæ•´ç¤ºä¾‹å‚è€ƒ&lt;a href=&#34;https://github.com/hb-go/micro/tree/master/istio&#34;&gt;hb-go/micro/istio&lt;/a&gt;ï¼Œç¤ºä¾‹åŒ…æ‹¬httpã€gRPC&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h5 id=&#34;å‘½ä»¤è¡Œå‚æ•°&#34;&gt;å‘½ä»¤è¡Œå‚æ•°&lt;/h5&gt;

&lt;p&gt;æ–¹ä¾¿æœåŠ¡è¿è¡Œæ—¶æŒ‡å®šç«¯å£ï¼Œåœ¨å‘½ä»¤è¡Œè·å–æœåŠ¡serverã€clientç«¯å£é…ç½®ï¼Œå‚æ•°æ ¹æ®å…·ä½“æƒ…å†µè‡ªè¡Œè®¾è®¡&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;åœ¨æœåŠ¡ç½‘æ ¼ä¸­æˆ‘å€¾å‘ç»Ÿä¸€ä¸Šä¸‹æ¸¸æœåŠ¡ç«¯å£ï¼Œé¿å…ä¸å¿…è¦çš„é…ç½®ä»¥åŠå› æ­¤å¼•å‘çš„å†²çªé—®é¢˜&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
&lt;li&gt;Clientç«¯æœåŠ¡åœ°å€&lt;code&gt;CallOptions.Address&lt;/code&gt;è§£æè§„åˆ™ï¼š

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;:&lt;/code&gt;å¼€å¤´ï¼Œå°†&lt;code&gt;service.Name&lt;/code&gt;ä¸­&lt;code&gt;.&lt;/code&gt;æ›¿æ¢ä¸º&lt;code&gt;-&lt;/code&gt;ï¼ŒåŠ &lt;code&gt;CallOptions.Address&lt;/code&gt;ï¼Œå¦‚&lt;code&gt;go.micro.api.sample&lt;/code&gt; &lt;code&gt;:9080&lt;/code&gt; =&amp;gt; &lt;code&gt;go-micro-api-sample:9080&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;é&lt;code&gt;:&lt;/code&gt;å¼€å¤´ï¼Œå›ºå®šåœ°å€&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;var (
	serverAddr string
	callAddr   string
	cmdHelp    bool
)

func init() {
	flag.StringVar(&amp;amp;serverAddr, &amp;quot;server_address&amp;quot;, &amp;quot;0.0.0.0:9080&amp;quot;, &amp;quot;server address.&amp;quot;)
	flag.StringVar(&amp;amp;callAddr, &amp;quot;client_call_address&amp;quot;, &amp;quot;:9080&amp;quot;, &amp;quot;client call options address.&amp;quot;)
	flag.Parse()
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;è‡ªå®šä¹‰server-clientæ’ä»¶-åˆ›å»ºæœåŠ¡&#34;&gt;è‡ªå®šä¹‰serverã€clientæ’ä»¶ï¼Œåˆ›å»ºæœåŠ¡&lt;/h5&gt;

&lt;blockquote&gt;
&lt;p&gt;ç”±äºmicroæ¡†æ¶å¯¹å‘½ä»¤è¡Œçš„è§£æé—®é¢˜ï¼Œåˆ›å»ºæœåŠ¡æ—¶éœ€è¦å¢åŠ &lt;code&gt;micro.Flags(...)&lt;/code&gt;ï¼Œå…¼å®¹è‡ªå®šä¹‰å‚æ•°ï¼Œå¦‚:&lt;code&gt;client_call_address&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;import (
	httpClient &amp;quot;github.com/hb-go/micro-plugins/client/istio_http&amp;quot;
	httpServer &amp;quot;github.com/hb-go/micro-plugins/server/istio_http&amp;quot;
)

func main() {
	c := httpClient.NewClient(
		client.ContentType(&amp;quot;application/json&amp;quot;),
		func(o *client.Options) {
			o.CallOptions.Address = callAddr
		},
	)
	s := httpServer.NewApiServer(
		server.Address(serverAddr),
	)

	// New Service
	service := micro.NewService(
		micro.Name(&amp;quot;go.micro.api.sample&amp;quot;),
		micro.Version(&amp;quot;latest&amp;quot;),
		micro.Registry(noop.NewRegistry()),
		micro.Client(c),
		micro.Server(s),

		// å…¼å®¹micro cmd parse
		micro.Flags(cli.StringFlag{
			Name:   &amp;quot;client_call_address&amp;quot;,
			EnvVar: &amp;quot;MICRO_CLIENT_CALL_ADDRESS&amp;quot;,
			Usage:  &amp;quot; Invalid!!!&amp;quot;,
		}),
	)

	service.Options().Cmd.Init()
	
	// â€¦â€¦
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;æœåŠ¡éƒ¨ç½²-yaml&#34;&gt;æœåŠ¡éƒ¨ç½².yaml&lt;/h5&gt;

&lt;blockquote&gt;
&lt;p&gt;å…¶å®ƒIstioç›¸å…³.yamlå‚è€ƒå®Œæ•´ç¤ºä¾‹&lt;a href=&#34;https://github.com/hb-go/micro/tree/master/istio/k8s&#34;&gt;hb-go/micro/istio/k8s&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;######################################################################################
# API service
######################################################################################
apiVersion: v1
kind: Service
metadata:
  name: go-micro-api-sample
  labels:
    app: go-micro-api-sample
spec:
  ports:
  - port: 9080
    name: http
  selector:
    app: go-micro-api-sample
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: go-micro-api-sample-v1
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: go-micro-api-sample
        version: v1
    spec:
      containers:
      - name: go-micro-api-sample
        command: [
          &amp;quot;/sample&amp;quot;,
          &amp;quot;-server_address=0.0.0.0:9080&amp;quot;,
          &amp;quot;-client_call_address=:9080&amp;quot;,
        ]
        image: hbchen/go-micro-istio-api-sample:v0.0.5
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9080
---
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>Spark &#43; Elasticsearchæ„å»ºæ¨èç³»ç»Ÿ</title>
      <link>http://hbchen.com/post/2018-10-24-spark-elasticsearch-recommender/</link>
      <pubDate>Wed, 24 Oct 2018 16:23:46 +0800</pubDate>
      
      <guid>http://hbchen.com/post/2018-10-24-spark-elasticsearch-recommender/</guid>
      
        <description>&lt;p&gt;Github &lt;a href=&#34;https://github.com/hb-chen/spark-elasticsearch-recommender&#34;&gt;hb-chen/spark-elasticsearch-recommender&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Zeppelin &lt;code&gt;0.8.0&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Spark &lt;code&gt;2.3.2&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Elasticsearch &lt;code&gt;6.3.2&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;1-ç¯å¢ƒå‡†å¤‡&#34;&gt;1.ç¯å¢ƒå‡†å¤‡&lt;/h4&gt;

&lt;blockquote&gt;
&lt;p&gt;Mac OSX&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h5 id=&#34;zeppeline&#34;&gt;Zeppeline&lt;/h5&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# http://www.apache.org/dyn/closer.cgi/zeppelin/zeppelin-0.8.0/zeppelin-0.8.0-bin-netinst.tgz
$ wget http://mirrors.shu.edu.cn/apache/zeppelin/zeppelin-0.8.0/zeppelin-0.8.0-bin-netinst.tgz
$ tar -zxf zeppelin-0.8.0-bin-netinst.tgz
$ cd zeppelin-0.8.0-bin-netinst

# å®‰è£…å¿…è¦interpreter
$ ./bin/install-interpreter.sh --name md,elasticsearch
$ ./bin/zeppelin-daemon.sh start
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;spark&#34;&gt;Spark&lt;/h5&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# http://spark.apache.org/downloads.html
$ wget https://www.apache.org/dyn/closer.lua/spark/spark-2.3.2/spark-2.3.2-bin-hadoop2.7.tgz
$ tar -zxf spark-2.3.2-bin-hadoop2.7.tgz
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;elasticsearch&#34;&gt;Elasticsearch&lt;/h5&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# https://www.elastic.co/downloads/past-releases
# Elasticsearch + 6.3.2
$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.3.2.zip
$ unzip elasticsearch-6.3.2.zip

# ES-Hadoop + 6.3.2
$ wget https://artifacts.elastic.co/downloads/elasticsearch-hadoop/elasticsearch-hadoop-6.3.2.zip
$ unzip elasticsearch-hadoop-6.3.2.zip
&lt;/code&gt;&lt;/pre&gt;

&lt;h6 id=&#34;elasticsearch-çŸ¢é‡è¯„åˆ†æ’ä»¶&#34;&gt;Elasticsearch çŸ¢é‡è¯„åˆ†æ’ä»¶&lt;/h6&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/muhleder/elasticsearch-vector-scoring&#34;&gt;muhleder/elasticsearch-vector-scoring&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# ä¿®æ”¹build.gradleï¼Œè¿™æ ·ä¸å¿…Checkout Elasticsearch 
# https://github.com/muhleder/elasticsearch-vector-scoring/issues/1#issuecomment-415267767
buildscript {
  repositories {
    jcenter()
    mavenLocal()
  }
  dependencies {
    classpath &amp;quot;org.elasticsearch.gradle:build-tools:6.3.2&amp;quot;
  }
}

apply plugin: &#39;idea&#39;
apply plugin: &#39;java&#39;
apply plugin: &#39;elasticsearch.esplugin&#39;

licenseFile = rootProject.file(&#39;LICENSE&#39;)
noticeFile = rootProject.file(&#39;NOTICE&#39;)

esplugin {
  name &#39;elasticsearch-vector-scoring&#39;
  description &#39;Provides a fast vector multiplication script.&#39;
  classname &#39;com.gosololaw.elasticsearch.VectorScoringPlugin&#39;
}

dependencies {
  compile &amp;quot;org.elasticsearch:elasticsearch:6.3.2&amp;quot;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# æ’ä»¶å®‰è£…
$ ./bin/elasticsearch-plugin install {file:///path/to/plugin.zip}
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;pythonä¾èµ–åº“&#34;&gt;Pythonä¾èµ–åº“&lt;/h5&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ pip install elasticsearch
$ pip install numpy
$ pip install tmdbsimple # å¿½ç•¥ï¼Œæš‚æ—¶æœªä½¿ç”¨
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;movielensæ•°æ®é›†-https-grouplens-org-datasets-movielens-ä¸‹è½½&#34;&gt;&lt;a href=&#34;https://grouplens.org/datasets/movielens/&#34;&gt;Movielensæ•°æ®é›†&lt;/a&gt;ä¸‹è½½&lt;/h5&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cd data # ä¸zeppelin-0.8.0-bin-netinståŒPathï¼Œnoteä¸­é…ç½®PATH_TO_DATA = &amp;quot;../data/ml-latest-small&amp;quot;
$ wget http://files.grouplens.org/datasets/movielens/ml-latest-small.zip
$ unzip ml-latest-small.zip
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;2-å¯åŠ¨æœåŠ¡&#34;&gt;2.å¯åŠ¨æœåŠ¡&lt;/h4&gt;

&lt;h5 id=&#34;elasticsearchå¯åŠ¨&#34;&gt;Elasticsearchå¯åŠ¨&lt;/h5&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ./bin/elasticsearch
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;zeppeliné…ç½®åŠå¯åŠ¨&#34;&gt;Zeppeliné…ç½®åŠå¯åŠ¨&lt;/h5&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cp conf/shiro.ini.template conf/shiro.ini
$ vim conf/shiro.ini
# ç®¡ç†å‘˜è´¦æˆ·å¯†ç 
[users]
admin = 123456, admin

$ cp conf/zeppelin-env.sh.template conf/zeppelin-env.sh
$ vim conf/zeppelin-env.sh
# Sparké…ç½®
export SPARK_HOME=/{apache-spark-path}/spark-2.3.2-bin-hadoop2.7
export SPARK_SUBMIT_OPTIONS=&amp;quot;--driver-memory 2G&amp;quot;

$ cp conf/zeppelin-site.xml.template conf/zeppelin-site.xml
$ vim conf/zeppelin-site.xml
# æ ¹æ®éœ€è¦å¯ä»¥ä¿®æ”¹zeppelin.server.portç­‰é…ç½®

# å¯åŠ¨
$ ./bin/zeppelin-daemon.sh start
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;3-notebook&#34;&gt;3.Notebook&lt;/h4&gt;

&lt;p&gt;&lt;a href=&#34;http://localhost:8080&#34;&gt;http://localhost:8080&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# Create new interpreter
# md

# elasticsearch
elasticsearch.client.type http
elasticsearch.port	9200

# spark
# æ·»åŠ Dependencies
artifact /{elasticsearch-hadoop-path}/elasticsearch-hadoop-6.3.2/dist/elasticsearch-spark-20_2.11-6.3.2.jar
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/IBM/elasticsearch-spark-recommender&#34;&gt;ä½¿ç”¨ Apache Spark å’Œ Elasticsearch æ„å»ºä¸€ä¸ªæ¨èç³»ç»Ÿ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
      
    </item>
    
  </channel>
</rss>