<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>HB-æŠ€æœ¯å®è·µ</title>
    <link>http://hbchen.com/</link>
    <description>Recent content on HB-æŠ€æœ¯å®è·µ</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <copyright>HB Studio &lt;a href=&#34;https://beian.miit.gov.cn/&#34; target=&#34;_blank&#34;&gt;èœ€ICPå¤‡18021614å·-1&lt;/a&gt;</copyright>
    <lastBuildDate>Sun, 20 Aug 2017 21:38:52 +0800</lastBuildDate>
    
        <atom:link href="http://hbchen.com/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>About</title>
      <link>http://hbchen.com/about/</link>
      <pubDate>Sun, 20 Aug 2017 21:38:52 +0800</pubDate>
      
      <guid>http://hbchen.com/about/</guid>
      
        <description>

&lt;h2 id=&#34;about&#34;&gt;About&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/micro-in-cn&#34;&gt;Microä¸­å›½ç«™&lt;/a&gt;æˆå‘˜&lt;/li&gt;
&lt;li&gt;Golangã€PHPã€Objective-C&amp;hellip; ä¸€çº¿ç å†œï¼Œå…¨æ ˆæ¶æ„&lt;/li&gt;
&lt;li&gt;ä¸“æ³¨äºå¾®æœåŠ¡æ¶æ„ä¸æœåŠ¡ç½‘æ ¼çš„åº”ç”¨&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;github&#34;&gt;GitHub&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;go-microå®è·µ &lt;a href=&#34;https://github.com/micro-in-cn/starter-kit&#34;&gt;micro-in-cn/starter-kit&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Echoå®è·µ &lt;a href=&#34;https://github.com/hb-go/echo-web&#34;&gt;hb-go/echo-web&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Istioå¾®æœåŠ¡æ¶æ„å®è·µ &lt;a href=&#34;https://github.com/hb-go/micro-mesh&#34;&gt;hb-go/micro-mesh&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;More &lt;a href=&#34;https://github.com/hb-chen&#34;&gt;GitHub&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;å¾®ä¿¡&#34;&gt;å¾®ä¿¡&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/wechat.jpg&#34; alt=&#34;å¾®ä¿¡&#34; /&gt;&lt;/p&gt;
</description>
      
    </item>
    
    <item>
      <title>ã€Tektonã€‘Golang CI/CD å®è·µ</title>
      <link>http://hbchen.com/post/devops/2021-08-09-tekton-golang/</link>
      <pubDate>Mon, 09 Aug 2021 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/devops/2021-08-09-tekton-golang/</guid>
      
        <description>&lt;p&gt;æ¥ä¸Šä¸€ç¯‡ &lt;a href=&#34;http://hbchen.com/post/devops/2021-03-28-tekton-install/&#34;&gt;ã€Tektonã€‘ç»„ä»¶ä»‹ç»åŠå®‰è£…éƒ¨ç½²&lt;/a&gt;ï¼Œæœ¬æ–‡ä»‹ç»å¦‚ä½•ä½¿ç”¨ Tekton å®Œæˆ CI/CD çš„å…¨æµç¨‹ï¼ŒåŒ…æ‹¬ WebHookã€ä»£ç æ‹‰å–ã€go testã€go buildã€docker build and pushã€helm/kubectl k8s éƒ¨ç½²ï¼Œå…¶ä¸­æ¶‰åŠ Git/é•œåƒä»“åº“çš„ Basic è®¤è¯ã€kubeconfigã€ä»¥åŠ go mod ç¼“å­˜å’Œå¤šé¡¹ç›®ç›®å½•ç»“æ„ç­‰å®è·µå†…å®¹ã€‚&lt;/p&gt;

&lt;p&gt;é¦–å…ˆçœ‹ä¸‹æœ¬æ–‡å®è·µçš„ CI/CD å…¨éƒ¨æµç¨‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-mermaid&#34;&gt;graph LR
	G(GitHub) --webhook--&amp;gt; EL(EventListener&amp;lt;br&amp;gt;Multi Repo)
	
	subgraph Tekton
	EL --trigger--&amp;gt; P(Pipelines)
  end
  
  P --deploy--&amp;gt; k8s(Kubernetes)
  
  style EL fill:#fbf
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;Pipelines&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-mermaid&#34;&gt;graph LR
	git(Git Clone&amp;lt;br&amp;gt;GitHub) --&amp;gt; test(Go Test)
  test --&amp;gt; build(Go Build)
  build --&amp;gt; docker(Docker Build&amp;lt;br&amp;gt;é•œåƒä»“åº“)
  docker --&amp;gt; deploy(Deploy&amp;lt;br&amp;gt;Helm/Kubectl)  
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;ç¤ºä¾‹æºç ï¼š&lt;a href=&#34;https://github.com/hb-chen/tekton-practice&#34;&gt;github.com/hb-chen/tekton-practice&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;å†…å®¹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;GitHub ä»“åº“é€šè¿‡ Webhook è§¦å‘æµæ°´çº¿&lt;/li&gt;
&lt;li&gt;æ”¯æŒå¤šé¡¹ç›®æ„å»º&lt;/li&gt;
&lt;li&gt;å¤šä¸ªé¡¹ç›®å…±ç”¨ PVCï¼Œé€šè¿‡å­ç›®å½•åŒºåˆ†&lt;/li&gt;
&lt;li&gt;EventListener æ¥æ”¶ Webhook åæ ¹æ® Repo ä¿¡æ¯åŒºåˆ†é¡¹ç›®ï¼Œå¹¶è§¦å‘ä¸åŒçš„ Pipeline&lt;/li&gt;
&lt;li&gt;æµæ°´çº¿å®Œæˆä»“åº“çš„ å…‹éš†ã€testã€buildã€é•œåƒæ„å»ºã€å‘å¸ƒåˆ° K8S å¹³å°&lt;/li&gt;
&lt;li&gt;æŒ‡å®š go mod ç›®å½•ï¼Œé¿å…æ¯æ¬¡é‡æ–°æ‹‰å–ä¾èµ–ï¼Œåšæ„å»ºç¼“å­˜&lt;/li&gt;
&lt;li&gt;ç§˜é’¥é…ç½®

&lt;ul&gt;
&lt;li&gt;Webhook ç§˜é’¥é…ç½®&lt;/li&gt;
&lt;li&gt;Git ä»“åº“ Basic è®¤è¯&lt;/li&gt;
&lt;li&gt;Docker Hub &lt;code&gt;config.json&lt;/code&gt; è®¤è¯&lt;/li&gt;
&lt;li&gt;K8S kubeConfig&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;webhook-è§¦å‘å™¨&#34;&gt;Webhook è§¦å‘å™¨&lt;/h2&gt;

&lt;p&gt;é¦–å…ˆä» Trigger å¼€å§‹ï¼Œè§¦å‘å™¨å¯¹åº”çš„ &lt;code&gt;CRD&lt;/code&gt; ä¸º &lt;code&gt;EventListener&lt;/code&gt;ï¼Œç”± &lt;code&gt;TriggerController&lt;/code&gt; è´Ÿè´£ &lt;code&gt;EL&lt;/code&gt; å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œ&lt;code&gt;EL&lt;/code&gt; ä¸ºæ¥æ”¶ Webhook çš„æœåŠ¡ã€‚ç›¸å…³çš„ &lt;code&gt;CRD&lt;/code&gt; è¿˜æœ‰ &lt;code&gt;TriggerBinding&lt;/code&gt; å’Œ&lt;code&gt;TriggerTemplate&lt;/code&gt;ï¼Œ&lt;code&gt;TriggerBinding&lt;/code&gt; ç”¨äºå°† Webhook è¯·æ±‚çš„æ•°æ®æ˜ å°„åˆ° &lt;code&gt;TriggerTemplate&lt;/code&gt; çš„è¾“å…¥å‚æ•°ï¼›&lt;code&gt;TriggerTemplate&lt;/code&gt; åˆ™ç”¨äºå®šä¹‰è§¦å‘å™¨æ‰€è¦è¿è¡Œçš„æµæ°´çº¿ï¼Œæœ‰å…³ Triiger çš„æ–‡æ¡£å‚è€ƒ &lt;a href=&#34;https://tekton.dev/docs/triggers/&#34;&gt;Triggers and EventListeners&lt;/a&gt;ã€‚å…·ä½“ &lt;code&gt;CRD&lt;/code&gt; å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;kind: Secret&lt;/code&gt;: &lt;code&gt;github-secret&lt;/code&gt; å®šä¹‰ Webhook æ¥å£æ‰€éœ€è¦çš„ç§˜é’¥&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;kind: EventListener&lt;/code&gt;: &lt;code&gt;github-listener-interceptor&lt;/code&gt; ä¸»è¦åœ¨ &lt;code&gt;triggers&lt;/code&gt; ä¸­åˆ†åˆ«å®šä¹‰ä¸¤ä¸ª GitHub é¡¹ç›®çš„ trigger&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;interceptors&lt;/code&gt; ä¸­ç”¨ &lt;code&gt;github&lt;/code&gt; å…³è”äº† Webhook éœ€è¦çš„ &lt;code&gt;secret&lt;/code&gt;ï¼Œç”¨ &lt;code&gt;cel.filter&lt;/code&gt; è¿‡æ»¤æŒ‡å®šé¡¹ç›®çš„ Repoï¼Œç”¨äºæµ‹è¯•çš„ä¸¤ä¸ªç”¨ä¾‹åˆ†åˆ«ä¸º &lt;a href=&#34;https://github.com/hb-chen/gateway&#34;&gt;hb-chen/gateway&lt;/a&gt; å’Œ &lt;a href=&#34;https://github.com/hb-chen/gmqtt&#34;&gt;hb-chen/gmqtt&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;template&lt;/code&gt; å’Œ &lt;code&gt;bindings&lt;/code&gt; åˆ†åˆ«ç”¨äºå…³è” &lt;code&gt;TriggerTemplate&lt;/code&gt; å’Œ &lt;code&gt;TriggerBinding&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;blockquote&gt;
&lt;p&gt;Trigger ä¹Ÿå¯ä»¥é€šè¿‡å•ç‹¬ CRD æ¥å®šä¹‰ï¼Œç”¨ &lt;code&gt;triggerRef&lt;/code&gt; æ¥å…³è”&lt;/p&gt;
&lt;/blockquote&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;kind: TriggerBinding&lt;/code&gt;: ä»…ä» body ä¸­è·å–äº† Repo åœ°å€ï¼Œæ›´å¤šä¿¡æ¯å¯ä»¥æ ¹æ® Template çš„éœ€æ±‚æƒ…å†µè¿›è¡Œç»‘å®š&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;kind: TriggerTemplate&lt;/code&gt;: åˆ†åˆ«å®šä¹‰äº†ä¸¤ä¸ªé¡¹ç›®çš„æµæ°´çº¿æ¨¡æ¿ï¼Œåœ¨è§¦å‘å™¨å‡ºå‘åä½¿ç”¨ &lt;code&gt;resourcetemplates&lt;/code&gt; åˆ›å»ºèµ„æºï¼Œå¹¶å¯ä»¥é€šè¿‡ &lt;code&gt;params&lt;/code&gt; å®šä¹‰æ¨¡æ¿å‚æ•°ï¼Œç»“åˆ &lt;code&gt;TriggerBinding&lt;/code&gt; ä¾¿å¯ä»¥è·å– Webhook æ¥å£ Request ä¸­çš„ä¿¡æ¯&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;---
apiVersion: v1
kind: Secret
metadata:
  name: github-secret
type: Opaque
stringData:
  secretToken: &amp;quot;123456&amp;quot;
---
apiVersion: triggers.tekton.dev/v1alpha1
kind: EventListener
metadata:
  name: github-listener-interceptor
spec:
  triggers:
    - name: github-gateway-listener
      interceptors:
        - github:
            secretRef:
              secretName: github-secret
              secretKey: secretToken
            eventTypes:
        # CEL è¿‡æ»¤æˆ–æ‰©å±• Event
        - cel:
            filter: &amp;quot;body.repository.full_name in [&#39;hb-chen/gateway&#39;]&amp;quot;
      bindings:
        - ref: pipeline-binding
      template:
        ref: grpc-gateway-pipeline-template
    - name: github-gmqtt-listener
      interceptors:
        - github:
            secretRef:
              secretName: github-secret
              secretKey: secretToken
            eventTypes:
        # CEL è¿‡æ»¤æˆ–æ‰©å±• Event
        - cel:
            filter: &amp;quot;body.repository.full_name in [&#39;hb-chen/gmqtt&#39;]&amp;quot;
      bindings:
        - ref: pipeline-binding
      template:
        ref: gmqtt-pipeline-template
  resources:
    kubernetesResource:
      spec:
        template:
          spec:
            serviceAccountName: tekton-triggers-example-sa
            containers:
              - resources:
                  requests:
                    memory: &amp;quot;64Mi&amp;quot;
                    cpu: &amp;quot;250m&amp;quot;
                  limits:
                    memory: &amp;quot;128Mi&amp;quot;
                    cpu: &amp;quot;500m&amp;quot;
---
apiVersion: triggers.tekton.dev/v1alpha1
kind: TriggerBinding
metadata:
  name: pipeline-binding
spec:
  params:
    - name: gitrepositoryurl
      value: $(body.repository.clone_url)
---
apiVersion: triggers.tekton.dev/v1alpha1
kind: TriggerTemplate
metadata:
  name: grpc-gateway-pipeline-template
spec:
  params:
    - name: gitrevision
      description: The git revision
      default: master
    - name: gitrepositoryurl
      description: The git repository url
  resourcetemplates:
    - apiVersion: tekton.dev/v1beta1
      kind: PipelineRun
      metadata:
        generateName: grpc-gateway-pipeline-run-
      spec:
        serviceAccountName: build-bot
        pipelineRef:
          name: grpc-gateway-pipeline
        workspaces:
          - name: shared-workspace
            persistentvolumeclaim:
              claimName: golang-source-pvc
          - name: dockerconfig
            secret:
              secretName: dockerconfig
          - name: kubeconfig
            secret:
              secretName: k8s-kubeconfig
        params:
          - name: url
            value: $(tt.params.gitrepositoryurl)
          - name: revision
            value: $(tt.params.gitrevision)
---
apiVersion: triggers.tekton.dev/v1alpha1
kind: TriggerTemplate
metadata:
  name: gmqtt-pipeline-template
spec:
  params:
    - name: gitrevision
      description: The git revision
      default: master
    - name: gitrepositoryurl
      description: The git repository url
  resourcetemplates:
    - apiVersion: tekton.dev/v1beta1
      kind: PipelineRun
      metadata:
        generateName: gmqtt-pipeline-run-
      spec:
        serviceAccountName: build-bot
        pipelineRef:
          name: gmqtt-pipeline
        workspaces:
          - name: shared-workspace
            persistentvolumeclaim:
              claimName: golang-source-pvc
          - name: dockerconfig
            secret:
              secretName: dockerconfig
          - name: kubeconfig
            secret:
              secretName: k8s-kubeconfig
        params:
          - name: url
            value: $(tt.params.gitrepositoryurl)
          - name: revision
            value: $(tt.params.gitrevision)
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;rbac&#34;&gt;RBAC&lt;/h3&gt;

&lt;p&gt;å‰é¢æœ‰äº† Trigger ç›¸å…³çš„èµ„æºï¼Œæœ€åè¿˜ç¼ºä¸€ä¸ª &lt;code&gt;ServiceAccount&lt;/code&gt; ï¼Œå¹¶ä¸”éœ€è¦åšç›¸åº”çš„ &lt;code&gt;RBAC&lt;/code&gt; æˆæƒï¼Œä¸»è¦åŒ…æ‹¬ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;triggers.tekton.dev&lt;/code&gt; ç›¸å…³ &lt;code&gt;CRD&lt;/code&gt; èµ„æºè·å–&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;å…è®¸åˆ›å»ºçš„ &lt;code&gt;CRD&lt;/code&gt; èµ„æº&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&amp;gt; Trigger æ˜¯ Tekton çš„ä¸€ä¸ªç‹¬ç«‹ç»„ä»¶ï¼Œ&lt;code&gt;TriggerTemplate&lt;/code&gt; å¯ä»¥ç”¨æ¥åˆ›å»ºå„ç±» &lt;code&gt;CRD&lt;/code&gt; èµ„æºï¼Œè‡ªç„¶è¦æœ‰ç›¸åº”èµ„æºçš„ &lt;code&gt;create&lt;/code&gt; æƒé™æ‰è¡Œ&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: v1
kind: ServiceAccount
metadata:
  name: tekton-triggers-example-sa
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: tekton-triggers-example-binding
subjects:
  - kind: ServiceAccount
    name: tekton-triggers-example-sa
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: tekton-triggers-eventlistener-roles
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: tekton-triggers-example-clusterbinding
subjects:
  - kind: ServiceAccount
    name: tekton-triggers-example-sa
    namespace: tekton-pipelines
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: tekton-triggers-eventlistener-clusterroles
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: tekton-triggers-eventlistener-roles
  labels:
    app.kubernetes.io/instance: default
    app.kubernetes.io/part-of: tekton-triggers
rules:
  - apiGroups: [&amp;quot;triggers.tekton.dev&amp;quot;]
    resources: [&amp;quot;eventlisteners&amp;quot;, &amp;quot;triggerbindings&amp;quot;, &amp;quot;triggertemplates&amp;quot;, &amp;quot;triggers&amp;quot;]
    verbs: [&amp;quot;get&amp;quot;, &amp;quot;list&amp;quot;, &amp;quot;watch&amp;quot;]
  - apiGroups: [&amp;quot;&amp;quot;]
    resources: [&amp;quot;configmaps&amp;quot;]
    verbs: [&amp;quot;get&amp;quot;, &amp;quot;list&amp;quot;, &amp;quot;watch&amp;quot;]
  - apiGroups: [&amp;quot;tekton.dev&amp;quot;]
    resources: [&amp;quot;pipelineruns&amp;quot;, &amp;quot;pipelineresources&amp;quot;, &amp;quot;taskruns&amp;quot;]
    verbs: [&amp;quot;create&amp;quot;]
  - apiGroups: [&amp;quot;&amp;quot;]
    resources: [&amp;quot;serviceaccounts&amp;quot;]
    verbs: [&amp;quot;impersonate&amp;quot;]
  - apiGroups: [&amp;quot;policy&amp;quot;]
    resources: [&amp;quot;podsecuritypolicies&amp;quot;]
    resourceNames: [&amp;quot;tekton-triggers&amp;quot;]
    verbs: [&amp;quot;use&amp;quot;]
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: tekton-triggers-eventlistener-clusterroles
  labels:
    app.kubernetes.io/instance: default
    app.kubernetes.io/part-of: tekton-triggers
rules:
  - apiGroups: [&amp;quot;triggers.tekton.dev&amp;quot;]
    resources: [&amp;quot;clustertriggerbindings&amp;quot;, &amp;quot;clusterinterceptors&amp;quot;]
    verbs: [&amp;quot;get&amp;quot;, &amp;quot;list&amp;quot;, &amp;quot;watch&amp;quot;]
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æµæ°´çº¿ä»»åŠ¡&#34;&gt;æµæ°´çº¿ä»»åŠ¡&lt;/h2&gt;

&lt;p&gt;Task ä¸»è¦å‚è€ƒå®˜æ–¹çš„ &lt;a href=&#34;https://github.com/tektoncd/catalog&#34;&gt;catalog&lt;/a&gt;ï¼Œç»“åˆè‡ªèº«éœ€æ±‚åšäº†é€‚å½“çš„æ”¹é€ ï¼Œè¯¦ç»†å†…å®¹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;å¢åŠ äº† &lt;code&gt;GOPROXY&lt;/code&gt; å’Œ &lt;code&gt;GOMODCACHE&lt;/code&gt; çš„æ”¯æŒï¼ŒåŠ é€Ÿä¾èµ–ä¸‹è½½é€Ÿåº¦ï¼Œä½¿ç”¨å›½å†… Proxyï¼Œå¹¶å°† mod cache æŒ‡å®šåˆ° &lt;code&gt;workspace&lt;/code&gt; çš„ç‹¬ç«‹ç›®å½•ï¼Œå¤šä¸ªé¡¹ç›®å…±äº«ä¸”é¿å…è¢«æ¸…ç†ï¼Œè·¯å¾„ä¸º &lt;code&gt;$(workspaces.source.path)/$(params.GOMODCACHE)&lt;/code&gt;ï¼Œ &lt;code&gt;GOMODCACHE&lt;/code&gt; å‚æ•°é»˜è®¤ä¸º &lt;code&gt;pkg/mod&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;å¢åŠ å¯¹å­ç›®å½•çš„æ”¯æŒï¼Œåœ¨åŒä¸€ &lt;code&gt;workspace&lt;/code&gt; ä¸‹åŒæ—¶å­˜å‚¨å¤šä¸ªé¡¹ç›®çš„æºç &lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&amp;gt; æœªå¿…æ˜¯ä¸ªå¥½çš„å®è·µæ–¹å¼ï¼Œä¸è¿‡é€‚åˆæˆ‘çš„éœ€æ±‚ğŸ˜‚&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;é•œåƒæ„å»ºé€‰ç”¨çš„ &lt;code&gt;kaniko&lt;/code&gt; è€Œæ²¡æœ‰ç”¨ &lt;code&gt;docker-build&lt;/code&gt;ï¼Œéƒ½å°è¯•åå‘ç°ç”¨ &lt;code&gt;kaniko&lt;/code&gt; å¯ä»¥æ¯”è¾ƒæ–¹ä¾¿çš„è·å– &lt;code&gt;image digested&lt;/code&gt;&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;å‘å¸ƒåˆ° &lt;code&gt;k8s&lt;/code&gt; æ²¡æœ‰ä½¿ç”¨ &lt;code&gt;catalog&lt;/code&gt; ä¸­çš„ Taskï¼Œè€Œæ˜¯ä½¿ç”¨ &lt;code&gt;dtzar/helm-kubectl&lt;/code&gt; é•œåƒè‡ªå·±å®šä¹‰çš„ä¸€ä¸ª Taskï¼Œå¯ä»¥è‡ªå®šä¹‰ &lt;code&gt;helm&lt;/code&gt; æˆ– &lt;code&gt;kubectl&lt;/code&gt; å‘½ä»¤&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;p&gt;æ¯ä¸ª Task çš„å…·ä½“å·¥ä½œåœ¨æ­¤ä¸åšè¯¦ç»†çš„ä»‹ç»ï¼ŒåŸºæœ¬é€šè¿‡æºç çš„å‚æ•°å’Œæ­¥éª¤å¯ä»¥å¾ˆå¿«äº†è§£æ¯ä¸ª Task çš„å…·ä½“ä»»åŠ¡å†…å®¹&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&#34;git-clone-yml&#34;&gt;git-clone.yml&lt;/h3&gt;

&lt;blockquote&gt;
&lt;p&gt;æœ€æ–°é…ç½®ä»¥ &lt;a href=&#34;https://github.com/hb-chen/tekton-practice&#34;&gt;github.com/hb-chen/tekton-practice&lt;/a&gt; ä¸ºå‡†&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: git-clone
  labels:
    app.kubernetes.io/version: &amp;quot;0.2&amp;quot;
  annotations:
    tekton.dev/pipelines.minVersion: &amp;quot;0.12.1&amp;quot;
    tekton.dev/tags: git
    tekton.dev/displayName: &amp;quot;git clone&amp;quot;
spec:
  description: &amp;gt;-
    These Tasks are Git tasks to work with repositories used by other tasks
    in your Pipeline.

    The git-clone Task will clone a repo from the provided url into the
    output Workspace. By default the repo will be cloned into the root of
    your Workspace. You can clone into a subdirectory by setting this Task&#39;s
    subdirectory param.

  workspaces:
    - name: output
      description: The git repo will be cloned onto the volume backing this workspace
  params:
    - name: url
      description: git url to clone
      type: string
    - name: revision
      description: git revision to checkout (branch, tag, sha, refâ€¦)
      type: string
      default: &amp;quot;&amp;quot;
    - name: refspec
      description: (optional) git refspec to fetch before checking out revision
      default: &amp;quot;&amp;quot;
    - name: submodules
      description: defines if the resource should initialize and fetch the submodules
      type: string
      default: &amp;quot;true&amp;quot;
    - name: depth
      description: performs a shallow clone where only the most recent commit(s) will be fetched
      type: string
      default: &amp;quot;1&amp;quot;
    - name: sslVerify
      description: defines if http.sslVerify should be set to true or false in the global git config
      type: string
      default: &amp;quot;true&amp;quot;
    - name: subdirectory
      description: subdirectory inside the &amp;quot;output&amp;quot; workspace to clone the git repo into
      type: string
      default: &amp;quot;&amp;quot;
    - name: deleteExisting
      description: clean out the contents of the repo&#39;s destination directory (if it already exists) before trying to clone the repo there
      type: string
      default: &amp;quot;true&amp;quot;
    - name: httpProxy
      description: git HTTP proxy server for non-SSL requests
      type: string
      default: &amp;quot;&amp;quot;
    - name: httpsProxy
      description: git HTTPS proxy server for SSL requests
      type: string
      default: &amp;quot;&amp;quot;
    - name: noProxy
      description: git no proxy - opt out of proxying HTTP/HTTPS requests
      type: string
      default: &amp;quot;&amp;quot;
    - name: verbose
      description: log the commands used during execution
      type: string
      default: &amp;quot;true&amp;quot;
    - name: gitInitImage
      description: the image used where the git-init binary is
      type: string
      default: &amp;quot;registry.cn-hangzhou.aliyuncs.com/hb-chen/tektoncd-git-init:v0.20.0@sha256:e8e38d1ad630cc2e435deed289b6283cb0a06d3c00947131f371f151781db2b3&amp;quot;
  results:
    - name: commit
      description: The precise commit SHA that was fetched by this Task
    - name: url
      description: The precise URL that was fetched by this Task
  steps:
    - name: clone
      image: $(params.gitInitImage)
      script: |
        #!/bin/sh
        set -eu -o pipefail

        if [[ &amp;quot;$(params.verbose)&amp;quot; == &amp;quot;true&amp;quot; ]] ; then
          set -x
        fi

        CHECKOUT_DIR=&amp;quot;$(workspaces.output.path)/$(params.subdirectory)&amp;quot;

        cleandir() {
          # Delete any existing contents of the repo directory if it exists.
          #
          # We don&#39;t just &amp;quot;rm -rf $CHECKOUT_DIR&amp;quot; because $CHECKOUT_DIR might be &amp;quot;/&amp;quot;
          # or the root of a mounted volume.
          if [[ -d &amp;quot;$CHECKOUT_DIR&amp;quot; ]] ; then
            # Delete non-hidden files and directories
            rm -rf &amp;quot;$CHECKOUT_DIR&amp;quot;/*
            # Delete files and directories starting with . but excluding ..
            rm -rf &amp;quot;$CHECKOUT_DIR&amp;quot;/.[!.]*
            # Delete files and directories starting with .. plus any other character
            rm -rf &amp;quot;$CHECKOUT_DIR&amp;quot;/..?*
          fi
        }

        if [[ &amp;quot;$(params.deleteExisting)&amp;quot; == &amp;quot;true&amp;quot; ]] ; then
          cleandir
        fi

        test -z &amp;quot;$(params.httpProxy)&amp;quot; || export HTTP_PROXY=$(params.httpProxy)
        test -z &amp;quot;$(params.httpsProxy)&amp;quot; || export HTTPS_PROXY=$(params.httpsProxy)
        test -z &amp;quot;$(params.noProxy)&amp;quot; || export NO_PROXY=$(params.noProxy)

        /ko-app/git-init \
          -url &amp;quot;$(params.url)&amp;quot; \
          -revision &amp;quot;$(params.revision)&amp;quot; \
          -refspec &amp;quot;$(params.refspec)&amp;quot; \
          -path &amp;quot;$CHECKOUT_DIR&amp;quot; \
          -sslVerify=&amp;quot;$(params.sslVerify)&amp;quot; \
          -submodules=&amp;quot;$(params.submodules)&amp;quot; \
          -depth &amp;quot;$(params.depth)&amp;quot;
        cd &amp;quot;$CHECKOUT_DIR&amp;quot;
        RESULT_SHA=&amp;quot;$(git rev-parse HEAD)&amp;quot;
        EXIT_CODE=&amp;quot;$?&amp;quot;
        if [ &amp;quot;$EXIT_CODE&amp;quot; != 0 ] ; then
          exit $EXIT_CODE
        fi
        # ensure we don&#39;t add a trailing newline to the result
        echo -n &amp;quot;$RESULT_SHA&amp;quot; &amp;gt; $(results.commit.path)
        echo -n &amp;quot;$(params.url)&amp;quot; &amp;gt; $(results.url.path)
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;golang-test-yml&#34;&gt;golang-test.yml&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: golang-test
  labels:
    app.kubernetes.io/version: &amp;quot;0.1&amp;quot;
  annotations:
    tekton.dev/pipelines.minVersion: &amp;quot;0.12.1&amp;quot;
    tekton.dev/tags: test
    tekton.dev/displayName: &amp;quot;golang test&amp;quot;
spec:
  description: &amp;gt;-
    This Task is Golang task to test Go projects.

  params:
    - name: package
      description: package (and its children) under test
    - name: packages
      description: &amp;quot;packages to test (default: ./...)&amp;quot;
      default: &amp;quot;./...&amp;quot;
    - name: subdirectory
      description: subdirectory inside the &amp;quot;source&amp;quot;
      type: string
      default: &amp;quot;&amp;quot;
    - name: version
      description: golang version to use for tests
      default: &amp;quot;latest&amp;quot;
    - name: flags
      description: flags to use for the test command
      default: -race -cover -v
    - name: GOOS
      description: &amp;quot;running program&#39;s operating system target&amp;quot;
      default: linux
    - name: GOARCH
      description: &amp;quot;running program&#39;s architecture target&amp;quot;
      default: amd64
    - name: GO111MODULE
      description: &amp;quot;value of module support&amp;quot;
      default: auto
    - name: GOPROXY
      description: &amp;quot;go proxy&amp;quot;
      default: &amp;quot;https://mirrors.aliyun.com/goproxy/,direct&amp;quot;
    - name: GOMODCACHE
      description: &amp;quot;go mod cache sub directory, base on source path&amp;quot;
      default: &amp;quot;pkg/mod&amp;quot;
  workspaces:
    - name: source
  steps:
    - name: unit-test
      image: docker.io/library/golang:$(params.version)
      script: |
        SRC_PATH=&amp;quot;$GOPATH/src/$(params.package)&amp;quot;
        mkdir -p $SRC_PATH
        cp -R &amp;quot;$(workspaces.source.path)&amp;quot;/$(params.subdirectory)/* $SRC_PATH
        cd $SRC_PATH
        go test $(params.flags) $(params.packages)
      env:
        - name: GOOS
          value: &amp;quot;$(params.GOOS)&amp;quot;
        - name: GOARCH
          value: &amp;quot;$(params.GOARCH)&amp;quot;
        - name: GO111MODULE
          value: &amp;quot;$(params.GO111MODULE)&amp;quot;
        - name: GOPROXY
          value: &amp;quot;$(params.GOPROXY)&amp;quot;
        - name: GOMODCACHE
          value: &amp;quot;$(workspaces.source.path)/$(params.GOMODCACHE)&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;golang-build-yml&#34;&gt;golang-build.yml&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;# fork from tektoncd/catalog, add GOPROXY
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: golang-build
  labels:
    app.kubernetes.io/version: &amp;quot;0.1&amp;quot;
  annotations:
    tekton.dev/pipelines.minVersion: &amp;quot;0.12.1&amp;quot;
    tekton.dev/tags: build-tool
    tekton.dev/displayName: &amp;quot;golang build&amp;quot;
spec:
  description: &amp;gt;-
    This Task is Golang task to build Go projects.

  params:
    - name: package
      description: base package to build in
    - name: packages
      description: &amp;quot;packages to build (default: ./cmd/...)&amp;quot;
      default: &amp;quot;./cmd/...&amp;quot;
    - name: subdirectory
      description: subdirectory inside the &amp;quot;source&amp;quot;
      type: string
      default: &amp;quot;&amp;quot;
    - name: version
      description: golang version to use for builds
      default: &amp;quot;latest&amp;quot;
    - name: flags
      description: flags to use for the test command
      default: -v
    - name: GOOS
      description: &amp;quot;running program&#39;s operating system target&amp;quot;
      default: linux
    - name: GOARCH
      description: &amp;quot;running program&#39;s architecture target&amp;quot;
      default: amd64
    - name: CGO_ENABLED
      description: &amp;quot;value of cgo enabled&amp;quot;
      default: &amp;quot;0&amp;quot;
    - name: GO111MODULE
      description: &amp;quot;value of module support&amp;quot;
      default: auto
    - name: GOPROXY
      description: &amp;quot;go proxy&amp;quot;
      default: &amp;quot;https://mirrors.aliyun.com/goproxy/,direct&amp;quot;
    - name: GOMODCACHE
      description: &amp;quot;go mod cache sub directory, base on source path&amp;quot;
      default: &amp;quot;pkg/mod&amp;quot;
  workspaces:
    - name: source
  steps:
    - name: build
      image: docker.io/library/golang:$(params.version)
      script: |
        SRC_PATH=&amp;quot;$GOPATH/src/$(params.package)&amp;quot;
        mkdir -p $SRC_PATH
        cp -R &amp;quot;$(workspaces.source.path)&amp;quot;/$(params.subdirectory)/* $SRC_PATH
        cd $SRC_PATH
        go env
        go build $(params.flags) $(params.packages)
      env:
        - name: GOOS
          value: &amp;quot;$(params.GOOS)&amp;quot;
        - name: GOARCH
          value: &amp;quot;$(params.GOARCH)&amp;quot;
        - name: CGO_ENABLED
          value: &amp;quot;$(params.CGO_ENABLED)&amp;quot;
        - name: GO111MODULE
          value: &amp;quot;$(params.GO111MODULE)&amp;quot;
        - name: GOPROXY
          value: &amp;quot;$(params.GOPROXY)&amp;quot;
        - name: GOMODCACHE
          value: &amp;quot;$(workspaces.source.path)/$(params.GOMODCACHE)&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;kaniko-yml&#34;&gt;kaniko.yml&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: kaniko
  labels:
    app.kubernetes.io/version: &amp;quot;0.4&amp;quot;
  annotations:
    tekton.dev/pipelines.minVersion: &amp;quot;0.17.0&amp;quot;
    tekton.dev/categories: Image Build
    tekton.dev/tags: image-build
    tekton.dev/displayName: &amp;quot;Build and upload container image using Kaniko&amp;quot;
spec:
  description: &amp;gt;-
    This Task builds source into a container image using Google&#39;s kaniko tool.

    Kaniko doesn&#39;t depend on a Docker daemon and executes each
    command within a Dockerfile completely in userspace. This enables
    building container images in environments that can&#39;t easily or
    securely run a Docker daemon, such as a standard Kubernetes cluster.

  params:
    - name: IMAGE
      description: Name (reference) of the image to build.
    - name: DOCKERFILE
      description: Path to the Dockerfile to build.
      default: ./Dockerfile
    - name: CONTEXT
      description: The build context used by Kaniko.
      default: ./
    - name: EXTRA_ARGS
      type: array
      default: []
    - name: BUILDER_IMAGE
      description: The image on which builds will run
      default: registry.cn-hangzhou.aliyuncs.com/hb-chen/kaniko-executor:v1.5.1@sha256:c812530c2ea981d3316c7544b180289abfbd9adf1dde6f1345692b8fb0a65cb0
  workspaces:
    - name: source
      description: Holds the context and docker file
    - name: dockerconfig
      description: Includes a docker `config.json`
      optional: true
      mountPath: /kaniko/.docker
  results:
    - name: IMAGE-DIGEST
      description: Digest of the image just built.
  steps:
    - name: build-and-push
      workingDir: $(workspaces.source.path)
      image: $(params.BUILDER_IMAGE)
      args:
        - $(params.EXTRA_ARGS[*])
        - --dockerfile=$(params.DOCKERFILE)
        - --context=$(workspaces.source.path)/$(params.CONTEXT)  # The user does not need to care the workspace and the source.
        - --destination=$(params.IMAGE)
        - --oci-layout-path=$(workspaces.source.path)/$(params.CONTEXT)/image-digest
      # kaniko assumes it is running as root, which means this example fails on platforms
      # that default to run containers as random uid (like OpenShift). Adding this securityContext
      # makes it explicit that it needs to run as root.
      securityContext:
        runAsUser: 0
    - name: write-digest
      workingDir: $(workspaces.source.path)
      image: registry.cn-hangzhou.aliyuncs.com/hb-chen/tektoncd-imagedigestexporter:v0.16.2@sha256:542d437868a0168f0771d840233110fbf860b210b0e9becce5d75628c694b958
      # output of imagedigestexport [{&amp;quot;key&amp;quot;:&amp;quot;digest&amp;quot;,&amp;quot;value&amp;quot;:&amp;quot;sha256:eed29..660&amp;quot;,&amp;quot;resourceRef&amp;quot;:{&amp;quot;name&amp;quot;:&amp;quot;myrepo/myimage&amp;quot;}}]
      command: [&amp;quot;/ko-app/imagedigestexporter&amp;quot;]
      args:
        - -images=[{&amp;quot;name&amp;quot;:&amp;quot;$(params.IMAGE)&amp;quot;,&amp;quot;type&amp;quot;:&amp;quot;image&amp;quot;,&amp;quot;url&amp;quot;:&amp;quot;$(params.IMAGE)&amp;quot;,&amp;quot;digest&amp;quot;:&amp;quot;&amp;quot;,&amp;quot;OutputImageDir&amp;quot;:&amp;quot;$(workspaces.source.path)/$(params.CONTEXT)/image-digest&amp;quot;}]
        - -terminationMessagePath=$(params.CONTEXT)/image-digested
      securityContext:
        runAsUser: 0
    - name: digest-to-results
      workingDir: $(workspaces.source.path)
      image: docker.io/stedolan/jq@sha256:a61ed0bca213081b64be94c5e1b402ea58bc549f457c2682a86704dd55231e09
      script: |
        cat $(params.CONTEXT)/image-digested | jq &#39;.[0].value&#39; -rj | tee /tekton/results/IMAGE-DIGEST
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;helm-kubectl-yml&#34;&gt;helm-kubectl.yml&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: helm-kubectl-deploy
  labels:
    app.kubernetes.io/version: &amp;quot;0.1&amp;quot;
  annotations:
    tekton.dev/pipelines.minVersion: &amp;quot;0.12.1&amp;quot;
    tekton.dev/tags: helm, kubectl
    tekton.dev/displayName: helm-kubectl-deploy
spec:
  description: &amp;gt;-
    Use kubectl and helm deploy application
  params:
    - name: image
      default: dtzar/helm-kubectl:3.4.2
      description: kubectl and helm image
    - name: commands
      default: kubectl version
  workspaces:
    - name: source
    - name: kubeconfig
      description: Includes a `.kube/config`
      optional: true
      mountPath: /root/.kube
  results:
  steps:
    - name: helm-kubectl-deploy
      image: $(params.image)
      workingDir: $(workspaces.source.path)
      script: |
        ls -l
        kubectl version
        helm version
        $(params.commands)
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æµæ°´çº¿å®šä¹‰&#34;&gt;æµæ°´çº¿å®šä¹‰&lt;/h2&gt;

&lt;p&gt;Pipeline åŸºæœ¬å°±æ˜¯å¯¹ Task çš„é…ç½®ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„å°±æ˜¯æ ¹æ®é¡¹ç›®åŒºåˆ† &lt;code&gt;workspace&lt;/code&gt; ä¸‹çš„å­ç›®å½•ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ç»Ÿä¸€ &lt;code&gt;subdirectory&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Golang build ç¼–è¯‘çš„è¾“å‡ºä½ç½®&lt;code&gt;-o $(workspaces.source.path)/${subdirectory}&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;é•œåƒæ„å»ºçš„ &lt;code&gt;DOCKERFILE&lt;/code&gt; å’Œ &lt;code&gt;CONTEXT&lt;/code&gt; ä¹Ÿæ˜¯åœ¨ &lt;code&gt;./${subdirectory}/&lt;/code&gt;ç›®å½•ä¸‹&lt;/li&gt;
&lt;li&gt;&lt;code&gt;helm&lt;/code&gt; éƒ¨ç½²æ—¶ &lt;code&gt;chart&lt;/code&gt; ä¹Ÿæ˜¯åœ¨&lt;code&gt;./${subdirectory}/&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä»¥ä¸‹æ˜¯ &lt;a href=&#34;https://github.com/hb-chen/gateway&#34;&gt;hb-chen/gateway&lt;/a&gt; çš„ç¤ºä¾‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: grpc-gateway-pipeline
spec:
  workspaces:
    - name: shared-workspace
    - name: dockerconfig
    - name: kubeconfig
  params:
    - name: url
    - name: revision
      default: master
  tasks:
    - name: fetch-repository
      taskRef:
        name: git-clone
      workspaces:
        - name: output
          workspace: shared-workspace
      params:
        - name: url
          value: $(params.url)
        - name: revision
          value: $(params.revision)
        - name: subdirectory
          value: &amp;quot;gateway&amp;quot;
        - name: deleteExisting
          value: &amp;quot;true&amp;quot;
    - name: run-test
      taskRef:
        name: golang-test
      runAfter:
        - fetch-repository
      workspaces:
        - name: source
          workspace: shared-workspace
      params:
        - name: package
          value: github.com/hb-chen/gateway
        - name: subdirectory
          value: &amp;quot;gateway&amp;quot;
        - name: version
          value: 1.14.15
    - name: run-build
      taskRef:
        name: golang-build
      runAfter:
        - run-test
      workspaces:
        - name: source
          workspace: shared-workspace
      params:
        - name: package
          value: github.com/hb-chen/gateway
        - name: subdirectory
          value: &amp;quot;gateway&amp;quot;
        - name: version
          value: 1.15.11
        - name: flags
          value: -v -o $(workspaces.source.path)/gateway/bin/linux/gateway
    - name: docker-build
      taskRef:
        name: kaniko
      runAfter:
        - run-build
      workspaces:
        - name: source
          workspace: shared-workspace
        - name: dockerconfig
          workspace: dockerconfig
      params:
        - name: IMAGE
          value: registry.cn-hangzhou.aliyuncs.com/hb-chen/grpc-gateway:latest
        - name: DOCKERFILE
          value: ./gateway/Dockerfile
        - name: CONTEXT
          value: ./gateway/
        - name: EXTRA_ARGS
          value:
            - &amp;quot;--skip-tls-verify&amp;quot;
            - &amp;quot;--insecure-registry=registry.cn-hangzhou.aliyuncs.com&amp;quot;
    - name: helm-kubectl-deploy
      taskRef:
        name: helm-kubectl-deploy
      runAfter:
        - docker-build
      workspaces:
        - name: source
          workspace: shared-workspace
        - name: kubeconfig
          workspace: kubeconfig
      params:
        - name: commands
          value: |
            helm template \
            --release-name grpc-gateway \
            --no-hooks \
            --set image.repository=registry.cn-hangzhou.aliyuncs.com/hb-chen/grpc-gateway \
            --set image.tag=latest \
            --set image.digest=@$(tasks.docker-build.results.IMAGE-DIGEST) \
            ./gateway/helm | kubectl apply -n grpc-gateway -f -
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;pvc&#34;&gt;PVC&lt;/h2&gt;

&lt;p&gt;PVC é€‰æ‹©æ˜¯å¤šä¸ªé¡¹ç›®å…±ç”¨ä¸€ä¸ªï¼Œæ‰€ä»¥åœ¨å‰é¢çš„ Task å’Œ Pipeline  ä¸­éœ€è¦é€šè¿‡ &lt;code&gt;subdirectory&lt;/code&gt; æ¥è§„åˆ’ä¸åŒé¡¹ç›®çš„æºç ä½ç½®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: golang-source-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 500Mi
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;å®‰å…¨è®¤è¯&#34;&gt;å®‰å…¨è®¤è¯&lt;/h2&gt;

&lt;p&gt;æ•´ä¸ªè¿‡ç¨‹æ¶‰åŠåˆ°å¤šå‡ºè®¤è¯ï¼ŒTrigger ä¸­ Webhook secret å·²ç»ä»‹ç»ï¼Œå‰©ä½™çš„è¿˜æœ‰æ˜¯å’Œæµæ°´çº¿ Task æœ‰å…³çš„ï¼Œå…¶ä¸­ Git å’Œ Docker Hub ä½¿ç”¨ Basic è®¤è¯ï¼Œä¸ &lt;code&gt;ServiceAcount&lt;/code&gt; ç»‘å®šï¼ŒKubernetes åˆ™é€šè¿‡æŒ‚åœ¨ KubeConfig Secret å®ç°ã€‚&lt;/p&gt;

&lt;h3 id=&#34;git&#34;&gt;Git&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: v1
kind: Secret
metadata:
  name: basic-git-user-pass
  annotations:
    tekton.dev/git-0: https://github.com
type: kubernetes.io/basic-auth
stringData:
  username: hobo@hbchen.com
  password: 123456
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;é•œåƒä»“åº“&#34;&gt;é•œåƒä»“åº“&lt;/h3&gt;

&lt;p&gt;é•œåƒä»“åº“çš„è®¤è¯ä¿¡æ¯é€šè¿‡æŒ‚è½½ &lt;code&gt;config.json&lt;/code&gt; çš„æ–¹å¼ï¼Œè€Œä¸ä½¿ç”¨ Basic Authï¼Œè¿™ä¸ªæ”¹åŠ¨åœ¨ Kaniko task ä¸­æœ‰è¯´æ˜ï¼š&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/tektoncd/catalog/tree/main/task/kaniko/0.4#changelog&#34;&gt;Changelog&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Replace ServiceAccount based authentication with a workspace based one. Tekton&amp;rsquo;s built-in auth can be disabled, it
can be hard to debug and it might not work for all type of credentials. Workspaces are available to all deployments, and can be bound to both secrets and PVCs.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å¦å¤–æ³¨æ„å¦‚æœ &lt;code&gt;config.json&lt;/code&gt; ä¸­æ²¡æœ‰ &lt;code&gt;auth&lt;/code&gt; ä¿¡æ¯ï¼Œåˆ æ‰ &lt;code&gt;credsStore&lt;/code&gt;ï¼Œé‡æ–° &lt;code&gt;docker login&lt;/code&gt;ï¼Œå‚è€ƒ &lt;a href=&#34;https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/&#34;&gt;Pull an Image from a Private
Registry&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;kubectl create secret generic dockerconfig \
  -n tekton-pipelines \
  --from-file=config.json=$HOME/.docker/config.json \
  --type=kubernetes.io/dockerconfig
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;kubeconfig&#34;&gt;KubeConfig&lt;/h3&gt;

&lt;p&gt;å¦‚æœä½¿ç”¨æœ¬åœ° KubeConfig é…ç½®å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¿«é€Ÿåˆ›å»º&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;kubectl create secret generic k8s-kubeconfig --from-file=$HOME/.kube/config
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;---
apiVersion: v1
kind: Secret
metadata:
  name: k8s-kubeconfig
type: Opaque
data:
  config: {$HOME/.kube/config base64 encode}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;service-account&#34;&gt;Service Account&lt;/h3&gt;

&lt;p&gt;å°† Docker å’Œ Git çš„ Basic è®¤è¯éƒ½ç»‘å®šåˆ° &lt;code&gt;build-bot&lt;/code&gt;ï¼Œè¿™æ˜¯è¿è¡Œæµæ°´çº¿æ˜¯ä½¿ç”¨çš„ ServiceAccount&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: build-bot
secrets:
  - name: basic-git-user-pass
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Tektonã€‘ç»„ä»¶ä»‹ç»åŠå®‰è£…éƒ¨ç½²</title>
      <link>http://hbchen.com/post/devops/2021-03-28-tekton-install/</link>
      <pubDate>Sun, 28 Mar 2021 00:41:51 +0800</pubDate>
      
      <guid>http://hbchen.com/post/devops/2021-03-28-tekton-install/</guid>
      
        <description>&lt;p&gt;Tekton ä½œä¸º Kubernetes åŸç”Ÿçš„ CI/CD æ¡†æ¶ï¼Œæ‹¥æœ‰è½»é‡ã€çµæ´»ç­‰ç‰¹ç‚¹ï¼Œæ¥ä¸‹æ¥æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•éƒ¨ç½² Tekton ç¯å¢ƒï¼Œåç»­ä»¥ä¸€ä¸ª Golang é¡¹ç›®ä¸ºä¾‹ï¼Œäº†è§£ Pipeline å’Œ Triggerï¼ŒåŒ…æ‹¬å¦‚ä½•ä½¿ç”¨ Taskã€Pipelineã€PipelineRunã€EventListenerã€TriggerBindingã€TriggerTemplate ç­‰ CRDs å®ŒæˆæŒç»­é›†æˆå’Œäº¤ä»˜çš„å…¨æµç¨‹ã€‚&lt;/p&gt;

&lt;p&gt;Tekton åŒ…æ‹¬ Pipelineã€Trigger å’Œ Dashboard ä¸‰ä¸ªéƒ¨åˆ†ï¼Œæœ€å°éƒ¨ç½²å¯ä»¥åªç”¨ Pipelineï¼ŒPipeline æ˜¯ Tekton çš„æ ¸å¿ƒï¼Œè´Ÿè´£å…·ä½“ä»»åŠ¡çš„æµæ°´çº¿å·¥ä½œï¼›Trigger åˆ™ä¸»è¦æ˜¯ Pipeline çš„è§¦å‘å™¨ï¼Œå¦‚æœ‰ Git PR åé€šè¿‡ Webhook è§¦å‘ CI æµæ°´çº¿ï¼›Dashboard åˆ™æä¾›äº†ä¸€ä¸ª Web æ§åˆ¶å°ã€‚è¦éƒ¨ç½² Tekton é¦–å…ˆè¦æœ‰ä¸€ä¸ª K8S ç¯å¢ƒï¼Œå¦‚æœæ²¡æœ‰ï¼Œå¯ä»¥ä½¿ç”¨ Minikube åšæµ‹è¯•ï¼Œå¦‚æœæœ‰æœåŠ¡å™¨èµ„æºæ¨èä½¿ç”¨ &lt;a href=&#34;https://rancher.com/&#34;&gt;Rancher&lt;/a&gt;ï¼Œå¯ä»¥é€‰æ‹©éƒ¨ç½²ä¸€ä¸ª K3S åš K8S çš„å¤šé›†ç¾¤ç®¡ç†ã€‚&lt;/p&gt;

&lt;p&gt;æœ‰äº† K8S ç¯å¢ƒ Tekton çš„éƒ¨ç½²å¾ˆç®€å•ï¼Œåªéœ€è¦&lt;code&gt;kubectl apply â€¦&lt;/code&gt;ï¼Œä½†ç›´æ¥ä½¿ç”¨å®˜æ–¹çš„&lt;code&gt;yaml&lt;/code&gt;ä¼šæœ‰é‡åˆ°ä¸€ä¸ªé—®é¢˜GFWä½¿&lt;code&gt;gcr.io&lt;/code&gt;é•œåƒæ— æ³•è®¿é—®ï¼Œæˆ‘åœ¨&lt;a href=&#34;https://github.com/hb-chen/tekton-practice/tree/main/install&#34;&gt;tekton-practice/install&lt;/a&gt;æä¾›äº†å›½å†…é•œåƒç‰ˆæœ¬ï¼Œå¦‚æœå¯ä»¥ç§‘å­¦ä¸Šç½‘ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨&lt;a href=&#34;https://github.com/hb-chen/docker-sync&#34;&gt;docker-sync&lt;/a&gt;è¿™ä¸ªå·¥å…·å°†é•œåƒåŒæ­¥åˆ°è‡ªå·±çš„é•œåƒä»“åº“ã€‚&lt;/p&gt;

&lt;p&gt;æœ‰äº†è¿™äº›å‡†å¤‡å·¥ä½œå‰©ä¸‹éƒ¨ç½²å¾ˆç®€å•ï¼Œä»¥ä½¿ç”¨&lt;a href=&#34;https://github.com/hb-chen/tekton-practice&#34;&gt;tekton-practice&lt;/a&gt;ä¸ºä¾‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;git clone https://github.com/hb-chen/tekton-practice.git

cd tekton-practice

# ç‰ˆæœ¬å¯ä»¥æ ¹æ®æƒ…å†µé€‰æ‹©æœ€æ–°ç‰ˆæœ¬
kubectl apply -f install/pipeline_v0.20.0.yaml
kubectl apply -f install/trigger_v0.10.2.yaml
kubectl apply -f install/dashboard_v0.15.0.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;ç‰ˆæœ¬é€‰æ‹©è¿˜è¦æ³¨æ„ä¸€ç‚¹æ˜¯ä¸‰ä¸ªç»„ä»¶é—´çš„å…¼å®¹å…³ç³»ï¼Œå¯ä»¥å‚è€ƒ&lt;a href=&#34;https://github.com/tektoncd/dashboard#which-version-should-i-use&#34;&gt;tektoncd/dashboard&lt;/a&gt;çš„ README æ–‡æ¡£ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;éƒ¨ç½²å®Œæˆåå¯ä»¥æŸ¥çœ‹ä¸‹ K8S çš„èµ„æºæƒ…å†µ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;# Pod
kubectl get po -n tekton-pipelines
NAME                                           READY   STATUS    RESTARTS   AGE
tekton-dashboard-5fcd8ddb84-qj6hr              1/1     Running   0          11d
tekton-pipelines-controller-7f7cfd5bdc-xb84j   1/1     Running   0          50d
tekton-pipelines-webhook-797666b499-dw6vp      1/1     Running   0          50d
tekton-triggers-controller-7b58bbd6db-6b6l2    1/1     Running   0          50d
tekton-triggers-webhook-59d767ddb-tk4jr        1/1     Running   0          50d

# Service
kubectl get svc -n tekton-pipelines
NAME                                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                              AGE
ingress-6a5bd2bac554b1f93e94a6160e460c0d   ClusterIP   10.43.55.190    &amp;lt;none&amp;gt;        9097/TCP                             50d
tekton-dashboard                           ClusterIP   10.43.134.48    &amp;lt;none&amp;gt;        9097/TCP                             43d
tekton-pipelines-controller                ClusterIP   10.43.211.12    &amp;lt;none&amp;gt;        9090/TCP,8080/TCP                    50d
tekton-pipelines-webhook                   ClusterIP   10.43.252.153   &amp;lt;none&amp;gt;        9090/TCP,8008/TCP,443/TCP,8080/TCP   50d
tekton-triggers-controller                 ClusterIP   10.43.3.54      &amp;lt;none&amp;gt;        9090/TCP                             50d
tekton-triggers-webhook                    ClusterIP   10.43.110.171   &amp;lt;none&amp;gt;        443/TCP                              50d
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;Dashboard æœ¬èº«æ²¡æœ‰å®‰å…¨è®¤è¯ï¼Œå¦‚æœæ˜¯æš´éœ²åœ¨å…¬ç½‘çš„æœåŠ¡å¯ä»¥ä½¿ç”¨ nginx ingress çš„ &lt;a href=&#34;https://kubernetes.github.io/ingress-nginx/examples/auth/basic/&#34;&gt;basic-auth&lt;/a&gt; åšä¸€ä¸ªç®€å•çš„è®¤è¯ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;è‡³æ­¤ Tekton çš„åŸºç¡€éƒ¨ç½²å®Œæˆï¼Œå¯ä»¥æ ¹æ®è‡ªèº«ç¯å¢ƒä¸åŒç»™ Dashboard é…ç½® Ingress ç½‘å…³ã€‚ä¸‹ç¯‡å¼€å§‹ä»¥ Golang é¡¹ç›®ä¸ºä¾‹å…·ä½“ä»‹ç»å¦‚ä½•ä½¿ç”¨ Pipeline å’Œ Trigger å®ŒæˆæŒç»­é›†æˆä¸äº¤ä»˜ã€‚&lt;/p&gt;</description>
      
    </item>
    
    <item>
      <title>Golangè¿œç¨‹è°ƒè¯•-Delve</title>
      <link>http://hbchen.com/post/go/2021-03-19-delve/</link>
      <pubDate>Fri, 19 Mar 2021 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/go/2021-03-19-delve/</guid>
      
        <description>&lt;p&gt;å½“çº¿ä¸Šæˆ–å…¶å®ƒéæœ¬åœ°ç¯å¢ƒé‡åˆ°é—®é¢˜æ— æ³•æœ¬åœ°å¤ç°æ—¶ï¼Œå¾€å¾€éœ€è¦è¿œç¨‹è°ƒè¯•ï¼Œåœ¨æœåŠ¡ç«¯è¿è¡ŒæœåŠ¡ï¼Œæœ¬åœ°ä½¿ç”¨ IDE è¿›è¡Œè°ƒè¯•ï¼Œæœ¬æ–‡ä»‹ç»åœ¨ IDEA ä½¿ç”¨ Delve åšè¿œç¨‹è°ƒè¯•ï¼Œè™½ç„¶ IDEA Go Remote æœ‰æ¯”è¾ƒæ¸…æ¥šè¯´æ˜ï¼Œä½†ä½¿ç”¨ä¸­è¿˜æ˜¯æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ã€‚&lt;/p&gt;

&lt;h2 id=&#34;go-remote&#34;&gt;Go Remote&lt;/h2&gt;

&lt;p&gt;é¦–å…ˆåœ¨ IDEA çš„ Run/Debug Configurations é€‰æ‹©&lt;strong&gt;â•&lt;/strong&gt;æ·»åŠ  Go Remoteï¼Œ&lt;code&gt;Host&lt;/code&gt;å¡«ä¸»æœº IPï¼Œ&lt;code&gt;Port&lt;/code&gt;å¯ä»¥é»˜è®¤ä¸å˜ï¼ŒåŒæ—¶çª—å£ä¸­æœ‰ä»¥ä¸‹è¯´æ˜ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-text&#34;&gt;Before running this configuration, please start your application and Delve as described bellow.  Allow Delve to compile your application: 
dlv debug --headless --listen=:2345 --api-version=2 --accept-multiclient
 
Or compile the application using one of these commands: 
go build -gcflags &amp;quot;all=-N -l&amp;quot; github.com/app/demo
for Go 1.10 or later
 
go build -gcflags &amp;quot;-N -l&amp;quot; github.com/app/demo
for Go 1.9 or earlier
 
and then run it via Delve with the following command:
dlv --listen=:2345 --headless=true --api-version=2 --accept-multiclient exec ./demo
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åŸºæœ¬äº†è§£åå¼€å§‹ä»‹ç»å…·ä½“ä½¿ç”¨æµç¨‹ï¼Œ&lt;strong&gt;æ­¤æ—¶å¯ä»¥æŠŠ Host å¡«å¥½å¹¶ Apply&lt;/strong&gt;ã€‚&lt;/p&gt;

&lt;h2 id=&#34;delve-å®‰è£…&#34;&gt;Delve å®‰è£…&lt;/h2&gt;

&lt;p&gt;æ ¹æ®ç¯å¢ƒåˆ†åˆ«åœ¨æœåŠ¡ç«¯å’Œæœ¬åœ°å®‰è£…&lt;code&gt;dlv&lt;/code&gt;å·¥å…·ï¼Œ&lt;a href=&#34;https://github.com/go-delve/delve/tree/master/Documentation/installation&#34;&gt;Installation&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;ç¼–è¯‘&#34;&gt;ç¼–è¯‘&lt;/h2&gt;

&lt;p&gt;ä½¿ç”¨&lt;code&gt;go build -gcflags &amp;quot;all=-N -l&amp;quot; github.com/app/demo&lt;/code&gt;ç¼–è¯‘ï¼Œä»¥&lt;a href=&#34;https://github.com/hb-chen/gateway&#34;&gt;hb-chen/gateway&lt;/a&gt;ä¸ºä¾‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;cd $GOPATH/src/github.com/hb-chen/gateway

# ç¼–è¯‘ linux
GOOS=linux go build -gcflags &amp;quot;all=-N -l&amp;quot; cmd/main.go
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;ä¸Šä¼ æ‰§è¡Œæ–‡ä»¶æœåŠ¡ç«¯&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;scp main root@{HOST_IP}:/workdir/
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;delve-è¿è¡ŒæœåŠ¡&#34;&gt;Delve è¿è¡ŒæœåŠ¡&lt;/h2&gt;

&lt;p&gt;æ¥ä¸‹æ¥åœ¨æœåŠ¡ç«¯è¿è¡ŒæœåŠ¡ï¼Œè¿™æ—¶æœ‰ä¸ªé—®é¢˜ï¼Œ&lt;strong&gt;å‘½ä»¤è¡Œå‚æ•°&lt;/strong&gt;æ€ä¹ˆæ·»åŠ ï¼Ÿç­”æ¡ˆæ˜¯éœ€è¦ä½¿ç”¨&lt;code&gt;--&lt;/code&gt;ä¸ Delve è¿è¡Œå‘½ä»¤åˆ†éš”å¼€ï¼Œå¦‚&lt;code&gt;gateway&lt;/code&gt;ç¤ºä¾‹æ·»åŠ &lt;code&gt;-e&lt;/code&gt;å‚æ•°ä½¿ç”¨æ ‡å‡†è¾“å‡ºæ‰“å°æ—¥å¿—ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;# æ— å‚æ•°
dlv --listen=:2345 --headless=true --api-version=2 --accept-multiclient exec ./main

# -- ä¸ºåˆ†éš”ç¬¦
# -e ä¸ºå‚æ•°
dlv --listen=:2345 --headless=true --api-version=2 --accept-multiclient exec ./main -- -e
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;è°ƒè¯•&#34;&gt;è°ƒè¯•&lt;/h2&gt;

&lt;p&gt;æ­¤æ—¶å›åˆ° IDEA å¯åŠ¨ Debug å°±å¯ä»¥è¿œç¨‹è°ƒè¯•äº†&lt;/p&gt;

&lt;p&gt;è°ƒè¯•æ—¶å¦‚æœéœ€è¦ä¿®æ”¹&lt;code&gt;gateway&lt;/code&gt;çš„å¯åŠ¨å‚æ•°ï¼Œåˆä¼šé‡åˆ°å¦ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨æœåŠ¡ç«¯çš„ç»ˆç«¯&lt;code&gt;ctl + c&lt;/code&gt;æ— æ³•é€€å‡ºï¼Œè¿™æ—¶éœ€è¦ä½¿ç”¨æœ¬åœ°å®‰è£…çš„&lt;code&gt;dlv&lt;/code&gt;å·¥å…·è¿æ¥åˆ°æœåŠ¡ç«¯ï¼Œç„¶åæ‰§è¡Œ&lt;code&gt;exit&lt;/code&gt;ä¼šè¯¢é—®&lt;code&gt;Would you like to kill the headless instance? [Y/n]&lt;/code&gt;é€‰æ‹©&lt;code&gt;Y&lt;/code&gt;ï¼Œæ­¤æ—¶æœåŠ¡ç«¯ç»ˆç«¯é€€å‡ºï¼Œå†é‡æ–°å¯åŠ¨ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;dlv connect {HOST_IP}:2345

Type &#39;help&#39; for list of commands.
(dlv) exit
Would you like to kill the headless instance? [Y/n] Y
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Istioã€‘Rust å¼€å‘ wasm æ‰©å±•</title>
      <link>http://hbchen.com/post/servicemesh/2020-05-22-istio-wasm-rust/</link>
      <pubDate>Fri, 22 May 2020 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/servicemesh/2020-05-22-istio-wasm-rust/</guid>
      
        <description>&lt;p&gt;Istio &lt;strong&gt;1.5&lt;/strong&gt; å¼€å§‹æ”¯æŒåœ¨æ•°æ®é¢æ”¯æŒ&lt;code&gt;Wasm&lt;/code&gt;æ‰©å±•ï¼Œç›¸å…³è§„èŒƒä»¥åŠSDKåœ¨&lt;a href=&#34;https://github.com/proxy-wasm&#34;&gt;proxy-wasm&lt;/a&gt;ï¼Œç›®å‰æä¾›æœ‰ä¸‰ç§ SDK å®ç°ï¼Œåˆ†åˆ«æ˜¯&lt;code&gt;C++&lt;/code&gt;ã€&lt;code&gt;Rust&lt;/code&gt;å’Œ&lt;code&gt;AssemblyScript&lt;/code&gt;ï¼Œå…¶ä¸­&lt;code&gt;AssemblyScript&lt;/code&gt;åœ¨&lt;a href=&#34;https://github.com/solo-io/proxy-runtime&#34;&gt;solo-io/proxy-runtime&lt;/a&gt;ã€‚é™¤äº† SDK Solo è¿˜å‘å¸ƒäº† &lt;a href=&#34;https://webassemblyhub.io/&#34;&gt;WebAssembly Hub&lt;/a&gt;ï¼Œå¹¶é…æœ‰&lt;code&gt;wasme&lt;/code&gt; CLI å·¥å…·ï¼Œä¸º Wasm æ‰©å±•çš„å¼€å‘æä¾›äº†ä¸é”™ä½“éªŒã€‚æœ¬æ–‡ä¸»è¦ä»‹ç»å¦‚ä½•ä½¿ç”¨ Rust SDK å¼€å‘ Istio Wasm æ‰©å±•ã€‚&lt;/p&gt;

&lt;h2 id=&#34;wasme-å·¥å…·&#34;&gt;Wasme å·¥å…·&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.solo.io/web-assembly-hub/latest/tutorial_code/getting_started/&#34;&gt;WebAssembly Hub Getting Started&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ curl -sL https://run.solo.io/wasme/install | sh
$ export PATH=$HOME/.wasme/bin:$PATH
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ wasme --version

wasme version 0.0.14
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;rust-é¡¹ç›®&#34;&gt;Rust é¡¹ç›®&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://www.rust-lang.org/zh-CN/tools/install&#34;&gt;Rustå®‰è£…&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ rustc --version

rustc 1.43.1 (8d69840ab 2020-05-04)
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;p&gt;åˆ›å»ºRusté¡¹ç›®&lt;/p&gt;

&lt;p&gt;ä½¿ç”¨&lt;code&gt;lib&lt;/code&gt;æ¨¡æ¿åˆ›å»ºé¡¹ç›®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ cargo new hello-wold --lib 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç¼–è¾‘&lt;code&gt;Cargo.toml&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;æ·»åŠ ä¾èµ–&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-toml&#34;&gt;[dependencies]
log = &amp;quot;0.4.8&amp;quot;
proxy-wasm = &amp;quot;0.1.0&amp;quot; # The Rust SDK for proxy-wasm
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é…ç½®åŠ¨æ€åº“ç¼–è¯‘&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-toml&#34;&gt;[lib]
path = &amp;quot;src/lib.rs&amp;quot;
crate-type = [&amp;quot;cdylib&amp;quot;]
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;wasm-æ‰©å±•&#34;&gt;Wasm æ‰©å±•&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;æºç &lt;a href=&#34;https://github.com/hb-chen/wasm-hello-world-rust&#34;&gt;hb-chen/wasm-hello-world-rust&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;å…ˆé€šè¿‡ Rust SDK äº†è§£æ‰©å±•åŠŸèƒ½ï¼Œç¼–è¾‘&lt;code&gt;src/lib.rs&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-rust&#34;&gt;use proxy_wasm as wasm;

struct HelloWorld {
    context_id: u32,
}

impl wasm::traits::Context for HelloWorld {}
impl wasm::traits::RootContext for HelloWorld{}
impl wasm::traits::StreamContext for HelloWorld{}
impl wasm::traits::HttpContext for HelloWorld{}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å®‰è£…ä¾èµ–&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ cargo build
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¦äº†è§£æ‰©å±•çœ‹ä¸‹å‡ ä¸ª Context çš„ç»“æ„ï¼Œå…¶ä¸­&lt;code&gt;on_*&lt;/code&gt;å¼€å¤´çš„ä¾¿æ˜¯æ‰©å±•ç‚¹ï¼Œå…¶ä»–&lt;code&gt;get_*&lt;/code&gt;ã€&lt;code&gt;set_*&lt;/code&gt;ã€&lt;code&gt;add_*&lt;/code&gt;ç­‰æä¾›äº†ä¸èƒ½æ¥å£èƒ½åŠ›ã€‚&lt;/p&gt;

&lt;p&gt;ä¸º Request æ·»åŠ è‡ªå®šä¹‰ Header&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-rust&#34;&gt;use log::info;
use proxy_wasm as wasm;

#[no_mangle]
pub fn _start() {
    proxy_wasm::set_log_level(wasm::types::LogLevel::Trace);
    proxy_wasm::set_http_context(
        |context_id, _root_context_id| -&amp;gt; Box&amp;lt;dyn wasm::traits::HttpContext&amp;gt; {
            Box::new(HelloWorld { context_id })
        },
    )
}

struct HelloWorld {
    context_id: u32,
}

impl wasm::traits::Context for HelloWorld {}

impl wasm::traits::HttpContext for HelloWorld {
    fn on_http_request_headers(&amp;amp;mut self, num_headers: usize) -&amp;gt; wasm::types::Action {
        info!(&amp;quot;Got {} HTTP headers in #{}.&amp;quot;, num_headers, self.context_id);
        let headers = self.get_http_request_headers();
        let mut authority = &amp;quot;&amp;quot;;

        for (name, value) in &amp;amp;headers {
            if name == &amp;quot;:authority&amp;quot; {
                authority = value;
            }
        }

        self.set_http_request_header(&amp;quot;x-hello&amp;quot;, Some(&amp;amp;format!(&amp;quot;Hello world from {}&amp;quot;, authority)));

        wasm::types::Action::Continue
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç¼–è¯‘&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ cargo build --target wasm32-unknown-unknown --release
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;runtime-config.json&lt;/code&gt;æ˜¯&lt;code&gt;wasme build&lt;/code&gt;æ—¶éœ€è¦çš„ï¼Œå¯ä»¥é€šè¿‡&lt;code&gt;wasme init&lt;/code&gt;åˆ›å»ºä¸€ä¸ª&lt;code&gt;cpp&lt;/code&gt;é¡¹ç›®è·å¾—&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-json&#34;&gt;{
  &amp;quot;type&amp;quot;: &amp;quot;envoy_proxy&amp;quot;,
  &amp;quot;abiVersions&amp;quot;: [
    &amp;quot;v0-097b7f2e4cc1fb490cc1943d0d633655ac3c522f&amp;quot;
  ],
  &amp;quot;config&amp;quot;: {
    &amp;quot;rootIds&amp;quot;: [
      &amp;quot;hello_world&amp;quot;
    ]
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ‰“åŒ…&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ wasme build precompiled target/wasm32-unknown-unknown/release/hello_world.wasm --tag webassemblyhub.io/hbchen/hello_world:v0.1
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ wasme list

NAME                          TAG  SIZE   SHA      UPDATED
webassemblyhub.io/hbchen/hello_world v0.1 1.9 MB 2e95e556 22 May 20 10:27 CST
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;wasme build&lt;/code&gt;ä¸‰ç§æ–¹å¼ï¼Œ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ wasme build -h

Available Commands:
  assemblyscript Build a wasm image from an AssemblyScript filter using NPM-in-Docker
  cpp            Build a wasm image from a CPP filter using Bazel-in-Docker
  precompiled    Build a wasm image from a Precompiled filter.
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;æœ¬åœ°æµ‹è¯•-envoy&#34;&gt;æœ¬åœ°æµ‹è¯• Envoy&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ wasme deploy envoy webassemblyhub.io/hbchen/hello_world:v0.1 --envoy-image=istio/proxyv2:1.6.0 --bootstrap=envoy-bootstrap.yml
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;[2020-05-24 03:03:41.736][12][info][wasm] [external/envoy/source/extensions/common/wasm/context.cc:1103] wasm log hello_world hello_world : Got 16 HTTP headers in #9.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a href=&#34;http://localhost:8080/headers&#34;&gt;http://localhost:8080/headers&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-json&#34;&gt;{
  &amp;quot;headers&amp;quot; : {
    &amp;quot;X-Hello&amp;quot; : &amp;quot;Hello world from localhost:8080&amp;quot;
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;wasme deploy&lt;/code&gt;ä¸‰ç§æ–¹å¼&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ wasme deploy -h

Available Commands:
  envoy       Run Envoy locally in Docker and attach a WASM Filter.
  gloo        Deploy an Envoy WASM Filter to the Gloo Gateway Proxies (Envoy).
  istio       Deploy an Envoy WASM Filter to Istio Sidecar Proxies (Envoy).
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;webassembly-hub-ä½¿ç”¨&#34;&gt;WebAssembly Hub ä½¿ç”¨&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://docs.solo.io/web-assembly-hub/latest/tutorial_code/getting_started/#create-a-user-on-webassemblyhub-io-https-webassemblyhub-io&#34;&gt;Create a User on webassemblyhub.io &amp;amp; Log In from the wasme command line&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Push é•œåƒ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ wasme push webassemblyhub.io/hbchen/hello_world:v0.1
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;å‘å¸ƒåˆ°-istio&#34;&gt;å‘å¸ƒåˆ° Istio&lt;/h2&gt;

&lt;blockquote&gt;
&lt;p&gt;httpbin ç”¨ä¾‹è‡ªå·±éƒ¨ç½²ï¼Œæœ¬ä¾‹&lt;code&gt;namespace=ns-httpbin&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;å¯ä»¥åˆ†åˆ«é€šè¿‡&lt;code&gt;wasme&lt;/code&gt;å·¥å…·æˆ–&lt;code&gt;operator&lt;/code&gt;æ·»åŠ æ‰©å±•&lt;/p&gt;

&lt;h3 id=&#34;cli-æ‰‹åŠ¨æ·»åŠ &#34;&gt;CLI æ‰‹åŠ¨æ·»åŠ &lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ wasme deploy istio webassemblyhub.io/hbchen/hello_world:v0.1 \
  --id=hello-world-filter \
  --namespace=ns-httpbin
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;http://{ingress-host}:{port}/headers&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-json&#34;&gt;{
  &amp;quot;headers&amp;quot; : {
    &amp;quot;X-Hello&amp;quot; : &amp;quot;Hello world from {ingress-host}&amp;quot;
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¸è½½&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ wasme undeploy istio \
  --id=hello-world-filter \
  --namespace=ns-httpbin
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;operator&#34;&gt;Operator&lt;/h3&gt;

&lt;p&gt;CRD&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ kubectl apply -f https://github.com/solo-io/wasme/releases/latest/download/wasme.io_v1_crds.yaml

customresourcedefinition.apiextensions.k8s.io/filterdeployments.wasme.io created
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Operator&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ kubectl apply -f https://github.com/solo-io/wasme/releases/latest/download/wasme-default.yaml

namespace/wasme created
configmap/wasme-cache created
serviceaccount/wasme-cache created
serviceaccount/wasme-operator created
clusterrole.rbac.authorization.k8s.io/wasme-operator created
clusterrole.rbac.authorization.k8s.io/wasme-cache created
clusterrolebinding.rbac.authorization.k8s.io/wasme-operator created
clusterrolebinding.rbac.authorization.k8s.io/wasme-cache created
daemonset.apps/wasme-cache created
deployment.apps/wasme-operator created
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Filter&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;$ kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: wasme.io/v1
kind: FilterDeployment
metadata:
  name: hello-world-filter
  namespace: ns-httpbin
spec:
  deployment:
    istio:
      kind: Deployment
  filter:
    image: webassemblyhub.io/hbchen/hello_world:v0.1
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Filter çŠ¶æ€&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ kubectl get filterdeployments.wasme.io -n ns-httpbin -o yaml hello-world-filter

status:
  observedGeneration: &amp;quot;1&amp;quot;
  workloads:
    httpbin:
      state: Succeeded
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;æ³¨æ„çœ‹ä¸‹ Pod æ˜¯å¦æˆåŠŸï¼Œå¦‚æœ&lt;code&gt;READY 1/2&lt;/code&gt;å¯èƒ½æ˜¯&lt;code&gt;istio-proxy&lt;/code&gt;æ²¡æœ‰å¯åŠ¨ï¼Œæµ‹è¯•æ—¶è¿™é‡Œé‡åˆ°é—®é¢˜&lt;code&gt;wasme-cache&lt;/code&gt;ç»å¸¸å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼Œå¹¶ä¸”å¤±è´¥åä¸èƒ½ç»­ä¼ ã€‚å¯ä»¥è¿›å…¥ Pod çœ‹ç¼“å­˜çš„å°ºå¯¸æ˜¯å¦å’Œ&lt;code&gt;hello_world.wasm&lt;/code&gt;å°ºå¯¸ä¸€è‡´ï¼Œç¼“å­˜è·¯å¾„&lt;code&gt;/var/local/lib/wasme-cache/&lt;/code&gt;ï¼Œä¸ä¸€è‡´å°±ç­‰ç¼“å­˜å®Œæˆåå†æµ‹è¯•ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;http://{ingress-host}:{port}/headers&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-json&#34;&gt;{
  &amp;quot;headers&amp;quot; : {
    &amp;quot;X-Hello&amp;quot; : &amp;quot;Hello world from {ingress-host}&amp;quot;
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¸è½½&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ kubectl delete FilterDeployment -n ns-httpbin hello-world-filter
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;ref&#34;&gt;Ref&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.solo.io/web-assembly-hub/latest/tutorial_code/&#34;&gt;WebAssembly Hub Tutorials&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/blog/2020/deploy-wasm-declarative/&#34;&gt;Declarative WebAssembly deployment for Istio&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://blog.red-badger.com/extending-istio-with-rust-and-webassembly&#34;&gt;Extending Istio with Rust and WebAssembly&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.solo.io/web-assembly-hub/latest/tutorial_code/deploy_tutorials/deploying_with_istio/&#34;&gt;Deploying Wasm Filters to Istio&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/blog/2020/wasmhub-istio/&#34;&gt;Extended and Improved WebAssemblyHub to Bring the Power of WebAssembly to Envoy and Istio&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
      
    </item>
    
    <item>
      <title>ã€DevOpsã€‘Drone CI/CD Go &#43; node &#43; kubernetes</title>
      <link>http://hbchen.com/post/devops/2020-05-07-drone/</link>
      <pubDate>Thu, 07 May 2020 20:38:53 +0800</pubDate>
      
      <guid>http://hbchen.com/post/devops/2020-05-07-drone/</guid>
      
        <description>&lt;p&gt;æœ¬æ–‡ä»‹ç»å¦‚ä½•ä½¿ç”¨ Drone æŒç»­æ„å»ºä¸å‘å¸ƒ Golang + node + kubernetes åº”ç”¨ã€‚&lt;/p&gt;

&lt;h2 id=&#34;docker-éƒ¨ç½²-drone&#34;&gt;Docker éƒ¨ç½² Drone&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;docker-compose.yaml&lt;/code&gt;ç¤ºä¾‹ï¼Œ å…¶ä¸­é…ç½®é¡¹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Key&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;GITHUB_USER_NAME&lt;/td&gt;
&lt;td&gt;GitHub çš„&lt;code&gt;username&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;TOKEN&lt;/td&gt;
&lt;td&gt;API æˆ– Cli è¿æ¥ Drone æœåŠ¡ç”¨çš„ tokenï¼Œå¯ä»¥éšæœºç”Ÿæˆ:&lt;code&gt;openssl rand -hex 16&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;GITHUB_CLIENT_ID&lt;/td&gt;
&lt;td&gt;å‚è€ƒ Drone æ–‡æ¡£ &lt;a href=&#34;https://docs.drone.io/server/provider/github/#create-an-oauth-application&#34;&gt;GitHub å¼•å¯¼&lt;/a&gt; åˆ›å»º &lt;a href=&#34;https://github.com/settings/developers&#34;&gt;OAuth Application&lt;/a&gt;ï¼Œé…ç½®å‚è€ƒå¦‚ä¸‹:&lt;br/&gt;&lt;code&gt;Homepage URL&lt;/code&gt;ä¸º&lt;code&gt;http://{SERVER_HOST}&lt;/code&gt;ï¼Œæ³¨æ„å¦‚æœä¸æ˜¯&lt;code&gt;80&lt;/code&gt;ç«¯å£éœ€è¦å¸¦ç«¯å£ï¼Œå¦‚&lt;code&gt;http://drone.hbchen.com:8000&lt;/code&gt;&lt;br/&gt;&lt;code&gt;Authorization callback URL&lt;/code&gt;ä¸º&lt;code&gt;{Homepage URL}/login&lt;/code&gt;ï¼Œå¦‚&lt;code&gt;http://drone.hbchen.com:8000/login&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;GITHUB_CLIENT_SECRET&lt;/td&gt;
&lt;td&gt;åŒä¸Š&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;SERVER_HOST&lt;/td&gt;
&lt;td&gt;ç»‘å®šçš„åŸŸåï¼Œå¦‚&lt;code&gt;drone.hbchen.com&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;RPC_SECRET&lt;/td&gt;
&lt;td&gt;Drone server å’Œ runner é€šä¿¡ç”¨çš„ secretï¼Œå¯ä»¥éšæœºç”Ÿæˆ:&lt;code&gt;openssl rand -hex 16&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;RUNNER_DASHBOARD_USERNAME&lt;/td&gt;
&lt;td&gt;&lt;code&gt;å¯é€‰&lt;/code&gt;ï¼ŒRunner å¯ä»¥åœ¨&lt;code&gt;3000&lt;/code&gt;ç«¯å£æä¾›ä¸€ä¸ª dashboardï¼Œå¦‚æœéœ€è¦å¯ä»¥é…ç½®ç”¨æˆ·åå’Œå¯†ç &lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;RUNNER_DASHBOARD_PASSWORD&lt;/td&gt;
&lt;td&gt;åŒä¸Š&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚æœå¤–ç½‘ä½¿ç”¨çš„ä¸æ˜¯80ç«¯å£ï¼ˆå¦‚æ­¤å¤„ä½¿ç”¨&lt;code&gt;8000&lt;/code&gt;ï¼‰ï¼Œåœ¨æ¿€æ´»ä¸€ä¸ª Repo åéœ€è¦ä¿®æ”¹ Repo Webhook çš„åœ°å€ï¼Œå¢åŠ ç«¯å£&lt;/li&gt;
&lt;li&gt;ä¸ºç”¨æˆ·æ·»åŠ  admin æƒé™ï¼Œåš cache æŒ‚è½½ volume æ—¶éœ€è¦å°† Repo çš„ &lt;code&gt;Project settings&lt;/code&gt; è®¾ç½®ä¸º &lt;code&gt;trusted&lt;/code&gt;ï¼Œè¦ admin æ‰æœ‰æ­¤æƒé™&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;version: &#39;3&#39;

services:
  drone-server:
    image: drone/drone:1.6
    restart: always
    ports:
      - 8000:80
    volumes:
      - /var/lib/drone:/data
    environment:
      - DRONE_USER_CREATE=username:{GITHUB_USER_NAME},machine:false,admin:true,token:{TOKEN}
      - DRONE_GITHUB_SERVER=https://github.com
      - DRONE_GITHUB_CLIENT_ID={GITHUB_CLIENT_ID}
      - DRONE_GITHUB_CLIENT_SECRET={GITHUB_CLIENT_SECRET}
      - DRONE_GITHUB_SKIP_VERIFY=true
      - DRONE_SERVER_HOST={SERVER_HOST}
      - DRONE_SERVER_PROTO=http
      - DRONE_RPC_SECRET={RPC_SECRET}

  drone-runner:
    image: drone/drone-runner-docker:1.2
    restart: always
    ports:
      - 3000:3000
    depends_on:
      - drone-server
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DRONE_RPC_HOST=drone-server
      - DRONE_RPC_PROTO=http
      - DRONE_RPC_SECRET={RPC_SECRET}
      - DRONE_RUNNER_NAME=drone-runner
      - DRONE_RUNNER_CAPACITY=2
      - DRONE_UI_USERNAME={RUNNER_DASHBOARD_USERNAME}
      - DRONE_UI_PASSWORD={RUNNER_DASHBOARD_PASSWORD}

&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;drone-pipeline&#34;&gt;Drone Pipeline&lt;/h2&gt;

&lt;h3 id=&#34;secret-é…ç½®&#34;&gt;Secret é…ç½®&lt;/h3&gt;

&lt;p&gt;Pipeline æ¶‰åŠåˆ° Secret é…ç½®ä¸æˆ‘ä»¬çš„ç›®æ ‡ç›¸å…³ï¼Œä»¥&lt;a href=&#34;https://github.com/micro-in-cn/starter-kit/blob/master/.drone.yml&#34;&gt;micro-in-cn/starter-kit/.drone.yml&lt;/a&gt;ä¸ºä¾‹ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Docker é•œåƒå‘å¸ƒ

&lt;ul&gt;
&lt;li&gt;push é•œåƒéœ€è¦ä»“åº“ç”¨æˆ·ååŠå¯†ç &lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;k8s éƒ¨ç½²

&lt;ul&gt;
&lt;li&gt;kubectl éœ€è¦é…ç½®&lt;code&gt;server&lt;/code&gt;ã€&lt;code&gt;ca&lt;/code&gt;å’Œ&lt;code&gt;token&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;k8s é…ç½®è·å–&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;1.å–ä¸€ä¸ª Pod çš„ Secret æˆ–è€…å•ç‹¬åˆ›å»ºä¸€ä¸ª account&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;kubectl describe po {pod-name} | grep SecretName
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2.å–Secretçš„caå’Œtoken&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;kubectl get secret {secret-name} -o yaml | egrep &#39;ca.crt:|token:&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;3.drone secret é…ç½®&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;k8s_server&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;cat ~/.kube/config&lt;/code&gt;ï¼Œ&lt;em&gt;é€‚ç”¨äº&lt;code&gt;minikube&lt;/code&gt;ç¯å¢ƒ&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;k8s_ca&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;caç›´æ¥ä½¿ç”¨&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;k8s_token&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;tokenåšbase64è§£ç åä½¿ç”¨&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;kubectl&lt;/code&gt;éƒ¨ç½²éœ€è¦å¯¹åº”çš„accountæœ‰æˆæƒ&lt;/strong&gt;ï¼Œæ ¹æ®è‡ªå·±çš„ç¯å¢ƒæƒ…å†µé…ç½®&lt;br/&gt;
æµ‹è¯•å¯ä»¥å°†clusterrole=cluster-adminæˆæƒç»™serviceaccount&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# Error from server (Forbidden): services is forbidden: User &amp;quot;system:serviceaccount:default:default&amp;quot; cannot list resource &amp;quot;services&amp;quot; in API group &amp;quot;&amp;quot; in the namespace &amp;quot;default&amp;quot;
kubectl create clusterrolebinding cluster-admin-role-bound --clusterrole=cluster-admin --serviceaccount={namespace}:{service-account}
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä½¿ç”¨ drone cli å·¥å…·è¿æ¥ drone server&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å–œæ¬¢ web æ“ä½œå¯ä»¥é€‰æ‹©åœ¨æ§åˆ¶å°é…ç½® secret&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;export DRONE_SERVER=http://drone.hbchen.com:8000
export DRONE_TOKEN={å‰é¢é…ç½®çš„TOKEN}
drone info
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;drone secret add --repository=micro-in-cn/starter-kit --name=ali_registry_username --data={xxx}
drone secret add --repository=micro-in-cn/starter-kit --name=ali_registry_password --data={xxx}
drone secret add --repository=micro-in-cn/starter-kit --name=k8s_server --data={xxx}
drone secret add --repository=micro-in-cn/starter-kit --name=k8s_ca --data={xxx}
drone secret add --repository=micro-in-cn/starter-kit --name=k8s_token --data={xxx}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;ç¼–è¯‘-ç¼“å­˜&#34;&gt;ç¼–è¯‘&amp;amp;ç¼“å­˜&lt;/h3&gt;

&lt;p&gt;åœ¨é¡¹ç›®ç¼–è¯‘æ—¶éƒ½ä¼šæœ‰å¤§é‡çš„ä¾èµ–ä¸‹è½½ï¼Œè¿™äº›å¯¹ç¼–è¯‘é€Ÿåº¦å½±å“å¾ˆå¤§ï¼Œå¹¶ä¸”å®¹æ˜“å¯¼è‡´å¤±è´¥ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ç¼“å­˜ï¼Œé¿å…æ¯æ¬¡éƒ½è¦é‡æ–°æ‹‰å–ä¾èµ–ï¼Œä»¥&lt;a href=&#34;https://github.com/micro-in-cn/starter-kit/blob/master/console/web&#34;&gt;micro-in-cn/starter-kit/console/web&lt;/a&gt;ä¸ºä¾‹ï¼Œæœ‰ Golang å’Œ node çš„ç¼–è¯‘ï¼Œä½¿ç”¨ drone ç¤¾åŒº&lt;code&gt;drillster/drone-volume-cache&lt;/code&gt;æ’ä»¶å¯¹ Golang å’Œ node ä¾èµ–è¿›è¡Œç¼“å­˜ã€‚åŸºæœ¬è¿‡ç¨‹å°±æ˜¯åœ¨ç¼–è¯‘å‰å°†&lt;code&gt;cache&lt;/code&gt;åŠ è½½åˆ°ç›¸åº”ç›®å½•ï¼Œç¼–è¯‘åé‡æ–°å°†&lt;code&gt;cache&lt;/code&gt;å†™å›&lt;code&gt;volume&lt;/code&gt;ï¼Œç¼–è¯‘æ—¶ Golang éœ€è¦æŒ‡å®š&lt;code&gt;GOPATH&lt;/code&gt;ï¼Œnode æŒ‡å®š&lt;code&gt;global cache&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;# æŒ‚è½½ host ç¼“å­˜ç›®å½•
volumes:
  - name: cache
    host:
      path: /tmp/drone_cache

steps:
  - name: restore-cache
    image: drillster/drone-volume-cache
    settings:
      restore: true
      mount:
        - ./.npm-cache
        - ./console/web/vue/node_modules
        - ./_gopath
    volumes:
      - name: cache
        path: /cache
    when:
      event:
        - push
  - name: build-vue
    image: node:10.16.3-alpine
    commands:
      - cd console/web/vue
      - npm config set cache ./.npm-cache --global
      - npm install
      - export VUE_APP_BASE_API=
      - npm run build:prod
    when:
      event:
        - push
  - name: build-golang
    image: golang:1.13-alpine
    environment:
      GOPATH: /drone/src/github.com/micro-in-cn/starter-kit/_gopath
      GOOS: linux
      GOARCH: amd64
      CGO_ENABLED: 0
      GOPROXY: https://mirrors.aliyun.com/goproxy/,direct
      GOSUMDB: off
    commands:
      - cd console/web
      - go version
      - go build -o ./bin/linux_amd64/console-web main.go plugin.go
    when:
      event:
        - push
  - name: rebuild-cache
    image: drillster/drone-volume-cache
    settings:
      rebuild: true
      mount:
        - ./.npm-cache
        - ./console/web/vue/node_modules
        - ./_gopath
    volumes:
      - name: cache
        path: /cache
    when:
      event:
        - push
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;å‘å¸ƒé•œåƒ-éƒ¨ç½²&#34;&gt;å‘å¸ƒé•œåƒ&amp;amp;éƒ¨ç½²&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;docker username å’Œ password é€šè¿‡ secret è·å–&lt;/li&gt;
&lt;li&gt;k8s å…ˆç”¨ secret é…ç½®ç¯å¢ƒå˜é‡ï¼Œä½¿ç”¨æ—¶å†ä»ç¯å¢ƒå˜é‡å»å–&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;  - name: publish-xxx
    image: plugins/docker
    settings:
      tags: latest
      dockerfile: ./console/api/Dockerfile
      context: ./console/web
      repo: registry.cn-hangzhou.aliyuncs.com/hb-chen/starter-kit-console-api
      registry: registry.cn-hangzhou.aliyuncs.com
      username:
        from_secret: ali_registry_username
      password:
        from_secret: ali_registry_password
    when:
      event:
        - push
  - name: deploy-xxx
    image: dtzar/helm-kubectl:3.1.1
    environment:
      SERVER:
        from_secret: k8s_server
      CERTIFICATE_AUTHORITY_DATA:
        from_secret: k8s_ca
      USER_TOKEN:
        from_secret: k8s_token
    commands:
      - kubectl config set-cluster k8s --server=&amp;quot;$${SERVER}&amp;quot;
      - kubectl config set clusters.k8s.certificate-authority-data &amp;quot;$${CERTIFICATE_AUTHORITY_DATA}&amp;quot;
      - kubectl config set-credentials k8s-admin --token=&amp;quot;$${USER_TOKEN}&amp;quot;
      - kubectl config set-context default --cluster=k8s --user=k8s-admin
      - kubectl config use-context default
      - helm template micro ./deploy/k8s/helm/starter-kit/charts/service --namespace starter-kit --set nameOverride=console-api --set micro.command=/console-api --set image.repository=registry.cn-hangzhou.aliyuncs.com/hb-chen/starter-kit-console-api --set image.tag=${DRONE_TAG=latest} --set image.pullPolicy=Always --set serviceAccount.create=true --set serviceAccount.name=micro-services | kubectl apply -f -
    when:
      event:
        - push
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>ã€go-microã€‘å¼€å‘åä½œ-æœ¬åœ°æœåŠ¡æ¥å…¥çº¿ä¸Šé›†æˆç¯å¢ƒ</title>
      <link>http://hbchen.com/post/microservice/2020-03-22-micro-dev-local/</link>
      <pubDate>Sun, 22 Mar 2020 10:53:43 +0800</pubDate>
      
      <guid>http://hbchen.com/post/microservice/2020-03-22-micro-dev-local/</guid>
      
        <description>&lt;p&gt;åœ¨&lt;a href=&#34;http://hbchen.com/post/microservice/2019-11-30-go-micro-service-chain/&#34;&gt;å¾®æœåŠ¡åä½œå¼€å‘ã€ç°åº¦å‘å¸ƒä¹‹æµé‡æŸ“è‰²&lt;/a&gt;ä»‹ç»äº†å¦‚ä½•é€šè¿‡æµé‡æŸ“è‰²åœ¨å¼€å‘ç¯å¢ƒè¿›è¡Œå¤šæœåŠ¡ã€å¤šç‰ˆæœ¬çš„åä½œå¼€å‘ï¼Œ
ä½†è¿™éƒ½æ˜¯åœ¨æœåŠ¡å·²ç»å‘å¸ƒåˆ°é›†æˆç¯å¢ƒæƒ…å†µä¸‹ï¼Œå¼€å‘è¿‡ç¨‹ä¸­å¯¹äºå•ä¸ªæœåŠ¡çš„å¼€å‘/ç»´æŠ¤è€…å¾€å¾€éœ€è¦å¿«é€Ÿçš„å°†æœ¬åœ°æœåŠ¡é›†æˆåˆ°åœ¨çº¿ç¯å¢ƒï¼Œä»¥å®Œæˆæ›´å¥½é›†æˆæµ‹è¯•ï¼Œè€Œä¸æ˜¯ç­‰å¾…å‘å¸ƒæµç¨‹ï¼Œ
è¿™æ ·ä¸€æ˜¯èŠ‚çº¦æ—¶é—´ï¼ŒäºŒæ˜¯é¿å…å°†æœ‰é—®é¢˜çš„æœåŠ¡å‘å¸ƒåˆ°çº¿ä¸Šé›†æˆç¯å¢ƒï¼Œå¯¹Taäººé€ æˆå½±å“ã€‚æœ¬æ–‡å°†ä»‹ç»åœ¨&lt;code&gt;micro&lt;/code&gt;ç”Ÿæ€å¦‚ä½•é€šè¿‡&lt;code&gt;network&lt;/code&gt;å°†æœ¬åœ°æœåŠ¡åŠ å…¥åˆ°çº¿ä¸Šé›†æˆç¯å¢ƒï¼Œæ—¢å¯ä»¥å¿«é€Ÿæµ‹è¯•ï¼Œåˆä¸å½±å“é›†æˆç¯å¢ƒã€‚&lt;/p&gt;

&lt;h1 id=&#34;æ–¹æ¡ˆ&#34;&gt;æ–¹æ¡ˆ&lt;/h1&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/micro/dev-local.png&#34; alt=&#34;network_dev_local&#34; /&gt;&lt;/p&gt;

&lt;p&gt;æ•´ä½“æ–¹æ¡ˆä¸€æ˜¯&lt;code&gt;go-micro&lt;/code&gt;çš„æœåŠ¡çš„&lt;code&gt;proxy&lt;/code&gt;æ–¹å¼ï¼Œï¼Œå¹¶ä¸”åœ¨ä»£ç†ä¸­æœ‰&lt;code&gt;router&lt;/code&gt;ç­›é€‰åŠŸèƒ½ï¼ŒäºŒæ˜¯&lt;code&gt;network&lt;/code&gt;æä¾›è¿æ¥ä¸åŒç½‘ç»œç¯å¢ƒçš„èƒ½åŠ›ã€‚&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;é¦–å…ˆåœ¨çº¿ä¸Šå’Œæœ¬åœ°éƒ¨ç½²&lt;code&gt;network&lt;/code&gt;æœåŠ¡ï¼Œæœ‰å…³&lt;code&gt;network&lt;/code&gt;çš„å†…å®¹å¯ä»¥å‚è€ƒæœ¬æ–‡&lt;a href=&#34;http://hbchen.com/post/microservice/2019-11-15-go-micro-network/&#34;&gt;ã€go-microã€‘Networkåˆæ¢&lt;/a&gt;ï¼Œ
æœ‰äº†&lt;code&gt;network&lt;/code&gt;çš„åŸºç¡€å‰©ä¸‹çš„å·¥ä½œå°±æ˜¯&lt;code&gt;proxy&lt;/code&gt;çš„&lt;code&gt;router&lt;/code&gt;ç­›é€‰åŠŸèƒ½ï¼Œå®ç°å‚è€ƒ PR&lt;a href=&#34;https://github.com/micro/go-micro/pull/897&#34;&gt;#897&lt;/a&gt;ï¼Œ
ä»å®ç°æˆ‘ä»¬çŸ¥é“é€šè¿‡&lt;code&gt;Micro-Router&lt;/code&gt;ã€&lt;code&gt;Micro-Network&lt;/code&gt;å’Œ&lt;code&gt;Micro-Gateway&lt;/code&gt;ä¸‰ä¸ª&lt;code&gt;metadata&lt;/code&gt;å¯ä»¥å¯¹&lt;code&gt;router&lt;/code&gt;è¿›è¡Œç­›é€‰ï¼Œè€Œä½¿ç”¨&lt;code&gt;Micro-Address&lt;/code&gt;ä»¥åŠåŸºäº&lt;code&gt;label&lt;/code&gt;çš„ç­›é€‰è¿˜å¤„äº&lt;strong&gt;&lt;em&gt;TODO&lt;/em&gt;&lt;/strong&gt;çŠ¶æ€ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;å…¶æ¬¡åœ¨çº¿ä¸ŠåŠæœ¬åœ°æ‰€æœ‰æœåŠ¡éƒ½éœ€è¦æ˜¯ç”¨&lt;code&gt;network&lt;/code&gt;åšä¸ºä»£ç†(&lt;code&gt;MICRO_PROXY=go.micro.network&lt;/code&gt;)åŒ…æ‹¬ç½‘å…³(&lt;em&gt;æ³¨æ„é»˜è®¤ç½‘å…³ä¸æ”¯æŒæœåŠ¡ç­›é€‰ï¼Œå¯¼è‡´ç½‘å…³ä¸èƒ½ç”¨networkåšä»£ç†&lt;/em&gt;)ï¼Œè¿™æ ·æœåŠ¡é—´æ‰€æœ‰æµé‡éƒ½é€šè¿‡&lt;code&gt;network&lt;/code&gt;è¿›è¡Œä»£ç†è½¬å‘ã€‚&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;æœ€åè€ƒè™‘æ‰€æœ‰æœåŠ¡éƒ½å¯ä»¥è‡ªåŠ©è·¯ç”±åˆ°ä¸ªäººæœ¬åœ°ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥ä½¿ç”¨&lt;code&gt;Micro-Router&lt;/code&gt;ï¼Œå› ä¸º&lt;code&gt;Micro-Router&lt;/code&gt;ä¼šåœ¨å…¨é“¾è·¯ç”Ÿæ•ˆï¼Œéœ€è¦ä½¿ç”¨&lt;code&gt;metadata&lt;/code&gt;æ¥ä¼ é€’&lt;code&gt;router&lt;/code&gt;ç­›é€‰ä¿¡æ¯ï¼Œ
å†é€šè¿‡&lt;code&gt;Client/Call Wrap&lt;/code&gt;å®ç°&lt;code&gt;Micro-Router&lt;/code&gt;çš„æ¢å¤å’Œæ¸…ç†ï¼Œåœ¨è¯†åˆ«åˆ°è°ƒç”¨æœåŠ¡éœ€è¦ç­›é€‰æ—¶æ·»åŠ &lt;code&gt;Micro-Router&lt;/code&gt;ï¼Œå¦åˆ™æ¸…ç†&lt;code&gt;Micro-Router&lt;/code&gt;ï¼Œé¿å…å‘ä¸‹ä¼ å¯¼ï¼Œå®è·µå‚è€ƒ&lt;a href=&#34;https://github.com/micro-in-cn/starter-kit/tree/master/pkg/plugin/wrapper/client/router_filter&#34;&gt;router_filter&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;strong&gt;&lt;em&gt;å®è·µå‚è€ƒ&lt;/em&gt;&lt;/strong&gt; &lt;a href=&#34;https://github.com/micro-in-cn/starter-kit#%E6%9C%AC%E5%9C%B0%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%85%A5-network%E4%BB%A3%E7%90%86&#34;&gt;micro-in-cn/starter-kit#æœ¬åœ°æœåŠ¡æ¥å…¥-networkä»£ç†&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;å±€é™æ€§-é—®é¢˜&#34;&gt;å±€é™æ€§/é—®é¢˜&lt;/h1&gt;

&lt;ul&gt;
&lt;li&gt;æ‰€æœ‰æœåŠ¡éƒ½è¦ä½¿ç”¨&lt;code&gt;network&lt;/code&gt;åšä»£ç†ï¼Œå¦‚æœæ¡†æ¶èƒ½å¤Ÿåœ¨&lt;code&gt;CallOption&lt;/code&gt;ä¸­æ”¯æŒåŠ¨æ€ä½¿ç”¨ä»£ç†å°†ä¼šæ›´å¥½&lt;/li&gt;
&lt;li&gt;æ‰€æœ‰æœåŠ¡éƒ½éœ€è¦æ·»åŠ &lt;code&gt;Client/Call Wrap&lt;/code&gt;ï¼Œéœ€è¦ç»Ÿä¸€çš„è§„èŒƒçº¦å®š&lt;/li&gt;
&lt;li&gt;åœ¨ç½‘å…³å±‚ä¸&lt;a href=&#34;http://hbchen.com/post/microservice/2019-11-30-go-micro-service-chain/#%E7%BD%91%E5%85%B3%E6%9C%8D%E5%8A%A1%E7%AD%9B%E9%80%89-%E5%9D%91&#34;&gt;æµé‡æŸ“è‰²&lt;/a&gt;é‡åˆ°ç›¸åŒçš„é—®é¢˜å³ï¼š&lt;strong&gt;&lt;em&gt;ä¸æ”¯æŒæœåŠ¡ç­›é€‰ï¼Œå¯¼è‡´ç½‘å…³ä¸èƒ½ç”¨networkåšä»£ç†&lt;/em&gt;&lt;/strong&gt;ï¼Œéœ€è¦å»æ‰&lt;code&gt;SelectOption&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;å¦ä¸€ä¸ªæ€è·¯æ˜¯åœ¨æœ¬åœ°å¼€&lt;code&gt;micro api&lt;/code&gt; + &lt;code&gt;èšåˆæœåŠ¡&lt;/code&gt;ï¼ŒèšåˆæœåŠ¡å†é€šè¿‡ network ä»£ç†è®¿é—®çº¿ä¸ŠæœåŠ¡&lt;/strong&gt;ï¼Œå¯ä»¥æ»¡è¶³ä¸€èˆ¬åœºæ™¯çš„éœ€æ±‚&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;ä¸ºäº†é¿å…è¯¯åä½œè¿‡ç¨‹ä¸­è·¯ç”±åˆ°Taäººæœ¬åœ°ç¯å¢ƒï¼Œå¯ä»¥å†å¢åŠ &lt;code&gt;Micro-Network&lt;/code&gt;è§„åˆ™ï¼Œçº¿ä¸Šä¸æœ¬åœ°&lt;code&gt;network&lt;/code&gt;ä½¿ç”¨ä¸åŒåç§°(&lt;em&gt;æœªå®æµ‹&lt;/em&gt;)

&lt;ul&gt;
&lt;li&gt;&lt;em&gt;å¦‚æœæ¡†æ¶èƒ½å¤Ÿåœ¨è·¯ç”±é€‰æ‹©ä¸Šæœ‰&lt;code&gt;route.Link=local&lt;/code&gt;è¿™æ ·çš„æœ¬åœ°ä¼˜å…ˆç­–ç•¥ä¼šæœ‰ä¸€ä¸ªæ›´å¥½çš„ä½“éªŒ&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Istioã€‘ä½¿ç”¨istioctlå®‰è£…</title>
      <link>http://hbchen.com/post/servicemesh/2020-03-22-istio-install-istioctl/</link>
      <pubDate>Sat, 21 Mar 2020 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/servicemesh/2020-03-22-istio-install-istioctl/</guid>
      
        <description>&lt;p&gt;&lt;code&gt;istioctl&lt;/code&gt;æ˜¯å½“å‰å®˜æ–¹æ¨èçš„å®‰è£…æ–¹å¼ï¼Œç›¸æ¯”&lt;code&gt;helm&lt;/code&gt;æœ‰æ›´å¥½çš„ä½“éªŒï¼Œä½†å®è·µè¿‡ç¨‹ä¸­ä¹Ÿé‡åˆ°äº›é—®é¢˜ï¼Œåœ¨æ­¤å¯¹&lt;code&gt;1.5.0&lt;/code&gt;ç‰ˆæœ¬çš„ä½¿ç”¨åšä¸ªæ•´ç†ã€‚
åŒ…æ‹¬é»˜è®¤å®‰è£…ã€å¯è§‚å¯Ÿæ€§ç»„ä»¶ã€å¤–éƒ¨Chartç­‰è‡ªå®šä¹‰å®‰è£…ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;ç›®æ ‡&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å®‰è£… Istio ç¯å¢ƒ&lt;/li&gt;
&lt;li&gt;éƒ¨ç½² httpbin ç”¨ä¾‹&lt;/li&gt;
&lt;li&gt;Prometheusã€Grafanaå’ŒKialiç»„ä»¶&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;ç¯å¢ƒ&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;minikube version: v1.7.2&lt;/li&gt;
&lt;li&gt;kubernetes version: v1.16.7&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&#34;istioctl&#34;&gt;istioctl&lt;/h1&gt;

&lt;p&gt;å‚è€ƒ&lt;a href=&#34;https://istio.io/docs/setup/getting-started/#download&#34;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;ä¸‹è½½æˆ–è€…åˆ°&lt;a href=&#34;https://github.com/istio/istio/releases/tag/1.5.0&#34;&gt;Github&lt;/a&gt;é€‰æ‹©å¹³å°ä¸‹è½½ï¼Œ
ç„¶åå°†&lt;code&gt;bin&lt;/code&gt;ç›®å½•åŠ å…¥ path ç¯å¢ƒå˜é‡ã€‚&lt;/p&gt;

&lt;p&gt;æ£€éªŒ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;istioctl version
2020-03-21T10:21:14.012409Z	warn	will use `--remote=false` to retrieve version info due to `no Istio pods in namespace &amp;quot;istio-system&amp;quot;`
1.5.0
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;istio-é»˜è®¤å®‰è£…&#34;&gt;Istio é»˜è®¤å®‰è£…&lt;/h1&gt;

&lt;p&gt;é»˜è®¤å®‰è£…å¾ˆç®€å•ï¼Œåªéœ€è¦ä¸€ä¸ª&lt;code&gt;manifest apply&lt;/code&gt;å‘½ä»¤&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;istioctl manifest apply
This will install the default Istio profile into the cluster. Proceed? (y/N) y
Detected that your cluster does not support third party JWT authentication. Falling back to less secure first party JWT. See https://istio.io/docs/ops/best-practices/security/#configure-third-party-service-account-tokens for details.
- Applying manifest for component Base...
âœ” Finished applying manifest for component Base.
- Applying manifest for component Pilot...
âœ” Finished applying manifest for component Pilot.
  Waiting for resources to become ready...
  Waiting for resources to become ready...
- Applying manifest for component IngressGateways...
- Applying manifest for component AddonComponents...
âœ” Finished applying manifest for component AddonComponents.
âœ” Finished applying manifest for component IngressGateways.

âœ” Installation complete
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;å¦‚æœå®‰è£…è¿‡ç¨‹é‡åˆ°é•œåƒæ— æ³•ä¸‹è½½å¯¼è‡´å¤±è´¥ï¼Œå¯ä»¥ä½¿ç”¨&lt;code&gt;--set&lt;/code&gt;è®¾ç½®æ›¿æ¢é•œåƒï¼Œé»˜è®¤å®‰è£…æ¶‰åŠä¸¤ä¸ªé•œåƒæºé…ç½®:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;istioç›¸å…³é•œåƒï¼š&lt;code&gt;--set hub=dockerhub.azk8s.cn/istio&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;prometheusé•œåƒï¼š&lt;code&gt;--set values.prometheus.hub=dockerhub.azk8s.cn/prom&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;istioctl manifest apply \
--set hub=dockerhub.azk8s.cn/istio \
--set values.prometheus.hub=dockerhub.azk8s.cn/prom
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;p&gt;æ£€éªŒ&lt;code&gt;Pod&lt;/code&gt;ï¼Œåªæœ‰ä¸‰ä¸ªè¿è¡Œå®ä¾‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;kubectl get po -n istio-system
    NAME                                    READY   STATUS    RESTARTS   AGE
    istio-ingressgateway-78f757846c-7sqg7   1/1     Running   0          69s
    istiod-65c5b8df9d-qglhr                 1/1     Running   0          87s
    prometheus-6fd77b7876-dk4xq             2/2     Running   0          67s
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ£€éªŒ&lt;code&gt;Service&lt;/code&gt;ï¼Œæ³¨æ„&lt;code&gt;istio-ingressgateway&lt;/code&gt;æš´éœ²çš„ç«¯å£ï¼Œåé¢&lt;code&gt;prometheus&lt;/code&gt;ã€&lt;code&gt;grafana&lt;/code&gt;å’Œ&lt;code&gt;kiali&lt;/code&gt;çš„&lt;code&gt;gateway&lt;/code&gt;ä¼šç”¨åˆ°&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ kubectl get svc -n istio-system
    NAME                   TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                                                                                      AGE
    istio-ingressgateway   LoadBalancer   10.100.77.12     &amp;lt;pending&amp;gt;     15020:31791/TCP,80:31302/TCP,443:31151/TCP,15029:31679/TCP,15030:31818/TCP,15031:31327/TCP,15032:30470/TCP,15443:31898/TCP   101s
    istio-pilot            ClusterIP      10.98.216.5      &amp;lt;none&amp;gt;        15010/TCP,15011/TCP,15012/TCP,8080/TCP,15014/TCP,443/TCP                                                                     2m3s
    istiod                 ClusterIP      10.109.224.120   &amp;lt;none&amp;gt;        15012/TCP,443/TCP                                                                                                            2m2s
    prometheus             ClusterIP      10.105.60.208    &amp;lt;none&amp;gt;        9090/TCP
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™æ—¶æµ‹è¯•ç½‘å…³&lt;code&gt;80&lt;/code&gt;ç«¯å£æ˜ å°„çš„&lt;code&gt;31302&lt;/code&gt;ä¼šå¾—åˆ°&lt;code&gt;404&lt;/code&gt;ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰ä»»ä½•æœåŠ¡ï¼Œ&lt;code&gt;INGRESS_HOST&lt;/code&gt;å‚è€ƒ&lt;a href=&#34;https://istio.io/docs/tasks/traffic-management/ingress/ingress-control/#determining-the-ingress-ip-and-ports&#34;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;æ ¹æ®ç¯å¢ƒè·å–ï¼Œ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;curl -I  http://{INGRESS_HOST}:31302
    HTTP/1.1 404 Not Found
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;éƒ¨ç½²httpbin&#34;&gt;éƒ¨ç½²httpbin&lt;/h1&gt;

&lt;p&gt;é¦–å…ˆä¸º&lt;code&gt;namespace&lt;/code&gt;æ·»åŠ &lt;code&gt;istio-injection=enabled&lt;/code&gt;æ ‡ç­¾ï¼Œå¼€å¯è‡ªåŠ¨æ³¨å…¥&lt;code&gt;sidecar&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;kubectl label namespace default istio-injection=enabled
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;éƒ¨ç½²&lt;code&gt;httpbin&lt;/code&gt;æœåŠ¡ä»¥åŠç½‘å…³&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;cd {istio-1.5.0_path}
kubectl apply -f samples/httpbin/httpbin.yaml -f samples/httpbin/httpbin-gateway.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ£€éªŒ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;kubectl get po -n default
    NAME                       READY   STATUS    RESTARTS   AGE
    httpbin-779c54bf49-dgcs4   2/2     Running   0          39s

kubectl get gateway -n default
    NAME              AGE
    httpbin-gateway   2m1s
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æµ‹è¯•æœåŠ¡&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;curl -I  http://192.168.39.130:31302
    HTTP/1.1 200 OK

curl http://192.168.39.130:31302/get
    {...}
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;å¯è§‚å¯Ÿæ€§ç»„ä»¶&#34;&gt;å¯è§‚å¯Ÿæ€§ç»„ä»¶&lt;/h1&gt;

&lt;p&gt;Istioçš„ä¸€å¤§ç‰¹ç‚¹å¯è§‚å¯Ÿæ€§ï¼Œä¸»è¦ç”±&lt;code&gt;Prometheus&lt;/code&gt;ã€&lt;code&gt;Grafana&lt;/code&gt;ã€&lt;code&gt;Kiali&lt;/code&gt;å’Œ&lt;code&gt;Tracing&lt;/code&gt;ï¼Œå…¶ä¸­&lt;code&gt;Prometheus&lt;/code&gt;æ˜¯é»˜è®¤å®‰è£…ç»„ä»¶ã€‚
å‰é¢åœ¨å®‰è£…åæ£€éªŒ&lt;code&gt;Service&lt;/code&gt;æ—¶æœ‰æåˆ°&lt;code&gt;istio-ingressgateway&lt;/code&gt;æš´éœ²çš„ç«¯å£ï¼Œå…¶ä¸­æœ‰å››ä¸ªç«¯å£åˆ†åˆ«å¯¹åº”è¿™4ä¸ªæœåŠ¡ï¼š&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç«¯å£&lt;/th&gt;
&lt;th&gt;æ˜ å°„&lt;/th&gt;
&lt;th&gt;æœåŠ¡&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;15029&lt;/td&gt;
&lt;td&gt;31679&lt;/td&gt;
&lt;td&gt;kiali&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;15030&lt;/td&gt;
&lt;td&gt;31818&lt;/td&gt;
&lt;td&gt;prometheus&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;15031&lt;/td&gt;
&lt;td&gt;31327&lt;/td&gt;
&lt;td&gt;grafana&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;15032&lt;/td&gt;
&lt;td&gt;30470&lt;/td&gt;
&lt;td&gt;tracing&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;è™½ç„¶ç«¯å£å·²ç»æš´éœ²ï¼Œä½†æ¯ä¸ªæœåŠ¡å¯¹åº”çš„&lt;code&gt;gateway&lt;/code&gt;éœ€è¦è‡ªå®šä¹‰å¼€å¯ï¼Œé…ç½®è·¯å¾„ä¸º&lt;code&gt;values.gateways.istio-ingressgateway.telemetry_addon_gateways.xxx_gateway&lt;/code&gt;ï¼Œ
å¯¹åº”&lt;code&gt;yaml&lt;/code&gt;ä¸º&lt;code&gt;gateways/istio-ingress/templates/addongateway.yaml&lt;/code&gt;ï¼Œé…ç½®é—´&lt;code&gt;istio-ingress&lt;/code&gt;çš„&lt;code&gt;values&lt;/code&gt;ã€‚
åœ¨&lt;code&gt;addongateway.yaml&lt;/code&gt;æ¨¡æ¿ä¸­éƒ½é»˜è®¤ä¸º&lt;code&gt;https&lt;/code&gt;ï¼Œå¦‚æœæµ‹è¯•ä¸æ–¹ä¾¿éœ€è¦è‡ªå·±æ‰‹åŠ¨ä¿®æ”¹&lt;code&gt;gateway&lt;/code&gt;ï¼Œä¹Ÿå¯ä»¥å‚è€ƒåé¢çš„&lt;a href=&#34;#å¤–éƒ¨Chart&#34;&gt;#å¤–éƒ¨Chart&lt;/a&gt;è¿›è¡Œè‡ªå®šä¹‰å®‰è£…ã€‚&lt;/p&gt;

&lt;h2 id=&#34;prometheus&#34;&gt;Prometheus&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;Prometheus&lt;/code&gt;é»˜è®¤æ˜¯å®‰è£…ï¼Œæ‰€ä»¥åªéœ€è¦å¯ç”¨&lt;code&gt;gateway&lt;/code&gt;å³å¯&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;istioctl manifest apply \
--set values.gateways.istio-ingressgateway.telemetry_addon_gateways.prometheus_gateway.enabled=true
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;Gatewayæ”¹ä¸ºHTTPæœåŠ¡&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: istio-prometheus-gateway
  namespace: istio-system
  labels:
    app: prometheus
    release: istio
spec:
  selector:
    istio: ingressgateway
  servers:
    - port:
        number: 15030
        name: https-prometheus
        protocol: HTTP
      hosts:
        - &amp;quot;*&amp;quot;
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è®¿é—® http://{INGRESS_HOST}:31818 å³å¯è¿›å…¥Prometheusçš„Webé¡µé¢ï¼Œå…ˆä¸º&lt;code&gt;httpbin&lt;/code&gt;çŒå…¥ä¸€äº›æµé‡ç„¶åçœ‹&lt;code&gt;Prometheus&lt;/code&gt;æ•°æ®æƒ…å†µ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;hey -z 60s -c 2 http://{INGRESS_HOST}:31302/get
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/istio/prometheus-httpbin.png&#34; alt=&#34;prometheus httpbin&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;grafana-kiali-tracing&#34;&gt;Grafana &amp;amp; Kiali &amp;amp; Tracing&lt;/h2&gt;

&lt;p&gt;è¿™ä¸‰ä¸ªæœåŠ¡é»˜è®¤æ˜¯ä¸å¯åŠ¨çš„ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨è®¾ç½®&lt;code&gt;enabled&lt;/code&gt;ï¼Œå…¶ä¸­&lt;code&gt;kiali&lt;/code&gt;éœ€è¦å¢åŠ ä¸€ä¸ª&lt;code&gt;createDemoSecret=true&lt;/code&gt;çš„é…ç½®ï¼Œä½¿ç”¨é»˜è®¤ç”¨æˆ·å(admin)å’Œå¯†ç (admin)åˆ›å»ºå¯†é’¥ï¼Œå¦åˆ™ä¼šæœ‰å¼‚å¸¸:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;The Kiali secret is missing. Users are prohibited from accessing Kiali until an administrator creates a valid secret. Please refer to the Kiali documentation for more details.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;istioctl manifest apply \
--set values.gateways.istio-ingressgateway.telemetry_addon_gateways.prometheus_gateway.enabled=true \
--set addonComponents.grafana.enabled=true \
--set values.gateways.istio-ingressgateway.telemetry_addon_gateways.grafana_gateway.enabled=true \
--set addonComponents.kiali.enabled=true \
--set values.kiali.createDemoSecret=true \
--set values.gateways.istio-ingressgateway.telemetry_addon_gateways.kiali_gateway.enabled=true \
--set addonComponents.tracing.enabled=true \
--set values.gateways.istio-ingressgateway.telemetry_addon_gateways.tracing_gateway.enabled=true
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åŒæ ·å°†&lt;code&gt;gateway&lt;/code&gt;æ”¹ä¸º&lt;code&gt;http&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: istio-prometheus-gateway
  namespace: istio-system
  labels:
    app: prometheus
    release: istio
spec:
  selector:
    istio: ingressgateway
  servers:
    - port:
        number: 15030
        name: https-prometheus
        protocol: HTTP
      hosts:
        - &amp;quot;*&amp;quot;
---
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: istio-grafana-gateway
  namespace: istio-system
  labels:
    app: grafana
    release: istio
spec:
  selector:
    istio: ingressgateway
  servers:
    - port:
        number: 15031
        name: https-grafana
        protocol: HTTP
      hosts:
        - &amp;quot;*&amp;quot;
---
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: istio-kiali-gateway
  namespace: istio-system
  labels:
    app: kiali
    release: istio
spec:
  selector:
    istio: ingressgateway
  servers:
    - port:
        number: 15029
        name: https-kiali
        protocol: HTTP
      hosts:
        - &amp;quot;*&amp;quot;
---
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: istio-tracing-gateway
  namespace: istio-system
  labels:
    app: tracing
    release: istio
spec:
  selector:
    istio: ingressgateway
  servers:
    - port:
        number: 15032
        name: https-tracing
        protocol: HTTP
      hosts:
        - &amp;quot;*&amp;quot;
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç°åœ¨å†æ¬¡ç»™&lt;code&gt;httpbin&lt;/code&gt;çŒå…¥æµé‡æŸ¥çœ‹å„ä¸ªæœåŠ¡çš„æ•ˆæœ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;hey -z 300s -c 2 http://{INGRESS_HOST}:31302/get
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;Grafana&lt;/strong&gt;
&lt;img src=&#34;http://hbchen.com/img/istio/grafana-httpbin.png&#34; alt=&#34;grafana httpbin&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Kiali&lt;/strong&gt;
&lt;img src=&#34;http://hbchen.com/img/istio/kiali-httpbin.png&#34; alt=&#34;kiali httpbin&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Tracing&lt;/strong&gt;
&lt;img src=&#34;http://hbchen.com/img/istio/tracing-httpbin.png&#34; alt=&#34;tracing httpbin&#34; /&gt;&lt;/p&gt;

&lt;h1 id=&#34;å¤–éƒ¨chart-å‘&#34;&gt;å¤–éƒ¨Chart-å‘&lt;/h1&gt;

&lt;p&gt;&lt;a href=&#34;https://istio.io/docs/setup/install/istioctl/#install-from-external-charts&#34;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;æœ‰å…³ä½¿ç”¨å¤–éƒ¨Chartçš„éƒ¨åˆ†å­˜åœ¨é—®é¢˜ï¼Œ&lt;code&gt;installPackagePath&lt;/code&gt;æ— æ•ˆï¼Œéœ€è¦ç”¨&lt;code&gt;install_package_path&lt;/code&gt;æ›¿æ¢ï¼ŒåŒæ—¶éœ€è¦æŒ‡å®š&lt;code&gt;profile&lt;/code&gt;ï¼Œåº”è¯¥ä¹Ÿæ˜¯istioå®ç°&lt;a href=&#34;https://github.com/istio/istio/issues/22368&#34;&gt;BUG&lt;/a&gt;ï¼Œ
æ–‡æ¡£ä¿®æ”¹å’ŒBUGä¿®å¤çš„PR &lt;a href=&#34;https://github.com/istio/istio.io/pull/6939&#34;&gt;istio/istio.io#6939&lt;/a&gt; å’Œ &lt;a href=&#34;https://github.com/istio/istio/pull/22371&#34;&gt;istio/istio#22371&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;release-1.5 æœ€æ–°ç‰ˆæœ¬å·²ç»ä¿®å¤æ­¤é—®é¢˜(&lt;em&gt;æ–‡æ¡£æ›´æ–°PR &lt;a href=&#34;https://github.com/istio/istio.io/pull/6939&#34;&gt;istio/istio.io#6939&lt;/a&gt;æœªè¢«é‡‡çº³&lt;/em&gt;)ï¼Œæ‰€ä»¥å¦‚æœ&lt;code&gt;istioctl&lt;/code&gt;ä½¿ç”¨çš„æ˜¯&lt;code&gt;1.5.0&lt;/code&gt;çš„Releaseç‰ˆæœ¬æ­¤é—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œåœ¨ä½¿ç”¨è¿™ä¸€éƒ¨åˆ†æ–‡æ¡£(&lt;a href=&#34;https://istio.io/docs/setup/install/istioctl/#install-from-external-charts&#34;&gt;install-from-external-charts&lt;/a&gt;)æ—¶éœ€è¦è¦æ³¨æ„&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;code&gt;addongateway.yaml&lt;/code&gt;çš„Gatewayæ”¹ä¸ºHTTP&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;# Template for telemetry addon gateways
{{ $gateway := index .Values &amp;quot;gateways&amp;quot; &amp;quot;istio-ingressgateway&amp;quot; }}
{{ range $addon := $gateway.telemetry_addon_gateways }}
{{ if $addon.enabled }}
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: istio-{{ $addon.name }}-gateway
  namespace: {{ $.Release.Namespace }}
  labels:
    app: {{ $addon.name }}
    release: {{ $.Release.Name }}
spec:
  selector:
    istio: ingressgateway
  servers:
{{- if $addon.tls }}
    - port:
        number: {{ $addon.port }}
        name: https-{{ $addon.name }}
        protocol: HTTPS
      tls:
        mode: SIMPLE
        serverCertificate: /etc/istio/ingressgateway-certs/tls.crt
        privateKey: /etc/istio/ingressgateway-certs/tls.key
      hosts:
        - &amp;quot;*&amp;quot;
  {{- else }}
    - port:
        number: {{ $addon.port }}
        name: http-{{ $addon.name }}
        protocol: HTTP
        hosts:
          - &amp;quot;*&amp;quot;
{{- end }}
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: {{ $addon.name }}-virtual-service
  namespace: {{ $.Release.Namespace }}
  labels:
    app: {{ $addon.name }}
    release: {{ $.Release.Name }}
spec:
  hosts:
    - &amp;quot;*&amp;quot;
  gateways:
    - istio-{{ $addon.name }}-gateway
  http:
    - match:
        - port: {{ $addon.port }}
      route:
        - destination:
            host: {{ $addon.name }}.{{ $.Release.Namespace }}.svc.{{ $.Values.global.proxy.clusterDomain }}
            port:
              number: {{ $addon.desPort }}
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: {{ $addon.name }}
  namespace: {{ $.Release.Namespace }}
  labels:
    app: {{ $addon.name }}
    release: {{ $.Release.Name }}
spec:
  host: {{ $addon.name }}.{{ $.Release.Namespace }}.svc.{{ $.Values.global.proxy.clusterDomain }}
  trafficPolicy:
    tls:
      mode: DISABLE
---
{{- end }}
{{- end }}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŒ‡å®šå¤–éƒ¨Chartéƒ¨ç½²&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;istioctl manifest apply \
--set profile=$PWD/install/kubernetes/operator/profiles/default.yaml \
--set install_package_path=$PWD/install/kubernetes/operator/charts \
--set values.gateways.istio-ingressgateway.telemetry_addon_gateways.prometheus_gateway.enabled=true \
--set addonComponents.grafana.enabled=true \
--set values.gateways.istio-ingressgateway.telemetry_addon_gateways.grafana_gateway.enabled=true \
--set addonComponents.kiali.enabled=true \
--set values.kiali.createDemoSecret=true \
--set values.gateways.istio-ingressgateway.telemetry_addon_gateways.kiali_gateway.enabled=true \
--set addonComponents.tracing.enabled=true \
--set values.gateways.istio-ingressgateway.telemetry_addon_gateways.tracing_gateway.enabled=true
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä½¿ç”¨&lt;code&gt;--set&lt;/code&gt;è¿‡äºéº»çƒ¦å¯ä»¥ä½¿ç”¨&lt;code&gt;yaml&lt;/code&gt;æ–‡ä»¶è¿›è¡Œé…ç½®ï¼Œ&lt;code&gt;profile&lt;/code&gt;å’Œ&lt;code&gt;install_package_path&lt;/code&gt;çš„è·¯å¾„ä»¥istioçš„ä¸‹è½½è·¯å¾„ä¸ºä¾‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;$ vi profile.yaml

apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  namespace: istio-system
  name: istio-operator
spec:
  profile: {istio-path}/install/kubernetes/operator/profiles/default.yaml
  install_package_path: {istio-path}/install/kubernetes/operator/charts
  
  addonComponents:
    prometheus:
      enabled: true
    kiali:
      enabled: true
    grafana:
      enabled: true
    tracing:
      enabled: true

  values:
    gateways:
      istio-ingressgateway:
        telemetry_addon_gateways:
          prometheus_gateway:
            enabled: true
          grafana_gateway:
            enabled: true
          kiali_gateway:
            enabled: true
          tracing_gateway:
            enabled: true
    kiali:
      createDemoSecret: true
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;istioctl manifest apply \
-f profile.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æœ‰å…³è‡ªå®šä¹‰å®‰è£…çš„&lt;code&gt;chart&lt;/code&gt;ã€&lt;code&gt;profile&lt;/code&gt;åœ¨&lt;a href=&#34;https://github.com/hb-chen/istio-operator&#34;&gt;hb-chen/istio-operator&lt;/a&gt;æœ‰äº›ç¤ºä¾‹å¯ä»¥å‚è€ƒã€‚&lt;/p&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Istioæºç ã€‘Citadel &amp; Node Agent</title>
      <link>http://hbchen.com/post/servicemesh/2020-01-07-istio-code-security/</link>
      <pubDate>Tue, 07 Jan 2020 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/servicemesh/2020-01-07-istio-code-security/</guid>
      
        <description>&lt;p&gt;Istioå®‰å…¨ä¸»è¦åŒ…æ‹¬&lt;strong&gt;è®¤è¯&lt;/strong&gt;å’Œ&lt;strong&gt;æˆæƒ&lt;/strong&gt;ï¼Œæœ‰å…³æˆæƒçš„&lt;code&gt;RBAC&lt;/code&gt;ä½¿ç”¨å‚è€ƒä¹‹å‰çš„æ–‡ç« &lt;a href=&#34;http://hbchen.com/post/servicemesh/2019-03-09-istio-rbac-quick-start/#1-å¼€å¯æˆæƒ-clusterrbacconfig&#34;&gt;ã€Istioå®‰å…¨ã€‘æœåŠ¡é—´è®¿é—®æ§åˆ¶-RBAC&lt;/a&gt;
ï¼Œä¸è¿‡&lt;code&gt;RBAC&lt;/code&gt;å·²ç»&lt;a href=&#34;https://istio.io/docs/reference/config/security/istio.rbac.v1alpha1/&#34;&gt;å‡†å¤‡åºŸå¼ƒ&lt;/a&gt;è¢«&lt;code&gt;Authorization&lt;/code&gt;æ›¿ä»£ï¼Œ
&lt;strong&gt;è®¤è¯&lt;/strong&gt;åˆ™åˆ†ä¸º&lt;strong&gt;æœåŠ¡é—´èº«ä»½éªŒè¯&lt;/strong&gt;å’Œ&lt;strong&gt;æ¥æºèº«ä»½è®¤è¯&lt;/strong&gt;ï¼ŒæœåŠ¡é—´èº«ä»½éªŒè¯Istioæä¾›äº†&lt;strong&gt;åŒå‘TLS&lt;/strong&gt;æ–¹æ¡ˆï¼Œå…¶ä¸­æ¶‰åŠçš„ç§˜é’¥ç®¡ç†æœåŠ¡ï¼Œä¸»è¦ç”±&lt;code&gt;istio/security&lt;/code&gt;æ¨¡å—çš„
&lt;code&gt;Citadel&lt;/code&gt;å’Œ&lt;code&gt;Node Agent&lt;/code&gt;æä¾›ï¼Œæœ¬æ–‡ä¸»è¦åˆ†æè¿™éƒ¨åˆ†çš„æºç å®ç°ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Istio 1.14.0&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h1 id=&#34;pki&#34;&gt;PKI&lt;/h1&gt;

&lt;p&gt;é¦–å…ˆå‚è€ƒ&lt;a href=&#34;https://preliminary.istio.io/zh/docs/concepts/security/#pki&#34;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;[&lt;a href=&#34;https://istio.io/docs/concepts/security/#pki&#34;&gt;en&lt;/a&gt;]çœ‹ä¸‹å‡ ç§ä¸åŒåœºæ™¯çš„æ–¹æ¡ˆï¼Œå…¶ä¸­&lt;code&gt;Kubernetes æ–¹æ¡ˆ&lt;/code&gt;æœ€ç®€å•ï¼Œ
&lt;code&gt;Kubernetes ä¸­çš„ä»£ç†èŠ‚ç‚¹&lt;/code&gt;æ›´é€‚åˆç”Ÿäº§ï¼Œå…·ä½“ä¼˜åŠ¿&lt;a href=&#34;https://preliminary.istio.io/zh/docs/tasks/security/citadel-config/auth-sds&#34;&gt;å‚è€ƒ&lt;/a&gt;[&lt;a href=&#34;https://istio.io/docs/tasks/security/citadel-config/auth-sds/&#34;&gt;en&lt;/a&gt;]ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Kubernetes æ–¹æ¡ˆ

&lt;ul&gt;
&lt;li&gt;Citadel ç›‘è§† Kubernetes apiserverï¼Œä¸ºæ¯ä¸ªç°æœ‰å’Œæ–°çš„æœåŠ¡å¸æˆ·åˆ›å»º SPIFFE è¯ä¹¦å’Œå¯†é’¥å¯¹ã€‚Citadel å°†è¯ä¹¦å’Œå¯†é’¥å¯¹å­˜å‚¨ä¸º Kubernetes secretã€‚&lt;/li&gt;
&lt;li&gt;åˆ›å»º pod æ—¶ï¼ŒKubernetes ä¼šæ ¹æ®å…¶æœåŠ¡å¸æˆ·é€šè¿‡ Kubernetes secret volume å°†è¯ä¹¦å’Œå¯†é’¥å¯¹æŒ‚è½½åˆ° pod ä¸Šã€‚&lt;/li&gt;
&lt;li&gt;Citadel ç›‘è§†æ¯ä¸ªè¯ä¹¦çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶é€šè¿‡é‡å†™ Kubernetes secret è‡ªåŠ¨è½®æ¢è¯ä¹¦ã€‚&lt;/li&gt;
&lt;li&gt;Pilot ç”Ÿæˆå®‰å…¨å‘½åä¿¡æ¯ï¼Œè¯¥ä¿¡æ¯å®šä¹‰äº†å“ªäº› Service Account å¯ä»¥è¿è¡Œå“ªäº›æœåŠ¡ã€‚Pilot ç„¶åå°†å®‰å…¨å‘½åä¿¡æ¯ä¼ é€’ç»™ envoy sidecarã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;æœ¬åœ°æœºå™¨æ–¹æ¡ˆ

&lt;ul&gt;
&lt;li&gt;Citadel åˆ›å»º gRPC æœåŠ¡æ¥æ¥å—è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆCSRï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;èŠ‚ç‚¹ä»£ç†ç”Ÿæˆç§é’¥å’Œ CSRï¼Œå¹¶å°† CSR åŠå…¶å‡­æ®å‘é€ç»™ Citadel è¿›è¡Œç­¾åã€‚&lt;/li&gt;
&lt;li&gt;Citadel éªŒè¯ CSR æ‰¿è½½çš„å‡­è¯ï¼Œå¹¶ç­¾ç½² CSR ä»¥ç”Ÿæˆè¯ä¹¦ã€‚&lt;/li&gt;
&lt;li&gt;èŠ‚ç‚¹ä»£ç†å°†ä» Citadel æ¥æ”¶çš„è¯ä¹¦å’Œç§é’¥å‘é€ç»™ Envoyã€‚&lt;/li&gt;
&lt;li&gt;ä¸Šè¿° CSR è¿‡ç¨‹ä¼šå®šæœŸé‡å¤è¿›è¡Œè¯ä¹¦å’Œå¯†é’¥è½®æ¢ã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;Kubernetes ä¸­çš„ä»£ç†èŠ‚ç‚¹

&lt;ul&gt;
&lt;li&gt;Citadel åˆ›å»ºä¸€ä¸ª gRPC æœåŠ¡æ¥æ¥å— CSR è¯·æ±‚ã€‚&lt;/li&gt;
&lt;li&gt;Envoy é€šè¿‡ Envoy secret å‘ç°æœåŠ¡ï¼ˆSDSï¼‰API å‘é€è¯ä¹¦å’Œå¯†é’¥è¯·æ±‚ã€‚&lt;/li&gt;
&lt;li&gt;æ”¶åˆ° SDS è¯·æ±‚åï¼ŒèŠ‚ç‚¹ä»£ç†ä¼šåˆ›å»ºç§é’¥å’Œ CSRï¼Œå¹¶å°† CSR åŠå…¶å‡­æ®å‘é€ç»™ Citadel è¿›è¡Œç­¾åã€‚&lt;/li&gt;
&lt;li&gt;Citadel éªŒè¯ CSR ä¸­æºå¸¦çš„å‡­è¯ï¼Œå¹¶ç­¾ç½² CSR ä»¥ç”Ÿæˆè¯ä¹¦ã€‚&lt;/li&gt;
&lt;li&gt;èŠ‚ç‚¹ä»£ç†é€šè¿‡ Envoy SDS API å°†ä» Citadel æ¥æ”¶çš„è¯ä¹¦å’Œç§é’¥å‘é€ç»™ Envoyã€‚&lt;/li&gt;
&lt;li&gt;ä¸Šè¿° CSR è¿‡ç¨‹ä¼šå®šæœŸé‡å¤è¿›è¡Œè¯ä¹¦å’Œå¯†é’¥è½®æ¢ã€‚&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h1 id=&#34;caç®¡ç†-citadel&#34;&gt;CAç®¡ç†-Citadel&lt;/h1&gt;

&lt;p&gt;Citadel(æºç å…¥å£&lt;code&gt;istio/security/cmd/istio_ca&lt;/code&gt;)æ˜¯Istioè‡ªå¸¦çš„ç§˜é’¥ç®¡ç†æœåŠ¡ï¼Œä½¿ç”¨ä»£ç†èŠ‚ç‚¹ä¹Ÿæ”¯æŒå¤–éƒ¨CAç³»ç»Ÿï¼Œå¦‚ï¼šVaultCAå’ŒGoogleCAã€‚&lt;/p&gt;

&lt;p&gt;åŒ…æ‹¬ä»¥ä¸‹èƒ½åŠ›ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;è¯ä¹¦ç®¡ç†:&lt;code&gt;pki/ca&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#istioca&#34;&gt;IstioCA&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;å·¥ä½œè´Ÿè½½çš„è¯ä¹¦è½®æ¢:&lt;code&gt;k8s/controller&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#secretcontroller&#34;&gt;SecretController&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;è¯ä¹¦ç­¾åæœåŠ¡:&lt;code&gt;server/ca&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#server&#34;&gt;Server&lt;/a&gt;
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;em&gt;TODO é…å›¾&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&#34;istioca&#34;&gt;IstioCA&lt;/h2&gt;

&lt;p&gt;IstioCaæ”¯æŒä¸¤ç§æ–¹å¼ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;è‡ªç­¾åè¯ä¹¦ï¼Œè‡ªåŠ¨è½®æ¢&lt;a href=&#34;#selfsignedca&#34;&gt;SelfSignedCA&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;å¤–éƒ¨æ–‡ä»¶è¯ä¹¦
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;selfsignedca&#34;&gt;SelfSignedCA&lt;/h3&gt;

&lt;p&gt;è‡ªç­¾åè¯ä¹¦ï¼Œè‡ªåŠ¨è½®æ¢ç®¡ç†ç”±&lt;code&gt;SelfSignedCARootCertRotator&lt;/code&gt;å®ç°ï¼Œé»˜è®¤&lt;code&gt;1å°æ—¶&lt;/code&gt;åšä¸€æ¬¡è¯ä¹¦çš„æ£€æŸ¥ã€‚&lt;/p&gt;

&lt;h2 id=&#34;secretcontroller&#34;&gt;SecretController&lt;/h2&gt;

&lt;p&gt;åœ¨Kubernetesæ–¹æ¡ˆä¸­å·¥ä½œè´Ÿè½½çš„è¯ä¹¦ç®¡ç†ï¼ŒCitadelé€šè¿‡ä¿®æ”¹&lt;code&gt;secret&lt;/code&gt;å¯¹å·¥ä½œè´Ÿè½½çš„è¯ä¹¦è¿›è¡Œç®¡ç†ï¼Œ&lt;code&gt;SecretController&lt;/code&gt;ç›‘æ§&lt;code&gt;ServiceAccount&lt;/code&gt;çš„åˆ›å»ºã€åˆ é™¤ï¼Œ
&lt;code&gt;Secret&lt;/code&gt;çš„åˆ é™¤ã€æ›´æ–°ï¼Œä»¥åŠ&lt;code&gt;Namespace&lt;/code&gt;çš„æ›´æ–°ï¼Œåœ¨äº§ç”Ÿå˜æ›´æ—¶ä¿®æ”¹&lt;code&gt;secret&lt;/code&gt;å®Œæˆè¯ä¹¦çš„è½®æ¢ï¼ŒåŒæ—¶&lt;code&gt;Pilot Agent&lt;/code&gt;ä¼šç›‘æ§&lt;code&gt;secret&lt;/code&gt;çš„å˜æ›´ï¼Œå¹¶é‡å¯Envoyä½¿é…ç½®ç”Ÿæ•ˆï¼Œå®Œæˆè¯ä¹¦çš„è½®æ¢ã€‚&lt;/p&gt;

&lt;h2 id=&#34;server&#34;&gt;Server&lt;/h2&gt;

&lt;p&gt;è¯ä¹¦æœåŠ¡ï¼Œä¸&lt;code&gt;nodeagent&lt;/code&gt;çš„&lt;code&gt;caclient&lt;/code&gt;äº¤äº’ï¼ŒåŒ…æ‹¬æœåŠ¡çš„è®¤è¯åŠé‰´æƒç­‰&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;gRPCæœåŠ¡å¦‚ä¸‹:&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;CertificateService

&lt;ul&gt;
&lt;li&gt;CreateCertificate(context.Context, *IstioCertificateRequest) (*IstioCertificateResponse, error)&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;CAService&lt;code&gt;åºŸå¼ƒ&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;HandleCSR(context.Context, *CsrRequest) (*CsrResponse, error)&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;authenticator&#34;&gt;Authenticator&lt;/h3&gt;

&lt;p&gt;gRPCæœåŠ¡è®¤è¯ï¼Œé»˜è®¤ä¸€ä¸ª&lt;code&gt;ClientCertAuthenticator&lt;/code&gt;ï¼Œå½“å¯åŠ¨SDSæ—¶æ·»åŠ äº†&lt;code&gt;KubeJWTAuthenticator&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&#34;authorizer&#34;&gt;Authorizer&lt;/h3&gt;

&lt;p&gt;gRPCæœåŠ¡&lt;code&gt;CAService&lt;/code&gt;å’Œ&lt;code&gt;CertificateService&lt;/code&gt;çš„é‰´æƒ&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;æœåŠ¡çš„&lt;code&gt;Authorizer&lt;/code&gt;éƒ½æ˜¯&lt;code&gt;TODO&lt;/code&gt;çŠ¶æ€&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;strong&gt;registry&lt;/strong&gt;æä¾›äº†ä¸€ä¸ªèº«ä»½æˆæƒçš„æ³¨å†Œè¡¨&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;kube/ServiceController

&lt;ul&gt;
&lt;li&gt;ç›‘æ§&lt;code&gt;Service&lt;/code&gt;åˆ›å»ºã€åˆ é™¤ä¸ä¿®æ”¹&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;kube/ServiceAccountController

&lt;ul&gt;
&lt;li&gt;ç›‘æ§&lt;code&gt;ServiceAccount&lt;/code&gt;åˆ›å»ºã€åˆ é™¤ä¸ä¿®æ”¹
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&#34;node-agent-k8s&#34;&gt;Node Agent K8S&lt;/h1&gt;

&lt;p&gt;NodeAgent(æºç å…¥å£&lt;code&gt;istio/security/cmd/node_agent_k8s&lt;/code&gt;)æ˜¯Citadelåœ¨å·¥ä½œè´Ÿè½½&lt;code&gt;node&lt;/code&gt;æˆ–è€…ç½‘å…³&lt;code&gt;pod&lt;/code&gt;ä¸­çš„ä»£ç†ï¼Œä¸ºEnvoyæä¾›&lt;code&gt;SDS&lt;/code&gt;æœåŠ¡ï¼Œå¹¶ä¸Citadeläº¤äº’å‘èµ·&lt;code&gt;CSR&lt;/code&gt;è¯·æ±‚ã€‚
ä½¿ç”¨&lt;strong&gt;Kubernetesä¸­çš„ä»£ç†èŠ‚ç‚¹&lt;/strong&gt;æ¨¡å¼æ—¶Citadelå¯ä»¥è¿è¡Œä¸º&lt;code&gt;server-only&lt;/code&gt;æ¨¡å¼ï¼Œå³ä¸åšå·¥ä½œè´Ÿè½½çš„è¯ä¹¦ç®¡ç†ã€‚&lt;/p&gt;

&lt;p&gt;&lt;em&gt;TODO é…å›¾&lt;/em&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Node Agentæºç å‡åœ¨&lt;code&gt;nodeagent&lt;/code&gt;ç›®å½•&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;ca-client&#34;&gt;CA Client&lt;/h2&gt;

&lt;p&gt;æä¾›CSRç­¾åæ¥å£ï¼ŒæœåŠ¡å®ç°æ”¯æŒ&lt;code&gt;citadel&lt;/code&gt;ã€&lt;code&gt;google&lt;/code&gt;ã€&lt;code&gt;vault&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Clientæ¥å£&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// Client interface defines the clients need to implement to talk to CA for CSR.
type Client interface {
	CSRSign(ctx context.Context, csrPEM []byte, subjectID string,
		certValidTTLInSec int64) ([]string /*PEM-encoded certificate chain*/, error)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;secret-fetcher&#34;&gt;Secret Fetcher&lt;/h2&gt;

&lt;p&gt;ä½œä¸ºWorkloadä»£ç†æ—¶æ ¹æ®ä¸åŒçš„Providerå®ä¾‹åŒ–CA Clientï¼Œæˆ–è€…ä½œä¸ºIngress Gatewayä»£ç†æ—¶ç›‘æ§&lt;code&gt;secret&lt;/code&gt;å˜æ›´ï¼Œå¹¶é€šçŸ¥åˆ°&lt;code&gt;secretcache&lt;/code&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Workloadä»£ç†ä»¥&lt;code&gt;DaemonSet&lt;/code&gt;åœ¨&lt;code&gt;node&lt;/code&gt;ä¸Šè¿è¡Œï¼Œä½¿ç”¨CA Clientä¸CA Serveräº¤äº’&lt;/li&gt;
&lt;li&gt;Ingress Gatewayä»£ç†ä¸Workloadéƒ¨ç½²æ–¹å¼ä¸åŒï¼Œä»£ç†åœ¨Podå†…è¿è¡Œï¼Œè€Œä¸æ˜¯&lt;code&gt;DaemonSet&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;ç›‘æ§&lt;code&gt;secret&lt;/code&gt;çš„åˆ›å»ºã€åˆ é™¤å’Œæ›´æ–°ï¼Œç”¨äºæ•è·Ingress Gatewayçš„TLSé…ç½®&lt;/li&gt;
&lt;li&gt;&lt;code&gt;secret&lt;/code&gt;æœ‰å˜æ›´æ—¶é€šè¿‡&lt;code&gt;AddCache&lt;/code&gt;ã€&lt;code&gt;DeleteCache&lt;/code&gt;å’Œ&lt;code&gt;UpdateCache&lt;/code&gt;æ–¹æ³•é€šçŸ¥&lt;code&gt;secretcache&lt;/code&gt;åˆ°&lt;code&gt;DeleteK8sSecret&lt;/code&gt;å’Œ&lt;code&gt;UpdateK8sSecret&lt;/code&gt;ï¼Œå†ç”±&lt;code&gt;sds.NotifyProxy&lt;/code&gt;é€šçŸ¥SDSæœåŠ¡&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://preliminary.istio.io/zh/docs/tasks/traffic-management/ingress/secure-ingress-sds/#configure-a-TLS-ingress-gateway-using-sds&#34;&gt;ä½¿ç”¨SDSçš„ä¼˜åŠ¿&lt;/a&gt;[&lt;a href=&#34;https://istio.io/docs/tasks/traffic-management/ingress/secure-ingress-sds/#configure-a-tls-ingress-gateway-using-sds&#34;&gt;en&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;Ingress Gatewayçš„TLSçš„é»˜è®¤é…ç½®æ–¹å¼æ˜¯&lt;a href=&#34;https://preliminary.istio.io/zh/docs/tasks/traffic-management/ingress/secure-ingress-mount/&#34;&gt;æ–‡ä»¶æŒ‚è½½&lt;/a&gt;[&lt;a href=&#34;https://istio.io/docs/tasks/traffic-management/ingress/secure-ingress-mount/&#34;&gt;en&lt;/a&gt;]&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;secret-cache&#34;&gt;Secret Cache&lt;/h2&gt;

&lt;p&gt;ç§˜é’¥ç¼“å­˜ï¼Œè´Ÿè´£ç§˜é’¥çš„è½®æ¢&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;é»˜è®¤&lt;code&gt;10åˆ†é’Ÿ&lt;/code&gt;åšä¸€æ¬¡æ£€æŸ¥ï¼Œå¯¹å³å°†è¿‡æœŸçš„åšè½®æ¢ï¼Œé»˜è®¤&lt;code&gt;1å°æ—¶&lt;/code&gt;åè¿‡æœŸçš„è¯ä¹¦å°±åšæ›´æ–°

&lt;ul&gt;
&lt;li&gt;å¦‚æœè½®è¯¢æ—¶&lt;code&gt;token&lt;/code&gt;è¿‡æœŸä¼šè¿”å›&lt;code&gt;secret=nil&lt;/code&gt;ï¼Œè¿™æ—¶SDSæœåŠ¡åœ¨æ”¶åˆ°&lt;code&gt;notify&lt;/code&gt;åéœ€è¦å°†è¿æ¥æ–­å¼€é‡è¿&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;äº§ç”Ÿè½®æ¢æ—¶é€šè¿‡&lt;code&gt;sds.NotifyProxy&lt;/code&gt;é€šçŸ¥åˆ°SDSæœåŠ¡ï¼ŒSDSæœåŠ¡é€šè¿‡&lt;code&gt;connKey&lt;/code&gt;æ‰¾åˆ°å¯¹åº”çš„&lt;code&gt;client&lt;/code&gt;ï¼Œå¹¶é€šè¿‡SDSçš„&lt;code&gt;StreamSecrets&lt;/code&gt;å°†æ–°çš„è¯ä¹¦æ¨é€åˆ°&lt;code&gt;Pod&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;åœ¨&lt;code&gt;generateSecret&lt;/code&gt;æ—¶ï¼Œå¦‚æœæ£€æµ‹åˆ°&lt;code&gt;rootCert&lt;/code&gt;ä¸º&lt;code&gt;nil&lt;/code&gt;æˆ–è€…ä¸&lt;code&gt;certChainPEM&lt;/code&gt;çš„ä¸ä¸€è‡´ï¼Œå°†è§¦å‘&lt;code&gt;rootCert&lt;/code&gt;çš„æ›´æ–°

&lt;ul&gt;
&lt;li&gt;SDSæœåŠ¡å°†æ–°çš„&lt;code&gt;rootCert&lt;/code&gt;åŠ å…¥åˆ°å¯ä¿¡&lt;code&gt;CA&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;SecretManageræ¥å£&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// SecretManager defines secrets management interface which is used by SDS.
type SecretManager interface {
	// GenerateSecret generates new secret and cache the secret.
	GenerateSecret(ctx context.Context, connectionID, resourceName, token string) (*model.SecretItem, error)

	// ShouldWaitForIngressGatewaySecret indicates whether a valid ingress gateway secret is expected.
	ShouldWaitForIngressGatewaySecret(connectionID, resourceName, token string) bool

	// SecretExist checks if secret already existed.
	// This API is used for sds server to check if coming request is ack request.
	SecretExist(connectionID, resourceName, token, version string) bool

	// DeleteSecret deletes a secret by its key from cache.
	DeleteSecret(connectionID, resourceName string)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;sds-service&#34;&gt;SDS Service&lt;/h2&gt;

&lt;p&gt;SDSæœåŠ¡å®ç°&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;NotifyProxy&lt;/code&gt;æ¥æ”¶&lt;code&gt;secret&lt;/code&gt;å˜æ›´çš„é€šçŸ¥

&lt;ul&gt;
&lt;li&gt;æŸ¥æ‰¾&lt;code&gt;client&lt;/code&gt;çš„&lt;code&gt;connection&lt;/code&gt;ï¼Œé€šè¿‡&lt;code&gt;pushChannel&lt;/code&gt;å°†&lt;code&gt;secret&lt;/code&gt;å˜æ›´äº‹ä»¶åˆ†å‘ç»™SDSæœåŠ¡æ¥å£&lt;code&gt;StreamSecrets&lt;/code&gt;ï¼Œç„¶åæ¨é€åˆ°Envoy&lt;/li&gt;
&lt;li&gt;äº‹ä»¶ç±»å‹ï¼š

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Secret_TlsCertificate&lt;/code&gt;TLSè¯ä¹¦&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Secret_ValidationContext&lt;/code&gt;å¯ä¿¡CA&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;æ¥æ”¶Envoyå¯¹SDSæœåŠ¡&lt;code&gt;StreamSecrets&lt;/code&gt;å’Œ&lt;code&gt;FetchSecrets&lt;/code&gt;è¯·æ±‚ï¼Œ&lt;code&gt;SecretManager.GenerateSecret()&lt;/code&gt;ç”Ÿæˆç§˜é’¥&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&#34;ref&#34;&gt;Ref&lt;/h1&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://zhuanlan.zhihu.com/p/59825498&#34;&gt;æ·±åº¦è§£æIstioç³»åˆ—ä¹‹å®‰å…¨æ¨¡å—ç¯‡&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://blog.fleeto.us/post/istio-security-notes/&#34;&gt;Istio å®‰å…¨è®¾ç½®ç¬”è®°&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
      
    </item>
    
    <item>
      <title>ã€go-microã€‘å¾®æœåŠ¡åä½œå¼€å‘ã€ç°åº¦å‘å¸ƒä¹‹æµé‡æŸ“è‰²</title>
      <link>http://hbchen.com/post/microservice/2019-11-30-go-micro-service-chain/</link>
      <pubDate>Sat, 30 Nov 2019 16:40:32 +0800</pubDate>
      
      <guid>http://hbchen.com/post/microservice/2019-11-30-go-micro-service-chain/</guid>
      
        <description>&lt;p&gt;åä½œå¼€å‘ä¸ç°åº¦å‘å¸ƒæ˜¯å¾®æœåŠ¡æ¡†æ¶åœ¨æµé‡æ²»ç†èƒ½åŠ›æ–¹é¢çš„ä¸¤ä¸ªä½“ç°ï¼Œæœ¬æ–‡ç»“åˆ&lt;strong&gt;go-micro&lt;/strong&gt;å®è·µå¯¹æµé‡è¿›è¡ŒæŸ“è‰²ï¼Œå®ç°å¼€å‘ç¯å¢ƒçš„å¤šåˆ†æ”¯åä½œï¼Œ
ä»¥åŠç”Ÿäº§ç¯å¢ƒçš„ç°åº¦å‘å¸ƒã€‚&lt;/p&gt;

&lt;h1 id=&#34;åœºæ™¯&#34;&gt;åœºæ™¯&lt;/h1&gt;

&lt;h2 id=&#34;å¼€å‘ç¯å¢ƒå¤šæœåŠ¡-å¤šåˆ†æ”¯åä½œ&#34;&gt;å¼€å‘ç¯å¢ƒå¤šæœåŠ¡ã€å¤šåˆ†æ”¯åä½œ&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/micro/chain-dev.png&#34; alt=&#34;micro-chain-dev&#34; /&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;QA&lt;/code&gt;ç»„æµ‹è¯•&lt;code&gt;v1.2&lt;/code&gt;å’Œ&lt;code&gt;v2.0&lt;/code&gt;é“¾è·¯

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;v2.0&lt;/code&gt; + &lt;code&gt;v1.2&lt;/code&gt;é“¾è·¯&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;v1.1&lt;/code&gt;ç»„ä»…å…³æ³¨&lt;code&gt;v1.1&lt;/code&gt;çš„ç‰ˆæœ¬å¼€å‘

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;v1.1&lt;/code&gt; + &lt;code&gt;master&lt;/code&gt;é“¾è·¯&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;v1.2&lt;/code&gt;ç»„åœ¨&lt;code&gt;v1.1&lt;/code&gt;å¼€å‘æ–°ç‰ˆ&lt;code&gt;srv-2&lt;/code&gt;æœåŠ¡

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;v1.2&lt;/code&gt; + &lt;code&gt;v1.1&lt;/code&gt; + &lt;code&gt;master&lt;/code&gt;é“¾è·¯&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;v2.0&lt;/code&gt;ç»„ä»…å…³æ³¨&lt;code&gt;v2.0&lt;/code&gt;çš„ç‰ˆæœ¬å¼€å‘

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;v2.0&lt;/code&gt; + &lt;code&gt;master&lt;/code&gt;é“¾è·¯
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;ç”Ÿäº§ç¯å¢ƒç°åº¦å‘å¸ƒ&#34;&gt;ç”Ÿäº§ç¯å¢ƒç°åº¦å‘å¸ƒ&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/micro/chain-gray.png&#34; alt=&#34;micro-chain-gray&#34; /&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;æ™®é€šç”¨æˆ·

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Pro&lt;/code&gt;é“¾è·¯&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;ç°åº¦æµ‹è¯•ç”¨æˆ·

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Gray&lt;/code&gt; + &lt;code&gt;Pro&lt;/code&gt;é“¾è·¯&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;QA

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Pre&lt;/code&gt; + &lt;code&gt;Pro&lt;/code&gt;é“¾è·¯&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&#34;æµé‡æŸ“è‰²&#34;&gt;æµé‡æŸ“è‰²&lt;/h1&gt;

&lt;p&gt;&lt;strong&gt;æµé‡æŸ“è‰²æ ¸å¿ƒï¼š&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;gatewayå¯¹è¯·æ±‚è¿›è¡ŒæŸ“è‰²

&lt;ul&gt;
&lt;li&gt;æŸ“è‰²è§„åˆ™å¯ä»¥æ˜¯&lt;code&gt;host&lt;/code&gt;ã€&lt;code&gt;header&lt;/code&gt;å­—æ®µã€&lt;code&gt;agent&lt;/code&gt;ç»ˆç«¯ä¿¡æ¯ã€ç”¨æˆ·ç­›é€‰ã€æµé‡æ¯”ä¾‹ç­‰ç­‰&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;æŸ“è‰²ä¿¡æ¯åœ¨æœåŠ¡é—´ä¼ é€’

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;go-micro&lt;/code&gt;ä¸­&lt;code&gt;http&lt;/code&gt;è¯·æ±‚çš„&lt;code&gt;header&lt;/code&gt;ä»¥åŠ&lt;code&gt;rpc&lt;/code&gt;è¯·æ±‚çš„&lt;code&gt;metadata&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;æœåŠ¡è°ƒç”¨æ—¶æ ¹æ®æŸ“è‰²ä¿¡æ¯å¯¹æœåŠ¡è¿›è¡Œç­›é€‰ï¼Œå®ç°è°ƒç”¨é“¾è·¯çš„ç®¡æ§&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æˆ‘ä»¬åŸºäº&lt;code&gt;go-micro&lt;/code&gt;å®è·µçš„æ˜¯å®ç°&lt;strong&gt;å¤šé“¾è·¯æŸ“è‰²&lt;/strong&gt;ï¼ŒæŸ“è‰²é“¾è·¯å¸¦æœ‰ä¼˜å…ˆçº§ï¼Œå¦‚&lt;a href=&#34;#å¼€å‘ç¯å¢ƒå¤šæœåŠ¡-å¤šåˆ†æ”¯åä½œ&#34;&gt;å¼€å‘ç¯å¢ƒå¤šæœåŠ¡ã€å¤šåˆ†æ”¯åä½œ&lt;/a&gt;çš„&lt;code&gt;v1.2&lt;/code&gt;ç»„ï¼Œ
è™½ç„¶&lt;code&gt;v1.1&lt;/code&gt;å’Œ&lt;code&gt;v1.2&lt;/code&gt;éƒ½æœ‰&lt;code&gt;srv-2&lt;/code&gt;æœåŠ¡ï¼Œä½†æˆ‘ä»¬åœ¨æŸ“è‰²ä¿¡æ¯ä¸­&lt;code&gt;v1.2&lt;/code&gt;åœ¨å‰ä¼˜å…ˆé€‰æ‹©ï¼Œæ‰€ä»¥å¯ä»¥å®ç°å¤šåˆ†æ”¯åŒæ—¶æŸ“è‰²(PSï¼šå¦‚æœä¸¤ä¸ªåˆ†æ”¯ä¸­ä¸¤ä¸ªæœåŠ¡çš„ä¼˜å…ˆçº§ç›¸åæ— æ³•å®ç°ï¼Œéœ€è¦è®¾è®¡æ›´å¤æ‚çš„æŸ“è‰²æ–¹æ¡ˆ)&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;ç½‘å…³æŸ“è‰²åŠ&lt;code&gt;client wrapper&lt;/code&gt;å®ç°å‚è€ƒæˆ‘å®ç°çš„ä¸¤ä¸ª&lt;code&gt;chain&lt;/code&gt;æ’ä»¶&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-plugins/tree/master/micro/chain&#34;&gt;hb-chen/micro-plugin/micro/chain&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-plugins/tree/master/wrapper/select/chain&#34;&gt;hb-chen/micro-plugin/wrapper/select/chain&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;æŸ“è‰²&#34;&gt;æŸ“è‰²&lt;/h2&gt;

&lt;p&gt;åœ¨ç½‘å…³å¯¹æµé‡è¿›è¡Œ&lt;strong&gt;æŸ“è‰²&lt;/strong&gt;ï¼ŒåŸºäº&lt;code&gt;mciro&lt;/code&gt;çš„æ’ä»¶ï¼Œå¯ä»¥æ–¹ä¾¿çš„å®ç°ï¼Œå…·ä½“æŸ“è‰²è§„åˆ™éœ€è¦æ ¹æ®è‡ªèº«éœ€æ±‚å®ç°ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;// é“¾è·¯æŸ“è‰²
api.Register(chain.New(chain.WithChainsFunc(func(r *http.Request) []string {
	return []string{&amp;quot;v2.0&amp;quot;, &amp;quot;v1.2&amp;quot;}
})))

web.Register(chain.New(chain.WithChainsFunc(func(r *http.Request) []string {
	return []string{&amp;quot;v2.0&amp;quot;}
})))
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;è°ƒç”¨é“¾è·¯ç®¡æ§&#34;&gt;è°ƒç”¨é“¾è·¯ç®¡æ§&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;go-micro&lt;/code&gt;å®ç°è°ƒç”¨é“¾è·¯ç®¡æ§ï¼Œæœ€å¤§çš„éšœç¢å°±æ˜¯&lt;strong&gt;ç½‘å…³&lt;/strong&gt;ï¼Œ&lt;code&gt;API&lt;/code&gt;åŠ&lt;code&gt;Web&lt;/code&gt;å‡ä¸æ”¯æŒæœåŠ¡ç­›é€‰ï¼Œéœ€è¦è‡ªå·±äºŒæ¬¡å¼€å‘ï¼Œç›¸å…³é—®é¢˜ä¹Ÿåé¦ˆç»™ç¤¾åŒºçœ‹åç»­è®¡åˆ’&lt;a href=&#34;https://github.com/micro/go-micro/issues/1003&#34;&gt;#1003&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;h3 id=&#34;ç½‘å…³æœåŠ¡ç­›é€‰-å‘&#34;&gt;ç½‘å…³æœåŠ¡ç­›é€‰-å‘&lt;/h3&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;æ­¤æ–¹æ³•ä»…ç”¨äºæµ‹è¯•ï¼Œå…·ä½“åŸå›  vtolstov åœ¨ç¤¾åŒºæçš„PR&lt;a href=&#34;https://github.com/micro/go-micro/pull/1388&#34;&gt;#1388&lt;/a&gt;æœ‰ asim çš„åé¦ˆ&lt;/li&gt;
&lt;li&gt;è‡ªå®šä¹‰ Router å®ç°ç½‘å…³å¯¹æœåŠ¡ç­›é€‰çš„æ”¯æŒï¼Œå®ç°å‚è€ƒæˆ‘ fork çš„åˆ†æ”¯ç‰ˆæœ¬ &lt;a href=&#34;https://github.com/hb-chen/micro/tree/gateway-2.4.0/gateway&#34;&gt;hb-chen/micro/gateway&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;strong&gt;APIç½‘å…³&lt;/strong&gt;ä»…å°è¯•äº†&lt;code&gt;api handler&lt;/code&gt;ï¼Œä¿®æ”¹ç›¸å¯¹ç®€å•ï¼Œåªéœ€è¦å¢åŠ &lt;code&gt;ClientWrapper&lt;/code&gt;ï¼Œå¹¶å»æ‰æŒ‡å®šçš„è´Ÿè½½ç­–ç•¥å³å¯ã€‚å¦‚æœä½¿ç”¨å…¶ä»–&lt;code&gt;handler&lt;/code&gt;éœ€è¦é€ä¸ªè§£å†³ã€‚&lt;/p&gt;

&lt;p&gt;&lt;em&gt;1. &lt;code&gt;micro/main.go&lt;/code&gt;æ·»åŠ &lt;code&gt;ClientWrapper&lt;/code&gt;&lt;/em&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func main() {
	cmd.Init(
		// é“¾è·¯æŸ“è‰²
		micro.WrapClient(chain.NewClientWrapper()),
	)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;em&gt;2. &lt;code&gt;go-micro/api/handler/api.go&lt;/code&gt;å»æ‰&lt;code&gt;strategy&lt;/code&gt;ï¼Œ&lt;code&gt;rpc handler&lt;/code&gt;ç±»ä¼¼&lt;/em&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// create strategy
// so := selector.WithStrategy(strategy(service.Services))

// if err := c.Call(cx, req, rsp, client.WithSelectOption(so)); err != nil {
if err := c.Call(cx, req, rsp); err != nil {
	
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;Webç½‘å…³&lt;/strong&gt;ç›¸å¯¹éº»çƒ¦ï¼Œä¸èƒ½æ–¹ä¾¿çš„ä½¿ç”¨&lt;code&gt;micro&lt;/code&gt;çš„&lt;code&gt;options&lt;/code&gt;ï¼Œæš‚æ—¶æµ‹è¯•åœ¨&lt;code&gt;web&lt;/code&gt;æ¨¡å—å®ç°&lt;code&gt;filter&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;1. &lt;code&gt;micro/web/web.go&lt;/code&gt;ä¿®æ”¹&lt;code&gt;func (s *srv) proxy() http.Handler&lt;/code&gt;ï¼Œå¢åŠ &lt;code&gt;SelectOption&lt;/code&gt;&lt;/em&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func (s *srv) proxy() http.Handler {
	sel := s.service.Client().Options().Selector

	director := func(r *http.Request) {
		kill := func() {
			r.URL.Host = &amp;quot;&amp;quot;
			r.URL.Path = &amp;quot;&amp;quot;
			r.URL.Scheme = &amp;quot;&amp;quot;
			r.Host = &amp;quot;&amp;quot;
			r.RequestURI = &amp;quot;&amp;quot;
		}

		parts := strings.Split(r.URL.Path, &amp;quot;/&amp;quot;)
		if len(parts) &amp;lt; 2 {
			kill()
			return
		}
		if !re.MatchString(parts[1]) {
			kill()
			return
		}

		// NOTE: æ·»åŠ SelectOption
		val := r.Header.Get(&amp;quot;X-Micro-Chain&amp;quot;)
		chains := strings.Split(val, &amp;quot;;&amp;quot;)

		next, err := sel.Select(Namespace+&amp;quot;.&amp;quot;+parts[1], selector.WithFilter(filterChain(chains)))
		if err != nil {
			kill()
			return
		}

		s, err := next()
		if err != nil {
			kill()
			return
		}

		r.Header.Set(BasePathHeader, &amp;quot;/&amp;quot;+parts[1])
		r.URL.Host = s.Address
		r.URL.Path = &amp;quot;/&amp;quot; + strings.Join(parts[2:], &amp;quot;/&amp;quot;)
		r.URL.Scheme = &amp;quot;http&amp;quot;
		r.Host = r.URL.Host
	}

	return &amp;amp;proxy{
		Default:  &amp;amp;httputil.ReverseProxy{Director: director},
		Director: director,
	}
}

// NOTE: SelectOptionçš„filterå®ç°
func filterChain(chains []string) selector.Filter {
	return func(old []*registry.Service) []*registry.Service {
		if len(chains) == 0 {
			return old
		}

		var services []*registry.Service

		chain := &amp;quot;&amp;quot;
		idx := 0
		for _, service := range old {
			serv := new(registry.Service)
			var nodes []*registry.Node

			for _, node := range service.Nodes {
				if node.Metadata == nil {
					continue
				}

				val := node.Metadata[&amp;quot;chain&amp;quot;]
				if len(val) == 0 {
					continue
				}

				if len(chain) &amp;gt; 0 &amp;amp;&amp;amp; idx == 0 {
					if chain == val {
						nodes = append(nodes, node)
					}
					continue
				}

				// chainsæŒ‰é¡ºåºä¼˜å…ˆåŒ¹é…
				ok, i := inArray(val, chains)
				if ok &amp;amp;&amp;amp; idx &amp;gt; i {
					// å‡ºç°ä¼˜å…ˆé“¾è·¯ï¼Œservicesæ¸…ç©ºï¼Œnodesæ¸…ç©º
					idx = i
					services = services[:0]
					nodes = nodes[:0]
				}

				if ok {
					chain = val
					nodes = append(nodes, node)
				}
			}

			// only add service if there&#39;s some nodes
			if len(nodes) &amp;gt; 0 {
				// copy
				*serv = *service
				serv.Nodes = nodes
				services = append(services, serv)
			}
		}

		if len(services) == 0 {
			return old
		}

		return services
	}
}

func inArray(s string, d []string) (bool, int) {
	for k, v := range d {
		if s == v {
			return true, k
		}
	}
	return false, 0
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;æœåŠ¡ç­›é€‰&#34;&gt;æœåŠ¡ç­›é€‰&lt;/h3&gt;

&lt;p&gt;æ™®é€šæœåŠ¡çš„ç­›é€‰æ¡†æ¶æ”¯æŒæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œé¦–å…ˆè¦ä¸ºæœåŠ¡æ·»åŠ &lt;code&gt;metadata&lt;/code&gt;ä¿¡æ¯ï¼Œä¸èµ˜è¿°ã€‚å…¶æ¬¡è¦å¯¹&lt;code&gt;Client&lt;/code&gt;è¿›è¡ŒåŒ…è£…ï¼ŒæœåŠ¡è°ƒç”¨æ—¶æ·»åŠ &lt;code&gt;SelectOption&lt;/code&gt;ï¼Œ
å®ç°å‚è€ƒæˆ‘çš„&lt;a href=&#34;https://github.com/hb-go/micro-plugins/tree/master/wrapper/select/chain&#34;&gt;chain&lt;/a&gt;æ’ä»¶ã€‚&lt;/p&gt;

&lt;p&gt;&lt;em&gt;1. æ·»åŠ &lt;code&gt;metadata&lt;/code&gt;&lt;/em&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;md := make(map[string]string)
md[&amp;quot;chain&amp;quot;] = &amp;quot;v2.0&amp;quot;

// New Service
service := micro.NewService(
	micro.Name(&amp;quot;go.micro.api.xxx&amp;quot;),
	micro.Version(&amp;quot;latest&amp;quot;),
	micro.Metadata(md),
)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;em&gt;2. Wrap Client&lt;/em&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;éœ€è¦æ³¨æ„çš„æ˜¯&lt;code&gt;service&lt;/code&gt;åˆå§‹è¿‡ç¨‹ï¼Œæœ‰ç±»ä¼¼&lt;code&gt;micro new&lt;/code&gt;æ¨¡æ¿å°†service clientæ³¨å…¥åˆ°contextçš„æ–¹æ³•ï¼Œéœ€è¦åˆ†ä¸¤æ¬¡Init()ï¼Œå…ˆWrapClientï¼Œå†WrapHandlerï¼Œ
å¦åˆ™æ³¨å…¥çš„&lt;code&gt;client&lt;/code&gt;å°†æ˜¯æœªè¢«åŒ…è£…çš„ã€‚è¿™ä¹Ÿæ˜¯microæ¯”è¾ƒå¸¸é‡åˆ°çš„&lt;strong&gt;å‘&lt;/strong&gt;ï¼&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// Initialise service
// NOTE: æ³¨æ„æœ‰ç±»ä¼¼micro newæ¨¡å—å°†service clientæ³¨å…¥åˆ°contextçš„æ–¹æ³•ï¼Œéœ€è¦åˆ†ä¸¤æ¬¡Init()ï¼Œå¦åˆ™æ³¨å…¥çš„Clientå¹¶æœªè¢«åŒ…è£…
service.Init(
	micro.WrapClient(chain.NewClientWrapper()),
)
service.Init(
	// create wrap for the Example srv client
	micro.WrapHandler(client.AccountWrapper(service)),
)
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;ref&#34;&gt;Ref&lt;/h1&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://mp.weixin.qq.com/s/UBoRKt3l91ffPagtjExmYw&#34;&gt;å¤§è§„æ¨¡å¾®æœåŠ¡åœºæ™¯ä¸‹ç°åº¦å‘å¸ƒä¸æµé‡æŸ“è‰²å®è·µ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
      
    </item>
    
    <item>
      <title>ã€go-microã€‘Network mTLS &amp; è‡ªç­¾åè¯ä¹¦</title>
      <link>http://hbchen.com/post/microservice/2019-11-27-go-micro-network-mtls/</link>
      <pubDate>Wed, 27 Nov 2019 20:39:14 +0800</pubDate>
      
      <guid>http://hbchen.com/post/microservice/2019-11-27-go-micro-network-mtls/</guid>
      
        <description>&lt;p&gt;åœ¨&lt;a href=&#34;http://hbchen.com/post/microservice/2019-11-15-go-micro-network/&#34;&gt;ã€go-microã€‘Networkåˆæ¢&lt;/a&gt;æˆ‘ä»¬åˆ†æäº†&lt;code&gt;network&lt;/code&gt;çš„åº”ç”¨åœºæ™¯ä»¥åŠå­˜åœ¨çš„ä¸è¶³ä¹‹å¤„ï¼Œ
å…¶ä¸­å¯¹äºå®‰å…¨ä¸è¶³ç ”ç©¶çš„ä¸å¤Ÿæ·±å…¥ï¼Œ&lt;code&gt;tunnel&lt;/code&gt;æ˜¯åœ¨&lt;code&gt;transport&lt;/code&gt;åŸºç¡€ä¸Šå»ºç«‹çš„ï¼Œè€Œ&lt;code&gt;transport&lt;/code&gt;å±‚æœ‰&lt;code&gt;mTLS&lt;/code&gt;çš„æ”¯æŒï¼Œæ‰€ä»¥å½“æ—¶æ‰€è¯´çš„åœ¨å®‰å…¨æ–¹é¢åªæœ‰&lt;code&gt;header&lt;/code&gt;ä¸­çš„&lt;code&gt;token&lt;/code&gt;æ˜¯é”™è¯¯çš„ã€‚
åªæ˜¯&lt;code&gt;micro&lt;/code&gt;å½“å‰åœ¨&lt;code&gt;network&lt;/code&gt;è¿˜æ²¡æœ‰åš&lt;code&gt;mTLS&lt;/code&gt;ç¯å¢ƒå˜é‡çš„æ”¯æŒï¼Œæœ¬æ–‡å°†åšä¸€ä¸ªç®€å•çš„åˆ†äº«ä¸º&lt;code&gt;network&lt;/code&gt;å¢åŠ &lt;code&gt;mTLS&lt;/code&gt;æ”¯æŒã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;åˆšåˆš(2019-11-27)&lt;code&gt;micro&lt;/code&gt;åˆå‘å¸ƒäº†æ–°ç‰ˆæœ¬&lt;code&gt;1.17.0&lt;/code&gt;ï¼Œç»§ç»­é‡‡å‘ğŸ¤£&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;networkä¿®æ”¹&#34;&gt;Networkä¿®æ”¹&lt;/h2&gt;

&lt;p&gt;å½“å‰&lt;code&gt;micro&lt;/code&gt;çš„&lt;code&gt;network&lt;/code&gt;æ¨¡å—å¹¶æ²¡æœ‰æä¾›&lt;code&gt;TLS&lt;/code&gt;ç¯å¢ƒå˜é‡é…ç½®çš„æ”¯æŒï¼Œéœ€è¦è‡ªå·±ä¿®æ”¹æºç ï¼Œåœ¨&lt;a href=&#34;https://github.com/micro/micro&#34;&gt;micro/micro&lt;/a&gt;çš„&lt;code&gt;internal/helper&lt;/code&gt;æœ‰&lt;code&gt;TLSConfig()&lt;/code&gt;æ–¹æ³•å¯ä»¥ä»&lt;code&gt;GLOBAL OPTIONS&lt;/code&gt;ä¸­ç”Ÿæˆ&lt;code&gt;*tls.Config&lt;/code&gt;ï¼Œ
å‚è€ƒå½“å‰&lt;code&gt;micro&lt;/code&gt;å®ç°&lt;code&gt;mTLS&lt;/code&gt;ä¸¤ä¸ª&lt;code&gt;command&lt;/code&gt;(&lt;code&gt;api&lt;/code&gt;å’Œ&lt;code&gt;web&lt;/code&gt;)ï¼Œå¯¹&lt;code&gt;network&lt;/code&gt;çš„&lt;code&gt;tunnel&lt;/code&gt;åšå¦‚ä¸‹ä¿®æ”¹:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// create a tunnel
tunOpts := []tunnel.Option{
	tunnel.Address(Address),
	tunnel.Nodes(nodes...),
	tunnel.Token(Token),
}
if ctx.GlobalBool(&amp;quot;enable_tls&amp;quot;) {
	config, err := helper.TLSConfig(ctx)
	if err != nil {
		fmt.Println(err.Error())
		return
	}
	config.InsecureSkipVerify = true

	tunOpts = append(tunOpts, tunnel.Transport(
		quic.NewTransport(transport.TLSConfig(config)),
	))
}
tun := tunnel.NewTunnel(tunOpts...)
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;æ³¨æ„è¿™é‡Œæˆ‘ä»¬è®¾ç½®äº†&lt;code&gt;InsecureSkipVerify&lt;/code&gt;ä¸º&lt;code&gt;true&lt;/code&gt;ï¼Œç”±äºæ˜¯åŒå‘è®¤è¯ï¼Œå¦‚æœ&lt;code&gt;InsecureSkipVerify&lt;/code&gt;ä¸º&lt;code&gt;false&lt;/code&gt;ï¼Œ&lt;code&gt;network&lt;/code&gt;å°†æ— æ³•æ­£å¸¸è¿æ¥&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;mtls&#34;&gt;mTLS&lt;/h2&gt;

&lt;p&gt;é¦–å…ˆå‚è€ƒä¸‹å›¾å¯¹&lt;code&gt;mTLS&lt;/code&gt;æœ‰ä¸ªäº†è§£ï¼Œ&lt;code&gt;server&lt;/code&gt;å’Œ&lt;code&gt;client&lt;/code&gt;éƒ½éœ€è¦é€šè¿‡&lt;code&gt;CA&lt;/code&gt;å¯¹å½¼æ­¤çš„è¯ä¹¦è¿›è¡ŒéªŒè¯&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/micro/mtls.png&#34; alt=&#34;network_multi_cluster&#34; /&gt;&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬åªç”Ÿæˆä¸€ä¸ª&lt;code&gt;CA&lt;/code&gt;å’Œ&lt;code&gt;CSR&lt;/code&gt;è¯ä¹¦ï¼Œå¯¹äºç”Ÿäº§ç¯å¢ƒæ ¹æ®è‡ªå·±çš„åœºæ™¯éœ€è¦æ›´ä¸ºå®Œå–„å’Œå¤æ‚çš„è¯ä¹¦ç®¡ç†ï¼Œè¿™é‡Œæ²¡æœ‰æ¶‰åŠï¼Œåé¢ä¼šç»“åˆ&lt;code&gt;micro&lt;/code&gt;ç”Ÿæ€ä¸å®‰å…¨ç›¸å…³çš„&lt;code&gt;mTLS&lt;/code&gt;åšæ›´å¤šçš„ç ”ç©¶åˆ†äº«ã€‚&lt;/p&gt;

&lt;h3 id=&#34;caè¯ä¹¦&#34;&gt;CAè¯ä¹¦&lt;/h3&gt;

&lt;p&gt;ä½¿ç”¨&lt;a href=&#34;https://github.com/square/certstrap&#34;&gt;certstrap&lt;/a&gt;å·¥å…·ç”Ÿæˆ&lt;code&gt;CA&lt;/code&gt;è¯ä¹¦&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# MacOS
$ brew install certstrap

# æœªè¾“å…¥å¯†ç 
$ certstrap init --common-name &amp;quot;MicroCA&amp;quot; --expires &amp;quot;20 years&amp;quot;
    Enter passphrase (empty for no passphrase): 
    Enter same passphrase again: 
    Created out/MicroCA.key
    Created out/MicroCA.crt
    Created out/MicroCA.crl
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;csrè¯ä¹¦&#34;&gt;CSRè¯ä¹¦&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ certstrap request-cert -cn network  
	Enter passphrase (empty for no passphrase): 
    Enter same passphrase again: 
    Created out/network.key
    Created out/network.csr
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;csrè¯ä¹¦ç­¾å&#34;&gt;CSRè¯ä¹¦ç­¾å&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ certstrap sign network --CA MicroCA
	Created out/network.crt from out/network.csr signed by out/MicroCA.key
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;è¿è¡Œnetwork-mtls&#34;&gt;è¿è¡ŒNetwork + mTLS&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ./micro \
--registry=etcd \
--transport=tcp \
--enable_tls=true \
--tls_cert_file=conf/tls/network.crt  \
--tls_key_file=conf/tls/network.key  \
--tls_client_ca_file=conf/tls/MicroCA.crt \
network

$ ./micro \
--registry=consul \
--transport=tcp \
--enable_tls=true \
--tls_cert_file=conf/tls/network.crt  \
--tls_key_file=conf/tls/network.key  \
--tls_client_ca_file=conf/tls/MicroCA.crt \
network \
--nodes=localhost:8085 \
--address=:8086
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;Network routes&lt;/strong&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å¦‚æœ&lt;code&gt;routes&lt;/code&gt;ä¸­çœ‹ä¸åˆ°&lt;code&gt;link=network&lt;/code&gt;åº”è¯¥æ˜¯&lt;code&gt;network&lt;/code&gt;é—´æœªèƒ½å»ºç«‹è¿æ¥&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;./micro --registry=etcd --transport=tcp network routes  
+------------------+----------------------+----------------------+--------------------------------------+----------+--------+---------+
|     SERVICE      |       ADDRESS        |       GATEWAY        |                ROUTER                | NETWORK  | METRIC |  LINK   |
+------------------+----------------------+----------------------+--------------------------------------+----------+--------+---------+
| consul           | 1919625842587659968  | 17017708900476934200 | f5dc3933-3ccc-4dc0-bafe-cbfd7abebf60 | go.micro | 1      | network |
| go.micro.network | 15624894091238291400 | 17017708900476934200 | f5dc3933-3ccc-4dc0-bafe-cbfd7abebf60 | go.micro | 1      | network |
| go.micro.network | 192.168.1.4:58527    |                      | df521f3c-a39e-455b-abbf-ada184a900c9 | go.micro | 1      | local   |
| go.micro.network | 192.168.1.4:58528    |                      | df521f3c-a39e-455b-abbf-ada184a900c9 | go.micro | 1      | local   |
| go.micro         | 192.168.1.4:8085     |                      | df521f3c-a39e-455b-abbf-ada184a900c9 | go.micro | 1      | local   |
| go.micro         | 9876822083478954444  | 17017708900476934200 | f5dc3933-3ccc-4dc0-bafe-cbfd7abebf60 | go.micro | 1      | network |
+------------------+----------------------+----------------------+--------------------------------------+----------+--------+---------+

./micro --registry=consul --transport=tcp network routes
+------------------+----------------------+---------------------+--------------------------------------+----------+--------+---------+
|     SERVICE      |       ADDRESS        |       GATEWAY       |                ROUTER                | NETWORK  | METRIC |  LINK   |
+------------------+----------------------+---------------------+--------------------------------------+----------+--------+---------+
| consul           | 127.0.0.1:8300       |                     | f5dc3933-3ccc-4dc0-bafe-cbfd7abebf60 | go.micro | 1      | local   |
| go.micro         | 192.168.1.4:8086     |                     | f5dc3933-3ccc-4dc0-bafe-cbfd7abebf60 | go.micro | 1      | local   |
| go.micro         | 9480410441638176179  | 3307701226171868606 | df521f3c-a39e-455b-abbf-ada184a900c9 | go.micro | 2      | network |
| go.micro.network | 11801771601773192119 | 3307701226171868606 | df521f3c-a39e-455b-abbf-ada184a900c9 | go.micro | 2      | network |
| go.micro.network | 192.168.1.4:58843    |                     | f5dc3933-3ccc-4dc0-bafe-cbfd7abebf60 | go.micro | 1      | local   |
| go.micro.network | 192.168.1.4:58844    |                     | f5dc3933-3ccc-4dc0-bafe-cbfd7abebf60 | go.micro | 1      | local   |
+------------------+----------------------+---------------------+--------------------------------------+----------+--------+---------+
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;ref&#34;&gt;Ref&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://www.gitdig.com/about/&#34;&gt;Go ç¼–ç¨‹: å¿«é€Ÿç”Ÿæˆè‡ªç­¾åè¯ä¹¦ä¸åŒå‘è®¤è¯(mTLS)&lt;/a&gt;&lt;/p&gt;</description>
      
    </item>
    
    <item>
      <title>ã€go-microã€‘Networkåˆæ¢</title>
      <link>http://hbchen.com/post/microservice/2019-11-15-go-micro-network/</link>
      <pubDate>Fri, 15 Nov 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/microservice/2019-11-15-go-micro-network/</guid>
      
        <description>&lt;p&gt;Networkæ˜¯microç¤¾åŒºæ­£åœ¨ä¸»åŠ›æ‰“é€ çš„è§£å†³å¤š&amp;rdquo;äº‘&amp;rdquo;ç¯å¢ƒçš„è§£å†³æ–¹æ¡ˆï¼Œä¸‹é¢ç»“åˆæœ€è¿‘çš„ç ”ç©¶åšä¸ªæ€»ç»“ï¼Œä¸»è¦åŒ…æ‹¬&lt;code&gt;network&lt;/code&gt;é€‚ç”¨çš„å‡ ç§åœºæ™¯åˆ†æï¼Œ
ä»¥åŠåœ¨è¿™äº›åœºæ™¯éœ€æ±‚ä¸‹&lt;code&gt;network&lt;/code&gt;è¿˜æœ‰å“ªäº›ä¸è¶³ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://micro.mu/docs/network.html&#34;&gt;Network Overview&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://micro.mu/docs/service-network.html&#34;&gt;Service Network&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;proxy&#34;&gt;Proxy&lt;/h2&gt;

&lt;p&gt;åœ¨åˆ†æ&lt;code&gt;network&lt;/code&gt;ä¹‹å‰å…ˆäº†è§£&lt;code&gt;micro&lt;/code&gt;çš„&lt;code&gt;proxy&lt;/code&gt;æ¨¡å¼ï¼ŒæœåŠ¡ä¹‹é—´è°ƒç”¨ä¸éœ€è¦æœåŠ¡å‘ç°ï¼Œè€Œæ˜¯é€šè¿‡&lt;code&gt;proxy&lt;/code&gt;åšè½¬å‘ï¼Œç”±&lt;code&gt;proxy&lt;/code&gt;å®ŒæˆæœåŠ¡çš„å‘ç°å’Œè°ƒç”¨ã€‚
&lt;code&gt;network&lt;/code&gt;å®ç°äº†ä¸€ä¸ªç‰¹æ®Šçš„ä»£ç†ï¼Œå®ƒçš„æœåŠ¡å‘ç°å¹¶ä¸åªæ˜¯é€šè¿‡æ³¨å†Œä¸­å¿ƒï¼ŒåŒæ—¶æœ‰&lt;code&gt;network&lt;/code&gt;ä¹‹é—´å…±äº«çš„æœåŠ¡ã€‚
&lt;img src=&#34;http://hbchen.com/img/micro/proxy.png&#34; alt=&#34;micro-proxy&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;æœåŠ¡å¯è§æ€§&#34;&gt;æœåŠ¡å¯è§æ€§&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;network&lt;/code&gt;é€šè¿‡å…±äº«æœåŠ¡ä¿¡æ¯ï¼Œå®ç°è·¨&lt;code&gt;network&lt;/code&gt;çš„æœåŠ¡å¯è§ï¼Œä»è€Œå®ç°ä»£ç†çš„æœåŠ¡å‘ç°ï¼Œå¹¶ä¸”å…±äº«æ˜¯æœ‰å¯è§æ€§çš„ï¼Œå½“å‰&lt;code&gt;advertise_strategy&lt;/code&gt;æœ‰&lt;code&gt;3+1&lt;/code&gt;ç§æ–¹æ¡ˆ:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;none&lt;/code&gt;ä¸å…±äº«æœåŠ¡

&lt;ul&gt;
&lt;li&gt;å³åªæ¥å—å¤–éƒ¨æœåŠ¡ï¼Œé€‚åˆè¾¹ç¼˜èŠ‚ç‚¹ï¼Œä¾èµ–ä¸­å¿ƒæœåŠ¡åœºæ™¯&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;all&lt;/code&gt;å…±äº«å…¨éƒ¨æœåŠ¡&lt;/li&gt;
&lt;li&gt;&lt;code&gt;best&lt;/code&gt;å…±äº«æœ€ä¼˜è·¯ç”±

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;local&lt;/code&gt;ä»…å…±äº«é›†ç¾¤å†…éƒ¨æœåŠ¡ï¼Œè€Œä¸å…±äº«ä»å…¶ä»–&lt;code&gt;network&lt;/code&gt;å…±äº«å¾—åˆ°çš„æœåŠ¡ï¼Œå®é™…æ˜¯&lt;code&gt;best&lt;/code&gt;çš„ä¸€ä¸ªç­›é€‰é¡¹ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¯´å®ƒæ˜¯&lt;code&gt;3+1&lt;/code&gt;
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;p&gt;æˆªæ­¢&lt;code&gt;v1.6.0&lt;/code&gt;ç‰ˆæœ¬è¿˜æ²¡æœ‰æ­¤åŠŸèƒ½ï¼Œéœ€è¦ä½¿ç”¨&lt;code&gt;master&lt;/code&gt;åˆ†æ”¯ï¼Œ&lt;a href=&#34;https://github.com/micro/go-micro/pull/932&#34;&gt;PR#932&lt;/a&gt;å¢åŠ äº†æ­¤ç­–ç•¥çš„æ”¯æŒï¼Œ
ä»¥microçš„å‘ç‰ˆé€Ÿåº¦åº”è¯¥è¦ä¸äº†å¤šä¹…å°±ä¼šæœ‰Releaseç‰ˆğŸ¤£&lt;/p&gt;

&lt;p&gt;Networkåœ¨ä¸æ–­å®Œå–„ï¼Œæœ¬æ–‡å‚è€ƒç‰ˆæœ¬ä¸ºï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/micro/micro/tree/98d9b1f332a2&#34;&gt;micro/tree/98d9b1f332a2&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/micro/go-micro/tree/9f481542f38d&#34;&gt;go-micro/tree/9f481542f38d&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;åº”ç”¨åœºæ™¯&#34;&gt;åº”ç”¨åœºæ™¯&lt;/h2&gt;

&lt;h3 id=&#34;å¤šé›†ç¾¤&#34;&gt;å¤šé›†ç¾¤&lt;/h3&gt;

&lt;p&gt;å¤šé›†ç¾¤åœºæ™¯åˆ†ä¸¤ç§ä¸€æ˜¯&lt;strong&gt;é›†ç¾¤æœåŠ¡å…±äº«&lt;/strong&gt;ï¼ŒäºŒæ˜¯&lt;strong&gt;å¤šä¸­å¿ƒ/ä¸»å¤‡é›†ç¾¤&lt;/strong&gt;ï¼Œåœ¨&lt;code&gt;advertise_strategy&lt;/code&gt;ç­–ç•¥é€‰æ‹©æœ‰åŒºåˆ«ã€‚&lt;/p&gt;

&lt;h4 id=&#34;é›†ç¾¤æœåŠ¡å…±äº«&#34;&gt;é›†ç¾¤æœåŠ¡å…±äº«&lt;/h4&gt;

&lt;p&gt;é›†ç¾¤æœåŠ¡å…±äº«æ˜¯æŒ‡ä¸åŒé›†ç¾¤æ‹¥æœ‰ä¸åŒçš„æœåŠ¡ï¼Œå®ç°é›†ç¾¤é—´çš„æœåŠ¡å‘ç°ï¼Œé€‰æ‹©çš„ç­–ç•¥æ˜¯&lt;code&gt;advertise_strategy=local&lt;/code&gt;ï¼Œ&lt;code&gt;network&lt;/code&gt;ä»…å…±äº«è‡ªèº«æœåŠ¡ï¼Œ
å¦‚æœ&lt;code&gt;DC B&lt;/code&gt;ä¸&lt;code&gt;DC C&lt;/code&gt;éœ€è¦å…±äº«æœåŠ¡ï¼Œé‚£ä¹ˆéœ€è¦ç›´æ¥å»ºç«‹è¿æ¥ï¼Œè€Œä¸æ˜¯é€šè¿‡&lt;code&gt;DC A&lt;/code&gt;
&lt;img src=&#34;http://hbchen.com/img/micro/network_multi_cluster_1.png&#34; alt=&#34;network_multi_cluster&#34; /&gt;&lt;/p&gt;

&lt;h4 id=&#34;å¤šä¸­å¿ƒ-ä¸»å¤‡é›†ç¾¤&#34;&gt;å¤šä¸­å¿ƒ/ä¸»å¤‡é›†ç¾¤&lt;/h4&gt;

&lt;p&gt;å¤šä¸­å¿ƒ/ä¸»å¤‡é›†ç¾¤æ˜¯å°†åŒä¸€å¥—æœåŠ¡éƒ¨ç½²åœ¨å¤šä¸ªä¸­å¿ƒï¼Œå¯èƒ½æ˜¯å¤šæ´»ï¼Œä¹Ÿå¯èƒ½æ˜¯åˆ†ä¸»å¤‡ï¼Œé€‰æ‹©çš„ç­–ç•¥æ˜¯&lt;code&gt;advertise_strategy=best&lt;/code&gt;ï¼Œä½†ç°åœ¨&lt;code&gt;network&lt;/code&gt;åœ¨è´Ÿè½½ç­–ç•¥ä¸Šè¿˜æ²¡æœ‰&lt;strong&gt;å°±è¿‘åŸåˆ™&lt;/strong&gt;
&lt;img src=&#34;http://hbchen.com/img/micro/network_multi_cluster_2.png&#34; alt=&#34;network_multi_cluster&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;ä¸­å¿ƒæœåŠ¡-è¾¹ç¼˜&#34;&gt;ä¸­å¿ƒæœåŠ¡+è¾¹ç¼˜&lt;/h3&gt;

&lt;p&gt;å¯¹äºè¾¹ç¼˜è®¡ç®—åœºæ™¯ï¼Œè¾¹ç¼˜èŠ‚ç‚¹å¯èƒ½æ˜¯ä¸æä¾›æœåŠ¡çš„ï¼Œæ¯”å¦‚åªä¸ŠæŠ¥æ•°æ®ï¼Œå¯ä»¥é€‰æ‹©&lt;code&gt;advertise_strategy=none&lt;/code&gt;ï¼Œå½“ç„¶æœ‰çš„å¯èƒ½åˆæ˜¯æä¾›æœåŠ¡çš„ï¼Œå¯ä»¥é€‰æ‹©&lt;code&gt;advertise_strategy=local&lt;/code&gt;ï¼Œ
ä½†&lt;code&gt;DC A&lt;/code&gt;å¹¶ä¸ä¼šå°†&lt;code&gt;DC C&lt;/code&gt;çš„æœåŠ¡å…±äº«ç»™&lt;code&gt;DC B&lt;/code&gt;ã€‚å› ä¸º&lt;code&gt;network&lt;/code&gt;é—´é€šè¿‡&lt;code&gt;tunnel&lt;/code&gt;é€šä¿¡ï¼Œè¾¹ç¼˜èŠ‚ç‚¹å¯ä»¥æ˜¯ä»»æ„ç½‘ç»œï¼Œåªè¦è¿æ¥åˆ°ä¸­å¿ƒæœåŠ¡çš„&lt;code&gt;network&lt;/code&gt;å³å¯ã€‚
&lt;img src=&#34;http://hbchen.com/img/micro/network_edge.png&#34; alt=&#34;network_edge&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;ä¸è¶³&#34;&gt;ä¸è¶³&lt;/h2&gt;

&lt;h3 id=&#34;networké«˜å¯ç”¨åŠæ€§èƒ½&#34;&gt;Networké«˜å¯ç”¨åŠæ€§èƒ½&lt;/h3&gt;

&lt;p&gt;è¦è€ƒè™‘&lt;code&gt;network&lt;/code&gt;çš„é«˜å¯ç”¨ï¼Œå¿…é¡»æ”¯æŒå¤šå‰¯æœ¬æ°´å¹³æ‰©å±•ï¼Œç°åœ¨åŒä¸€é›†ç¾¤å†…&lt;code&gt;network&lt;/code&gt;ä¼šå…±äº«æœåŠ¡ï¼Œä½†å½“å‰&lt;code&gt;network&lt;/code&gt;çš„æœåŠ¡å¯è§æ€§å¹¶æ²¡æœ‰å°†é›†ç¾¤å†…&lt;code&gt;node&lt;/code&gt;ä¸ç›´è¿çš„&lt;code&gt;node&lt;/code&gt;èŠ‚ç‚¹åšåŒºåˆ†ï¼Œ
å¦‚æœé›†ç¾¤å†…å‡ºç°nä¸ªå‰¯æœ¬ï¼Œé‚£ä¹ˆæœ€å·®çš„æƒ…å†µä¸‹å¯èƒ½è¦åœ¨&lt;code&gt;network&lt;/code&gt;çš„&lt;code&gt;pod&lt;/code&gt;é—´è·³è½¬næ¬¡ã€‚ç†æƒ³çŠ¶æ€åº”è¯¥æ˜¯å¯¹äºé›†ç¾¤å†…ä»…å…±äº«ä¸&lt;code&gt;node&lt;/code&gt;ç›´è¿çš„&lt;strong&gt;é›†ç¾¤å¤–æœåŠ¡&lt;/strong&gt;ï¼ˆè¿™æ˜¯å½“å‰&lt;code&gt;network&lt;/code&gt;ä¸å…·å¤‡ï¼‰ï¼Œ
è€Œå¯¹é›†ç¾¤å¤–å…±äº«æœ¬é›†ç¾¤æœåŠ¡ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿é›†ç¾¤å†…&lt;code&gt;network&lt;/code&gt;ä»£ç†æœ€å¤šç»è¿‡&lt;strong&gt;ä¸¤è·³&lt;/strong&gt;å³å¯è°ƒç”¨é›†ç¾¤å¤–æœåŠ¡ã€‚
&lt;img src=&#34;http://hbchen.com/img/micro/network_problem_ha.png&#34; alt=&#34;network_edge&#34; /&gt;
å›¾ä¸­çº¢è‰²æ ‡è®°çš„&lt;code&gt;go.micro.srv.s-2 gateway-a-2&lt;/code&gt;ã€&lt;code&gt;go.micro.srv.s-2 gateway-a-3&lt;/code&gt;ä¸åº”è¯¥å‡ºç°åœ¨&lt;code&gt;network&lt;/code&gt;çš„&lt;code&gt;routes&lt;/code&gt;ä¸­ï¼Œé¿å…åŒä¸€é›†ç¾¤å†…æ²¡å¿…è¦çš„è·¯ç”±ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;æœ‰å…³&lt;code&gt;network&lt;/code&gt;çš„å¤šå‰¯æœ¬è¿˜éœ€è¦è¿›ä¸€æ­¥ç ”ç©¶ï¼Œæ¯”å¦‚4ä¸ªåä¼šä¸ä¼šå‡ºç°é“¾è·¯å¾ªç¯ï¼Œä»¥åŠå…·ä½“è·¯ç”±è´Ÿè½½ç­–ç•¥ç­‰&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;æ€»çš„æ¥è¯´æ˜¯&lt;code&gt;advertise_strategy&lt;/code&gt;éœ€è¦æ›´å®Œå–„çš„ç­–ç•¥æ”¯æŒï¼Œåšå¿…è¦çš„éš”ç¦»ã€ç­›é€‰ï¼Œä¸€æ˜¯æœåŠ¡çš„å¯è§æ€§é—®é¢˜ï¼ŒäºŒæ˜¯æœåŠ¡è§„æ¨¡å¢åŠ å&lt;code&gt;network&lt;/code&gt;é—´çš„æ•°æ®é€šä¿¡ä¹Ÿä¼šæˆä¸ºç“¶é¢ˆã€‚&lt;/p&gt;

&lt;h3 id=&#34;è·¯ç”±è´Ÿè½½ç­–ç•¥&#34;&gt;è·¯ç”±è´Ÿè½½ç­–ç•¥&lt;/h3&gt;

&lt;p&gt;è·¯ç”±è´Ÿè½½é€‰æ‹©éœ€è¦ä¼˜å…ˆçº§ã€ç­›é€‰ç­‰ç­–ç•¥ï¼Œå¦‚localä¼˜å…ˆï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥å®ç°ä¸»å¤‡é›†ç¾¤ï¼Œä»¥åŠé›†ç¾¤é—´æµé‡åˆ‡æ¢ç­‰åœºæ™¯çš„åº”ç”¨&lt;/p&gt;

&lt;h3 id=&#34;å®‰å…¨&#34;&gt;å®‰å…¨&lt;/h3&gt;

&lt;blockquote&gt;
&lt;p&gt;æ›´æ­£ï¼šè¿™é‡Œæˆ‘ä»¬å¿½ç•¥äº†&lt;code&gt;tunnel&lt;/code&gt;çš„&lt;code&gt;transport&lt;/code&gt;ï¼Œåœ¨&lt;code&gt;transport&lt;/code&gt;å±‚æ˜¯æœ‰&lt;code&gt;mTLS&lt;/code&gt;æ”¯æŒçš„ï¼Œå…·ä½“å‚è€ƒ&lt;a href=&#34;http://hbchen.com/post/microservice/2019-11-27-go-micro-tunnel-mtls/&#34;&gt;ã€go-microã€‘è‡ªç­¾åè¯ä¹¦&amp;amp;Tunnel mTLS&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;del&gt;&lt;code&gt;network&lt;/code&gt;é—´çš„è¿æ¥æ˜¯é€šè¿‡&lt;code&gt;tunnel&lt;/code&gt;å®Œæˆï¼Œè€Œ&lt;code&gt;tunnel&lt;/code&gt;åœ¨å®‰å…¨æ–¹é¢åªæ˜¯åœ¨&lt;code&gt;message&lt;/code&gt;çš„&lt;code&gt;header&lt;/code&gt;ä¸­æ”¾äº†ä¸€ä¸ª&lt;code&gt;token&lt;/code&gt;ç”¨äºç›¸äº’éªŒè¯ï¼Œè¿™ä¹Ÿæ˜¯éœ€è¦åŠ å¼ºçš„éƒ¨åˆ†ã€‚&lt;/del&gt;&lt;/p&gt;

&lt;h2 id=&#34;networkæ¨¡æ‹Ÿæµ‹è¯•&#34;&gt;Networkæ¨¡æ‹Ÿæµ‹è¯•&lt;/h2&gt;

&lt;p&gt;å¯ä»¥æœ¬åœ°ä½¿ç”¨ä¸åŒçš„æ³¨å†Œä¸­å¿ƒæ¨¡æ‹Ÿå¤šä¸ªé›†ç¾¤ï¼Œç®€å•çš„&lt;code&gt;mdns&lt;/code&gt;ã€&lt;code&gt;consul&lt;/code&gt;å’Œ&lt;code&gt;etcd&lt;/code&gt;å°±å¯ä»¥æ¨¡æ‹Ÿå‡ºä¸‰ä¸ªé›†ç¾¤ï¼Œå¦‚æœæœ‰å…¬ç½‘æœåŠ¡å™¨å½“ç„¶æ›´å¥½ã€‚&lt;/p&gt;</description>
      
    </item>
    
    <item>
      <title>ã€go-microã€‘å¾®æœåŠ¡å¿«é€Ÿå¼€å§‹</title>
      <link>http://hbchen.com/post/microservice/2019-10-13-go-micro-quick-start/</link>
      <pubDate>Sun, 13 Oct 2019 15:27:12 +0800</pubDate>
      
      <guid>http://hbchen.com/post/microservice/2019-10-13-go-micro-quick-start/</guid>
      
        <description>&lt;p&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start&#34;&gt;github.com/hb-go/micro-quick-start&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;è¿™åªæ˜¯ä¸€ä¸ªç®€æ˜“æ•™ç¨‹ï¼Œæ˜¯ç»“åˆæ¼”ç¤ºæ–‡ç¨¿&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/blob/master/micro-quick-start.pdf&#34;&gt;micro-quick-start.pdf&lt;/a&gt;çš„ä»£ç ç¤ºä¾‹ï¼Œ
ç»“åˆæ¼”ç¤ºæ–‡ç¨¿å¯ä»¥å¿«é€Ÿäº†è§£å¾®æœåŠ¡ä¸&lt;code&gt;go-micro&lt;/code&gt;æ¡†æ¶ï¼Œå¹¶å¯ä»¥ç»“åˆä»£ç ç¤ºä¾‹è¿›è¡ŒéªŒè¯æµ‹è¯•ï¼Œæ–‡ç¨¿ä¸­æœ‰å…³äº&lt;a href=&#34;#microè‡ªå®šä¹‰&#34;&gt;&lt;code&gt;micro&lt;/code&gt;è‡ªå®šä¹‰&lt;/a&gt;ä»¥åŠ&lt;code&gt;go-micro&lt;/code&gt;ç°æˆç»„ä»¶çš„ä½¿ç”¨è¿™é‡Œå¹¶æ²¡æœ‰å…¨éƒ¨ç¤ºèŒƒï¼Œ
è¯¦ç»†å‚è€ƒæ–‡ç¨¿ï¼Œæœ¬æ•™ç¨‹æ¯ä¸ªç¤ºä¾‹å‡å¯¹åº”ä¸€ä¸ª&lt;code&gt;commit&lt;/code&gt;ï¼Œå¯ä»¥å¿«é€ŸæŸ¥çœ‹/æ¯”è¾ƒç¤ºä¾‹ç›¸å…³ä»£ç ï¼ŒåŒ…å«ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/commit/e76368bbee7dec646d13f1d9644b9d529e88074f&#34;&gt;æœåŠ¡åˆ›å»º&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;é€šè¿‡&lt;code&gt;micro new&lt;/code&gt;åˆ›å»ºæœåŠ¡åè¿›è¡Œå®Œå–„ï¼Œä½¿æ¨¡æ¿åˆ›å»ºçš„æœåŠ¡å¯ä»¥è¿è¡Œ&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/commit/5f7de50b10c19e19ef546144d6a11adf69ad1cfd&#34;&gt;è‡ªå®šä¹‰Server&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/commit/ff70f21ba9d6a9bbf889598c0837e058706bf2fd&#34;&gt;è‡ªå®šä¹‰Transport&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/commit/615d4604e251bf1188fe12a0be22e05ca9c4ebf9&#34;&gt;æœåŠ¡ç­›é€‰&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/commit/703851f4364c541c436896f85badb836859c3b7e&#34;&gt;è‡ªå®šä¹‰Wrapper-ç›‘æ§&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/commit/2f0baa1f5117d44809be07d6435fe36aeb1b9990&#34;&gt;è¶…æ—¶&amp;amp;é‡è¯•&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/commit/11453df1566721c1b8aa50d253e3454986aa2c4f&#34;&gt;é™æµ&amp;amp;ç†”æ–­&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/commit/8573ae85a7bd70038c0e0a18900bfa76d4cddb6c&#34;&gt;é…ç½®-consul&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/commit/d3f79f6c427822c1646ee7ccb2a4ba68c81681fd&#34;&gt;é“¾è·¯è¿½è¸ª&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-quick-start/commit/8979073c7f473635e84d0300b61a749b66bc3bd1&#34;&gt;k8séƒ¨ç½²&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;microè‡ªå®šä¹‰&#34;&gt;microè‡ªå®šä¹‰&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;micro&lt;/code&gt;åšä¸ºç½‘å…³å¾€å¾€éœ€è¦è‡ªå®šä¹‰ï¼Œ&lt;code&gt;micro&lt;/code&gt;æä¾›äº†&lt;code&gt;plugin&lt;/code&gt;çš„è‡ªå®šä¹‰ï¼Œä»¥ä¸‹æ˜¯éƒ¨åˆ†å‚è€ƒï¼Œå¦‚å¢åŠ ç»„ä»¶&lt;code&gt;tcp&lt;/code&gt;ã€&lt;code&gt;kubernetes&lt;/code&gt;ï¼Œä½¿ç”¨&lt;code&gt;go-plugins&lt;/code&gt;ä¸­å·²æœ‰çš„&lt;code&gt;micro/metrics&lt;/code&gt;æ’ä»¶ï¼Œ
ä»¥åŠå®Œå…¨è‡ªå®šä¹‰ä¸€ä¸ª&lt;code&gt;metrics&lt;/code&gt;æ’ä»¶ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;package main

import (
	&amp;quot;github.com/micro/go-micro/util/log&amp;quot;
	&amp;quot;github.com/micro/go-plugins/micro/metrics&amp;quot;
	&amp;quot;github.com/micro/micro/api&amp;quot;
	&amp;quot;github.com/micro/micro/plugin&amp;quot;
	&amp;quot;github.com/micro/micro/web&amp;quot;
	&amp;quot;github.com/prometheus/client_golang/prometheus&amp;quot;
	&amp;quot;github.com/prometheus/client_golang/prometheus/promhttp&amp;quot;
	&amp;quot;net/http&amp;quot;
	&amp;quot;strconv&amp;quot;

	// tcp transport
	_ &amp;quot;github.com/micro/go-plugins/transport/tcp&amp;quot;

	// k8s registry
	_ &amp;quot;github.com/micro/go-plugins/registry/kubernetes&amp;quot;
)

// Metrics
func init() {
	api.Register(metrics.NewPlugin())
	web.Register(metrics.NewPlugin())
}

// è‡ªå®šä¹‰Metrics
func init() {
	api.Register(plugin.NewPlugin(
		plugin.WithHandler(
			func(h http.Handler) http.Handler {
				return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
					r.Header.Get(&amp;quot;&amp;quot;)
				})
			}),
	))

	api.Register(plugin.NewPlugin(
		plugin.WithHandler(
			func(h http.Handler) http.Handler {
				md := make(map[string]string)

				opsCounter := prometheus.NewCounterVec(
					prometheus.CounterOpts{
						Namespace: &amp;quot;micro&amp;quot;,
						Name:      &amp;quot;request_total&amp;quot;,
						Help:      &amp;quot;How many go-micro requests processed, partitioned by method and status&amp;quot;,
					},
					[]string{&amp;quot;path&amp;quot;, &amp;quot;method&amp;quot;, &amp;quot;code&amp;quot;},
				)

				timeCounterSummary := prometheus.NewSummaryVec(
					prometheus.SummaryOpts{
						Namespace: &amp;quot;micro&amp;quot;,
						Name:      &amp;quot;upstream_latency_microseconds&amp;quot;,
						Help:      &amp;quot;Service backend method request latencies in microseconds&amp;quot;,
					},
					[]string{&amp;quot;path&amp;quot;, &amp;quot;method&amp;quot;},
				)

				timeCounterHistogram := prometheus.NewHistogramVec(
					prometheus.HistogramOpts{
						Namespace: &amp;quot;micro&amp;quot;,
						Name:      &amp;quot;request_duration_seconds&amp;quot;,
						Help:      &amp;quot;Service method request time in seconds&amp;quot;,
					},
					[]string{&amp;quot;path&amp;quot;, &amp;quot;method&amp;quot;},
				)

				reg := prometheus.NewRegistry()
				wrapreg := prometheus.WrapRegistererWith(md, reg)
				wrapreg.MustRegister(
					opsCounter,
					timeCounterSummary,
					timeCounterHistogram,
				)

				prometheus.DefaultGatherer = reg
				prometheus.DefaultRegisterer = wrapreg

				return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
					// æ‹¦æˆªmetrics pathï¼Œé»˜è®¤&amp;quot;/metrics&amp;quot;
					if r.URL.Path == &amp;quot;/metrics&amp;quot; {
						promhttp.Handler().ServeHTTP(w, r)
						return
					}

					path := r.URL.Path
					method := r.Method
					timer := prometheus.NewTimer(prometheus.ObserverFunc(func(v float64) {
						us := v * 1000000 // make microseconds
						timeCounterSummary.WithLabelValues(path, method).Observe(us)
						timeCounterHistogram.WithLabelValues(path, method).Observe(v)
					}))
					defer timer.ObserveDuration()

					ww := wrapWriter{ResponseWriter: w}
					h.ServeHTTP(&amp;amp;ww, r)
					log.Logf(&amp;quot;statusCode: %d, %s&amp;quot;, ww.StatusCode, strconv.Itoa(ww.StatusCode))
					opsCounter.WithLabelValues(path, method, strconv.Itoa(ww.StatusCode)).Inc()
				})
			}),
	))

}

type wrapWriter struct {
	StatusCode int
	http.ResponseWriter
}

func (ww *wrapWriter) WriteHeader(statusCode int) {
	log.Logf(&amp;quot;statusCode: %d&amp;quot;, statusCode)
	ww.StatusCode = statusCode
	ww.ResponseWriter.WriteHeader(statusCode)
}
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>ã€æœåŠ¡ç½‘æ ¼-gRPCã€‘ç½‘å…³grpc-gateway</title>
      <link>http://hbchen.com/post/servicemesh/2019-08-30-mesh-grpc-01/</link>
      <pubDate>Fri, 30 Aug 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/servicemesh/2019-08-30-mesh-grpc-01/</guid>
      
        <description>&lt;p&gt;åœ¨ç½‘æ ¼ä¸­ä½¿ç”¨&lt;code&gt;gRPC&lt;/code&gt;å¯ä»¥æ–¹ä¾¿çš„å®šä¹‰æœåŠ¡ï¼Œè€Œå½“éœ€è¦å¯¹å¤–æä¾›æœåŠ¡æ—¶å¾€å¾€&lt;code&gt;HTTP&lt;/code&gt;æ¥å£æ¯”è¾ƒæ™®éï¼Œ&lt;code&gt;grpc-gateway&lt;/code&gt;æä¾›äº†&lt;code&gt;RESTful JSON API&lt;/code&gt;è½¬&lt;code&gt;gRPC&lt;/code&gt;çš„ä»£ç†æœåŠ¡ã€‚
åœ¨&lt;code&gt;mesh&lt;/code&gt;ä¸­&lt;code&gt;grpc-gateway&lt;/code&gt;çš„è§’è‰²æ›´åƒä¸€ä¸ª&lt;strong&gt;æœåŠ¡èšåˆå±‚&lt;/strong&gt;ï¼Œå°†å†…éƒ¨&lt;code&gt;gRPC&lt;/code&gt;æœåŠ¡èšåˆå¹¶æä¾›&lt;code&gt;HTTP&lt;/code&gt;æ¥å£æœåŠ¡ï¼Œåœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ä¹Ÿé‡åˆ°äº›é—®é¢˜ï¼Œå¦‚ï¼šè¿›ç¨‹å†…è·¯ç”±ã€Headeræ˜ å°„ç­‰ï¼Œè¿™é‡Œç»“åˆä½¿ç”¨ç»éªŒåšä¸ªæ€»ç»“ã€‚&lt;/p&gt;

&lt;h1 id=&#34;æ¥å£å®šä¹‰&#34;&gt;æ¥å£å®šä¹‰&lt;/h1&gt;

&lt;p&gt;&lt;code&gt;gRPC&lt;/code&gt;çš„æœåŠ¡å®šä¹‰è¿™é‡Œä¸åšè¿‡å¤šå…³è”ä»‹ç»ï¼Œ&lt;code&gt;grpc-gateway&lt;/code&gt;åè®®æ”¯æŒä¸¤ç§æ–¹å¼æ·»åŠ ï¼Œä¸€æ˜¯åœ¨&lt;code&gt;.proto&lt;/code&gt;çš„æœåŠ¡å®šä¹‰ä¸­ä»¥&lt;code&gt;option&lt;/code&gt;çš„æ–¹å¼ç›´æ¥ç»‘å®šï¼›
äºŒæ˜¯ä½¿ç”¨å•ç‹¬çš„&lt;code&gt;.yaml&lt;/code&gt;æ–‡ä»¶å®šä¹‰ã€‚æ¥å£å®šä¹‰éµå¾ª&lt;a href=&#34;https://cloud.google.com/service-infrastructure/docs/service-management/reference/rpc/google.api#http&#34;&gt;google.api&lt;/a&gt;å¤§å®¶å¯ä»¥å‚è€ƒï¼Œ
ä¸»è¦å†…å®¹åœ¨&lt;code&gt;HttpRule&lt;/code&gt;ï¼Œå…·ä½“å­—æ®µå‚è€ƒåè®®&lt;a href=&#34;https://github.com/googleapis/googleapis/blob/master/google/api/http.proto&#34;&gt;http.proto&lt;/a&gt;æ›´æ¸…æ™°ï¼Œ
æ¯”å¦‚:&lt;code&gt;response_body&lt;/code&gt;åœ¨æ–‡æ¡£ä¸­å¹¶æ²¡æœ‰æåˆ°ï¼Œç”¨äºé€‰æ‹©&lt;code&gt;Response&lt;/code&gt;ç»“æ„çš„æŸä¸€å­—æ®µä½œä¸ºå“åº”å†…å®¹ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;grpc-gateway&lt;/code&gt;æ–‡æ¡£å‚è€ƒ

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://grpc-ecosystem.github.io/grpc-gateway/docs/usage.html&#34;&gt;Usage&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://grpc-ecosystem.github.io/grpc-gateway/docs/grpcapiconfiguration.html&#34;&gt;Usage without annotations (gRPC API Configuration)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;syntax = &amp;quot;proto3&amp;quot;;
package example;

import &amp;quot;google/api/annotations.proto&amp;quot;;

message StringMessage {
    string value = 1;
}

service YourService {
    rpc Echo (StringMessage) returns (StringMessage) {
       option (google.api.http) = {
           post: &amp;quot;/v1/example/echo&amp;quot;
           body: &amp;quot;*&amp;quot;
       };
    }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;type: google.api.Service
config_version: 3

http:
  rules:
  - selector: example.YourService.Echo
    post: /v1/example/echo
    body: &amp;quot;*&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;è¿›ç¨‹å†…è·¯ç”±&#34;&gt;è¿›ç¨‹å†…è·¯ç”±&lt;/h1&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/grpc/grpc-gateway.png&#34; alt=&#34;grpc-gateway&#34; /&gt;
&lt;code&gt;grpc-gateway&lt;/code&gt;çš„ä»£ç†æ–¹å¼æ˜¯&lt;code&gt;gRPC&lt;/code&gt;è¿œç¨‹è°ƒç”¨ï¼Œåœ¨&lt;code&gt;mesh&lt;/code&gt;ä¸­æœ‰å·²ç»æœ‰&lt;code&gt;ingress&lt;/code&gt;ç½‘å…³ï¼Œå¦‚æœç»§ç»­ç”¨&lt;code&gt;rpc&lt;/code&gt;è°ƒç”¨ï¼Œ
å°†åœ¨é“¾è·¯ä¸Šåˆå¢åŠ ä¸€å±‚ç½‘ç»œå¼€é”€&lt;code&gt;ingress -&amp;gt; grpc-gatewap -&amp;gt; grpc server&lt;/code&gt;ï¼Œè€Œæˆ‘ä»¬çš„ä¸»è¦ç›®çš„æ˜¯å°†&lt;code&gt;gRPC&lt;/code&gt;æœåŠ¡æ˜ å°„æˆ&lt;code&gt;HTTP&lt;/code&gt;å¹¶ä¸éœ€è¦å…¶å®ƒèƒ½åŠ›ï¼Œ
æ‰€ä»¥æˆ‘ä»¬æœŸæœ›&lt;code&gt;grpc-gateway&lt;/code&gt;èƒ½å¤Ÿè¿›ç¨‹å°†&lt;code&gt;HTTP&lt;/code&gt;è¯·æ±‚è½¬å‘ç»™&lt;code&gt;gRPC&lt;/code&gt;æœåŠ¡ã€‚&lt;/p&gt;

&lt;p&gt;é’ˆå¯¹è¿™ä¸€éœ€æ±‚éœ€è¦&lt;code&gt;gRPC&lt;/code&gt;æœåŠ¡æ”¯æŒè¿›ç¨‹å†…è°ƒç”¨ï¼Œç¤¾åŒºç°æœ‰çš„æ–¹æ¡ˆæ˜¯&lt;a href=&#34;https://github.com/grpc/grpc-go/tree/master/test/bufconn&#34;&gt;test/bufconn&lt;/a&gt;ï¼Œ
ç¤ºä¾‹å‚è€ƒ&lt;a href=&#34;https://github.com/grpc-ecosystem/grpc-gateway/pull/947#issuecomment-502578553&#34;&gt;grpc-gateway/pull/947&lt;/a&gt;ä¸­çš„è®¨è®ºã€‚
è‡³äºç›´æ¥&lt;strong&gt;è¿›ç¨‹å†…è°ƒ&lt;/strong&gt;&lt;code&gt;Contributor&lt;/code&gt;çš„æœ€æ–°å›å¤æ˜¯8æœˆä»½å¯åŠ¨&lt;a href=&#34;https://github.com/grpc/grpc-go/issues/906#issuecomment-513856927&#34;&gt;grpc-go/issues/906&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;p&gt;å¦ä¸€ä¸ªä¸´æ—¶çš„æ–¹æ¡ˆæ˜¯æˆ‘æäº¤åˆ°&lt;code&gt;grpc-gateway&lt;/code&gt;çš„&lt;code&gt;PR&lt;/code&gt; &lt;a href=&#34;https://github.com/grpc-ecosystem/grpc-gateway/pull/947&#34;&gt;pull/947&lt;/a&gt;ï¼Œå·²ç»&lt;code&gt;merge&lt;/code&gt;åˆ°&lt;code&gt;master&lt;/code&gt;ï¼Œ
ä½†æ­¤æ–¹æ¡ˆä»…æ”¯æŒ&lt;code&gt;Unary&lt;/code&gt;ï¼Œä¸æ”¯æŒ&lt;code&gt;Streaming&lt;/code&gt;ï¼Œä¸è¿‡å¯¹äºç½‘å…³åº”è¯¥èƒ½å¤Ÿæ»¡è¶³å¤§éƒ¨åˆ†åœºæ™¯çš„éœ€æ±‚ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func RegisterXXXHandlerServer(ctx context.Context, mux *runtime.ServeMux, server XXXServer) error
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;headerä¼ é€’&#34;&gt;Headerä¼ é€’&lt;/h1&gt;

&lt;p&gt;åœ¨&lt;code&gt;tracing&lt;/code&gt;ç­‰åœºæ™¯æˆ‘ä»¬å¾€å¾€éœ€è¦å°†&lt;code&gt;Header&lt;/code&gt;ä¿¡æ¯åœ¨æœåŠ¡ä¹‹é—´ä¼ é€’ï¼ŒåŒ…æ‹¬&lt;code&gt;RESTful API&lt;/code&gt;è¯·æ±‚ã€‚é¦–å…ˆ&lt;code&gt;grpc-gateway&lt;/code&gt;çš„&lt;code&gt;NewServeMux()&lt;/code&gt;éœ€è¦&lt;code&gt;runtime.WithMetadata()&lt;/code&gt;Optionï¼Œ
ç­›é€‰&lt;code&gt;HTTP Header&lt;/code&gt;æ˜ å°„ä¸º&lt;code&gt;metadata&lt;/code&gt;ï¼›å…¶æ¬¡å¦‚æœæ˜¯ä½¿ç”¨&lt;a href=&#34;https://github.com/grpc/grpc-go/tree/master/test/bufconn&#34;&gt;test/bufconn&lt;/a&gt;æ–¹æ¡ˆï¼Œ
åœ¨&lt;code&gt;RegisterXXXHandlerFromEndpoint(...,opts []grpc.DialOption)&lt;/code&gt; &lt;code&gt;opts&lt;/code&gt;çš„&lt;code&gt;grpc.WithChainUnaryInterceptor()&lt;/code&gt;ä¸­éœ€è¦å¢åŠ &lt;code&gt;metadata&lt;/code&gt;çš„æ˜ å°„ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;grpc-gateway&lt;/code&gt;çš„å¦ä¸€ä¸ªæ–¹å¼æ˜¯&lt;code&gt;runtime.WithIncomingHeaderMatcher()&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨å¯ä»¥å‚è€ƒæˆ‘çš„&lt;code&gt;metadata&lt;/code&gt;æ’ä»¶&lt;a href=&#34;https://github.com/hb-go/grpc-contrib/tree/master/metadata&#34;&gt;github.com/hb-go/grpc-contrib/metadata&lt;/a&gt;ï¼Œ
æ”¯æŒæŒ‡å®š&lt;strong&gt;Header&lt;/strong&gt;å’Œ&lt;strong&gt;å‰ç¼€åŒ¹é…&lt;/strong&gt;ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;hb-go/grpc-contrib/metadata&lt;/code&gt;ç¤ºä¾‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;mux := runtime.NewServeMux(
    runtime.WithMetadata(metadata.GatewayMetadataAnnotator(
        metadata.WithHeader(&amp;quot;x-request-id&amp;quot;),
        metadata.WithPrefix(&amp;quot;x-prefix&amp;quot;),
    )),
)
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;err := pb.RegisterXXXHandlerFromEndpoint(ctx, mux, &amp;quot;&amp;quot;,
    []grpc.DialOption{
        grpc.WithChainUnaryInterceptor(
            metadata.UnaryClientInterceptor(
                metadata.WithHeader(&amp;quot;x-request-id&amp;quot;),
                metadata.WithPrefix(&amp;quot;x-prefix&amp;quot;),
            ),
        ),
    },
)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;Istio&lt;/code&gt;ç¯å¢ƒè¦å®Œæ•´&lt;code&gt;tracing&lt;/code&gt;é“¾è·¯ï¼Œ&lt;code&gt;ClientConn&lt;/code&gt;éœ€è¦ä¸&lt;code&gt;grpc-gateway&lt;/code&gt;ä¸€æ ·ï¼Œåœ¨&lt;code&gt;DialOption&lt;/code&gt;çš„&lt;code&gt;grpc.WithChainUnaryInterceptor()&lt;/code&gt;ä¸­åŠ å…¥&lt;code&gt;metadata.UnaryClientInterceptor(...)&lt;/code&gt;ï¼Œ
&lt;code&gt;Header&lt;/code&gt;è¯´æ˜å‚è€ƒ&lt;code&gt;Istio&lt;/code&gt;æ–‡æ¡£&lt;a href=&#34;https://istio.io/faq/distributed-tracing/#how-to-support-tracing&#34;&gt;WHAT IS REQUIRED FOR DISTRIBUTED TRACING WITH ISTIO?&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;metadata.WithHeader(&amp;quot;x-request-id&amp;quot;),
metadata.WithHeader(&amp;quot;x-b3-traceid&amp;quot;),
metadata.WithHeader(&amp;quot;x-b3-spanid&amp;quot;),
metadata.WithHeader(&amp;quot;x-b3-parentspanid&amp;quot;),
metadata.WithHeader(&amp;quot;x-b3-sampled&amp;quot;),
metadata.WithHeader(&amp;quot;x-b3-flags&amp;quot;),
metadata.WithHeader(&amp;quot;b3&amp;quot;),
metadata.WithHeader(&amp;quot;x-ot-span-context&amp;quot;),
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;TODO&lt;/p&gt;

&lt;h1 id=&#34;å‚æ•°æ˜ å°„&#34;&gt;å‚æ•°æ˜ å°„&lt;/h1&gt;

&lt;ul&gt;
&lt;li&gt;body&lt;/li&gt;
&lt;li&gt;path&lt;/li&gt;
&lt;li&gt;queue&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;</description>
      
    </item>
    
    <item>
      <title>ã€go-microã€‘ä½¿ç”¨kubernetesæ³¨å†Œä¸­å¿ƒ</title>
      <link>http://hbchen.com/post/microservice/2019-06-27-go-micro-use-kubernetes-registry/</link>
      <pubDate>Thu, 27 Jun 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/microservice/2019-06-27-go-micro-use-kubernetes-registry/</guid>
      
        <description>&lt;p&gt;&lt;code&gt;go-micro&lt;/code&gt;éƒ¨ç½²åˆ°&lt;code&gt;kubernetes&lt;/code&gt;ç¯å¢ƒï¼Œå¯ä»¥é€‰æ‹©&lt;code&gt;kubernetes&lt;/code&gt;æ³¨å†Œä¸­å¿ƒæ’ä»¶ï¼Œå‡å°‘ç»„ä»¶ä¾èµ–ç®€åŒ–è¿ç»´ã€‚&lt;/p&gt;

&lt;h1 id=&#34;ä¸»è¦å·¥ä½œ&#34;&gt;ä¸»è¦å·¥ä½œ&lt;/h1&gt;

&lt;blockquote&gt;
&lt;p&gt;éƒ¨ç½²ç¤ºä¾‹&lt;a href=&#34;https://github.com/hb-go/micro/tree/master/k8s&#34;&gt;hb-go/micro&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;micro&lt;/code&gt;é€‰æ‹©è‡ªå·±ç¼–è¯‘ï¼Œè€Œä¸æ˜¯ç›´æ¥&lt;code&gt;go get -u github.com/micro/micro&lt;/code&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;è‡ªå®šä¹‰é€‰æ‹©æ’ä»¶çš„æ”¯æŒ&lt;/li&gt;
&lt;li&gt;è‡ªå·±å‘å¸ƒé•œåƒï¼Œå®˜æ–¹&lt;code&gt;microhq/micro&lt;/code&gt;ä¸Šçš„é•œåƒæ²¡æœ‰ç‰ˆæœ¬ï¼Œå®¹æ˜“å‡ºç°å…¼å®¹é—®é¢˜&lt;/li&gt;
&lt;li&gt;å¦å¤–éå¸¸é‡è¦çš„ä¸€ç‚¹&lt;strong&gt;ä¿è¯æœ¬åœ°ä¸çº¿ä¸Š&lt;code&gt;micro&lt;/code&gt;çš„ä¸€è‡´&lt;/strong&gt;ï¼Œåªéœ€è¦æ›¿æ¢æ³¨å†Œä¸­å¿ƒ&lt;code&gt;--registry=kubernetes&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;code&gt;go build&lt;/code&gt;æ‰“åŒ…æœåŠ¡æ—¶å¢åŠ &lt;code&gt;kubernetes&lt;/code&gt;æ’ä»¶&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;import (
	_ &amp;quot;github.com/micro/go-plugins/registry/kubernetes&amp;quot;
)
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&#34;rbacé—®é¢˜&#34;&gt;RBACé—®é¢˜&lt;/h1&gt;

&lt;p&gt;å¦‚æœ&lt;code&gt;kubernetes&lt;/code&gt;å¼€å¯äº†&lt;code&gt;RBAC&lt;/code&gt;ï¼Œåœ¨éƒ¨ç½²æœåŠ¡æ—¶éœ€è¦é…ç½®&lt;code&gt;RBAC&lt;/code&gt;ï¼ŒåŒ…æ‹¬&lt;code&gt;micro web&lt;/code&gt;ã€&lt;code&gt;micro api&lt;/code&gt;æœåŠ¡ï¼Œå¦åˆ™æœåŠ¡æ³¨å†Œ/å‘ç°å°†å¤±è´¥&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;2019/06/27 12:54:13 K8s: request failed with code 403
2019/06/27 12:54:13 K8s: request failed with body:
2019/06/27 12:54:13 {&amp;quot;kind&amp;quot;:&amp;quot;Status&amp;quot;,&amp;quot;apiVersion&amp;quot;:&amp;quot;v1&amp;quot;,&amp;quot;metadata&amp;quot;:{},&amp;quot;status&amp;quot;:&amp;quot;Failure&amp;quot;,&amp;quot;message&amp;quot;:&amp;quot;pods \&amp;quot;micro-web-79545546b4-p5vbt\&amp;quot; is forbidden: User \&amp;quot;system:serviceaccount:default:default\&amp;quot; cannot patch resource \&amp;quot;pods\&amp;quot; in API group \&amp;quot;\&amp;quot; in the namespace \&amp;quot;default\&amp;quot;&amp;quot;,&amp;quot;reason&amp;quot;:&amp;quot;Forbidden&amp;quot;,&amp;quot;details&amp;quot;:{&amp;quot;name&amp;quot;:&amp;quot;micro-web-79545546b4-p5vbt&amp;quot;,&amp;quot;kind&amp;quot;:&amp;quot;pods&amp;quot;},&amp;quot;code&amp;quot;:403}
2019/06/27 12:54:13 Server register error: K8s: error
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;rbac-yaml&#34;&gt;RBAC yaml&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: v1
kind: ServiceAccount
metadata:
  name: micro-services
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: micro-registry
rules:
- apiGroups:
  - &amp;quot;&amp;quot;
  resources:
  - pods
  verbs:
  - list
  - patch
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: micro-registry
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: micro-registry
subjects:
- kind: ServiceAccount
  name: micro-services
  namespace: default
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æœåŠ¡æŒ‡å®šservice-account&#34;&gt;æœåŠ¡æŒ‡å®šService Account&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  namespace: default
  name: micro-api
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: micro-api
    spec:
+     serviceAccountName: micro-services
      containers:
      - name: api
        command: [
          &amp;quot;/micro&amp;quot;,
          &amp;quot;--registry=kubernetes&amp;quot;,
          &amp;quot;--server=rpc&amp;quot;,
          &amp;quot;--broker=http&amp;quot;,
          &amp;quot;--transport=http&amp;quot;,
          &amp;quot;--register_ttl=60&amp;quot;,
          &amp;quot;--register_interval=30&amp;quot;,
          &amp;quot;--selector=cache&amp;quot;,
          &amp;quot;--enable_stats&amp;quot;,
          &amp;quot;api&amp;quot;
        ]
        image: hbchen/micro:k8s
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
          name: api-port
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>ã€go-microã€‘æœåŠ¡é—´é€šä¿¡æ’ä»¶Benchmark</title>
      <link>http://hbchen.com/post/microservice/2019-05-31-go-micro-benchmark/</link>
      <pubDate>Fri, 31 May 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/microservice/2019-05-31-go-micro-benchmark/</guid>
      
        <description>&lt;p&gt;æµ‹è¯•å½±å“&lt;code&gt;go-micro&lt;/code&gt;æœåŠ¡é—´é€šä¿¡æ•ˆç‡çš„ä¸‰ä¸ªç»„ä»¶ï¼š&lt;code&gt;transport&lt;/code&gt;ã€&lt;code&gt;server&lt;/code&gt;ä»¥åŠ&lt;code&gt;codec&lt;/code&gt;ï¼Œä¸»è¦åšä¸åŒæ’ä»¶é—´çš„æ¨ªå‘å¯¹æ¯”ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;æºç &lt;a href=&#34;https://github.com/hb-go/micro/tree/master/benchmark&#34;&gt;github.com/hb-go/micro/benchmark&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;strong&gt;æµ‹è¯•ç¯å¢ƒ&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;MBP&lt;/li&gt;
&lt;li&gt;go &lt;strong&gt;1.12.5&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;go-micro &lt;strong&gt;v1.2.0&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;go-plugins &lt;strong&gt;v1.1.0&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;transport-serverå¯¹æ¯”&#34;&gt;Transport + Serverå¯¹æ¯”&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;transport&lt;/code&gt;å’Œ&lt;code&gt;server&lt;/code&gt;çš„å¯¹æ¯”ä½¿ç”¨&lt;code&gt;100&lt;/code&gt;å¹¶å‘ï¼Œå®Œæˆ&lt;code&gt;10W&lt;/code&gt;è¯·æ±‚è¿›è¡Œæµ‹è¯•&lt;/p&gt;

&lt;h3 id=&#34;ç»“æœå¯¹æ¯”&#34;&gt;ç»“æœå¯¹æ¯”&lt;/h3&gt;

&lt;p&gt;ä»ç»“æœçœ‹&lt;code&gt;tcp&lt;/code&gt;+&lt;code&gt;rpc&lt;/code&gt;ååé‡æœ€é«˜ï¼Œåˆ†åˆ«æ¯”è¾ƒï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;transport&lt;/code&gt;æ¯”è¾ƒç»“æœ&lt;code&gt;tcp&lt;/code&gt;&amp;gt;&lt;code&gt;grpc&lt;/code&gt;&amp;gt;&lt;code&gt;utp&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;server&lt;/code&gt;æ¯”è¾ƒç»“æœå¤§è‡´ä¸º&lt;code&gt;rpc&lt;/code&gt;&amp;gt;&lt;code&gt;grpc&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;T+S&lt;/th&gt;
&lt;th&gt;å¹³å‡&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;ä¸­ä½&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;æœ€å¤§&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;æœ€å°&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;P90&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;P99&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;TPS&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;tcp+rpc&lt;/td&gt;
&lt;td&gt;7.236&lt;/td&gt;
&lt;td&gt;5.629&lt;/td&gt;
&lt;td&gt;101.506&lt;/td&gt;
&lt;td&gt;0.177&lt;/td&gt;
&lt;td&gt;13.338&lt;/td&gt;
&lt;td&gt;35.880&lt;/td&gt;
&lt;td&gt;13192&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;grpc+rpc&lt;/td&gt;
&lt;td&gt;8.668&lt;/td&gt;
&lt;td&gt;7.964&lt;/td&gt;
&lt;td&gt;101.280&lt;/td&gt;
&lt;td&gt;0.251&lt;/td&gt;
&lt;td&gt;12.744&lt;/td&gt;
&lt;td&gt;21.672&lt;/td&gt;
&lt;td&gt;11166&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;utp+rpc&lt;/td&gt;
&lt;td&gt;11.824&lt;/td&gt;
&lt;td&gt;11.600&lt;/td&gt;
&lt;td&gt;53.183&lt;/td&gt;
&lt;td&gt;0.204&lt;/td&gt;
&lt;td&gt;15.575&lt;/td&gt;
&lt;td&gt;21.334&lt;/td&gt;
&lt;td&gt;8252&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;grpc+grpc&lt;/td&gt;
&lt;td&gt;8.924&lt;/td&gt;
&lt;td&gt;8.181&lt;/td&gt;
&lt;td&gt;134.434&lt;/td&gt;
&lt;td&gt;0.286&lt;/td&gt;
&lt;td&gt;13.211&lt;/td&gt;
&lt;td&gt;22.973&lt;/td&gt;
&lt;td&gt;10845&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;blockquote&gt;
&lt;p&gt;åœ¨å¼€å§‹çš„æµ‹è¯•ä¸­æœ‰ä¸ªè¯¯åŒºï¼Œ&lt;code&gt;grpc&lt;/code&gt;æœåŠ¡å¹¶ä¸ä½¿ç”¨&lt;code&gt;transport&lt;/code&gt;ï¼ŒåŒ…æ‹¬&lt;code&gt;http&lt;/code&gt;æœåŠ¡ï¼Œ&lt;code&gt;transport&lt;/code&gt;ä»…åœ¨ä½¿ç”¨&lt;code&gt;go-micro&lt;/code&gt;çš„&lt;code&gt;rpc&lt;/code&gt;æœåŠ¡æ—¶æœ‰æ•ˆ&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;codecå¯¹æ¯”&#34;&gt;Codecå¯¹æ¯”&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;transport&lt;/code&gt;å’Œ&lt;code&gt;server&lt;/code&gt;åˆ†åˆ«ä½¿ç”¨&lt;code&gt;tcp&lt;/code&gt;å’Œ&lt;code&gt;rpc&lt;/code&gt;å¯¹æ¯”ä¸åŒ&lt;code&gt;codec&lt;/code&gt;æ€§èƒ½ï¼Œå› ä¸ºå¹¶å‘&lt;code&gt;100&lt;/code&gt;æ—¶ä¸åŒ&lt;code&gt;codec&lt;/code&gt;çš„å¤±è´¥ç‡å·®åˆ«æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥ä½¿ç”¨&lt;code&gt;50&lt;/code&gt;å¹¶å‘ï¼Œå®Œæˆ&lt;code&gt;10W&lt;/code&gt;è¯·æ±‚è¿›è¡Œæµ‹è¯•&lt;/p&gt;

&lt;h3 id=&#34;ç»“æœå¯¹æ¯”-1&#34;&gt;ç»“æœå¯¹æ¯”&lt;/h3&gt;

&lt;p&gt;å¯¹æ¯”ç»“æœï¼š&lt;code&gt;protobuf&lt;/code&gt;&amp;gt;&lt;code&gt;proto-rpc&lt;/code&gt;&amp;gt;&lt;code&gt;grpc&lt;/code&gt;&amp;gt;&lt;code&gt;json&lt;/code&gt;&amp;gt;&lt;code&gt;grpc+json&lt;/code&gt;&amp;gt;&lt;code&gt;json-rpc&lt;/code&gt;&amp;gt;&lt;code&gt;bsonrpc&lt;/code&gt;&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;CODEC&lt;/th&gt;
&lt;th&gt;å¹³å‡&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;ä¸­ä½&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;æœ€å¤§&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;æœ€å°&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;P90&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;P99&lt;br/&gt;(ms)&lt;/th&gt;
&lt;th&gt;TPS&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;grpc&lt;/td&gt;
&lt;td&gt;3.937&lt;/td&gt;
&lt;td&gt;2.979&lt;/td&gt;
&lt;td&gt;90.004&lt;/td&gt;
&lt;td&gt;0.180&lt;/td&gt;
&lt;td&gt;7.184&lt;/td&gt;
&lt;td&gt;19.355&lt;/td&gt;
&lt;td&gt;12310&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;grpc+json&lt;/td&gt;
&lt;td&gt;6.085&lt;/td&gt;
&lt;td&gt;4.694&lt;/td&gt;
&lt;td&gt;149.861&lt;/td&gt;
&lt;td&gt;0.342&lt;/td&gt;
&lt;td&gt;10.365&lt;/td&gt;
&lt;td&gt;31.837&lt;/td&gt;
&lt;td&gt;8000&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;protobuf&lt;/td&gt;
&lt;td&gt;3.661&lt;/td&gt;
&lt;td&gt;2.707&lt;/td&gt;
&lt;td&gt;96.636&lt;/td&gt;
&lt;td&gt;0.156&lt;/td&gt;
&lt;td&gt;6.542&lt;/td&gt;
&lt;td&gt;20.261&lt;/td&gt;
&lt;td&gt;13150&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;json&lt;/td&gt;
&lt;td&gt;5.402&lt;/td&gt;
&lt;td&gt;4.122&lt;/td&gt;
&lt;td&gt;122.360&lt;/td&gt;
&lt;td&gt;0.225&lt;/td&gt;
&lt;td&gt;9.186&lt;/td&gt;
&lt;td&gt;30.474&lt;/td&gt;
&lt;td&gt;8896&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;json-rpc&lt;/td&gt;
&lt;td&gt;6.380&lt;/td&gt;
&lt;td&gt;4.878&lt;/td&gt;
&lt;td&gt;115.141&lt;/td&gt;
&lt;td&gt;0.288&lt;/td&gt;
&lt;td&gt;11.150&lt;/td&gt;
&lt;td&gt;33.395&lt;/td&gt;
&lt;td&gt;7631&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;proto-rpc&lt;/td&gt;
&lt;td&gt;3.692&lt;/td&gt;
&lt;td&gt;2.729&lt;/td&gt;
&lt;td&gt;101.010&lt;/td&gt;
&lt;td&gt;0.180&lt;/td&gt;
&lt;td&gt;6.701&lt;/td&gt;
&lt;td&gt;19.454&lt;/td&gt;
&lt;td&gt;13041&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;bsonrpc&lt;/td&gt;
&lt;td&gt;7.912&lt;/td&gt;
&lt;td&gt;5.979&lt;/td&gt;
&lt;td&gt;132.041&lt;/td&gt;
&lt;td&gt;0.354&lt;/td&gt;
&lt;td&gt;14.789&lt;/td&gt;
&lt;td&gt;40.414&lt;/td&gt;
&lt;td&gt;6145&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;é»˜è®¤&lt;code&gt;chdec&lt;/code&gt;å¦‚ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;DefaultCodecs = map[string]codec.NewCodec{
    &amp;quot;application/grpc&amp;quot;:         grpc.NewCodec,
    &amp;quot;application/grpc+json&amp;quot;:    grpc.NewCodec,
    &amp;quot;application/grpc+proto&amp;quot;:   grpc.NewCodec,
    &amp;quot;application/json&amp;quot;:         json.NewCodec,
    &amp;quot;application/json-rpc&amp;quot;:     jsonrpc.NewCodec,
    &amp;quot;application/protobuf&amp;quot;:     proto.NewCodec,
    &amp;quot;application/proto-rpc&amp;quot;:    protorpc.NewCodec,
    &amp;quot;application/octet-stream&amp;quot;: raw.NewCodec,
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¦å¤–&lt;code&gt;go-plugins&lt;/code&gt;æä¾›ä¸‰ä¸ª&lt;code&gt;codec&lt;/code&gt;æ’ä»¶ï¼Œåœ¨&lt;code&gt;server&lt;/code&gt;å’Œ&lt;code&gt;client&lt;/code&gt;åˆå§‹åŒ–æ—¶è‡ªå®šä¹‰æ·»åŠ &lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;server.Codec(&amp;quot;application/msgpackrpc&amp;quot;, msgpackrpc.NewCodec),
server.Codec(&amp;quot;application/bsonrpc&amp;quot;, bsonrpc.NewCodec),
server.Codec(&amp;quot;application/jsonrpc2&amp;quot;, jsonrpc2.NewCodec),

client.Codec(&amp;quot;application/msgpackrpc&amp;quot;, msgpackrpc.NewCodec),
client.Codec(&amp;quot;application/bsonrpc&amp;quot;, bsonrpc.NewCodec),
client.Codec(&amp;quot;application/jsonrpc2&amp;quot;, jsonrpc2.NewCodec),
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å®é™…æµ‹è¯•æ—¶ç”±äºä¸åŒåŸå› &lt;code&gt;raw&lt;/code&gt; ã€&lt;code&gt;msgpackrpc&lt;/code&gt;å’Œ&lt;code&gt;jsonrpc2&lt;/code&gt;è¿è¡Œå¤±è´¥æœªæµ‹è¯•ï¼Œ&lt;code&gt;grpc+proto&lt;/code&gt;ä¸&lt;code&gt;grpc&lt;/code&gt;å®ç°ä¸€è‡´æœªæµ‹è¯•&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;raw.NewCodec&lt;br/&gt;error:{&amp;ldquo;id&amp;rdquo;:&amp;ldquo;go.micro.client.codec&amp;rdquo;,&amp;ldquo;code&amp;rdquo;:500,&amp;ldquo;detail&amp;rdquo;:&amp;ldquo;failed to write: field1:â€¦â€¦&lt;br/&gt;
 msgpackrpc.NewCodecï¼Œéœ€è¦å®ç°EncodeMsg(*Writer)&lt;br/&gt;error:{&amp;ldquo;id&amp;rdquo;:&amp;ldquo;go.micro.client.codec&amp;rdquo;,&amp;ldquo;code&amp;rdquo;:500,&amp;ldquo;detail&amp;rdquo;:&amp;ldquo;Not encodable&amp;rdquo;,&amp;ldquo;status&amp;rdquo;:&amp;ldquo;Internal Server Error&amp;rdquo;}&lt;br/&gt;
 jsonrpc2.NewCodec&lt;br/&gt;error:{&amp;ldquo;id&amp;rdquo;:&amp;ldquo;go.micro.client.transport&amp;rdquo;,&amp;ldquo;code&amp;rdquo;:500,&amp;ldquo;detail&amp;rdquo;:&amp;ldquo;EOF&amp;rdquo;,&amp;ldquo;status&amp;rdquo;:&amp;ldquo;Internal Server Error&amp;rdquo;}&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;è¯¦ç»†æ•°æ®&#34;&gt;è¯¦ç»†æ•°æ®&lt;/h2&gt;

&lt;h3 id=&#34;transport-server&#34;&gt;Transport + Server&lt;/h3&gt;

&lt;h4 id=&#34;æµ‹è¯•å‘½ä»¤&#34;&gt;æµ‹è¯•å‘½ä»¤&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ go run server.go
$ go run client.go -c 100 -n 100000
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;tcp + rpc&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 7580
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 99999
throughput (TPS)       : 13192

concurrency mean      median    max         min       p90        p99        TPS
100         7235584ns 5629000ns 101506000ns 177000ns  13338000ns 35880000ns 13192
100         7.236ms   5.629ms   101.506ms   0.177ms   13.338ms   35.880ms   13192

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;grpc + rpc&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 8955
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 99999
throughput (TPS)       : 11166

concurrency mean      median    max         min       p90        p99        TPS
100         8668191ns 7964000ns 101280000ns 251000ns  12744000ns 21672000ns 11166
100         8.668ms   7.964ms   101.280ms   0.251ms   12.744ms   21.672ms   11166
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;utp + rpc&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 12117
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 100000
throughput (TPS)       : 8252

concurrency mean       median     max        min       p90        p99        TPS
100         11823520ns 11600000ns 53183000ns 204000ns  15575000ns 21334000ns 8252
100         11.824ms   11.600ms   53.183ms   0.204ms   15.575ms   21.334ms   8252
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;grpc + gRPC&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 9220
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 99995
throughput (TPS)       : 10845

concurrency mean      median    max         min       p90        p99        TPS
100         8924043ns 8181000ns 134434000ns 286000ns  13211000ns 22973000ns 10845
100         8.924ms   8.181ms   134.434ms   0.286ms   13.211ms   22.973ms   10845
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;codec&#34;&gt;Codec&lt;/h3&gt;

&lt;h4 id=&#34;æµ‹è¯•å‘½ä»¤-1&#34;&gt;æµ‹è¯•å‘½ä»¤&lt;/h4&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cd benchmark/tcp_rpc
$ go run server.go
$ go run client.go -c 50 -n 100000 -ct grpc
$ go run client.go -c 50 -n 100000 -ct grpc+json
$ go run client.go -c 50 -n 100000 -ct protobuf
$ go run client.go -c 50 -n 100000 -ct json
$ go run client.go -c 50 -n 100000 -ct json-rpc
$ go run client.go -c 50 -n 100000 -ct proto-rpc
$ go run client.go -c 50 -n 100000 -ct bsonrpc
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;grpc&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 8123
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 100000
throughput (TPS)       : 12310

concurrency mean      median    max        min       p90       p99        TPS
50          3936652ns 2979000ns 90004000ns 180000ns  7184000ns 19355000ns 12310
50          3.937ms   2.979ms   90.004ms   0.180ms   7.184ms   19.355ms   12310
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;grpc+json&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 12500
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 99961
throughput (TPS)       : 8000

concurrency mean      median    max         min       p90        p99        TPS
50          6084709ns 4694000ns 149861000ns 342000ns  10365000ns 31837000ns 8000
50          6.085ms   4.694ms   149.861ms   0.342ms   10.365ms   31.837ms   8000
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;protobuf&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 7604
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 100000
throughput (TPS)       : 13150

concurrency mean      median    max        min       p90       p99        TPS
50          3660854ns 2707000ns 96636000ns 156000ns  6542000ns 20261000ns 13150
50          3.661ms   2.707ms   96.636ms   0.156ms   6.542ms   20.261ms   13150
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;json&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 11241
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 99922
throughput (TPS)       : 8896

concurrency mean      median    max         min       p90       p99        TPS
50          5401532ns 4121500ns 122360000ns 225000ns  9186000ns 30474000ns 8896
50          5.402ms   4.122ms   122.360ms   0.225ms   9.186ms   30.474ms   8896
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;json-rpc&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 13103
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 99971
throughput (TPS)       : 7631

concurrency mean      median    max         min       p90        p99        TPS
50          6380308ns 4878000ns 115141000ns 288000ns  11150000ns 33395000ns 7631
50          6.380ms   4.878ms   115.141ms   0.288ms   11.150ms   33.395ms   7631
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;proto-rpc&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 7668
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 99998
throughput (TPS)       : 13041

concurrency mean      median    max         min       p90       p99        TPS
50          3692281ns 2729000ns 101010000ns 180000ns  6701000ns 19454000ns 13041
50          3.692ms   2.729ms   101.010ms   0.180ms   6.701ms   19.454ms   13041
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;bsonrpc&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;took       (ms)        : 16272
sent       requests    : 100000
received   requests    : 100000
received   requests_OK : 99933
throughput (TPS)       : 6145

concurrency mean      median    max         min       p90        p99        TPS
50          7911887ns 5979000ns 132041000ns 354000ns  14789000ns 40414000ns 6145
50          7.912ms   5.979ms   132.041ms   0.354ms   14.789ms   40.414ms   6145
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Istioå®‰å…¨ã€‘ç½‘æ ¼è¾¹ç¼˜-Ingress</title>
      <link>http://hbchen.com/post/servicemesh/2019-05-11-istio-security-ingress/</link>
      <pubDate>Sat, 11 May 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/servicemesh/2019-05-11-istio-security-ingress/</guid>
      
        <description>&lt;p&gt;æ¥&lt;a href=&#34;(/post/servicemesh/2019-04-11-istio-security-egress/)&#34;&gt;ã€Istioå®‰å…¨ã€‘ç½‘æ ¼è¾¹ç¼˜-Egress&lt;/a&gt;ç»§ç»­ç½‘æ ¼è¾¹ç¼˜çš„å®è·µ&lt;code&gt;ingress-gateway&lt;/code&gt;ï¼Œ
åˆ†ä¸º&lt;strong&gt;HTTP&lt;/strong&gt;ã€&lt;strong&gt;HTTPS-ä¸ç»ˆæ­¢TLS&lt;/strong&gt;å’Œ&lt;strong&gt;HTTPS-ç§å­TLS&lt;/strong&gt;ä¸‰ç§åœºæ™¯ã€‚&lt;/p&gt;

&lt;h2 id=&#34;å‡†å¤‡å·¥ä½œ&#34;&gt;å‡†å¤‡å·¥ä½œ&lt;/h2&gt;

&lt;p&gt;æœ‰äº†&lt;a href=&#34;http://hbchen.com/post/servicemesh/2019-04-11-istio-security-egress/&#34;&gt;Egress&lt;/a&gt;çš„å®è·µï¼Œè¿™é‡Œä¸ä½¿ç”¨&lt;code&gt;httpbin&lt;/code&gt;åšå†…éƒ¨æœåŠ¡ï¼Œè€Œæ˜¯ç”¨&lt;code&gt;egress-gateway&lt;/code&gt;çš„æˆæœï¼Œ
&lt;code&gt;www.aliyun.com&lt;/code&gt;å’Œ&lt;code&gt;hbchen.com&lt;/code&gt;çš„ä¸¤ä¸ªå¤–éƒ¨æœåŠ¡è¿›è¡Œæµ‹è¯•ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;$ kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: entry-x
spec:
  hosts:
  - www.aliyun.com
  - hbchen.com
  ports:
  - number: 80
    name: http
    protocol: HTTP
  resolution: NONE
EOF

$ kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: originate-tls-for-aliyun
spec:
  host: www.aliyun.com
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
  subsets:
    - name: originate-tls
      trafficPolicy:
        loadBalancer:
          simple: ROUND_ROBIN
        portLevelSettings:
        - port:
            number: 443
          tls:
            mode: SIMPLE
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;ç¯å¢ƒå˜é‡&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=&#39;{.spec.ports[?(@.name==&amp;quot;http2&amp;quot;)].nodePort}&#39;)
export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=&#39;{.spec.ports[?(@.name==&amp;quot;https&amp;quot;)].nodePort}&#39;)

export INGRESS_HOST=$(minikube ip)
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;æ¥ä¸‹æ¥è¿›å…¥æ­£æ–‡&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;éƒ½åªéœ€è¦å®šä¹‰ä¸¤ä¸ª&lt;code&gt;.yaml&lt;/code&gt;é…ç½®:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Gateway&lt;/strong&gt;:&lt;code&gt;ingress-example-gateway&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;VirtualService&lt;/strong&gt;:&lt;code&gt;ingress-example-svc&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;http-gateway&#34;&gt;Http Gateway&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/istio/ingress-http.png&#34; alt=&#34;ServiceEntry&#34; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å®˜æ–¹æ–‡æ¡£&lt;a href=&#34;https://istio.io/zh/docs/tasks/traffic-management/ingress/&#34;&gt;æ§åˆ¶ Ingress æµé‡&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: ingress-example-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: http
    hosts:
    - &amp;quot;hbchen.com&amp;quot;
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ingress-example-svc
spec:
  hosts:
  - &amp;quot;hbchen.com&amp;quot;
  gateways:
  - ingress-example-gateway
  http:
  - match:
    - port: 80
    route:
    - destination:
        host: hbchen.com
        port:
          number: 80
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;curl -I -v -HHost:hbchen.com http://$INGRESS_HOST:$INGRESS_PORT
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;https-gateway-ä¸ç»ˆæ­¢-tls&#34;&gt;Https Gateway-ä¸ç»ˆæ­¢&lt;code&gt;TLS&lt;/code&gt;&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/istio/ingress-https-passthrough.png&#34; alt=&#34;ServiceEntry&#34; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å®˜æ–¹æ–‡æ¡£&lt;a href=&#34;https://istio.io/zh/docs/examples/advanced-gateways/ingress-sni-passthrough/&#34;&gt;æ²¡æœ‰ TLS çš„ Ingress gateway&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä¸ç»ˆæ­¢&lt;code&gt;TLS&lt;/code&gt;å³é€ä¼ &lt;code&gt;https&lt;/code&gt;è¯·æ±‚åˆ°ç½‘æ ¼å†…æœåŠ¡ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå¤–éƒ¨æœåŠ¡æ¥æ¨¡æ‹Ÿä¸€ä¸ªæ”¯æŒ&lt;code&gt;https&lt;/code&gt;çš„æœåŠ¡&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: ingress-example-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: http
    hosts:
    - &amp;quot;www.aliyun.com&amp;quot;
  - port:
      number: 443
      name: https
      protocol: HTTPS
    tls:
      mode: PASSTHROUGH
    hosts:
    - &amp;quot;www.aliyun.com&amp;quot;
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ingress-example-svc
spec:
  hosts:
  - &amp;quot;www.aliyun.com&amp;quot;
  gateways:
  - ingress-example-gateway
  http:
  - match:
    - port: 80
    route:
    - destination:
        host: www.aliyun.com
        subset: originate-tls
        port:
          number: 443
  tls:
  - match:
    - port: 443
      sni_hosts:
      - www.aliyun.com
    route:
    - destination:
        host: www.aliyun.com
        port:
          number: 443
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;curl -I -v -HHost:www.aliyun.com http://$INGRESS_HOST:$INGRESS_PORT
curl -I -v --resolve www.aliyun.com:$SECURE_INGRESS_PORT:$INGRESS_HOST https://www.aliyun.com:$SECURE_INGRESS_PORT
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;https-gateway-ç»ˆæ­¢-tls&#34;&gt;Https Gateway-ç»ˆæ­¢&lt;code&gt;TLS&lt;/code&gt;&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/istio/ingress-https.png&#34; alt=&#34;ServiceEntry&#34; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å®˜æ–¹æ–‡æ¡£&lt;a href=&#34;https://istio.io/zh/docs/tasks/traffic-management/secure-ingress/sds/&#34;&gt;ä½¿ç”¨ SDS ä¸º Gateway æä¾› HTTPS åŠ å¯†æ”¯æŒ&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ç»ˆæ­¢&lt;code&gt;TLS&lt;/code&gt;å³ç”±&lt;code&gt;ingress-gateway&lt;/code&gt;æä¾›&lt;code&gt;https&lt;/code&gt;æœåŠ¡ï¼Œæ›´ç¬¦åˆ&lt;code&gt;ingress-gateway&lt;/code&gt;ä½œä¸ºç½‘æ ¼ç»Ÿä¸€å…¥å£çš„éœ€æ±‚&lt;/p&gt;

&lt;h3 id=&#34;å¯ç”¨sds&#34;&gt;å¯ç”¨SDS&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;SDS&lt;/code&gt;é»˜è®¤æ˜¯å…³é—­çš„ï¼Œæ‰€ä»¥é¦–å…ˆéœ€è¦å¼€å¯&lt;code&gt;ingress-gateway&lt;/code&gt;çš„&lt;code&gt;SDS&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cd istio/path 

# ç”Ÿæˆ.yaml
$ helm template install/kubernetes/helm/istio/ --name istio \
--namespace istio-system -x charts/gateways/templates/deployment.yaml \
--set gateways.istio-egressgateway.enabled=false \
--set gateways.istio-ingressgateway.sds.enabled=true &amp;gt; \
$HOME/istio-ingressgateway.yaml

# é‡æ–°éƒ¨ç½²
$ kubectl apply -f $HOME/istio-ingressgateway.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;ç”Ÿæˆè¯ä¹¦&#34;&gt;ç”Ÿæˆè¯ä¹¦&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ git clone https://github.com/nicholasjackson/mtls-go-example

$ cd mtls-go-example
$ ./generate.sh hbchen.com 123456

$ mkdir ./../hbchen.com &amp;amp;&amp;amp; mv 1_root 2_intermediate 3_application 4_client ./../hbchen.com
$ cd ..
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;åˆ›å»º-secret&#34;&gt;åˆ›å»º&lt;code&gt;Secret&lt;/code&gt;&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl create -n istio-system secret generic hbchen-credential \
--from-file=key=hbchen.com/3_application/private/hbchen.com.key.pem \
--from-file=cert=hbchen.com/3_application/certs/hbchen.com.cert.pem
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: ingress-example-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 443
      name: https
      protocol: HTTPS
    tls:
      mode: SIMPLE
      credentialName: &amp;quot;hbchen-credential&amp;quot; # NOTE: å’Œ Secret åç§°ä¸€è‡´
    hosts:
    - &amp;quot;hbchen.com&amp;quot;
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: ingress-example-svc
spec:
  hosts:
  - &amp;quot;hbchen.com&amp;quot;
  gateways:
  - ingress-example-gateway
  http:
  - match:
    - port: 443
    route:
    - destination:
        host: hbchen.com
        port:
          number: 80
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;curl -I -v -HHost:hbchen.com \
--resolve hbchen.com:$SECURE_INGRESS_PORT:$INGRESS_HOST \
--cacert hbchen.com/2_intermediate/certs/ca-chain.cert.pem \
https://hbchen.com:$SECURE_INGRESS_PORT
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;todo&#34;&gt;TODO&lt;/h2&gt;

&lt;h3 id=&#34;jwt&#34;&gt;JWT&lt;/h3&gt;

&lt;h3 id=&#34;authn&#34;&gt;Authn&lt;/h3&gt;</description>
      
    </item>
    
    <item>
      <title>åˆ†å¸ƒå¼ç³»ç»Ÿé™æµæœåŠ¡-Golang&amp;Redis</title>
      <link>http://hbchen.com/post/distributed/2019-05-05-rate-limit/</link>
      <pubDate>Sun, 05 May 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/distributed/2019-05-05-rate-limit/</guid>
      
        <description>&lt;p&gt;æœ¬æ–‡å‚è€ƒä¸¤ä¸ªä½¿ç”¨Redisåšé™æµçš„é¡¹ç›®ï¼Œåˆ†æåˆ†å¸ƒå¼ç³»ç»Ÿé™æµæœåŠ¡çš„å®ç°ï¼ŒåŒ…æ‹¬å›ºå®šçª—å£ä»¥åŠæ»šåŠ¨çª—å£çš„é™æµã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;å‚è€ƒé¡¹ç›®&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Istioé¡¹ç›®&lt;code&gt;mixer&lt;/code&gt;æ¨¡å—çš„&lt;a href=&#34;https://github.com/istio/istio/tree/master/mixer/adapter/redisquota&#34;&gt;adapter/redisquota&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/go-redis/redis_rate&#34;&gt;go-redis/redis_rate&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;å›ºå®šçª—å£&#34;&gt;å›ºå®šçª—å£&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/distributed/rate-window-fixed.png&#34; alt=&#34;fixed-window&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;go-redis-redis-rate&#34;&gt;go-redis/redis_rate&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;redis_rate&lt;/code&gt;ä½¿ç”¨&lt;strong&gt;çª—å£æ ‡è¯†&lt;/strong&gt;åš&lt;code&gt;key&lt;/code&gt;çš„å­—ç¬¦ä¸²ï¼Œç”¨&lt;code&gt;INCRBY&lt;/code&gt;ç»Ÿè®¡çª—å£å·²ä½¿ç”¨æµé‡&lt;code&gt;n&lt;/code&gt;ï¼Œä¸”&lt;code&gt;key&lt;/code&gt;åœ¨æ­¤çª—å£ç»“æŸåè‡ªåŠ¨è¿‡æœŸã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;çª—å£æ ‡è¯†&lt;/strong&gt;çš„ç”Ÿæˆï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;slot&lt;/code&gt; = &lt;code&gt;utime&lt;/code&gt;(&lt;em&gt;æ—¶é—´æˆ³&lt;code&gt;s&lt;/code&gt;&lt;/em&gt;)â—&lt;code&gt;udur&lt;/code&gt;(&lt;em&gt;çª—å£å¤§å°&lt;code&gt;s&lt;/code&gt;ï¼Œ&lt;code&gt;dur â‰¥ 1s&lt;/code&gt;&lt;/em&gt;)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;key&lt;/code&gt; = &lt;code&gt;name&lt;/code&gt; + &lt;code&gt;slot&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;utime&lt;/code&gt;ä¸ç³»ç»Ÿæ—¶é’Ÿç›¸å…³ï¼Œè€ƒè™‘ä¸€ç§è¾ƒä¸ºæç«¯çš„æƒ…å†µï¼Œçª—å£å¤§å°&lt;code&gt;1s&lt;/code&gt;ï¼Œ&lt;code&gt;A&lt;/code&gt;ã€&lt;code&gt;B&lt;/code&gt;ä¸¤ä¸ªç³»ç»Ÿæ—¶é’Ÿå·®&lt;code&gt;2s&lt;/code&gt;ï¼Œè€Œ&lt;code&gt;key&lt;/code&gt;çš„è¿‡æœŸæ—¶é—´ä¸çª—å£å¤§å°ç›¸åŒ&lt;code&gt;1s&lt;/code&gt;ï¼Œ
å‡è®¾&lt;code&gt;key&lt;/code&gt;åœ¨çª—å£æœ€åæœ‰æ›´æ–°åˆ™&lt;code&gt;key&lt;/code&gt;çš„ç”Ÿå­˜å‘¨æœŸæ˜¯&lt;code&gt;2s&lt;/code&gt;ï¼Œè€Œæ°å¥½æ—¶é’Ÿç›¸å·®&lt;code&gt;2s&lt;/code&gt;ï¼Œè¿™æ ·&lt;code&gt;A&lt;/code&gt;ã€&lt;code&gt;B&lt;/code&gt;ç³»ç»Ÿçš„åˆ†å¸ƒå¼é™æµå°±å˜æˆäº†å•æœºé™æµã€‚&lt;br/&gt;
è™½ç„¶æ¯”è¾ƒæç«¯ï¼Œä½†åœ¨ä½¿ç”¨æ—¶è¿˜æ˜¯éœ€è¦æ³¨æ„ï¼Œæ ¹æ®éœ€è¦å¯ä»¥é€‚å½“åŠ å¤§&lt;code&gt;key&lt;/code&gt;çš„è¿‡æœŸæ—¶é—´ï¼ŒåŒæ—¶å­˜æ´»å¤šä¸ªçª—å£ï¼Œä½¿å­˜æ´»çª—å£èŒƒå›´è¦†ç›–ç³»ç»Ÿé—´çš„æ—¶é’Ÿè¯¯å·®ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;func (l *Limiter) AllowN(
	name string, maxn int64, dur time.Duration, n int64,
) (count int64, delay time.Duration, allow bool) {
	udur := int64(dur / time.Second)
	utime := time.Now().Unix()
	slot := utime / udur
	delay = time.Duration((slot+1)*udur-utime) * time.Second

	if l.Fallback != nil {
		allow = l.Fallback.Allow()
	}

	name = allowName(name, slot)
	count, err := l.incr(name, dur, n)
	if err == nil {
		allow = count &amp;lt;= maxn
	}

	return count, delay, allow
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;adapter-redisquota-fixed-window&#34;&gt;adapter/redisquota/fixed_window&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;redisquota&lt;/strong&gt;ä½¿ç”¨&lt;code&gt;lua&lt;/code&gt;è„šæœ¬å®ç°ï¼Œè®¾è®¡ä¸Šä½¿ç”¨ä¸€ä¸ªå¸¦æœ‰&lt;code&gt;token&lt;/code&gt;å’Œ&lt;code&gt;expire&lt;/code&gt;çš„å“ˆå¸Œè¡¨ï¼Œ&lt;code&gt;key&lt;/code&gt;è¿‡æœŸæ—¶é—´ä¸º&lt;code&gt;windowLength&lt;/code&gt;ï¼Œçª—å£åœ¨&lt;code&gt;key&lt;/code&gt;è¿‡æœŸæˆ–&lt;code&gt;timestamp&lt;/code&gt;â‰¥&lt;code&gt;expire&lt;/code&gt;æ—¶é‡ç½®ã€‚
å¦å¤–&lt;code&gt;redisquota&lt;/code&gt;æ ¹æ®åœºæ™¯åšäº†&lt;strong&gt;å¹‚ç­‰&lt;/strong&gt;è®¾è®¡ï¼ŒåŒä¸€&lt;code&gt;deduplicationid&lt;/code&gt;åœ¨çª—å£æœ‰æ•ˆæœŸå†…ä¸ä¼šé‡æ–°åˆ†é…&lt;code&gt;token&lt;/code&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å› ä¸º&lt;code&gt;timestamp&lt;/code&gt;ä¸ç³»ç»Ÿæ—¶é’Ÿç›¸å…³ï¼ŒåŒæ ·å‡è®¾&lt;code&gt;A&lt;/code&gt;ã€&lt;code&gt;B&lt;/code&gt;ä¸¤ä¸ªç³»ç»Ÿæ—¶é’Ÿå·®&lt;code&gt;2s&lt;/code&gt;(&lt;code&gt;A&lt;/code&gt;&amp;gt;&lt;code&gt;B&lt;/code&gt;)ï¼Œçª—å£å¤§å°&lt;code&gt;10s&lt;/code&gt;ï¼Œå¦‚æœçª—å£â‘ ç”±&lt;code&gt;A&lt;/code&gt;ç³»ç»Ÿæ—¶é—´æˆ³è§¦å‘ï¼Œè€Œçª—å£â‘¡ç”±&lt;code&gt;B&lt;/code&gt;ç³»ç»Ÿæ—¶é—´æˆ³è§¦å‘(&lt;code&gt;A&lt;/code&gt;åœ¨å&lt;code&gt;2s&lt;/code&gt;æ²¡æœ‰æµé‡)ï¼Œ
è¿™æ ·â‘ å®é™…çª—å£å¤§å°å°±æ˜¯&lt;code&gt;12s&lt;/code&gt;ï¼Œè¿™æ ·ç»§ç»­åˆ°çª—å£â‘¢ç”±&lt;code&gt;A&lt;/code&gt;ç³»ç»Ÿæ—¶é—´æˆ³è§¦å‘ï¼Œâ‘¡çš„å®é™…çª—å£ä»£é”€å°±æ˜¯&lt;code&gt;8s&lt;/code&gt;ï¼Œæ‰€ä»¥åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹é™æµæ•ˆæœåŒæ ·å—ç³»ç»Ÿæ—¶é’Ÿè¯¯å·®çš„å½±å“ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-lua&#34;&gt;local key_meta = KEYS[1]
-- local key_data = KEYS[2]

local credit = tonumber(ARGV[1])
local windowLength = tonumber(ARGV[2])
-- local bucketLength = tonumber(ARGV[3])
local bestEffort = tonumber(ARGV[4])
local token = tonumber(ARGV[5])
local timestamp = tonumber(ARGV[6])
local deduplicationid = ARGV[7]

-- lookup previous response for the deduplicationid and returns if it is still valid
--------------------------------------------------------------------------------
if (deduplicationid or &#39;&#39;) ~= &#39;&#39; then
    local previous_token = tonumber(redis.call(&amp;quot;HGET&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, &amp;quot;token&amp;quot;))
    local previous_expire = tonumber(redis.call(&amp;quot;HGET&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, &amp;quot;expire&amp;quot;))

    if previous_token and previous_expire then
        if timestamp &amp;lt; previous_expire then
            return {previous_token, previous_expire - timestamp}
        end
    end
end

-- read or initialize meta information
--------------------------------------------------------------------------------
local info_token = tonumber(redis.call(&amp;quot;HGET&amp;quot;, key_meta, &amp;quot;token&amp;quot;))
local info_expire = tonumber(redis.call(&amp;quot;HGET&amp;quot;, key_meta, &amp;quot;expire&amp;quot;))

if (not info_token or not info_expire) or (timestamp &amp;gt;= info_expire) then
    info_token = 0
    info_expire = windowLength + timestamp

    redis.call(&amp;quot;HMSET&amp;quot;, key_meta, &amp;quot;token&amp;quot;, info_token, &amp;quot;expire&amp;quot;, windowLength + timestamp)
    -- set the expiration time for automatic cleanup
    redis.call(&amp;quot;PEXPIRE&amp;quot;, key_meta, windowLength / 1000000)
end

if info_token + token &amp;gt; credit then
    if bestEffort == 1 then
        local exceeded = info_token + token - credit

        if exceeded &amp;lt; token then
            -- return maximum available allocated token
            redis.call(&amp;quot;HMSET&amp;quot;, key_meta, &amp;quot;token&amp;quot;, credit)

            -- save current request and set expiration time for auto cleanup
            if (deduplicationid or &#39;&#39;) ~= &#39;&#39; then
                redis.call(&amp;quot;HMSET&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, &amp;quot;token&amp;quot;, token - exceeded, &amp;quot;expire&amp;quot;, info_expire)
                redis.call(&amp;quot;PEXPIRE&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, math.floor((info_expire - timestamp) / 1000000))
            end

            return {token - exceeded, info_expire - timestamp}
        else
            -- not enough available credit
            return {0, 0}
        end
    else
        -- not enough available credit
        return {0, 0}
    end
else
    -- allocated token
    redis.call(&amp;quot;HMSET&amp;quot;, key_meta, &amp;quot;token&amp;quot;, info_token + token)

    -- save current request and set expiration time for auto cleanup
    if (deduplicationid or &#39;&#39;) ~= &#39;&#39; then
        redis.call(&amp;quot;HMSET&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, &amp;quot;token&amp;quot;, token, &amp;quot;expire&amp;quot;, info_expire)
        redis.call(&amp;quot;PEXPIRE&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, math.floor((info_expire - timestamp) / 1000000))
    end

    return {token, info_expire - timestamp}
end
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;luaè„šæœ¬è·å–æ—¶é—´æˆ³&#34;&gt;Luaè„šæœ¬è·å–æ—¶é—´æˆ³&lt;/h3&gt;

&lt;p&gt;æ—¢ç„¶åœ¨åˆ†å¸ƒå¼ç¯å¢ƒç³»ç»Ÿæ—¶é’Ÿæœ‰å¯èƒ½å­˜åœ¨è¯¯å·®ï¼Œé‚£è‡ªç„¶è€ƒè™‘å°†æ—¶é—´æˆ³è½¬åˆ°Redisä¸­è·å–ï¼Œæ¶ˆé™¤æ—¶é’Ÿè¯¯å·®å¯¹çª—å£çš„å½±å“ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªé™åˆ¶æ¡ä»¶æ˜¯éœ€è¦Luaè„šæœ¬æ”¯æŒ&lt;strong&gt;éšæœºå†™å…¥&lt;/strong&gt;ï¼Œ
æœ‰å…³Redis Luaè„šæœ¬&lt;strong&gt;éšæœºå†™å…¥&lt;/strong&gt;è¯·å‚è€ƒæ­¤æ–‡ã€Š&lt;a href=&#34;https://yq.aliyun.com/articles/195914&#34;&gt;redis4.0ä¹‹Luaè„šæœ¬æ–°å§¿åŠ¿&lt;/a&gt;ã€‹ï¼Œç»“åˆè¿™ä¸ªç‰¹æ€§å¯ä»¥å°†ä¸¤ä¸ªæ–¹æ¡ˆçš„æ—¶é—´æˆ³ç”±å¤–éƒ¨ä¼ å…¥æ”¹ä¸ºåœ¨Luaè„šæœ¬ä¸­è·å–Redisç³»ç»Ÿæ—¶é—´ï¼Œ
æˆ‘åœ¨&lt;a href=&#34;https://github.com/hb-go/pkg/tree/master/rate&#34;&gt;hb-go/pkg/rate&lt;/a&gt;åŒ…åˆ†åˆ«ä½¿ç”¨&lt;code&gt;SET&lt;/code&gt;ã€&lt;code&gt;HSET&lt;/code&gt;åšäº†å®ç°å¯ä»¥å‚è€ƒã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lua&#34;&gt;-- Redis version â‰¥ 3.2
redis.replicate_commands()
local now = redis.call(&#39;TIME&#39;)
timestamp = (tonumber(now[1]) * 1e6 + tonumber(now[2])) * 1e3
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æ»šåŠ¨çª—å£&#34;&gt;æ»šåŠ¨çª—å£&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/distributed/rate-window-rolling.png&#34; alt=&#34;rolling-window&#34; /&gt;&lt;/p&gt;

&lt;p&gt;æ»šåŠ¨çª—å£åœ¨å›ºå®šçª—å£åŸºç¡€ä¸Šï¼Œå°†ä¸€ä¸ª&lt;code&gt;window&lt;/code&gt;æ‹†æˆå¤šä¸ª&lt;code&gt;bucket&lt;/code&gt;ï¼Œè¿™æ ·çª—å£æ ¹æ®&lt;code&gt;bucket&lt;/code&gt;çš„å¤§å°å‘å‰ç§»åŠ¨ã€‚Redisçš„ç»“æ„ä¸ºå“ˆå¸Œè¡¨ï¼š&lt;code&gt;token&lt;/code&gt;ã€&lt;code&gt;bucket.token&lt;/code&gt;ã€&lt;code&gt;bucket.timestamp&lt;/code&gt;å’Œ&lt;code&gt;key&lt;/code&gt;ï¼Œ
ä»¥åŠä¸€ä¸ªå­˜å‚¨&lt;code&gt;bucket&lt;/code&gt;å†å²æ•°æ®çš„æœ‰åºé›†åˆ(&lt;em&gt;ä»¥&lt;code&gt;bucket&lt;/code&gt;çš„æ—¶é—´æˆ³æ’åº&lt;/em&gt;)&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;token&lt;/code&gt;:çª—å£å†…å·²ä½¿ç”¨&lt;code&gt;token&lt;/code&gt;æ•°&lt;/li&gt;
&lt;li&gt;&lt;code&gt;bucket.token&lt;/code&gt;:å½“å‰æ¡¶å†…å·²ä½¿ç”¨&lt;code&gt;token&lt;/code&gt;æ•°&lt;/li&gt;
&lt;li&gt;&lt;code&gt;bucket.timestamp&lt;/code&gt;:å½“å‰æ¡¶çš„æ—¶é—´æˆ³&lt;/li&gt;
&lt;li&gt;&lt;code&gt;key&lt;/code&gt;:ç´¯è®¡&lt;code&gt;bucket&lt;/code&gt;æ•°é‡&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-lua&#34;&gt;local key_meta = KEYS[1]
local key_data = KEYS[2]

local credit = tonumber(ARGV[1])
local windowLength = tonumber(ARGV[2])
local bucketLength = tonumber(ARGV[3])
local bestEffort = tonumber(ARGV[4])
local token = tonumber(ARGV[5])
local timestamp = tonumber(ARGV[6])
local deduplicationid = ARGV[7]

-- lookup previous response for the deduplicationid and returns if it is still valid
--------------------------------------------------------------------------------
if (deduplicationid or &#39;&#39;) ~= &#39;&#39; then
    local previous_token = tonumber(redis.call(&amp;quot;HGET&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, &amp;quot;token&amp;quot;))
    local previous_expire = tonumber(redis.call(&amp;quot;HGET&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, &amp;quot;expire&amp;quot;))

    if previous_token and previous_expire then
        if timestamp &amp;lt; previous_expire then
            return {previous_token, previous_expire - timestamp}
        end
    end
end

-- read meta information
--------------------------------------------------------------------------------
local info_token = tonumber(redis.call(&amp;quot;HGET&amp;quot;, key_meta, &amp;quot;token&amp;quot;))
local info_bucket_token = tonumber(redis.call(&amp;quot;HGET&amp;quot;, key_meta, &amp;quot;bucket.token&amp;quot;))
local info_bucket_timestamp = tonumber(redis.call(&amp;quot;HGET&amp;quot;, key_meta, &amp;quot;bucket.timestamp&amp;quot;))

-- initialize meta
--------------------------------------------------------------------------------
if not info_token or not info_bucket_token or not info_bucket_timestamp then
    info_token = 0
    info_bucket_token = 0
    info_bucket_timestamp = timestamp

    redis.call(&amp;quot;HMSET&amp;quot;, key_meta,
        &amp;quot;token&amp;quot;, info_token,
        &amp;quot;bucket.token&amp;quot;, info_bucket_token,
        &amp;quot;bucket.timestamp&amp;quot;, info_bucket_timestamp,
        &amp;quot;key&amp;quot;, 0)
end


-- move buffer to bucket list if bucket timer is older than bucket window
--------------------------------------------------------------------------------
if (timestamp - info_bucket_timestamp + 1) &amp;gt; bucketLength then
    if tonumber(info_bucket_token) &amp;gt; 0 then
        local nextKey = redis.call(&amp;quot;HINCRBY&amp;quot;, key_meta, &amp;quot;key&amp;quot;, 1)
        local value = tostring(nextKey) .. &amp;quot;.&amp;quot; .. tostring(info_bucket_token)
        redis.call(&amp;quot;ZADD&amp;quot;, key_data, info_bucket_timestamp, value);
    end
    redis.call(&amp;quot;HMSET&amp;quot;, key_meta,
        &amp;quot;bucket.token&amp;quot;, 0,
        &amp;quot;bucket.timestamp&amp;quot;, timestamp)
end

local time_to_expire = timestamp - windowLength

-- reclaim tokens from expired records
--------------------------------------------------------------------------------
local reclaimed = 0
local expired = redis.call(&amp;quot;ZRANGEBYSCORE&amp;quot;, key_data, 0, time_to_expire)

for idx, value in ipairs(expired) do
    reclaimed = reclaimed + tonumber(string.sub(value, string.find(value, &amp;quot;%.&amp;quot;)+1))
end

-- remove expired records
--------------------------------------------------------------------------------
redis.call(&amp;quot;ZREMRANGEBYSCORE&amp;quot;, key_data, 0, time_to_expire)

-- update consumed token
--------------------------------------------------------------------------------
if reclaimed &amp;gt; 0 then
    info_token = info_token - reclaimed;
    if info_token &amp;lt; 0 then
        info_token = 0
    end
    redis.call(&amp;quot;HSET&amp;quot;, key_meta, &amp;quot;token&amp;quot;, info_token)
end

-- update the expiration time for automatic cleanup
--------------------------------------------------------------------------------
redis.call(&amp;quot;PEXPIRE&amp;quot;, key_meta, windowLength / 1000000)
redis.call(&amp;quot;PEXPIRE&amp;quot;, key_meta, windowLength / 1000000)

-- calculate available token
--------------------------------------------------------------------------------
local available_token = credit - info_token

-- check available token and requested token
--------------------------------------------------------------------------------

if available_token &amp;lt;= 0 then
    -- credit exhausted
    return {0, 0}
elseif available_token &amp;gt;= token then
    -- increase token and bucket.token by token
    redis.call(&amp;quot;HINCRBY&amp;quot;, key_meta, &amp;quot;token&amp;quot;, token)
    redis.call(&amp;quot;HINCRBY&amp;quot;, key_meta, &amp;quot;bucket.token&amp;quot;, token)

    -- save current request and set expiration time for auto cleanup
    if (deduplicationid or &#39;&#39;) ~= &#39;&#39; then
        redis.call(&amp;quot;HMSET&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, &amp;quot;token&amp;quot;, token, &amp;quot;expire&amp;quot;, timestamp + windowLength)
        redis.call(&amp;quot;PEXPIRE&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, windowLength / 1000000)
    end

    return {token,  windowLength}
else

    if bestEffort == 0 then
        -- not enough token
        return {0, 0}
    end

    -- allocate available token only
    redis.call(&amp;quot;HINCRBY&amp;quot;, key_meta, &amp;quot;token&amp;quot;, available_token)
    redis.call(&amp;quot;HINCRBY&amp;quot;, key_meta, &amp;quot;bucket.token&amp;quot;, available_token)

    -- save current request and set expiration time for auto cleanup
    if (deduplicationid or &#39;&#39;) ~= &#39;&#39; then
        redis.call(&amp;quot;HMSET&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, &amp;quot;token&amp;quot;, available_token, &amp;quot;expire&amp;quot;, timestamp + windowLength)
        redis.call(&amp;quot;PEXPIRE&amp;quot;, deduplicationid .. &amp;quot;-&amp;quot; .. key_meta, windowLength / 1000000)
    end

    return {available_token, windowLength}
end
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;é™æµçš„çª—å£ä¸Flinkçš„&lt;a href=&#34;https://ci.apache.org/projects/flink/flink-docs-release-1.8/dev/stream/operators/windows.html#tumbling-windows&#34;&gt;Window&lt;/a&gt;ç±»ä¼¼ï¼Œ
å¯¹äºå›ºå®šçª—å£ç»“åˆä½¿ç”¨åœºæ™¯çš„éœ€æ±‚ï¼Œå¯ä»¥å€Ÿé‰´Flinkçš„&lt;strong&gt;Tumbling Window&lt;/strong&gt;æ¥å£è®¾è®¡æä¾›&lt;code&gt;offset&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Flinkå®è·µã€‘å®æ—¶æ¶ˆè´¹é˜¿é‡Œäº‘SLSæ—¥å¿—&#43;è¾“å‡ºåˆ°ES</title>
      <link>http://hbchen.com/post/flink/2019-04-29-sls&#43;es/</link>
      <pubDate>Mon, 29 Apr 2019 18:42:22 +0800</pubDate>
      
      <guid>http://hbchen.com/post/flink/2019-04-29-sls&#43;es/</guid>
      
        <description>&lt;p&gt;æœ¬æ–‡ä»‹ç»Flinkåœ¨æµè®¡ç®—åœºæ™¯çš„ç®€å•åº”ç”¨ï¼Œå®æ—¶æ¶ˆè´¹SLSå†…çš„AccessLogï¼Œå¹¶å°†è®¡ç®—ç»“æœè¾“å‡ºåˆ°Elasticsearchã€‚&lt;/p&gt;

&lt;h2 id=&#34;ç¯å¢ƒ&#34;&gt;ç¯å¢ƒ&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;Flink

&lt;ul&gt;
&lt;li&gt;1.8&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;ES

&lt;ul&gt;
&lt;li&gt;6.3.2&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;å‡è®¾åœºæ™¯&#34;&gt;å‡è®¾åœºæ™¯&lt;/h2&gt;

&lt;p&gt;&lt;em&gt;æ—¥å¿—ç»“æ„&lt;/em&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;request_time: 1556415329
uri: /analysis/path?id=1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç³»ç»ŸAccessLogé€šè¿‡Logtaié‡‡é›†åˆ°é˜¿é‡Œäº‘SLSï¼ŒæŒ‡å®š&lt;code&gt;request_time&lt;/code&gt;ä¸ºæ—¥å¿—æ—¶é—´å­—æ®µã€‚ç¤ºä¾‹åœºæ™¯éœ€æ±‚ç»Ÿè®¡æŒ‡å®š&lt;code&gt;uri.path&lt;/code&gt;+&lt;code&gt;uri.query.id&lt;/code&gt;åˆ†ç»„ç»Ÿè®¡è®¿é—®è®¡æ•°ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å®æ—¶æ¶ˆè´¹&lt;code&gt;SLS&lt;/code&gt;æ—¥å¿—&lt;/li&gt;
&lt;li&gt;ç­›é€‰&lt;code&gt;uri.path&lt;/code&gt;=&lt;code&gt;/analysis/path&lt;/code&gt;(&lt;em&gt;ç®€åŒ–åªç»Ÿè®¡å•ä¸ª&lt;code&gt;path&lt;/code&gt;ï¼Œå®é™…åœºæ™¯å¯èƒ½æ˜¯å¤šä¸ª&lt;code&gt;path&lt;/code&gt;çš„è®¿é—®ç»Ÿè®¡ï¼Œç›¸åº”çš„&lt;code&gt;key&lt;/code&gt;å‚æ•°è§„åˆ™ä¹Ÿä¼šä¸åŒ&lt;/em&gt;)&lt;/li&gt;
&lt;li&gt;è§£æ&lt;code&gt;uri.query&lt;/code&gt;å‚æ•°&lt;code&gt;id&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;åˆ›å»ºESç´¢å¼•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;PUT sls_analysis

PUT sls_analysis/_mapping/_doc
{
  &amp;quot;properties&amp;quot;: {
    &amp;quot;path&amp;quot;: {
      &amp;quot;type&amp;quot;: &amp;quot;text&amp;quot;
    },
    &amp;quot;key&amp;quot;: {
      &amp;quot;type&amp;quot;: &amp;quot;integer&amp;quot;
    },
    &amp;quot;count&amp;quot;: {
      &amp;quot;type&amp;quot;: &amp;quot;integer&amp;quot;
    },
    &amp;quot;timestamp&amp;quot;: {
      &amp;quot;type&amp;quot;:&amp;quot;long&amp;quot;
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æµç¨‹è§£æ&#34;&gt;æµç¨‹è§£æ&lt;/h2&gt;

&lt;p&gt;æ¥ä¸‹æ¥ç»“åˆ&lt;a href=&#34;https://github.com/hb-chen/flink-practice/tree/master/sls&#34;&gt;hb-chen/flink-practice&lt;/a&gt;æºç å¯¹æµç¨‹è¿›è¡Œè§£æã€‚&lt;/p&gt;

&lt;h3 id=&#34;gradleæ·»åŠ ä¾èµ–&#34;&gt;Gradleæ·»åŠ ä¾èµ–&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;    // ES
    flinkShadowJar &amp;quot;org.apache.flink:flink-connector-elasticsearch6_${scalaBinaryVersion}:${flinkVersion}&amp;quot;

    // SLS
    flinkShadowJar &amp;quot;com.aliyun.openservices:flink-log-connector:0.1.7&amp;quot;
    flinkShadowJar &amp;quot;com.aliyun.openservices:aliyun-log:0.6.19&amp;quot;
    flinkShadowJar &amp;quot;com.aliyun.openservices:log-loghub-producer:0.1.8&amp;quot;
    flinkShadowJar &amp;quot;com.google.protobuf:protobuf-java:2.5.0&amp;quot;
    
    // YAMLè§£æ
    flinkShadowJar &amp;quot;org.yaml:snakeyaml:1.24&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;å‚æ•°-é…ç½®-å¯å¿½ç•¥&#34;&gt;å‚æ•°&amp;amp;é…ç½®ï¼ˆå¯å¿½ç•¥ï¼‰&lt;/h3&gt;

&lt;p&gt;è™½ç„¶åªæ˜¯ç¤ºä¾‹è¿˜æ˜¯åšäº†&lt;code&gt;args&lt;/code&gt;å‚æ•°åŠ&lt;code&gt;config.yml&lt;/code&gt;é…ç½®çš„è·å–ï¼Œæ–¹ä¾¿é…ç½®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;public static void main(String[] args) throws Exception {
    final ParameterTool params = ParameterTool.fromArgs(args);
    String analysisPath = params.getRequired(&amp;quot;path&amp;quot;);
    String analysisQueryKey = params.get(&amp;quot;key&amp;quot;, &amp;quot;id&amp;quot;);
    LOG.info(&amp;quot;access log analysis path:&amp;quot; + analysisPath + &amp;quot; key:&amp;quot; + analysisQueryKey);

    Config config = getConfig();
    
    // â€¦â€¦
}

private static Config getConfig() {
    Constructor constructor = new Constructor(Config.class);
    org.yaml.snakeyaml.Yaml yaml = new org.yaml.snakeyaml.Yaml(constructor);

    Config config = yaml.loadAs(SlsAnalysis.class.getClassLoader().getResourceAsStream(&amp;quot;config.yml&amp;quot;), Config.class);
    return config;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;æ—¥å¿—æ¶ˆè´¹&#34;&gt;æ—¥å¿—æ¶ˆè´¹&lt;/h3&gt;

&lt;p&gt;é¦–å…ˆå‚è€ƒ&lt;a href=&#34;https://help.aliyun.com/document_detail/63594.html&#34;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;é€šè¿‡&lt;code&gt;SLS&lt;/code&gt;çš„å„ç§é…ç½®åˆ›å»ºä¸€ä¸ª&lt;code&gt;Consumer&lt;/code&gt;ï¼Œè·å¾—&lt;code&gt;SLS&lt;/code&gt;æ—¥å¿—æµ&lt;code&gt;DataStream&amp;lt;RawLogGroupList&amp;gt; logStream&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;    // SLSæ¶ˆè´¹
    // https://help.aliyun.com/document_detail/63594.html
    Properties configProps = new Properties();
    // è®¾ç½®è®¿é—®æ—¥å¿—æœåŠ¡çš„åŸŸå
    configProps.put(ConfigConstants.LOG_ENDPOINT, config.getSls().getEndpoint());
    // è®¾ç½®è®¿é—®ak
    configProps.put(ConfigConstants.LOG_ACCESSSKEYID, config.getSls().getAk());
    configProps.put(ConfigConstants.LOG_ACCESSKEY, config.getSls().getSk());
    // è®¾ç½®æ—¥å¿—æœåŠ¡çš„project
    configProps.put(ConfigConstants.LOG_PROJECT, config.getSls().getProject());
    // è®¾ç½®æ—¥å¿—æœåŠ¡çš„Logstore
    configProps.put(ConfigConstants.LOG_LOGSTORE, config.getSls().getLogStore());
    // è®¾ç½®æ¶ˆè´¹æ—¥å¿—æœåŠ¡èµ·å§‹ä½ç½®
    configProps.put(ConfigConstants.LOG_CONSUMER_BEGIN_POSITION, &amp;quot;&amp;quot; + (System.currentTimeMillis() / 1000L));
    // è®¾ç½®æ—¥å¿—æ‹‰å–æ—¶é—´é—´éš”åŠæ¯æ¬¡è°ƒç”¨æ‹‰å–çš„æ—¥å¿—æ•°é‡
    configProps.put(ConfigConstants.LOG_FETCH_DATA_INTERVAL_MILLIS, &amp;quot;1000&amp;quot;);
    configProps.put(ConfigConstants.LOG_MAX_NUMBER_PER_FETCH, &amp;quot;100&amp;quot;);
    // è®¾ç½®Shardså‘ç°å‘¨æœŸ
    configProps.put(ConfigConstants.LOG_SHARDS_DISCOVERY_INTERVAL_MILLIS, Consts.DEFAULT_SHARDS_DISCOVERY_INTERVAL_MILLIS);

    // è®¾ç½®æ—¥å¿—æœåŠ¡çš„æ¶ˆæ¯ååºåˆ—åŒ–æ–¹æ³•
    RawLogGroupListDeserializer deserializer = new RawLogGroupListDeserializer();
    final StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
    DataStream&amp;lt;RawLogGroupList&amp;gt; logStream = env.addSource(new FlinkLogConsumer&amp;lt;RawLogGroupList&amp;gt;(deserializer, configProps));
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é€šè¿‡&lt;code&gt;RawLogGroupList&lt;/code&gt;ç»“æ„çŸ¥é“&lt;code&gt;logStream&lt;/code&gt;è·å¾—çš„æ˜¯æ‰¹é‡çš„&lt;code&gt;SLS&lt;/code&gt;æ—¥å¿—ï¼Œå•æ¡æ—¥å¿—æ˜¯åˆ†ç»„çš„&lt;code&gt;RawLog&lt;/code&gt;åˆ—è¡¨ï¼Œè¿™å°±éœ€è¦é¦–å…ˆå¯¹æ‰¹é‡çš„æ•°æ®è¿›è¡Œå±•å¼€(&lt;code&gt;flatMap()&lt;/code&gt;)æ¥è·å¾—å•æ¡æ•°æ®æµ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;public class RawLogGroupList implements Serializable {
    public List&amp;lt;RawLogGroup&amp;gt; rawLogGroups = new ArrayList();
}

public class RawLogGroup implements Serializable {
    public String source;
    public String topic = &amp;quot;&amp;quot;;
    public Map&amp;lt;String, String&amp;gt; tags = new HashMap();
    public List&amp;lt;RawLog&amp;gt; logs = new ArrayList();
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;æ‰¹é‡æ—¥å¿—å±•å¼€&#34;&gt;æ‰¹é‡æ—¥å¿—å±•å¼€&lt;/h3&gt;

&lt;p&gt;è¿™æ˜¯æ•´ä¸ªè¿‡æµç¨‹æœ€å…³é”®çš„ä¸€ç¯ï¼Œè¿™é‡Œè¦å®šä¹‰å±•å¼€åæ•°æ®æµçš„ç»“æ„ï¼Œä¸å•°å—¦ç›´æ¥çœ‹ç»“æ„&lt;code&gt;Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&lt;/code&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;f0&lt;/code&gt;:&lt;code&gt;AccessLogAnalysis&lt;/code&gt;æ˜¯è§£æ&lt;code&gt;uri&lt;/code&gt;çš„&lt;code&gt;path&lt;/code&gt;+&lt;code&gt;key&lt;/code&gt;çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¦ç”¨åš&lt;code&gt;keyBy&lt;/code&gt;çš„å±æ€§&lt;/li&gt;
&lt;li&gt;&lt;code&gt;f1&lt;/code&gt;:&lt;code&gt;Integer&lt;/code&gt;ç»Ÿè®¡æ•°é‡ï¼Œå•æ¡æ—¥å¿—å…¨è®¡ä¸º1(&lt;em&gt;æ ¹æ®éœ€æ±‚è¿™é‡Œå¯ä»¥è€ƒäº›ä¼˜åŒ–ï¼Œæ¯”å¦‚Groupå†…æœ‰åºå¯ä»¥åœ¨rangeè¿‡ç¨‹ç›´æ¥å¯¹ç›¸åŒ&lt;code&gt;request_time&lt;/code&gt;åšèšåˆ&lt;/em&gt;)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;f2&lt;/code&gt;:&lt;code&gt;Long&lt;/code&gt;æ—¥å¿—æ—¶é—´æˆ³ï¼Œè€ƒè™‘åç»­ä½œä¸º&lt;code&gt;EventTime&lt;/code&gt;ä½¿ç”¨ï¼Œæ‰€ä»¥å°†&lt;code&gt;request_time&lt;/code&gt;è½¬ä¸ºæ¯«ç§’&lt;/li&gt;
&lt;li&gt;&lt;code&gt;f3&lt;/code&gt;:&lt;code&gt;Long&lt;/code&gt;æ‰¹é‡æ—¥å¿—çš„æœ€å°æ—¶é—´æˆ³ï¼Œå› ä¸º&lt;code&gt;SLS&lt;/code&gt;æ—¥å¿—æ˜¯æ—¶é—´æœ‰åºçš„ï¼Œä¸”å•ä¸ª&lt;code&gt;RawLogGroup&lt;/code&gt;æ—¥å¿—å‡åºï¼Œæ‰€ä»¥è‡ªç„¶çš„è€ƒè™‘ä½¿ç”¨æœ€å°æ—¶é—´æˆ³ä½œä¸º&lt;code&gt;watermark&lt;/code&gt;ï¼Œè¿™æ ·ä¹Ÿé¿å…äº†&lt;strong&gt;arrive late&lt;/strong&gt;çš„å‡ºç°&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;    // SLSæ‰¹é‡æ—¥å¿—å±•å¼€
    DataStream&amp;lt;Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&amp;gt; flatStream = logStream.flatMap(new FlatMapFunction&amp;lt;RawLogGroupList, Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&amp;gt;() {
        @Override
        public void flatMap(RawLogGroupList value, Collector&amp;lt;Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&amp;gt; out) throws Exception {
            // Log groupå†…æ—¶é—´å‡åºï¼Œè®°å½•æ‰€æœ‰åˆ†ç»„æœ€å°æ—¶é—´æˆ³ï¼Œå³ä¸ºwatermarkä½ç½®
            long minTimestamp = Long.MAX_VALUE;
            for (RawLogGroup group : value.getRawLogGroups()) {
                if (group.getLogs().size() &amp;gt; 0) {
                    RawLog log = group.getLogs().get(0);
                    long rt = Optional.ofNullable(log.getContents().get(&amp;quot;request_time&amp;quot;)).map(Long::new).orElse(Long.MAX_VALUE);
                    minTimestamp = rt &amp;lt; minTimestamp ? rt : minTimestamp;
                }
            }
            // å–æ¯«ç§’ï¼Œæ’é™¤MAX_VALUE
            minTimestamp = minTimestamp == Long.MAX_VALUE ? minTimestamp : minTimestamp * 1000;

            Integer count = 0;
            for (RawLogGroup group : value.getRawLogGroups()) {
                count += group.getLogs().size();
                for (RawLog log : group.getLogs()) {
                    // URIè§£æ
                    QueryStringDecoder decoder = new QueryStringDecoder(log.getContents().get(&amp;quot;uri&amp;quot;));
                    String path = decoder.path();
                    List&amp;lt;String&amp;gt; keyList = decoder.parameters().get(analysisQueryKey);
                    if (path.equalsIgnoreCase(analysisPath) &amp;amp;&amp;amp; keyList != null &amp;amp;&amp;amp; keyList.size() &amp;gt; 0) {
                        Integer id = Optional.ofNullable(keyList.get(0)).map(Integer::new).orElse(0);
                        AccessLogAnalysis ala = new AccessLogAnalysis();
                        ala.setKey(id);
                        ala.setPath(path);

                        Long timestamp = Optional.ofNullable(log.getContents().get(&amp;quot;request_time&amp;quot;)).map(Long::new).orElse(0L);
                        timestamp *= 1000;

                        out.collect(new Tuple4&amp;lt;&amp;gt;(ala, 1, timestamp, minTimestamp));
                    }

                }
            }
            LOG.info(&amp;quot;raw log count:&amp;quot; + count + &amp;quot; timestamp:&amp;quot; + minTimestamp);
        }
    });
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;eventtime-timewindow&#34;&gt;EventTime &amp;amp; timeWindow&lt;/h3&gt;

&lt;p&gt;æœ‰äº†&lt;code&gt;flatStream&lt;/code&gt;çš„ç»“æœï¼Œè‡ªå®šä¹‰&lt;code&gt;EventTime&lt;/code&gt;ä»¥åŠ&lt;code&gt;Watermark&lt;/code&gt;å°±æ¯”è¾ƒç®€å•ã€‚&lt;br/&gt;&lt;code&gt;.keyBy(0).timeWindow(Time.seconds(60)).sum(1)&lt;/code&gt;æµç¨‹ä»¥&lt;code&gt;f0&lt;/code&gt;ä¸º&lt;code&gt;key&lt;/code&gt;åˆ†éš”ï¼Œ60sä¸ºæ—¶é—´çª—å£å¯¹&lt;code&gt;f1&lt;/code&gt;æ±‚å’Œã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;DataStream result = flatStream.assignTimestampsAndWatermarks(new AssignerWithPunctuatedWatermarks&amp;lt;Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&amp;gt;() {
    @Nullable
    @Override
    public Watermark checkAndGetNextWatermark(Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt; lastElement, long extractedTimestamp) {
        return lastElement.f3 &amp;lt;= extractedTimestamp ? new Watermark(lastElement.f3) : null;
    }

    @Override
    public long extractTimestamp(Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt; element, long previousElementTimestamp) {
        if (element.f2 &amp;gt; 0L) {
            return element.f2;
        } else {
            return previousElementTimestamp;
        }
    }
})
.keyBy(0)
.timeWindow(Time.seconds(60))
.sum(1);
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;è¾“å‡ºåˆ°es&#34;&gt;è¾“å‡ºåˆ°ES&lt;/h3&gt;

&lt;p&gt;å¤§è‡´å‚è€ƒ&lt;a href=&#34;https://ci.apache.org/projects/flink/flink-docs-release-1.8/dev/connectors/elasticsearch.html&#34;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;å³å¯ï¼Œ
åªæ˜¯æ²¡æœ‰è®¤è¯(&lt;em&gt;ç”Ÿäº§ç¯å¢ƒå¿…ä¸å¯å°‘ï¼Œæƒ³åˆ°ESç¤¾åŒºçš„åˆ†äº«ï¼Œåœ¨&lt;a href=&#34;https://www.shodan.io&#34;&gt;shodan.io&lt;/a&gt;ä¸Šæ‰¾å„ç§å…¬å¼€å…è´¹ESèµ„æºğŸ˜&lt;/em&gt;)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;// Sink:Elasticsearch
List&amp;lt;HttpHost&amp;gt; httpHosts = new ArrayList&amp;lt;&amp;gt;();
httpHosts.add(new HttpHost(config.getEs().getHostname(), 9200, &amp;quot;http&amp;quot;));

// use a ElasticsearchSink.Builder to create an ElasticsearchSink
ElasticsearchSink.Builder&amp;lt;Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&amp;gt; esSinkBuilder = new ElasticsearchSink.Builder&amp;lt;&amp;gt;(httpHosts, new ElasticsearchSinkFunction&amp;lt;Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&amp;gt;() {
    public IndexRequest createIndexRequest(Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt; element) {
        Map&amp;lt;String, String&amp;gt; json = new HashMap&amp;lt;&amp;gt;();
        json.put(&amp;quot;path&amp;quot;, element.f0.getPath());
        json.put(&amp;quot;key&amp;quot;, element.f0.getKey().toString());
        json.put(&amp;quot;count&amp;quot;, element.f1.toString());
        json.put(&amp;quot;timestamp&amp;quot;, element.f3.toString());

        return Requests.indexRequest().index(&amp;quot;sls_analysis&amp;quot;).type(&amp;quot;_doc&amp;quot;).source(json);
    }

    @Override
    public void process(Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt; element, RuntimeContext runtimeContext, RequestIndexer requestIndexer) {
        requestIndexer.add(createIndexRequest(element));
    }
});

// configuration for the bulk requests; this instructs the sink to emit after every element, otherwise they would be buffered
esSinkBuilder.setBulkFlushMaxActions(1);

// provide a RestClientFactory for custom configuration on the internally created REST client
String esUsername = config.getEs().getUsername();
String esPassword = config.getEs().getPassword();
esSinkBuilder.setRestClientFactory(restClientBuilder -&amp;gt; {
    // restClientBuilder.setDefaultHeaders(headers);
    // restClientBuilder.setMaxRetryTimeoutMillis(...)
    // restClientBuilder.setPathPrefix(...)
    restClientBuilder.setHttpClientConfigCallback(new RestClientBuilder.HttpClientConfigCallback() {
        @Override
        public HttpAsyncClientBuilder customizeHttpClient(HttpAsyncClientBuilder httpAsyncClientBuilder) {
            CredentialsProvider credentialsProvider = new BasicCredentialsProvider();
            credentialsProvider.setCredentials(AuthScope.ANY, new UsernamePasswordCredentials(esUsername, esPassword));
            return httpAsyncClientBuilder.setDefaultCredentialsProvider(credentialsProvider);
        }
    });
});

// finally, build and add the sink to the job&#39;s pipeline
result.addSink(esSinkBuilder.build());
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡Œè¿˜é‡åˆ°ä¸ªå°å‘ï¼ˆJavaä¸¢çš„å¤ªä¹…äº†ğŸ˜‚ï¼‰ï¼Œåœ¨&lt;code&gt;UsernamePasswordCredentials()&lt;/code&gt;ä¸­ç›´æ¥ä½¿ç”¨&lt;code&gt;config.getEs().getUsername()&lt;/code&gt; &lt;code&gt;config.getEs().getPassword()&lt;/code&gt;ï¼Œå¯¼è‡´åºåˆ—åŒ–é”™è¯¯ï¼Œç›¸å…³å‚è€ƒ&lt;a href=&#34;https://yuzhouwan.com/posts/20644/&#34;&gt;Apache Flink#è¸©è¿‡çš„å‘&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;Exception in thread &amp;quot;main&amp;quot; org.apache.flink.api.common.InvalidProgramException: The implementation of the ElasticsearchSinkBase is not serializable. The object probably contains or references non serializable fields.
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;æµ‹è¯•-æ‰“åŒ…&#34;&gt;æµ‹è¯• &amp;amp; æ‰“åŒ…&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# æµ‹è¯•
$ ./gradlew sls:run --args=&amp;quot;--path /analysis/path&amp;quot;

# æ‰“åŒ…
$ ./gradlew clean sls:shadowJar
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;æäº¤jobåˆ°flinkè¿è¡Œ&#34;&gt;æäº¤Jobåˆ°Flinkè¿è¡Œ&lt;/h3&gt;

&lt;p&gt;ä¸Šä¼ &lt;code&gt;.jar&lt;/code&gt;åˆ°Flink&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;Program Arguments
--path /analysis/path
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/flink/sls+es-dashboard.png&#34; alt=&#34;auth-adapter&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;åˆ°kibanaçœ‹ä¸‹ç»“æœ&#34;&gt;åˆ°Kibanaçœ‹ä¸‹ç»“æœ&lt;/h3&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/flink/sls+es-kibana.png&#34; alt=&#34;auth-adapter&#34; /&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;GET /sls_analysis/_search
{
  &amp;quot;aggs&amp;quot;: {
    &amp;quot;2&amp;quot;: {
      &amp;quot;terms&amp;quot;: {
        &amp;quot;field&amp;quot;: &amp;quot;key&amp;quot;,
        &amp;quot;size&amp;quot;: 20,
        &amp;quot;order&amp;quot;: {
          &amp;quot;1&amp;quot;: &amp;quot;desc&amp;quot;
        }
      },
      &amp;quot;aggs&amp;quot;: {
        &amp;quot;1&amp;quot;: {
          &amp;quot;sum&amp;quot;: {
            &amp;quot;field&amp;quot;: &amp;quot;count&amp;quot;
          }
        }
      }
    }
  },
  &amp;quot;size&amp;quot;: 0,
  &amp;quot;_source&amp;quot;: {
    &amp;quot;excludes&amp;quot;: []
  },
  &amp;quot;stored_fields&amp;quot;: [
    &amp;quot;*&amp;quot;
  ],
  &amp;quot;script_fields&amp;quot;: {},
  &amp;quot;docvalue_fields&amp;quot;: [],
  &amp;quot;query&amp;quot;: {
    &amp;quot;bool&amp;quot;: {
      &amp;quot;must&amp;quot;: [
        {
          &amp;quot;match_all&amp;quot;: {}
        },
        {
          &amp;quot;match_phrase&amp;quot;: {
            &amp;quot;path&amp;quot;: {
              &amp;quot;query&amp;quot;: &amp;quot;/analysis/path&amp;quot;
            }
          }
        }
      ],
      &amp;quot;filter&amp;quot;: [],
      &amp;quot;should&amp;quot;: [],
      &amp;quot;must_not&amp;quot;: []
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;todo&#34;&gt;TODO&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;Checkpoint&lt;/li&gt;
&lt;/ul&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Istioå®‰å…¨ã€‘ç½‘æ ¼è¾¹ç¼˜-Egress</title>
      <link>http://hbchen.com/post/servicemesh/2019-04-11-istio-security-egress/</link>
      <pubDate>Sun, 14 Apr 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/servicemesh/2019-04-11-istio-security-egress/</guid>
      
        <description>&lt;p&gt;æ¥ä¸Šä¸€ç¯‡ã€Š&lt;a href=&#34;http://hbchen.com/post/servicemesh/2019-03-09-istio-rbac-quick-start/&#34;&gt;ã€Istioå®‰å…¨ã€‘æœåŠ¡é—´è®¿é—®æ§åˆ¶-RBAC&lt;/a&gt;ã€‹ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»ç½‘æ ¼è¾¹ç¼˜Egressç›¸å…³çš„é…ç½®ï¼Œ&lt;code&gt;HTTP&lt;/code&gt;ã€&lt;code&gt;HTTPS&lt;/code&gt;ä»¥åŠ&lt;code&gt;HTTP&lt;/code&gt;è½¬&lt;code&gt;TLS&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Istioç‰ˆæœ¬ &lt;strong&gt;1.1.1&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;å¼€å§‹å‰çš„å‡†å¤‡&#34;&gt;å¼€å§‹å‰çš„å‡†å¤‡&lt;/h2&gt;

&lt;blockquote&gt;
&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;  # Set the default behavior of the sidecar for handling outbound traffic from the application:
  # ALLOW_ANY - outbound traffic to unknown destinations will be allowed, in case there are no
  #   services or ServiceEntries for the destination port
  # REGISTRY_ONLY - restrict outbound traffic to services defined in the service registry as well
  #   as those defined through ServiceEntries
  # ALLOW_ANY is the default in 1.1.  This means each pod will be able to make outbound requests 
  # to services outside of the mesh without any ServiceEntry.
  # REGISTRY_ONLY was the default in 1.0.  If this behavior is desired, set the value below to REGISTRY_ONLY.
  outboundTrafficPolicy:
    mode: ALLOW_ANY
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;p&gt;Istioéƒ¨ç½²é…ç½®çš„&lt;code&gt;global.outboundTrafficPolicy&lt;/code&gt;å‚æ•°ï¼Œåœ¨1.1å¼€å§‹é»˜è®¤&lt;code&gt;ALLOW_ANY&lt;/code&gt;ï¼Œè¿™ç§æƒ…å†µä¸‹å¦‚æœä¸é…ç½®&lt;code&gt;ServiceEntry&lt;/code&gt;ï¼Œè®¿é—®å¤–åŒ…HTTPæµé‡è¿”å›&lt;code&gt;404&lt;/code&gt;ï¼Œè€ŒHTTPSæµé‡å¯ä»¥æ­£å¸¸è®¿é—®ï¼Œä¸ºäº†æµ‹è¯•&lt;code&gt;ServiceEntry&lt;/code&gt;é…ç½®æ•ˆæœï¼Œå°†é…ç½®æ”¹ä¸º&lt;code&gt;REGISTRY_ONLY&lt;/code&gt;ï¼Œæ–¹ä¾¿è§‚å¯Ÿ&lt;code&gt;ServiceEntry&lt;/code&gt;é…ç½®çš„æ•ˆæœ&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;æœ¬æ–‡ç¤ºä¾‹Istioä½¿ç”¨helmçš„values-istio-demo.yamlé…ç½®å®‰è£…&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;éƒ¨ç½²æµ‹è¯•ç”¨ä¾‹&lt;code&gt;sleep&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.1/samples/sleep/sleep.yaml

$ export SOURCE_POD=$(kubectl get pod -l app=sleep -o jsonpath={.items..metadata.name})
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;code&gt;outboundTrafficPolicy=ALLOW_ANY&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://hbchen.com
HTTP/1.1 404 Not Found

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://www.aliyun.com
HTTP/1.1 404 Not Found

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - https://www.aliyun.com
HTTP/2 200
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¿®æ”¹&lt;code&gt;values-istio-demo.yaml&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;  outboundTrafficPolicy:
    mode: REGISTRY_ONLY
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é‡æ–°éƒ¨ç½²Istio&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ helm template install/kubernetes/helm/istio --name istio --namespace istio-system --values install/kubernetes/helm/istio/values-istio-demo.yaml | kubectl apply -f -
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é‡æ–°éƒ¨ç½²æµ‹è¯•ç”¨ä¾‹&lt;code&gt;sleep&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl delete -f https://raw.githubusercontent.com/istio/istio/release-1.1/samples/sleep/sleep.yaml
$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.1/samples/sleep/sleep.yaml

$ export SOURCE_POD=$(kubectl get pod -l app=sleep -o jsonpath={.items..metadata.name})
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;sidecaræ–¹å¼&#34;&gt;Sidecaræ–¹å¼&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/istio/egress-sidecar.png&#34; alt=&#34;ServiceEntry&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;http&#34;&gt;HTTP&lt;/h3&gt;

&lt;p&gt;å…ˆå®šä¹‰ä¸€ä¸ª&lt;code&gt;ServiceEntry&lt;/code&gt;ï¼Œå¼€å¯&lt;code&gt;www.aliyun.com&lt;/code&gt;ã€&lt;code&gt;hbchen.com&lt;/code&gt;çš„å¤–éƒ¨è®¿é—®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;$ kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: entry-x
spec:
  hosts:
  - www.aliyun.com
  - hbchen.com
  ports:
  - number: 80
    name: http
    protocol: HTTP
  resolution: NONE
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://hbchen.com
HTTP/1.1 200 OK

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://www.aliyun.com
HTTP/1.1 301 Moved Permanently
...
command terminated with exit code 35

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - https://www.aliyun.com
command terminated with exit code 35
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;http-https&#34;&gt;HTTP &amp;amp; HTTPS&lt;/h3&gt;

&lt;p&gt;åªå¼€&lt;code&gt;80&lt;/code&gt;ç«¯å£ï¼Œ&lt;code&gt;HTTP&lt;/code&gt;æ­£å¸¸ï¼Œè€Œå¯¹äº&lt;code&gt;HTTPS&lt;/code&gt;ä»¥åŠæœ‰&lt;code&gt;HTTP&lt;/code&gt;é‡å®šå‘&lt;code&gt;HTTPS&lt;/code&gt;çš„è¯·æ±‚ä»ä¼šå¤±è´¥&lt;code&gt;command terminated with exit code 35&lt;/code&gt;ï¼Œæ‰€ä»¥å®è·µä¸­å¤–éƒ¨æœåŠ¡ä¸€èˆ¬åŒæ—¶å¼€å¯&lt;code&gt;80&lt;/code&gt;ã€&lt;code&gt;443&lt;/code&gt;ç«¯å£&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;$ kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: entry-x
spec:
  hosts:
  - www.aliyun.com
  - hbchen.com
  ports:
  - number: 80
    name: http-port
    protocol: HTTP
  - number: 443
    name: https-port
    protocol: HTTPS
  resolution: NONE
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://www.aliyun.com
HTTP/1.1 301 Moved Permanently
...
HTTP/2 200

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - https://www.aliyun.com
HTTP/2 200
...
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;httpè½¬tls&#34;&gt;HTTPè½¬TLS&lt;/h3&gt;

&lt;p&gt;è¿™æ—¶æˆ‘ä»¬çœ‹åˆ°å¦ä¸€ä¸ªé—®é¢˜ï¼Œéœ€è¦å‡çº§&lt;code&gt;HTTPS&lt;/code&gt;çš„&lt;code&gt;HTTP&lt;/code&gt;è¯·æ±‚æ¯æ¬¡éƒ½è¦&lt;code&gt;301&lt;/code&gt;é‡å®šå‘ä¸€æ¬¡ï¼Œåœ¨ä¸ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹å¯ä»¥åœ¨&lt;code&gt;proxy&lt;/code&gt;å°†&lt;code&gt;HTTP&lt;/code&gt;è¯·æ±‚å‡çº§ä¸º&lt;code&gt;TLS&lt;/code&gt;ï¼Œé¿å…äºŒæ¬¡è·³è½¬ï¼Œéœ€è¦åŠ &lt;code&gt;VirtualService&lt;/code&gt; + &lt;code&gt;DestinationRule&lt;/code&gt;æ¥å®ç°ã€‚&lt;/p&gt;

&lt;p&gt;åœ¨å®˜æ–¹ç¤ºä¾‹&lt;a href=&#34;https://istio.io/zh/docs/examples/advanced-gateways/egress-tls-origination/#%E5%87%BA%E5%8F%A3%E6%B5%81%E9%87%8F%E7%9A%84-tls&#34;&gt;å‡ºå£æµé‡çš„-tls&lt;/a&gt;ä¸­ï¼Œä»…å°†&lt;code&gt;HTTP&lt;/code&gt;å‡çº§åˆ°&lt;code&gt;TLS&lt;/code&gt;ï¼Œè€Œå¯¹æ­£å¸¸çš„&lt;code&gt;HTTPS&lt;/code&gt;æ²¡æœ‰æ”¯æŒï¼Œè¿™é‡Œç¨ä½œæ”¹åŠ¨ï¼Œåœ¨&lt;code&gt;VirtualService&lt;/code&gt;ä¸­ä¸º&lt;code&gt;80&lt;/code&gt;ç«¯å£çš„&lt;code&gt;destination&lt;/code&gt;å®šä¹‰&lt;code&gt;subset&lt;/code&gt;ï¼Œè¿™æ ·åœ¨&lt;code&gt;DestinationRule&lt;/code&gt;ä¸­é»˜è®¤&lt;code&gt;trafficPolicy&lt;/code&gt;ä¸åšå¤„ç†ï¼Œä»…å¯¹æŒ‡å®šçš„&lt;code&gt;subset&lt;/code&gt;åš&lt;code&gt;HTTPS&lt;/code&gt;è½¬å‘ï¼Œä½¿ç½‘æ ¼å†…æ— è®ºå‘èµ·&lt;code&gt;HTTP&lt;/code&gt;è¿˜æ˜¯&lt;code&gt;HTTPS&lt;/code&gt;çš„å¤–ç½‘è¯·æ±‚éƒ½å¯ä»¥æ­£å¸¸è®¿é—®ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: entry-x
spec:
  hosts:
  - www.aliyun.com
  - hbchen.com
  ports:
  - number: 80
    name: http-port
    protocol: HTTP
  - number: 443
    name: https-port
    protocol: HTTPS
  resolution: DNS
  location: MESH_EXTERNAL
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: rewrite-port-for-entry
spec:
  hosts:
  - www.aliyun.com
  http:
  - match:
      - port: 80
    route:
    - destination:
        # NOTE: ä¸ºHTTPå‡çº§æµé‡æŒ‡å®šsubset
        subset: originate-tls
        host: www.aliyun.com
        port:
          number: 443
  tls:
  - match:
      - port: 443
        sniHosts:
        - www.aliyun.com
    route:
    - destination:
        host: www.aliyun.com
        port:
          number: 443
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: originate-tls-for-entry
spec:
  host: www.aliyun.com
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
  subsets:
    - name: originate-tls
      trafficPolicy:
        loadBalancer:
          simple: ROUND_ROBIN
        portLevelSettings:
        - port:
            number: 443
          tls:
            mode: SIMPLE
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://hbchen.com
HTTP/1.1 200 OK

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://www.aliyun.com
HTTP/1.1 200 OK

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - https://www.aliyun.com
HTTP/2 200
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;gatewayæ–¹å¼&#34;&gt;Gatewayæ–¹å¼&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/istio/egress-gateway.png&#34; alt=&#34;ServiceEntry&#34; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å®˜æ–¹ç¤ºä¾‹&lt;a href=&#34;https://istio.io/zh/docs/examples/advanced-gateways/egress-gateway/&#34;&gt;é…ç½® Egress gateway&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Gatewayä¸Sidecarçš„åŒºåˆ«æ˜¯å°†å‡ºå£æµé‡éƒ½è½¬åˆ°&lt;code&gt;egressgateway&lt;/code&gt;ï¼Œå†ç”±Gatewayè¿›è¡Œè½¬å‘å¤„ç†ï¼Œæ— è®ºGatewayè¿˜æ˜¯Sidecar&lt;code&gt;ServiceEntry&lt;/code&gt;çš„é…ç½®è§„åˆ™éƒ½æ˜¯éœ€è¦çš„ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥å¼€å¯&lt;code&gt;80&lt;/code&gt;ã€&lt;code&gt;433&lt;/code&gt;ï¼Œæ³¨æ„&lt;code&gt;resolution&lt;/code&gt;=&lt;code&gt;DNS&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: entry-x
spec:
  hosts:
  - www.aliyun.com
  ports:
  - number: 80
    name: http-port
    protocol: HTTP
  - number: 443
    name: https-port
    protocol: HTTPS
  resolution: DNS
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;em&gt;è®¿é—®æµ‹è¯•ï¼ˆç•¥ï¼‰&lt;/em&gt;&lt;/p&gt;

&lt;h3 id=&#34;http-1&#34;&gt;HTTP&lt;/h3&gt;

&lt;p&gt;æµç¨‹å¦‚ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-mermaid&#34;&gt;graph LR;
   S[Siedcar]--&amp;gt;|&amp;quot;â‘ HTTP&amp;quot;|VS[VirtualService&amp;lt;br/&amp;gt;www.aliyun.com]
   VS--&amp;gt;|&amp;quot;â‘¡gateway=mesh&amp;quot;|EG[EgressGateway]
   EG--&amp;gt;|&amp;quot;â‘¢HTTP&amp;quot;|VS
   VS--&amp;gt;|&amp;quot;â‘£gateway=istio-egressgateway&amp;quot;|E[External]
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: istio-egressgateway
spec:
  selector:
    istio: egressgateway
  servers:
  - port:
      number: 80
      name: http-port
      protocol: HTTP
    hosts:
    - www.aliyun.com
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: egressgateway-for-aliyun
spec:
  host: istio-egressgateway.istio-system.svc.cluster.local
  subsets:
  - name: aliyun
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: aliyun-through-egress-gateway
spec:
  hosts:
  - www.aliyun.com
  gateways:
  - istio-egressgateway
  - mesh
  http:
  - match:
    - gateways:
      - mesh
      port: 80
    route:
    - destination:
        host: istio-egressgateway.istio-system.svc.cluster.local
        subset: aliyun
        port:
          number: 80
      weight: 100
  - match:
    - gateways:
      - istio-egressgateway
      port: 80
    route:
    - destination:
        host: www.aliyun.com
        port:
          number: 80
      weight: 100
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;(&lt;em&gt;è¿™é‡Œåªæœ‰HTTP&lt;/em&gt;)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://www.aliyun.com
HTTP/1.1 301 Moved Permanently
...
HTTP/2 200
...
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;httpè½¬tls-1&#34;&gt;HTTPè½¬TLS&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-mermaid&#34;&gt;graph LR;
   S[Siedcar]--&amp;gt;|&amp;quot;â‘ HTTP&amp;quot;|VS[VirtualService&amp;lt;br/&amp;gt;www.aliyun.com]
   VS--&amp;gt;|&amp;quot;â‘¡gateway=mesh&amp;quot;|EG[EgressGateway]
   EG--&amp;gt;|&amp;quot;â‘¢HTTP&amp;quot;|VS
   VS--&amp;gt;|&amp;quot;â‘£gateway=istio-egressgateway&amp;lt;br/&amp;gt;DestinationRuleä¸ºSubsetå‡çº§TLS&amp;quot;|E[External]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸Sidecaræ–¹å¼ç±»ä¼¼ï¼Œå¯¹äºæœ‰&lt;code&gt;HTTP&lt;/code&gt;é‡å®šå‘åˆ°&lt;code&gt;HTTPS&lt;/code&gt;çš„æµé‡å¯ä»¥åœ¨Gatewayä»£ç†ç›´æ¥å‡çº§ä¸º&lt;code&gt;TLS&lt;/code&gt;ï¼Œå‡å°‘è·³è½¬ï¼Œå®ç°æ–¹å¼ä¸Sidecaræ–¹å¼ç±»ä¼¼ï¼Œä¸º&lt;code&gt;HOST&lt;/code&gt;å¢åŠ &lt;code&gt;DestinationRule&lt;/code&gt;è§„åˆ™ä¸º&lt;code&gt;HTTP&lt;/code&gt;æµé‡å‘èµ·&lt;code&gt;TLS&lt;/code&gt;è¯·æ±‚ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: istio-egressgateway
spec:
  selector:
    istio: egressgateway
  servers:
  - port:
      number: 80
      name: http-port
      protocol: HTTP
    hosts:
    - www.aliyun.com
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: egressgateway-for-aliyun
spec:
  host: istio-egressgateway.istio-system.svc.cluster.local
  subsets:
  - name: aliyun
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: aliyun-through-egress-gateway
spec:
  hosts:
  - www.aliyun.com
  gateways:
  - istio-egressgateway
  - mesh
  http:
  - match:
    - gateways:
      - mesh
      port: 80
    route:
    - destination:
        host: istio-egressgateway.istio-system.svc.cluster.local
        subset: aliyun
        port:
          number: 80
      weight: 100
  - match:
    - gateways:
      - istio-egressgateway
      port: 80
    route:
    - destination:
        host: www.aliyun.com
        # NOTE: ä¸ºHTTPå‡çº§æµé‡æŒ‡å®šsubset
        subset: originate-tls
        port:
          number: 443
      weight: 100
---
# NOTE: æ³¨æ„è¿™é‡Œä¸Sidecaræ–¹å¼ç±»ä¼¼ï¼Œéœ€è¦å¯¹HTTPæµé‡å•ç‹¬é…ç½®subsetï¼Œå¦åˆ™å½±å“æ­£å¸¸HTTPSæµé‡
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: originate-tls-for-aliyun
spec:
  host: www.aliyun.com
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
  subsets:
    - name: originate-tls
      trafficPolicy:
        loadBalancer:
          simple: ROUND_ROBIN
        portLevelSettings:
        - port:
            number: 443
          tls:
            mode: SIMPLE
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://www.aliyun.com
HTTP/1.1 200 OK
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;åŒå‘&lt;code&gt;TLS&lt;/code&gt;ã€&lt;code&gt;HTTTPS&lt;/code&gt;é€ä¼ ç­‰è¿™é‡Œæ²¡æœ‰å†åšæµ‹è¯•ï¼Œæœ‰å…´è¶£å¯ä»¥å‚è€ƒå®˜æ–¹ç¤ºä¾‹&lt;a href=&#34;https://istio.io/zh/docs/examples/advanced-gateways/egress-gateway/&#34;&gt;é…ç½® Egress gateway&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;ç›´æ¥è°ƒç”¨å¤–éƒ¨æœåŠ¡&#34;&gt;ç›´æ¥è°ƒç”¨å¤–éƒ¨æœåŠ¡&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/istio/egress-sidecar-ip.png&#34; alt=&#34;ServiceEntry&#34; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Istioæ–‡æ¡£&lt;a href=&#34;https://istio.io/zh/docs/tasks/traffic-management/egress/#%E7%9B%B4%E6%8E%A5%E8%B0%83%E7%94%A8%E5%A4%96%E9%83%A8%E6%9C%8D%E5%8A%A1&#34;&gt;ç›´æ¥è°ƒç”¨å¤–éƒ¨æœåŠ¡&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;éœ€è¦ä¿®æ”¹helmçš„valuesé…ç½®æ›´æ–°éƒ¨ç½²ã€‚å¹¶ä¸”è¦è®©æ–°çš„&lt;code&gt;istio-sidecar-injector&lt;/code&gt;ç”Ÿæ•ˆï¼Œé‡æ–°éƒ¨ç½²&lt;code&gt;sleep&lt;/code&gt;ç”¨ä¾‹ã€‚è¿™ç§æ–¹å¼åœ¨Sidecarçš„Proxyä¸­è·³è¿‡äº†å¤–éƒ¨IPï¼Œè™½ç„¶ä¹Ÿæœ‰&lt;code&gt;excludeIPRanges&lt;/code&gt;æ–¹å¼ï¼Œä½†ä¿®æ”¹éº»çƒ¦éœ€è¦æ›´æ–°sidecarï¼Œå¹¶ä¸”è¿™æ ·ä¹Ÿå¤±å»äº†Istioçš„å…¶å®ƒèƒ½åŠ›ï¼Œæ‰€ä»¥ä¸æ€ä¹ˆå®ç”¨ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;  proxy:
    # Minikube
    includeIPRanges: &amp;quot;10.0.0.1/24&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;ServiceEntry&lt;/code&gt;é…åˆ&lt;code&gt;VirtualService&lt;/code&gt;ã€&lt;code&gt;DestinationRule&lt;/code&gt;å¯ä»¥ä½¿å¤–éƒ¨æµé‡åšæ¯”è¾ƒçµæ´»çš„ç®¡æ§ï¼Œå¹¶ä¸”å¯ä»¥å¯¹å¤–éƒ¨æœåŠ¡ä½¿ç”¨æµé‡ç®¡ç†çš„ç›¸å…³åŠŸèƒ½ï¼ŒGatewayç›¸å¯¹Sidecaré…ç½®è¿˜æ˜¯ç•¥æ˜¾å¤æ‚ï¼Œè€Œåœ¨æ€§èƒ½æ–¹é¢å®˜æ–¹Blog&lt;a href=&#34;https://istio.io/zh/blog/2019/egress-performance/&#34;&gt;Egress gateway æ€§èƒ½æµ‹è¯•&lt;/a&gt;ç»™å‡ºçš„æ¯”è¾ƒç»“æœä¸¤è€…ç›¸å·®ä¸å¤§ï¼Œè‡³äºç›´æ¥è°ƒç”¨æ–¹å¼ç›¸å¯¹å°±ä¸æ€ä¹ˆå®ç”¨äº†ã€‚&lt;/p&gt;</description>
      
    </item>
    
  </channel>
</rss>