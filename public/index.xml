<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Hobo&#39;s Blog - æŠ€æœ¯å®è·µ</title>
    <link>http://hbchen.com/</link>
    <description>Recent content on Hobo&#39;s Blog - æŠ€æœ¯å®è·µ</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <copyright>HB Studio</copyright>
    <lastBuildDate>Sun, 20 Aug 2017 21:38:52 +0800</lastBuildDate>
    
        <atom:link href="http://hbchen.com/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>About</title>
      <link>http://hbchen.com/about/</link>
      <pubDate>Sun, 20 Aug 2017 21:38:52 +0800</pubDate>
      
      <guid>http://hbchen.com/about/</guid>
      
        <description>

&lt;h2 id=&#34;hobo-s-blog&#34;&gt;Hobo&amp;rsquo;s Blog!&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;å¾®ä¿¡&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/wechat.jpg&#34; alt=&#34;å¾®ä¿¡&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;github-https-github-com-hb-chen&#34;&gt;&lt;a href=&#34;https://github.com/hb-chen&#34;&gt;GitHub&lt;/a&gt;&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/echo-web&#34;&gt;Echo å®è·µ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro&#34;&gt;go-microå®è·µ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/hb-go/micro-mesh&#34;&gt;Istioå¾®æœåŠ¡æ¶æ„å®è·µ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
      
    </item>
    
    <item>
      <title>ã€Flinkå®è·µã€‘å®æ—¶æ¶ˆè´¹é˜¿é‡Œäº‘SLSæ—¥å¿—&#43;è¾“å‡ºåˆ°ES</title>
      <link>http://hbchen.com/post/flink/2019-04-29-sls&#43;es/</link>
      <pubDate>Mon, 29 Apr 2019 18:42:22 +0800</pubDate>
      
      <guid>http://hbchen.com/post/flink/2019-04-29-sls&#43;es/</guid>
      
        <description>&lt;p&gt;æœ¬æ–‡ä»‹ç»Flinkåœ¨æµè®¡ç®—åœºæ™¯çš„ç®€å•åº”ç”¨ï¼Œå®æ—¶æ¶ˆè´¹SLSå†…çš„AccessLogï¼Œå¹¶å°†è®¡ç®—ç»“æœè¾“å‡ºåˆ°Elasticsearchã€‚&lt;/p&gt;

&lt;h2 id=&#34;ç¯å¢ƒ&#34;&gt;ç¯å¢ƒ&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;Flink

&lt;ul&gt;
&lt;li&gt;1.8&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;ES

&lt;ul&gt;
&lt;li&gt;6.3.2&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;å‡è®¾åœºæ™¯&#34;&gt;å‡è®¾åœºæ™¯&lt;/h2&gt;

&lt;p&gt;&lt;em&gt;æ—¥å¿—ç»“æ„&lt;/em&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;request_time: 1556415329
uri: /analysis/path?id=1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç³»ç»ŸAccessLogé€šè¿‡Logtaié‡‡é›†åˆ°é˜¿é‡Œäº‘SLSï¼ŒæŒ‡å®š&lt;code&gt;request_time&lt;/code&gt;ä¸ºæ—¥å¿—æ—¶é—´å­—æ®µã€‚ç¤ºä¾‹åœºæ™¯éœ€æ±‚ç»Ÿè®¡æŒ‡å®š&lt;code&gt;uri.path&lt;/code&gt;+&lt;code&gt;uri.query.id&lt;/code&gt;åˆ†ç»„ç»Ÿè®¡è®¿é—®è®¡æ•°ã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å®æ—¶æ¶ˆè´¹&lt;code&gt;SLS&lt;/code&gt;æ—¥å¿—&lt;/li&gt;
&lt;li&gt;ç­›é€‰&lt;code&gt;uri.path&lt;/code&gt;=&lt;code&gt;/analysis/path&lt;/code&gt;(&lt;em&gt;ç®€åŒ–åªç»Ÿè®¡å•ä¸ª&lt;code&gt;path&lt;/code&gt;ï¼Œå®é™…åœºæ™¯å¯èƒ½æ˜¯å¤šä¸ª&lt;code&gt;path&lt;/code&gt;çš„è®¿é—®ç»Ÿè®¡ï¼Œç›¸åº”çš„&lt;code&gt;key&lt;/code&gt;å‚æ•°è§„åˆ™ä¹Ÿä¼šä¸åŒ&lt;/em&gt;)&lt;/li&gt;
&lt;li&gt;è§£æ&lt;code&gt;uri.query&lt;/code&gt;å‚æ•°&lt;code&gt;id&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;åˆ›å»ºESç´¢å¼•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;PUT sls_analysis

PUT sls_analysis/_mapping/_doc
{
  &amp;quot;properties&amp;quot;: {
    &amp;quot;path&amp;quot;: {
      &amp;quot;type&amp;quot;: &amp;quot;text&amp;quot;
    },
    &amp;quot;key&amp;quot;: {
      &amp;quot;type&amp;quot;: &amp;quot;integer&amp;quot;
    },
    &amp;quot;count&amp;quot;: {
      &amp;quot;type&amp;quot;: &amp;quot;integer&amp;quot;
    },
    &amp;quot;timestamp&amp;quot;: {
      &amp;quot;type&amp;quot;:&amp;quot;long&amp;quot;
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æµç¨‹è§£æ&#34;&gt;æµç¨‹è§£æ&lt;/h2&gt;

&lt;p&gt;æ¥ä¸‹æ¥ç»“åˆ&lt;a href=&#34;https://github.com/hb-chen/flink-practice/tree/master/sls&#34;&gt;hb-chen/flink-practice&lt;/a&gt;æºç å¯¹æµç¨‹è¿›è¡Œè§£æã€‚&lt;/p&gt;

&lt;h3 id=&#34;gradleæ·»åŠ ä¾èµ–&#34;&gt;Gradleæ·»åŠ ä¾èµ–&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;    // ES
    flinkShadowJar &amp;quot;org.apache.flink:flink-connector-elasticsearch6_${scalaBinaryVersion}:${flinkVersion}&amp;quot;

    // SLS
    flinkShadowJar &amp;quot;com.aliyun.openservices:flink-log-connector:0.1.7&amp;quot;
    flinkShadowJar &amp;quot;com.aliyun.openservices:aliyun-log:0.6.19&amp;quot;
    flinkShadowJar &amp;quot;com.aliyun.openservices:log-loghub-producer:0.1.8&amp;quot;
    flinkShadowJar &amp;quot;com.google.protobuf:protobuf-java:2.5.0&amp;quot;
    
    // YAMLè§£æ
    flinkShadowJar &amp;quot;org.yaml:snakeyaml:1.24&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;å‚æ•°-é…ç½®-å¯å¿½ç•¥&#34;&gt;å‚æ•°&amp;amp;é…ç½®ï¼ˆå¯å¿½ç•¥ï¼‰&lt;/h3&gt;

&lt;p&gt;è™½ç„¶åªæ˜¯ç¤ºä¾‹è¿˜æ˜¯åšäº†&lt;code&gt;args&lt;/code&gt;å‚æ•°åŠ&lt;code&gt;config.yml&lt;/code&gt;é…ç½®çš„è·å–ï¼Œæ–¹ä¾¿é…ç½®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;public static void main(String[] args) throws Exception {
    final ParameterTool params = ParameterTool.fromArgs(args);
    String analysisPath = params.getRequired(&amp;quot;path&amp;quot;);
    String analysisQueryKey = params.get(&amp;quot;key&amp;quot;, &amp;quot;id&amp;quot;);
    LOG.info(&amp;quot;access log analysis path:&amp;quot; + analysisPath + &amp;quot; key:&amp;quot; + analysisQueryKey);

    Config config = getConfig();
    
    // â€¦â€¦
}

private static Config getConfig() {
    Constructor constructor = new Constructor(Config.class);
    org.yaml.snakeyaml.Yaml yaml = new org.yaml.snakeyaml.Yaml(constructor);

    Config config = yaml.loadAs(SlsAnalysis.class.getClassLoader().getResourceAsStream(&amp;quot;config.yml&amp;quot;), Config.class);
    return config;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;æ—¥å¿—æ¶ˆè´¹&#34;&gt;æ—¥å¿—æ¶ˆè´¹&lt;/h3&gt;

&lt;p&gt;é¦–å…ˆå‚è€ƒ&lt;a href=&#34;https://help.aliyun.com/document_detail/63594.html&#34;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;é€šè¿‡&lt;code&gt;SLS&lt;/code&gt;çš„å„ç§é…ç½®åˆ›å»ºä¸€ä¸ª&lt;code&gt;Consumer&lt;/code&gt;ï¼Œè·å¾—&lt;code&gt;SLS&lt;/code&gt;æ—¥å¿—æµ&lt;code&gt;DataStream&amp;lt;RawLogGroupList&amp;gt; logStream&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;    // SLSæ¶ˆè´¹
    // https://help.aliyun.com/document_detail/63594.html
    Properties configProps = new Properties();
    // è®¾ç½®è®¿é—®æ—¥å¿—æœåŠ¡çš„åŸŸå
    configProps.put(ConfigConstants.LOG_ENDPOINT, config.getSls().getEndpoint());
    // è®¾ç½®è®¿é—®ak
    configProps.put(ConfigConstants.LOG_ACCESSSKEYID, config.getSls().getAk());
    configProps.put(ConfigConstants.LOG_ACCESSKEY, config.getSls().getSk());
    // è®¾ç½®æ—¥å¿—æœåŠ¡çš„project
    configProps.put(ConfigConstants.LOG_PROJECT, config.getSls().getProject());
    // è®¾ç½®æ—¥å¿—æœåŠ¡çš„Logstore
    configProps.put(ConfigConstants.LOG_LOGSTORE, config.getSls().getLogStore());
    // è®¾ç½®æ¶ˆè´¹æ—¥å¿—æœåŠ¡èµ·å§‹ä½ç½®
    configProps.put(ConfigConstants.LOG_CONSUMER_BEGIN_POSITION, &amp;quot;&amp;quot; + (System.currentTimeMillis() / 1000L));
    // è®¾ç½®æ—¥å¿—æ‹‰å–æ—¶é—´é—´éš”åŠæ¯æ¬¡è°ƒç”¨æ‹‰å–çš„æ—¥å¿—æ•°é‡
    configProps.put(ConfigConstants.LOG_FETCH_DATA_INTERVAL_MILLIS, &amp;quot;1000&amp;quot;);
    configProps.put(ConfigConstants.LOG_MAX_NUMBER_PER_FETCH, &amp;quot;100&amp;quot;);
    // è®¾ç½®Shardså‘ç°å‘¨æœŸ
    configProps.put(ConfigConstants.LOG_SHARDS_DISCOVERY_INTERVAL_MILLIS, Consts.DEFAULT_SHARDS_DISCOVERY_INTERVAL_MILLIS);

    // è®¾ç½®æ—¥å¿—æœåŠ¡çš„æ¶ˆæ¯ååºåˆ—åŒ–æ–¹æ³•
    RawLogGroupListDeserializer deserializer = new RawLogGroupListDeserializer();
    final StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
    DataStream&amp;lt;RawLogGroupList&amp;gt; logStream = env.addSource(new FlinkLogConsumer&amp;lt;RawLogGroupList&amp;gt;(deserializer, configProps));
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é€šè¿‡&lt;code&gt;RawLogGroupList&lt;/code&gt;ç»“æ„çŸ¥é“&lt;code&gt;logStream&lt;/code&gt;è·å¾—çš„æ˜¯æ‰¹é‡çš„&lt;code&gt;SLS&lt;/code&gt;æ—¥å¿—ï¼Œå•æ¡æ—¥å¿—æ˜¯åˆ†ç»„çš„&lt;code&gt;RawLog&lt;/code&gt;åˆ—è¡¨ï¼Œè¿™å°±éœ€è¦é¦–å…ˆå¯¹æ‰¹é‡çš„æ•°æ®è¿›è¡Œå±•å¼€(&lt;code&gt;flatMap()&lt;/code&gt;)æ¥è·å¾—å•æ¡æ•°æ®æµ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;public class RawLogGroupList implements Serializable {
    public List&amp;lt;RawLogGroup&amp;gt; rawLogGroups = new ArrayList();
}

public class RawLogGroup implements Serializable {
    public String source;
    public String topic = &amp;quot;&amp;quot;;
    public Map&amp;lt;String, String&amp;gt; tags = new HashMap();
    public List&amp;lt;RawLog&amp;gt; logs = new ArrayList();
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;æ‰¹é‡æ—¥å¿—å±•å¼€&#34;&gt;æ‰¹é‡æ—¥å¿—å±•å¼€&lt;/h3&gt;

&lt;p&gt;è¿™æ˜¯æ•´ä¸ªè¿‡æµç¨‹æœ€å…³é”®çš„ä¸€ç¯ï¼Œè¿™é‡Œè¦å®šä¹‰å±•å¼€åæ•°æ®æµçš„ç»“æ„ï¼Œä¸å•°å—¦ç›´æ¥çœ‹ç»“æ„&lt;code&gt;Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&lt;/code&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;f0&lt;/code&gt;:&lt;code&gt;AccessLogAnalysis&lt;/code&gt;æ˜¯è§£æ&lt;code&gt;uri&lt;/code&gt;çš„&lt;code&gt;path&lt;/code&gt;+&lt;code&gt;key&lt;/code&gt;çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¦ç”¨åš&lt;code&gt;keyBy&lt;/code&gt;çš„å±æ€§&lt;/li&gt;
&lt;li&gt;&lt;code&gt;f1&lt;/code&gt;:&lt;code&gt;Integer&lt;/code&gt;ç»Ÿè®¡æ•°é‡ï¼Œå•æ¡æ—¥å¿—å…¨è®¡ä¸º1(&lt;em&gt;æ ¹æ®éœ€æ±‚è¿™é‡Œå¯ä»¥è€ƒäº›ä¼˜åŒ–ï¼Œæ¯”å¦‚Groupå†…æœ‰åºå¯ä»¥åœ¨rangeè¿‡ç¨‹ç›´æ¥å¯¹ç›¸åŒ&lt;code&gt;request_time&lt;/code&gt;åšèšåˆ&lt;/em&gt;)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;f2&lt;/code&gt;:&lt;code&gt;Long&lt;/code&gt;æ—¥å¿—æ—¶é—´æˆ³ï¼Œè€ƒè™‘åç»­ä½œä¸º&lt;code&gt;EventTime&lt;/code&gt;ä½¿ç”¨ï¼Œæ‰€ä»¥å°†&lt;code&gt;request_time&lt;/code&gt;è½¬ä¸ºæ¯«ç§’&lt;/li&gt;
&lt;li&gt;&lt;code&gt;f3&lt;/code&gt;:&lt;code&gt;Long&lt;/code&gt;æ‰¹é‡æ—¥å¿—çš„æœ€å°æ—¶é—´æˆ³ï¼Œå› ä¸º&lt;code&gt;SLS&lt;/code&gt;æ—¥å¿—æ˜¯æ—¶é—´æœ‰åºçš„ï¼Œä¸”å•ä¸ª&lt;code&gt;RawLogGroup&lt;/code&gt;æ—¥å¿—å‡åºï¼Œæ‰€ä»¥è‡ªç„¶çš„è€ƒè™‘ä½¿ç”¨æœ€å°æ—¶é—´æˆ³ä½œä¸º&lt;code&gt;watermark&lt;/code&gt;ï¼Œè¿™æ ·ä¹Ÿé¿å…äº†&lt;strong&gt;arrive late&lt;/strong&gt;çš„å‡ºç°&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;    // SLSæ‰¹é‡æ—¥å¿—å±•å¼€
    DataStream&amp;lt;Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&amp;gt; flatStream = logStream.flatMap(new FlatMapFunction&amp;lt;RawLogGroupList, Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&amp;gt;() {
        @Override
        public void flatMap(RawLogGroupList value, Collector&amp;lt;Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&amp;gt; out) throws Exception {
            // Log groupå†…æ—¶é—´å‡åºï¼Œè®°å½•æ‰€æœ‰åˆ†ç»„æœ€å°æ—¶é—´æˆ³ï¼Œå³ä¸ºwatermarkä½ç½®
            long minTimestamp = Long.MAX_VALUE;
            for (RawLogGroup group : value.getRawLogGroups()) {
                if (group.getLogs().size() &amp;gt; 0) {
                    RawLog log = group.getLogs().get(0);
                    long rt = Optional.ofNullable(log.getContents().get(&amp;quot;request_time&amp;quot;)).map(Long::new).orElse(Long.MAX_VALUE);
                    minTimestamp = rt &amp;lt; minTimestamp ? rt : minTimestamp;
                }
            }
            // å–æ¯«ç§’ï¼Œæ’é™¤MAX_VALUE
            minTimestamp = minTimestamp == Long.MAX_VALUE ? minTimestamp : minTimestamp * 1000;

            Integer count = 0;
            for (RawLogGroup group : value.getRawLogGroups()) {
                count += group.getLogs().size();
                for (RawLog log : group.getLogs()) {
                    // URIè§£æ
                    QueryStringDecoder decoder = new QueryStringDecoder(log.getContents().get(&amp;quot;uri&amp;quot;));
                    String path = decoder.path();
                    List&amp;lt;String&amp;gt; keyList = decoder.parameters().get(analysisQueryKey);
                    if (path.equalsIgnoreCase(analysisPath) &amp;amp;&amp;amp; keyList != null &amp;amp;&amp;amp; keyList.size() &amp;gt; 0) {
                        Integer id = Optional.ofNullable(keyList.get(0)).map(Integer::new).orElse(0);
                        AccessLogAnalysis ala = new AccessLogAnalysis();
                        ala.setKey(id);
                        ala.setPath(path);

                        Long timestamp = Optional.ofNullable(log.getContents().get(&amp;quot;request_time&amp;quot;)).map(Long::new).orElse(0L);
                        timestamp *= 1000;

                        out.collect(new Tuple4&amp;lt;&amp;gt;(ala, 1, timestamp, minTimestamp));
                    }

                }
            }
            LOG.info(&amp;quot;raw log count:&amp;quot; + count + &amp;quot; timestamp:&amp;quot; + minTimestamp);
        }
    });
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;eventtime-timewindow&#34;&gt;EventTime &amp;amp; timeWindow&lt;/h3&gt;

&lt;p&gt;æœ‰äº†&lt;code&gt;flatStream&lt;/code&gt;çš„ç»“æœï¼Œè‡ªå®šä¹‰&lt;code&gt;EventTime&lt;/code&gt;ä»¥åŠ&lt;code&gt;Watermark&lt;/code&gt;å°±æ¯”è¾ƒç®€å•ã€‚&lt;br/&gt;&lt;code&gt;.keyBy(0).timeWindow(Time.seconds(60)).sum(1)&lt;/code&gt;æµç¨‹ä»¥&lt;code&gt;f0&lt;/code&gt;ä¸º&lt;code&gt;key&lt;/code&gt;åˆ†éš”ï¼Œ60sä¸ºæ—¶é—´çª—å£å¯¹&lt;code&gt;f1&lt;/code&gt;æ±‚å’Œã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;DataStream result = flatStream.assignTimestampsAndWatermarks(new AssignerWithPunctuatedWatermarks&amp;lt;Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&amp;gt;() {
    @Nullable
    @Override
    public Watermark checkAndGetNextWatermark(Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt; lastElement, long extractedTimestamp) {
        return lastElement.f3 &amp;lt;= extractedTimestamp ? new Watermark(lastElement.f3) : null;
    }

    @Override
    public long extractTimestamp(Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt; element, long previousElementTimestamp) {
        if (element.f2 &amp;gt; 0L) {
            return element.f2;
        } else {
            return previousElementTimestamp;
        }
    }
})
.keyBy(0)
.timeWindow(Time.seconds(60))
.sum(1);
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;è¾“å‡ºåˆ°es&#34;&gt;è¾“å‡ºåˆ°ES&lt;/h3&gt;

&lt;p&gt;å¤§è‡´å‚è€ƒ&lt;a href=&#34;https://ci.apache.org/projects/flink/flink-docs-release-1.8/dev/connectors/elasticsearch.html&#34;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;å³å¯ï¼Œ
åªæ˜¯æ²¡æœ‰è®¤è¯(&lt;em&gt;ç”Ÿäº§ç¯å¢ƒå¿…ä¸å¯å°‘ï¼Œæƒ³åˆ°ESç¤¾åŒºçš„åˆ†äº«ï¼Œåœ¨&lt;a href=&#34;https://www.shodan.io&#34;&gt;shodan.io&lt;/a&gt;ä¸Šæ‰¾å„ç§å…¬å¼€å…è´¹ESèµ„æºğŸ˜&lt;/em&gt;)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;// Sink:Elasticsearch
List&amp;lt;HttpHost&amp;gt; httpHosts = new ArrayList&amp;lt;&amp;gt;();
httpHosts.add(new HttpHost(config.getEs().getHostname(), 9200, &amp;quot;http&amp;quot;));

// use a ElasticsearchSink.Builder to create an ElasticsearchSink
ElasticsearchSink.Builder&amp;lt;Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&amp;gt; esSinkBuilder = new ElasticsearchSink.Builder&amp;lt;&amp;gt;(httpHosts, new ElasticsearchSinkFunction&amp;lt;Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt;&amp;gt;() {
    public IndexRequest createIndexRequest(Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt; element) {
        Map&amp;lt;String, String&amp;gt; json = new HashMap&amp;lt;&amp;gt;();
        json.put(&amp;quot;path&amp;quot;, element.f0.getPath());
        json.put(&amp;quot;key&amp;quot;, element.f0.getKey().toString());
        json.put(&amp;quot;count&amp;quot;, element.f1.toString());
        json.put(&amp;quot;timestamp&amp;quot;, element.f3.toString());

        return Requests.indexRequest().index(&amp;quot;sls_analysis&amp;quot;).type(&amp;quot;_doc&amp;quot;).source(json);
    }

    @Override
    public void process(Tuple4&amp;lt;AccessLogAnalysis, Integer, Long, Long&amp;gt; element, RuntimeContext runtimeContext, RequestIndexer requestIndexer) {
        requestIndexer.add(createIndexRequest(element));
    }
});

// configuration for the bulk requests; this instructs the sink to emit after every element, otherwise they would be buffered
esSinkBuilder.setBulkFlushMaxActions(1);

// provide a RestClientFactory for custom configuration on the internally created REST client
String esUsername = config.getEs().getUsername();
String esPassword = config.getEs().getPassword();
esSinkBuilder.setRestClientFactory(restClientBuilder -&amp;gt; {
    // restClientBuilder.setDefaultHeaders(headers);
    // restClientBuilder.setMaxRetryTimeoutMillis(...)
    // restClientBuilder.setPathPrefix(...)
    restClientBuilder.setHttpClientConfigCallback(new RestClientBuilder.HttpClientConfigCallback() {
        @Override
        public HttpAsyncClientBuilder customizeHttpClient(HttpAsyncClientBuilder httpAsyncClientBuilder) {
            CredentialsProvider credentialsProvider = new BasicCredentialsProvider();
            credentialsProvider.setCredentials(AuthScope.ANY, new UsernamePasswordCredentials(esUsername, esPassword));
            return httpAsyncClientBuilder.setDefaultCredentialsProvider(credentialsProvider);
        }
    });
});

// finally, build and add the sink to the job&#39;s pipeline
result.addSink(esSinkBuilder.build());
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡Œè¿˜é‡åˆ°ä¸ªå°å‘ï¼ˆJavaä¸¢çš„å¤ªä¹…äº†ğŸ˜‚ï¼‰ï¼Œåœ¨&lt;code&gt;UsernamePasswordCredentials()&lt;/code&gt;ä¸­ç›´æ¥ä½¿ç”¨&lt;code&gt;config.getEs().getUsername()&lt;/code&gt; &lt;code&gt;config.getEs().getPassword()&lt;/code&gt;ï¼Œå¯¼è‡´åºåˆ—åŒ–é”™è¯¯ï¼Œç›¸å…³å‚è€ƒ&lt;a href=&#34;https://yuzhouwan.com/posts/20644/&#34;&gt;Apache Flink#è¸©è¿‡çš„å‘&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;Exception in thread &amp;quot;main&amp;quot; org.apache.flink.api.common.InvalidProgramException: The implementation of the ElasticsearchSinkBase is not serializable. The object probably contains or references non serializable fields.
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;æµ‹è¯•-æ‰“åŒ…&#34;&gt;æµ‹è¯• &amp;amp; æ‰“åŒ…&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# æµ‹è¯•
$ ./gradlew sls:run --args=&amp;quot;--path /analysis/path&amp;quot;

# æ‰“åŒ…
$ ./gradlew clean sls:shadowJar
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;æäº¤jobåˆ°flinkè¿è¡Œ&#34;&gt;æäº¤Jobåˆ°Flinkè¿è¡Œ&lt;/h3&gt;

&lt;p&gt;ä¸Šä¼ &lt;code&gt;.jar&lt;/code&gt;åˆ°Flink&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;Program Arguments
--path /analysis/path
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/hb-chen/hbchen.com/master/static/img/flink/sls+es-dashboard.png&#34; alt=&#34;auth-adapter&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;åˆ°kibanaçœ‹ä¸‹ç»“æœ&#34;&gt;åˆ°Kibanaçœ‹ä¸‹ç»“æœ&lt;/h3&gt;

&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/hb-chen/hbchen.com/master/static/img/flink/sls+es-kibana.png&#34; alt=&#34;auth-adapter&#34; /&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;GET /sls_analysis/_search
{
  &amp;quot;aggs&amp;quot;: {
    &amp;quot;2&amp;quot;: {
      &amp;quot;terms&amp;quot;: {
        &amp;quot;field&amp;quot;: &amp;quot;key&amp;quot;,
        &amp;quot;size&amp;quot;: 20,
        &amp;quot;order&amp;quot;: {
          &amp;quot;1&amp;quot;: &amp;quot;desc&amp;quot;
        }
      },
      &amp;quot;aggs&amp;quot;: {
        &amp;quot;1&amp;quot;: {
          &amp;quot;sum&amp;quot;: {
            &amp;quot;field&amp;quot;: &amp;quot;count&amp;quot;
          }
        }
      }
    }
  },
  &amp;quot;size&amp;quot;: 0,
  &amp;quot;_source&amp;quot;: {
    &amp;quot;excludes&amp;quot;: []
  },
  &amp;quot;stored_fields&amp;quot;: [
    &amp;quot;*&amp;quot;
  ],
  &amp;quot;script_fields&amp;quot;: {},
  &amp;quot;docvalue_fields&amp;quot;: [],
  &amp;quot;query&amp;quot;: {
    &amp;quot;bool&amp;quot;: {
      &amp;quot;must&amp;quot;: [
        {
          &amp;quot;match_all&amp;quot;: {}
        },
        {
          &amp;quot;match_phrase&amp;quot;: {
            &amp;quot;path&amp;quot;: {
              &amp;quot;query&amp;quot;: &amp;quot;/analysis/path&amp;quot;
            }
          }
        }
      ],
      &amp;quot;filter&amp;quot;: [],
      &amp;quot;should&amp;quot;: [],
      &amp;quot;must_not&amp;quot;: []
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Istioå®‰å…¨ã€‘ç½‘æ ¼è¾¹ç¼˜-Egress</title>
      <link>http://hbchen.com/post/servicemesh/2019-04-11-istio-security-egress/</link>
      <pubDate>Sun, 14 Apr 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/servicemesh/2019-04-11-istio-security-egress/</guid>
      
        <description>&lt;p&gt;æ¥ä¸Šä¸€ç¯‡ã€Š&lt;a href=&#34;http://hbchen.com/post/servicemesh/2019-03-09-istio-rbac-quick-start/&#34;&gt;ã€Istioå®‰å…¨ã€‘æœåŠ¡é—´è®¿é—®æ§åˆ¶-RBAC&lt;/a&gt;ã€‹ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»ç½‘æ ¼è¾¹ç¼˜Egressç›¸å…³çš„é…ç½®ï¼Œ&lt;code&gt;HTTP&lt;/code&gt;ã€&lt;code&gt;HTTPS&lt;/code&gt;ä»¥åŠ&lt;code&gt;HTTP&lt;/code&gt;è½¬&lt;code&gt;TLS&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Istioç‰ˆæœ¬ &lt;strong&gt;1.1.1&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;å¼€å§‹å‰çš„å‡†å¤‡&#34;&gt;å¼€å§‹å‰çš„å‡†å¤‡&lt;/h2&gt;

&lt;blockquote&gt;
&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;  # Set the default behavior of the sidecar for handling outbound traffic from the application:
  # ALLOW_ANY - outbound traffic to unknown destinations will be allowed, in case there are no
  #   services or ServiceEntries for the destination port
  # REGISTRY_ONLY - restrict outbound traffic to services defined in the service registry as well
  #   as those defined through ServiceEntries
  # ALLOW_ANY is the default in 1.1.  This means each pod will be able to make outbound requests 
  # to services outside of the mesh without any ServiceEntry.
  # REGISTRY_ONLY was the default in 1.0.  If this behavior is desired, set the value below to REGISTRY_ONLY.
  outboundTrafficPolicy:
    mode: ALLOW_ANY
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;p&gt;Istioéƒ¨ç½²é…ç½®çš„&lt;code&gt;global.outboundTrafficPolicy&lt;/code&gt;å‚æ•°ï¼Œåœ¨1.1å¼€å§‹é»˜è®¤&lt;code&gt;ALLOW_ANY&lt;/code&gt;ï¼Œè¿™ç§æƒ…å†µä¸‹å¦‚æœä¸é…ç½®&lt;code&gt;ServiceEntry&lt;/code&gt;ï¼Œè®¿é—®å¤–åŒ…HTTPæµé‡è¿”å›&lt;code&gt;404&lt;/code&gt;ï¼Œè€ŒHTTPSæµé‡å¯ä»¥æ­£å¸¸è®¿é—®ï¼Œä¸ºäº†æµ‹è¯•&lt;code&gt;ServiceEntry&lt;/code&gt;é…ç½®æ•ˆæœï¼Œå°†é…ç½®æ”¹ä¸º&lt;code&gt;REGISTRY_ONLY&lt;/code&gt;ï¼Œæ–¹ä¾¿è§‚å¯Ÿ&lt;code&gt;ServiceEntry&lt;/code&gt;é…ç½®çš„æ•ˆæœ&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;æœ¬æ–‡ç¤ºä¾‹Istioä½¿ç”¨helmçš„values-istio-demo.yamlé…ç½®å®‰è£…&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;éƒ¨ç½²æµ‹è¯•ç”¨ä¾‹&lt;code&gt;sleep&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.1/samples/sleep/sleep.yaml

$ export SOURCE_POD=$(kubectl get pod -l app=sleep -o jsonpath={.items..metadata.name})
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;code&gt;outboundTrafficPolicy=ALLOW_ANY&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://hbchen.com
HTTP/1.1 404 Not Found

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://www.aliyun.com
HTTP/1.1 404 Not Found

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - https://www.aliyun.com
HTTP/2 200
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¿®æ”¹&lt;code&gt;values-istio-demo.yaml&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;  outboundTrafficPolicy:
    mode: REGISTRY_ONLY
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é‡æ–°éƒ¨ç½²Istio&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ helm template install/kubernetes/helm/istio --name istio --namespace istio-system --values install/kubernetes/helm/istio/values-istio-demo.yaml | kubectl apply -f -
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é‡æ–°éƒ¨ç½²æµ‹è¯•ç”¨ä¾‹&lt;code&gt;sleep&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl delete -f https://raw.githubusercontent.com/istio/istio/release-1.1/samples/sleep/sleep.yaml
$ kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.1/samples/sleep/sleep.yaml

$ export SOURCE_POD=$(kubectl get pod -l app=sleep -o jsonpath={.items..metadata.name})
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;sidecaræ–¹å¼&#34;&gt;Sidecaræ–¹å¼&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/hb-chen/hbchen.com/master/static/img/istio/egress-sidecar.png&#34; alt=&#34;ServiceEntry&#34; /&gt;&lt;/p&gt;

&lt;h3 id=&#34;http&#34;&gt;HTTP&lt;/h3&gt;

&lt;p&gt;å…ˆå®šä¹‰ä¸€ä¸ª&lt;code&gt;ServiceEntry&lt;/code&gt;ï¼Œå¼€å¯&lt;code&gt;www.aliyun.com&lt;/code&gt;ã€&lt;code&gt;hbchen.com&lt;/code&gt;çš„å¤–éƒ¨è®¿é—®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;$ kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: entry-x
spec:
  hosts:
  - www.aliyun.com
  - hbchen.com
  ports:
  - number: 80
    name: http
    protocol: HTTP
  resolution: NONE
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://hbchen.com
HTTP/1.1 200 OK

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://www.aliyun.com
HTTP/1.1 301 Moved Permanently
...
command terminated with exit code 35

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - https://www.aliyun.com
command terminated with exit code 35
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;http-https&#34;&gt;HTTP &amp;amp; HTTPS&lt;/h3&gt;

&lt;p&gt;åªå¼€&lt;code&gt;80&lt;/code&gt;ç«¯å£ï¼Œ&lt;code&gt;HTTP&lt;/code&gt;æ­£å¸¸ï¼Œè€Œå¯¹äº&lt;code&gt;HTTPS&lt;/code&gt;ä»¥åŠæœ‰&lt;code&gt;HTTP&lt;/code&gt;é‡å®šå‘&lt;code&gt;HTTPS&lt;/code&gt;çš„è¯·æ±‚ä»ä¼šå¤±è´¥&lt;code&gt;command terminated with exit code 35&lt;/code&gt;ï¼Œæ‰€ä»¥å®è·µä¸­å¤–éƒ¨æœåŠ¡ä¸€èˆ¬åŒæ—¶å¼€å¯&lt;code&gt;80&lt;/code&gt;ã€&lt;code&gt;443&lt;/code&gt;ç«¯å£&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;$ kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: entry-x
spec:
  hosts:
  - www.aliyun.com
  - hbchen.com
  ports:
  - number: 80
    name: http-port
    protocol: HTTP
  - number: 443
    name: https-port
    protocol: HTTPS
  resolution: NONE
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://www.aliyun.com
HTTP/1.1 301 Moved Permanently
...
HTTP/2 200

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - https://www.aliyun.com
HTTP/2 200
...
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;httpè½¬tls&#34;&gt;HTTPè½¬TLS&lt;/h3&gt;

&lt;p&gt;è¿™æ—¶æˆ‘ä»¬çœ‹åˆ°å¦ä¸€ä¸ªé—®é¢˜ï¼Œéœ€è¦å‡çº§&lt;code&gt;HTTPS&lt;/code&gt;çš„&lt;code&gt;HTTP&lt;/code&gt;è¯·æ±‚æ¯æ¬¡éƒ½è¦&lt;code&gt;301&lt;/code&gt;é‡å®šå‘ä¸€æ¬¡ï¼Œåœ¨ä¸ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹å¯ä»¥åœ¨&lt;code&gt;proxy&lt;/code&gt;å°†&lt;code&gt;HTTP&lt;/code&gt;è¯·æ±‚å‡çº§ä¸º&lt;code&gt;TLS&lt;/code&gt;ï¼Œé¿å…äºŒæ¬¡è·³è½¬ï¼Œéœ€è¦åŠ &lt;code&gt;VirtualService&lt;/code&gt; + &lt;code&gt;DestinationRule&lt;/code&gt;æ¥å®ç°ã€‚&lt;/p&gt;

&lt;p&gt;åœ¨å®˜æ–¹ç¤ºä¾‹&lt;a href=&#34;https://istio.io/zh/docs/examples/advanced-gateways/egress-tls-origination/#%E5%87%BA%E5%8F%A3%E6%B5%81%E9%87%8F%E7%9A%84-tls&#34;&gt;å‡ºå£æµé‡çš„-tls&lt;/a&gt;ä¸­ï¼Œä»…å°†&lt;code&gt;HTTP&lt;/code&gt;å‡çº§åˆ°&lt;code&gt;TLS&lt;/code&gt;ï¼Œè€Œå¯¹æ­£å¸¸çš„&lt;code&gt;HTTPS&lt;/code&gt;æ²¡æœ‰æ”¯æŒï¼Œè¿™é‡Œç¨ä½œæ”¹åŠ¨ï¼Œåœ¨&lt;code&gt;VirtualService&lt;/code&gt;ä¸­ä¸º&lt;code&gt;80&lt;/code&gt;ç«¯å£çš„&lt;code&gt;destination&lt;/code&gt;å®šä¹‰&lt;code&gt;subset&lt;/code&gt;ï¼Œè¿™æ ·åœ¨&lt;code&gt;DestinationRule&lt;/code&gt;ä¸­é»˜è®¤&lt;code&gt;trafficPolicy&lt;/code&gt;ä¸åšå¤„ç†ï¼Œä»…å¯¹æŒ‡å®šçš„&lt;code&gt;subset&lt;/code&gt;åš&lt;code&gt;HTTPS&lt;/code&gt;è½¬å‘ï¼Œä½¿ç½‘æ ¼å†…æ— è®ºå‘èµ·&lt;code&gt;HTTP&lt;/code&gt;è¿˜æ˜¯&lt;code&gt;HTTPS&lt;/code&gt;çš„å¤–ç½‘è¯·æ±‚éƒ½å¯ä»¥æ­£å¸¸è®¿é—®ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: entry-x
spec:
  hosts:
  - www.aliyun.com
  - hbchen.com
  ports:
  - number: 80
    name: http-port
    protocol: HTTP
  - number: 443
    name: https-port
    protocol: HTTPS
  resolution: DNS
  location: MESH_EXTERNAL
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: rewrite-port-for-entry
spec:
  hosts:
  - www.aliyun.com
  http:
  - match:
      - port: 80
    route:
    - destination:
        # NOTE: ä¸ºHTTPå‡çº§æµé‡æŒ‡å®šsubset
        subset: originate-tls
        host: www.aliyun.com
        port:
          number: 443
  tls:
  - match:
      - port: 443
        sniHosts:
        - www.aliyun.com
    route:
    - destination:
        host: www.aliyun.com
        port:
          number: 443
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: originate-tls-for-entry
spec:
  host: www.aliyun.com
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
  subsets:
    - name: originate-tls
      trafficPolicy:
        loadBalancer:
          simple: ROUND_ROBIN
        portLevelSettings:
        - port:
            number: 443
          tls:
            mode: SIMPLE
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://hbchen.com
HTTP/1.1 200 OK

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://www.aliyun.com
HTTP/1.1 200 OK

$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - https://www.aliyun.com
HTTP/2 200
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;gatewayæ–¹å¼&#34;&gt;Gatewayæ–¹å¼&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/hb-chen/hbchen.com/master/static/img/istio/egress-gateway.png&#34; alt=&#34;ServiceEntry&#34; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å®˜æ–¹ç¤ºä¾‹&lt;a href=&#34;https://istio.io/zh/docs/examples/advanced-gateways/egress-gateway/&#34;&gt;é…ç½® Egress gateway&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Gatewayä¸Sidecarçš„åŒºåˆ«æ˜¯å°†å‡ºå£æµé‡éƒ½è½¬åˆ°&lt;code&gt;egressgateway&lt;/code&gt;ï¼Œå†ç”±Gatewayè¿›è¡Œè½¬å‘å¤„ç†ï¼Œæ— è®ºGatewayè¿˜æ˜¯Sidecar&lt;code&gt;ServiceEntry&lt;/code&gt;çš„é…ç½®è§„åˆ™éƒ½æ˜¯éœ€è¦çš„ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥å¼€å¯&lt;code&gt;80&lt;/code&gt;ã€&lt;code&gt;433&lt;/code&gt;ï¼Œæ³¨æ„&lt;code&gt;resolution&lt;/code&gt;=&lt;code&gt;DNS&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: entry-x
spec:
  hosts:
  - www.aliyun.com
  ports:
  - number: 80
    name: http-port
    protocol: HTTP
  - number: 443
    name: https-port
    protocol: HTTPS
  resolution: DNS
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;em&gt;è®¿é—®æµ‹è¯•ï¼ˆç•¥ï¼‰&lt;/em&gt;&lt;/p&gt;

&lt;h3 id=&#34;http-1&#34;&gt;HTTP&lt;/h3&gt;

&lt;p&gt;æµç¨‹å¦‚ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-mermaid&#34;&gt;graph LR;
   S[Siedcar]--&amp;gt;|&amp;quot;â‘ HTTP&amp;quot;|VS[VirtualService&amp;lt;br/&amp;gt;www.aliyun.com]
   VS--&amp;gt;|&amp;quot;â‘¡gateway=mesh&amp;quot;|EG[EgressGateway]
   EG--&amp;gt;|&amp;quot;â‘¢HTTP&amp;quot;|VS
   VS--&amp;gt;|&amp;quot;â‘£gateway=istio-egressgateway&amp;quot;|E[External]
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: istio-egressgateway
spec:
  selector:
    istio: egressgateway
  servers:
  - port:
      number: 80
      name: http-port
      protocol: HTTP
    hosts:
    - www.aliyun.com
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: egressgateway-for-aliyun
spec:
  host: istio-egressgateway.istio-system.svc.cluster.local
  subsets:
  - name: aliyun
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: aliyun-through-egress-gateway
spec:
  hosts:
  - www.aliyun.com
  gateways:
  - istio-egressgateway
  - mesh
  http:
  - match:
    - gateways:
      - mesh
      port: 80
    route:
    - destination:
        host: istio-egressgateway.istio-system.svc.cluster.local
        subset: aliyun
        port:
          number: 80
      weight: 100
  - match:
    - gateways:
      - istio-egressgateway
      port: 80
    route:
    - destination:
        host: www.aliyun.com
        port:
          number: 80
      weight: 100
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;(&lt;em&gt;è¿™é‡Œåªæœ‰HTTP&lt;/em&gt;)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://www.aliyun.com
HTTP/1.1 301 Moved Permanently
...
HTTP/2 200
...
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;httpè½¬tls-1&#34;&gt;HTTPè½¬TLS&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-mermaid&#34;&gt;graph LR;
   S[Siedcar]--&amp;gt;|&amp;quot;â‘ HTTP&amp;quot;|VS[VirtualService&amp;lt;br/&amp;gt;www.aliyun.com]
   VS--&amp;gt;|&amp;quot;â‘¡gateway=mesh&amp;quot;|EG[EgressGateway]
   EG--&amp;gt;|&amp;quot;â‘¢HTTP&amp;quot;|VS
   VS--&amp;gt;|&amp;quot;â‘£gateway=istio-egressgateway&amp;lt;br/&amp;gt;DestinationRuleä¸ºSubsetå‡çº§TLS&amp;quot;|E[External]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸Sidecaræ–¹å¼ç±»ä¼¼ï¼Œå¯¹äºæœ‰&lt;code&gt;HTTP&lt;/code&gt;é‡å®šå‘åˆ°&lt;code&gt;HTTPS&lt;/code&gt;çš„æµé‡å¯ä»¥åœ¨Gatewayä»£ç†ç›´æ¥å‡çº§ä¸º&lt;code&gt;TLS&lt;/code&gt;ï¼Œå‡å°‘è·³è½¬ï¼Œå®ç°æ–¹å¼ä¸Sidecaræ–¹å¼ç±»ä¼¼ï¼Œä¸º&lt;code&gt;HOST&lt;/code&gt;å¢åŠ &lt;code&gt;DestinationRule&lt;/code&gt;è§„åˆ™ä¸º&lt;code&gt;HTTP&lt;/code&gt;æµé‡å‘èµ·&lt;code&gt;TLS&lt;/code&gt;è¯·æ±‚ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;kubectl apply -f - &amp;lt;&amp;lt;EOF
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: istio-egressgateway
spec:
  selector:
    istio: egressgateway
  servers:
  - port:
      number: 80
      name: http-port
      protocol: HTTP
    hosts:
    - www.aliyun.com
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: egressgateway-for-aliyun
spec:
  host: istio-egressgateway.istio-system.svc.cluster.local
  subsets:
  - name: aliyun
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: aliyun-through-egress-gateway
spec:
  hosts:
  - www.aliyun.com
  gateways:
  - istio-egressgateway
  - mesh
  http:
  - match:
    - gateways:
      - mesh
      port: 80
    route:
    - destination:
        host: istio-egressgateway.istio-system.svc.cluster.local
        subset: aliyun
        port:
          number: 80
      weight: 100
  - match:
    - gateways:
      - istio-egressgateway
      port: 80
    route:
    - destination:
        host: www.aliyun.com
        # NOTE: ä¸ºHTTPå‡çº§æµé‡æŒ‡å®šsubset
        subset: originate-tls
        port:
          number: 443
      weight: 100
---
# NOTE: æ³¨æ„è¿™é‡Œä¸Sidecaræ–¹å¼ç±»ä¼¼ï¼Œéœ€è¦å¯¹HTTPæµé‡å•ç‹¬é…ç½®subsetï¼Œå¦åˆ™å½±å“æ­£å¸¸HTTPSæµé‡
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: originate-tls-for-aliyun
spec:
  host: www.aliyun.com
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
  subsets:
    - name: originate-tls
      trafficPolicy:
        loadBalancer:
          simple: ROUND_ROBIN
        portLevelSettings:
        - port:
            number: 443
          tls:
            mode: SIMPLE
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;è®¿é—®æµ‹è¯•&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ kubectl exec -it $SOURCE_POD -c sleep -- curl -sL -o /dev/null -D - http://www.aliyun.com
HTTP/1.1 200 OK
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;åŒå‘&lt;code&gt;TLS&lt;/code&gt;ã€&lt;code&gt;HTTTPS&lt;/code&gt;é€ä¼ ç­‰è¿™é‡Œæ²¡æœ‰å†åšæµ‹è¯•ï¼Œæœ‰å…´è¶£å¯ä»¥å‚è€ƒå®˜æ–¹ç¤ºä¾‹&lt;a href=&#34;https://istio.io/zh/docs/examples/advanced-gateways/egress-gateway/&#34;&gt;é…ç½® Egress gateway&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;ç›´æ¥è°ƒç”¨å¤–éƒ¨æœåŠ¡&#34;&gt;ç›´æ¥è°ƒç”¨å¤–éƒ¨æœåŠ¡&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/hb-chen/hbchen.com/master/static/img/istio/egress-sidecar-ip.png&#34; alt=&#34;ServiceEntry&#34; /&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Istioæ–‡æ¡£&lt;a href=&#34;https://istio.io/zh/docs/tasks/traffic-management/egress/#%E7%9B%B4%E6%8E%A5%E8%B0%83%E7%94%A8%E5%A4%96%E9%83%A8%E6%9C%8D%E5%8A%A1&#34;&gt;ç›´æ¥è°ƒç”¨å¤–éƒ¨æœåŠ¡&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;éœ€è¦ä¿®æ”¹helmçš„valuesé…ç½®æ›´æ–°éƒ¨ç½²ã€‚å¹¶ä¸”è¦è®©æ–°çš„&lt;code&gt;istio-sidecar-injector&lt;/code&gt;ç”Ÿæ•ˆï¼Œé‡æ–°éƒ¨ç½²&lt;code&gt;sleep&lt;/code&gt;ç”¨ä¾‹ã€‚è¿™ç§æ–¹å¼åœ¨Sidecarçš„Proxyä¸­è·³è¿‡äº†å¤–éƒ¨IPï¼Œè™½ç„¶ä¹Ÿæœ‰&lt;code&gt;excludeIPRanges&lt;/code&gt;æ–¹å¼ï¼Œä½†ä¿®æ”¹éº»çƒ¦éœ€è¦æ›´æ–°sidecarï¼Œå¹¶ä¸”è¿™æ ·ä¹Ÿå¤±å»äº†Istioçš„å…¶å®ƒèƒ½åŠ›ï¼Œæ‰€ä»¥ä¸æ€ä¹ˆå®ç”¨ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;  proxy:
    # Minikube
    includeIPRanges: &amp;quot;10.0.0.1/24&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;ServiceEntry&lt;/code&gt;é…åˆ&lt;code&gt;VirtualService&lt;/code&gt;ã€&lt;code&gt;DestinationRule&lt;/code&gt;å¯ä»¥ä½¿å¤–éƒ¨æµé‡åšæ¯”è¾ƒçµæ´»çš„ç®¡æ§ï¼Œå¹¶ä¸”å¯ä»¥å¯¹å¤–éƒ¨æœåŠ¡ä½¿ç”¨æµé‡ç®¡ç†çš„ç›¸å…³åŠŸèƒ½ï¼ŒGatewayç›¸å¯¹Sidecaré…ç½®è¿˜æ˜¯ç•¥æ˜¾å¤æ‚ï¼Œè€Œåœ¨æ€§èƒ½æ–¹é¢å®˜æ–¹Blog&lt;a href=&#34;https://istio.io/zh/blog/2019/egress-performance/&#34;&gt;Egress gateway æ€§èƒ½æµ‹è¯•&lt;/a&gt;ç»™å‡ºçš„æ¯”è¾ƒç»“æœä¸¤è€…ç›¸å·®ä¸å¤§ï¼Œè‡³äºç›´æ¥è°ƒç”¨æ–¹å¼ç›¸å¯¹å°±ä¸æ€ä¹ˆå®ç”¨äº†ã€‚&lt;/p&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Istioæºç ã€‘Pilot Agent</title>
      <link>http://hbchen.com/post/servicemesh/2019-03-31-istio-code-pilot-agent/</link>
      <pubDate>Sun, 07 Apr 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/servicemesh/2019-03-31-istio-code-pilot-agent/</guid>
      
        <description>&lt;p&gt;æ¥ä¸Šä¸€ç¯‡&lt;a href=&#34;http://hbchen.com/post/servicemesh/2019-03-17-istio-code-pilot-discovery/&#34;&gt;ã€Šã€Istioæºç ã€‘Pilot Discoveryã€‹&lt;/a&gt;ï¼Œè¿™ç¯‡ç»§ç»­åˆ†æ&lt;strong&gt;Pilot&lt;/strong&gt;çš„&lt;code&gt;pilot-agent&lt;/code&gt;æ¨¡å—ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;pilot-agent&lt;/code&gt;ç›¸å¯¹&lt;code&gt;pilot-discovery&lt;/code&gt;åœ¨æ§åˆ¶å¹³é¢æ¯”è¾ƒç®€å•ï¼Œ&lt;strong&gt;agent&lt;/strong&gt;æ›´å¤šçš„èƒ½åŠ›æ˜¯åœ¨æ•°æ®å¹³é¢çš„&lt;code&gt;envoy&lt;/code&gt;ï¼Œ&lt;code&gt;envoy&lt;/code&gt;é€šè¿‡&lt;code&gt;xDS&lt;/code&gt;åè®®ä¸&lt;code&gt;pilot-discovery&lt;/code&gt;æœåŠ¡è¿›è¡Œé€šä¿¡ã€‚agentä¸»è¦è´Ÿè´£ç›‘æ§&lt;code&gt;ingress&lt;/code&gt;ã€&lt;code&gt;mTLS&lt;/code&gt;çš„è¯ä¹¦ï¼Œå‘ç”Ÿå˜æ›´åé‡å¯&lt;code&gt;envoy&lt;/code&gt;ï¼Œä»¥åŠæä¾›&lt;strong&gt;agent&lt;/strong&gt;çŠ¶æ€çš„HTTPæœåŠ¡(&lt;em&gt;å¯é€‰æœåŠ¡&lt;/em&gt;)&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-mermaid&#34;&gt;sequenceDiagram
    participant a as agent
    participant pa as proxy/agent
    participant ew as envoy/watcher
    participant ep as envoy/proxy
    participant s as status
    participant fw as fsnotify.Watcher 
    
    Note over a,fw: agentçŠ¶æ€æœåŠ¡
    a -&amp;gt;&amp;gt; s: NewServer()
    s --&amp;gt;&amp;gt; a: statusServer *Server
    a -&amp;gt;&amp;gt; s: statusServer.Run()

    a -&amp;gt;&amp;gt; ep: NewProxy(proxyConfig)
    ep --&amp;gt;&amp;gt; a: envoyProxy proxy.Proxy
    a -&amp;gt;&amp;gt; pa: NewAgent(envoyProxy)
    pa --&amp;gt; a: agent Agent
    a -&amp;gt;&amp;gt; ew: NewWatcher(agent.ConfigCh)ï¼Œupdates = agent.ConfigCh
    ew --&amp;gt;&amp;gt; a: watcher Watcher
    
    Note over a,fw: watcherç›‘æ§é…ç½®å˜æ›´ï¼Œé€šçŸ¥agenté‡å¯envoy
    loop: go
        a -&amp;gt;&amp;gt; ew: watcher.Run()
        ew -&amp;gt;&amp;gt; fw: fw.Watch(certs)ï¼ŒAuthCertsPathã€IngressCertsPath
        fw --&amp;gt;&amp;gt; ew: w.watchFileEvents()
        ew -&amp;gt;&amp;gt; ew: &amp;lt;-timeChanï¼Œ10så»¶è¿Ÿ
        ew -&amp;gt;&amp;gt; ew: SendConfig()
        ew -&amp;gt;&amp;gt; pa: updates&amp;lt;-
        Note over pa: &amp;lt;-configCh
    end    
    
    Note over a,fw: agentåšenvoyé‡å¯æ“ä½œï¼ŒåŒ…æ‹¬é¢‘ç‡æ§åˆ¶ã€å¤±è´¥é‡è¯•ç­‰
    loop : go
        a -&amp;gt;&amp;gt; pa: agent.Run()
        Note over pa: rateLimiter.Wait()&amp;lt;br/&amp;gt;æ§åˆ¶é¢‘ç‡
        alt &amp;lt;-configCh
            Note over pa: é…ç½®æ›´æ–°Envoyçƒ­é‡å¯&amp;lt;br/&amp;gt;reconcile()
        else &amp;lt;-statusCh  
            Note over pa: Envoyé‡å¯åé€šçŸ¥å¤„ç†&amp;lt;br/&amp;gt;å¤±è´¥é‡è¯•é€»è¾‘
        else &amp;lt;-reconcileTimer.C
            Note over pa: å¤±è´¥é‡è¯•è®¡æ—¶é‡å¯&amp;lt;br/&amp;gt;reconcile()
        end
    end
    
    loop: envoyé‡å¯
        pa -&amp;gt;&amp;gt; pa: reconcile()
        Note over ep: é»˜è®¤æœåŠ¡å‘ç°åœ°å€:&amp;lt;br/&amp;gt;istio-pilot:15010&amp;lt;br/&amp;gt;å¯¹åº”pilot-discoveryçš„åœ°å€:&amp;lt;br/&amp;gt;gRPC port:15010
        pa -&amp;gt;&amp;gt; ep: proxy.Run(&amp;lt;-abort)
        ep --&amp;gt;&amp;gt; pa: err error
        pa -&amp;gt;&amp;gt; pa: statusCh&amp;lt;-
    end
    
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Istioæºç ã€‘Pilot Discovery</title>
      <link>http://hbchen.com/post/servicemesh/2019-03-17-istio-code-pilot-discovery/</link>
      <pubDate>Sat, 30 Mar 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/servicemesh/2019-03-17-istio-code-pilot-discovery/</guid>
      
        <description>&lt;p&gt;æµé‡ç®¡ç†æ˜¯ç½‘æ ¼çš„åŸºç¡€ï¼ŒPilotè´Ÿè´£ä¸‰ä¸ªä¸»è¦åŠŸèƒ½ï¼šæœåŠ¡æ²»ç†&lt;code&gt;istio-pilot&lt;/code&gt;ã€Sidecaræ³¨å…¥&lt;code&gt;istio-sidecar-injector&lt;/code&gt;ã€ä»¥åŠSidecar&lt;code&gt;istio-proxy&lt;/code&gt;ï¼Œ
åˆ†åˆ«ç”±ä¸‰ä¸ªæ¨¡å—è´Ÿè´£ï¼š&lt;code&gt;pilot-discovery&lt;/code&gt;ã€&lt;code&gt;sidecar-injector&lt;/code&gt;ã€&lt;code&gt;pilot-agent&lt;/code&gt;ï¼Œè¿™é‡Œä»&lt;code&gt;pilot-discovery&lt;/code&gt;å¼€å§‹ã€‚&lt;/p&gt;

&lt;h2 id=&#34;discoveryè¿è¡Œåºåˆ—&#34;&gt;Discoveryè¿è¡Œåºåˆ—&lt;/h2&gt;

&lt;h3 id=&#34;kubeç¯å¢ƒç®€åŒ–åºåˆ—&#34;&gt;kubeç¯å¢ƒç®€åŒ–åºåˆ—&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-mermaid&#34;&gt;sequenceDiagram
    participant s as server
    participant f as fileWatcher
    participant i as k8s.io/client-go&amp;lt;br/&amp;gt;informer
    participant h as handler
    
    Note over s: mesh
    s -&amp;gt;&amp;gt; f: addFieWatcher()
    Note over s: meshNetworks
    s -&amp;gt;&amp;gt; f: addFileWatcher()
    Note over s: config
        loop IstioConfigTypes
        s -&amp;gt;&amp;gt; i: cache.NewSharedIndexInformer()
        end
    Note over s: service
        activate i
        s -&amp;gt;&amp;gt; i: Services().Informer()
        s -&amp;gt;&amp;gt; i: Endpoints().Informer()
        s -&amp;gt;&amp;gt; i: Nodes().Informer()
        s -&amp;gt;&amp;gt; i: Pods().Informer()
        deactivate i
    Note over s: discovery
        activate h
        s -&amp;gt;&amp;gt; h: service.AppendServiceHandler()
        s -&amp;gt;&amp;gt; h: service.AppendInstanceHandler()
        s -&amp;gt;&amp;gt; h: config.RegisterEventHandler()
        deactivate h
    alt fsnotify
        f -&amp;gt;&amp;gt; s: fsnotify.Event()
        s -&amp;gt;&amp;gt; s: ds.ConfigUpdate()
    end
        
    alt K8S
        i -&amp;gt;&amp;gt; h: handler.Apply()
        loop handler.funcs
            h -&amp;gt;&amp;gt; s: Event Handler
            s -&amp;gt;&amp;gt; s: ds.ConfigUpdate()
        end
    end
    activate s
    s -&amp;gt;&amp;gt; s: pushChannel &amp;lt;- XdsEvent
    s -&amp;gt;&amp;gt; s: ds.StreamAggregatedResources()Pushåˆ°xDS
    deactivate s

&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;è¯¦ç»†åºåˆ—&#34;&gt;è¯¦ç»†åºåˆ—&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-mermaid&#34;&gt;sequenceDiagram
    participant b as bootstrap
    participant kc as k8s.io/client-go
    participant cmd as cmd
    participant c as config/&amp;lt;br/&amp;gt;aggregate&amp;lt;br/&amp;gt;kube&amp;lt;br/&amp;gt;â€¦â€¦
    
    participant k as kube
    participant m as model
    participant pe as proxy/envoy
    participant sr as serviceregistry
    
    
    b -&amp;gt;&amp;gt; b: NewServer()
    Note left of b: initKubeClient()
    b -&amp;gt;&amp;gt; k: kube.CreateClientset()
    k --&amp;gt;&amp;gt; b: kubeClient *kubernetes.Clientset
    
    Note left of b: ç½‘æ ¼é…ç½®&amp;lt;br/&amp;gt;initMesh()
        Note over kc,cmd: é»˜è®¤ConfigFile&amp;lt;br/&amp;gt;/etc/istio/config/mesh
        alt args.Mesh.ConfigFile != &amp;quot;&amp;quot;
        b -&amp;gt;&amp;gt; cmd: cmd.ReadMeshConfig(args.Mesh.ConfigFile)
        cmd --&amp;gt;&amp;gt; b: mesh *meshconfig.MeshConfig
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&amp;lt;br/&amp;gt;ï¸addFileWatcher(args.Mesh.ConfigFile)&amp;lt;br/&amp;gt;mesh reload&amp;lt;br/&amp;gt;âœ…s.EnvoyXdsServer.ConfigUpdate()
        else K8s ConfigMap è·å–é…ç½®
        b -&amp;gt;&amp;gt; b: GetMeshConfig(s.kubeClient, kube.IstioNamespace, kube.IstioConfigMap)
        b -&amp;gt;&amp;gt; m: model.DefaultMeshConfig()/model.ApplyMeshConfigDefaults(cfgYaml)
        m --&amp;gt;&amp;gt; b: mesh meshconfig.MeshConfig
        end
    
    Note left of b: Meshç½‘ç»œé…ç½®&amp;lt;br/&amp;gt;initMeshNetworks()
        Note over kc,cmd: é»˜è®¤NetworksConfigFile&amp;lt;br/&amp;gt;/etc/istio/config/meshNetworks
        alt args.NetworksConfigFile != &amp;quot;&amp;quot;
        b -&amp;gt;&amp;gt; cmd: cmd.ReadMeshNetworksConfig()
        cmd --&amp;gt;&amp;gt; b: meshNetworks *meshconfig.MeshNetworks
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&amp;lt;br/&amp;gt;addFileWatcher(args.NetworksConfigFile)&amp;lt;br/&amp;gt;meshNetworks reload&amp;lt;br/&amp;gt;âœ…s.EnvoyXdsServer.ConfigUpdate()
        end
    
    Note left of b: Mixer&amp;lt;br/&amp;gt;initMixerSan()
        alt s.mesh.DefaultConfig.ControlPlaneAuthPolicy == meshconfig.AuthenticationPolicy_MUTUAL_TLS
        b -&amp;gt;&amp;gt; pe: envoy.GetMixerSAN(args.Namespace)
        pe -&amp;gt;&amp;gt; b: SpiffeURI string
        Note over kc,cmd: s.mixerSAN[SpiffeURI]&amp;lt;br/&amp;gt;NewDiscoveryServiceçš„Env
        end
    
    Note left of b: é…ç½®ç®¡ç†&amp;lt;br/&amp;gt;initConfigController()
        alt len(args.MCPServerAddrs) &amp;gt; 0 || len(s.mesh.ConfigSources) &amp;gt; 0
        Note over kc,cmd: s.initMCPConfigController()
            Note over kc,cmd: var clients []*client.Client&amp;lt;br/&amp;gt;var clients2 []*sink.Client&amp;lt;br/&amp;gt;var conns []*grpc.ClientConn&amp;lt;br/&amp;gt;var configStores []model.ConfigStoreCache
            loop s.mesh.ConfigSources
                alt url.Scheme == fsScheme
                b -&amp;gt;&amp;gt; c: memory.NewController(store)
                c --&amp;gt;&amp;gt; b: configController model.ConfigStoreCache
                Note over kc,cmd: configStores = append(configStores, configController)
                else
                b -&amp;gt;&amp;gt; c: coredatamodel.NewController()
                c --&amp;gt;&amp;gt; b: mcpController CoreDataModel
                Note over kc,cmd: clients = append(clients, mcpClient)&amp;lt;br/&amp;gt;clients2 = append(clients2, mcpClient2)&amp;lt;br/&amp;gt;mcpControlleræ˜¯MCP Clientçš„Updater&amp;lt;br/&amp;gt;å½“Clientç«¯æ”¶åˆ°Responseæ—¶&amp;lt;br/&amp;gt;é€šè¿‡Updater.Apply()æ¥å£é€šçŸ¥æ›´æ–°
                Note over kc,cmd: conns = append(conns, conn)&amp;lt;br/&amp;gt;configStores = append(configStores, mcpController)
                end
            end
            
            alt len(configStores) == 0
            Note over kc,cmd: ConfigSourcesæœªåŠ è½½é…ç½®&amp;lt;br/&amp;gt;ä»MCPServerAddrsåŠ è½½
            loop args.MCPServerAddrs
            b -&amp;gt;&amp;gt; c: coredatamodel.NewController()
            c --&amp;gt;&amp;gt; b: mcpController CoreDataModel
            Note over kc,cmd: conns = append(conns, conn)&amp;lt;br/&amp;gt;configStores = append(configStores, mcpController)
            end
            end
            
            
            Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&amp;lt;br/&amp;gt;s.addStartFunc(go func() {client.Run(ctx)}())&amp;lt;br/&amp;gt;MCP Clientså¯åŠ¨&amp;lt;br/&amp;gt;æ¥æ”¶åˆ°Responseé€šçŸ¥mcpController&amp;lt;br/&amp;gt;Apply(*Change)&amp;lt;br/&amp;gt;model.ServiceEntry.Typeçš„ä¿®æ”¹é€šçŸ¥åˆ°serviceEntryEvents()&amp;lt;br/&amp;gt;â—åœ¨external.NewServiceDiscovery()æœ‰model.ServiceEntry.Typeçš„handler
            Note over kc,cmd: é…ç½®æ±‡æ€»
            b -&amp;gt;&amp;gt; c: configaggregate.MakeCache(configStores)
            c --&amp;gt;&amp;gt; b: aggregateMcpController model.ConfigStoreCache
            
        else args.Config.Controller != nil
        Note over kc,cmd: s.configController = args.Config.Controller
        else args.Config.FileDir != &amp;quot;&amp;quot;
        Note over kc,cmd: configController := memory.NewController(store)
        else é»˜è®¤KubeConfig
        Note over kc,cmd: controller, err := s.makeKubeConfigController(args)
        end
        
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&amp;lt;br/&amp;gt;s.addStartFunc ( go s.configController.Run(stop) )&amp;lt;br/&amp;gt;é…ç½®Controllerå¯åŠ¨&amp;lt;br/&amp;gt;å¤„ç†é…ç½®å˜æ›´çš„EventHandler&amp;lt;br/&amp;gt;memoryã€kube.crdçš„Controlleræœ‰Run()å®ç°
        Note over kc,cmd: memoryé€šè¿‡makeFileMonitor()ç›‘æ§æ–‡ä»¶&amp;lt;br/&amp;gt;æ¥æ”¶èµ„æºå˜æ›´æ—¶æ›´æ–°configStore&amp;lt;br/&amp;gt;å¹¶é€šè¿‡monitor.ScheduleProcessEvent()åˆ†å‘äº‹ä»¶&amp;lt;br/&amp;gt;â—RegisterEventHandlerå°†handler Appendåˆ°monitorçš„handlers
        Note over kc,cmd: kube.crd.cacheHandlerè¿è¡Œinformer&amp;lt;br/&amp;gt;informerç›‘æ§ä¸åŒConfigType&amp;lt;br/&amp;gt;informerå°†èµ„æºAddã€Updateã€Deleteäº‹ä»¶ç»Ÿä¸€å‹å…¥Queue&amp;lt;br/&amp;gt;Queue Run()é€ä¸ªäº‹ä»¶å¤„ç†ï¼Œå³cacheHandlerçš„hander.funcs&amp;lt;br/&amp;gt;â—RegisterEventHandlerå°†handler Appendåˆ°hander.funcs
        Note over b,c: ğŸ’šğŸ’šğŸ’šğŸ’šğŸ’š&amp;lt;br/&amp;gt;RegisterEventHandler()&amp;lt;br/&amp;gt;&amp;lt;br/&amp;gt;â—åœ¨Discoveryå’ŒServiceRegistryæœ‰handleræ³¨å†Œ
        
        alt hasKubeRegistry(args) &amp;amp;&amp;amp; s.mesh.IngressControllerMode != meshconfig.MeshConfig_OFF
        Note over kc,cmd: K8s ingressçš„ConfigController
        b -&amp;gt;&amp;gt; c: ingress.NewController()
        c --&amp;gt;&amp;gt; b: ingress model.ConfigStoreCache
        b -&amp;gt;&amp;gt; c: configaggregate.MakeCache(s.configController, ingress)
        c --&amp;gt;&amp;gt; b: configController model.ConfigStoreCache
        b -&amp;gt;&amp;gt; c: ingress.NewStatusSyncer()
        c --&amp;gt;&amp;gt; b: ingressSyncer *StatusSyncer
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&amp;lt;br/&amp;gt;s.addStartFunc ( go ingressSyncer.Run(stop) )&amp;lt;br/&amp;gt;Ingress Syncerå¯åŠ¨
        end
        b -&amp;gt;&amp;gt; m: model.MakeIstioStore(s.configController)
        m --&amp;gt;&amp;gt; b: istioConfigStore IstioConfigStore
        Note over b,c: ğŸ’šğŸ’šğŸ’šğŸ’šğŸ’š&amp;lt;br/&amp;gt;istioConfigStoreæä¾›Istioé…ç½®è·å–&amp;lt;br/&amp;gt;ä¸»è¦ä¸ºConfigStoreçš„List()æ¥å£
    
    Note left of b: æœåŠ¡æ³¨å†Œ&amp;lt;br/&amp;gt;initServiceControllers()
        b -&amp;gt;&amp;gt; sr: aggregate.NewController()
        sr --&amp;gt;&amp;gt; b: serviceControllers *Controller
        loop args.Service.Registries
        Note over b,c: ğŸ’šğŸ’šğŸ’šğŸ’šğŸ’š&amp;lt;br/&amp;gt;å¤šæ³¨å†Œä¸­å¿ƒ&amp;lt;br/&amp;gt;Controlleré€šè¿‡AppendServiceHandler()ã€AppendInstanceHandler()æ¥æ”¶å¤–éƒ¨Handler&amp;lt;br/&amp;gt;åœ¨æœ‰å˜æ›´æ—¶è½®è¯¢Handler&amp;lt;br/&amp;gt;â—Discoveryä¼šAppendHandler
        alt serviceregistry.MockRegistry
        b -&amp;gt;&amp;gt; b: s.initMemoryRegistry()
        b -&amp;gt;&amp;gt; sr: srmemory.NewDiscovery() aggregate.Registry{}
        b --&amp;gt;&amp;gt; b: serviceControllers.AddRegistry()
        else serviceregistry.KubernetesRegistry
        b -&amp;gt;&amp;gt; b: s.createK8sServiceControllers()
        b -&amp;gt;&amp;gt; sr: kube.NewController()
        b --&amp;gt;&amp;gt; b: serviceControllers.AddRegistry()
        else serviceregistry.ConsulRegistry
        b -&amp;gt;&amp;gt; b: s.initConsulRegistry()
        b -&amp;gt;&amp;gt; sr: consul.NewController()
        b --&amp;gt;&amp;gt; b: serviceControllers.AddRegistry()
        else serviceregistry.MCPRegistry
        Note over kc,cmd: no-op: get service info from MCP ServiceEntries.
        end
        end
        b -&amp;gt;&amp;gt; sr: external.NewServiceDiscovery()
        sr --&amp;gt;&amp;gt; b: serviceEntryStore *ServiceEntryStore
        b --&amp;gt;&amp;gt; b: serviceControllers.AddRegistry()
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&amp;lt;br/&amp;gt;s.addStartFunc()&amp;lt;br/&amp;gt;æœåŠ¡æ³¨å†ŒControllerså¯åŠ¨
    
    Note left of b: æœåŠ¡å‘ç°&amp;lt;br/&amp;gt;initDiscoveryService()&amp;lt;br/&amp;gt;gRPCå’ŒHTTPæœåŠ¡
        b -&amp;gt;&amp;gt; pe: envoy.NewDiscoveryService()
        Note over b,c: ğŸ’šğŸ’šğŸ’šğŸ’šğŸ’šds.clearCache()å°è£…ä¸ºHandler&amp;lt;br/&amp;gt;æ¥æ”¶s.ServiceControllerã€s.configControllerçš„å˜æ›´é€šçŸ¥&amp;lt;br/&amp;gt;âœ…s.ServiceController.AppendServiceHandler()&amp;lt;br/&amp;gt;âœ…s.ServiceController.AppendInstanceHandler()&amp;lt;br/&amp;gt;âœ…s.configController.RegisterEventHandler()
        pe --&amp;gt;&amp;gt; b: discovery *DiscoveryService
        Note over kc,cmd: HTTP&amp;lt;br/&amp;gt;envoy.DiscoveryServiceæä¾›/v1/registrationä»¥åŠ/debug/pprof/* RESTæ¥å£
        b --&amp;gt; b: s.mux = discovery.RestContainer.ServeMux
        b -&amp;gt;&amp;gt; pe: envoyv2.NewDiscoveryServer()
        pe --&amp;gt;&amp;gt; b: s.EnvoyXdsServer *DiscoveryServer
        Note over kc,cmd: gRPC&amp;lt;br/&amp;gt;envoyv2.DiscoveryServer&amp;lt;br/&amp;gt;åªæä¾›StreamAggregatedResources()æœåŠ¡&amp;lt;br/&amp;gt;xDSç®¡ç†
        Note over kc,cmd: s.initGrpcServer()&amp;lt;br/&amp;gt;s.httpServer&amp;lt;br/&amp;gt;http.Server{Handler: s.mux}        
        Note over kc,cmd: http listener&amp;lt;br/&amp;gt;grpc listener
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸â¤ï¸ï¸s.addStartFunc()&amp;lt;br/&amp;gt;s.httpServer.Serve()&amp;lt;br/&amp;gt;s.grpcServer.Serve()
        alt args.DiscoveryOptions.SecureGrpcAddr != &amp;quot;&amp;quot;
        b -&amp;gt;&amp;gt; b: initSecureGrpcServer()
            Note over kc,cmd: s.secureGRPCServer&amp;lt;br/&amp;gt;s.secureHTTPServer
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&amp;lt;br/&amp;gt;s.addStartFunc()&amp;lt;br/&amp;gt;s.secureHTTPServer.ServeTLS()
        end
        
        Note right of b: 
    
    Note left of b: ç›‘æ§&amp;lt;br/&amp;gt;initMonitor()
        Note over b,c: â¤ï¸â¤ï¸â¤ï¸ï¸â¤ï¸ï¸â¤ï¸&amp;lt;br/&amp;gt;s.addStartFunc()&amp;lt;br/&amp;gt;startMonitor()
    
    Note left of b: é›†ç¾¤&amp;lt;br/&amp;gt;initClusterRegistries()
        b -&amp;gt;&amp;gt; c: clusterregistry.NewMulticluster()
        c --&amp;gt;&amp;gt; b: multicluster *Multicluster
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;discovery-serveræµç¨‹&#34;&gt;Discovery Serveræµç¨‹&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-mermaid&#34;&gt;graph LR
    
    
    s(ads.StreamAggregatedResources)
    style s fill:#f9f
    s --&amp;gt; rc(reqChannel)
    s --&amp;gt; pc(pushChannel)
    style rc fill:#f9f
    style pc fill:#f9f
    
    subgraph reqChannel
        rc --&amp;gt; dt{discReq.TypeUrl}
        dt --&amp;gt;|ClusterType| pushCds[&amp;quot;pushCds()&amp;quot;]
        dt --&amp;gt;|ListenerType| pushLds[&amp;quot;pushLds()&amp;quot;]
        dt --&amp;gt;|RouteType| pushRoute[&amp;quot;pushRoute()&amp;quot;]
        dt --&amp;gt;|EndpointType| pushEds[&amp;quot;pushEds()&amp;quot;]
    end
    
    subgraph pushChannel
        nd(&amp;quot;DiscoveryServer&amp;quot;) --&amp;gt; pr(&amp;quot;periodicRefresh&amp;quot;)
        nd --&amp;gt; ash(&amp;quot;s.ServiceController.AppendServiceHandler()&amp;quot;)
        nd --&amp;gt; aih(&amp;quot;s.ServiceController.AppendInstanceHandler()&amp;quot;)
        nd --&amp;gt; reh(&amp;quot;s.configController.RegisterEventHandler()&amp;quot;)
        ash --&amp;gt; clearCache(&amp;quot;clearCache()&amp;quot;)
        aih --&amp;gt; clearCache
        reh --&amp;gt; clearCache
        clearCache --&amp;gt;|full=true| ds(&amp;quot;ds.ConfigUpdate()&amp;quot;)
        pr --&amp;gt; pa(&amp;quot;ads.AdsPushAll()&amp;quot;)         
        
        sp(&amp;quot;ads.startPush()&amp;quot;) --&amp;gt; pc
        
        c(config) --MeshConfig/MeshNetworks/MCPConfig--&amp;gt; ds
        ds --&amp;gt; dp(&amp;quot;doPush()&amp;quot;)
        dp --&amp;gt; push(&amp;quot;Push()&amp;quot;)
        
        push --&amp;gt; pa
        pa --&amp;gt; updateCluster[&amp;quot;eds.updateCluster()&amp;quot;]
        push --&amp;gt; updateServiceShards[&amp;quot;eds.updateServiceShards()&amp;quot;]
        pa --&amp;gt; ei(&amp;quot;eds.edsIncremental()&amp;quot;)
        ei --&amp;gt; updateClusterInc(&amp;quot;eds.updateClusterInc()&amp;quot;)
        pa --&amp;gt; sp
        ei --&amp;gt; sp
        updateClusterInc --&amp;gt; updateCluster
        
        
        pc --&amp;gt; pushConn(pushConnection)
        pushConn -.-&amp;gt; C/E/L/Rds
    end
    
    nd --&amp;gt;|Serve gRPC| s
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Istioå®‰å…¨ã€‘æœåŠ¡é—´è®¿é—®æ§åˆ¶-RBAC</title>
      <link>http://hbchen.com/post/servicemesh/2019-03-09-istio-rbac-quick-start/</link>
      <pubDate>Fri, 22 Mar 2019 00:00:00 +0000</pubDate>
      
      <guid>http://hbchen.com/post/servicemesh/2019-03-09-istio-rbac-quick-start/</guid>
      
        <description>&lt;p&gt;Istioæä¾›äº†éå¸¸æ˜“ç”¨çš„å®‰å…¨è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬æœåŠ¡é—´èº«ä»½éªŒè¯&lt;code&gt;mTLS&lt;/code&gt;ï¼ŒæœåŠ¡é—´è®¿é—®æ§åˆ¶&lt;code&gt;RBAC&lt;/code&gt;ï¼Œä»¥åŠç»ˆç«¯ç”¨æˆ·èº«ä»½éªŒè¯&lt;code&gt;JWT&lt;/code&gt;ç­‰ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»å¦‚ä½•ä½¿ç”¨æœåŠ¡é—´è®¿é—®æ§åˆ¶ï¼ŒåŒæ—¶æ¶‰åŠ&lt;code&gt;åŒå‘TLS&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Istioç‰ˆæœ¬ &lt;strong&gt;1.1.0&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;åœ¨çš„&lt;a href=&#34;https://github.com/hb-go/micro-mesh&#34;&gt;github.com/hb-go/micro-mesh&lt;/a&gt;ä¸­æœ‰ç»“åˆç¤ºä¾‹çš„&lt;a href=&#34;https://github.com/hb-go/micro-mesh/tree/master/deploy/k8s/rbac&#34;&gt;RBACé…ç½®å®è·µ&lt;/a&gt;å¯ä»¥å‚è€ƒ&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;strong&gt;è¦å®ç°&lt;code&gt;RBAC&lt;/code&gt;ä¸»è¦ç†è§£ä»¥ä¸‹å‡ ä¸ªç±»å‹çš„&lt;code&gt;yaml&lt;/code&gt;é…ç½®ï¼Œä»¥åŠä¹‹é—´çš„å…³ç³»ï¼š&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#åŒå‘tls&#34;&gt;åŒå‘TLS&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Policy&lt;/code&gt;æˆ–&lt;code&gt;MeshPolicy&lt;/code&gt;ï¼Œä¸Šæ¸¸&lt;code&gt;server&lt;/code&gt;å¼€å¯TLS&lt;/li&gt;
&lt;li&gt;&lt;code&gt;DestinationRule&lt;/code&gt;ï¼Œä¸‹æ¸¸&lt;code&gt;client&lt;/code&gt;å¼€å¯TLS&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#rbac&#34;&gt;RBAC&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;ClusterRbacConfig&lt;/code&gt;/&lt;code&gt;RbacConfig&lt;/code&gt;ï¼Œå¯ç”¨æˆæƒåŠèŒƒå›´&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ServiceRole&lt;/code&gt;ï¼Œè§’è‰²æƒé™è§„åˆ™&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ServiceRoleBinding&lt;/code&gt;ï¼Œè§’è‰²ç»‘å®šè§„åˆ™&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#optional&#34;&gt;Optional&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;ServiceAccount&lt;/code&gt;ï¼Œ&lt;code&gt;ServiceRoleBinding&lt;/code&gt;.&lt;code&gt;subjects&lt;/code&gt;çš„&lt;code&gt;user&lt;/code&gt;æ¡ä»¶
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;å‡è®¾åœºæ™¯&#34;&gt;å‡è®¾åœºæ™¯&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;ç½‘æ ¼å†…&lt;code&gt;service-1&lt;/code&gt;ã€&lt;code&gt;service-2&lt;/code&gt;å¼€å¯RBACè®¿é—®æ§åˆ¶&lt;/li&gt;
&lt;li&gt;ä»…&lt;code&gt;service-1&lt;/code&gt;æˆæƒç»™&lt;code&gt;ingressgateway&lt;/code&gt;è®¿é—®ï¼Œ&lt;code&gt;service-2&lt;/code&gt;åˆ™ä¸èƒ½è¢«&lt;code&gt;ingressgateway&lt;/code&gt;è®¿é—®&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/hb-chen/hbchen.com/master/static/img/istio-tls-rbac.png&#34; alt=&#34;auth-adapter&#34; /&gt;&lt;/p&gt;

&lt;h2 id=&#34;åŒå‘tls&#34;&gt;åŒå‘TLS&lt;/h2&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/concepts/security/#%E8%AE%A4%E8%AF%81&#34;&gt;Istioæ–‡æ¡£-è®¤è¯ç­–ç•¥&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/concepts/security/#%E8%AE%A4%E8%AF%81%E7%AD%96%E7%95%A5&#34;&gt;è®¤è¯ç­–ç•¥&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/tasks/security/authn-policy/&#34;&gt;Istioæ–‡æ¡£-åŸºç¡€è®¤è¯ç­–ç•¥&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/tasks/security/authn-policy/#%E4%B8%BA%E7%BD%91%E6%A0%BC%E4%B8%AD%E7%9A%84%E6%89%80%E6%9C%89%E6%9C%8D%E5%8A%A1%E5%90%AF%E7%94%A8%E5%8F%8C%E5%90%91-tls-%E8%AE%A4%E8%AF%81&#34;&gt;ä¸ºç½‘æ ¼ä¸­çš„æ‰€æœ‰æœåŠ¡å¯ç”¨åŒå‘ TLS è®¤è¯&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h3 id=&#34;1-ä¸Šæ¸¸-server-å¼€å¯tls&#34;&gt;1.ä¸Šæ¸¸&lt;code&gt;server&lt;/code&gt;å¼€å¯TLS&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;&lt;em&gt;&lt;a href=&#34;##&#34;&gt;ç­–ç•¥èŒƒå›´è¯´æ˜&lt;/a&gt;&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;ç½‘æ ¼èŒƒå›´ç­–ç•¥&lt;/strong&gt;ï¼šåœ¨ç½‘æ ¼èŒƒå›´å­˜å‚¨ä¸­å®šä¹‰çš„ç­–ç•¥ï¼Œæ²¡æœ‰ç›®æ ‡é€‰æ‹©å™¨éƒ¨åˆ†ã€‚ç½‘æ ¼ä¸­æœ€å¤šåªèƒ½æœ‰&lt;strong&gt;ä¸€ä¸ªç½‘æ ¼èŒƒå›´&lt;/strong&gt;çš„ç­–ç•¥ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å‘½åç©ºé—´èŒƒå›´çš„ç­–ç•¥&lt;/strong&gt;ï¼šåœ¨å‘½åç©ºé—´èŒƒå›´å­˜å‚¨ä¸­å®šä¹‰çš„ç­–ç•¥ï¼Œåç§°ä¸º default ä¸”æ²¡æœ‰ç›®æ ‡é€‰æ‹©å™¨éƒ¨åˆ†ã€‚æ¯ä¸ªå‘½åç©ºé—´æœ€å¤šåªèƒ½æœ‰&lt;strong&gt;ä¸€ä¸ªå‘½åç©ºé—´èŒƒå›´&lt;/strong&gt;çš„ç­–ç•¥ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç‰¹å®šäºæœåŠ¡çš„ç­–ç•¥&lt;/strong&gt;ï¼šåœ¨å‘½åç©ºé—´èŒƒå›´å­˜å‚¨ä¸­å®šä¹‰çš„ç­–ç•¥ï¼Œå…·æœ‰éç©ºç›®æ ‡é€‰æ‹©å™¨éƒ¨åˆ†ã€‚å‘½åç©ºé—´å¯ä»¥å…·æœ‰&lt;strong&gt;é›¶ä¸ªï¼Œä¸€ä¸ªæˆ–å¤šä¸ªç‰¹å®šäºæœåŠ¡&lt;/strong&gt;çš„ç­–ç•¥ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;ç­–ç•¥èŒƒå›´å¯ä»¥åˆ†åˆ«ç”±&lt;code&gt;Policy&lt;/code&gt;ã€&lt;code&gt;MeshPolicy&lt;/code&gt;è®¾ç½®ï¼Œ&lt;code&gt;Policy&lt;/code&gt;å¯ä»¥é€‰æ‹©å¯¹&lt;strong&gt;å‘½åç©ºé—´&lt;/strong&gt;æ‰€æœ‰æœåŠ¡ç”Ÿæ•ˆï¼Œä¹Ÿå¯ä»¥æŒ‡å®š&lt;code&gt;targets&lt;/code&gt;å¯¹&lt;strong&gt;ç‰¹å®šæœåŠ¡&lt;/strong&gt;ç”Ÿæ•ˆï¼Œ&lt;code&gt;MeshPolicy&lt;/code&gt;åˆ™æ˜¯æ•´ä¸ªç½‘æ ¼å†…ç”Ÿæ•ˆï¼Œå¯¹äº&lt;strong&gt;å‘½åç©ºé—´èŒƒå›´&lt;/strong&gt;å’Œ&lt;strong&gt;ç½‘æ ¼èŒƒå›´&lt;/strong&gt;åç§°éƒ½åªèƒ½ä¸º&lt;code&gt;default&lt;/code&gt;ã€‚&lt;/br&gt;
åŒæ—¶é…ç½®å¤šä¸ªç­–ç•¥æ—¶ä½¿ç”¨æœ€çª„åŒ¹é…ç­–ç•¥ï¼Œ&lt;strong&gt;ç‰¹å®šæœåŠ¡&amp;gt;å‘½åç©ºé—´èŒƒå›´&amp;gt;ç½‘æ ¼èŒƒå›´&lt;/strong&gt;ï¼Œå¦‚æœå¤šä¸ª&lt;strong&gt;ç‰¹å®šäºæœåŠ¡çš„ç­–ç•¥&lt;/strong&gt;ä¸æœåŠ¡åŒ¹é…ï¼Œåˆ™éšæœºé€‰æ‹©ä¸€ä¸ªã€‚ä¸‹é¢æ˜¯ä¸åŒç­–ç•¥èŒƒå›´çš„å…·ä½“é…ç½®å‚è€ƒï¼š&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&lt;code&gt;Policy&lt;/code&gt;ç‰¹å®šäºæœåŠ¡çš„ç­–ç•¥&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;targets&lt;/code&gt;æ”¯æŒ&lt;code&gt;name&lt;/code&gt;ä»¥åŠ&lt;code&gt;ports&lt;/code&gt;åˆ—è¡¨&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: &amp;quot;authentication.istio.io/v1alpha1&amp;quot;
kind: &amp;quot;Policy&amp;quot;
metadata:
  name: &amp;quot;policy-name&amp;quot;
spec:
  targets:
  - name: service-name-1
  - name: service-name-2
    ports:
    - number: 8080
  peers:
  - mtls: {}
---
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;&lt;code&gt;Policy&lt;/code&gt;å‘½åç©ºé—´èŒƒå›´çš„ç­–ç•¥&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: &amp;quot;authentication.istio.io/v1alpha1&amp;quot;
kind: &amp;quot;Policy&amp;quot;
metadata:
  name: &amp;quot;default&amp;quot;
  namespace: &amp;quot;namespace-1&amp;quot;
spec:
  peers:
  - mtls: {}
---
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;&lt;code&gt;MeshPolicy&lt;/code&gt;ç½‘æ ¼èŒƒå›´ç­–ç•¥&lt;/strong&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: &amp;quot;authentication.istio.io/v1alpha1&amp;quot;
kind: &amp;quot;MeshPolicy&amp;quot;
metadata:
  name: &amp;quot;default&amp;quot;
spec:
  peers:
  - mtls: {}
---
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;2-ä¸‹æ¸¸-client-å¼€å¯tls&#34;&gt;2.ä¸‹æ¸¸&lt;code&gt;client&lt;/code&gt;å¼€å¯TLS&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;client&lt;/code&gt;ç«¯TLSç”±ç›®æ ‡è§„åˆ™&lt;code&gt;DestinationRule&lt;/code&gt;é…ç½®ï¼Œåœ¨æµé‡ç­–ç•¥&lt;code&gt;trafficPolicy&lt;/code&gt;ä¸­å¼€å¯&lt;code&gt;tls&lt;/code&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/reference/config/istio.networking.v1alpha3/#destinationrule&#34;&gt;Istioå‚è€ƒé…ç½®-é€šä¿¡è·¯ç”±#DestinationRule&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/reference/config/istio.networking.v1alpha3/#trafficpolicy&#34;&gt;Istioå‚è€ƒé…ç½®-é€šä¿¡è·¯ç”±#TrafficPolicy&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: service-name-1
spec:
  host: service-host-1
  # NOTE: å¼€å¯TLS
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
  subsets:
  - name: v1
    labels:
      version: v1
---
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;TLS&lt;code&gt;mode&lt;/code&gt;è¯´æ˜&lt;/strong&gt;&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&#34;center&#34;&gt;modeå€¼&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;æè¿°&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;DISABLE&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;ä¸è¦ä¸ºä¸Šæ¸¸ç«¯ç‚¹ä½¿ç”¨ TLSã€‚&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;SIMPLE&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;å‘ä¸Šæ¸¸ç«¯ç‚¹å‘èµ· TLS è¿æ¥ã€‚&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;MUTUAL&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;å‘é€å®¢æˆ·ç«¯è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼Œç”¨åŒå‘ TLS è¿æ¥ä¸Šæ¸¸ç«¯ç‚¹ã€‚&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;ISTIO_MUTUAL&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;å‘é€å®¢æˆ·ç«¯è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼Œç”¨åŒå‘ TLS è¿æ¥ä¸Šæ¸¸ç«¯ç‚¹ã€‚å’Œ MUTUAL ç›¸æ¯”ï¼Œè¿™ç§æ–¹å¼ä½¿ç”¨çš„åŒå‘ TLS è¯ä¹¦ç³»ç»Ÿæ˜¯ç”± Istio ç”Ÿæˆçš„ã€‚å¦‚æœä½¿ç”¨è¿™ç§æ¨¡å¼ï¼ŒTLSSettings ä¸­çš„å…¶ä»–å­—æ®µåº”è¯¥ç•™ç©ºã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&#34;rbac&#34;&gt;RBAC&lt;/h2&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/concepts/security/#%E6%8E%88%E6%9D%83&#34;&gt;Istioæ–‡æ¡£-æˆæƒ&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/concepts/security/#%E5%90%AF%E7%94%A8%E6%8E%88%E6%9D%83&#34;&gt;å¯ç”¨æˆæƒ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/concepts/security/#%E6%8E%88%E6%9D%83%E7%AD%96%E7%95%A5&#34;&gt;æˆæƒç­–ç•¥&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/tasks/security/role-based-access-control/&#34;&gt;Istioæ–‡æ¡£-åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/tasks/security/role-based-access-control/#%E6%9C%8D%E5%8A%A1%E7%BA%A7%E7%9A%84%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6&#34;&gt;æœåŠ¡çº§çš„è®¿é—®æ§åˆ¶&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/setup/kubernetes/upgrade/#%E8%BF%81%E7%A7%BB-rbacconfig-%E5%88%B0-clusterrbacconfig&#34;&gt;Istioæ–‡æ¡£-è¿ç§» RbacConfig åˆ° ClusterRbacConfig&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;em&gt;è¿™é‡Œä½¿ç”¨çš„&lt;code&gt;ClusterRbacConfig&lt;/code&gt;&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://istio.io/zh/docs/reference/config/authorization/&#34;&gt;Istioå‚è€ƒé…ç½®-æˆæƒ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;æœ‰å…³&lt;code&gt;RbacConfig&lt;/code&gt;ã€&lt;code&gt;ServiceRole&lt;/code&gt;ã€&lt;code&gt;ServiceRoleBinding&lt;/code&gt;çš„å±æ€§ç»“æ„Istioæ–‡æ¡£æœ‰è¯¦ç»†çš„é…ç½®å¯ä»¥å‚è€ƒ:&lt;a href=&#34;https://istio.io/zh/docs/reference/config/authorization/istio.rbac.v1alpha1/&#34;&gt;Istioå‚è€ƒé…ç½®-æˆæƒ-RBAC&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;1-å¼€å¯æˆæƒ-clusterrbacconfig&#34;&gt;1.å¼€å¯æˆæƒ&lt;code&gt;ClusterRbacConfig&lt;/code&gt;&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: &amp;quot;rbac.istio.io/v1alpha1&amp;quot;
kind: ClusterRbacConfig
metadata:
  name: default
  namespace: istio-system
spec:
  mode: &#39;ON_WITH_INCLUSION&#39;
  inclusion:
    #namespaces: [&amp;quot;namespace-1&amp;quot;]
    services: [&amp;quot;service-name-1.namespace-1.svc.cluster.local&amp;quot;, &amp;quot;service-name-2.namespace-1.svc.cluster.local&amp;quot;]
  # NOTE: ENFORCED/PERMISSIVEï¼Œä¸¥æ ¼æˆ–å®½å®¹æ¨¡å¼
  enforcement_mode: ENFORCED
---
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;enforcement_mode&lt;/code&gt;å¯ä»¥é€‰æ‹©&lt;code&gt;ENFORCED&lt;/code&gt;ä¸¥æ ¼æ¨¡å¼ï¼Œæˆ–&lt;code&gt;PERMISSIVE&lt;/code&gt;å®½å®¹æ¨¡å¼ï¼Œå®½å®¹æ¨¡å¼ä¾¿äºæˆæƒç­–ç•¥éœ€è¦&lt;strong&gt;å˜æ›´æ—¶è¿›è¡ŒéªŒè¯æµ‹è¯•&lt;/strong&gt;ï¼Œ&lt;a href=&#34;https://istio.io/zh/docs/tasks/security/role-based-access-control/#%E6%8E%88%E6%9D%83%E8%AE%B8%E5%8F%AF%E6%A8%A1%E5%BC%8F&#34;&gt;Istioä»»åŠ¡-æˆæƒè®¸å¯æ¨¡å¼&lt;/a&gt;ä»»åŠ¡ä¸­æœ‰æ›´å…·ä½“çš„åœºæ™¯ä»‹ç»ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;æ¨¡å¼&lt;code&gt;mode&lt;/code&gt;è¯´æ˜&lt;/strong&gt;&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&#34;center&#34;&gt;modeå€¼&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;æè¿°&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;OFF&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;å…³é—­ Istio RBACï¼ŒRbacConfig çš„æ‰€æœ‰é…ç½®å°†ä¼šå¤±æ•ˆï¼Œä¸” Istio RBAC Policies ä¸ä¼šæ‰§è¡Œã€‚&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;ON&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;ä¸ºæ‰€æœ‰ services å’Œ namespaces å¯ç”¨ Istio RBACã€‚&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;ON_WITH_INCLUSION&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;ä»…é’ˆå¯¹ inclusion å­—æ®µä¸­æŒ‡å®šçš„ services å’Œ namespaces å¯ç”¨ Istio RBACã€‚å…¶å®ƒä¸åœ¨ inclusion å­—æ®µä¸­çš„ services å’Œ namespaces å°†ä¸ä¼šè¢« Istio RBAC Policies å¼ºåˆ¶æ‰§è¡Œã€‚&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td align=&#34;center&#34;&gt;ON_WITH_EXCLUSION&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;é’ˆå¯¹é™¤äº† exclusion å­—æ®µä¸­æŒ‡å®šçš„ services å’Œ namespacesï¼Œå¯ç”¨ Istio RBACã€‚å…¶å®ƒä¸åœ¨ exclusion å­—æ®µä¸­çš„ services å’Œ namespaces å°†æŒ‰ç…§ Istio RBAC Policies æ‰§è¡Œã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&#34;2-è§’è‰²æƒé™è§„åˆ™-servicerole&#34;&gt;2.è§’è‰²æƒé™è§„åˆ™&lt;code&gt;ServiceRole&lt;/code&gt;&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;namespace&lt;/code&gt; + &lt;code&gt;services&lt;/code&gt; + &lt;code&gt;paths&lt;/code&gt; + &lt;code&gt;methods&lt;/code&gt; ä¸€èµ·å®šä¹‰äº†å¦‚ä½•è®¿é—®æœåŠ¡ï¼Œå…¶ä¸­&lt;code&gt;services&lt;/code&gt;å¿…é€‰ï¼Œå¦å¤–æœ‰&lt;code&gt;constraints&lt;/code&gt;å¯ä»¥æŒ‡å®šå…¶å®ƒçº¦æŸï¼Œæ”¯æŒçš„çº¦æŸå‚è€ƒ&lt;a href=&#34;https://istio.io/zh/docs/reference/config/authorization/constraints-and-properties/#%E6%94%AF%E6%8C%81%E7%9A%84%E7%BA%A6%E6%9D%9F&#34;&gt;Istioå‚è€ƒé…ç½®-æˆæƒ-çº¦æŸå’Œå±æ€§#æ”¯æŒçš„çº¦æŸ&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: &amp;quot;rbac.istio.io/v1alpha1&amp;quot;
kind: ServiceRole
metadata:
  name: service-role-1
  namespace: default
spec:
  rules:
  - services: [&amp;quot;service-name-1.namespace-1.svc.cluster.local&amp;quot;]
    methods: [&amp;quot;*&amp;quot;]
    # NOTE: æ ¹æ®çº¦æŸéœ€è¦ä¿®æ”¹
    constraints:
    - key: request.headers[version]
      values: [&amp;quot;v1&amp;quot;, &amp;quot;v2&amp;quot;]
---
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;3-è§’è‰²ç»‘å®šè§„åˆ™-servicerolebinding&#34;&gt;3.è§’è‰²ç»‘å®šè§„åˆ™&lt;code&gt;ServiceRoleBinding&lt;/code&gt;&lt;/h3&gt;

&lt;p&gt;&lt;code&gt;user&lt;/code&gt; + &lt;code&gt;properties&lt;/code&gt; ä¸€èµ·å®šä¹‰æˆæƒç»™è°ï¼Œæ”¯æŒçš„å±æ€§å‚è€ƒ&lt;a href=&#34;https://istio.io/zh/docs/reference/config/authorization/constraints-and-properties/#%E6%94%AF%E6%8C%81%E7%9A%84%E5%B1%9E%E6%80%A7&#34;&gt;Istioå‚è€ƒé…ç½®-æˆæƒ-çº¦æŸå’Œå±æ€§#æ”¯æŒçš„å±æ€§&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: &amp;quot;rbac.istio.io/v1alpha1&amp;quot;
kind: ServiceRoleBinding
metadata:
  name: service-rb-1
  namespace: default
spec:
  subjects:
  # NOTE: éœ€è¦æ·»åŠ  ServiceAccount
  - user: &amp;quot;cluster.local/ns/namespace-1/sa/service-account-2&amp;quot;
    # NOTE: æ ¹æ®å±æ€§éœ€è¦ä¿®æ”¹
    properties:
      source.namespace: &amp;quot;default&amp;quot;
  # NOTE: ingressgatewayæˆæƒ
  - user: &amp;quot;cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account&amp;quot;
  roleRef:
    kind: ServiceRole
    name: &amp;quot;service-role-1&amp;quot;
---
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;optional&#34;&gt;Optional&lt;/h2&gt;

&lt;h3 id=&#34;éƒ¨ç½²å®ä¾‹æ·»åŠ -serviceaccount&#34;&gt;éƒ¨ç½²å®ä¾‹æ·»åŠ &lt;code&gt;ServiceAccount&lt;/code&gt;&lt;/h3&gt;

&lt;p&gt;å¯¹äºéœ€è¦è¦åœ¨&lt;code&gt;ServiceRoleBinding&lt;/code&gt;çš„&lt;code&gt;subjects&lt;/code&gt;æ¡ä»¶ä¸­æˆæƒçš„&lt;code&gt;user&lt;/code&gt;ï¼Œéœ€è¦åœ¨éƒ¨ç½²å®ä¾‹æ—¶æŒ‡å®š&lt;code&gt;serviceAccountName&lt;/code&gt;ï¼Œå¦‚å‰é¢&lt;code&gt;ServiceRoleBinding&lt;/code&gt;é…ç½®è¦å…è®¸&lt;code&gt;service-2&lt;/code&gt;è®¿é—®&lt;code&gt;service-1&lt;/code&gt;ï¼Œåˆ™éƒ¨ç½²&lt;code&gt;service-2&lt;/code&gt;æ—¶éœ€è¦é…ç½®&lt;code&gt;serviceAccountName: service-account-2&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;# NOTE: åˆ›å»ºServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: service-account-2
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: service-name-2-v1
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: service-name-2
        version: v1
    spec:
      # NOTE: ä¸ºéƒ¨ç½²å®ä¾‹æŒ‡å®šserviceAccountName
      serviceAccountName: service-account-2
      containers:
      - name: service-name-2-v1
        command: [
          &amp;quot;/main&amp;quot;
        ]
        image: hbchen/service-2:v0.0.1
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9080
---
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;

&lt;p&gt;IstioæœåŠ¡ç½‘æ ¼å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°&lt;strong&gt;æœåŠ¡é—´è®¿é—®æ§åˆ¶&lt;/strong&gt;ï¼Œé€šè¿‡æœåŠ¡çº§çš„æˆæƒå¼€å…³ï¼Œå†ç»“åˆ&lt;code&gt;ServiceRole&lt;/code&gt;ã€&lt;code&gt;ServiceRoleBinding&lt;/code&gt;çš„çº¦æŸå’Œå±æ€§æ¡ä»¶ï¼Œå¯ä»¥å®ç°ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶ã€‚æœ¬æ–‡æœªæ¶‰åŠIstioçš„ç»ˆç«¯ç”¨æˆ·èº«ä»½éªŒè¯ï¼Œåé¢ä¼šç»“åˆ&lt;code&gt;Ingress&lt;/code&gt;ã€&lt;code&gt;Egress&lt;/code&gt;çš„&lt;code&gt;TLS&lt;/code&gt;å’Œ&lt;code&gt;JWT&lt;/code&gt;ä¸€èµ·åˆ†æè¾¹ç¼˜æµé‡ç›¸å…³çš„å®‰å…¨é—®é¢˜ã€‚&lt;/p&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Istioæºç ã€‘Mixer</title>
      <link>http://hbchen.com/post/servicemesh/2019-03-17-istio-code-mixer/</link>
      <pubDate>Sun, 17 Mar 2019 17:23:52 +0800</pubDate>
      
      <guid>http://hbchen.com/post/servicemesh/2019-03-17-istio-code-mixer/</guid>
      
        <description>&lt;p&gt;Mixeræ¨¡å—ä¸ºIstioæä¾›äº†æ¨¡å—åŒ–å¯æ‰©å±•çš„ç»„ä»¶ï¼Œå°†ç­–ç•¥ä¸é¥æµ‹è¿›è¡ŒæŠ½è±¡ï¼Œé€šè¿‡é…ç½®æ¨¡å‹è¿›è¡Œé…ç½®ã€‚åœ¨&lt;a href=&#34;http://hbchen.com/post/2019-03-05-custom-istio-mixer-adapter/&#34;&gt;ã€Šã€Istioã€‘è‡ªå®šä¹‰ Mixer Adapterç¤ºä¾‹æ•™ç¨‹(é™„æºç )ã€‹&lt;/a&gt;ä¸­ä»‹ç»äº†å¦‚ä½•è‡ªå®šä¹‰ä¸€ä¸ªAdapterï¼Œæœ¬æ–‡é€šè¿‡&lt;code&gt;mxier&lt;/code&gt;çš„æºç åˆ†æï¼Œè¿›ä¸€æ­¥äº†è§£é€‚é…å™¨å¦‚ä½•å·¥ä½œã€‚&lt;/p&gt;

&lt;p&gt;Istioéƒ¨ç½²ä¸­æœ‰ä¸¤ä¸ªæœåŠ¡ä¸&lt;code&gt;mixer&lt;/code&gt;æœ‰å…³:&lt;code&gt;istio-policy&lt;/code&gt;ã€&lt;code&gt;istio-telemetry&lt;/code&gt;ï¼Œåˆ†åˆ«è´Ÿè´£ç­–ç•¥ä¸é¥æµ‹ï¼Œè¿è¡Œçš„éƒ½æ˜¯&lt;code&gt;mixs&lt;/code&gt;ï¼›å¦å¤–&lt;code&gt;mixer&lt;/code&gt;çš„Clientç«¯åœ¨Sidecar&lt;code&gt;istio-proxy&lt;/code&gt;ï¼Œç«Ÿåƒæ˜¯&lt;code&gt;pilot-agent&lt;/code&gt;ï¼Œé•œåƒä¸­çš„&lt;code&gt;Envoy&lt;/code&gt;æ˜¯&lt;code&gt;istio/proxy&lt;/code&gt;é€šè¿‡&lt;code&gt;Envoy&lt;/code&gt;çš„&lt;code&gt;filter&lt;/code&gt;æ‰©å±•äº†&lt;code&gt;mixerclient&lt;/code&gt;ã€&lt;code&gt;jwt_auth&lt;/code&gt;ã€&lt;code&gt;authn&lt;/code&gt;ç­‰åŠŸèƒ½ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
&lt;li&gt;github.com/istio/istio &lt;strong&gt;release 1.1.0&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;github.com/istio/proxy &lt;strong&gt;release 1.1.0&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;mixeræ¨¡å—-mixs-server-æ‰§è¡Œåºåˆ—&#34;&gt;Mixeræ¨¡å—&lt;code&gt;mixs server&lt;/code&gt;æ‰§è¡Œåºåˆ—&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-mermaid&#34;&gt;sequenceDiagram
    participant s as server
    participant a as api
    participant r as runtime
    participant rd as runtine/dispatcher
    participant rc as runtime/config
    participant cs as config/store
    
    s -&amp;gt;&amp;gt; r: runtime.New()
    r --&amp;gt;&amp;gt; s: rt *Runtime
    s -&amp;gt;&amp;gt; r: p.runtimeListen(rt) â€”&amp;gt; rt.StartListening()
    r -&amp;gt;&amp;gt; cs: store.StartWatch()
    loop é…ç½®ç›‘æ§ 
    cs -&amp;gt;&amp;gt; cs: go func() { watchChan&amp;lt;-Event }
    end
    cs --&amp;gt;&amp;gt; r: &amp;lt;-watchChan
    
    loop é…ç½®æ›´æ–°
    r -&amp;gt;&amp;gt; rc: go func() { WatchChanges(watchChan) }
    alt &amp;lt;-watchChan
    Note over rd,rc: &amp;lt;-watchChan Eventå…ˆåšå †ç§¯
    cs -&amp;gt;&amp;gt; cs: append(events, event)
    
    else &amp;lt;-timeChan
    Note over rd,rc: &amp;lt;-timeChan è®¡æ—¶å™¨æ›´æ–°é…ç½®
    cs -&amp;gt;&amp;gt; r: onConfigChange()
    r -&amp;gt;&amp;gt; rc: ephemeral.ApplyEvent(events)
    rc -&amp;gt;&amp;gt; rc: entries Lock()ï¼Œæ›´æ–°entries
    r -&amp;gt;&amp;gt; r: processNewConfig()
    r -&amp;gt;&amp;gt; rc: ephemeral.BuildSnapshot()
    Note right of rc: åˆ›å»ºé…ç½®å¿«ç…§&amp;lt;br/&amp;gt;entries RLock()&amp;lt;br/&amp;gt;......&amp;lt;br/&amp;gt;e.processRuleConfigs
    rc -&amp;gt;&amp;gt; rc: processXXXConfigs()
    rc --&amp;gt;&amp;gt; r: nweSnapshot *Snapshot
    Note right of r: è·å¾—newHandlers
    r -&amp;gt;&amp;gt; r: handler.NewTable(nweSnapshot)
    Note right of r: è·å¾—newRoutes
    r -&amp;gt;&amp;gt; r: routing.BuildTable(newHandlers, nweSnapshot)
    Note right of r: æ›´æ–°RoutingContext
    r -&amp;gt;&amp;gt; rd: dispatcher.ChangeRoute(newRoutes)
    
    else &amp;lt;-stop
    Note over rd,rc: &amp;lt;-stop é€€å‡ºgoroutine
    cs --&amp;gt;&amp;gt; r: return
    end
    end
    
    r --&amp;gt;&amp;gt; s: nil or error
    s -&amp;gt;&amp;gt; a: api.NewGRPCServer(s.dispatcher)
    a --&amp;gt;&amp;gt; s: *MixerServer
    s -&amp;gt;&amp;gt; s: grpcServer.Serve()
    
    loop MixerServer
    activate a
    s -&amp;gt;&amp;gt; a: MixerServer Request
    Note right of a: MixeræœåŠ¡é€»è¾‘
    a -&amp;gt;&amp;gt; rd: Checkã€Quotaç­‰è°ƒåº¦
    activate rd
    rd -&amp;gt;&amp;gt; rd: session.dispatch()
    Note right of rd: æ ¹æ®varietyã€nsç­›é€‰&amp;lt;br/&amp;gt;destinations
    rd -&amp;gt;&amp;gt; rd: s.rc.Routes.GetDestinations()
    Note right of rd: ç­‰å¾…Adapterè°ƒåº¦å®Œæˆ
    rd -&amp;gt;&amp;gt; rd: s.waitForDispatched()
    rd --&amp;gt;&amp;gt; a: nil or error
    a --&amp;gt;&amp;gt; s: MixerServer Response
    deactivate rd
    deactivate s
    end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é€šè¿‡åºåˆ—åˆ†æå¯¹&lt;code&gt;mixs server&lt;/code&gt;æœ‰æ•´ä½“çš„äº†è§£ï¼Œå¯¹&lt;code&gt;.yaml&lt;/code&gt;é…ç½®é€»è¾‘çš„ç†è§£åœ¨&lt;code&gt;runtime/config/ephemeral.go&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// BuildSnapshot builds a stable, fully-resolved snapshot view of the configuration.
func (e *Ephemeral) BuildSnapshot() (*Snapshot, error) {
	// â€¦â€¦
	
	// NOTE: e.entriesä¸­Kindä¸ºattributemanifestçš„å±æ€§ï¼Œä»¥åŠe.templatesä¸­Varietyä¸ºTEMPLATE_VARIETY_ATTRIBUTE_GENERATORç”Ÿäº§çš„å±æ€§
	attributes := e.processAttributeManifests(monitoringCtx)
	
	// NOTE: e.entriesä¸­Kindä¸ºhandlerï¼Œä¸”åœ¨e.adaptersä¸­æœ‰å®šä¹‰çš„Resource
	shandlers := e.processStaticAdapterHandlerConfigs(monitoringCtx)
	
	// NOTE: e.entriesä¸­Kindåœ¨e.templatesä¸­çš„Resource
	af := ast.NewFinder(attributes)
	instances := e.processInstanceConfigs(monitoringCtx, af, errs)
    
	// New dynamic configurations
	dTemplates := e.processDynamicTemplateConfigs(monitoringCtx, errs)
	dAdapters := e.processDynamicAdapterConfigs(monitoringCtx, dTemplates, errs)
	dhandlers := e.processDynamicHandlerConfigs(monitoringCtx, dAdapters, errs)
	dInstances := e.processDynamicInstanceConfigs(monitoringCtx, dTemplates, af, errs)
    
	// NOTE: æ ¹æ®è§„åˆ™åŒ¹é…é»˜è®¤åŠåŠ¨æ€çš„handlersã€instancesé…ç½®
	rules := e.processRuleConfigs(monitoringCtx, shandlers, instances, dhandlers, dInstances, af, errs)
	// â€¦â€¦
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;istio-proxyä¸­-mixerclient-æ‰§è¡Œæµç¨‹&#34;&gt;istio/proxyä¸­&lt;code&gt;mixerclient&lt;/code&gt;æ‰§è¡Œæµç¨‹&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;src/envoy/BUILD

&lt;ul&gt;
&lt;li&gt;http/mixer:filter_lib&lt;/li&gt;
&lt;li&gt;tcp/mixer:filter_lib&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;src/envoy/httpã€tcp/mixer/filter.cc

&lt;ul&gt;
&lt;li&gt;åˆ†åˆ«åœ¨&lt;code&gt;decodeHeaders()&lt;/code&gt;å’Œ&lt;code&gt;onData()&lt;/code&gt;åš&lt;code&gt;Check()&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;src/istio/control/httpã€tcp/request_handler_impl.cc

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Check()&lt;/code&gt;å…ˆåšå±æ€§æ³¨å…¥&lt;/li&gt;
&lt;li&gt;src/istio/control/client_context_base.ccï¼Œ&lt;code&gt;SendCheck()&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;è°ƒç”¨&lt;code&gt;mixerclient-&amp;gt;Check()&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;src/istio/mixerclient/client_impl.cc

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Check()&lt;/code&gt;å…ˆè·å–ç¼“å­˜&lt;code&gt;checkPolicyCache()&lt;/code&gt;ï¼Œç¼“å­˜æ²¡æœ‰å‘½ä¸­åˆ™èµ°&lt;code&gt;RemoteCheck()&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;RemoteCheck()&lt;/code&gt;æˆåŠŸåæ›´æ–°ç¼“å­˜&lt;code&gt;updatePolicyCache()&lt;/code&gt;
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-mermaid&#34;&gt;graph TB;
  subgraph src/envoy
  A[mixer:filter_lib]--&amp;gt;|&amp;quot;decodeHeaders()&amp;quot;|B(http/mixer/filter.cc)
  A--&amp;gt;|&amp;quot;onData()&amp;quot;|C(tcp/mixer/filter.cc)
  end
  subgraph srv/istio/control
  B--&amp;gt;|&amp;quot;Check(){å±æ€§æ³¨å…¥}&amp;quot;|D(http/request_handler_impl.cc)
  C--&amp;gt;|&amp;quot;Check(){å±æ€§æ³¨å…¥}&amp;quot;|E(tcp/request_handler_impl.cc)
  D--&amp;gt;|&amp;quot;SendCheck()&amp;quot;|F(client_context_base.cc)
  E--&amp;gt;|&amp;quot;SendCheck()&amp;quot;|F
  end
  subgraph srv/istio/mixerclient
  F--&amp;gt;|&amp;quot;Check()&amp;quot;|G(client_impl.cc)
  G--&amp;gt;|&amp;quot;â‘ checkPolicyCache()&amp;quot;|H(check_context.cc)
  G--&amp;gt;|&amp;quot;â‘¡RemoteCheck()&amp;quot;|G
  G--&amp;gt;|&amp;quot;â‘¢updatePolicyCache()&amp;quot;|H
  end
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>ã€Istioã€‘è‡ªå®šä¹‰ Mixer Adapterç¤ºä¾‹æ•™ç¨‹(é™„æºç )</title>
      <link>http://hbchen.com/post/2019-03-05-custom-istio-mixer-adapter/</link>
      <pubDate>Tue, 05 Mar 2019 20:44:07 +0800</pubDate>
      
      <guid>http://hbchen.com/post/2019-03-05-custom-istio-mixer-adapter/</guid>
      
        <description>&lt;blockquote&gt;
&lt;p&gt;å¿«é€Ÿå¼€å§‹:&lt;a href=&#34;https://github.com/hb-go/micro-mesh/tree/master/examples/adapter/auth&#34;&gt;micro-mesh/examples/adapter/auth&lt;/a&gt;æºç ä¼ é€é—¨&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ç ”ç©¶Istioä¸‹æ„å»ºç®€æ´çš„å¾®æœåŠ¡æ¶æ„ï¼Œå¯¹Istioçš„ç ”ç©¶ä¹Ÿæ›´æ·±å…¥ï¼Œè‡ªå®šä¹‰Mixer Adapterå¿…ä¸å°‘ï¼Œä»¥ä¸‹ç»“åˆä½¿ç”¨åœºæ™¯åšä¸€ä¸ªè‡ªå®šä¹‰é€‚é…å™¨çš„å®è·µåˆ†äº«ã€‚&lt;/p&gt;

&lt;h2 id=&#34;èƒŒæ™¯&#34;&gt;èƒŒæ™¯&lt;/h2&gt;

&lt;p&gt;&lt;img src=&#34;https://raw.githubusercontent.com/hb-go/micro-mesh/master/doc/img/micro-mesh.jpg&#34; alt=&#34;auth-adapter&#34; /&gt;
ç»“åˆ&lt;a href=&#34;https://github.com/hb-go/micro-mesh#micro-mesh&#34;&gt;micro-mesh&lt;/a&gt;çš„å®è·µåœºæ™¯ï¼Œéœ€è¦åœ¨&lt;code&gt;ingressgateway&lt;/code&gt;ä¸&lt;code&gt;API service&lt;/code&gt;é—´åŠ å…¥è®¤è¯&amp;amp;é‰´æƒ(JWT&amp;amp;RBAC)ï¼Œè‡ªç„¶è€ƒè™‘Istioæä¾›çš„&lt;a href=&#34;https://istio.io/zh/docs/concepts/security/&#34;&gt;å®‰å…¨&lt;/a&gt;æ–¹æ¡ˆï¼Œä½†ä½¿ç”¨JWTåšè®¤è¯é‰´æƒåœ¨åç«¯æ˜¯æ— çŠ¶æ€çš„ï¼Œè¿™æ ·åœ¨ä½¿ç”¨åœºæ™¯ä¸Šæœ‰ä¸€å®šé™åˆ¶ï¼Œå¦‚:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å¯†ç ä¿®æ”¹ã€ç»ˆç«¯è¿æ¥é™åˆ¶ç­‰åœºæ™¯ä¸‹æ— æ³•è¸¢é™¤&lt;/li&gt;
&lt;li&gt;è®¿é—®æ§åˆ¶ç­–ç•¥æ— æ³•å®æ—¶ç”Ÿæ•ˆ&lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
&lt;p&gt;é»˜è®¤æ–¹æ¡ˆåªæ˜¯åœ¨ä¸€äº›åœºæ™¯ä¸‹ä¸åˆé€‚ï¼Œæ ¹æ®å…·ä½“éœ€æ±‚è€ƒè™‘&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;åŸºäºè¿™æ ·çš„åœºæ™¯å¯ä»¥è‡ªå®šä¹‰Adapteræ¥å®ç°ï¼Œç›®æ ‡:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Token-JWT

&lt;ul&gt;
&lt;li&gt;æœåŠ¡ç«¯éªŒè¯tokenæœ‰æ•ˆæ€§&lt;/li&gt;
&lt;li&gt;åº”å¯¹å¯†ç ä¿®æ”¹ã€ç»ˆç«¯æ•°é‡é™åˆ¶ç­‰åœºæ™¯&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;ACL-&lt;a href=&#34;http://github.com/casbin/casbin&#34;&gt;Casbin&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;æœåŠ¡ç«¯è·å–ç”¨æˆ·è§’è‰²ï¼ŒåšAPIè®¿é—®æ§åˆ¶&lt;/li&gt;
&lt;li&gt;ç”¨æˆ·è§’è‰²åŠæ¥å£æˆæƒç­–ç•¥å®æ—¶ç”Ÿæ•ˆ
&lt;br /&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä»¥ä¸‹ç¤ºä¾‹å¯¹tokenéªŒè¯ã€è®¿é—®æ§åˆ¶ä¸åšå…·ä½“è®¾è®¡ï¼Œé‡ç‚¹ä»‹ç»å¦‚ä½•è‡ªå®šä¹‰ä¸€ä¸ª&lt;code&gt;auth-adapter&lt;/code&gt;&lt;/p&gt;

&lt;h2 id=&#34;è‡ªå®šä¹‰adapterä»‹ç»&#34;&gt;è‡ªå®šä¹‰Adapterä»‹ç»&lt;/h2&gt;

&lt;p&gt;é…ç½®å…³ç³»åŠæ‰§è¡Œæµç¨‹å¦‚å›¾ï¼š
&lt;img src=&#34;https://raw.githubusercontent.com/hb-go/micro-mesh/master/doc/img/auth-adapter.jpg&#34; alt=&#34;auth-adapter&#34; /&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;å±æ€§ï¼šä½¿ç”¨&lt;code&gt;istio&lt;/code&gt;çš„&lt;code&gt;attributes&lt;/code&gt;ï¼Œ&lt;code&gt;istio/mixer/testdata/config/attributes.yaml&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;å±æ€§ä¸é€‚é…å™¨è¾“å…¥æ˜ å°„æ¨¡æ¿ï¼šä½¿ç”¨&lt;code&gt;istio&lt;/code&gt;çš„&lt;code&gt;authorization&lt;/code&gt;æ¨¡æ¿ï¼Œ&lt;code&gt;istio/mixer/template/authorization/template.yaml&lt;/code&gt;ï¼Œé€šè¿‡&lt;code&gt;template.proto&lt;/code&gt;æŸ¥çœ‹åè®®å†…å®¹&lt;/li&gt;
&lt;li&gt;é€‚é…å™¨ï¼Œ&lt;code&gt;micro-mesh/examples/adapter/auth/config/auth-adapter.yaml&lt;/code&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;go generate ./...&lt;/code&gt;è‡ªåŠ¨ç”Ÿæˆ&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;é€‚é…å™¨æœåŠ¡å¯åŠ¨é…ç½®ï¼Œ&lt;code&gt;micro-mesh/examples/adapter/auth/config/config.proto&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;é€‚é…å™¨æœåŠ¡å®ä¾‹ï¼Œ&lt;code&gt;micro-mesh/examples/adapter/auth/operatorconfig/cluster-service.yaml&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;é€‚é…å™¨é…ç½®ï¼Œ&lt;code&gt;micro-mesh/examples/adapter/auth/operatorconfig/operator-cfg.yaml&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;ç›®å½•ç»“æ„&#34;&gt;ç›®å½•ç»“æ„&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;bin                         æ‰§è¡Œæ–‡ä»¶
cmd                         
  â”” main.go                 é€‚é…å™¨å…¥å£
config                      é…ç½®åè®®
  â”œ adapter.auth.config.pb.html                 #go generate ./... è‡ªåŠ¨ç”Ÿæˆ
  â”œ auth-adapter.yaml       é€‚é…å™¨æè¿°æ–‡ä»¶       #go generate ./... è‡ªåŠ¨ç”Ÿæˆ
  â”œ config.pb.go                                #go generate ./... è‡ªåŠ¨ç”Ÿæˆ
  â”œ config.proto            é€‚é…å™¨æœåŠ¡å¯åŠ¨é…ç½®
  â”” config.proto_descriptor                     #go generate ./... è‡ªåŠ¨ç”Ÿæˆ
operatorconfig              k8sé…ç½®
  â”œ attributes.yaml         å±æ€§                  #copy istio/mixer/testdata/config/attributes.yaml
  â”œ cluster-service.yaml    é€‚é…å™¨æœåŠ¡å®ä¾‹
  â”œ operator-cfg.yaml       é€‚é…å™¨é…ç½®
  â”” template.yaml           å±æ€§ä¸é€‚é…å™¨è¾“å…¥æ¨¡æ¿    #copy istio/mixer/template/authorization/template.yaml
testdata                    æµ‹è¯•é…ç½®
  â”œ attributes.yaml         å±æ€§                  #copy istio/mixer/testdata/config/attributes.yaml
  â”œ auth-adapter.yaml       é€‚é…å™¨æè¿°æ–‡ä»¶         #copy config/auth-adapter.yaml
  â”œ operator-cfg.yaml       é€‚é…å™¨é…ç½®
  â”” template.yaml           å±æ€§ä¸é€‚é…å™¨è¾“å…¥æ¨¡æ¿    #copy istio/mixer/template/authorization/template.yaml
auth.go                     é€‚é…å™¨æœåŠ¡å®ç°
Dockerfile                  Dockeré•œåƒ
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æœ‰3å¤„ä¸é€‚é…å™¨å®ç°ç›¸å…³ï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;é€‚é…å™¨æœåŠ¡å¯åŠ¨é…ç½®&lt;code&gt;config/config.proto&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;é€‚é…å™¨æœåŠ¡å®ç°&lt;code&gt;auth.go&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;é€‚é…å™¨å…¥å£&lt;code&gt;cmd/main.go&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;blockquote&gt;
&lt;p&gt;æ¥ä¸‹æ¥ä½¿ç”¨&lt;a href=&#34;https://github.com/hb-go/micro-mesh/tree/master/examples/adapter/auth&#34;&gt;micro-mesh/examples/adapter/auth&lt;/a&gt;æºç æŒ‰æ­¥éª¤æ“ä½œï¼Œå®ç°æœ¬åœ°åŠ&lt;code&gt;GKE&lt;/code&gt;ç¯å¢ƒçš„æµ‹è¯•éƒ¨ç½²&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&#34;æ­¥éª¤&#34;&gt;æ­¥éª¤&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;å¼€å‘ç¯å¢ƒ&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;OSX&lt;/li&gt;
&lt;li&gt;Go &lt;strong&gt;1.11.1&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;protoc &lt;strong&gt;libprotoc 3.6.1&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;Istio &lt;strong&gt;1.1.0&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;1-istioæºç &#34;&gt;1.Istioæºç &lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;mkdir -p $GOPATH/src/istio.io/
cd $GOPATH/src/istio.io/
git clone https://github.com/istio/istio.git
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;2-micro-meshæºç &#34;&gt;2.micro-meshæºç &lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;git clone https://github.com/hb-go/micro-mesh.git
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;3-mixerå¼€å‘å·¥å…·&#34;&gt;3.Mixerå¼€å‘å·¥å…·&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# build mixer server &amp;amp; client 
cd istio
make mixs
make mixc
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨&lt;code&gt;$GOPATH/out/darwin_amd64/release/&lt;/code&gt;ç”Ÿæˆ&lt;code&gt;mixs&lt;/code&gt;ã€&lt;code&gt;mixc&lt;/code&gt;&lt;/p&gt;

&lt;h3 id=&#34;4-æ„å»ºauth-adapteré¡¹ç›®&#34;&gt;4.æ„å»ºAuth adapteré¡¹ç›®&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# copy auth adapter example
cp {micro-mesh path}/examples/adapter/auth mixer/adapter/auth

cd mixer/adapter/auth
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Optional&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;å¯ä»¥åˆ é™¤&lt;code&gt;config&lt;/code&gt;ç›®å½•é™¤&lt;code&gt;config.proto&lt;/code&gt;å¤–çš„å…¶ä»–æ–‡ä»¶ï¼Œçœ‹æ‰§è¡Œgo generateåçš„ç»“æœ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;go generate ./...
go build ./...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;go generate&lt;/code&gt;æ ¹æ®&lt;code&gt;config/config.proto&lt;/code&gt;ä»¥åŠ&lt;code&gt;auth.go&lt;/code&gt;çš„æ³¨é‡Šè‡ªåŠ¨ç”Ÿæˆ&lt;code&gt;config&lt;/code&gt;ç›®å½•ä¸‹çš„å…¶ä»–æ–‡ä»¶:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;adapter.auth.config.pb.html&lt;/li&gt;
&lt;li&gt;auth-adapter.yaml&lt;/li&gt;
&lt;li&gt;config.pb.go&lt;/li&gt;
&lt;li&gt;config.proto_descriptor&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ ¹æ®&lt;code&gt;auth.go&lt;/code&gt;çš„ä»¥ä¸‹æ³¨é‡Šï¼Œ&lt;code&gt;mixer_codegen.sh&lt;/code&gt;ä½¿ç”¨&lt;code&gt;authorization&lt;/code&gt;æ¨¡æ¿ç”Ÿæˆ&lt;code&gt;name&lt;/code&gt;ä¸º&lt;code&gt;auth-adapter&lt;/code&gt;çš„é€‚é…å™¨&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;// nolint:lll
// Generates the auth adapter&#39;s resource yaml. It contains the adapter&#39;s configuration, name, supported template
// names (metric in this case), and whether it is session or no-session based.
//go:generate $GOPATH/src/istio.io/istio/bin/mixer_codegen.sh -a mixer/adapter/auth/config/config.proto -x &amp;quot;-s=false -n auth-adapter -t authorization&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;/blockquote&gt;

&lt;h3 id=&#34;5-æœ¬åœ°æµ‹è¯•&#34;&gt;5.æœ¬åœ°æµ‹è¯•&lt;/h3&gt;

&lt;p&gt;æœ¬åœ°æµ‹è¯•ä½¿ç”¨testdataä¸‹çš„é…ç½®ï¼Œå…¶ä¸­&lt;code&gt;operator-cfg.yaml&lt;/code&gt;æœ‰å‡ å¤„ä¸æ­£å¼éƒ¨ç½²ä¸åŒï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;handler&lt;/code&gt;çš„&lt;code&gt;address&lt;/code&gt;ä½¿ç”¨æœ¬åœ°æœåŠ¡&lt;code&gt;&amp;quot;[::]:44225&amp;quot;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;ä¸ºäº†æ–¹ä¾¿æµ‹è¯•&lt;code&gt;instance&lt;/code&gt;çš„&lt;code&gt;params&lt;/code&gt;å‚æ•°ä»¥åŠ&lt;code&gt;rule&lt;/code&gt;çš„&lt;code&gt;math&lt;/code&gt;æ¡ä»¶åšäº†ç®€åŒ–&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# å¯åŠ¨é€‚é…å™¨æœåŠ¡
go run cmd/main.go 44225

# ä½¿ç”¨testdataä¸‹é…ç½®å¯åŠ¨mixer server
$GOPATH/out/darwin_amd64/release/mixs server \
--configStoreURL=fs://$GOPATH/src/istio.io/istio/mixer/adapter/auth/testdata \
--log_output_level=default:debug,attributes:debug

# æµ‹è¯•Adapteræ˜¯å¦ç”Ÿæ•ˆ
$GOPATH/out/darwin_amd64/release/mixc check -s request.host=&amp;quot;localhost&amp;quot; --stringmap_attributes &amp;quot;request.headers=x-custom-token:efg&amp;quot;
# Check RPC completed successfully. Check status was PERMISSION_DENIED (mm-example-auth.handler.istio-system:Unauthorized...)

$GOPATH/out/darwin_amd64/release/mixc check -s request.host=&amp;quot;localhost&amp;quot; --stringmap_attributes &amp;quot;request.headers=x-custom-token:abc&amp;quot;
# Check RPC completed successfully. Check status was OK
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;NOTE:å‡ºç°é¢„æœŸç»“æœä¸ä¸€è‡´å¯èƒ½æ˜¯ç”±äºmixer cacheå¯¼è‡´&lt;code&gt;Valid use count: 10000, valid duration: 9.726875254s&lt;/code&gt;ï¼Œè¯·å‚è€ƒ&lt;a href=&#34;http://www.servicemesher.com/categories/istio-mixer-cache&#34;&gt;Istio Mixer Cache&lt;/a&gt;ç³»åˆ—æ–‡ç« äº†è§£&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&#34;6-æ‰“åŒ…é•œåƒ&#34;&gt;6.æ‰“åŒ…é•œåƒ&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# buildæ‰§è¡Œæ–‡ä»¶
CGO_ENABLED=0 GOOS=linux \
    go build -a -installsuffix cgo -v -o bin/auth ./cmd/
    
# dockeré•œåƒ
docker build -t hbchen/micro-mesh-example-adapter-auth:v0.0.1 .
docker push hbchen/micro-mesh-example-adapter-auth:v0.0.1
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;7-istioç¯å¢ƒéƒ¨ç½²&#34;&gt;7.Istioç¯å¢ƒéƒ¨ç½²&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;éƒ¨ç½²ç¯å¢ƒ&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;GKE &lt;strong&gt;1.12.5-gke.10&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;Istio &lt;strong&gt;1.1.0&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# å±æ€§ã€æ¨¡æ¿
# attributes.yaml -&amp;gt; istio/mixer/testdata/config/attributes.yaml 
# template.yaml -&amp;gt; istio/mixer/template/authorization/template.yaml
kubectl apply -f examples/adapter/auth/testdata/attributes.yaml -f examples/adapter/auth/testdata/template.yaml

# é€‚é…å™¨
kubectl apply -f examples/adapter/auth/config/auth-adapter.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;blockquote&gt;
&lt;p&gt;è¿™é‡Œæ˜¯ä»¥&lt;a href=&#34;https://github.com/hb-go/micro-mesh&#34;&gt;micro-mesh&lt;/a&gt;ç¤ºä¾‹ä¸ºåŸºç¡€çš„é…ç½®ï¼Œå¦‚æœä½¿ç”¨&lt;code&gt;bookinfo&lt;/code&gt;æˆ–è€…è‡ªå·±çš„æœåŠ¡éœ€è¦åšç›¸åº”çš„ä¿®æ”¹&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;code&gt;operator-cfg.yaml&lt;/code&gt;ä¸æœ¬åœ°æµ‹è¯•é…ç½®ä¸åŒï¼š&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;handler&lt;/code&gt;çš„&lt;code&gt;address&lt;/code&gt;ä½¿ç”¨é›†ç¾¤æœåŠ¡&lt;code&gt;&amp;quot;mm-example-auth-adapter-service:44225&amp;quot;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;instance&lt;/code&gt;çš„&lt;code&gt;params&lt;/code&gt;æ ¹æ®&lt;code&gt;authorization&lt;/code&gt;æ¨¡æ¿åŠ&lt;code&gt;auth-adapter&lt;/code&gt;æœåŠ¡çš„éœ€æ±‚é…ç½®&lt;/li&gt;
&lt;li&gt;&lt;code&gt;rule&lt;/code&gt;çš„&lt;code&gt;match&lt;/code&gt;æ¡ä»¶ä½¿ç”¨&lt;code&gt;destination.service.name == &amp;quot;mm-example-api&amp;quot;&lt;/code&gt;æˆ–&lt;code&gt;destination.service.host == &amp;quot;mm-example-api.default.svc.cluster.local&amp;quot;&lt;/code&gt;ï¼Œä»…å¯¹&lt;code&gt;mm-example-api&lt;/code&gt;æœåŠ¡ç”Ÿæ•ˆ&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# é€‚é…å™¨æœåŠ¡å®ä¾‹éƒ¨ç½²
kubectl apply -f examples/adapter/auth/operatorconfig/cluster-service.yaml

# é€‚é…å™¨é…ç½®
kubectl apply -f examples/adapter/auth/operatorconfig/operator-cfg.yaml
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;8-istioç¯å¢ƒéƒ¨ç½²æµ‹è¯•&#34;&gt;8.Istioç¯å¢ƒéƒ¨ç½²æµ‹è¯•&lt;/h3&gt;

&lt;blockquote&gt;
&lt;p&gt;å¦‚æœæ²¡æœ‰å¼€Gatewayçš„JWTéªŒè¯å¯ä»¥å¿½ç•¥&lt;code&gt;Authorization&lt;/code&gt;ï¼Œå…¶å®åšäº†è‡ªå®šä¹‰Authåæ˜¯å¤šä½™çš„ğŸ˜‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;TOKEN=$(curl https://raw.githubusercontent.com/istio/istio/release-1.1/security/tools/jwt/samples/demo.jwt -s)

curl -H &amp;quot;Authorization: Bearer $TOKEN&amp;quot; -H &amp;quot;x-custom-token: efg&amp;quot; -H &amp;quot;Grpc-Metadata-x-tier: 2&amp;quot; -X GET http://35.192.111.18/v1/example/call/Hobo
curl -H &amp;quot;Authorization: Bearer $TOKEN&amp;quot; -H &amp;quot;x-custom-token: abc&amp;quot; -H &amp;quot;Grpc-Metadata-x-tier: 2&amp;quot; -X GET http://35.192.111.18/v1/example/call/Hobo

&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/istio/istio/wiki/Mixer-Out-of-Process-Adapter-Walkthrough&#34;&gt;Mixer Out of Process Adapter Walkthrough&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://medium.com/google-cloud/simple-istio-mixer-out-of-process-authorization-adapter-5f9363cd9bbc&#34;&gt;Simple Istio Mixer Out of Process Authorization Adapter&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
      
    </item>
    
    <item>
      <title>go-microåŠ å…¥IstioæœåŠ¡ç½‘æ ¼</title>
      <link>http://hbchen.com/post/2019-01-08-go-micro%E5%8A%A0%E5%85%A5istio%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/</link>
      <pubDate>Thu, 21 Feb 2019 16:59:37 +0800</pubDate>
      
      <guid>http://hbchen.com/post/2019-01-08-go-micro%E5%8A%A0%E5%85%A5istio%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/</guid>
      
        <description>&lt;p&gt;å°†go-microæœåŠ¡åŠ å…¥service meshï¼ŒClientã€Serverä¸éœ€è¦Registryã€Selectorã€Transportç­‰ï¼Œé€šè¿‡è‡ªå®šä¹‰microçš„server &amp;amp; clientæ’ä»¶ï¼Œå»æ‰åœ¨istioä¸­ä¸éœ€è¦çš„ç»„ä»¶ä¾èµ–ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/go-micro-istio.jpg&#34; alt=&#34;go-micro&#34; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/hb-go/micro-plugins&#34;&gt;hb-go/micro-plugins&lt;/a&gt;å®ç°äº†gRPCã€httpçš„Istioç‰ˆæœ¬Pluginï¼Œä¸‹é¢ä»‹ç»å¦‚ä½•ä½¿ç”¨ã€‚&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å®Œæ•´ç¤ºä¾‹å‚è€ƒ&lt;a href=&#34;https://github.com/hb-go/micro/tree/master/istio&#34;&gt;hb-go/micro/istio&lt;/a&gt;ï¼Œç¤ºä¾‹åŒ…æ‹¬httpã€gRPC&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h5 id=&#34;å‘½ä»¤è¡Œå‚æ•°&#34;&gt;å‘½ä»¤è¡Œå‚æ•°&lt;/h5&gt;

&lt;p&gt;æ–¹ä¾¿æœåŠ¡è¿è¡Œæ—¶æŒ‡å®šç«¯å£ï¼Œåœ¨å‘½ä»¤è¡Œè·å–æœåŠ¡serverã€clientç«¯å£é…ç½®ï¼Œå‚æ•°æ ¹æ®å…·ä½“æƒ…å†µè‡ªè¡Œè®¾è®¡&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;åœ¨æœåŠ¡ç½‘æ ¼ä¸­æˆ‘å€¾å‘ç»Ÿä¸€ä¸Šä¸‹æ¸¸æœåŠ¡ç«¯å£ï¼Œé¿å…ä¸å¿…è¦çš„é…ç½®ä»¥åŠå› æ­¤å¼•å‘çš„å†²çªé—®é¢˜&lt;/p&gt;
&lt;/blockquote&gt;

&lt;ul&gt;
&lt;li&gt;Clientç«¯æœåŠ¡åœ°å€&lt;code&gt;CallOptions.Address&lt;/code&gt;è§£æè§„åˆ™ï¼š

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;:&lt;/code&gt;å¼€å¤´ï¼Œå°†&lt;code&gt;service.Name&lt;/code&gt;ä¸­&lt;code&gt;.&lt;/code&gt;æ›¿æ¢ä¸º&lt;code&gt;-&lt;/code&gt;ï¼ŒåŠ &lt;code&gt;CallOptions.Address&lt;/code&gt;ï¼Œå¦‚&lt;code&gt;go.micro.api.sample&lt;/code&gt; &lt;code&gt;:9080&lt;/code&gt; =&amp;gt; &lt;code&gt;go-micro-api-sample:9080&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;é&lt;code&gt;:&lt;/code&gt;å¼€å¤´ï¼Œå›ºå®šåœ°å€&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;var (
	serverAddr string
	callAddr   string
	cmdHelp    bool
)

func init() {
	flag.StringVar(&amp;amp;serverAddr, &amp;quot;server_address&amp;quot;, &amp;quot;0.0.0.0:9080&amp;quot;, &amp;quot;server address.&amp;quot;)
	flag.StringVar(&amp;amp;callAddr, &amp;quot;client_call_address&amp;quot;, &amp;quot;:9080&amp;quot;, &amp;quot;client call options address.&amp;quot;)
	flag.Parse()
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;è‡ªå®šä¹‰server-clientæ’ä»¶-åˆ›å»ºæœåŠ¡&#34;&gt;è‡ªå®šä¹‰serverã€clientæ’ä»¶ï¼Œåˆ›å»ºæœåŠ¡&lt;/h5&gt;

&lt;blockquote&gt;
&lt;p&gt;ç”±äºmicroæ¡†æ¶å¯¹å‘½ä»¤è¡Œçš„è§£æé—®é¢˜ï¼Œåˆ›å»ºæœåŠ¡æ—¶éœ€è¦å¢åŠ &lt;code&gt;micro.Flags(...)&lt;/code&gt;ï¼Œå…¼å®¹è‡ªå®šä¹‰å‚æ•°ï¼Œå¦‚:&lt;code&gt;client_call_address&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-go&#34;&gt;import (
	httpClient &amp;quot;github.com/hb-go/micro-plugins/client/istio_http&amp;quot;
	httpServer &amp;quot;github.com/hb-go/micro-plugins/server/istio_http&amp;quot;
)

func main() {
	c := httpClient.NewClient(
		client.ContentType(&amp;quot;application/json&amp;quot;),
		func(o *client.Options) {
			o.CallOptions.Address = callAddr
		},
	)
	s := httpServer.NewApiServer(
		server.Address(serverAddr),
	)

	// New Service
	service := micro.NewService(
		micro.Name(&amp;quot;go.micro.api.sample&amp;quot;),
		micro.Version(&amp;quot;latest&amp;quot;),
		micro.Registry(noop.NewRegistry()),
		micro.Client(c),
		micro.Server(s),

		// å…¼å®¹micro cmd parse
		micro.Flags(cli.StringFlag{
			Name:   &amp;quot;client_call_address&amp;quot;,
			EnvVar: &amp;quot;MICRO_CLIENT_CALL_ADDRESS&amp;quot;,
			Usage:  &amp;quot; Invalid!!!&amp;quot;,
		}),
	)

	service.Options().Cmd.Init()
	
	// â€¦â€¦
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;æœåŠ¡éƒ¨ç½²-yaml&#34;&gt;æœåŠ¡éƒ¨ç½².yaml&lt;/h5&gt;

&lt;blockquote&gt;
&lt;p&gt;å…¶å®ƒIstioç›¸å…³.yamlå‚è€ƒå®Œæ•´ç¤ºä¾‹&lt;a href=&#34;https://github.com/hb-go/micro/tree/master/istio/k8s&#34;&gt;hb-go/micro/istio/k8s&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;######################################################################################
# API service
######################################################################################
apiVersion: v1
kind: Service
metadata:
  name: go-micro-api-sample
  labels:
    app: go-micro-api-sample
spec:
  ports:
  - port: 9080
    name: http
  selector:
    app: go-micro-api-sample
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: go-micro-api-sample-v1
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: go-micro-api-sample
        version: v1
    spec:
      containers:
      - name: go-micro-api-sample
        command: [
          &amp;quot;/sample&amp;quot;,
          &amp;quot;-server_address=0.0.0.0:9080&amp;quot;,
          &amp;quot;-client_call_address=:9080&amp;quot;,
        ]
        image: hbchen/go-micro-istio-api-sample:v0.0.5
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9080
---
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>Spark &#43; Elasticsearchæ„å»ºæ¨èç³»ç»Ÿ</title>
      <link>http://hbchen.com/post/2018-10-24-spark-elasticsearch-recommender/</link>
      <pubDate>Wed, 24 Oct 2018 16:23:46 +0800</pubDate>
      
      <guid>http://hbchen.com/post/2018-10-24-spark-elasticsearch-recommender/</guid>
      
        <description>&lt;p&gt;Github &lt;a href=&#34;https://github.com/hb-chen/spark-elasticsearch-recommender&#34;&gt;hb-chen/spark-elasticsearch-recommender&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Zeppelin &lt;code&gt;0.8.0&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Spark &lt;code&gt;2.3.2&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Elasticsearch &lt;code&gt;6.3.2&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;1-ç¯å¢ƒå‡†å¤‡&#34;&gt;1.ç¯å¢ƒå‡†å¤‡&lt;/h4&gt;

&lt;blockquote&gt;
&lt;p&gt;Mac OSX&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h5 id=&#34;zeppeline&#34;&gt;Zeppeline&lt;/h5&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# http://www.apache.org/dyn/closer.cgi/zeppelin/zeppelin-0.8.0/zeppelin-0.8.0-bin-netinst.tgz
$ wget http://mirrors.shu.edu.cn/apache/zeppelin/zeppelin-0.8.0/zeppelin-0.8.0-bin-netinst.tgz
$ tar -zxf zeppelin-0.8.0-bin-netinst.tgz
$ cd zeppelin-0.8.0-bin-netinst

# å®‰è£…å¿…è¦interpreter
$ ./bin/install-interpreter.sh --name md,elasticsearch
$ ./bin/zeppelin-daemon.sh start
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;spark&#34;&gt;Spark&lt;/h5&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# http://spark.apache.org/downloads.html
$ wget https://www.apache.org/dyn/closer.lua/spark/spark-2.3.2/spark-2.3.2-bin-hadoop2.7.tgz
$ tar -zxf spark-2.3.2-bin-hadoop2.7.tgz
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;elasticsearch&#34;&gt;Elasticsearch&lt;/h5&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# https://www.elastic.co/downloads/past-releases
# Elasticsearch + 6.3.2
$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.3.2.zip
$ unzip elasticsearch-6.3.2.zip

# ES-Hadoop + 6.3.2
$ wget https://artifacts.elastic.co/downloads/elasticsearch-hadoop/elasticsearch-hadoop-6.3.2.zip
$ unzip elasticsearch-hadoop-6.3.2.zip
&lt;/code&gt;&lt;/pre&gt;

&lt;h6 id=&#34;elasticsearch-çŸ¢é‡è¯„åˆ†æ’ä»¶&#34;&gt;Elasticsearch çŸ¢é‡è¯„åˆ†æ’ä»¶&lt;/h6&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/muhleder/elasticsearch-vector-scoring&#34;&gt;muhleder/elasticsearch-vector-scoring&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# ä¿®æ”¹build.gradleï¼Œè¿™æ ·ä¸å¿…Checkout Elasticsearch 
# https://github.com/muhleder/elasticsearch-vector-scoring/issues/1#issuecomment-415267767
buildscript {
  repositories {
    jcenter()
    mavenLocal()
  }
  dependencies {
    classpath &amp;quot;org.elasticsearch.gradle:build-tools:6.3.2&amp;quot;
  }
}

apply plugin: &#39;idea&#39;
apply plugin: &#39;java&#39;
apply plugin: &#39;elasticsearch.esplugin&#39;

licenseFile = rootProject.file(&#39;LICENSE&#39;)
noticeFile = rootProject.file(&#39;NOTICE&#39;)

esplugin {
  name &#39;elasticsearch-vector-scoring&#39;
  description &#39;Provides a fast vector multiplication script.&#39;
  classname &#39;com.gosololaw.elasticsearch.VectorScoringPlugin&#39;
}

dependencies {
  compile &amp;quot;org.elasticsearch:elasticsearch:6.3.2&amp;quot;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# æ’ä»¶å®‰è£…
$ ./bin/elasticsearch-plugin install {file:///path/to/plugin.zip}
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;pythonä¾èµ–åº“&#34;&gt;Pythonä¾èµ–åº“&lt;/h5&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ pip install elasticsearch
$ pip install numpy
$ pip install tmdbsimple # å¿½ç•¥ï¼Œæš‚æ—¶æœªä½¿ç”¨
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;movielensæ•°æ®é›†-https-grouplens-org-datasets-movielens-ä¸‹è½½&#34;&gt;&lt;a href=&#34;https://grouplens.org/datasets/movielens/&#34;&gt;Movielensæ•°æ®é›†&lt;/a&gt;ä¸‹è½½&lt;/h5&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cd data # ä¸zeppelin-0.8.0-bin-netinståŒPathï¼Œnoteä¸­é…ç½®PATH_TO_DATA = &amp;quot;../data/ml-latest-small&amp;quot;
$ wget http://files.grouplens.org/datasets/movielens/ml-latest-small.zip
$ unzip ml-latest-small.zip
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;2-å¯åŠ¨æœåŠ¡&#34;&gt;2.å¯åŠ¨æœåŠ¡&lt;/h4&gt;

&lt;h5 id=&#34;elasticsearchå¯åŠ¨&#34;&gt;Elasticsearchå¯åŠ¨&lt;/h5&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ./bin/elasticsearch
&lt;/code&gt;&lt;/pre&gt;

&lt;h5 id=&#34;zeppeliné…ç½®åŠå¯åŠ¨&#34;&gt;Zeppeliné…ç½®åŠå¯åŠ¨&lt;/h5&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ cp conf/shiro.ini.template conf/shiro.ini
$ vim conf/shiro.ini
# ç®¡ç†å‘˜è´¦æˆ·å¯†ç 
[users]
admin = 123456, admin

$ cp conf/zeppelin-env.sh.template conf/zeppelin-env.sh
$ vim conf/zeppelin-env.sh
# Sparké…ç½®
export SPARK_HOME=/{apache-spark-path}/spark-2.3.2-bin-hadoop2.7
export SPARK_SUBMIT_OPTIONS=&amp;quot;--driver-memory 2G&amp;quot;

$ cp conf/zeppelin-site.xml.template conf/zeppelin-site.xml
$ vim conf/zeppelin-site.xml
# æ ¹æ®éœ€è¦å¯ä»¥ä¿®æ”¹zeppelin.server.portç­‰é…ç½®

# å¯åŠ¨
$ ./bin/zeppelin-daemon.sh start
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;3-notebook&#34;&gt;3.Notebook&lt;/h4&gt;

&lt;p&gt;&lt;a href=&#34;http://localhost:8080&#34;&gt;http://localhost:8080&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;# Create new interpreter
# md

# elasticsearch
elasticsearch.client.type http
elasticsearch.port	9200

# spark
# æ·»åŠ Dependencies
artifact /{elasticsearch-hadoop-path}/elasticsearch-hadoop-6.3.2/dist/elasticsearch-spark-20_2.11-6.3.2.jar
&lt;/code&gt;&lt;/pre&gt;

&lt;h4 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/IBM/elasticsearch-spark-recommender&#34;&gt;ä½¿ç”¨ Apache Spark å’Œ Elasticsearch æ„å»ºä¸€ä¸ªæ¨èç³»ç»Ÿ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
      
    </item>
    
    <item>
      <title>go-microæ¡†æ¶ä»‹ç»</title>
      <link>http://hbchen.com/post/2018-03-27-go-micro-%E6%A1%86%E6%9E%B6%E4%BB%8B%E7%BB%8D/</link>
      <pubDate>Tue, 27 Mar 2018 19:09:32 +0800</pubDate>
      
      <guid>http://hbchen.com/post/2018-03-27-go-micro-%E6%A1%86%E6%9E%B6%E4%BB%8B%E7%BB%8D/</guid>
      
        <description>&lt;h2 id=&#34;go-micro-https-github-com-micro-go-micro&#34;&gt;&lt;a href=&#34;https://github.com/micro/go-micro&#34;&gt;go-micro&lt;/a&gt;&lt;/h2&gt;

&lt;p&gt;go-microæ˜¯Microçš„æ ¸å¿ƒï¼Œæ˜¯ä¸€å¥—Goè¯­è¨€çš„å¯æ’æ‹”RPCæ¡†æ¶ï¼Œæä¾›æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€åŒæ­¥/å¼‚æ­¥é€šä¿¡ã€ç¼–ç ã€æœåŠ¡æ¥å£ç­‰ï¼Œæ‰€æœ‰ç»„ä»¶å‡è®¾è®¡ä¸ºInterfaceï¼Œä¾¿äºæ‰©å±•&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;http://hbchen.com/img/go-micro.jpg&#34; alt=&#34;go-micro&#34; /&gt;&lt;/p&gt;

&lt;p&gt;ä¸»è¦æœ‰ä»¥ä¸‹ç»„ä»¶æ„æˆ:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Registry&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;æä¾›ä¸€å¥—æœåŠ¡æ³¨å†Œã€å‘ç°ã€æ³¨é”€ã€ç›‘æµ‹æœºåˆ¶ï¼ŒæœåŠ¡æ³¨å†Œä¸­å¿ƒæ”¯æŒconsulã€etcd2/3ã€zookeeperã€gossipã€k8sã€eurekaç­‰&lt;/p&gt;
&lt;/blockquote&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Selector&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;é€‰æ‹©å™¨æä¾›äº†è´Ÿè½½å‡è¡¡ï¼Œå¯ä»¥é€šè¿‡è¿‡æ»¤æ–¹æ³•å¯¹å¾®æœåŠ¡è¿›è¡Œè¿‡æ»¤ï¼Œå¹¶é€šè¿‡ä¸åŒè·¯ç”±ç®—æ³•é€‰æ‹©å¾®æœåŠ¡ï¼Œä»¥åŠç¼“å­˜ç­‰&lt;/p&gt;
&lt;/blockquote&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Transport&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å¾®æœåŠ¡é—´åŒæ­¥è¯·æ±‚/å“åº”é€šä¿¡æ–¹å¼ï¼Œç›¸å¯¹Goæ ‡å‡†netåŒ…åšäº†æ›´é«˜çš„æŠ½è±¡ï¼Œæ”¯æŒæ›´å¤šçš„ä¼ è¾“æ–¹å¼ï¼Œå¦‚httpã€grpcã€tcpã€udpã€Rabbitmqç­‰&lt;/p&gt;
&lt;/blockquote&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Broker&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å¾®æœåŠ¡é—´å¼‚æ­¥å‘å¸ƒ/è®¢é˜…é€šä¿¡æ–¹å¼ï¼Œæ›´å¥½çš„å¤„ç†åˆ†å¸ƒå¼ç³»ç»Ÿè§£è€¦é—®é¢˜ï¼Œé»˜è®¤ä½¿ç”¨httpæ–¹å¼ï¼Œç”Ÿäº§ç¯å¢ƒé€šå¸¸ä¼šä½¿ç”¨æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå¦‚Kafkaã€RabbitMQã€NSQç­‰&lt;/p&gt;
&lt;/blockquote&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Codec&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;æœåŠ¡é—´æ¶ˆæ¯çš„ç¼–è§£ç ï¼Œæ”¯æŒjsonã€protobufã€bsonã€msgpackç­‰ï¼Œä¸æ™®é€šç¼–ç æ ¼å¼ä¸åŒéƒ½æ˜¯æ”¯æŒRPCæ ¼å¼&lt;/p&gt;
&lt;/blockquote&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Server&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;ç”¨äºå¯åŠ¨æœåŠ¡ï¼Œä¸ºæœåŠ¡å‘½åã€æ³¨å†ŒHandlerã€æ·»åŠ ä¸­é—´ä»¶ç­‰&lt;/p&gt;
&lt;/blockquote&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Client&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;æä¾›å¾®æœåŠ¡å®¢æˆ·ç«¯ï¼Œé€šè¿‡Registryã€Selectorã€Transportã€Brokerå®ç°ä»¥æœåŠ¡åæ¥æŸ¥æ‰¾æœåŠ¡ã€è´Ÿè½½å‡è¡¡ã€åŒæ­¥é€šä¿¡ã€å¼‚æ­¥æ¶ˆæ¯ç­‰&lt;/p&gt;
&lt;/blockquote&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;micro-https-github-com-micro-micro&#34;&gt;&lt;a href=&#34;https://github.com/micro/micro&#34;&gt;micro&lt;/a&gt;&lt;/h2&gt;

&lt;p&gt;Microçš„å·¥å…·åŒ…ï¼Œä¸»è¦ç”±ä»¥ä¸‹éƒ¨åˆ†æ„æˆ:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;API&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;APIç½‘å…³æä¾›HTTPæœåŠ¡ï¼Œå¹¶å°†è¯·æ±‚è·¯ç”±åˆ°æŒ‡å®šçš„å¾®æœåŠ¡ï¼Œæ˜¯Microçš„ç»Ÿä¸€å…¥å£ï¼Œå¯ä»¥ç”¨ä½œåå‘ä»£ç†ï¼Œæˆ–è€…å°†HTTPè¯·æ±‚è½¬åˆ°RPC&lt;/p&gt;
&lt;/blockquote&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Web&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;ä¸ºMicroæä¾›ä¸€å¥—ä»ªè¡¨ç›˜ï¼Œå¹¶å¯ä½œä¸ºWebåº”ç”¨çš„åå‘ä»£ç†ï¼Œæœ‰åˆ«äºæ™®é€šAPIå°†Webåº”ç”¨ä½œä¸ºäº†Microçš„ä¸€ç­‰å…¬æ°‘ï¼Œå…¶å®å’ŒAPIå·®ä¸å¤šï¼Œä½†åŒæ—¶æä¾›äº†å¯¹socketçš„æ”¯æŒ&lt;/p&gt;
&lt;/blockquote&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Sidecar&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;é€šè¿‡HTTPçš„æ–¹å¼å®ç°go-microå…¨éƒ¨åŠŸèƒ½çš„RPCä»£ç†ï¼Œé€šè¿‡Sidecarå¯ä»¥æ–¹ä¾¿çš„å°†å…¶ä»–è¯­è¨€é›†æˆåˆ°Microæ¡†æ¶ä¸­ï¼Œæ–¹ä¾¿è§£å†³è§£å†³åº”ç”¨çš„å¼‚æ„æ¡†æ¶é—®é¢˜&lt;/p&gt;
&lt;/blockquote&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;CLI&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;æä¾›ä¸€å¥—å‘½ä»¤è¡Œå·¥å…·ï¼Œå¯ä»¥æ–¹ä¾¿çš„ä¸MicroæœåŠ¡è¿›è¡Œäº¤äº’ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡Sidecarä»£ç†CLIå‘½ä»¤&lt;/p&gt;
&lt;/blockquote&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Bot&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;é€šè¿‡Botå¯ä»¥åœ¨Microç¯å¢ƒä¸­æ–¹ä¾¿çš„ä¸Slackã€HipChatã€XMPPç­‰è¿›è¡Œé›†æˆï¼Œé€šè¿‡æ¶ˆæ¯çš„æ–¹å¼æ¨¡ä»¿CLIåŠŸèƒ½&lt;/p&gt;
&lt;/blockquote&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;go-plugins-https-github-com-micro-go-plugins&#34;&gt;&lt;a href=&#34;https://github.com/micro/go-plugins&#34;&gt;go-plugins&lt;/a&gt;&lt;/h3&gt;

&lt;p&gt;go-pluginsæ˜¯Microçš„æ’ä»¶åº“ï¼Œé™¤go-microç›¸åº”ç»„ä»¶çš„æ‰©å±•å¤–ï¼Œè¿˜æœ‰å…¶ä»–å¦‚Traceã€KVå­˜å‚¨ã€ç›‘æ§ç­‰&lt;/p&gt;</description>
      
    </item>
    
    <item>
      <title>Centos VSFTPé…ç½®</title>
      <link>http://hbchen.com/post/2014-10-17-centos-vsftp/</link>
      <pubDate>Fri, 17 Oct 2014 16:18:00 +0800</pubDate>
      
      <guid>http://hbchen.com/post/2014-10-17-centos-vsftp/</guid>
      
        <description>&lt;p&gt;å®‰è£…&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;yum install vsftp
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é…ç½®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;#/etc/vsftpd/vsftpd.conf
#å…³é—­åŒ¿åç™»å½•
#anonymous_enable=NO

user_listä¸­çš„è¯´æ˜æ˜¯userlist_deny
#userlist_enable=NO

FTP root
#local_root=/mnt/ftp

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ·»åŠ ç™»å½•ç”¨æˆ·&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;æ·»åŠ ç”¨æˆ·
$ useradd Hobo
è®¾ç½®å¯†ç 
$ passwd Hobo
$åŠ å…¥user_list
$ echo Hobo &amp;gt;&amp;gt; /etc/vsftpd/user_list
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é‡å¯&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$service vsftpd restart
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>MySQL Backup</title>
      <link>http://hbchen.com/post/2014-10-17-mysql-backup/</link>
      <pubDate>Fri, 17 Oct 2014 14:04:00 +0800</pubDate>
      
      <guid>http://hbchen.com/post/2014-10-17-mysql-backup/</guid>
      
        <description>&lt;p&gt;MySQLå¤‡ä»½è„šæœ¬ï¼Œæ”¯æŒmysqldump,mysqlhotcopy,tarä¸‰ç§æ–¹å¼ï¼Œ+å®šæ—¶ä»»åŠ¡è‡ªåŠ¨å¤‡ä»½ã€‚&lt;/p&gt;

&lt;p&gt;Gist
&lt;a href=&#34;https://gist.github.com/Hobo86/effd4b45b50f576bf4d1&#34;&gt;https://gist.github.com/Hobo86/effd4b45b50f576bf4d1&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#è„šæœ¬å±æ€§è®¾ä¸ºå¯æ‰§è¡Œ
$ chmod +x mysql_backup.sh
 
#ç¼–è¾‘å®šæ—¶ä»»åŠ¡
$ vi /etc/crontab
 
å¦‚ï¼šæ¯å¤©03:01æ‰§è¡Œå¤‡ä»½è„šæœ¬
01 3 * * * root /usr/sbin/mysql_backup.sh
 
#é‡å¯å®šæ—¶ä»»åŠ¡
$ /etc/rc.d/init.d/crond restart
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Gist
&lt;a href=&#34;https://gist.github.com/Hobo86/29b27d361a4c59545348&#34;&gt;https://gist.github.com/Hobo86/29b27d361a4c59545348&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#mysql_backup.sh
#!/bin/bash
 
DBName=db_name
 
DBUser=root
 
DBPasswd=123456
 
BackupPath=/mnt/backup/
 
LogFile=/mnt/backup/db_name.log
 
DBPath=/mnt/mysql/
 
BackupMethod=mysqldump
 
#BackupMethod=mysqlhotcopy
 
#BackupMethod=tar
 
 
NewFile=&amp;quot;$BackupPath&amp;quot;db_name_$(date +%y%m%d).tgz
 
DumpFile=&amp;quot;$BackupPath&amp;quot;db_name_$(date +%y%m%d)
 
OldFile=&amp;quot;$BackupPath&amp;quot;db_name_$(date +%y%m%d --date=&#39;5 days ago&#39;).tgz
 
#SettingEnd
 
echo &amp;quot;-------------------------------------------&amp;quot;&amp;gt;&amp;gt;$LogFile
echo $(date +%Y-%m-%d%t%H:%M:%S)&amp;gt;&amp;gt;$LogFile
 
echo &amp;quot;--------------------------&amp;quot;&amp;gt;&amp;gt;$LogFile
 
#DeleteOldFile
if [ -f $OldFile ]
	then
		rm -f $OldFile&amp;gt;&amp;gt;$LogFile 2&amp;gt;&amp;amp;1
		echo &amp;quot;[$OldFile]DeleteOldFileSuccess!&amp;quot;&amp;gt;&amp;gt;$LogFile
	else
		echo &amp;quot;[$OldFile]NoOldBackupFile!&amp;quot;&amp;gt;&amp;gt;$LogFile
fi
 
if [ -f $NewFile ] 
	then
		echo &amp;quot;[$NewFile]TheBackupFileisexists,Can&#39;tBackup!&amp;quot;&amp;gt;&amp;gt;$LogFile
	else
		case $BackupMethod in
		mysqldump)
 			if [ -z $DBPasswd ] 
				then
					mysqldump -u$DBUser --opt $DBName&amp;gt;$DumpFile
				else
					mysqldump -u$DBUser -p$DBPasswd --opt $DBName&amp;gt;$DumpFile
			fi
 
			tar czvf $NewFile $DumpFile&amp;gt;&amp;gt;$LogFile 2&amp;gt;&amp;amp;1
			echo &amp;quot;[$NewFile]BackupSuccess!&amp;quot;&amp;gt;&amp;gt;$LogFile
 			rm -rf $DumpFile
		;;
 
		mysqlhotcopy)
 			rm -rf $DumpFile
 			mkdir $DumpFile
 
			if [ -z $DBPasswd ] 
				then
					mysqlhotcopy -u$DBUser $DBName $DumpFile&amp;gt;&amp;gt;$LogFile 2&amp;gt;&amp;amp;1
				else
					mysqlhotcopy -u$DBUser -p$DBPasswd $DBName $DumpFile&amp;gt;&amp;gt;$LogFile2&amp;gt;&amp;amp;1
			fi
 
			tar czvf $NewFile $DumpFile&amp;gt;&amp;gt;$LogFile 2&amp;gt;&amp;amp;1
			echo &amp;quot;[$NewFile]BackupSuccess!&amp;quot;&amp;gt;&amp;gt;$LogFile
			rm -rf $DumpFile
		;;
 
		*)
			/etc/init.d/mysqldstop&amp;gt;/dev/null2&amp;gt;&amp;amp;1
			tar czvf $NewFile $DBPath$DBName&amp;gt;&amp;gt;$LogFile 2&amp;gt;&amp;amp;1
			/etc/init.d/mysqldstart&amp;gt;/dev/null2&amp;gt;&amp;amp;1
			echo &amp;quot;[$NewFile]BackupSuccess!&amp;quot;&amp;gt;&amp;gt;$LogFile
		;;
 
		esac
fi
echo &amp;quot;-------------------------------------------&amp;quot;&amp;gt;&amp;gt;$LogFile
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>[è½¬]Git-é¡¹ç›®è‡ªåŠ¨éƒ¨ç½²</title>
      <link>http://hbchen.com/post/2014-10-17-xiang-mu-zi-dong-bu-shu-git/</link>
      <pubDate>Fri, 17 Oct 2014 13:29:00 +0800</pubDate>
      
      <guid>http://hbchen.com/post/2014-10-17-xiang-mu-zi-dong-bu-shu-git/</guid>
      
        <description>&lt;p&gt;Git pushåè‡ªåŠ¨æ›´æ–°é¡¹ç›®éƒ¨ç½²ï¼Œ&amp;rdquo;[deploy]&amp;ldquo;éƒ¨ç½²çš„åˆ†æ”¯ä¸ºmasterã€‚&lt;/p&gt;

&lt;p&gt;Gist
&lt;/br&gt;&lt;a href=&#34;https://gist.github.com/icyleaf/566767&#34;&gt;https://gist.github.com/icyleaf/566767&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ vi post-receive

#!/bin/sh
#
# git autodeploy script when it matches the string &amp;quot;[deploy]&amp;quot;
#
# @author    icyleaf &amp;lt;icyleaf.cn@gmail.com&amp;gt;
# @link      http://icyleaf.com
# @version   0.1
#
# Usage:
#       1. put this into the post-receive hook file itself below
#       2. `chmod +x post-recive` 
#       3. Done!
 
# Check the remote git repository whether it is bare
IS_BARE=$(git rev-parse --is-bare-repository)
if [ -z &amp;quot;$IS_BARE&amp;quot; ]; then
	echo &amp;gt;&amp;amp;2 &amp;quot;fatal: post-receive: IS_NOT_BARE&amp;quot;
	exit 1
fi
 
# Get the latest commit subject
SUBJECT=$(git log -1 --pretty=format:&amp;quot;%s&amp;quot;)
 
# Deploy the HEAD sources to publish
IS_PULL=$(echo &amp;quot;$SUBJECT&amp;quot; | grep &amp;quot;\[deploy\]&amp;quot;)
if [ -z &amp;quot;$IS_PULL&amp;quot; ]; then
	echo &amp;gt;&amp;amp;2 &amp;quot;tips: post-receive: IS_NOT_PULL&amp;quot;
	exit 1
fi
 
# Check the deploy dir whether it exists
DEPLOY_DIR=/home/icyleaf/php/icyleaf/
if [ ! -d $DEPLOY_DIR ] ; then
	echo &amp;gt;&amp;amp;2 &amp;quot;fatal: post-receive: DEPLOY_DIR_NOT_EXIST: \&amp;quot;$DEPLOY_DIR\&amp;quot;&amp;quot;
	exit 1
fi
 
# Check the deploy dir whether it is git repository
#
#IS_GIT=$(git rev-parse --git-dir 2&amp;gt;/dev/null)
#if [ -z &amp;quot;$IS_GIT&amp;quot; ]; then
#	echo &amp;gt;&amp;amp;2 &amp;quot;fatal: post-receive: IS_NOT_GIT&amp;quot;
#	exit 1
#fi
 
# Goto the deploy dir and pull the latest sources
cd $DEPLOY_DIR
env -i git reset --hard
env -i git pull
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>Redmine Plugins</title>
      <link>http://hbchen.com/post/2014-04-15-redmine-plugins/</link>
      <pubDate>Tue, 15 Apr 2014 12:09:00 +0800</pubDate>
      
      <guid>http://hbchen.com/post/2014-04-15-redmine-plugins/</guid>
      
        <description>&lt;p&gt;Gitç‰ˆæœ¬åº“å·¥å…·-&lt;a href=&#34;https://github.com/CtrlC-Root/redmine-gitolite/&#34;&gt;Gitolite&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;çŸ¥è¯†ç§¯ç´¯å·¥å…·-&lt;a href=&#34;https://github.com/alexbevi/redmine_knowledgebase/&#34;&gt;Knowledgebase&lt;/a&gt;&lt;/p&gt;
</description>
      
    </item>
    
    <item>
      <title>Macå®‰è£…é…ç½®MongoDB&#43;RockMongo</title>
      <link>http://hbchen.com/post/2014-03-11-mac-mongodb-rockmongo/</link>
      <pubDate>Tue, 11 Mar 2014 18:00:00 +0800</pubDate>
      
      <guid>http://hbchen.com/post/2014-03-11-mac-mongodb-rockmongo/</guid>
      
        <description>&lt;p&gt;MongoDBå®‰è£…
&lt;/br&gt;ä½¿ç”¨brewå®‰è£…å¾ˆæ–¹ä¾¿
&lt;/br&gt;&lt;a href=&#34;http://docs.mongodb.org/manual/tutorial/install-mongodb-on-os-x/&#34;&gt;http://docs.mongodb.org/manual/tutorial/install-mongodb-on-os-x/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;å®‰è£…å®Œæˆåå¯ä»¥é€‰æ‹©ä¿®æ”¹é…ç½®æ–‡ä»¶&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#mongod.conf
#dbpath,logpath,bind_ip
vi /usr/local/etc/mongod.conf

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯åŠ¨é…ç½®&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨é…ç½®.bash_profile
vi ~/.bash_profile

#æ·»åŠ ä»¥ä¸‹å†…å®¹
export PATH=$PATH:/usr/local/opt/mongodb/bin
alias mongodb_start=&#39;sudo launchctl load -w /usr/local/Cellar/mongodb/2.4.9/homebrew.mxcl.mongodb.plist&#39;
alias mongodb_stop=&#39;sudo launchctl unload -w /usr/local/Cellar/mongodb/2.4.9/homebrew.mxcl.mongodb.plist&#39;
alias mongodb_restart=&#39;mongodb_stop; mongodb_start;&#39;

#è¿™æ ·ç›´æ¥ä½¿ç”¨mongodb_start,mongodb_stop,mongodb_restartå¾ˆæ–¹ä¾¿

#å¯åŠ¨
mongodb_start

#é…ç½®ç”¨æˆ·åå¯†ç 
mongo
db show
use test
db.addUser(&amp;quot;root&amp;quot;, &amp;quot;123456&amp;quot;)

#é‡å¯
mongodb_restart
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç®¡ç†å·¥å…·RockMongoï¼Œä¸‹è½½åæ ¹æ®è‡ªå·±çš„PHPç¯å¢ƒé…ç½®
&lt;/br&gt;&lt;a href=&#34;http://rockmongo.com/downloads&#34;&gt;http://rockmongo.com/downloads&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;å®‰è£…php-mongo&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#æˆ‘ç”¨çš„php54ï¼Œè®°ä¸‹å®‰è£…åçš„è·¯å¾„
brew php54-mongo

#é…ç½®php.ini
#æ·»åŠ æˆ–è€…ä¿®æ”¹extension=&amp;quot;mongo.so&amp;quot;
extension=&amp;quot;/usr/local/Cellar/php54-mongo/1.4.5/mongo.so&amp;quot;

#å¯åŠ¨/é‡å¯Phpç¯å¢ƒ
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>BAE Cache&amp;Rediså®ç°ThinkPHPçš„Cacheé©±åŠ¨</title>
      <link>http://hbchen.com/post/2014-03-06-bae-redisshi-xian-thinkphpcache/</link>
      <pubDate>Thu, 06 Mar 2014 19:00:00 +0800</pubDate>
      
      <guid>http://hbchen.com/post/2014-03-06-bae-redisshi-xian-thinkphpcache/</guid>
      
        <description>&lt;p&gt;åœ¨BAEç¯å¢ƒä¸‹æœ‰å•ç‹¬çš„Cacheï¼ŒåŒæ—¶ä¹Ÿæœ‰Redisï¼Œå¯ä»¥åŒæ—¶ç”¨æ¥åšä¸åŒçš„CacheæœåŠ¡ï¼Œå…ˆä»Rediså¼€å§‹&lt;/p&gt;

&lt;p&gt;1ã€Redisç›¸å…³é…ç½®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;//conf.php
#BAE API Keyä¸Secret Key
&#39;BAE_AK&#39; 	=&amp;gt; &#39;XXX&#39;,
&#39;BAE_SK&#39;	=&amp;gt; &#39;XXX&#39;,

#BAE Redisæ‰©å±•é…ç½®
&#39;BAE_REDIS_HOST&#39;   =&amp;gt;	&#39;redis.duapp.com&#39;,
&#39;BAE_REDIS_PORT&#39;   =&amp;gt;	80,
&#39;BAE_REDIS_DBNAME&#39; =&amp;gt;	&#39;XXX&#39;,

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥é€‰æ‹©å°†Redisæ˜¯å¦è®¾ä¸ºé»˜è®¤ç¼“å­˜ï¼Œå¦‚æœä¸æ˜¯ï¼Œä½¿ç”¨æ—¶æ³¨æ„åˆ‡æ¢&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$cache = Cache::getInstance(&#39;Baeredis&#39;,array());
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;2ã€Redis Cache é©±åŠ¨&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;//CacheBaeredis.class.php
#æ ¹æ®CacheRedis.class.phpä¿®æ”¹

&amp;lt;?php

defined(&#39;THINK_PATH&#39;) or exit();


class CacheBaeredis extends Cache {
	 /**
	 * æ¶æ„å‡½æ•°
     * @param array $options ç¼“å­˜å‚æ•°
     * @access public
     */
    public function __construct($options=array()) {
        if ( !extension_loaded(&#39;redis&#39;) ) {
            throw_exception(L(&#39;_NOT_SUPPERT_&#39;).&#39;:redis&#39;);
        }
        if(empty($options)) {
            $options = array (
                &#39;host&#39;          =&amp;gt; C(&#39;BAE_REDIS_HOST&#39;) ? C(&#39;BAE_REDIS_HOST&#39;) : &#39;127.0.0.1&#39;,
                &#39;port&#39;          =&amp;gt; C(&#39;BAE_REDIS_PORT&#39;) ? C(&#39;BAE_REDIS_PORT&#39;) : 80,
                &#39;timeout&#39;       =&amp;gt; C(&#39;DATA_CACHE_TIMEOUT&#39;) ? C(&#39;DATA_CACHE_TIMEOUT&#39;) : false,
                &#39;persistent&#39;    =&amp;gt; false,
            );
        }
        $this-&amp;gt;options =  $options;
        $this-&amp;gt;options[&#39;expire&#39;] =  isset($options[&#39;expire&#39;])?  $options[&#39;expire&#39;]  :   C(&#39;DATA_CACHE_TIME&#39;);
        $this-&amp;gt;options[&#39;prefix&#39;] =  isset($options[&#39;prefix&#39;])?  $options[&#39;prefix&#39;]  :   C(&#39;DATA_CACHE_PREFIX&#39;);        
        $this-&amp;gt;options[&#39;length&#39;] =  isset($options[&#39;length&#39;])?  $options[&#39;length&#39;]  :   0;        
            
        try {
            /*å»ºç«‹è¿æ¥åï¼Œåœ¨è¿›è¡Œé›†åˆæ“ä½œå‰ï¼Œéœ€è¦å…ˆè¿›è¡ŒauthéªŒè¯*/
            $this-&amp;gt;handler = new Redis();
            $ret;
            if ($options[&#39;timeout&#39;] === false) {
                $ret = $this-&amp;gt;handler-&amp;gt;connect($options[&#39;host&#39;], $options[&#39;port&#39;]);
            }
            else {
                $ret = $this-&amp;gt;handler-&amp;gt;connect($options[&#39;host&#39;], $options[&#39;port&#39;], $options[&#39;timeout&#39;]);
            }

            if ($ret === false) {
                throw new RedisException($this-&amp;gt;handler-&amp;gt;getLastError());
            }

            $user = C(&#39;BAE_AK&#39;);
            $pwd = C(&#39;BAE_SK&#39;);
            $dbname = C(&#39;BAE_REDIS_DBNAME&#39;);

            $ret = $this-&amp;gt;handler-&amp;gt;auth($user . &amp;quot;-&amp;quot; . $pwd . &amp;quot;-&amp;quot; . $dbname);
            if ($ret === false) {
                throw new RedisException($this-&amp;gt;handler-&amp;gt;getLastError());
            }
         
        } catch (RedisException $e) {
            throw_exception(&#39;BAE Redis:&#39;.$e-&amp;gt;getMessage());
        }


    }

    /**
     * è¯»å–ç¼“å­˜
     * @access public
     * @param string $name ç¼“å­˜å˜é‡å
     * @return mixed
     */
    public function get($name) {
        N(&#39;cache_read&#39;,1);
        $value = $this-&amp;gt;handler-&amp;gt;get($this-&amp;gt;options[&#39;prefix&#39;].$name);
        $jsonData  = json_decode( $value, true );
        return ($jsonData === NULL) ? $value : $jsonData;	//æ£€æµ‹æ˜¯å¦ä¸ºJSONæ•°æ® true è¿”å›JSONè§£ææ•°ç»„, falseè¿”å›æºæ•°æ®
    }

    /**
     * å†™å…¥ç¼“å­˜
     * @access public
     * @param string $name ç¼“å­˜å˜é‡å
     * @param mixed $value  å­˜å‚¨æ•°æ®
     * @param integer $expire  æœ‰æ•ˆæ—¶é—´ï¼ˆç§’ï¼‰
     * @return boolen
     */
    public function set($name, $value, $expire = null) {
        N(&#39;cache_write&#39;,1);
        if(is_null($expire)) {
            $expire  =  $this-&amp;gt;options[&#39;expire&#39;];
        }
        $name   =   $this-&amp;gt;options[&#39;prefix&#39;].$name;
        //å¯¹æ•°ç»„/å¯¹è±¡æ•°æ®è¿›è¡Œç¼“å­˜å¤„ç†ï¼Œä¿è¯æ•°æ®å®Œæ•´æ€§
        $value  =  (is_object($value) || is_array($value)) ? json_encode($value) : $value;

        //ç›¸å¯¹CacheRedisçš„é©±åŠ¨å¢åŠ äº†expire&amp;gt;0çš„åˆ¤æ–­
        if(is_int($expire) &amp;amp; $expire &amp;gt; 0) {
            $result = $this-&amp;gt;handler-&amp;gt;setex($name, $expire, $value);
        }else{
            $result = $this-&amp;gt;handler-&amp;gt;set($name, $value);
        }
        if($result &amp;amp;&amp;amp; $this-&amp;gt;options[&#39;length&#39;]&amp;gt;0) {
            // è®°å½•ç¼“å­˜é˜Ÿåˆ—
            $this-&amp;gt;queue($name);
        }
        return $result;
    }

    /**
     * åˆ é™¤ç¼“å­˜
     * @access public
     * @param string $name ç¼“å­˜å˜é‡å
     * @return boolen
     */
    public function rm($name) {
        return $this-&amp;gt;handler-&amp;gt;delete($this-&amp;gt;options[&#39;prefix&#39;].$name);
    }

    /**
     * æ¸…é™¤ç¼“å­˜
     * @access public
     * @return boolen
     */
    public function clear() {
        return $this-&amp;gt;handler-&amp;gt;flushDB();
    }

}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;3ã€BAE Cacheé©±åŠ¨åŠé…ç½®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;#é…ç½®
#BAE API Keyä¸Secret Keyï¼Œå‰é¢å·²ç»æœ‰é…ç½®
&#39;BAE_AK&#39; 	=&amp;gt; &#39;XXX&#39;,
&#39;BAE_SK&#39;	=&amp;gt; &#39;XXX&#39;,

#è®¾ç½®è‡ªå·±çš„CacheIDï¼ˆèµ„æºåç§°ï¼‰ã€Hostå’ŒPort
&#39;DATA_CACHE_TYPE&#39; 	=&amp;gt; &#39;Bae&#39;,		//è®¾ä¸ºé»˜è®¤
&#39;DATA_CACHE_ID&#39;		=&amp;gt;	&#39;XXX&#39;,
&#39;MEMCACHE_HOST&#39;		=&amp;gt;	&#39;cache.duapp.com&#39;,
&#39;MEMCACHE_PORT&#39;		=&amp;gt;	000,


#require_once(BAE_API_ROOT_PATH . &#39;BaeMemcache.class.php&#39;);
#éœ€è¦BAEç›¸å…³çš„é©±åŠ¨æ–‡ä»¶ï¼Œå¯ä»¥åœ¨index.phpå…¥å£ä¸­æ·»åŠ Root Pathæ–¹ä¾¿ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥è‡ªå·±ä¿®æ”¹å®šä¹‰
define(&#39;BAE_API_ROOT_PATH&#39;, &#39;ä½ çš„BAEé©±åŠ¨æ–‡ä»¶è·¯å¾„&#39;);

&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;//CacheBae.class.php
&amp;lt;?php
class CacheBae extends Cache {

    static $_cache;
    private $_handler;
   
    /**
     +----------------------------------------------------------
     * æ¶æ„å‡½æ•°
     +----------------------------------------------------------
     * @access public
     +----------------------------------------------------------
     */
    public function __construct($options=&#39;&#39;) {
        if(!empty($options)) {
            $this-&amp;gt;options =  $options;
        }
        $this-&amp;gt;options[&#39;expire&#39;] = isset($options[&#39;expire&#39;])?$options[&#39;expire&#39;]:C(&#39;DATA_CACHE_TIME&#39;);
        $this-&amp;gt;options[&#39;length&#39;]  =  isset($options[&#39;length&#39;])?$options[&#39;length&#39;]:0;
        $this-&amp;gt;options[&#39;queque&#39;]  =  &#39;bae&#39;;
        $this-&amp;gt;init();
    }

    /**
     +----------------------------------------------------------
     * åˆå§‹åŒ–æ£€æŸ¥
     +----------------------------------------------------------
     * @access private
     +----------------------------------------------------------
     * @return boolen
     +----------------------------------------------------------
     */
    private function init() {
    	require_once(BAE_API_ROOT_PATH . &#39;BaeMemcache.class.php&#39;);
    	/*Cacheé…ç½®ä¿¡æ¯ï¼Œå¯æŸ¥è¯¢Cacheè¯¦æƒ…é¡µ*/
    	$cacheid = C(&#39;DATA_CACHE_ID&#39;);
    	$host = C(&#39;MEMCACHE_HOST&#39;);
    	$port = C(&#39;MEMCACHE_PORT&#39;);
    	$user = C(&#39;BAE_AK&#39;);
    	$pwd = C(&#39;BAE_SK&#39;);

		$this-&amp;gt;_handler = new BaeMemcache($cacheid,$host. &#39;: &#39;. $port, $user, $pwd);
		$this-&amp;gt;connected = true;
    }

    /**
     +----------------------------------------------------------
     * æ˜¯å¦è¿æ¥
     +----------------------------------------------------------
     * @access public
     +----------------------------------------------------------
     * @return boolen
     +----------------------------------------------------------
     */
    private function isConnected() {
        return $this-&amp;gt;connected;
    }
    /**
     +----------------------------------------------------------
     * è¯»å–ç¼“å­˜
     +----------------------------------------------------------
     * @access public
     +----------------------------------------------------------
     * @param string $name ç¼“å­˜å˜é‡å
     +----------------------------------------------------------
     * @return mixed
     +----------------------------------------------------------
     */
    public function get($name) {
        N(&#39;cache_read&#39;,1);
	$content = $this-&amp;gt;_handler-&amp;gt;get($name);
	if(false !== $content ){
            if(C(&#39;DATA_CACHE_COMPRESS&#39;) &amp;amp;&amp;amp; function_exists(&#39;gzcompress&#39;)) {
		$content = substr($content,0,-1);  //remvoe \0 in the end
	    }
            if(C(&#39;DATA_CACHE_CHECK&#39;)) {//å¼€å¯æ•°æ®æ ¡éªŒ
                $check  =  substr($content,0, 32);
                $content   =  substr($content,32);
                if($check != md5($content)) {//æ ¡éªŒé”™è¯¯
                    return false;
                }
            }
            if(C(&#39;DATA_CACHE_COMPRESS&#39;) &amp;amp;&amp;amp; function_exists(&#39;gzcompress&#39;)) {
                //å¯ç”¨æ•°æ®å‹ç¼©
                $content   =   gzuncompress($content);
            }
            $content    =   unserialize($content);
	    return $content;
        }
        else {
            return false;
        }
    }

    /**
     +----------------------------------------------------------
     * å†™å…¥ç¼“å­˜
     +----------------------------------------------------------
     * @access public
     +----------------------------------------------------------
     * @param string $name ç¼“å­˜å˜é‡å
     * @param mixed $value  å­˜å‚¨æ•°æ®
     * @param int $expire  æœ‰æ•ˆæ—¶é—´ 0ä¸ºæ°¸ä¹…
     +----------------------------------------------------------
     * @return boolen
     +----------------------------------------------------------
     */
    public function set($name,$value,$expire=null) {
        N(&#39;cache_write&#39;,1);
        if(is_null($expire)) {
            $expire =  $this-&amp;gt;options[&#39;expire&#39;];
        }
        $data   =   serialize($value);
        if( C(&#39;DATA_CACHE_COMPRESS&#39;) &amp;amp;&amp;amp; function_exists(&#39;gzcompress&#39;)) {
            //æ•°æ®å‹ç¼©
        //    $data   =   gzcompress($data,3);
	      $data =  gzencode($data) . &amp;quot;\0&amp;quot;;
        }
        if(C(&#39;DATA_CACHE_CHECK&#39;)) {//å¼€å¯æ•°æ®æ ¡éªŒ
            $check  =  md5($data);
        }else {
            $check  =  &#39;&#39;;
        }
	$data = $check.$data;
	$result =  $this-&amp;gt;_handler-&amp;gt;set($name,$data,0,intval($expire));
        if($result) {
            if($this-&amp;gt;options[&#39;length&#39;]&amp;gt;0) {
                // è®°å½•ç¼“å­˜é˜Ÿåˆ—
                $this-&amp;gt;queue($name);
            }
	    return true;
        }else {
            return false;
        }
    }

    /**
     +----------------------------------------------------------
     * åˆ é™¤ç¼“å­˜
     +----------------------------------------------------------
     * @access public
     +----------------------------------------------------------
     * @param string $name ç¼“å­˜å˜é‡å
     +----------------------------------------------------------
     * @return boolen
     +----------------------------------------------------------
     */
    public function rm($name) {
        return $this-&amp;gt;_handler-&amp;gt;delete($name);
    }
    static function queueSet($name,$value)
    {
	$h = new BaeMemcache();
	if ( $h-&amp;gt;set($name,$value) ){
		self::$_cache = array($name =&amp;gt; $value);
	}
    }
    static function queueGet($name)
    {
	if(isset(self::$_cache[$name]))
		return self::$_cache[$name];
	$h = new BaeMemcache();
	$r = $h-&amp;gt;get($name);
	if ( false === $r ){
		return false;
	}
	self::$_cache[$name] = $r;
	return $r;
    }

}

&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>WAMP&#43;ThinkPHPé…ç½®</title>
      <link>http://hbchen.com/post/2014-03-05-wamppei-zhi/</link>
      <pubDate>Wed, 05 Mar 2014 18:30:00 +0800</pubDate>
      
      <guid>http://hbchen.com/post/2014-03-05-wamppei-zhi/</guid>
      
        <description>&lt;p&gt;é…ç½®ThinkPHPå¼€å‘ç¯å¢ƒ&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;å¼€å¯Rewriteæ”¯æŒ.htaccess&lt;/li&gt;
&lt;li&gt;è‡ªå®šä¹‰å·¥ç¨‹è·¯å¾„&lt;/li&gt;
&lt;li&gt;è‡ªå®šä¹‰æœ¬åœ°åŸŸåè®¿é—®&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;WAMPå®‰è£…
&lt;a href=&#34;http://www.wampserver.com/en/#download-wrapper&#34;&gt;http://www.wampserver.com/en/#download-wrapper&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#ç¼–è¾‘wamp/bin/apache/Apache2.x.x/conf/httpd.conf
#å¼€å¯rewriteï¼Œæ”¯æŒ.htaccess
#LoadModule rewrite_module modules/mod_rewrite.soå»æ‰æ³¨é‡Š
LoadModule rewrite_module modules/mod_rewrite.so

#å¼€å¯httpd-vhostsï¼Œè‡ªå®šä¹‰åŸŸåå’Œå·¥ç¨‹è·¯å¾„
#Include conf/extra/httpd-vhosts.confå»æ‰æ³¨é‡Š
Include conf/extra/httpd-vhosts.conf

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è‡ªå®šä¹‰æœ¬åœ°åŸŸåå’Œå·¥ç¨‹è·¯å¾„&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#ç¼–è¾‘wamp/bin/apache/Apache2.x.x/conf/extra/httpd-vhosts.conf
#è‡ªå®šä¹‰å·¥ç¨‹è·¯å¾„
#d:projectpathå·¥ç¨‹è·¯å¾„
#mylocalhost.comè‡ªå®šä¹‰åŸŸå
#æ³¨æ„AllowOverride æ˜¯Allï¼Œä¸wampä¸»ç•Œé¢ä¸åŒ
#å¯ä»¥å®šä¹‰å…¶ä»–ç«¯å£
&amp;lt;VirtualHost *:80&amp;gt;  
  DocumentRoot d:projectpath 
  ServerName myhost.com 
  &amp;lt;Directory &amp;quot;d:projectpath&amp;quot;&amp;gt; 
      Options Indexes FollowSymLinks 
      AllowOverride All 
      Order allow,deny 
      Allow from all 
  &amp;lt;/Directory&amp;gt; 
&amp;lt;/VirtualHost&amp;gt;

#æ·»åŠ wampä¸»ç•Œé¢ï¼Œå‡è®¾wampå®‰è£…åœ¨Dç›˜
&amp;lt;VirtualHost *:80&amp;gt;  
  DocumentRoot d:wamp/www 
  ServerName wamp.com 
  &amp;lt;Directory &amp;quot;d:wamp/www&amp;quot;&amp;gt; 
      Options Indexes FollowSymLinks 
      AllowOverride None 
      Order allow,deny 
      Allow from all 
  &amp;lt;/Directory&amp;gt; 
&amp;lt;/VirtualHost&amp;gt;

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å»æ‰URLä¸­çš„index.php&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#.htaccess
&amp;lt;IfModule mod_rewrite.c&amp;gt;
RewriteEngine on
RewriteCond %{SCRIPT_FILENAME} !-f
RewriteCond %{SCRIPT_FILENAME} !-d
RewriteRule ^(.*)$ index.php/$1 [QAS,PT,L]
&amp;lt;/IfModule&amp;gt;

&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;#ä¿®æ”¹ç³»ç»Ÿhosts
127.0.0.1 	myhost.com
127.0.0.1 	wamp.com

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é‡å¯Apache&lt;/p&gt;

&lt;p&gt;æŸ¥çœ‹æˆæœå§&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;myhost.com
wamp.com
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>MySql:ä¼˜åŒ–å·¥å…·</title>
      <link>http://hbchen.com/post/2013-11-07-mysql-you-hua-gong-ju/</link>
      <pubDate>Thu, 07 Nov 2013 18:36:00 +0800</pubDate>
      
      <guid>http://hbchen.com/post/2013-11-07-mysql-you-hua-gong-ju/</guid>
      
        <description>&lt;p&gt;è„šæœ¬ä¼˜åŒ–tuning-primer.sh&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#cd /etc/   (my.confæ‰€åœ¨ç›®å½•)
#wget http://www.day32.com/MySQL/tuning-primer.sh
#chmod +x tuning-primer.sh
#./tuning-primer.sh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¼˜åŒ–å·¥å…·Mysqltuner&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;å®‰è£…ï¼š
#yum install -y mysqltuner
è¿è¡Œï¼š
#mysqltuner
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
    <item>
      <title>æ—¥å¿—ç»Ÿè®¡åˆ†æ-Shell/Goaccess</title>
      <link>http://hbchen.com/post/2013-11-07-ri-zhi-tong-ji-fen-xi-shell-slash-goaccess/</link>
      <pubDate>Thu, 07 Nov 2013 18:36:00 +0800</pubDate>
      
      <guid>http://hbchen.com/post/2013-11-07-ri-zhi-tong-ji-fen-xi-shell-slash-goaccess/</guid>
      
        <description>&lt;p&gt;å¯¹Nginxæˆ–å…¶ä»–æ—¥å¿—è¿›è¡Œç®€å•çš„ç»Ÿè®¡åˆ†æ&lt;/p&gt;

&lt;p&gt;Shell
å¯¹æŸä¸€åˆ—è¿›è¡Œç»Ÿè®¡ï¼Œå¯ä»¥åˆ†æStatus Code,URLç­‰&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#cat access.log | awk &#39;{print $9}&#39;|sort|uniq -c | sort -r -n &amp;gt; stat.log
æˆ–
#cat access.log |grep &amp;quot;200&amp;quot; | awk &#39;{print $7}&#39;|sort|uniq -c | sort -r -n &amp;gt; stat.log
#vi stat.log
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŒ‡å®šStringç»Ÿè®¡&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#cat access.log|grep &amp;quot;200&amp;quot;|wc -l 
#cat access.log|grep &amp;quot;www.localhost.com&amp;quot;|wc -l
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Goaccesså·¥å…·
&lt;a href=&#34;http://goaccess.io/&#34;&gt;http://goaccess.io/&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#goaccess -f access.log
#goaccess -f access.log -a -s -b
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Goaccessåˆ†æå‹ç¼©æ—¥å¿—&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#zcat access.log-20130123.gz | goaccess
&lt;/code&gt;&lt;/pre&gt;</description>
      
    </item>
    
  </channel>
</rss>